cscope 15 /data1/zhangcong/Opensrc/muduo -q 0000003511 0000848061
	@contrib/hiredis/Hiredis.cc

1 
	~"Hœedis.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/ChªÃl.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/Sock‘sOps.h
>

8 
	~<hœedis/async.h
>

10 
usšg
 
Çme¥aû
 
	gmuduo
;

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

12 
usšg
 
Çme¥aû
 
	ghœedis
;

14 
dummy
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>&)

18 
Hœedis
::
	$Hœedis
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
)

19 : 
	`loİ_
(
loİ
),

20 
	`£rv”Addr_
(
£rv”Addr
),

21 
	$cÚ‹xt_
(
NULL
)

23 
	}
}

25 
	gHœedis
::~
	$Hœedis
()

27 
LOG_DEBUG
 << 
this
;

28 
	`as£¹
(!
chªÃl_
 || chªÃl_->
	`isNÚeEv’t
());

29 ::
	`»disAsyncF»e
(
cÚ‹xt_
);

30 
	}
}

32 
boŞ
 
	gHœedis
::
	$cÚÃùed
() const

34  
chªÃl_
 && 
cÚ‹xt_
 && (cÚ‹xt_->
c
.
æags
 & 
REDIS_CONNECTED
);

35 
	}
}

37 cÚ¡ * 
	gHœedis
::
	$”r¡r
() const

39 
	`as£¹
(
cÚ‹xt_
 !ğ
NULL
);

40  
cÚ‹xt_
->
”r¡r
;

41 
	}
}

43 
	gHœedis
::
	$cÚÃù
()

45 
	`as£¹
(!
cÚ‹xt_
);

47 
cÚ‹xt_
 = ::
	`»disAsyncCÚÃù
(
£rv”Addr_
.
	`toIp
().
	`c_¡r
(), s”v”Addr_.
	`toPÜt
());

49 
cÚ‹xt_
->
ev
.
addR—d
 =‡ddRead;

50 
cÚ‹xt_
->
ev
.
d–R—d
 = delRead;

51 
cÚ‹xt_
->
ev
.
addWr™e
 =‡ddWrite;

52 
cÚ‹xt_
->
ev
.
d–Wr™e
 = delWrite;

53 
cÚ‹xt_
->
ev
.
ş—nup
 = cleanup;

54 
cÚ‹xt_
->
ev
.
d©a
 = 
this
;

56 
	`£tChªÃl
();

58 
	`as£¹
(
cÚ‹xt_
->
ÚCÚÃù
 =ğ
NULL
);

59 
	`as£¹
(
cÚ‹xt_
->
ÚDiscÚÃù
 =ğ
NULL
);

60 ::
	`»disAsyncS‘CÚÃùC®lback
(
cÚ‹xt_
, 
cÚÃùC®lback
);

61 ::
	`»disAsyncS‘DiscÚÃùC®lback
(
cÚ‹xt_
, 
discÚÃùC®lback
);

62 
	}
}

64 
	gHœedis
::
	$discÚÃù
()

66 ià(
	`cÚÃùed
())

68 
LOG_DEBUG
 << 
this
;

69 ::
	`»disAsyncDiscÚÃù
(
cÚ‹xt_
);

71 
	}
}

73 
	gHœedis
::
	$fd
() const

75 
	`as£¹
(
cÚ‹xt_
);

76  
cÚ‹xt_
->
c
.
fd
;

77 
	}
}

79 
	gHœedis
::
	$£tChªÃl
()

81 
LOG_DEBUG
 << 
this
;

82 
	`as£¹
(!
chªÃl_
);

83 
chªÃl_
.
	`»£t
(
Ãw
 
	`ChªÃl
(
loİ_
, 
	`fd
()));

84 
chªÃl_
->
	`£tR—dC®lback
(
boo¡
::
	`bšd
(&
Hœedis
::
hªdËR—d
, 
this
, 
_1
));

85 
chªÃl_
->
	`£tWr™eC®lback
(
boo¡
::
	`bšd
(&
Hœedis
::
hªdËWr™e
, 
this
));

86 
	}
}

88 
	gHœedis
::
	$»moveChªÃl
()

90 
LOG_DEBUG
 << 
this
;

91 
chªÃl_
->
	`di§bËAÎ
();

92 
chªÃl_
->
	`»move
();

93 
loİ_
->
	`queueInLoİ
(
boo¡
::
	`bšd
(
dummy
, 
chªÃl_
));

94 
chªÃl_
.
	`»£t
();

95 
	}
}

97 
	gHœedis
::
hªdËR—d
(
muduo
::
Time¡amp
 
»ûiveTime
)

99 
LOG_TRACE
 << "»ûiveTimğ" << 
»ûiveTime
.
toSŒšg
();

100 ::
»disAsyncHªdËR—d
(
cÚ‹xt_
);

103 
	gHœedis
::
	$hªdËWr™e
()

105 ià(!(
cÚ‹xt_
->
c
.
æags
 & 
REDIS_CONNECTED
))

107 
	`»moveChªÃl
();

109 ::
	`»disAsyncHªdËWr™e
(
cÚ‹xt_
);

110 
	}
}

112  
Hœedis
* 
	gHœedis
::
	$g‘Hœedis
(cÚ¡ 
»disAsyncCÚ‹xt
* 
ac
)

114 
Hœedis
* 
hœedis
 = 
¡©ic_ÿ¡
<Hœedis*>(
ac
->
ev
.
d©a
);

115 
	`as£¹
(
hœedis
->
cÚ‹xt_
 =ğ
ac
);

116  
hœedis
;

117 
	}
}

119 
	gHœedis
::
	$logCÚÃùiÚ
(
boŞ
 
up
) const

121 
IÃtAdd»ss
 
	`loÿlAddr
(
sock‘s
::
	`g‘LoÿlAddr
(
	`fd
()));

122 
IÃtAdd»ss
 
	`³”Addr
(
sock‘s
::
	`g‘P“rAddr
(
	`fd
()));

124 
LOG_INFO
 << 
loÿlAddr
.
	`toIpPÜt
() << " -> "

125 << 
³”Addr
.
	`toIpPÜt
() << " is "

126 << (
up
 ? "UP" : "DOWN");

127 
	}
}

129  
	gHœedis
::
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
* 
ac
, 
¡©us
)

131 
LOG_TRACE
;

132 
	`g‘Hœedis
(
ac
)->
	`cÚÃùC®lback
(
¡©us
);

133 
	}
}

135 
	gHœedis
::
	$cÚÃùC®lback
(
¡©us
)

137 ià(
¡©us
 !ğ
REDIS_OK
)

139 
LOG_ERROR
 << 
cÚ‹xt_
->
”r¡r
 << " faedØcÚÃùØ" << 
£rv”Addr_
.
	`toIpPÜt
();

143 
	`logCÚÃùiÚ
(
Œue
);

144 
	`£tChªÃl
();

147 ià(
cÚÃùCb_
)

149 
	`cÚÃùCb_
(
this
, 
¡©us
);

151 
	}
}

153  
	gHœedis
::
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
* 
ac
, 
¡©us
)

155 
LOG_TRACE
;

156 
	`g‘Hœedis
(
ac
)->
	`discÚÃùC®lback
(
¡©us
);

157 
	}
}

159 
	gHœedis
::
	$discÚÃùC®lback
(
¡©us
)

161 
	`logCÚÃùiÚ
(
çl£
);

162 
	`»moveChªÃl
();

164 ià(
discÚÃùCb_
)

166 
	`discÚÃùCb_
(
this
, 
¡©us
);

168 
	}
}

170 
	gHœedis
::
	$addR—d
(* 
´ivd©a
)

172 
LOG_TRACE
;

173 
Hœedis
* 
hœedis
 = 
¡©ic_ÿ¡
<Hœedis*>(
´ivd©a
);

174 
hœedis
->
chªÃl_
->
	`’abËR—dšg
();

175 
	}
}

177 
	gHœedis
::
	$d–R—d
(* 
´ivd©a
)

179 
LOG_TRACE
;

180 
Hœedis
* 
hœedis
 = 
¡©ic_ÿ¡
<Hœedis*>(
´ivd©a
);

181 
hœedis
->
chªÃl_
->
	`di§bËR—dšg
();

182 
	}
}

184 
	gHœedis
::
	$addWr™e
(* 
´ivd©a
)

186 
LOG_TRACE
;

187 
Hœedis
* 
hœedis
 = 
¡©ic_ÿ¡
<Hœedis*>(
´ivd©a
);

188 
hœedis
->
chªÃl_
->
	`’abËWr™šg
();

189 
	}
}

191 
	gHœedis
::
	$d–Wr™e
(* 
´ivd©a
)

193 
LOG_TRACE
;

194 
Hœedis
* 
hœedis
 = 
¡©ic_ÿ¡
<Hœedis*>(
´ivd©a
);

195 
hœedis
->
chªÃl_
->
	`di§bËWr™šg
();

196 
	}
}

198 
	gHœedis
::
	$ş—nup
(* 
´ivd©a
)

200 
Hœedis
* 
hœedis
 = 
¡©ic_ÿ¡
<Hœedis*>(
´ivd©a
);

201 
LOG_DEBUG
 << 
hœedis
;

202 
	}
}

204 
	gHœedis
::
commªd
(cÚ¡ 
CommªdC®lback
& 
cb
, 
muduo
::
SŒšgArg
 
cmd
, ...)

206 ià(!
cÚÃùed
()è 
	gREDIS_ERR
;

208 
	gLOG_TRACE
;

209 
CommªdC®lback
* 
	gp
 = 
Ãw
 CommªdC®lback(
cb
);

210 
va_li¡
 
	g¬gs
;

211 
va_¡¬t
(
¬gs
, 
cmd
);

212 
	g»t
 = ::
»disvAsyncCommªd
(
cÚ‹xt_
, 
commªdC®lback
, 
p
, 
cmd
.
c_¡r
(), 
¬gs
);

213 
va_’d
(
¬gs
);

214  
	g»t
;

217  
	gHœedis
::
	$commªdC®lback
(
»disAsyncCÚ‹xt
* 
ac
, * 
r
, * 
´ivd©a
)

219 
»disR•ly
* 
»¶y
 = 
¡©ic_ÿ¡
<»disR•ly*>(
r
);

220 
CommªdC®lback
* 
cb
 = 
¡©ic_ÿ¡
<CommªdC®lback*>(
´ivd©a
);

221 
	`g‘Hœedis
(
ac
)->
	`commªdC®lback
(
»¶y
, 
cb
);

222 
	}
}

224 
	gHœedis
::
	$commªdC®lback
(
»disR•ly
* 
»¶y
, 
CommªdC®lback
* 
cb
)

226 (*
cb
)(
this
, 
»¶y
);

227 
d–‘e
 
cb
;

228 
	}
}

230 
	gHœedis
::
	$pšg
()

232  
	`commªd
(
boo¡
::
	`bšd
(&
Hœedis
::
pšgC®lback
, 
this
, 
_1
, 
_2
), "PING");

233 
	}
}

235 
	gHœedis
::
	$pšgC®lback
(
Hœedis
* 
me
, 
»disR•ly
* 
»¶y
)

237 
	`as£¹
(
this
 =ğ
me
);

238 
LOG_DEBUG
 << 
»¶y
->
¡r
;

239 
	}
}

	@contrib/hiredis/Hiredis.h

1 #iâdeà
MUDUO_EXAMPLES_HIREDIS_HIREDIS_H


2 
	#MUDUO_EXAMPLES_HIREDIS_HIREDIS_H


	)

4 
	~<muduo/ba£/SŒšgP›û.h
>

5 
	~<muduo/ba£/Ty³s.h
>

6 
	~<muduo/Ãt/C®lbacks.h
>

7 
	~<muduo/Ãt/IÃtAdd»ss.h
>

9 
	~<boo¡/bšd.hµ
>

10 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

11 
	~<boo¡/nÚcİyabË.hµ
>

12 
	~<boo¡/sh¬ed_±r.hµ
>

14 
	~<hœedis/hœedis.h
>

16 
	g»disAsyncCÚ‹xt
;

18 
Çme¥aû
 
	gmuduo


20 
Çme¥aû
 
	gÃt


22 
şass
 
	gChªÃl
;

23 
şass
 
	gEv’tLoİ
;

27 
Çme¥aû
 
	ghœedis


30 
şass
 
	gHœedis
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<
Hœedis
>,

31 
	gboo¡
::
nÚcİyabË


33 
public
:

34 
boo¡
::
	tfunùiÚ
<(
	tHœedis
*, )> 
	tCÚÃùC®lback
;

35 
	gboo¡
::
	tfunùiÚ
<(
	tHœedis
*, )> 
	tDiscÚÃùC®lback
;

36 
	gboo¡
::
	tfunùiÚ
<(
	tHœedis
*, 
	t»disR•ly
*)> 
	tCommªdC®lback
;

38 
Hœedis
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
, cÚ¡ muduo::Ãt::
IÃtAdd»ss
& 
£rv”Addr
);

39 ~
Hœedis
();

41 cÚ¡ 
	gmuduo
::
Ãt
::
IÃtAdd»ss
& 
£rv”Add»ss
(ècÚ¡ {  
£rv”Addr_
; }

43 
boŞ
 
cÚÃùed
() const;

44 cÚ¡ * 
”r¡r
() const;

46 
£tCÚÃùC®lback
(cÚ¡ 
CÚÃùC®lback
& 
cb
è{ 
	gcÚÃùCb_
 = cb; }

47 
£tDiscÚÃùC®lback
(cÚ¡ 
DiscÚÃùC®lback
& 
cb
è{ 
	gdiscÚÃùCb_
 = cb; }

49 
cÚÃù
();

50 
discÚÃù
();

52 
commªd
(cÚ¡ 
CommªdC®lback
& 
cb
, 
muduo
::
SŒšgArg
 
cmd
, ...);

54 
pšg
();

56 
	g´iv©e
:

57 
hªdËR—d
(
muduo
::
Time¡amp
 
»ûiveTime
);

58 
hªdËWr™e
();

60 
fd
() const;

61 
logCÚÃùiÚ
(
boŞ
 
up
) const;

62 
£tChªÃl
();

63 
»moveChªÃl
();

65 
cÚÃùC®lback
(
¡©us
);

66 
discÚÃùC®lback
(
¡©us
);

67 
commªdC®lback
(
»disR•ly
* 
»¶y
, 
CommªdC®lback
* 
´ivd©a
);

69 
Hœedis
* 
g‘Hœedis
(cÚ¡ 
»disAsyncCÚ‹xt
* 
ac
);

71 
cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
* 
ac
, 
¡©us
);

72 
discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
* 
ac
, 
¡©us
);

74 
commªdC®lback
(
»disAsyncCÚ‹xt
* 
ac
, *, *);

76 
addR—d
(* 
´ivd©a
);

77 
d–R—d
(* 
´ivd©a
);

78 
addWr™e
(* 
´ivd©a
);

79 
d–Wr™e
(* 
´ivd©a
);

80 
ş—nup
(* 
´ivd©a
);

82 
pšgC®lback
(
Hœedis
* 
me
, 
»disR•ly
* 
»¶y
);

84 
	g´iv©e
:

85 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ_
;

86 cÚ¡ 
	gmuduo
::
Ãt
::
IÃtAdd»ss
 
£rv”Addr_
;

87 
»disAsyncCÚ‹xt
* 
	gcÚ‹xt_
;

88 
	gboo¡
::
sh¬ed_±r
<
muduo
::
Ãt
::
ChªÃl
> 
chªÃl_
;

89 
CÚÃùC®lback
 
	gcÚÃùCb_
;

90 
DiscÚÃùC®lback
 
	gdiscÚÃùCb_
;

	@contrib/hiredis/Hiredis.h

1 #iâdeà
MUDUO_EXAMPLES_HIREDIS_HIREDIS_H


2 
	#MUDUO_EXAMPLES_HIREDIS_HIREDIS_H


	)

4 
	~<muduo/ba£/SŒšgP›û.h
>

5 
	~<muduo/ba£/Ty³s.h
>

6 
	~<muduo/Ãt/C®lbacks.h
>

7 
	~<muduo/Ãt/IÃtAdd»ss.h
>

9 
	~<boo¡/bšd.hµ
>

10 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

11 
	~<boo¡/nÚcİyabË.hµ
>

12 
	~<boo¡/sh¬ed_±r.hµ
>

14 
	~<hœedis/hœedis.h
>

16 
	g»disAsyncCÚ‹xt
;

18 
Çme¥aû
 
	gmuduo


20 
Çme¥aû
 
	gÃt


22 
şass
 
	gChªÃl
;

23 
şass
 
	gEv’tLoİ
;

27 
Çme¥aû
 
	ghœedis


30 
şass
 
	gHœedis
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<
Hœedis
>,

31 
	gboo¡
::
nÚcİyabË


33 
public
:

34 
boo¡
::
	tfunùiÚ
<(
	tHœedis
*, )> 
	tCÚÃùC®lback
;

35 
	gboo¡
::
	tfunùiÚ
<(
	tHœedis
*, )> 
	tDiscÚÃùC®lback
;

36 
	gboo¡
::
	tfunùiÚ
<(
	tHœedis
*, 
	t»disR•ly
*)> 
	tCommªdC®lback
;

38 
Hœedis
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
, cÚ¡ muduo::Ãt::
IÃtAdd»ss
& 
£rv”Addr
);

39 ~
Hœedis
();

41 cÚ¡ 
	gmuduo
::
Ãt
::
IÃtAdd»ss
& 
£rv”Add»ss
(ècÚ¡ {  
£rv”Addr_
; }

43 
boŞ
 
cÚÃùed
() const;

44 cÚ¡ * 
”r¡r
() const;

46 
£tCÚÃùC®lback
(cÚ¡ 
CÚÃùC®lback
& 
cb
è{ 
	gcÚÃùCb_
 = cb; }

47 
£tDiscÚÃùC®lback
(cÚ¡ 
DiscÚÃùC®lback
& 
cb
è{ 
	gdiscÚÃùCb_
 = cb; }

49 
cÚÃù
();

50 
discÚÃù
();

52 
commªd
(cÚ¡ 
CommªdC®lback
& 
cb
, 
muduo
::
SŒšgArg
 
cmd
, ...);

54 
pšg
();

56 
	g´iv©e
:

57 
hªdËR—d
(
muduo
::
Time¡amp
 
»ûiveTime
);

58 
hªdËWr™e
();

60 
fd
() const;

61 
logCÚÃùiÚ
(
boŞ
 
up
) const;

62 
£tChªÃl
();

63 
»moveChªÃl
();

65 
cÚÃùC®lback
(
¡©us
);

66 
discÚÃùC®lback
(
¡©us
);

67 
commªdC®lback
(
»disR•ly
* 
»¶y
, 
CommªdC®lback
* 
´ivd©a
);

69 
Hœedis
* 
g‘Hœedis
(cÚ¡ 
»disAsyncCÚ‹xt
* 
ac
);

71 
cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
* 
ac
, 
¡©us
);

72 
discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
* 
ac
, 
¡©us
);

74 
commªdC®lback
(
»disAsyncCÚ‹xt
* 
ac
, *, *);

76 
addR—d
(* 
´ivd©a
);

77 
d–R—d
(* 
´ivd©a
);

78 
addWr™e
(* 
´ivd©a
);

79 
d–Wr™e
(* 
´ivd©a
);

80 
ş—nup
(* 
´ivd©a
);

82 
pšgC®lback
(
Hœedis
* 
me
, 
»disR•ly
* 
»¶y
);

84 
	g´iv©e
:

85 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ_
;

86 cÚ¡ 
	gmuduo
::
Ãt
::
IÃtAdd»ss
 
£rv”Addr_
;

87 
»disAsyncCÚ‹xt
* 
	gcÚ‹xt_
;

88 
	gboo¡
::
sh¬ed_±r
<
muduo
::
Ãt
::
ChªÃl
> 
chªÃl_
;

89 
CÚÃùC®lback
 
	gcÚÃùCb_
;

90 
DiscÚÃùC®lback
 
	gdiscÚÃùCb_
;

	@contrib/hiredis/mrediscli.cc

1 
	~"Hœedis.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<¡ršg
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
¡ršg
 
	$toSŒšg
(
v®ue
)

13 
buf
[32];

14 
	`¢´štf
(
buf
,  buf, "%Îd", 
v®ue
);

15  
buf
;

16 
	}
}

18 
¡ršg
 
	$»disR•lyToSŒšg
(cÚ¡ 
»disR•ly
* 
»¶y
)

20 cÚ¡ * cÚ¡ 
ty³s
[] = { "",

24 
¡ršg
 
¡r
;

25 ià(!
»¶y
è 
¡r
;

27 
¡r
 +ğ
ty³s
[
»¶y
->
ty³
] + 
	`¡ršg
("("è+ 
	`toSŒšg
(reply->type) + ") ";

29 
¡r
 += "{ ";

30 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
 ||

31 
»¶y
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

32 
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
)

34 
¡r
 +ğ'"' + 
	`¡ršg
(
»¶y
->¡r,„•ly->
Ën
) + '"';

36 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
)

38 
¡r
 +ğ
	`toSŒšg
(
»¶y
->
š‹g”
);

40 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ARRAY
)

42 
¡r
 +ğ
	`toSŒšg
(
»¶y
->
–em’ts
) + " ";

43 
size_t
 
i
 = 0; i < 
»¶y
->
–em’ts
; i++)

45 
¡r
 +ğ" " + 
	`»disR•lyToSŒšg
(
»¶y
->
–em’t
[
i
]);

48 
¡r
 += " }";

50  
¡r
;

51 
	}
}

53 
cÚÃùC®lback
(
hœedis
::
Hœedis
* 
c
, 
¡©us
)

55 ià(
	g¡©us
 !ğ
REDIS_OK
)

57 
LOG_ERROR
 << "cÚÃùC®lback E¼Ü:" << 
c
->
”r¡r
();

61 
	gLOG_INFO
 << "Connected...";

65 
discÚÃùC®lback
(
hœedis
::
Hœedis
* 
c
, 
¡©us
)

67 ià(
	g¡©us
 !ğ
REDIS_OK
)

69 
LOG_ERROR
 << "discÚÃùC®lback E¼Ü:" << 
c
->
”r¡r
();

73 
	gLOG_INFO
 << "Disconnected...";

77 
timeC®lback
(
hœedis
::
Hœedis
* 
c
, 
»disR•ly
* 
»¶y
)

79 
	gLOG_INFO
 << "tim" << 
»disR•lyToSŒšg
(
»¶y
);

82 
echoC®lback
(
hœedis
::
Hœedis
* 
c
, 
»disR•ly
* 
»¶y
, 
¡ršg
* 
echo
)

84 
	gLOG_INFO
 << *
	gecho
 << " " << 
»disR•lyToSŒšg
(
»¶y
);

85 
	gc
->
discÚÃù
();

88 
dbsizeC®lback
(
hœedis
::
Hœedis
* 
c
, 
»disR•ly
* 
»¶y
)

90 
	gLOG_INFO
 << "dbsiz" << 
»disR•lyToSŒšg
(
»¶y
);

93 
£ËùC®lback
(
hœedis
::
Hœedis
* 
c
, 
»disR•ly
* 
»¶y
, 
ušt16_t
* 
šdex
)

95 
	gLOG_INFO
 << "£Ëù " << *
	gšdex
 << " " << 
»disR•lyToSŒšg
(
»¶y
);

98 
authC®lback
(
hœedis
::
Hœedis
* 
c
, 
»disR•ly
* 
»¶y
, 
¡ršg
* 
·sswÜd
)

100 
	gLOG_INFO
 << "auth " << *
	g·sswÜd
 << " " << 
»disR•lyToSŒšg
(
»¶y
);

103 
echo
(
hœedis
::
Hœedis
* 
c
, 
¡ršg
* 
s
)

105 
	gc
->
commªd
(
boo¡
::
bšd
(
echoC®lback
, 
_1
, 
_2
, 
s
), "echØ%s", s->
c_¡r
());

108 
	$maš
(
¬gc
, ** 
¬gv
)

110 
Logg”
::
	`£tLogLev–
(Logg”::
DEBUG
);

112 
Ev’tLoİ
 
loİ
;

114 
IÃtAdd»ss
 
	`£rv”Addr
("127.0.0.1", 6379);

115 
hœedis
::
Hœedis
 
	`hœedis
(&
loİ
, 
£rv”Addr
);

117 
hœedis
.
	`£tCÚÃùC®lback
(
cÚÃùC®lback
);

118 
hœedis
.
	`£tDiscÚÃùC®lback
(
discÚÃùC®lback
);

119 
hœedis
.
	`cÚÃù
();

122 
loİ
.
	`runEv”y
(1.0, 
boo¡
::
	`bšd
(&
hœedis
::
Hœedis
::
pšg
, &hiredis));

124 
hœedis
.
	`commªd
(
timeC®lback
, "time");

126 
¡ršg
 
hi
 = "hi";

127 
hœedis
.
	`commªd
(
boo¡
::
	`bšd
(
echoC®lback
, 
_1
, 
_2
, &
hi
), "echØ%s", hi.
	`c_¡r
());

128 
loİ
.
	`runEv”y
(2.0, 
boo¡
::
	`bšd
(
echo
, &
hœedis
, &
hi
));

130 
hœedis
.
	`commªd
(
dbsizeC®lback
, "dbsize");

132 
ušt16_t
 
šdex
 = 8;

133 
hœedis
.
	`commªd
(
boo¡
::
	`bšd
(
£ËùC®lback
, 
_1
, 
_2
, &
šdex
), "select %d", index);

135 
¡ršg
 
·sswÜd
 = "password";

136 
hœedis
.
	`commªd
(
boo¡
::
	`bšd
(
authC®lback
, 
_1
, 
_2
, &
·sswÜd
), "auth %s",…asswÜd.
	`c_¡r
());

138 
loİ
.
	`loİ
();

141 
	}
}

	@contrib/thrift/ThriftConnection.cc

1 
	~"ThriáCÚÃùiÚ.h
"

3 
	~<boo¡/bšd.hµ
>

5 
	~<muduo/ba£/Loggšg.h
>

7 
	~<thriá/Œª¥Üt/TT¿n¥ÜtExû±iÚ.h
>

9 
	~"ThriáS”v”.h
"

11 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

14 
	gThriáCÚÃùiÚ
::
	$ThriáCÚÃùiÚ
(
ThriáS”v”
* 
£rv”
,

15 cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

16 : 
	`£rv”_
(
£rv”
),

17 
	`cÚn_
(
cÚn
),

18 
	`¡©e_
(
kEx³ùF¿meSize
),

19 
	$äameSize_
(0)

21 
cÚn_
->
	`£tMes§geC®lback
(
boo¡
::
	`bšd
(&
ThriáCÚÃùiÚ
::
ÚMes§ge
,

22 
this
, 
_1
, 
_2
, 
_3
));

23 
nuÎT¿n¥Üt_
.
	`»£t
(
Ãw
 
	`TNuÎT¿n¥Üt
());

24 
šputT¿n¥Üt_
.
	`»£t
(
Ãw
 
	`TMemÜyBufãr
(
NULL
, 0));

25 
ouutT¿n¥Üt_
.
	`»£t
(
Ãw
 
	`TMemÜyBufãr
());

27 
çùÜyIÅutT¿n¥Üt_
 = 
£rv”_
->
	`g‘IÅutT¿n¥ÜtFaùÜy
()->
	`g‘T¿n¥Üt
(
šputT¿n¥Üt_
);

28 
çùÜyOuutT¿n¥Üt_
 = 
£rv”_
->
	`g‘OuutT¿n¥ÜtFaùÜy
()->
	`g‘T¿n¥Üt
(
ouutT¿n¥Üt_
);

30 
šputPrÙocŞ_
 = 
£rv”_
->
	`g‘IÅutPrÙocŞFaùÜy
()->
	`g‘PrÙocŞ
(
çùÜyIÅutT¿n¥Üt_
);

31 
ouutPrÙocŞ_
 = 
£rv”_
->
	`g‘OuutPrÙocŞFaùÜy
()->
	`g‘PrÙocŞ
(
çùÜyOuutT¿n¥Üt_
);

33 
´oûssÜ_
 = 
£rv”_
->
	`g‘ProûssÜ
(
šputPrÙocŞ_
, 
ouutPrÙocŞ_
, 
nuÎT¿n¥Üt_
);

34 
	}
}

36 
	gThriáCÚÃùiÚ
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

37 
Bufãr
* 
bufãr
,

38 
Time¡amp
 
»ûiveTime
)

40 
boŞ
 
mÜe
 = 
Œue
;

41 
mÜe
)

43 ià(
¡©e_
 =ğ
kEx³ùF¿meSize
)

45 ià(
bufãr
->
	`»adabËBy‹s
() >= 4)

47 
äameSize_
 = 
¡©ic_ÿ¡
<
ušt32_t
>(
bufãr
->
	`»adIÁ32
());

48 
¡©e_
 = 
kEx³ùF¿me
;

52 
mÜe
 = 
çl£
;

55 ià(
¡©e_
 =ğ
kEx³ùF¿me
)

57 ià(
bufãr
->
	`»adabËBy‹s
(è>ğ
äameSize_
)

59 
ušt8_t
* 
buf
 = 
»š‹½»t_ÿ¡
<ušt8_t*>((
cÚ¡_ÿ¡
<*>(
bufãr
->
	`³ek
())));

61 
šputT¿n¥Üt_
->
	`»£tBufãr
(
buf
, 
äameSize_
, 
TMemÜyBufãr
::
COPY
);

62 
ouutT¿n¥Üt_
->
	`»£tBufãr
();

63 
ouutT¿n¥Üt_
->
	`g‘Wr™ePŒ
(4);

64 
ouutT¿n¥Üt_
->
	`wrÙeBy‹s
(4);

66 ià(
£rv”_
->
	`isWÜk”Th»adPoŞProûssšg
())

68 
£rv”_
->
	`wÜk”Th»adPoŞ
().
	`run
(
boo¡
::
	`bšd
(&
ThriáCÚÃùiÚ
::
´oûss
, 
this
));

72 
	`´oûss
();

75 
bufãr
->
	`»Œ›ve
(
äameSize_
);

76 
¡©e_
 = 
kEx³ùF¿meSize
;

80 
mÜe
 = 
çl£
;

84 
	}
}

86 
	gThriáCÚÃùiÚ
::
	$´oûss
()

88 
Œy


90 
´oûssÜ_
->
	`´oûss
(
šputPrÙocŞ_
, 
ouutPrÙocŞ_
, 
NULL
);

92 
ušt8_t
* 
buf
;

93 
ušt32_t
 
size
;

94 
ouutT¿n¥Üt_
->
	`g‘Bufãr
(&
buf
, &
size
);

96 
	`as£¹
(
size
 >= 4);

97 
ušt32_t
 
äameSize
 = 
¡©ic_ÿ¡
<ušt32_t>(
	`htÚl
(
size
 - 4));

98 
	`memıy
(
buf
, &
äameSize
, 4);

100 
cÚn_
->
	`£nd
(
buf
, 
size
);

101 } 
	`ÿtch
 (cÚ¡ 
TT¿n¥ÜtExû±iÚ
& 
ex
)

103 
LOG_ERROR
 << "ThriáS”v” TT¿n¥ÜtExû±iÚ: " << 
ex
.
	`wh©
();

104 
	`şo£
();

105 } 
	`ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
ex
)

107 
LOG_ERROR
 << "ThriáS”v” std::exû±iÚ: " << 
ex
.
	`wh©
();

108 
	`şo£
();

109 } 
	`ÿtch
 (...)

111 
LOG_ERROR
 << "ThriftServer unknownƒxception";

112 
	`şo£
();

114 
	}
}

116 
	gThriáCÚÃùiÚ
::
	$şo£
()

118 
nuÎT¿n¥Üt_
->
	`şo£
();

119 
çùÜyIÅutT¿n¥Üt_
->
	`şo£
();

120 
çùÜyOuutT¿n¥Üt_
->
	`şo£
();

121 
	}
}

	@contrib/thrift/ThriftConnection.h

1 #iâdeà
MUDUO_EXAMPLES_THRIFT_THRIFTCONNECTION_H


2 
	#MUDUO_EXAMPLES_THRIFT_THRIFTCONNECTION_H


	)

4 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

5 
	~<boo¡/nÚcİyabË.hµ
>

7 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

9 
	~<thriá/´ÙocŞ/TPrÙocŞ.h
>

10 
	~<thriá/Œª¥Üt/TBufãrT¿n¥Üts.h
>

11 
	~<thriá/Œª¥Üt/TT¿n¥ÜtUts.h
>

13 
usšg
 
	g­ache
::
thriá
::
TProûssÜ
;

14 
usšg
 
	g­ache
::
thriá
::
´ÙocŞ
::
TPrÙocŞ
;

15 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TMemÜyBufãr
;

16 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TNuÎT¿n¥Üt
;

17 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TT¿n¥Üt
;

18 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TT¿n¥ÜtExû±iÚ
;

20 
şass
 
	gThriáS”v”
;

22 
şass
 
	gThriáCÚÃùiÚ
 : 
boo¡
::
nÚcİyabË
,

23 
public
 
	gboo¡
::
’abË_sh¬ed_äom_this
<
ThriáCÚÃùiÚ
>

25 
public
:

26 
	eS‹


28 
kEx³ùF¿meSize
,

29 
	gkEx³ùF¿me


32 
ThriáCÚÃùiÚ
(
ThriáS”v”
* 
£rv”
, cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

34 
	g´iv©e
:

35 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

36 
muduo
::
Ãt
::
Bufãr
* 
bufãr
,

37 
muduo
::
Time¡amp
 
»ûiveTime
);

39 
´oûss
();

41 
şo£
();

43 
	g´iv©e
:

44 
ThriáS”v”
* 
£rv”_
;

45 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn_
;

47 
	gboo¡
::
sh¬ed_±r
<
TNuÎT¿n¥Üt
> 
nuÎT¿n¥Üt_
;

49 
	gboo¡
::
sh¬ed_±r
<
TMemÜyBufãr
> 
šputT¿n¥Üt_
;

50 
	gboo¡
::
sh¬ed_±r
<
TMemÜyBufãr
> 
ouutT¿n¥Üt_
;

52 
	gboo¡
::
sh¬ed_±r
<
TT¿n¥Üt
> 
çùÜyIÅutT¿n¥Üt_
;

53 
	gboo¡
::
sh¬ed_±r
<
TT¿n¥Üt
> 
çùÜyOuutT¿n¥Üt_
;

55 
	gboo¡
::
sh¬ed_±r
<
TPrÙocŞ
> 
šputPrÙocŞ_
;

56 
	gboo¡
::
sh¬ed_±r
<
TPrÙocŞ
> 
ouutPrÙocŞ_
;

58 
	gboo¡
::
sh¬ed_±r
<
TProûssÜ
> 
´oûssÜ_
;

60 
S‹
 
	g¡©e_
;

61 
ušt32_t
 
	gäameSize_
;

64 
	gboo¡
::
	tsh¬ed_±r
<
	tThriáCÚÃùiÚ
> 
	tThriáCÚÃùiÚPŒ
;

	@contrib/thrift/ThriftConnection.h

1 #iâdeà
MUDUO_EXAMPLES_THRIFT_THRIFTCONNECTION_H


2 
	#MUDUO_EXAMPLES_THRIFT_THRIFTCONNECTION_H


	)

4 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

5 
	~<boo¡/nÚcİyabË.hµ
>

7 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

9 
	~<thriá/´ÙocŞ/TPrÙocŞ.h
>

10 
	~<thriá/Œª¥Üt/TBufãrT¿n¥Üts.h
>

11 
	~<thriá/Œª¥Üt/TT¿n¥ÜtUts.h
>

13 
usšg
 
	g­ache
::
thriá
::
TProûssÜ
;

14 
usšg
 
	g­ache
::
thriá
::
´ÙocŞ
::
TPrÙocŞ
;

15 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TMemÜyBufãr
;

16 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TNuÎT¿n¥Üt
;

17 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TT¿n¥Üt
;

18 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TT¿n¥ÜtExû±iÚ
;

20 
şass
 
	gThriáS”v”
;

22 
şass
 
	gThriáCÚÃùiÚ
 : 
boo¡
::
nÚcİyabË
,

23 
public
 
	gboo¡
::
’abË_sh¬ed_äom_this
<
ThriáCÚÃùiÚ
>

25 
public
:

26 
	eS‹


28 
kEx³ùF¿meSize
,

29 
	gkEx³ùF¿me


32 
ThriáCÚÃùiÚ
(
ThriáS”v”
* 
£rv”
, cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

34 
	g´iv©e
:

35 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

36 
muduo
::
Ãt
::
Bufãr
* 
bufãr
,

37 
muduo
::
Time¡amp
 
»ûiveTime
);

39 
´oûss
();

41 
şo£
();

43 
	g´iv©e
:

44 
ThriáS”v”
* 
£rv”_
;

45 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn_
;

47 
	gboo¡
::
sh¬ed_±r
<
TNuÎT¿n¥Üt
> 
nuÎT¿n¥Üt_
;

49 
	gboo¡
::
sh¬ed_±r
<
TMemÜyBufãr
> 
šputT¿n¥Üt_
;

50 
	gboo¡
::
sh¬ed_±r
<
TMemÜyBufãr
> 
ouutT¿n¥Üt_
;

52 
	gboo¡
::
sh¬ed_±r
<
TT¿n¥Üt
> 
çùÜyIÅutT¿n¥Üt_
;

53 
	gboo¡
::
sh¬ed_±r
<
TT¿n¥Üt
> 
çùÜyOuutT¿n¥Üt_
;

55 
	gboo¡
::
sh¬ed_±r
<
TPrÙocŞ
> 
šputPrÙocŞ_
;

56 
	gboo¡
::
sh¬ed_±r
<
TPrÙocŞ
> 
ouutPrÙocŞ_
;

58 
	gboo¡
::
sh¬ed_±r
<
TProûssÜ
> 
´oûssÜ_
;

60 
S‹
 
	g¡©e_
;

61 
ušt32_t
 
	gäameSize_
;

64 
	gboo¡
::
	tsh¬ed_±r
<
	tThriáCÚÃùiÚ
> 
	tThriáCÚÃùiÚPŒ
;

	@contrib/thrift/ThriftServer.cc

1 
	~"ThriáS”v”.h
"

3 
	~<boo¡/bšd.hµ
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
usšg
 
Çme¥aû
 
	gmuduo
;

8 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

10 
	gThriáS”v”
::~
	$ThriáS”v”
()

12 
	}
}

14 
ThriáS”v”
::
	$£rve
()

16 
	`¡¬t
();

17 
	}
}

19 
	gThriáS”v”
::
	$¡¬t
()

21 ià(
numWÜk”Th»ads_
 > 0)

23 
wÜk”Th»adPoŞ_
.
	`¡¬t
(
numWÜk”Th»ads_
);

25 
£rv”_
.
	`¡¬t
();

26 
	}
}

28 
	gThriáS”v”
::
	$¡İ
()

30 ià(
numWÜk”Th»ads_
 > 0)

32 
wÜk”Th»adPoŞ_
.
	`¡İ
();

34 
£rv”_
.
	`g‘Loİ
()->
	`runAá”
(3.0, 
boo¡
::
	`bšd
(&
Ev’tLoİ
::
qu™
,

35 
£rv”_
.
	`g‘Loİ
()));

36 
	}
}

38 
	gThriáS”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

40 ià(
cÚn
->
	`cÚÃùed
())

42 
ThriáCÚÃùiÚPŒ
 
	`±r
(
Ãw
 
	`ThriáCÚÃùiÚ
(
this
, 
cÚn
));

43 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

44 
	`as£¹
(
cÚns_
.
	`fšd
(
cÚn
->
	`Çme
()è=ğcÚns_.
	`’d
());

45 
cÚns_
[
cÚn
->
	`Çme
()] = 
±r
;

49 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

50 
	`as£¹
(
cÚns_
.
	`fšd
(
cÚn
->
	`Çme
()è!ğcÚns_.
	`’d
());

51 
cÚns_
.
	`”a£
(
cÚn
->
	`Çme
());

53 
	}
}

	@contrib/thrift/ThriftServer.h

1 #iâdeà
MUDUO_EXAMPLES_THRIFT_THRIFTSERVER_H


2 
	#MUDUO_EXAMPLES_THRIFT_THRIFTSERVER_H


	)

4 
	~<m­
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<boo¡/nÚcİyabË.hµ
>

9 
	~<muduo/ba£/Th»adPoŞ.h
>

10 
	~<muduo/Ãt/TıS”v”.h
>

12 
	~<thriá/£rv”/TS”v”.h
>

14 
	~"ThriáCÚÃùiÚ.h
"

16 
usšg
 
	g­ache
::
thriá
::
TProûssÜ
;

17 
usšg
 
	g­ache
::
thriá
::
TProûssÜFaùÜy
;

18 
usšg
 
	g­ache
::
thriá
::
´ÙocŞ
::
TPrÙocŞFaùÜy
;

19 
usšg
 
	g­ache
::
thriá
::
£rv”
::
TS”v”
;

20 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TT¿n¥ÜtFaùÜy
;

22 
şass
 
	gThriáS”v”
 : 
boo¡
::
nÚcİyabË
,

23 
public
 
	gTS”v”


25 
	gpublic
:

26 
‹m¶©e
 <
ty³Çme
 
ProûssÜFaùÜy
>

27 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜFaùÜy
>& 
´oûssÜFaùÜy
,

28 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

29 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

30 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

31 
THRIFT_OVERLOAD_IF
(
ProûssÜFaùÜy
, 
TProûssÜFaùÜy
))

32 : 
TS”v”
(
´oûssÜFaùÜy
),

33 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

34 
numWÜk”Th»ads_
(0),

35 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

37 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

38 
this
, 
_1
));

41 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜ
>

42 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜ
>& 
´oûssÜ
,

43 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

44 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

45 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

46 
THRIFT_OVERLOAD_IF
(
ProûssÜ
, 
TProûssÜ
))

47 : 
TS”v”
(
´oûssÜ
),

48 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

49 
numWÜk”Th»ads_
(0),

50 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

52 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

53 
this
, 
_1
));

56 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜFaùÜy
>

57 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜFaùÜy
>& 
´oûssÜFaùÜy
,

58 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
´ÙocŞFaùÜy
,

59 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

60 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

61 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

62 
THRIFT_OVERLOAD_IF
(
ProûssÜFaùÜy
, 
TProûssÜFaùÜy
))

63 : 
TS”v”
(
´oûssÜFaùÜy
),

64 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

65 
numWÜk”Th»ads_
(0),

66 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

68 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

69 
this
, 
_1
));

70 
£tIÅutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

71 
£tOuutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

74 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜ
>

75 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜ
>& 
´oûssÜ
,

76 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
´ÙocŞFaùÜy
,

77 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

78 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

79 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

80 
THRIFT_OVERLOAD_IF
(
ProûssÜ
, 
TProûssÜ
))

81 : 
TS”v”
(
´oûssÜ
),

82 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

83 
numWÜk”Th»ads_
(0),

84 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

86 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

87 
this
, 
_1
));

88 
£tIÅutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

89 
£tOuutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

92 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜFaùÜy
>

93 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜFaùÜy
>& 
´oûssÜFaùÜy
,

94 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
Œª¥ÜtFaùÜy
,

95 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
´ÙocŞFaùÜy
,

96 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

97 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

98 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

99 
THRIFT_OVERLOAD_IF
(
ProûssÜFaùÜy
, 
TProûssÜFaùÜy
))

100 : 
TS”v”
(
´oûssÜFaùÜy
),

101 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

102 
numWÜk”Th»ads_
(0),

103 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

105 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

106 
this
, 
_1
));

107 
£tIÅutT¿n¥ÜtFaùÜy
(
Œª¥ÜtFaùÜy
);

108 
£tOuutT¿n¥ÜtFaùÜy
(
Œª¥ÜtFaùÜy
);

109 
£tIÅutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

110 
£tOuutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

113 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜ
>

114 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜ
>& 
´oûssÜ
,

115 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
Œª¥ÜtFaùÜy
,

116 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
´ÙocŞFaùÜy
,

117 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

118 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

119 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

120 
THRIFT_OVERLOAD_IF
(
ProûssÜ
, 
TProûssÜ
))

121 : 
TS”v”
(
´oûssÜ
),

122 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

123 
numWÜk”Th»ads_
(0),

124 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

126 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

127 
this
, 
_1
));

128 
£tIÅutT¿n¥ÜtFaùÜy
(
Œª¥ÜtFaùÜy
);

129 
£tOuutT¿n¥ÜtFaùÜy
(
Œª¥ÜtFaùÜy
);

130 
£tIÅutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

131 
£tOuutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

134 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜFaùÜy
>

135 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜFaùÜy
>& 
´oûssÜFaùÜy
,

136 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
šputT¿n¥ÜtFaùÜy
,

137 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
ouutT¿n¥ÜtFaùÜy
,

138 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
šputPrÙocŞFaùÜy
,

139 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
ouutPrÙocŞFaùÜy
,

140 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

141 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

142 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

143 
THRIFT_OVERLOAD_IF
(
ProûssÜFaùÜy
, 
TProûssÜFaùÜy
))

144 : 
TS”v”
(
´oûssÜFaùÜy
),

145 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

146 
numWÜk”Th»ads_
(0),

147 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

149 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

150 
this
, 
_1
));

151 
£tIÅutT¿n¥ÜtFaùÜy
(
šputT¿n¥ÜtFaùÜy
);

152 
£tOuutT¿n¥ÜtFaùÜy
(
ouutT¿n¥ÜtFaùÜy
);

153 
£tIÅutPrÙocŞFaùÜy
(
šputPrÙocŞFaùÜy
);

154 
£tOuutPrÙocŞFaùÜy
(
ouutPrÙocŞFaùÜy
);

157 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜ
>

158 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜ
>& 
´oûssÜ
,

159 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
šputT¿n¥ÜtFaùÜy
,

160 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
ouutT¿n¥ÜtFaùÜy
,

161 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
šputPrÙocŞFaùÜy
,

162 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
ouutPrÙocŞFaùÜy
,

163 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

164 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

165 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

166 
THRIFT_OVERLOAD_IF
(
ProûssÜ
, 
TProûssÜ
))

167 : 
TS”v”
(
´oûssÜ
),

168 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

169 
numWÜk”Th»ads_
(0),

170 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

172 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

173 
this
, 
_1
));

174 
£tIÅutT¿n¥ÜtFaùÜy
(
šputT¿n¥ÜtFaùÜy
);

175 
£tOuutT¿n¥ÜtFaùÜy
(
ouutT¿n¥ÜtFaùÜy
);

176 
£tIÅutPrÙocŞFaùÜy
(
šputPrÙocŞFaùÜy
);

177 
£tOuutPrÙocŞFaùÜy
(
ouutPrÙocŞFaùÜy
);

180 
	gvœtu®
 ~
ThriáS”v”
();

182 
£rve
();

184 
¡¬t
();

186 
¡İ
();

188 
	gmuduo
::
Th»adPoŞ
& 
wÜk”Th»adPoŞ
()

190  
wÜk”Th»adPoŞ_
;

193 
boŞ
 
isWÜk”Th»adPoŞProûssšg
() const

195  
	gnumWÜk”Th»ads_
 != 0;

198 
£tTh»adNum
(
numTh»ads
)

200 
	g£rv”_
.
£tTh»adNum
(
numTh»ads
);

203 
£tWÜk”Th»adNum
(
numWÜk”Th»ads
)

205 
as£¹
(
numWÜk”Th»ads
 > 0);

206 
	gnumWÜk”Th»ads_
 = 
numWÜk”Th»ads
;

209 
	g´iv©e
:

210 
ä›nd
 
şass
 
ThriáCÚÃùiÚ
;

212 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

214 
	g´iv©e
:

215 
muduo
::
Ãt
::
TıS”v”
 
£rv”_
;

216 
	gnumWÜk”Th»ads_
;

217 
	gmuduo
::
Th»adPoŞ
 
wÜk”Th»adPoŞ_
;

218 
	gmuduo
::
Mu‹xLock
 
mu‹x_
;

219 
	g¡d
::
m­
<
muduo
::
¡ršg
, 
	gThriáCÚÃùiÚPŒ
> 
	gcÚns_
;

	@contrib/thrift/ThriftServer.h

1 #iâdeà
MUDUO_EXAMPLES_THRIFT_THRIFTSERVER_H


2 
	#MUDUO_EXAMPLES_THRIFT_THRIFTSERVER_H


	)

4 
	~<m­
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<boo¡/nÚcİyabË.hµ
>

9 
	~<muduo/ba£/Th»adPoŞ.h
>

10 
	~<muduo/Ãt/TıS”v”.h
>

12 
	~<thriá/£rv”/TS”v”.h
>

14 
	~"ThriáCÚÃùiÚ.h
"

16 
usšg
 
	g­ache
::
thriá
::
TProûssÜ
;

17 
usšg
 
	g­ache
::
thriá
::
TProûssÜFaùÜy
;

18 
usšg
 
	g­ache
::
thriá
::
´ÙocŞ
::
TPrÙocŞFaùÜy
;

19 
usšg
 
	g­ache
::
thriá
::
£rv”
::
TS”v”
;

20 
usšg
 
	g­ache
::
thriá
::
Œª¥Üt
::
TT¿n¥ÜtFaùÜy
;

22 
şass
 
	gThriáS”v”
 : 
boo¡
::
nÚcİyabË
,

23 
public
 
	gTS”v”


25 
	gpublic
:

26 
‹m¶©e
 <
ty³Çme
 
ProûssÜFaùÜy
>

27 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜFaùÜy
>& 
´oûssÜFaùÜy
,

28 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

29 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

30 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

31 
THRIFT_OVERLOAD_IF
(
ProûssÜFaùÜy
, 
TProûssÜFaùÜy
))

32 : 
TS”v”
(
´oûssÜFaùÜy
),

33 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

34 
numWÜk”Th»ads_
(0),

35 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

37 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

38 
this
, 
_1
));

41 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜ
>

42 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜ
>& 
´oûssÜ
,

43 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

44 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

45 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

46 
THRIFT_OVERLOAD_IF
(
ProûssÜ
, 
TProûssÜ
))

47 : 
TS”v”
(
´oûssÜ
),

48 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

49 
numWÜk”Th»ads_
(0),

50 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

52 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

53 
this
, 
_1
));

56 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜFaùÜy
>

57 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜFaùÜy
>& 
´oûssÜFaùÜy
,

58 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
´ÙocŞFaùÜy
,

59 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

60 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

61 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

62 
THRIFT_OVERLOAD_IF
(
ProûssÜFaùÜy
, 
TProûssÜFaùÜy
))

63 : 
TS”v”
(
´oûssÜFaùÜy
),

64 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

65 
numWÜk”Th»ads_
(0),

66 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

68 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

69 
this
, 
_1
));

70 
£tIÅutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

71 
£tOuutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

74 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜ
>

75 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜ
>& 
´oûssÜ
,

76 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
´ÙocŞFaùÜy
,

77 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

78 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

79 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

80 
THRIFT_OVERLOAD_IF
(
ProûssÜ
, 
TProûssÜ
))

81 : 
TS”v”
(
´oûssÜ
),

82 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

83 
numWÜk”Th»ads_
(0),

84 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

86 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

87 
this
, 
_1
));

88 
£tIÅutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

89 
£tOuutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

92 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜFaùÜy
>

93 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜFaùÜy
>& 
´oûssÜFaùÜy
,

94 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
Œª¥ÜtFaùÜy
,

95 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
´ÙocŞFaùÜy
,

96 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

97 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

98 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

99 
THRIFT_OVERLOAD_IF
(
ProûssÜFaùÜy
, 
TProûssÜFaùÜy
))

100 : 
TS”v”
(
´oûssÜFaùÜy
),

101 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

102 
numWÜk”Th»ads_
(0),

103 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

105 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

106 
this
, 
_1
));

107 
£tIÅutT¿n¥ÜtFaùÜy
(
Œª¥ÜtFaùÜy
);

108 
£tOuutT¿n¥ÜtFaùÜy
(
Œª¥ÜtFaùÜy
);

109 
£tIÅutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

110 
£tOuutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

113 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜ
>

114 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜ
>& 
´oûssÜ
,

115 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
Œª¥ÜtFaùÜy
,

116 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
´ÙocŞFaùÜy
,

117 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

118 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

119 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

120 
THRIFT_OVERLOAD_IF
(
ProûssÜ
, 
TProûssÜ
))

121 : 
TS”v”
(
´oûssÜ
),

122 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

123 
numWÜk”Th»ads_
(0),

124 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

126 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

127 
this
, 
_1
));

128 
£tIÅutT¿n¥ÜtFaùÜy
(
Œª¥ÜtFaùÜy
);

129 
£tOuutT¿n¥ÜtFaùÜy
(
Œª¥ÜtFaùÜy
);

130 
£tIÅutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

131 
£tOuutPrÙocŞFaùÜy
(
´ÙocŞFaùÜy
);

134 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜFaùÜy
>

135 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜFaùÜy
>& 
´oûssÜFaùÜy
,

136 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
šputT¿n¥ÜtFaùÜy
,

137 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
ouutT¿n¥ÜtFaùÜy
,

138 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
šputPrÙocŞFaùÜy
,

139 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
ouutPrÙocŞFaùÜy
,

140 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

141 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

142 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

143 
THRIFT_OVERLOAD_IF
(
ProûssÜFaùÜy
, 
TProûssÜFaùÜy
))

144 : 
TS”v”
(
´oûssÜFaùÜy
),

145 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

146 
numWÜk”Th»ads_
(0),

147 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

149 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

150 
this
, 
_1
));

151 
£tIÅutT¿n¥ÜtFaùÜy
(
šputT¿n¥ÜtFaùÜy
);

152 
£tOuutT¿n¥ÜtFaùÜy
(
ouutT¿n¥ÜtFaùÜy
);

153 
£tIÅutPrÙocŞFaùÜy
(
šputPrÙocŞFaùÜy
);

154 
£tOuutPrÙocŞFaùÜy
(
ouutPrÙocŞFaùÜy
);

157 
	g‹m¶©e
 <
ty³Çme
 
	gProûssÜ
>

158 
ThriáS”v”
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ProûssÜ
>& 
´oûssÜ
,

159 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
šputT¿n¥ÜtFaùÜy
,

160 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TT¿n¥ÜtFaùÜy
>& 
ouutT¿n¥ÜtFaùÜy
,

161 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
šputPrÙocŞFaùÜy
,

162 cÚ¡ 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
>& 
ouutPrÙocŞFaùÜy
,

163 
muduo
::
Ãt
::
Ev’tLoİ
* 
ev’oİ
,

164 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
addr
,

165 cÚ¡ 
muduo
::
¡ršg
& 
Çme
,

166 
THRIFT_OVERLOAD_IF
(
ProûssÜ
, 
TProûssÜ
))

167 : 
TS”v”
(
´oûssÜ
),

168 
£rv”_
(
ev’oİ
, 
addr
, 
Çme
),

169 
numWÜk”Th»ads_
(0),

170 
wÜk”Th»adPoŞ_
(
Çme
 + 
muduo
::
¡ršg
("WorkerThreadPool"))

172 
£rv”_
.
£tCÚÃùiÚC®lback
(
boo¡
::
bšd
(&
ThriáS”v”
::
ÚCÚÃùiÚ
,

173 
this
, 
_1
));

174 
£tIÅutT¿n¥ÜtFaùÜy
(
šputT¿n¥ÜtFaùÜy
);

175 
£tOuutT¿n¥ÜtFaùÜy
(
ouutT¿n¥ÜtFaùÜy
);

176 
£tIÅutPrÙocŞFaùÜy
(
šputPrÙocŞFaùÜy
);

177 
£tOuutPrÙocŞFaùÜy
(
ouutPrÙocŞFaùÜy
);

180 
	gvœtu®
 ~
ThriáS”v”
();

182 
£rve
();

184 
¡¬t
();

186 
¡İ
();

188 
	gmuduo
::
Th»adPoŞ
& 
wÜk”Th»adPoŞ
()

190  
wÜk”Th»adPoŞ_
;

193 
boŞ
 
isWÜk”Th»adPoŞProûssšg
() const

195  
	gnumWÜk”Th»ads_
 != 0;

198 
£tTh»adNum
(
numTh»ads
)

200 
	g£rv”_
.
£tTh»adNum
(
numTh»ads
);

203 
£tWÜk”Th»adNum
(
numWÜk”Th»ads
)

205 
as£¹
(
numWÜk”Th»ads
 > 0);

206 
	gnumWÜk”Th»ads_
 = 
numWÜk”Th»ads
;

209 
	g´iv©e
:

210 
ä›nd
 
şass
 
ThriáCÚÃùiÚ
;

212 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

214 
	g´iv©e
:

215 
muduo
::
Ãt
::
TıS”v”
 
£rv”_
;

216 
	gnumWÜk”Th»ads_
;

217 
	gmuduo
::
Th»adPoŞ
 
wÜk”Th»adPoŞ_
;

218 
	gmuduo
::
Mu‹xLock
 
mu‹x_
;

219 
	g¡d
::
m­
<
muduo
::
¡ršg
, 
	gThriáCÚÃùiÚPŒ
> 
	gcÚns_
;

	@contrib/thrift/tests/echo/EchoServer.cc

1 
	~<uni¡d.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~"ThriáS”v”.h
"

8 
	~"Echo.h
"

10 
usšg
 
Çme¥aû
 
	gmuduo
;

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 
usšg
 
Çme¥aû
 
	gecho
;

15 şas 
	cEchoHªdËr
 : 
vœtu®
 
public
 
EchoIf


17 
public
:

18 
	$EchoHªdËr
()

22 
	`echo
(
¡d
::
¡ršg
& 
¡r
, cÚ¡ std::¡ršg& 
s
)

24 
LOG_INFO
 << "EchoHªdËr::echo:" << 
s
;

25 
¡r
 = 
s
;

26 
	}
}

30 
	$NumCPU
()

32  
¡©ic_ÿ¡
<>(
	`syscÚf
(
_SC_NPROCESSORS_ONLN
));

33 
	}
}

35 
	$maš
(
¬gc
, **
¬gv
)

37 
Ev’tLoİ
 
ev’oİ
;

38 
IÃtAdd»ss
 
	`addr
("127.0.0.1", 9090);

39 
¡ršg
 
	`Çme
("EchoServer");

41 
boo¡
::
sh¬ed_±r
<
EchoHªdËr
> 
	`hªdËr
(
Ãw
 
	`EchoHªdËr
());

42 
boo¡
::
sh¬ed_±r
<
TProûssÜ
> 
	`´oûssÜ
(
Ãw
 
	`EchoProûssÜ
(
hªdËr
));

44 
ThriáS”v”
 
	`£rv”
(
´oûssÜ
, &
ev’oİ
, 
addr
, 
Çme
);

45 
£rv”
.
	`£tWÜk”Th»adNum
(
	`NumCPU
() * 2);

46 
£rv”
.
	`¡¬t
();

47 
ev’oİ
.
	`loİ
();

50 
	}
}

	@contrib/thrift/tests/ping/PingServer.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

4 
	~<thriá/´ÙocŞ/TCom·ùPrÙocŞ.h
>

6 
	~"ThriáS”v”.h
"

8 
	~"Pšg.h
"

10 
usšg
 
Çme¥aû
 
	gmuduo
;

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 
usšg
 
	g­ache
::
thriá
::
´ÙocŞ
::
TCom·ùPrÙocŞFaùÜy
;

15 
usšg
 
Çme¥aû
 
	gpšg
;

17 şas 
	cPšgHªdËr
 : 
vœtu®
 
public
 
PšgIf


19 
public
:

20 
	$PšgHªdËr
()

24 
	$pšg
()

26 
LOG_INFO
 << "ping";

27 
	}
}

31 
	$maš
(
¬gc
, **
¬gv
)

33 
Ev’tLoİ
 
ev’oİ
;

34 
IÃtAdd»ss
 
	`addr
("127.0.0.1", 9090);

35 
¡ršg
 
	`Çme
("PingServer");

37 
boo¡
::
sh¬ed_±r
<
PšgHªdËr
> 
	`hªdËr
(
Ãw
 
	`PšgHªdËr
());

38 
boo¡
::
sh¬ed_±r
<
TProûssÜ
> 
	`´oûssÜ
(
Ãw
 
	`PšgProûssÜ
(
hªdËr
));

39 
boo¡
::
sh¬ed_±r
<
TPrÙocŞFaùÜy
> 
	`´ÙcŞFaùÜy
(
Ãw
 
	`TCom·ùPrÙocŞFaùÜy
());

41 
ThriáS”v”
 
	`£rv”
(
´oûssÜ
, 
´ÙcŞFaùÜy
, &
ev’oİ
, 
addr
, 
Çme
);

42 
£rv”
.
	`¡¬t
();

43 
ev’oİ
.
	`loİ
();

46 
	}
}

	@examples/ace/logging/client.cc

1 
	~<exam¶es/aû/loggšg/log»cÜd.pb.h
>

3 
	~<muduo/ba£/Mu‹x.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/ProûssInfo.h
>

6 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

8 
	~<muduo/Ãt/TıCl›Á.h
>

9 
	~<muduo/Ãt/´Ùobuf/PrÙobufCodecL™e.h
>

11 
	~<boo¡/bšd.hµ
>

13 
	~<io¡»am
>

14 
	~<¡dio.h
>

16 
usšg
 
Çme¥aû
 
	gmuduo
;

17 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

21 
Çme¥aû
 
	gloggšg


23 cÚ¡ 
logg
[] = "LOG0";

24 
	gPrÙobufCodecL™eT
<
	tLogRecÜd
, 
	tlogg
> 
	tCodec
;

27 şas 
	cLogCl›Á
 : 
boo¡
::
nÚcİyabË


29 
public
:

30 
LogCl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
)

31 : 
ş›Á_
(
loİ
, 
£rv”Addr
, "LogClient"),

32 
codec_
(
boo¡
::
bšd
(&
LogCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
))

34 
	gş›Á_
.
£tCÚÃùiÚC®lback
(

35 
boo¡
::
bšd
(&
LogCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

36 
	gş›Á_
.
£tMes§geC®lback
(

37 
boo¡
::
bšd
(&
Codec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

38 
	gş›Á_
.
’abËR‘ry
();

41 
cÚÃù
()

43 
	gş›Á_
.
cÚÃù
();

46 
discÚÃù
()

48 
	gş›Á_
.
discÚÃù
();

51 
wr™e
(cÚ¡ 
SŒšgP›û
& 
mes§ge
)

53 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

54 
upd©eLogRecÜd
(
mes§ge
);

55 ià(
	gcÚÃùiÚ_
)

57 
	gcodec_
.
£nd
(
cÚÃùiÚ_
, 
logRecÜd_
);

61 
	gLOG_WARN
 << "NOT CONNECTED";

65 
	g´iv©e
:

66 
ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

68 
LOG_INFO
 << 
cÚn
->
loÿlAdd»ss
().
toIpPÜt
() << " -> "

69 << 
cÚn
->
³”Add»ss
().
toIpPÜt
() << " is "

70 << (
cÚn
->
cÚÃùed
() ? "UP" : "DOWN");

72 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

73 ià(
	gcÚn
->
cÚÃùed
())

75 
	gcÚÃùiÚ_
 = 
cÚn
;

76 
LogRecÜd_H—¹b—t
* 
	ghb
 = 
logRecÜd_
.
mubË_h—¹b—t
();

77 
	ghb
->
£t_ho¡Çme
(
ProûssInfo
::
ho¡Çme
().
c_¡r
());

78 
	ghb
->
£t_´oûss_Çme
(
ProûssInfo
::
´oúame
().
c_¡r
());

79 
	ghb
->
£t_´oûss_id
(
ProûssInfo
::
pid
());

80 
	ghb
->
£t_´oûss_¡¬t_time
(
ProûssInfo
::
¡¬tTime
().
miüoSecÚdsSšûEpoch
());

81 
	ghb
->
£t_u£ºame
(
ProûssInfo
::
u£ºame
().
c_¡r
());

82 
upd©eLogRecÜd
("Heartbeat");

83 
	gcodec_
.
£nd
(
cÚÃùiÚ_
, 
logRecÜd_
);

84 
	glogRecÜd_
.
ş—r_h—¹b—t
();

85 
	gLOG_INFO
 << "Type message below:";

89 
	gcÚÃùiÚ_
.
»£t
();

93 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

94 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

95 
Time¡amp
)

98 
LogRecÜd
* 
	glogRecÜd
 = 
muduo
::
down_ÿ¡
<LogRecÜd*>(
mes§ge
.
g‘
());

99 
	gLOG_WARN
 << 
	glogRecÜd
->
DebugSŒšg
();

102 
upd©eLogRecÜd
(cÚ¡ 
SŒšgP›û
& 
mes§ge
)

104 
	gmu‹x_
.
as£¹Locked
();

105 
	glogRecÜd_
.
£t_Ëv–
(1);

106 
	glogRecÜd_
.
£t_th»ad_id
(
Cu¼’tTh»ad
::
tid
());

107 
	glogRecÜd_
.
£t_time¡amp
(
Time¡amp
::
now
().
miüoSecÚdsSšûEpoch
());

108 
	glogRecÜd_
.
£t_mes§ge
(
mes§ge
.
d©a
(), mes§ge.
size
());

111 
TıCl›Á
 
	gş›Á_
;

112 
Codec
 
	gcodec_
;

113 
Mu‹xLock
 
	gmu‹x_
;

114 
LogRecÜd
 
	glogRecÜd_
;

115 
TıCÚÃùiÚPŒ
 
	gcÚÃùiÚ_
;

120 
	$maš
(
¬gc
, * 
¬gv
[])

122 ià(
¬gc
 < 3)

124 
	`´štf
("u§ge: % £rv”_ s”v”_pÜt\n", 
¬gv
[0]);

128 
Ev’tLoİTh»ad
 
loİTh»ad
;

129 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

130 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 
pÜt
);

132 
loggšg
::
LogCl›Á
 
	`ş›Á
(
loİTh»ad
.
	`¡¬tLoİ
(), 
£rv”Addr
);

133 
ş›Á
.
	`cÚÃù
();

134 
¡d
::
¡ršg
 
lše
;

135 
¡d
::
	`g‘lše
(¡d::
cš
, 
lše
))

137 
ş›Á
.
	`wr™e
(
lše
);

139 
ş›Á
.
	`discÚÃù
();

140 
Cu¼’tTh»ad
::
	`¦“pU£c
(1000*1000);

142 
googË
::
´Ùobuf
::
	`ShutdownPrÙobufLib¿ry
();

143 
	}
}

	@examples/ace/logging/server.cc

1 
	~<exam¶es/aû/loggšg/log»cÜd.pb.h
>

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/FeUt.h
>

5 
	~<muduo/ba£/Loggšg.h
>

6 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<muduo/Ãt/TıS”v”.h
>

8 
	~<muduo/Ãt/´Ùobuf/PrÙobufCodecL™e.h
>

10 
	~<boo¡/bšd.hµ
>

12 
	~<¡dio.h
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 
Çme¥aû
 
	gloggšg


19 cÚ¡ 
logg
[] = "LOG0";

20 
	gPrÙobufCodecL™eT
<
	tLogRecÜd
, 
	tlogg
> 
	tCodec
;

22 şas 
	cSessiÚ
 : 
boo¡
::
nÚcİyabË


24 
public
:

25 
ex¶ic™
 
SessiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

26 : 
codec_
(
boo¡
::
bšd
(&
SessiÚ
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

27 
fe_
(
g‘FeName
(
cÚn
))

29 
	gcÚn
->
£tMes§geC®lback
(

30 
boo¡
::
bšd
(&
Codec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

33 
	g´iv©e
:

37 
¡ršg
 
g‘FeName
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

39 
¡ršg
 
f’ame
;

40 
	gf’ame
 +ğ
cÚn
->
³”Add»ss
().
toIp
();

42 
	gtimebuf
[32];

43 
tm
 
	gtm
;

44 
time_t
 
	gnow
 = 
time
(
NULL
);

45 
gmtime_r
(&
now
, &
tm
);

46 
¡ráime
(
timebuf
, imebuf, ".%Y%m%d-%H%M%S.", &
tm
);

47 
	gf’ame
 +ğ
timebuf
;

49 
	gbuf
[32];

50 
¢´štf
(
buf
,  buf, "%d", 
glob®CouÁ_
.
šüem’tAndG‘
());

51 
	gf’ame
 +ğ
buf
;

53 
	gf’ame
 += ".log";

54 
	gLOG_INFO
 << "SessiÚ oà" << 
	gcÚn
->
Çme
(è<< " f" << 
	gf’ame
;

55  
	gf’ame
;

58 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

59 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

60 
Time¡amp
 
time
)

62 
LogRecÜd
* 
	glogRecÜd
 = 
muduo
::
down_ÿ¡
<LogRecÜd*>(
mes§ge
.
g‘
());

63 ià(
	glogRecÜd
->
has_h—¹b—t
())

67 cÚ¡ * 
	g£p
 = "==========\n";

68 
	g¡d
::
¡ršg
 
¡r
 = 
logRecÜd
->
DebugSŒšg
();

69 
	gfe_
.
­³nd
(
¡r
.
c_¡r
(), sŒ.
size
());

70 
	gfe_
.
­³nd
(
£p
, 
¡¾’
(sep));

71 
	gLOG_DEBUG
 << 
	g¡r
;

74 
Codec
 
	gcodec_
;

75 
	gFeUt
::
Aµ’dFe
 
fe_
;

76 
AtomicIÁ32
 
	gglob®CouÁ_
;

78 
	gboo¡
::
	tsh¬ed_±r
<
	tSessiÚ
> 
	tSessiÚPŒ
;

80 
AtomicIÁ32
 
	gSessiÚ
::
glob®CouÁ_
;

82 şas 
	cLogS”v”
 : 
boo¡
::
nÚcİyabË


84 
public
:

85 
LogS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, 
numTh»ads
)

86 : 
loİ_
(
loİ
),

87 
£rv”_
(
loİ_
, 
li¡’Addr
, "AceLoggingServer")

89 
	g£rv”_
.
£tCÚÃùiÚC®lback
(

90 
boo¡
::
bšd
(&
LogS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

91 ià(
	gnumTh»ads
 > 1)

93 
	g£rv”_
.
£tTh»adNum
(
numTh»ads
);

97 
¡¬t
()

99 
	g£rv”_
.
¡¬t
();

102 
	g´iv©e
:

103 
ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

105 ià(
cÚn
->
cÚÃùed
())

107 
SessiÚPŒ
 
£ssiÚ
(
Ãw
 
SessiÚ
(
cÚn
));

108 
	gcÚn
->
£tCÚ‹xt
(
£ssiÚ
);

112 
	gcÚn
->
£tCÚ‹xt
(
SessiÚPŒ
());

116 
Ev’tLoİ
* 
	gloİ_
;

117 
TıS”v”
 
	g£rv”_
;

122 
	$maš
(
¬gc
, * 
¬gv
[])

124 
Ev’tLoİ
 
loİ
;

125 
pÜt
 = 
¬gc
 > 1 ? 
	`©oi
(
¬gv
[1]) : 50000;

126 
LOG_INFO
 << "Li¡’ oÀpÜˆ" << 
pÜt
;

127 
IÃtAdd»ss
 
	`li¡’Addr
(
¡©ic_ÿ¡
<
ušt16_t
>(
pÜt
));

128 
numTh»ads
 = 
¬gc
 > 2 ? 
	`©oi
(
¬gv
[2]) : 1;

129 
loggšg
::
LogS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
numTh»ads
);

130 
£rv”
.
	`¡¬t
();

131 
loİ
.
	`loİ
();

133 
	}
}

	@examples/ace/ttcp/common.cc

1 
	~<exam¶es/aû/‰ı/commÚ.h
>

3 
	~<boo¡/´og¿m_İtiÚs.hµ
>

5 
	~<io¡»am
>

7 
	~<Ãtdb.h
>

8 
	~<¡dio.h
>

10 
Çme¥aû
 
	gpo
 = 
boo¡
::
´og¿m_İtiÚs
;

12 
boŞ
 
	$·r£CommªdLše
(
¬gc
, * 
¬gv
[], 
O±iÚs
* 
İt
)

14 
po
::
İtiÚs_desütiÚ
 
	`desc
("Allowed options");

15 
desc
.
	`add_İtiÚs
()

17 ("pÜt,p", 
po
::
v®ue
<
ušt16_t
>(&
İt
->
pÜt
)->
	`deçuÉ_v®ue
(5001), "TCP…ort")

18 ("Ëngth,l", 
po
::
v®ue
<>(&
İt
->
Ëngth
)->
	`deçuÉ_v®ue
(65536), "Buffer†ength")

19 ("numb”,n", 
po
::
v®ue
<>(&
İt
->
numb”
)->
	`deçuÉ_v®ue
(8192), "Number of buffers")

20 ("Œªs,t", 
po
::
v®ue
<
¡d
::
¡ršg
>(&
İt
->
ho¡
), "Transmit")

25 
po
::
v¬ŸbËs_m­
 
vm
;

26 
po
::
	`¡Üe
Õo::
	`·r£_commªd_lše
(
¬gc
, 
¬gv
, 
desc
), 
vm
);

27 
po
::
	`nÙify
(
vm
);

29 
İt
->
Œªsm™
 = 
vm
.
	`couÁ
("trans");

30 
İt
->
»ûive
 = 
vm
.
	`couÁ
("recv");

31 
İt
->
nod–ay
 = 
vm
.
	`couÁ
("nodelay");

32 ià(
vm
.
	`couÁ
("help"))

34 
¡d
::
cout
 << 
desc
 << std::
’dl
;

35  
çl£
;

38 ià(
İt
->
Œªsm™
 =ğİt->
»ûive
)

40 
	`´štf
("either -t or -r must be specified.\n");

41  
çl£
;

44 
	`´štf
("pÜˆğ%d\n", 
İt
->
pÜt
);

45 ià(
İt
->
Œªsm™
)

47 
	`´štf
("bufã¸Ëngth = %d\n", 
İt
->
Ëngth
);

48 
	`´štf
("numb” oàbufãr ğ%d\n", 
İt
->
numb”
);

52 
	`´štf
("accepting...\n");

54  
Œue
;

55 
	}
}

57 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wold-style-cast"

59 
sockaddr_š
 
	$»sŞveOrD›
(cÚ¡ * 
ho¡
, 
ušt16_t
 
pÜt
)

61 
ho¡’t
* 
he
 = ::
	`g‘ho¡byÇme
(
ho¡
);

62 ià(!
he
)

64 
	`³¼Ü
("gethostbyname");

65 
	`ex™
(1);

67 
	`as£¹
(
he
->
h_add¹y³
 =ğ
AF_INET
 && he->
h_Ëngth
 =ğ(
ušt32_t
));

68 
sockaddr_š
 
addr
;

69 
	`bz”o
(&
addr
, (addr));

70 
addr
.
sš_çmy
 = 
AF_INET
;

71 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

72 
addr
.
sš_addr
 = *
»š‹½»t_ÿ¡
<
š_addr
*>(
he
->
h_addr
);

73  
addr
;

74 
	}
}

	@examples/ace/ttcp/common.h

1 #´agm¨
Úû


3 
	~<¡ršg
>

4 
	~<¡dšt.h
>

6 
	sO±iÚs


8 
ušt16_t
 
	mpÜt
;

9 
	mËngth
;

10 
	mnumb”
;

11 
boŞ
 
	mŒªsm™
, 
	m»ûive
, 
	mnod–ay
;

12 
	m¡d
::
¡ršg
 
ho¡
;

13 
O±iÚs
()

14 : 
pÜt
(0), 
Ëngth
(0), 
numb”
(0),

15 
Œªsm™
(
çl£
), 
»ûive
(çl£), 
nod–ay
(false)

20 
boŞ
 
·r£CommªdLše
(
¬gc
, * 
¬gv
[], 
O±iÚs
* 
İt
);

21 
sockaddr_š
 
»sŞveOrD›
(cÚ¡ * 
ho¡
, 
ušt16_t
 
pÜt
);

23 
	sSessiÚMes§ge


25 
št32_t
 
	mnumb”
;

26 
št32_t
 
	mËngth
;

27 } 
__©Œibu‹__
 ((
__·cked__
));

29 
	sPaylßdMes§ge


31 
št32_t
 
	mËngth
;

32 
	md©a
[0];

35 
Œªsm™
(cÚ¡ 
O±iÚs
& 
İt
);

37 
»ûive
(cÚ¡ 
O±iÚs
& 
İt
);

	@examples/ace/ttcp/common.h

1 #´agm¨
Úû


3 
	~<¡ršg
>

4 
	~<¡dšt.h
>

6 
	sO±iÚs


8 
ušt16_t
 
	mpÜt
;

9 
	mËngth
;

10 
	mnumb”
;

11 
boŞ
 
	mŒªsm™
, 
	m»ûive
, 
	mnod–ay
;

12 
	m¡d
::
¡ršg
 
ho¡
;

13 
O±iÚs
()

14 : 
pÜt
(0), 
Ëngth
(0), 
numb”
(0),

15 
Œªsm™
(
çl£
), 
»ûive
(çl£), 
nod–ay
(false)

20 
boŞ
 
·r£CommªdLše
(
¬gc
, * 
¬gv
[], 
O±iÚs
* 
İt
);

21 
sockaddr_š
 
»sŞveOrD›
(cÚ¡ * 
ho¡
, 
ušt16_t
 
pÜt
);

23 
	sSessiÚMes§ge


25 
št32_t
 
	mnumb”
;

26 
št32_t
 
	mËngth
;

27 } 
__©Œibu‹__
 ((
__·cked__
));

29 
	sPaylßdMes§ge


31 
št32_t
 
	mËngth
;

32 
	md©a
[0];

35 
Œªsm™
(cÚ¡ 
O±iÚs
& 
İt
);

37 
»ûive
(cÚ¡ 
O±iÚs
& 
İt
);

	@examples/ace/ttcp/main.cc

1 
	~<exam¶es/aû/‰ı/commÚ.h
>

3 
	~<as£¹.h
>

5 
	$maš
(
¬gc
, * 
¬gv
[])

7 
O±iÚs
 
İtiÚs
;

8 ià(
	`·r£CommªdLše
(
¬gc
, 
¬gv
, &
İtiÚs
))

10 ià(
İtiÚs
.
Œªsm™
)

12 
	`Œªsm™
(
İtiÚs
);

14 ià(
İtiÚs
.
»ûive
)

16 
	`»ûive
(
İtiÚs
);

20 
	`as£¹
(0);

23 
	}
}

	@examples/ace/ttcp/ttcp.cc

1 
	~<exam¶es/aû/‰ı/commÚ.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/TıCl›Á.h
>

6 
	~<muduo/Ãt/TıS”v”.h
>

8 
	~<boo¡/bšd.hµ
>

10 
	~<¡dio.h
>

12 
usšg
 
Çme¥aû
 
	gmuduo
;

13 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

15 
Ev’tLoİ
* 
	gg_loİ
;

17 
	sCÚ‹xt


19 
	mcouÁ
;

20 
št64_t
 
	mby‹s
;

21 
SessiÚMes§ge
 
	m£ssiÚ
;

22 
Bufãr
 
	mouut
;

24 
CÚ‹xt
()

25 : 
couÁ
(0),

26 
by‹s
(0)

28 
	m£ssiÚ
.
	mnumb”
 = 0;

29 
	m£ssiÚ
.
	mËngth
 = 0;

37 
Çme¥aû
 
	gŒªs


40 
ÚCÚÃùiÚ
(cÚ¡ 
O±iÚs
& 
İt
, cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

42 ià(
	gcÚn
->
cÚÃùed
())

44 
´štf
("connected\n");

45 
CÚ‹xt
 
	gcÚ‹xt
;

46 
	gcÚ‹xt
.
	gcouÁ
 = 1;

47 
	gcÚ‹xt
.
	gby‹s
 = 
İt
.
Ëngth
;

48 
	gcÚ‹xt
.
	g£ssiÚ
.
	gnumb”
 = 
İt
.
numb”
;

49 
	gcÚ‹xt
.
	g£ssiÚ
.
	gËngth
 = 
İt
.
Ëngth
;

50 
	gcÚ‹xt
.
	gouut
.
­³ndIÁ32
(
İt
.
Ëngth
);

51 
	gcÚ‹xt
.
	gouut
.
’su»Wr™abËBy‹s
(
İt
.
Ëngth
);

52 
	gi
 = 0; i < 
	gİt
.
	gËngth
; ++i)

54 
	gcÚ‹xt
.
	gouut
.
begšWr™e
()[
i
] = "0123456789ABCDEF"[i % 16];

56 
	gcÚ‹xt
.
	gouut
.
hasWr™‹n
(
İt
.
Ëngth
);

57 
	gcÚn
->
£tCÚ‹xt
(
cÚ‹xt
);

59 
SessiÚMes§ge
 
	g£ssiÚMes§ge
 = { 0, 0 };

60 
	g£ssiÚMes§ge
.
	gnumb”
 = 
htÚl
(
İt
.
numb”
);

61 
	g£ssiÚMes§ge
.
	gËngth
 = 
htÚl
(
İt
.
Ëngth
);

62 
	gcÚn
->
£nd
(&
£ssiÚMes§ge
, (sessionMessage));

64 
	gcÚn
->
£nd
(
cÚ‹xt
.
ouut
.
toSŒšgP›û
());

68 cÚ¡ 
	gCÚ‹xt
& 
	gcÚ‹xt
 = 
boo¡
::
ªy_ÿ¡
<
CÚ‹xt
>(
cÚn
->
g‘CÚ‹xt
());

69 
	gLOG_INFO
 << "·ylßd by‹ " << 
	gcÚ‹xt
.
	gby‹s
;

70 
	gcÚn
->
g‘Loİ
()->
qu™
();

74 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
time
)

76 
CÚ‹xt
* 
	gcÚ‹xt
 = 
boo¡
::
ªy_ÿ¡
<CÚ‹xt>(
cÚn
->
g‘MubËCÚ‹xt
());

77 
	gbuf
->
»adabËBy‹s
(è>ğ(
št32_t
))

79 
št32_t
 
Ëngth
 = 
buf
->
»adIÁ32
();

80 ià(
	gËngth
 =ğ
cÚ‹xt
->
£ssiÚ
.
Ëngth
)

82 ià(
cÚ‹xt
->
couÁ
 < cÚ‹xt->
£ssiÚ
.
numb”
)

84 
cÚn
->
£nd
(
cÚ‹xt
->
ouut
.
toSŒšgP›û
());

85 ++
	gcÚ‹xt
->
	gcouÁ
;

86 
	gcÚ‹xt
->
	gby‹s
 +ğ
Ëngth
;

90 
	gcÚn
->
shutdown
();

96 
	gcÚn
->
shutdown
();

104 
	$Œªsm™
(cÚ¡ 
O±iÚs
& 
İt
)

106 
IÃtAdd»ss
 
	`addr
(
İt
.
pÜt
);

107 ià(!
IÃtAdd»ss
::
	`»sŞve
(
İt
.
ho¡
, &
addr
))

109 
LOG_FATAL
 << "UÇbËØ»sŞv" << 
İt
.
ho¡
;

111 
muduo
::
Time¡amp
 
	`¡¬t
(muduo::Time¡amp::
	`now
());

112 
Ev’tLoİ
 
loİ
;

113 
g_loİ
 = &
loİ
;

114 
TıCl›Á
 
	`ş›Á
(&
loİ
, 
addr
, "TtcpClient");

115 
ş›Á
.
	`£tCÚÃùiÚC®lback
(

116 
boo¡
::
	`bšd
(&
Œªs
::
ÚCÚÃùiÚ
, 
İt
, 
_1
));

117 
ş›Á
.
	`£tMes§geC®lback
(

118 
boo¡
::
	`bšd
(&
Œªs
::
ÚMes§ge
, 
_1
, 
_2
, 
_3
));

119 
ş›Á
.
	`cÚÃù
();

120 
loİ
.
	`loİ
();

121 
–­£d
 = 
	`timeDifã»nû
(
muduo
::
Time¡amp
::
	`now
(), 
¡¬t
);

122 
tÙ®_mb
 = 1.0 * 
İt
.
Ëngth
 * o±.
numb”
 / 1024 / 1024;

123 
	`´štf
("%.3àMiB¿nsã¼ed\n%.3àMiB/s\n", 
tÙ®_mb
,Ù®_mb / 
–­£d
);

124 
	}
}

130 
Çme¥aû
 
	g»ûivšg


133 
ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

135 ià(
	gcÚn
->
cÚÃùed
())

137 
CÚ‹xt
 
	gcÚ‹xt
;

138 
	gcÚn
->
£tCÚ‹xt
(
cÚ‹xt
);

142 cÚ¡ 
	gCÚ‹xt
& 
	gcÚ‹xt
 = 
boo¡
::
ªy_ÿ¡
<
CÚ‹xt
>(
cÚn
->
g‘CÚ‹xt
());

143 
	gLOG_INFO
 << "·ylßd by‹ " << 
	gcÚ‹xt
.
	gby‹s
;

144 
	gcÚn
->
g‘Loİ
()->
qu™
();

148 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
time
)

150 
	gbuf
->
»adabËBy‹s
(è>ğ(
št32_t
))

152 
CÚ‹xt
* 
cÚ‹xt
 = 
boo¡
::
ªy_ÿ¡
<CÚ‹xt>(
cÚn
->
g‘MubËCÚ‹xt
());

153 
	gSessiÚMes§ge
& 
	g£ssiÚ
 = 
cÚ‹xt
->
£ssiÚ
;

154 ià(
	g£ssiÚ
.
	gnumb”
 =ğ0 && 
£ssiÚ
.
Ëngth
 == 0)

156 ià(
buf
->
»adabËBy‹s
(è>ğ(
SessiÚMes§ge
))

158 
£ssiÚ
.
numb”
 = 
buf
->
»adIÁ32
();

159 
	g£ssiÚ
.
	gËngth
 = 
buf
->
»adIÁ32
();

160 
	gcÚ‹xt
->
	gouut
.
­³ndIÁ32
(
£ssiÚ
.
Ëngth
);

161 
´štf
("receive‚umber = %d\nreceive†ength = %d\n",

162 
£ssiÚ
.
numb”
, sessiÚ.
Ëngth
);

171 cÚ¡ 
	gtÙ®_Ën
 = 
£ssiÚ
.
Ëngth
 + 
¡©ic_ÿ¡
<>((
št32_t
));

172 cÚ¡ 
št32_t
 
	gËngth
 = 
buf
->
³ekIÁ32
();

173 ià(
	gËngth
 =ğ
£ssiÚ
.
Ëngth
)

175 ià(
buf
->
»adabËBy‹s
(è>ğ
tÙ®_Ën
)

177 
buf
->
»Œ›ve
(
tÙ®_Ën
);

178 
	gcÚn
->
£nd
(
cÚ‹xt
->
ouut
.
toSŒšgP›û
());

179 ++
	gcÚ‹xt
->
	gcouÁ
;

180 
	gcÚ‹xt
->
	gby‹s
 +ğ
Ëngth
;

181 ià(
	gcÚ‹xt
->
	gcouÁ
 >ğ
£ssiÚ
.
numb”
)

183 
cÚn
->
shutdown
();

194 
´štf
("wrÚg†’gth %d\n", 
Ëngth
);

195 
	gcÚn
->
shutdown
();

204 
	$»ûive
(cÚ¡ 
O±iÚs
& 
İt
)

206 
Ev’tLoİ
 
loİ
;

207 
g_loİ
 = &
loİ
;

208 
IÃtAdd»ss
 
	`li¡’Addr
(
İt
.
pÜt
);

209 
TıS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, "TtcpReceive");

210 
£rv”
.
	`£tCÚÃùiÚC®lback
(

211 
boo¡
::
	`bšd
(&
»ûivšg
::
ÚCÚÃùiÚ
, 
_1
));

212 
£rv”
.
	`£tMes§geC®lback
(

213 
boo¡
::
	`bšd
(&
»ûivšg
::
ÚMes§ge
, 
_1
, 
_2
, 
_3
));

214 
£rv”
.
	`¡¬t
();

215 
loİ
.
	`loİ
();

216 
	}
}

	@examples/ace/ttcp/ttcp_blocking.cc

1 
	~<exam¶es/aû/‰ı/commÚ.h
>

2 
	~<muduo/ba£/Time¡amp.h
>

4 #undeà
NDEBUG


6 
	~<as£¹.h
>

7 
	~<”ºo.h
>

8 
	~<¡dio.h
>

9 
	~<¡ršgs.h
>

10 
	~<uni¡d.h
>

12 
	~<Ãtš‘/š.h
>

13 
	~<¬·/š‘.h
>

15 
	$acû±OrD›
(
ušt16_t
 
pÜt
)

17 
li¡’fd
 = ::
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
);

18 
	`as£¹
(
li¡’fd
 >= 0);

20 
yes
 = 1;

21 ià(
	`£tsockİt
(
li¡’fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes)))

23 
	`³¼Ü
("setsockopt");

24 
	`ex™
(1);

27 
sockaddr_š
 
addr
;

28 
	`bz”o
(&
addr
, (addr));

29 
addr
.
sš_çmy
 = 
AF_INET
;

30 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

31 
addr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

32 ià(
	`bšd
(
li¡’fd
, 
»š‹½»t_ÿ¡
<
sockaddr
*>(&
addr
), (addr)))

34 
	`³¼Ü
("bind");

35 
	`ex™
(1);

38 ià(
	`li¡’
(
li¡’fd
, 5))

40 
	`³¼Ü
("listen");

41 
	`ex™
(1);

44 
sockaddr_š
 
³”_addr
;

45 
	`bz”o
(&
³”_addr
, (peer_addr));

46 
sockËn_t
 
add¾’
 = 0;

47 
sockfd
 = ::
	`acû±
(
li¡’fd
, 
»š‹½»t_ÿ¡
<
sockaddr
*>(&
³”_addr
), &
add¾’
);

48 ià(
sockfd
 < 0)

50 
	`³¼Ü
("accept");

51 
	`ex™
(1);

53 ::
	`şo£
(
li¡’fd
);

54  
sockfd
;

55 
	}
}

57 
	$wr™e_n
(
sockfd
, cÚ¡ * 
buf
, 
Ëngth
)

59 
wr™‹n
 = 0;

60 
wr™‹n
 < 
Ëngth
)

62 
ssize_t
 
nw
 = ::
	`wr™e
(
sockfd
, 
¡©ic_ÿ¡
<cÚ¡ *>(
buf
è+ 
wr™‹n
, 
Ëngth
 - written);

63 ià(
nw
 > 0)

65 
wr™‹n
 +ğ
¡©ic_ÿ¡
<>(
nw
);

67 ià(
nw
 == 0)

71 ià(
”ºo
 !ğ
EINTR
)

73 
	`³¼Ü
("write");

77  
wr™‹n
;

78 
	}
}

80 
	$»ad_n
(
sockfd
, * 
buf
, 
Ëngth
)

82 
Ä—d
 = 0;

83 
Ä—d
 < 
Ëngth
)

85 
ssize_t
 
Ä
 = ::
	`»ad
(
sockfd
, 
¡©ic_ÿ¡
<*>(
buf
è+ 
Ä—d
, 
Ëngth
 -‚read);

86 ià(
Ä
 > 0)

88 
Ä—d
 +ğ
¡©ic_ÿ¡
<>(
Ä
);

90 ià(
Ä
 == 0)

94 ià(
”ºo
 !ğ
EINTR
)

96 
	`³¼Ü
("read");

100  
Ä—d
;

101 
	}
}

103 
	$Œªsm™
(cÚ¡ 
O±iÚs
& 
İt
)

105 
sockaddr_š
 
addr
 = 
	`»sŞveOrD›
(
İt
.
ho¡
.
	`c_¡r
(), o±.
pÜt
);

106 
	`´štf
("cÚÃùšgØ%s:%d\n", 
	`š‘_Áß
(
addr
.
sš_addr
), 
İt
.
pÜt
);

108 
sockfd
 = ::
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
);

109 
	`as£¹
(
sockfd
 >= 0);

110 
»t
 = ::
	`cÚÃù
(
sockfd
, 
»š‹½»t_ÿ¡
<
sockaddr
*>(&
addr
), (addr));

111 ià(
»t
)

113 
	`³¼Ü
("connect");

114 
	`´štf
("UÇbËØcÚÃù %s\n", 
İt
.
ho¡
.
	`c_¡r
());

115 ::
	`şo£
(
sockfd
);

119 
	`´štf
("connected\n");

120 
muduo
::
Time¡amp
 
	`¡¬t
(muduo::Time¡amp::
	`now
());

121 
SessiÚMes§ge
 
£ssiÚMes§ge
 = { 0, 0 };

122 
£ssiÚMes§ge
.
numb”
 = 
	`htÚl
(
İt
.number);

123 
£ssiÚMes§ge
.
Ëngth
 = 
	`htÚl
(
İt
.length);

124 ià(
	`wr™e_n
(
sockfd
, &
£ssiÚMes§ge
, (sessionMessage)) != (sessionMessage))

126 
	`³¼Ü
("write SessionMessage");

127 
	`ex™
(1);

130 cÚ¡ 
tÙ®_Ën
 = 
¡©ic_ÿ¡
<>((
št32_t
è+ 
İt
.
Ëngth
);

131 
PaylßdMes§ge
* 
·ylßd
 = 
¡©ic_ÿ¡
<PaylßdMes§ge*>(::
	`m®loc
(
tÙ®_Ën
));

132 
	`as£¹
(
·ylßd
);

133 
·ylßd
->
Ëngth
 = 
	`htÚl
(
İt
.length);

134 
i
 = 0; i < 
İt
.
Ëngth
; ++i)

136 
·ylßd
->
d©a
[
i
] = "0123456789ABCDEF"[i % 16];

139 
tÙ®_mb
 = 1.0 * 
İt
.
Ëngth
 * o±.
numb”
 / 1024 / 1024;

140 
	`´štf
("%.3àMiB iÀtÙ®\n", 
tÙ®_mb
);

142 
i
 = 0; i < 
İt
.
numb”
; ++i)

144 
nw
 = 
	`wr™e_n
(
sockfd
, 
·ylßd
, 
tÙ®_Ën
);

145 
	`as£¹
(
nw
 =ğ
tÙ®_Ën
);

147 
ack
 = 0;

148 
Ä
 = 
	`»ad_n
(
sockfd
, &
ack
, (ack));

149 
	`as£¹
(
Ä
 =ğ(
ack
));

150 
ack
 = 
	`Áohl
(ack);

151 
	`as£¹
(
ack
 =ğ
İt
.
Ëngth
);

154 ::
	`ä“
(
·ylßd
);

155 ::
	`şo£
(
sockfd
);

156 
–­£d
 = 
	`timeDifã»nû
(
muduo
::
Time¡amp
::
	`now
(), 
¡¬t
);

157 
	`´štf
("%.3à£cÚds\n%.3àMiB/s\n", 
–­£d
, 
tÙ®_mb
 /ƒlapsed);

158 
	}
}

160 
	$»ûive
(cÚ¡ 
O±iÚs
& 
İt
)

162 
sockfd
 = 
	`acû±OrD›
(
İt
.
pÜt
);

164 
SessiÚMes§ge
 
£ssiÚMes§ge
 = { 0, 0 };

165 ià(
	`»ad_n
(
sockfd
, &
£ssiÚMes§ge
, (sessionMessage)) != (sessionMessage))

167 
	`³¼Ü
("read SessionMessage");

168 
	`ex™
(1);

171 
£ssiÚMes§ge
.
numb”
 = 
	`Áohl
(sessionMessage.number);

172 
£ssiÚMes§ge
.
Ëngth
 = 
	`Áohl
(sessionMessage.length);

173 
	`´štf
("receive‚umber = %d\nreceive†ength = %d\n",

174 
£ssiÚMes§ge
.
numb”
, sessiÚMes§ge.
Ëngth
);

175 cÚ¡ 
tÙ®_Ën
 = 
¡©ic_ÿ¡
<>((
št32_t
è+ 
£ssiÚMes§ge
.
Ëngth
);

176 
PaylßdMes§ge
* 
·ylßd
 = 
¡©ic_ÿ¡
<PaylßdMes§ge*>(::
	`m®loc
(
tÙ®_Ën
));

177 
	`as£¹
(
·ylßd
);

179 
i
 = 0; i < 
£ssiÚMes§ge
.
numb”
; ++i)

181 
·ylßd
->
Ëngth
 = 0;

182 ià(
	`»ad_n
(
sockfd
, &
·ylßd
->
Ëngth
, (payload->length)) != (payload->length))

184 
	`³¼Ü
("read†ength");

185 
	`ex™
(1);

187 
·ylßd
->
Ëngth
 = 
	`Áohl
(payload->length);

188 
	`as£¹
(
·ylßd
->
Ëngth
 =ğ
£ssiÚMes§ge
.length);

189 ià(
	`»ad_n
(
sockfd
, 
·ylßd
->
d©a
,…aylßd->
Ëngth
) !=…ayload->length)

191 
	`³¼Ü
("read…ayload data");

192 
	`ex™
(1);

194 
št32_t
 
ack
 = 
	`htÚl
(
·ylßd
->
Ëngth
);

195 ià(
	`wr™e_n
(
sockfd
, &
ack
, (ack)) != (ack))

197 
	`³¼Ü
("write‡ck");

198 
	`ex™
(1);

201 ::
	`ä“
(
·ylßd
);

202 ::
	`şo£
(
sockfd
);

203 
	}
}

	@examples/asio/chat/client.cc

1 
	~"codec.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Mu‹x.h
>

5 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

6 
	~<muduo/Ãt/TıCl›Á.h
>

8 
	~<boo¡/bšd.hµ
>

9 
	~<boo¡/nÚcİyabË.hµ
>

11 
	~<io¡»am
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 şas 
	cCh©Cl›Á
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
	$Ch©Cl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
)

22 : 
	`ş›Á_
(
loİ
, 
£rv”Addr
, "ChatClient"),

23 
	`codec_
(
boo¡
::
	`bšd
(&
Ch©Cl›Á
::
ÚSŒšgMes§ge
, 
this
, 
_1
, 
_2
, 
_3
))

25 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

26 
boo¡
::
	`bšd
(&
Ch©Cl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

27 
ş›Á_
.
	`£tMes§geC®lback
(

28 
boo¡
::
	`bšd
(&
L’gthH—d”Codec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

29 
ş›Á_
.
	`’abËR‘ry
();

32 
	$cÚÃù
()

34 
ş›Á_
.
	`cÚÃù
();

35 
	}
}

37 
	$discÚÃù
()

39 
ş›Á_
.
	`discÚÃù
();

40 
	}
}

42 
	$wr™e
(cÚ¡ 
SŒšgP›û
& 
mes§ge
)

44 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

45 ià(
cÚÃùiÚ_
)

47 
codec_
.
	`£nd
(
	`g‘_poš‹r
(
cÚÃùiÚ_
), 
mes§ge
);

49 
	}
}

51 
	g´iv©e
:

52 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

54 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

55 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

56 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

58 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

59 ià(
cÚn
->
	`cÚÃùed
())

61 
cÚÃùiÚ_
 = 
cÚn
;

65 
cÚÃùiÚ_
.
	`»£t
();

67 
	}
}

69 
	$ÚSŒšgMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

70 cÚ¡ 
¡ršg
& 
mes§ge
,

71 
Time¡amp
)

73 
	`´štf
("<<< %s\n", 
mes§ge
.
	`c_¡r
());

74 
	}
}

76 
TıCl›Á
 
	gş›Á_
;

77 
L’gthH—d”Codec
 
	gcodec_
;

78 
Mu‹xLock
 
	gmu‹x_
;

79 
TıCÚÃùiÚPŒ
 
	gcÚÃùiÚ_
;

82 
	$maš
(
¬gc
, * 
¬gv
[])

84 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

85 ià(
¬gc
 > 2)

87 
Ev’tLoİTh»ad
 
loİTh»ad
;

88 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

89 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 
pÜt
);

91 
Ch©Cl›Á
 
	`ş›Á
(
loİTh»ad
.
	`¡¬tLoİ
(), 
£rv”Addr
);

92 
ş›Á
.
	`cÚÃù
();

93 
¡d
::
¡ršg
 
lše
;

94 
¡d
::
	`g‘lše
(¡d::
cš
, 
lše
))

96 
ş›Á
.
	`wr™e
(
lše
);

98 
ş›Á
.
	`discÚÃù
();

99 
Cu¼’tTh»ad
::
	`¦“pU£c
(1000*1000);

103 
	`´štf
("U§ge: % ho¡_…Üt\n", 
¬gv
[0]);

105 
	}
}

	@examples/asio/chat/codec.h

1 #iâdeà
MUDUO_EXAMPLES_ASIO_CHAT_CODEC_H


2 
	#MUDUO_EXAMPLES_ASIO_CHAT_CODEC_H


	)

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/Ãt/Bufãr.h
>

6 
	~<muduo/Ãt/EndŸn.h
>

7 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

9 
	~<boo¡/funùiÚ.hµ
>

10 
	~<boo¡/nÚcİyabË.hµ
>

12 şas 
	cL’gthH—d”Codec
 : 
boo¡
::
nÚcİyabË


14 
public
:

15 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

16 cÚ¡ 
	tmuduo
::
	t¡ršg
& 
	tmes§ge
,

17 
	tmuduo
::
	tTime¡amp
)> 
	tSŒšgMes§geC®lback
;

19 
ex¶ic™
 
	$L’gthH—d”Codec
(cÚ¡ 
SŒšgMes§geC®lback
& 
cb
)

20 : 
	$mes§geC®lback_
(
cb
)

24 
	`ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

25 
muduo
::
Ãt
::
Bufãr
* 
buf
,

26 
muduo
::
Time¡amp
 
»ûiveTime
)

28 
buf
->
	`»adabËBy‹s
(è>ğ
kH—d”L’
)

31 cÚ¡ * 
d©a
 = 
buf
->
	`³ek
();

32 
št32_t
 
be32
 = *
¡©ic_ÿ¡
<cÚ¡ iÁ32_t*>(
d©a
);

33 cÚ¡ 
št32_t
 
Ën
 = 
muduo
::
Ãt
::
sock‘s
::
	`ÃtwÜkToHo¡32
(
be32
);

34 ià(
Ën
 > 65536 ||†en < 0)

36 
LOG_ERROR
 << "Inv®id†’gth " << 
Ën
;

37 
cÚn
->
	`shutdown
();

40 ià(
buf
->
	`»adabËBy‹s
(è>ğ
Ën
 + 
kH—d”L’
)

42 
buf
->
	`»Œ›ve
(
kH—d”L’
);

43 
muduo
::
¡ršg
 
	`mes§ge
(
buf
->
	`³ek
(), 
Ën
);

44 
	`mes§geC®lback_
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

45 
buf
->
	`»Œ›ve
(
Ën
);

52 
	}
}

55 
£nd
(
muduo
::
Ãt
::
TıCÚÃùiÚ
* 
cÚn
,

56 cÚ¡ 
muduo
::
SŒšgP›û
& 
mes§ge
)

58 
muduo
::
Ãt
::
Bufãr
 
buf
;

59 
	gbuf
.
­³nd
(
mes§ge
.
d©a
(), mes§ge.
size
());

60 
št32_t
 
	gËn
 = 
¡©ic_ÿ¡
<št32_t>(
mes§ge
.
size
());

61 
št32_t
 
	gbe32
 = 
muduo
::
Ãt
::
sock‘s
::
ho¡ToN‘wÜk32
(
Ën
);

62 
	gbuf
.
´•’d
(&
be32
,  be32);

63 
	gcÚn
->
£nd
(&
buf
);

66 
	g´iv©e
:

67 
SŒšgMes§geC®lback
 
mes§geC®lback_
;

68 cÚ¡ 
size_t
 
	gkH—d”L’
 = (
št32_t
);

	@examples/asio/chat/codec.h

1 #iâdeà
MUDUO_EXAMPLES_ASIO_CHAT_CODEC_H


2 
	#MUDUO_EXAMPLES_ASIO_CHAT_CODEC_H


	)

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/Ãt/Bufãr.h
>

6 
	~<muduo/Ãt/EndŸn.h
>

7 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

9 
	~<boo¡/funùiÚ.hµ
>

10 
	~<boo¡/nÚcİyabË.hµ
>

12 şas 
	cL’gthH—d”Codec
 : 
boo¡
::
nÚcİyabË


14 
public
:

15 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

16 cÚ¡ 
	tmuduo
::
	t¡ršg
& 
	tmes§ge
,

17 
	tmuduo
::
	tTime¡amp
)> 
	tSŒšgMes§geC®lback
;

19 
ex¶ic™
 
	$L’gthH—d”Codec
(cÚ¡ 
SŒšgMes§geC®lback
& 
cb
)

20 : 
	$mes§geC®lback_
(
cb
)

24 
	`ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

25 
muduo
::
Ãt
::
Bufãr
* 
buf
,

26 
muduo
::
Time¡amp
 
»ûiveTime
)

28 
buf
->
	`»adabËBy‹s
(è>ğ
kH—d”L’
)

31 cÚ¡ * 
d©a
 = 
buf
->
	`³ek
();

32 
št32_t
 
be32
 = *
¡©ic_ÿ¡
<cÚ¡ iÁ32_t*>(
d©a
);

33 cÚ¡ 
št32_t
 
Ën
 = 
muduo
::
Ãt
::
sock‘s
::
	`ÃtwÜkToHo¡32
(
be32
);

34 ià(
Ën
 > 65536 ||†en < 0)

36 
LOG_ERROR
 << "Inv®id†’gth " << 
Ën
;

37 
cÚn
->
	`shutdown
();

40 ià(
buf
->
	`»adabËBy‹s
(è>ğ
Ën
 + 
kH—d”L’
)

42 
buf
->
	`»Œ›ve
(
kH—d”L’
);

43 
muduo
::
¡ršg
 
	`mes§ge
(
buf
->
	`³ek
(), 
Ën
);

44 
	`mes§geC®lback_
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

45 
buf
->
	`»Œ›ve
(
Ën
);

52 
	}
}

55 
£nd
(
muduo
::
Ãt
::
TıCÚÃùiÚ
* 
cÚn
,

56 cÚ¡ 
muduo
::
SŒšgP›û
& 
mes§ge
)

58 
muduo
::
Ãt
::
Bufãr
 
buf
;

59 
	gbuf
.
­³nd
(
mes§ge
.
d©a
(), mes§ge.
size
());

60 
št32_t
 
	gËn
 = 
¡©ic_ÿ¡
<št32_t>(
mes§ge
.
size
());

61 
št32_t
 
	gbe32
 = 
muduo
::
Ãt
::
sock‘s
::
ho¡ToN‘wÜk32
(
Ën
);

62 
	gbuf
.
´•’d
(&
be32
,  be32);

63 
	gcÚn
->
£nd
(&
buf
);

66 
	g´iv©e
:

67 
SŒšgMes§geC®lback
 
mes§geC®lback_
;

68 cÚ¡ 
size_t
 
	gkH—d”L’
 = (
št32_t
);

	@examples/asio/chat/loadtest.cc

1 
	~"codec.h
"

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Mu‹x.h
>

6 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

8 
	~<muduo/Ãt/TıCl›Á.h
>

10 
	~<boo¡/bšd.hµ
>

11 
	~<boo¡/nÚcİyabË.hµ
>

12 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

14 
	~<¡dio.h
>

15 
	~<uni¡d.h
>

17 
usšg
 
Çme¥aû
 
	gmuduo
;

18 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

20 
	gg_cÚÃùiÚs
 = 0;

21 
AtomicIÁ32
 
	gg_®iveCÚÃùiÚs
;

22 
AtomicIÁ32
 
	gg_mes§gesReûived
;

23 
Time¡amp
 
	gg_¡¬tTime
;

24 
	g¡d
::
veùÜ
<
Time¡amp
> 
g_»ûiveTime
;

25 
Ev’tLoİ
* 
	gg_loİ
;

26 
	gboo¡
::
funùiÚ
<()> 
g_¡©i¡ic
;

28 şas 
	cCh©Cl›Á
 : 
boo¡
::
nÚcİyabË


30 
public
:

31 
	$Ch©Cl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
)

32 : 
	`loİ_
(
loİ
),

33 
	`ş›Á_
(
loİ
, 
£rv”Addr
, "LoadTestClient"),

34 
	`codec_
(
boo¡
::
	`bšd
(&
Ch©Cl›Á
::
ÚSŒšgMes§ge
, 
this
, 
_1
, 
_2
, 
_3
))

36 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

37 
boo¡
::
	`bšd
(&
Ch©Cl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

38 
ş›Á_
.
	`£tMes§geC®lback
(

39 
boo¡
::
	`bšd
(&
L’gthH—d”Codec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

43 
	$cÚÃù
()

45 
ş›Á_
.
	`cÚÃù
();

46 
	}
}

48 
	$discÚÃù
()

51 
	}
}

53 
Time¡amp
 
	$»ûiveTime
(ècÚ¡ {  
»ûiveTime_
; 
	}
}

55 
	g´iv©e
:

56 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

58 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

59 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

60 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

62 ià(
cÚn
->
	`cÚÃùed
())

64 
cÚÃùiÚ_
 = 
cÚn
;

65 ià(
g_®iveCÚÃùiÚs
.
	`šüem’tAndG‘
(è=ğ
g_cÚÃùiÚs
)

67 
LOG_INFO
 << "all connected";

68 
loİ_
->
	`runAá”
(10.0, 
boo¡
::
	`bšd
(&
Ch©Cl›Á
::
£nd
, 
this
));

73 
cÚÃùiÚ_
.
	`»£t
();

75 
	}
}

77 
	$ÚSŒšgMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

78 cÚ¡ 
¡ršg
& 
mes§ge
,

79 
Time¡amp
)

82 
»ûiveTime_
 = 
loİ_
->
	`pŞlR‘uºTime
();

83 
»ûived
 = 
g_mes§gesReûived
.
	`šüem’tAndG‘
();

84 ià(
»ûived
 =ğ
g_cÚÃùiÚs
)

86 
Time¡amp
 
’dTime
 = Time¡amp::
	`now
();

87 
LOG_INFO
 << "®È»ûived " << 
g_cÚÃùiÚs
 << " in "

88 << 
	`timeDifã»nû
(
’dTime
, 
g_¡¬tTime
);

89 
g_loİ
->
	`queueInLoİ
(
g_¡©i¡ic
);

91 ià(
»ûived
 % 1000 == 0)

93 
LOG_DEBUG
 << 
»ûived
;

95 
	}
}

97 
	$£nd
()

99 
g_¡¬tTime
 = 
Time¡amp
::
	`now
();

100 
codec_
.
	`£nd
(
	`g‘_poš‹r
(
cÚÃùiÚ_
), "hello");

101 
LOG_DEBUG
 << "sent";

102 
	}
}

104 
Ev’tLoİ
* 
	gloİ_
;

105 
TıCl›Á
 
	gş›Á_
;

106 
L’gthH—d”Codec
 
	gcodec_
;

107 
TıCÚÃùiÚPŒ
 
	gcÚÃùiÚ_
;

108 
Time¡amp
 
	g»ûiveTime_
;

111 
¡©i¡ic
(cÚ¡ 
boo¡
::
±r_veùÜ
<
Ch©Cl›Á
>& 
ş›Ás
)

113 
LOG_INFO
 << "¡©i¡iø" << 
ş›Ás
.
size
();

114 
	g¡d
::
veùÜ
<> 
£cÚds
(
ş›Ás
.
size
());

115 
size_t
 
	gi
 = 0; i < 
	gş›Ás
.
size
(); ++i)

117 
	g£cÚds
[
i
] = 
timeDifã»nû
(
ş›Ás
[i].
»ûiveTime
(), 
g_¡¬tTime
);

120 
	g¡d
::
sÜt
(
£cÚds
.
begš
(), secÚds.
’d
());

121 
size_t
 
	gi
 = 0; i < 
	gş›Ás
.
size
(); i +ğ
¡d
::
max
(
¡©ic_ÿ¡
<size_t>(1), 
ş›Ás
.size()/20))

123 
´štf
("%6zd%% %.6f\n", 
i
*100/
ş›Ás
.
size
(), 
£cÚds
[i]);

125 ià(
	gş›Ás
.
size
() >= 100)

127 
´štf
("%6d%% %.6f\n", 99, 
£cÚds
[
ş›Ás
.
size
() - clients.size()/100]);

129 
´štf
("%6d%% %.6f\n", 100, 
£cÚds
.
back
());

132 
	$maš
(
¬gc
, * 
¬gv
[])

134 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

135 ià(
¬gc
 > 3)

137 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

138 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 
pÜt
);

139 
g_cÚÃùiÚs
 = 
	`©oi
(
¬gv
[3]);

140 
th»ads
 = 0;

141 ià(
¬gc
 > 4)

143 
th»ads
 = 
	`©oi
(
¬gv
[4]);

146 
Ev’tLoİ
 
loİ
;

147 
g_loİ
 = &
loİ
;

148 
Ev’tLoİTh»adPoŞ
 
	`loİPoŞ
(&
loİ
, "chat-loadtest");

149 
loİPoŞ
.
	`£tTh»adNum
(
th»ads
);

150 
loİPoŞ
.
	`¡¬t
();

152 
g_»ûiveTime
.
	`»£rve
(
g_cÚÃùiÚs
);

153 
boo¡
::
±r_veùÜ
<
Ch©Cl›Á
> 
	`ş›Ás
(
g_cÚÃùiÚs
);

154 
g_¡©i¡ic
 = 
boo¡
::
	`bšd
(
¡©i¡ic
, boo¡::
	`»f
(
ş›Ás
));

156 
i
 = 0; i < 
g_cÚÃùiÚs
; ++i)

158 
ş›Ás
.
	`push_back
(
Ãw
 
	`Ch©Cl›Á
(
loİPoŞ
.
	`g‘NextLoİ
(), 
£rv”Addr
));

159 
ş›Ás
[
i
].
	`cÚÃù
();

160 
	`u¦“p
(200);

163 
loİ
.
	`loİ
();

168 
	`´štf
("U§ge: % ho¡_…ÜˆcÚÃùiÚ [th»ads]\n", 
¬gv
[0]);

170 
	}
}

	@examples/asio/chat/server.cc

1 
	~"codec.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Mu‹x.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/TıS”v”.h
>

8 
	~<boo¡/bšd.hµ
>

10 
	~<£t
>

11 
	~<¡dio.h
>

12 
	~<uni¡d.h
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 şas 
	cCh©S”v”
 : 
boo¡
::
nÚcİyabË


19 
public
:

20 
	$Ch©S”v”
(
Ev’tLoİ
* 
loİ
,

21 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

22 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "ChatServer"),

23 
	`codec_
(
boo¡
::
	`bšd
(&
Ch©S”v”
::
ÚSŒšgMes§ge
, 
this
, 
_1
, 
_2
, 
_3
))

25 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

26 
boo¡
::
	`bšd
(&
Ch©S”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

27 
£rv”_
.
	`£tMes§geC®lback
(

28 
boo¡
::
	`bšd
(&
L’gthH—d”Codec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

31 
	$¡¬t
()

33 
£rv”_
.
	`¡¬t
();

34 
	}
}

36 
	g´iv©e
:

37 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

39 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

40 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

41 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

43 ià(
cÚn
->
	`cÚÃùed
())

45 
cÚÃùiÚs_
.
	`š£¹
(
cÚn
);

49 
cÚÃùiÚs_
.
	`”a£
(
cÚn
);

51 
	}
}

53 
	$ÚSŒšgMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

54 cÚ¡ 
¡ršg
& 
mes§ge
,

55 
Time¡amp
)

57 
CÚÃùiÚLi¡
::
™”©Ü
 
™
 = 
cÚÃùiÚs_
.
	`begš
();

58 
™
 !ğ
cÚÃùiÚs_
.
	`’d
();

59 ++
™
)

61 
codec_
.
	`£nd
(
	`g‘_poš‹r
(*
™
), 
mes§ge
);

63 
	}
}

65 
	g¡d
::
	t£t
<
	tTıCÚÃùiÚPŒ
> 
	tCÚÃùiÚLi¡
;

66 
TıS”v”
 
	g£rv”_
;

67 
L’gthH—d”Codec
 
	gcodec_
;

68 
CÚÃùiÚLi¡
 
	gcÚÃùiÚs_
;

71 
	$maš
(
¬gc
, * 
¬gv
[])

73 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

74 ià(
¬gc
 > 1)

76 
Ev’tLoİ
 
loİ
;

77 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

78 
IÃtAdd»ss
 
	`£rv”Addr
(
pÜt
);

79 
Ch©S”v”
 
	`£rv”
(&
loİ
, 
£rv”Addr
);

80 
£rv”
.
	`¡¬t
();

81 
loİ
.
	`loİ
();

85 
	`´štf
("U§ge: % pÜt\n", 
¬gv
[0]);

87 
	}
}

	@examples/asio/chat/server_threaded.cc

1 
	~"codec.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Mu‹x.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/TıS”v”.h
>

8 
	~<boo¡/bšd.hµ
>

10 
	~<£t
>

11 
	~<¡dio.h
>

12 
	~<uni¡d.h
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 şas 
	cCh©S”v”
 : 
boo¡
::
nÚcİyabË


19 
public
:

20 
	$Ch©S”v”
(
Ev’tLoİ
* 
loİ
,

21 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

22 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "ChatServer"),

23 
	`codec_
(
boo¡
::
	`bšd
(&
Ch©S”v”
::
ÚSŒšgMes§ge
, 
this
, 
_1
, 
_2
, 
_3
))

25 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

26 
boo¡
::
	`bšd
(&
Ch©S”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

27 
£rv”_
.
	`£tMes§geC®lback
(

28 
boo¡
::
	`bšd
(&
L’gthH—d”Codec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

31 
	$£tTh»adNum
(
numTh»ads
)

33 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

34 
	}
}

36 
	$¡¬t
()

38 
£rv”_
.
	`¡¬t
();

39 
	}
}

41 
	g´iv©e
:

42 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

44 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

45 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

46 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

48 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

49 ià(
cÚn
->
	`cÚÃùed
())

51 
cÚÃùiÚs_
.
	`š£¹
(
cÚn
);

55 
cÚÃùiÚs_
.
	`”a£
(
cÚn
);

57 
	}
}

59 
	$ÚSŒšgMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

60 cÚ¡ 
¡ršg
& 
mes§ge
,

61 
Time¡amp
)

63 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

64 
CÚÃùiÚLi¡
::
™”©Ü
 
™
 = 
cÚÃùiÚs_
.
	`begš
();

65 
™
 !ğ
cÚÃùiÚs_
.
	`’d
();

66 ++
™
)

68 
codec_
.
	`£nd
(
	`g‘_poš‹r
(*
™
), 
mes§ge
);

70 
	}
}

72 
	g¡d
::
	t£t
<
	tTıCÚÃùiÚPŒ
> 
	tCÚÃùiÚLi¡
;

73 
TıS”v”
 
	g£rv”_
;

74 
L’gthH—d”Codec
 
	gcodec_
;

75 
Mu‹xLock
 
	gmu‹x_
;

76 
CÚÃùiÚLi¡
 
	gcÚÃùiÚs_
;

79 
	$maš
(
¬gc
, * 
¬gv
[])

81 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

82 ià(
¬gc
 > 1)

84 
Ev’tLoİ
 
loİ
;

85 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

86 
IÃtAdd»ss
 
	`£rv”Addr
(
pÜt
);

87 
Ch©S”v”
 
	`£rv”
(&
loİ
, 
£rv”Addr
);

88 ià(
¬gc
 > 2)

90 
£rv”
.
	`£tTh»adNum
(
	`©oi
(
¬gv
[2]));

92 
£rv”
.
	`¡¬t
();

93 
loİ
.
	`loİ
();

97 
	`´štf
("U§ge: % pÜˆ[th»ad_num]\n", 
¬gv
[0]);

99 
	}
}

	@examples/asio/chat/server_threaded_efficient.cc

1 
	~"codec.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Mu‹x.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/TıS”v”.h
>

8 
	~<boo¡/bšd.hµ
>

9 
	~<boo¡/sh¬ed_±r.hµ
>

11 
	~<£t
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 şas 
	cCh©S”v”
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
	$Ch©S”v”
(
Ev’tLoİ
* 
loİ
,

22 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

23 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "ChatServer"),

24 
	`codec_
(
boo¡
::
	`bšd
(&
Ch©S”v”
::
ÚSŒšgMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

25 
	$cÚÃùiÚs_
(
Ãw
 
CÚÃùiÚLi¡
)

27 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

28 
boo¡
::
	`bšd
(&
Ch©S”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

29 
£rv”_
.
	`£tMes§geC®lback
(

30 
boo¡
::
	`bšd
(&
L’gthH—d”Codec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

33 
	$£tTh»adNum
(
numTh»ads
)

35 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

36 
	}
}

38 
	$¡¬t
()

40 
£rv”_
.
	`¡¬t
();

41 
	}
}

43 
	g´iv©e
:

44 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

46 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

47 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

48 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

50 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

51 ià(!
cÚÃùiÚs_
.
	`unique
())

53 
cÚÃùiÚs_
.
	`»£t
(
Ãw
 
	`CÚÃùiÚLi¡
(*connections_));

55 
	`as£¹
(
cÚÃùiÚs_
.
	`unique
());

57 ià(
cÚn
->
	`cÚÃùed
())

59 
cÚÃùiÚs_
->
	`š£¹
(
cÚn
);

63 
cÚÃùiÚs_
->
	`”a£
(
cÚn
);

65 
	}
}

67 
	g¡d
::
	t£t
<
	tTıCÚÃùiÚPŒ
> 
	tCÚÃùiÚLi¡
;

68 
	gboo¡
::
	tsh¬ed_±r
<
	tCÚÃùiÚLi¡
> 
	tCÚÃùiÚLi¡PŒ
;

70 
	$ÚSŒšgMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

71 cÚ¡ 
¡ršg
& 
mes§ge
,

72 
Time¡amp
)

74 
CÚÃùiÚLi¡PŒ
 
cÚÃùiÚs
 = 
	`g‘CÚÃùiÚLi¡
();;

75 
CÚÃùiÚLi¡
::
™”©Ü
 
™
 = 
cÚÃùiÚs
->
	`begš
();

76 
™
 !ğ
cÚÃùiÚs
->
	`’d
();

77 ++
™
)

79 
codec_
.
	`£nd
(
	`g‘_poš‹r
(*
™
), 
mes§ge
);

81 
	}
}

83 
CÚÃùiÚLi¡PŒ
 
	$g‘CÚÃùiÚLi¡
()

85 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

86  
cÚÃùiÚs_
;

87 
	}
}

89 
TıS”v”
 
	g£rv”_
;

90 
L’gthH—d”Codec
 
	gcodec_
;

91 
Mu‹xLock
 
	gmu‹x_
;

92 
CÚÃùiÚLi¡PŒ
 
	gcÚÃùiÚs_
;

95 
	$maš
(
¬gc
, * 
¬gv
[])

97 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

98 ià(
¬gc
 > 1)

100 
Ev’tLoİ
 
loİ
;

101 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

102 
IÃtAdd»ss
 
	`£rv”Addr
(
pÜt
);

103 
Ch©S”v”
 
	`£rv”
(&
loİ
, 
£rv”Addr
);

104 ià(
¬gc
 > 2)

106 
£rv”
.
	`£tTh»adNum
(
	`©oi
(
¬gv
[2]));

108 
£rv”
.
	`¡¬t
();

109 
loİ
.
	`loİ
();

113 
	`´štf
("U§ge: % pÜˆ[th»ad_num]\n", 
¬gv
[0]);

115 
	}
}

	@examples/asio/chat/server_threaded_highperformance.cc

1 
	~"codec.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Mu‹x.h
>

5 
	~<muduo/ba£/Th»adLoÿlSšgËtÚ.h
>

6 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<muduo/Ãt/TıS”v”.h
>

9 
	~<boo¡/bšd.hµ
>

10 
	~<boo¡/sh¬ed_±r.hµ
>

12 
	~<£t
>

13 
	~<¡dio.h
>

14 
	~<uni¡d.h
>

16 
usšg
 
Çme¥aû
 
	gmuduo
;

17 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

19 şas 
	cCh©S”v”
 : 
boo¡
::
nÚcİyabË


21 
public
:

22 
	$Ch©S”v”
(
Ev’tLoİ
* 
loİ
,

23 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

24 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "ChatServer"),

25 
	`codec_
(
boo¡
::
	`bšd
(&
Ch©S”v”
::
ÚSŒšgMes§ge
, 
this
, 
_1
, 
_2
, 
_3
))

27 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

28 
boo¡
::
	`bšd
(&
Ch©S”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

29 
£rv”_
.
	`£tMes§geC®lback
(

30 
boo¡
::
	`bšd
(&
L’gthH—d”Codec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

33 
	$£tTh»adNum
(
numTh»ads
)

35 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

36 
	}
}

38 
	$¡¬t
()

40 
£rv”_
.
	`£tTh»adIn™C®lback
(
boo¡
::
	`bšd
(&
Ch©S”v”
::
th»adIn™
, 
this
, 
_1
));

41 
£rv”_
.
	`¡¬t
();

42 
	}
}

44 
	g´iv©e
:

45 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

47 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

48 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

49 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

51 ià(
cÚn
->
	`cÚÃùed
())

53 
LoÿlCÚÃùiÚs
::
	`š¡ªû
().
	`š£¹
(
cÚn
);

57 
LoÿlCÚÃùiÚs
::
	`š¡ªû
().
	`”a£
(
cÚn
);

59 
	}
}

61 
	$ÚSŒšgMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

62 cÚ¡ 
¡ršg
& 
mes§ge
,

63 
Time¡amp
)

65 
Ev’tLoİ
::
FunùÜ
 
f
 = 
boo¡
::
	`bšd
(&
Ch©S”v”
::
di¡ribu‹Mes§ge
, 
this
, 
mes§ge
);

66 
LOG_DEBUG
;

68 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

69 
¡d
::
£t
<
Ev’tLoİ
*>::
™”©Ü
 
™
 = 
loİs_
.
	`begš
();

70 
™
 !ğ
loİs_
.
	`’d
();

71 ++
™
)

73 (*
™
)->
	`queueInLoİ
(
f
);

75 
LOG_DEBUG
;

76 
	}
}

78 
	g¡d
::
	t£t
<
	tTıCÚÃùiÚPŒ
> 
	tCÚÃùiÚLi¡
;

80 
	$di¡ribu‹Mes§ge
(cÚ¡ 
¡ršg
& 
mes§ge
)

82 
LOG_DEBUG
 << "begin";

83 
CÚÃùiÚLi¡
::
™”©Ü
 
™
 = 
LoÿlCÚÃùiÚs
::
	`š¡ªû
().
	`begš
();

84 
™
 !ğ
LoÿlCÚÃùiÚs
::
	`š¡ªû
().
	`’d
();

85 ++
™
)

87 
codec_
.
	`£nd
(
	`g‘_poš‹r
(*
™
), 
mes§ge
);

89 
LOG_DEBUG
 << "end";

90 
	}
}

92 
	$th»adIn™
(
Ev’tLoİ
* 
loİ
)

94 
	`as£¹
(
LoÿlCÚÃùiÚs
::
	`poš‹r
(è=ğ
NULL
);

95 
LoÿlCÚÃùiÚs
::
	`š¡ªû
();

96 
	`as£¹
(
LoÿlCÚÃùiÚs
::
	`poš‹r
(è!ğ
NULL
);

97 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

98 
loİs_
.
	`š£¹
(
loİ
);

99 
	}
}

101 
TıS”v”
 
	g£rv”_
;

102 
L’gthH—d”Codec
 
	gcodec_
;

103 
	gTh»adLoÿlSšgËtÚ
<
	tCÚÃùiÚLi¡
> 
	tLoÿlCÚÃùiÚs
;

105 
Mu‹xLock
 
	gmu‹x_
;

106 
	g¡d
::
£t
<
Ev’tLoİ
*> 
loİs_
;

109 
	$maš
(
¬gc
, * 
¬gv
[])

111 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

112 ià(
¬gc
 > 1)

114 
Ev’tLoİ
 
loİ
;

115 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

116 
IÃtAdd»ss
 
	`£rv”Addr
(
pÜt
);

117 
Ch©S”v”
 
	`£rv”
(&
loİ
, 
£rv”Addr
);

118 ià(
¬gc
 > 2)

120 
£rv”
.
	`£tTh»adNum
(
	`©oi
(
¬gv
[2]));

122 
£rv”
.
	`¡¬t
();

123 
loİ
.
	`loİ
();

127 
	`´štf
("U§ge: % pÜˆ[th»ad_num]\n", 
¬gv
[0]);

129 
	}
}

	@examples/asio/tutorial/timer2/timer.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<io¡»am
>

5 
	$´št
()

7 
¡d
::
cout
 << "Hello, world!\n";

8 
	}
}

10 
	$maš
()

12 
muduo
::
Ãt
::
Ev’tLoİ
 
loİ
;

13 
loİ
.
	`runAá”
(5, 
´št
);

14 
loİ
.
	`loİ
();

15 
	}
}

	@examples/asio/tutorial/timer3/timer.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<io¡»am
>

4 
	~<boo¡/bšd.hµ
>

6 
´št
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
, * 
couÁ
)

8 ià(*
	gcouÁ
 < 5)

10 
	g¡d
::
cout
 << *
couÁ
 << "\n";

11 ++(*
	gcouÁ
);

13 
	gloİ
->
runAá”
(1, 
boo¡
::
bšd
(
´št
, 
loİ
, 
couÁ
));

17 
	gloİ
->
qu™
();

21 
	$maš
()

23 
muduo
::
Ãt
::
Ev’tLoİ
 
loİ
;

24 
couÁ
 = 0;

26 
loİ
.
	`runAá”
(1, 
boo¡
::
	`bšd
(
´št
, &loİ, &
couÁ
));

27 
loİ
.
	`loİ
();

28 
¡d
::
cout
 << "Fš® couÁ i " << 
couÁ
 << "\n";

29 
	}
}

	@examples/asio/tutorial/timer4/timer.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<io¡»am
>

4 
	~<boo¡/bšd.hµ
>

5 
	~<boo¡/nÚcİyabË.hµ
>

7 şas 
	cPrš‹r
 : 
boo¡
::
nÚcİyabË


9 
public
:

10 
Prš‹r
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
)

11 : 
loİ_
(
loİ
),

12 
	$couÁ_
(0)

15 
loİ_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št
, 
this
));

18 ~
	$Prš‹r
()

20 
¡d
::
cout
 << "Fš® couÁ i " << 
couÁ_
 << "\n";

21 
	}
}

23 
	$´št
()

25 ià(
couÁ_
 < 5)

27 
¡d
::
cout
 << 
couÁ_
 << "\n";

28 ++
couÁ_
;

30 
loİ_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št
, 
this
));

34 
loİ_
->
	`qu™
();

36 
	}
}

38 
	g´iv©e
:

39 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ_
;

40 
	gcouÁ_
;

43 
	$maš
()

45 
muduo
::
Ãt
::
Ev’tLoİ
 
loİ
;

46 
Prš‹r
 
	`´š‹r
(&
loİ
);

47 
loİ
.
	`loİ
();

48 
	}
}

	@examples/asio/tutorial/timer5/timer.cc

1 
	~<muduo/ba£/Mu‹x.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

5 
	~<io¡»am
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<boo¡/nÚcİyabË.hµ
>

9 şas 
	cPrš‹r
 : 
boo¡
::
nÚcİyabË


11 
public
:

12 
Prš‹r
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ1
, muduo::Ãt::Ev’tLoİ* 
loİ2
)

13 : 
loİ1_
(
loİ1
),

14 
loİ2_
(
loİ2
),

15 
	$couÁ_
(0)

17 
loİ1_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št1
, 
this
));

18 
loİ2_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št2
, 
this
));

21 ~
	$Prš‹r
()

23 
¡d
::
cout
 << "Fš® couÁ i " << 
couÁ_
 << "\n";

24 
	}
}

26 
	$´št1
()

28 
muduo
::
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

29 ià(
couÁ_
 < 10)

31 
¡d
::
cout
 << "Tim” 1: " << 
couÁ_
 << "\n";

32 ++
couÁ_
;

34 
loİ1_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št1
, 
this
));

38 
loİ1_
->
	`qu™
();

40 
	}
}

42 
	$´št2
()

44 
muduo
::
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

45 ià(
couÁ_
 < 10)

47 
¡d
::
cout
 << "Tim” 2: " << 
couÁ_
 << "\n";

48 ++
couÁ_
;

50 
loİ2_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št2
, 
this
));

54 
loİ2_
->
	`qu™
();

56 
	}
}

58 
	g´iv©e
:

60 
muduo
::
Mu‹xLock
 
mu‹x_
;

61 
	gmuduo
::
Ãt
::
Ev’tLoİ
* 
loİ1_
;

62 
	gmuduo
::
Ãt
::
Ev’tLoİ
* 
loİ2_
;

63 
	gcouÁ_
;

66 
	$maš
()

68 
boo¡
::
scİed_±r
<
Prš‹r
> 
´š‹r
;

70 
muduo
::
Ãt
::
Ev’tLoİ
 
loİ
;

71 
muduo
::
Ãt
::
Ev’tLoİTh»ad
 
loİTh»ad
;

72 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİInAnÙh”Th»ad
 = 
loİTh»ad
.
	`¡¬tLoİ
();

73 
´š‹r
.
	`»£t
(
Ãw
 
	`Prš‹r
(&
loİ
, 
loİInAnÙh”Th»ad
));

74 
loİ
.
	`loİ
();

75 
	}
}

	@examples/asio/tutorial/timer6/timer.cc

1 
	~<muduo/ba£/Mu‹x.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

5 
	~<¡dio.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<boo¡/nÚcİyabË.hµ
>

13 şas 
	cPrš‹r
 : 
boo¡
::
nÚcİyabË


15 
public
:

16 
Prš‹r
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ1
, muduo::Ãt::Ev’tLoİ* 
loİ2
)

17 : 
loİ1_
(
loİ1
),

18 
loİ2_
(
loİ2
),

19 
	$couÁ_
(0)

21 
loİ1_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št1
, 
this
));

22 
loİ2_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št2
, 
this
));

25 ~
	$Prš‹r
()

29 
	`´štf
("Fš® couÁ i %d\n", 
couÁ_
);

30 
	}
}

32 
	$´št1
()

34 
boŞ
 
shouldQu™
 = 
çl£
;

35 
couÁ
 = 0;

38 
muduo
::
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

39 ià(
couÁ_
 < 10)

41 
couÁ
 = 
couÁ_
;

42 ++
couÁ_
;

46 
shouldQu™
 = 
Œue
;

51 ià(
shouldQu™
)

54 
loİ1_
->
	`qu™
();

60 
	`´štf
("Tim” 1: %d\n", 
couÁ
);

61 
loİ1_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št1
, 
this
));

63 
	}
}

65 
	$´št2
()

67 
boŞ
 
shouldQu™
 = 
çl£
;

68 
couÁ
 = 0;

71 
muduo
::
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

72 ià(
couÁ_
 < 10)

74 
couÁ
 = 
couÁ_
;

75 ++
couÁ_
;

79 
shouldQu™
 = 
Œue
;

84 ià(
shouldQu™
)

87 
loİ2_
->
	`qu™
();

93 
	`´štf
("Tim” 2: %d\n", 
couÁ
);

94 
loİ2_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
Prš‹r
::
´št2
, 
this
));

96 
	}
}

98 
	g´iv©e
:

100 
muduo
::
Mu‹xLock
 
mu‹x_
;

101 
	gmuduo
::
Ãt
::
Ev’tLoİ
* 
loİ1_
;

102 
	gmuduo
::
Ãt
::
Ev’tLoİ
* 
loİ2_
;

103 
	gcouÁ_
;

106 
	$maš
()

108 
boo¡
::
scİed_±r
<
Prš‹r
> 
´š‹r
;

110 
muduo
::
Ãt
::
Ev’tLoİ
 
loİ
;

111 
muduo
::
Ãt
::
Ev’tLoİTh»ad
 
loİTh»ad
;

112 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİInAnÙh”Th»ad
 = 
loİTh»ad
.
	`¡¬tLoİ
();

113 
´š‹r
.
	`»£t
(
Ãw
 
	`Prš‹r
(&
loİ
, 
loİInAnÙh”Th»ad
));

114 
loİ
.
	`loİ
();

115 
	}
}

	@examples/cdns/Resolver.cc

1 
	~<exam¶es/cdns/ResŞv”.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/ChªÃl.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<boo¡/bšd.hµ
>

9 
	~<¬es.h
>

10 
	~<Ãtdb.h
>

11 
	~<¬·/š‘.h
>

12 
	~<Ãtš‘/š.h
>

14 
	~<¡dlib.h
>

15 
	~<¡dio.h
>

16 
	~<as£¹.h
>

18 
usšg
 
Çme¥aû
 
	gmuduo
;

19 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

20 
usšg
 
Çme¥aû
 
	gcdns
;

22 
	gÇme¥aû


24 
g‘SecÚds
(
timev®
* 
tv
)

26 ià(
	gtv
)

27  (
	gtv
->
	gtv_£c
è+ Ñv->
	gtv_u£c
)/1000000.0;

32 cÚ¡ * 
g‘Sock‘Ty³
(
ty³
)

34 ià(
	gty³
 =ğ
SOCK_DGRAM
)

36 ià(
	gty³
 =ğ
SOCK_STREAM
)

42 cÚ¡ 
boŞ
 
	gkDebug
 = 
çl£
;

45 
	gResŞv”
::
	$ResŞv”
(
Ev’tLoİ
* 
loİ
, 
O±iÚ
 
İt
)

46 : 
	`loİ_
(
loİ
),

47 
	`ùx_
(
NULL
),

48 
	$tim”Aùive_
(
çl£
)

50 
lookups
[] = "b";

51 
¬es_İtiÚs
 
İtiÚs
;

52 
İtmask
 = 
ARES_OPT_FLAGS
;

53 
İtiÚs
.
æags
 = 
ARES_FLAG_NOCHECKRESP
;

54 
İtiÚs
.
æags
 |ğ
ARES_FLAG_STAYOPEN
;

55 
İtiÚs
.
æags
 |ğ
ARES_FLAG_IGNTC
;

56 
İtmask
 |ğ
ARES_OPT_SOCK_STATE_CB
;

57 
İtiÚs
.
sock_¡©e_cb
 = &
ResŞv”
::
¬es_sock_¡©e_ÿÎback
;

58 
İtiÚs
.
sock_¡©e_cb_d©a
 = 
this
;

59 
İtmask
 |ğ
ARES_OPT_TIMEOUT
;

60 
İtiÚs
.
timeout
 = 2;

61 ià(
İt
 =ğ
kDNSÚly
)

63 
İtmask
 |ğ
ARES_OPT_LOOKUPS
;

64 
İtiÚs
.
lookups
 =†ookups;

67 
¡©us
 = 
	`¬es_š™_İtiÚs
(&
ùx_
, &
İtiÚs
, 
İtmask
);

68 ià(
¡©us
 !ğ
ARES_SUCCESS
)

70 
	`as£¹
(0);

72 
	`¬es_£t_sock‘_ÿÎback
(
ùx_
, &
ResŞv”
::
¬es_sock_ü—‹_ÿÎback
, 
this
);

73 
	}
}

75 
	gResŞv”
::~
	$ResŞv”
()

77 
	`¬es_de¡roy
(
ùx_
);

78 
	}
}

80 
boŞ
 
	gResŞv”
::
	$»sŞve
(
SŒšgArg
 
ho¡Çme
, cÚ¡ 
C®lback
& 
cb
)

82 
loİ_
->
	`as£¹InLoİTh»ad
();

83 
Qu”yD©a
* 
qu”yD©a
 = 
Ãw
 
	`Qu”yD©a
(
this
, 
cb
);

84 
	`¬es_g‘ho¡byÇme
(
ùx_
, 
ho¡Çme
.
	`c_¡r
(), 
AF_INET
,

85 &
ResŞv”
::
¬es_ho¡_ÿÎback
, 
qu”yD©a
);

86 
timev®
 
tv
;

87 
timev®
* 
tvp
 = 
	`¬es_timeout
(
ùx_
, 
NULL
, &
tv
);

88 
timeout
 = 
	`g‘SecÚds
(
tvp
);

89 
LOG_DEBUG
 << "timeouˆ" << 
timeout
 << "‡ùiv" << 
tim”Aùive_
;

90 ià(!
tim”Aùive_
)

92 
loİ_
->
	`runAá”
(
timeout
, 
boo¡
::
	`bšd
(&
ResŞv”
::
ÚTim”
, 
this
));

93 
tim”Aùive_
 = 
Œue
;

95  
qu”yD©a
 !ğ
NULL
;

96 
	}
}

98 
	gResŞv”
::
	$ÚR—d
(
sockfd
, 
Time¡amp
 
t
)

100 
LOG_DEBUG
 << "ÚR—d " << 
sockfd
 << "‡ˆ" << 
t
.
	`toSŒšg
();

101 
	`¬es_´oûss_fd
(
ùx_
, 
sockfd
, 
ARES_SOCKET_BAD
);

102 
	}
}

104 
	gResŞv”
::
	$ÚTim”
()

106 
	`as£¹
(
tim”Aùive_
 =ğ
Œue
);

107 
	`¬es_´oûss_fd
(
ùx_
, 
ARES_SOCKET_BAD
, ARES_SOCKET_BAD);

108 
timev®
 
tv
;

109 
timev®
* 
tvp
 = 
	`¬es_timeout
(
ùx_
, 
NULL
, &
tv
);

110 
timeout
 = 
	`g‘SecÚds
(
tvp
);

111 
LOG_DEBUG
 << 
loİ_
->
	`pŞlR‘uºTime
().
	`toSŒšg
(è<< "‚exˆtimeouˆ" << 
timeout
;

113 ià(
timeout
 < 0)

115 
tim”Aùive_
 = 
çl£
;

119 
loİ_
->
	`runAá”
(
timeout
, 
boo¡
::
	`bšd
(&
ResŞv”
::
ÚTim”
, 
this
));

121 
	}
}

123 
	gResŞv”
::
	$ÚQu”yResuÉ
(
¡©us
, 
ho¡’t
* 
»suÉ
, cÚ¡ 
C®lback
& 
ÿÎback
)

125 
LOG_DEBUG
 << "ÚQu”yResuÉ " << 
¡©us
;

126 
sockaddr_š
 
addr
;

127 
	`bz”o
(&
addr
, ‡ddr);

128 
addr
.
sš_çmy
 = 
AF_INET
;

129 
addr
.
sš_pÜt
 = 0;

130 ià(
»suÉ
)

132 
addr
.
sš_addr
 = *
»š‹½»t_ÿ¡
<
š_addr
*>(
»suÉ
->
h_addr
);

133 ià(
kDebug
)

135 
	`´štf
("h_Çm%s\n", 
»suÉ
->
h_Çme
);

136 ** 
®Ÿs
 = 
»suÉ
->
h_®Ÿ£s
; *®Ÿ !ğ
NULL
; ++alias)

138 
	`´štf
("®Ÿs: %s\n", *
®Ÿs
);

142 ** 
haddr
 = 
»suÉ
->
h_addr_li¡
; *hadd¸!ğ
NULL
; ++haddr)

144 
buf
[32];

145 
	`š‘_Áİ
(
AF_INET
, *
haddr
, 
buf
,  buf);

146 
	`´štf
(" %s\n", 
buf
);

150 
IÃtAdd»ss
 
	`š‘
(
addr
);

151 
	`ÿÎback
(
š‘
);

152 
	}
}

154 
	gResŞv”
::
	$ÚSockC»©e
(
sockfd
, 
ty³
)

156 
loİ_
->
	`as£¹InLoİTh»ad
();

157 
	`as£¹
(
chªÃls_
.
	`fšd
(
sockfd
è=ğchªÃls_.
	`’d
());

158 
ChªÃl
* 
chªÃl
 = 
Ãw
 
	`ChªÃl
(
loİ_
, 
sockfd
);

159 
chªÃl
->
	`£tR—dC®lback
(
boo¡
::
	`bšd
(&
ResŞv”
::
ÚR—d
, 
this
, 
sockfd
, 
_1
));

160 
chªÃl
->
	`’abËR—dšg
();

161 
chªÃls_
.
	`š£¹
(
sockfd
, 
chªÃl
);

162 
	}
}

164 
	gResŞv”
::
	$ÚSockS‹Chªge
(
sockfd
, 
boŞ
 
»ad
, boŞ 
wr™e
)

166 
loİ_
->
	`as£¹InLoİTh»ad
();

167 
ChªÃlLi¡
::
™”©Ü
 
™
 = 
chªÃls_
.
	`fšd
(
sockfd
);

168 
	`as£¹
(
™
 !ğ
chªÃls_
.
	`’d
());

169 ià(
»ad
)

177 
™
->
£cÚd
->
	`di§bËAÎ
();

178 
™
->
£cÚd
->
	`»move
();

179 
chªÃls_
.
	`”a£
(
™
);

181 
	}
}

183 
	gResŞv”
::
	$¬es_ho¡_ÿÎback
(* 
d©a
, 
¡©us
, 
timeouts
, 
ho¡’t
* hostent)

185 
Qu”yD©a
* 
qu”y
 = 
¡©ic_ÿ¡
<Qu”yD©a*>(
d©a
);

187 
qu”y
->
owÃr
->
	`ÚQu”yResuÉ
(
¡©us
, 
ho¡’t
, qu”y->
ÿÎback
);

188 
d–‘e
 
qu”y
;

189 
	}
}

191 
	gResŞv”
::
	$¬es_sock_ü—‹_ÿÎback
(
sockfd
, 
ty³
, * 
d©a
)

193 
LOG_TRACE
 << "sockfd=" << 
sockfd
 << "y³=" << 
	`g‘Sock‘Ty³
(
ty³
);

194 
¡©ic_ÿ¡
<
ResŞv”
*>(
d©a
)->
	`ÚSockC»©e
(
sockfd
, 
ty³
);

196 
	}
}

198 
	gResŞv”
::
	$¬es_sock_¡©e_ÿÎback
(* 
d©a
, 
sockfd
, 
»ad
, 
wr™e
)

200 
LOG_TRACE
 << "sockfd=" << 
sockfd
 << "„—d=" << 
»ad
 << " wr™e=" << 
wr™e
;

201 
¡©ic_ÿ¡
<
ResŞv”
*>(
d©a
)->
	`ÚSockS‹Chªge
(
sockfd
, 
»ad
, 
wr™e
);

202 
	}
}

	@examples/cdns/Resolver.h

1 #iâdeà
MUDUO_EXAMPLES_CDNS_RESOLVER_H


2 
	#MUDUO_EXAMPLES_CDNS_RESOLVER_H


	)

4 
	~<muduo/ba£/SŒšgP›û.h
>

5 
	~<muduo/ba£/Time¡amp.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<boo¡/funùiÚ.hµ
>

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<boo¡/±r_cÚš”/±r_m­.hµ
>

14 
ho¡’t
;

15 
¬es_chªÃld©a
;

16 
¬es_chªÃld©a
* 
	t¬es_chªÃl
;

19 
Çme¥aû
 
muduo


21 
Çme¥aû
 
Ãt


23 
şass
 
ChªÃl
;

24 
şass
 
Ev’tLoİ
;

28 
Çme¥aû
 
cdns


31 şas 
	cResŞv”
 : 
boo¡
::
nÚcİyabË


33 
public
:

34 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tIÃtAdd»ss
&)> 
	tC®lback
;

35 
	eO±iÚ


37 
kDNSªdHo¡sFe
,

38 
kDNSÚly
,

41 
ex¶ic™
 
ResŞv”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
, 
O±iÚ
 
İt
 = 
kDNSªdHo¡sFe
);

42 ~
ResŞv”
();

44 
boŞ
 
»sŞve
(
muduo
::
SŒšgArg
 
ho¡Çme
, cÚ¡ 
C®lback
& 
cb
);

46 
´iv©e
:

48 
	sQu”yD©a


50 
ResŞv”
* 
owÃr
;

51 
C®lback
 
ÿÎback
;

52 
Qu”yD©a
(
ResŞv”
* 
o
, cÚ¡ 
C®lback
& 
cb
)

53 : 
owÃr
(
o
), 
ÿÎback
(
cb
)

58 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ_
;

59 
¬es_chªÃl
 
ùx_
;

60 
boŞ
 
tim”Aùive_
;

61 
boo¡
::
	t±r_m­
<, 
	tmuduo
::
	tÃt
::
	tChªÃl
> 
	tChªÃlLi¡
;

62 
ChªÃlLi¡
 
chªÃls_
;

64 
ÚR—d
(
sockfd
, 
muduo
::
Time¡amp
 
t
);

65 
ÚTim”
();

66 
ÚQu”yResuÉ
(
¡©us
, 
ho¡’t
* 
»suÉ
, cÚ¡ 
C®lback
& 
cb
);

67 
ÚSockC»©e
(
sockfd
, 
ty³
);

68 
ÚSockS‹Chªge
(
sockfd
, 
boŞ
 
»ad
, boŞ 
wr™e
);

70 
¬es_ho¡_ÿÎback
(* 
d©a
, 
¡©us
, 
timeouts
, 
ho¡’t
* hostent);

71 
¬es_sock_ü—‹_ÿÎback
(
sockfd
, 
ty³
, * 
d©a
);

72 
¬es_sock_¡©e_ÿÎback
(* 
d©a
, 
sockfd
, 
»ad
, 
wr™e
);

	@examples/cdns/Resolver.h

1 #iâdeà
MUDUO_EXAMPLES_CDNS_RESOLVER_H


2 
	#MUDUO_EXAMPLES_CDNS_RESOLVER_H


	)

4 
	~<muduo/ba£/SŒšgP›û.h
>

5 
	~<muduo/ba£/Time¡amp.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<boo¡/funùiÚ.hµ
>

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<boo¡/±r_cÚš”/±r_m­.hµ
>

14 
ho¡’t
;

15 
¬es_chªÃld©a
;

16 
¬es_chªÃld©a
* 
	t¬es_chªÃl
;

19 
Çme¥aû
 
muduo


21 
Çme¥aû
 
Ãt


23 
şass
 
ChªÃl
;

24 
şass
 
Ev’tLoİ
;

28 
Çme¥aû
 
cdns


31 şas 
	cResŞv”
 : 
boo¡
::
nÚcİyabË


33 
public
:

34 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tIÃtAdd»ss
&)> 
	tC®lback
;

35 
	eO±iÚ


37 
kDNSªdHo¡sFe
,

38 
kDNSÚly
,

41 
ex¶ic™
 
ResŞv”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
, 
O±iÚ
 
İt
 = 
kDNSªdHo¡sFe
);

42 ~
ResŞv”
();

44 
boŞ
 
»sŞve
(
muduo
::
SŒšgArg
 
ho¡Çme
, cÚ¡ 
C®lback
& 
cb
);

46 
´iv©e
:

48 
	sQu”yD©a


50 
ResŞv”
* 
owÃr
;

51 
C®lback
 
ÿÎback
;

52 
Qu”yD©a
(
ResŞv”
* 
o
, cÚ¡ 
C®lback
& 
cb
)

53 : 
owÃr
(
o
), 
ÿÎback
(
cb
)

58 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ_
;

59 
¬es_chªÃl
 
ùx_
;

60 
boŞ
 
tim”Aùive_
;

61 
boo¡
::
	t±r_m­
<, 
	tmuduo
::
	tÃt
::
	tChªÃl
> 
	tChªÃlLi¡
;

62 
ChªÃlLi¡
 
chªÃls_
;

64 
ÚR—d
(
sockfd
, 
muduo
::
Time¡amp
 
t
);

65 
ÚTim”
();

66 
ÚQu”yResuÉ
(
¡©us
, 
ho¡’t
* 
»suÉ
, cÚ¡ 
C®lback
& 
cb
);

67 
ÚSockC»©e
(
sockfd
, 
ty³
);

68 
ÚSockS‹Chªge
(
sockfd
, 
boŞ
 
»ad
, boŞ 
wr™e
);

70 
¬es_ho¡_ÿÎback
(* 
d©a
, 
¡©us
, 
timeouts
, 
ho¡’t
* hostent);

71 
¬es_sock_ü—‹_ÿÎback
(
sockfd
, 
ty³
, * 
d©a
);

72 
¬es_sock_¡©e_ÿÎback
(* 
d©a
, 
sockfd
, 
»ad
, 
wr™e
);

	@examples/cdns/dns.cc

1 
	~<exam¶es/cdns/ResŞv”.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<boo¡/bšd.hµ
>

4 
	~<¡dio.h
>

6 
usšg
 
Çme¥aû
 
	gmuduo
;

7 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

8 
usšg
 
Çme¥aû
 
	gcdns
;

10 
Ev’tLoİ
* 
	gg_loİ
;

11 
	gcouÁ
 = 0;

12 
	gtÙ®
 = 0;

14 
	$qu™
()

16 
g_loİ
->
	`qu™
();

17 
	}
}

19 
	$»sŞveC®lback
(cÚ¡ 
¡ršg
& 
ho¡
, cÚ¡ 
IÃtAdd»ss
& 
addr
)

21 
	`´štf
("»sŞveC®lback % -> %s\n", 
ho¡
.
	`c_¡r
(), 
addr
.
	`toIpPÜt
().c_str());

22 ià(++
couÁ
 =ğ
tÙ®
)

23 
	`qu™
();

24 
	}
}

26 
	$»sŞve
(
ResŞv”
* 
»s
, cÚ¡ 
¡ršg
& 
ho¡
)

28 
»s
->
	`»sŞve
(
ho¡
, 
boo¡
::
	`bšd
(&
»sŞveC®lback
, ho¡, 
_1
));

29 
	}
}

31 
	$maš
(
¬gc
, * 
¬gv
[])

33 
Ev’tLoİ
 
loİ
;

34 
loİ
.
	`runAá”
(10, 
qu™
);

35 
g_loİ
 = &
loİ
;

36 
ResŞv”
 
	`»sŞv”
(&
loİ
,

37 
¬gc
 =ğ1 ? 
ResŞv”
::
kDNSÚly
 : ResŞv”::
kDNSªdHo¡sFe
);

38 ià(
¬gc
 == 1)

40 
tÙ®
 = 3;

41 
	`»sŞve
(&
»sŞv”
, "www.chenshuo.com");

42 
	`»sŞve
(&
»sŞv”
, "www.example.com");

43 
	`»sŞve
(&
»sŞv”
, "www.google.com");

47 
tÙ®
 = 
¬gc
-1;

48 
i
 = 1; i < 
¬gc
; ++i)

49 
	`»sŞve
(&
»sŞv”
, 
¬gv
[
i
]);

51 
loİ
.
	`loİ
();

52 
	}
}

	@examples/curl/Curl.cc

1 
	~<exam¶es/cu¾/Cu¾.h
>

2 
	~<muduo/ba£/Loggšg.h
>

3 
	~<muduo/Ãt/ChªÃl.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<boo¡/bšd.hµ
>

7 
	~<cu¾/cu¾.h
>

8 
	~<as£¹.h
>

10 
usšg
 
Çme¥aû
 
	gcu¾
;

11 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

14 
dummy
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>&)

18 
Reque¡
::
	$Reque¡
(
Cu¾
* 
owÃr
, cÚ¡ * 
u¾
)

19 : 
	`owÃr_
(
owÃr
),

20 
	`cu¾_
(
	`CHECK_NOTNULL
(
	$cu¾_—sy_š™
()))

22 
	`£tİt
(
CURLOPT_URL
, 
u¾
);

23 
	`£tİt
(
CURLOPT_WRITEFUNCTION
, &
Reque¡
::
wr™eD©a
);

24 
	`£tİt
(
CURLOPT_WRITEDATA
, 
this
);

25 
	`£tİt
(
CURLOPT_HEADERFUNCTION
, &
Reque¡
::
h—d”D©a
);

26 
	`£tİt
(
CURLOPT_HEADERDATA
, 
this
);

27 
	`£tİt
(
CURLOPT_PRIVATE
, 
this
);

28 
	`£tİt
(
CURLOPT_USERAGENT
, "curl");

30 
LOG_DEBUG
 << 
cu¾_
 << " " << 
u¾
;

31 
	`cu¾_muÉi_add_hªdË
(
owÃr_
->
	`g‘Cu¾m
(), 
cu¾_
);

32 
	}
}

34 
	gReque¡
::~
	$Reque¡
()

36 
	`as£¹
(!
chªÃl_
 || chªÃl_->
	`isNÚeEv’t
());

37 
	`cu¾_muÉi_»move_hªdË
(
owÃr_
->
	`g‘Cu¾m
(), 
cu¾_
);

38 
	`cu¾_—sy_ş—nup
(
cu¾_
);

39 
	}
}

49 
	gReque¡
::
	$h—d”OÆy
()

51 
	`£tİt
(
CURLOPT_NOBODY
, 1);

52 
	}
}

54 
	gReque¡
::
	$£tRªge
(cÚ¡ 
SŒšgArg
 
¿nge
)

56 
	`£tİt
(
CURLOPT_RANGE
, 
¿nge
.
	`c_¡r
());

57 
	}
}

59 cÚ¡ * 
	gReque¡
::
	$g‘EfãùiveU¾
()

61 cÚ¡ * 
p
 = 
NULL
;

62 
	`cu¾_—sy_g‘šfo
(
cu¾_
, 
CURLINFO_EFFECTIVE_URL
, &
p
);

63  
p
;

64 
	}
}

66 cÚ¡ * 
	gReque¡
::
	$g‘RedœeùU¾
()

68 cÚ¡ * 
p
 = 
NULL
;

69 
	`cu¾_—sy_g‘šfo
(
cu¾_
, 
CURLINFO_REDIRECT_URL
, &
p
);

70  
p
;

71 
	}
}

73 
	gReque¡
::
	$g‘Re¥Ú£Code
()

75 
code
 = 0;

76 
	`cu¾_—sy_g‘šfo
(
cu¾_
, 
CURLINFO_RESPONSE_CODE
, &
code
);

77  
¡©ic_ÿ¡
<>(
code
);

78 
	}
}

80 
ChªÃl
* 
	gReque¡
::
	$£tChªÃl
(
fd
)

82 
	`as£¹
(
chªÃl_
.
	`g‘
(è=ğ
NULL
);

83 
chªÃl_
.
	`»£t
(
Ãw
 
	`ChªÃl
(
owÃr_
->
	`g‘Loİ
(), 
fd
));

84 
chªÃl_
->
	`t›
(
	`sh¬ed_äom_this
());

85  
	`g‘_poš‹r
(
chªÃl_
);

86 
	}
}

88 
	gReque¡
::
	$»moveChªÃl
()

90 
chªÃl_
->
	`di§bËAÎ
();

91 
chªÃl_
->
	`»move
();

92 
owÃr_
->
	`g‘Loİ
()->
	`queueInLoİ
(
boo¡
::
	`bšd
(
dummy
, 
chªÃl_
));

93 
chªÃl_
.
	`»£t
();

94 
	}
}

96 
	gReque¡
::
	$dÚe
(
code
)

98 ià(
dÚeCb_
)

100 
	`dÚeCb_
(
this
, 
code
);

102 
	}
}

104 
	gReque¡
::
	$d©aC®lback
(cÚ¡ * 
bufãr
, 
Ën
)

106 ià(
d©aCb_
)

108 
	`d©aCb_
(
bufãr
, 
Ën
);

110 
	}
}

112 
	gReque¡
::
	$h—d”C®lback
(cÚ¡ * 
bufãr
, 
Ën
)

114 ià(
h—d”Cb_
)

116 
	`h—d”Cb_
(
bufãr
, 
Ën
);

118 
	}
}

120 
size_t
 
	gReque¡
::
	$wr™eD©a
(* 
bufãr
, 
size_t
 
size
, size_ˆ
nmemb
, * 
u£½
)

122 
	`as£¹
(
size
 == 1);

123 
Reque¡
* 
»q
 = 
¡©ic_ÿ¡
<Reque¡*>(
u£½
);

124 
»q
->
	`d©aC®lback
(
bufãr
, 
¡©ic_ÿ¡
<>(
nmemb
));

125  
nmemb
;

126 
	}
}

128 
size_t
 
	gReque¡
::
	$h—d”D©a
(* 
bufãr
, 
size_t
 
size
, size_ˆ
nmemb
, * 
u£½
)

130 
	`as£¹
(
size
 == 1);

131 
Reque¡
* 
»q
 = 
¡©ic_ÿ¡
<Reque¡*>(
u£½
);

132 
»q
->
	`h—d”C®lback
(
bufãr
, 
¡©ic_ÿ¡
<>(
nmemb
));

133  
nmemb
;

134 
	}
}

138 
	gCu¾
::
	$š™Ÿlize
(
O±iÚ
 
İt
)

140 
	`cu¾_glob®_š™
(
İt
 =ğ
kCURLnos¦
 ? 
CURL_GLOBAL_NOTHING
 : 
CURL_GLOBAL_SSL
);

141 
	}
}

143 
	gCu¾
::
	$sock‘C®lback
(
CURL
* 
c
, 
fd
, 
wh©
, * 
u£½
, * 
sock‘p
)

145 
Cu¾
* 
cu¾
 = 
¡©ic_ÿ¡
<Cu¾*>(
u£½
);

146 cÚ¡ *
wh©¡r
[]={ "none", "IN", "OUT", "INOUT", "REMOVE" };

147 
LOG_DEBUG
 << "Cu¾::sock‘C®lback [" << 
cu¾
 << "] - fd = " << 
fd


148 << " wh© = " << 
wh©¡r
[
wh©
];

149 
Reque¡
* 
»q
 = 
NULL
;

150 
	`cu¾_—sy_g‘šfo
(
c
, 
CURLINFO_PRIVATE
, &
»q
);

151 
	`as£¹
(
»q
->
	`g‘Cu¾
(è=ğ
c
);

152 ià(
wh©
 =ğ
CURL_POLL_REMOVE
)

154 
muduo
::
Ãt
::
ChªÃl
* 
ch
 = 
¡©ic_ÿ¡
<ChªÃl*>(
sock‘p
);

155 
	`as£¹
(
»q
->
	`g‘ChªÃl
(è=ğ
ch
);

156 
»q
->
	`»moveChªÃl
();

157 
ch
 = 
NULL
;

158 
	`cu¾_muÉi_assign
(
cu¾
->
cu¾m_
, 
fd
, 
ch
);

162 
muduo
::
Ãt
::
ChªÃl
* 
ch
 = 
¡©ic_ÿ¡
<ChªÃl*>(
sock‘p
);

163 ià(!
ch
)

165 
ch
 = 
»q
->
	`£tChªÃl
(
fd
);

166 
ch
->
	`£tR—dC®lback
(
boo¡
::
	`bšd
(&
Cu¾
::
ÚR—d
, 
cu¾
, 
fd
));

167 
ch
->
	`£tWr™eC®lback
(
boo¡
::
	`bšd
(&
Cu¾
::
ÚWr™e
, 
cu¾
, 
fd
));

168 
ch
->
	`’abËR—dšg
();

169 
	`cu¾_muÉi_assign
(
cu¾
->
cu¾m_
, 
fd
, 
ch
);

170 
LOG_TRACE
 << "Ãw chªÃÈfÜ fd=" << 
fd
;

172 
	`as£¹
(
»q
->
	`g‘ChªÃl
(è=ğ
ch
);

174 ià(
wh©
 & 
CURL_POLL_OUT
)

176 
ch
->
	`’abËWr™šg
();

180 
ch
->
	`di§bËWr™šg
();

184 
	}
}

186 
	gCu¾
::
	$tim”C®lback
(
CURLM
* 
cu¾m
, 
ms
, * 
u£½
)

188 
Cu¾
* 
cu¾
 = 
¡©ic_ÿ¡
<Cu¾*>(
u£½
);

189 
LOG_DEBUG
 << 
cu¾
 << " " << 
ms
 << " ms";

190 
cu¾
->
loİ_
->
	`runAá”
(
¡©ic_ÿ¡
<>(
ms
)/1000.0, 
boo¡
::
	`bšd
(&
Cu¾
::
ÚTim”
, curl));

192 
	}
}

194 
	gCu¾
::
	$Cu¾
(
Ev’tLoİ
* 
loİ
)

195 : 
	`loİ_
(
loİ
),

196 
	`cu¾m_
(
	`CHECK_NOTNULL
(
	`cu¾_muÉi_š™
())),

197 
	`ruÂšgHªdËs_
(0),

198 
	$´evRuÂšgHªdËs_
(0)

200 
	`cu¾_muÉi_£tİt
(
cu¾m_
, 
CURLMOPT_SOCKETFUNCTION
, &
Cu¾
::
sock‘C®lback
);

201 
	`cu¾_muÉi_£tİt
(
cu¾m_
, 
CURLMOPT_SOCKETDATA
, 
this
);

202 
	`cu¾_muÉi_£tİt
(
cu¾m_
, 
CURLMOPT_TIMERFUNCTION
, &
Cu¾
::
tim”C®lback
);

203 
	`cu¾_muÉi_£tİt
(
cu¾m_
, 
CURLMOPT_TIMERDATA
, 
this
);

204 
	}
}

206 
	gCu¾
::~
	$Cu¾
()

208 
	`cu¾_muÉi_ş—nup
(
cu¾m_
);

209 
	}
}

211 
Reque¡PŒ
 
	gCu¾
::
	$g‘U¾
(
SŒšgArg
 
u¾
)

213 
Reque¡PŒ
 
	`»q
(
Ãw
 
	`Reque¡
(
this
, 
u¾
.
	`c_¡r
()));

214  
»q
;

215 
	}
}

217 
	gCu¾
::
	$ÚTim”
()

219 
CURLMcode
 
rc
 = 
CURLM_OK
;

221 
LOG_TRACE
;

222 
rc
 = 
	`cu¾_muÉi_sock‘_aùiÚ
(
cu¾m_
, 
CURL_SOCKET_TIMEOUT
, 0, &
ruÂšgHªdËs_
);

223 
LOG_TRACE
 << 
rc
 << " " << 
ruÂšgHªdËs_
;

224 } 
rc
 =ğ
CURLM_CALL_MULTI_PERFORM
);

225 
	`checkFšish
();

226 
	}
}

228 
	gCu¾
::
	$ÚR—d
(
fd
)

230 
CURLMcode
 
rc
 = 
CURLM_OK
;

232 
LOG_TRACE
 << 
fd
;

233 
rc
 = 
	`cu¾_muÉi_sock‘_aùiÚ
(
cu¾m_
, 
fd
, 
CURL_POLL_IN
, &
ruÂšgHªdËs_
);

234 
LOG_TRACE
 << 
fd
 << " " << 
rc
 << " " << 
ruÂšgHªdËs_
;

235 } 
rc
 =ğ
CURLM_CALL_MULTI_PERFORM
);

236 
	`checkFšish
();

237 
	}
}

239 
	gCu¾
::
	$ÚWr™e
(
fd
)

241 
CURLMcode
 
rc
 = 
CURLM_OK
;

243 
LOG_TRACE
 << 
fd
;

244 
rc
 = 
	`cu¾_muÉi_sock‘_aùiÚ
(
cu¾m_
, 
fd
, 
CURL_POLL_OUT
, &
ruÂšgHªdËs_
);

245 
LOG_TRACE
 << 
fd
 << " " << 
rc
 << " " << 
ruÂšgHªdËs_
;

246 } 
rc
 =ğ
CURLM_CALL_MULTI_PERFORM
);

247 
	`checkFšish
();

248 
	}
}

250 
	gCu¾
::
	$checkFšish
()

252 ià(
´evRuÂšgHªdËs_
 > 
ruÂšgHªdËs_
 ||„unningHandles_ == 0)

254 
CURLMsg
* 
msg
 = 
NULL
;

255 
Ëá
 = 0;

256  (
msg
 = 
	`cu¾_muÉi_šfo_»ad
(
cu¾m_
, &
Ëá
)è!ğ
NULL
)

258 ià(
msg
->msg =ğ
CURLMSG_DONE
)

260 
CURL
* 
c
 = 
msg
->
—sy_hªdË
;

261 
CURLcode
 
»s
 = 
msg
->
d©a
.
»suÉ
;

262 
Reque¡
* 
»q
 = 
NULL
;

263 
	`cu¾_—sy_g‘šfo
(
c
, 
CURLINFO_PRIVATE
, &
»q
);

264 
	`as£¹
(
»q
->
	`g‘Cu¾
(è=ğ
c
);

265 
LOG_TRACE
 << 
»q
 << " done";

266 
»q
->
	`dÚe
(
»s
);

270 
´evRuÂšgHªdËs_
 = 
ruÂšgHªdËs_
;

271 
	}
}

	@examples/curl/Curl.h

1 #iâdeà
MUDUO_EXAMPLES_CURL_CURL_H


2 
	#MUDUO_EXAMPLES_CURL_CURL_H


	)

4 
	~<muduo/ba£/SŒšgP›û.h
>

6 
	~<boo¡/funùiÚ.hµ
>

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<boo¡/sh¬ed_±r.hµ
>

9 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

10 
	~<boo¡/scİed_±r.hµ
>

14 
	tCURLM
;

15 
	tCURL
;

18 
Çme¥aû
 
muduo


20 
Çme¥aû
 
Ãt


22 
şass
 
ChªÃl
;

23 
şass
 
Ev’tLoİ
;

27 
Çme¥aû
 
cu¾


30 
şass
 
Cu¾
;

32 
şass
 
Reque¡
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<Request>,

33 
boo¡
::
nÚcİyabË


35 
public
:

36 
boo¡
::
	tfunùiÚ
<(cÚ¡ *, )> 
	tD©aC®lback
;

37 
boo¡
::
	tfunùiÚ
<(
	tReque¡
*, )> 
	tDÚeC®lback
;

39 
Reque¡
(
Cu¾
*, cÚ¡ * 
u¾
);

40 ~
Reque¡
();

42 
£tD©aC®lback
(cÚ¡ 
D©aC®lback
& 
cb
)

43 { 
d©aCb_
 = 
cb
; }

45 
£tDÚeC®lback
(cÚ¡ 
DÚeC®lback
& 
cb
)

46 { 
dÚeCb_
 = 
cb
; }

48 
£tH—d”C®lback
(cÚ¡ 
D©aC®lback
& 
cb
)

49 { 
h—d”Cb_
 = 
cb
; }

52 
h—d”OÆy
();

53 
£tRªge
(cÚ¡ 
muduo
::
SŒšgArg
 
¿nge
);

55 
‹m¶©e
<
ty³Çme
 
OPT
>

56 
£tİt
(
OPT
 
İt
, 
p
)

58  
cu¾_—sy_£tİt
(
cu¾_
, 
İt
, 
p
);

61 
‹m¶©e
<
ty³Çme
 
OPT
>

62 
£tİt
(
OPT
 
İt
, cÚ¡ * 
p
)

64  
cu¾_—sy_£tİt
(
cu¾_
, 
İt
, 
p
);

67 
‹m¶©e
<
ty³Çme
 
OPT
>

68 
£tİt
(
OPT
 
İt
, * 
p
)

70  
cu¾_—sy_£tİt
(
cu¾_
, 
İt
, 
p
);

73 
‹m¶©e
<
ty³Çme
 
OPT
>

74 
£tİt
(
OPT
 
İt
, 
size_t
 (*
p
)(*, size_t , size_t , *))

76  
cu¾_—sy_£tİt
(
cu¾_
, 
İt
, 
p
);

79 cÚ¡ * 
g‘EfãùiveU¾
();

80 cÚ¡ * 
g‘RedœeùU¾
();

81 
g‘Re¥Ú£Code
();

84 
muduo
::
Ãt
::
ChªÃl
* 
£tChªÃl
(
fd
);

85 
»moveChªÃl
();

86 
dÚe
(
code
);

87 
CURL
* 
g‘Cu¾
(è{  
cu¾_
; }

88 
muduo
::
Ãt
::
ChªÃl
* 
g‘ChªÃl
(è{  
g‘_poš‹r
(
chªÃl_
); }

90 
´iv©e
:

92 
d©aC®lback
(cÚ¡ * 
bufãr
, 
Ën
);

93 
h—d”C®lback
(cÚ¡ * 
bufãr
, 
Ën
);

94 
size_t
 
wr™eD©a
(*
bufãr
, size_ˆ
size
, size_ˆ
nmemb
, *
u£½
);

95 
size_t
 
h—d”D©a
(*
bufãr
, size_ˆ
size
, size_ˆ
nmemb
, *
u£½
);

96 
dÚeC®lback
();

98 
şass
 
Cu¾
* 
owÃr_
;

99 
CURL
* 
cu¾_
;

100 
boo¡
::
sh¬ed_±r
<
muduo
::
Ãt
::
ChªÃl
> 
chªÃl_
;

101 
D©aC®lback
 
d©aCb_
;

102 
D©aC®lback
 
h—d”Cb_
;

103 
DÚeC®lback
 
dÚeCb_
;

106 
boo¡
::
	tsh¬ed_±r
<
	tReque¡
> 
	tReque¡PŒ
;

108 şas 
	cCu¾
 : 
boo¡
::
nÚcİyabË


110 
public
:

112 
	eO±iÚ


114 
kCURLnos¦
 = 0,

115 
kCURLs¦
 = 1,

118 
ex¶ic™
 
Cu¾
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
);

119 ~
Cu¾
();

121 
Reque¡PŒ
 
g‘U¾
(
muduo
::
SŒšgArg
 
u¾
);

123 
š™Ÿlize
(
O±iÚ
 
İt
 = 
kCURLnos¦
);

126 
CURLM
* 
g‘Cu¾m
(è{  
cu¾m_
; }

127 
muduo
::
Ãt
::
Ev’tLoİ
* 
g‘Loİ
(è{  
loİ_
; }

129 
´iv©e
:

130 
ÚTim”
();

131 
ÚR—d
(
fd
);

132 
ÚWr™e
(
fd
);

133 
checkFšish
();

135 
sock‘C®lback
(
CURL
*, , , *, *);

136 
tim”C®lback
(
CURLM
*, , *);

138 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ_
;

139 
CURLM
* 
cu¾m_
;

140 
ruÂšgHªdËs_
;

141 
´evRuÂšgHªdËs_
;

	@examples/curl/Curl.h

1 #iâdeà
MUDUO_EXAMPLES_CURL_CURL_H


2 
	#MUDUO_EXAMPLES_CURL_CURL_H


	)

4 
	~<muduo/ba£/SŒšgP›û.h
>

6 
	~<boo¡/funùiÚ.hµ
>

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<boo¡/sh¬ed_±r.hµ
>

9 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

10 
	~<boo¡/scİed_±r.hµ
>

14 
	tCURLM
;

15 
	tCURL
;

18 
Çme¥aû
 
muduo


20 
Çme¥aû
 
Ãt


22 
şass
 
ChªÃl
;

23 
şass
 
Ev’tLoİ
;

27 
Çme¥aû
 
cu¾


30 
şass
 
Cu¾
;

32 
şass
 
Reque¡
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<Request>,

33 
boo¡
::
nÚcİyabË


35 
public
:

36 
boo¡
::
	tfunùiÚ
<(cÚ¡ *, )> 
	tD©aC®lback
;

37 
boo¡
::
	tfunùiÚ
<(
	tReque¡
*, )> 
	tDÚeC®lback
;

39 
Reque¡
(
Cu¾
*, cÚ¡ * 
u¾
);

40 ~
Reque¡
();

42 
£tD©aC®lback
(cÚ¡ 
D©aC®lback
& 
cb
)

43 { 
d©aCb_
 = 
cb
; }

45 
£tDÚeC®lback
(cÚ¡ 
DÚeC®lback
& 
cb
)

46 { 
dÚeCb_
 = 
cb
; }

48 
£tH—d”C®lback
(cÚ¡ 
D©aC®lback
& 
cb
)

49 { 
h—d”Cb_
 = 
cb
; }

52 
h—d”OÆy
();

53 
£tRªge
(cÚ¡ 
muduo
::
SŒšgArg
 
¿nge
);

55 
‹m¶©e
<
ty³Çme
 
OPT
>

56 
£tİt
(
OPT
 
İt
, 
p
)

58  
cu¾_—sy_£tİt
(
cu¾_
, 
İt
, 
p
);

61 
‹m¶©e
<
ty³Çme
 
OPT
>

62 
£tİt
(
OPT
 
İt
, cÚ¡ * 
p
)

64  
cu¾_—sy_£tİt
(
cu¾_
, 
İt
, 
p
);

67 
‹m¶©e
<
ty³Çme
 
OPT
>

68 
£tİt
(
OPT
 
İt
, * 
p
)

70  
cu¾_—sy_£tİt
(
cu¾_
, 
İt
, 
p
);

73 
‹m¶©e
<
ty³Çme
 
OPT
>

74 
£tİt
(
OPT
 
İt
, 
size_t
 (*
p
)(*, size_t , size_t , *))

76  
cu¾_—sy_£tİt
(
cu¾_
, 
İt
, 
p
);

79 cÚ¡ * 
g‘EfãùiveU¾
();

80 cÚ¡ * 
g‘RedœeùU¾
();

81 
g‘Re¥Ú£Code
();

84 
muduo
::
Ãt
::
ChªÃl
* 
£tChªÃl
(
fd
);

85 
»moveChªÃl
();

86 
dÚe
(
code
);

87 
CURL
* 
g‘Cu¾
(è{  
cu¾_
; }

88 
muduo
::
Ãt
::
ChªÃl
* 
g‘ChªÃl
(è{  
g‘_poš‹r
(
chªÃl_
); }

90 
´iv©e
:

92 
d©aC®lback
(cÚ¡ * 
bufãr
, 
Ën
);

93 
h—d”C®lback
(cÚ¡ * 
bufãr
, 
Ën
);

94 
size_t
 
wr™eD©a
(*
bufãr
, size_ˆ
size
, size_ˆ
nmemb
, *
u£½
);

95 
size_t
 
h—d”D©a
(*
bufãr
, size_ˆ
size
, size_ˆ
nmemb
, *
u£½
);

96 
dÚeC®lback
();

98 
şass
 
Cu¾
* 
owÃr_
;

99 
CURL
* 
cu¾_
;

100 
boo¡
::
sh¬ed_±r
<
muduo
::
Ãt
::
ChªÃl
> 
chªÃl_
;

101 
D©aC®lback
 
d©aCb_
;

102 
D©aC®lback
 
h—d”Cb_
;

103 
DÚeC®lback
 
dÚeCb_
;

106 
boo¡
::
	tsh¬ed_±r
<
	tReque¡
> 
	tReque¡PŒ
;

108 şas 
	cCu¾
 : 
boo¡
::
nÚcİyabË


110 
public
:

112 
	eO±iÚ


114 
kCURLnos¦
 = 0,

115 
kCURLs¦
 = 1,

118 
ex¶ic™
 
Cu¾
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
);

119 ~
Cu¾
();

121 
Reque¡PŒ
 
g‘U¾
(
muduo
::
SŒšgArg
 
u¾
);

123 
š™Ÿlize
(
O±iÚ
 
İt
 = 
kCURLnos¦
);

126 
CURLM
* 
g‘Cu¾m
(è{  
cu¾m_
; }

127 
muduo
::
Ãt
::
Ev’tLoİ
* 
g‘Loİ
(è{  
loİ_
; }

129 
´iv©e
:

130 
ÚTim”
();

131 
ÚR—d
(
fd
);

132 
ÚWr™e
(
fd
);

133 
checkFšish
();

135 
sock‘C®lback
(
CURL
*, , , *, *);

136 
tim”C®lback
(
CURLM
*, , *);

138 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ_
;

139 
CURLM
* 
cu¾m_
;

140 
ruÂšgHªdËs_
;

141 
´evRuÂšgHªdËs_
;

	@examples/curl/download.cc

3 
	~<exam¶es/cu¾/Cu¾.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

8 
	~<¡dio.h
>

9 
	~<s¡»am
>

11 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

14 
	gboo¡
::
	tsh¬ed_±r
<
	tFILE
> 
	tFePŒ
;

16 
	g‹m¶©e
<
	gN
>

17 
boŞ
 
¡¬tW™h
(cÚ¡ 
¡ršg
& 
¡r
, cÚ¡ (&
´efix
)[
N
])

19  
	g¡r
.
size
(è>ğ
N
-1 && 
¡d
::
equ®
(
´efix
,…»fix+N-1, 
¡r
.
begš
());

22 şas 
	cP›û
 : 
boo¡
::
nÚcİyabË


24 
public
:

25 
P›û
(cÚ¡ 
cu¾
::
Reque¡PŒ
& 
»q
,

26 cÚ¡ 
FePŒ
& 
out
,

27 cÚ¡ 
muduo
::
¡ršg
& 
¿nge
,

28 cÚ¡ 
boo¡
::
funùiÚ
<()> 
dÚe
)

29 : 
»q_
(
»q
),

30 
out_
(
out
),

31 
¿nge_
(
¿nge
),

32 
	$dÚeCb_
(
dÚe
)

34 
LOG_INFO
 << "¿nge: " << 
¿nge
;

35 
»q
->
	`£tRªge
(
¿nge
);

36 
»q_
->
	`£tD©aC®lback
(

37 
boo¡
::
	`bšd
(&
P›û
::
ÚD©a
, 
this
, 
_1
, 
_2
));

38 
»q_
->
	`£tDÚeC®lback
(

39 
boo¡
::
	`bšd
(&
P›û
::
ÚDÚe
, 
this
, 
_1
, 
_2
));

41 
´iv©e
:

42 
	$ÚD©a
(cÚ¡ * 
d©a
, 
Ën
)

44 ::
	`fwr™e
(
d©a
, 1, 
Ën
, 
	`g‘_poš‹r
(
out_
));

45 
	}
}

47 
ÚDÚe
(
cu¾
::
Reque¡
* 
c
, 
code
)

49 
	gLOG_INFO
 << "[" << 
	g¿nge_
 << "] is done";

50 
	g»q_
.
»£t
();

51 
	gout_
.
»£t
();

52 
dÚeCb_
();

55 
	gcu¾
::
Reque¡PŒ
 
»q_
;

56 
FePŒ
 
	gout_
;

57 
	gmuduo
::
¡ršg
 
¿nge_
;

58 
	gboo¡
::
funùiÚ
<()> 
dÚeCb_
;

61 şas 
	cDowÆßd”
 : 
boo¡
::
nÚcİyabË


63 
public
:

64 
	$DowÆßd”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
¡ršg
& 
u¾
)

65 : 
	`loİ_
(
loİ
),

66 
	`cu¾_
(
loİ_
),

67 
	`u¾_
(
u¾
),

68 
	`»q_
(
cu¾_
.
	`g‘U¾
(
u¾_
)),

69 
	`found_
(
çl£
),

70 
	`acû±Rªges_
(
çl£
),

71 
	`Ëngth_
(0),

72 
	`p›ûs_
(
kCÚcu¼’t
),

73 
	$cÚcu¼’t_
(0)

75 
»q_
->
	`£tH—d”C®lback
(

76 
boo¡
::
	`bšd
(&
DowÆßd”
::
ÚH—d”
, 
this
, 
_1
, 
_2
));

77 
»q_
->
	`£tDÚeC®lback
(

78 
boo¡
::
	`bšd
(&
DowÆßd”
::
ÚH—d”DÚe
, 
this
, 
_1
, 
_2
));

79 
»q_
->
	`h—d”OÆy
();

82 
´iv©e
:

83 
	$ÚH—d”
(cÚ¡ * 
d©a
, 
Ën
)

85 
¡ršg
 
	`lše
(
d©a
, 
Ën
);

86 ià(
	`¡¬tW™h
(
lše
, "HTTP/1.1 200") || startWith(line, "HTTP/1.0 200"))

88 
found_
 = 
Œue
;

90 ià(
lše
 == "Accept-Ranges: bytes\r\n")

92 
acû±Rªges_
 = 
Œue
;

93 
LOG_DEBUG
 << "Accept-Ranges";

95 ià(
	`¡¬tW™h
(
lše
, "Content-Length:"))

97 
Ëngth_
 = 
	`©Şl
(
lše
.
	`c_¡r
(è+ 
	`¡¾’
("Content-Length:"));

98 
LOG_INFO
 << "CÚ‹Á-L’gth: " << 
Ëngth_
;

100 
	}
}

102 
ÚH—d”DÚe
(
cu¾
::
Reque¡
* 
c
, 
code
)

104 
	gLOG_DEBUG
 << 
	gcode
;

105 ià(
	gacû±Rªges_
 && 
	gËngth_
 >ğ
kCÚcu¼’t
 * 4096)

107 
LOG_INFO
 << "DowÆßdšg w™h " << 
kCÚcu¼’t
 << " connections";

108 
	gcÚcu¼’t_
 = 
kCÚcu¼’t
;

109 
cÚcu¼’tDowÆßd
();

111 ià(
	gfound_
)

113 
	gLOG_WARN
 << "Single connection download";

114 
FILE
* 
	gå
 = ::
fİ’
("output", "wb");

115 ià(
	gå
)

117 
FePŒ
(
å
, ::
fşo£
).
sw­
(
out_
);

118 
	g»q_
.
»£t
();

119 
	g»q2_
 = 
cu¾_
.
g‘U¾
(
u¾_
);

120 
	g»q2_
->
£tD©aC®lback
(

121 
boo¡
::
bšd
(&
DowÆßd”
::
ÚD©a
, 
this
, 
_1
, 
_2
));

122 
	g»q2_
->
£tDÚeC®lback
(

123 
boo¡
::
bšd
(&
DowÆßd”
::
ÚDowÆßdDÚe
, 
this
));

124 
	gcÚcu¼’t_
 = 1;

128 
	gLOG_ERROR
 << "Can‚ot create output file";

129 
	gloİ_
->
qu™
();

134 
	gLOG_ERROR
 << "File‚ot found";

135 
	gloİ_
->
qu™
();

139 
	$cÚcu¼’tDowÆßd
()

141 cÚ¡ 
št64_t
 
p›ûL’
 = 
Ëngth_
 / 
kCÚcu¼’t
;

142 
i
 = 0; i < 
kCÚcu¼’t
; ++i)

144 
buf
[256];

145 
	`¢´štf
(
buf
,  buf, "ouut-%05d-of-%05d", 
i
, 
kCÚcu¼’t
);

146 
FILE
* 
å
 = ::
	`fİ’
(
buf
, "wb");

147 ià(
å
)

149 
FePŒ
 
	`out
(
å
, ::
fşo£
);

150 
cu¾
::
Reque¡PŒ
 
»q
 = 
cu¾_
.
	`g‘U¾
(
u¾_
);

152 
¡d
::
o¡ršg¡»am
 
¿nge
;

153 ià(
i
 < 
kCÚcu¼’t
 - 1)

155 
¿nge
 << 
i
 * 
p›ûL’
 << "-" << (i+1) *…ieceLen - 1;

159 
¿nge
 << 
i
 * 
p›ûL’
 << "-" << 
Ëngth_
 - 1;

161 
p›ûs_
.
	`push_back
(
Ãw
 
	`P›û
(
»q
,

162 
out
,

163 
¿nge
.
	`¡r
().
	`c_¡r
(),

164 
boo¡
::
	`bšd
(&
DowÆßd”
::
ÚDowÆßdDÚe
, 
this
)));

168 
LOG_ERROR
 << "Cª‚Ù c»©ouuˆfe: " << 
buf
;

169 
loİ_
->
	`qu™
();

172 
	}
}

174 
	$ÚD©a
(cÚ¡ * 
d©a
, 
Ën
)

176 ::
	`fwr™e
(
d©a
, 1, 
Ën
, 
	`g‘_poš‹r
(
out_
));

177 
	}
}

179 
	$ÚDowÆßdDÚe
()

181 ià(--
cÚcu¼’t_
 <= 0)

183 
loİ_
->
	`qu™
();

185 
	}
}

187 
Ev’tLoİ
* 
	gloİ_
;

188 
	gcu¾
::
Cu¾
 
cu¾_
;

189 
¡ršg
 
	gu¾_
;

190 
	gcu¾
::
Reque¡PŒ
 
»q_
;

191 
	gcu¾
::
Reque¡PŒ
 
»q2_
;

192 
boŞ
 
	gfound_
;

193 
boŞ
 
	gacû±Rªges_
;

194 
št64_t
 
	gËngth_
;

195 
FePŒ
 
	gout_
;

196 
	gboo¡
::
±r_veùÜ
<
P›û
> 
p›ûs_
;

197 
	gcÚcu¼’t_
;

199 cÚ¡ 
	gkCÚcu¼’t
 = 4;

202 
	$maš
(
¬gc
, * 
¬gv
[])

204 
Ev’tLoİ
 
loİ
;

205 
cu¾
::
Cu¾
::
	`š™Ÿlize
(cu¾::Cu¾::
kCURLs¦
);

206 
¡ršg
 
u¾
 = 
¬gc
 > 1 ? 
¬gv
[1] : "https://chenshuo-public.s3.amazonaws.com/pdf/allinone.pdf";

207 
DowÆßd”
 
	`d
(&
loİ
, 
u¾
);

208 
loİ
.
	`loİ
();

209 
	}
}

	@examples/curl/mcurl.cc

1 
	~<exam¶es/cu¾/Cu¾.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<boo¡/bšd.hµ
>

4 
	~<¡dio.h
>

6 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

8 
Ev’tLoİ
* 
	gg_loİ
 = 
NULL
;

10 
	$ÚD©a
(cÚ¡ * 
d©a
, 
Ën
)

12 
	`´štf
("ËÀ%d\n", 
Ën
);

13 
	}
}

15 
dÚe
(
cu¾
::
Reque¡
* 
c
, 
code
)

17 
´štf
("dÚ%°% %d\n", 
c
, c->
g‘EfãùiveU¾
(), 
code
);

20 
dÚe2
(
cu¾
::
Reque¡
* 
c
, 
code
)

22 
´štf
("dÚe2 %°% %d %d\n", 
c
, c->
g‘RedœeùU¾
(), c->
g‘Re¥Ú£Code
(), 
code
);

26 
	$maš
(
¬gc
, * 
¬gv
[])

28 
Ev’tLoİ
 
loİ
;

29 
g_loİ
 = &
loİ
;

30 
loİ
.
	`runAá”
(30.0, 
boo¡
::
	`bšd
(&
Ev’tLoİ
::
qu™
, &loop));

31 
cu¾
::
Cu¾
::
	`š™Ÿlize
(cu¾::Cu¾::
kCURLs¦
);

32 
cu¾
::
Cu¾
 
	`cu¾
(&
loİ
);

34 
cu¾
::
Reque¡PŒ
 
»q
 = cu¾.
	`g‘U¾
("http://chenshuo.com");

35 
»q
->
	`£tD©aC®lback
(
ÚD©a
);

36 
»q
->
	`£tDÚeC®lback
(
dÚe
);

38 
cu¾
::
Reque¡PŒ
 
»q2
 = cu¾.
	`g‘U¾
("https://github.com");

40 
»q2
->
	`£tD©aC®lback
(
ÚD©a
);

41 
»q2
->
	`£tDÚeC®lback
(
dÚe
);

43 
cu¾
::
Reque¡PŒ
 
»q3
 = cu¾.
	`g‘U¾
("http://example.com");

45 
»q3
->
	`£tD©aC®lback
(
ÚD©a
);

46 
»q3
->
	`£tDÚeC®lback
(
dÚe2
);

48 
loİ
.
	`loİ
();

49 
	}
}

	@examples/fastcgi/fastcgi.cc

1 
	~<exam¶es/ç¡cgi/ç¡cgi.h
>

2 
	~<muduo/ba£/Loggšg.h
>

3 
	~<muduo/Ãt/EndŸn.h
>

5 
	gFa¡CgiCodec
::
RecÜdH—d”


7 
ušt8_t
 
v”siÚ
;

8 
ušt8_t
 
	gty³
;

9 
ušt16_t
 
	gid
;

10 
ušt16_t
 
	gËngth
;

11 
ušt8_t
 
	g·ddšg
;

12 
ušt8_t
 
	gunu£d
;

15 cÚ¡ 
	gFa¡CgiCodec
::
kRecÜdH—d”
 = 
¡©ic_ÿ¡
<>((
Fa¡CgiCodec
::
RecÜdH—d”
));

17 
	eFcgiTy³


19 
	mkFcgiInv®id
 = 0,

20 
	mkFcgiBegšReque¡
 = 1,

21 
	mkFcgiAbÜtReque¡
 = 2,

22 
	mkFcgiEndReque¡
 = 3,

23 
	mkFcgiP¬ams
 = 4,

24 
	mkFcgiStdš
 = 5,

25 
	mkFcgiStdout
 = 6,

26 
	mkFcgiStd”r
 = 7,

27 
	mkFcgiD©a
 = 8,

28 
	mkFcgiG‘V®ues
 = 9,

29 
	mkFcgiG‘V®uesResuÉ
 = 10,

32 
	eFcgiRŞe


35 
	mkFcgiRe¥Úd”
 = 1,

36 
	mkFcgiAuthÜiz”
 = 2,

39 
	eFcgiCÚ¡ªt


41 
	mkFcgiK“pCÚn
 = 1,

44 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

46 
boŞ
 
	gFa¡CgiCodec
::
	$ÚP¬ams
(cÚ¡ * 
cÚ‹Á
, 
ušt16_t
 
Ëngth
)

48 ià(
Ëngth
 > 0)

50 
·¿msSŒ—m_
.
	`­³nd
(
cÚ‹Á
, 
Ëngth
);

52 ià(!
	`·r£AÎP¬ams
())

54 
LOG_ERROR
 << "parseAllParams() failed";

55  
çl£
;

57  
Œue
;

58 
	}
}

60 
	gFa¡CgiCodec
::
	$ÚStdš
(cÚ¡ * 
cÚ‹Á
, 
ušt16_t
 
Ëngth
)

62 ià(
Ëngth
 > 0)

64 
¡dš_
.
	`­³nd
(
cÚ‹Á
, 
Ëngth
);

68 
gÙReque¡_
 = 
Œue
;

70 
	}
}

72 
boŞ
 
	gFa¡CgiCodec
::
	$·r£AÎP¬ams
()

74 
·¿msSŒ—m_
.
	`»adabËBy‹s
() > 0)

76 
ušt32_t
 
ÇmeL’
 = 
	`»adL’
();

77 ià(
ÇmeL’
 =ğ
¡©ic_ÿ¡
<
ušt32_t
>(-1))

78  
çl£
;

79 
ušt32_t
 
v®ueL’
 = 
	`»adL’
();

80 ià(
v®ueL’
 =ğ
¡©ic_ÿ¡
<
ušt32_t
>(-1))

81  
çl£
;

82 ià(
·¿msSŒ—m_
.
	`»adabËBy‹s
(è>ğ
ÇmeL’
+
v®ueL’
)

84 
¡ršg
 
Çme
 = 
·¿msSŒ—m_
.
	`»Œ›veAsSŒšg
(
ÇmeL’
);

85 
·¿ms_
[
Çme
] = 
·¿msSŒ—m_
.
	`»Œ›veAsSŒšg
(
v®ueL’
);

89  
çl£
;

92  
Œue
;

93 
	}
}

95 
ušt32_t
 
	gFa¡CgiCodec
::
	$»adL’
()

97 ià(
·¿msSŒ—m_
.
	`»adabËBy‹s
() >= 1)

99 
ušt8_t
 
by‹
 = 
·¿msSŒ—m_
.
	`³ekIÁ8
();

100 ià(
by‹
 & 0x80)

102 ià(
·¿msSŒ—m_
.
	`»adabËBy‹s
(è>ğ(
ušt32_t
))

104  
·¿msSŒ—m_
.
	`»adIÁ32
() & 0x7fffffff;

113  
·¿msSŒ—m_
.
	`»adIÁ8
();

120 
	}
}

122 
usšg
 
	gmuduo
::
Ãt
::
Bufãr
;

124 
	gFa¡CgiCodec
::
	$’dStdout
(
Bufãr
* 
buf
)

126 
RecÜdH—d”
 
h—d”
 =

129 
kFcgiStdout
,

130 
sock‘s
::
	`ho¡ToN‘wÜk16
(1),

135 
buf
->
	`­³nd
(&
h—d”
, 
kRecÜdH—d”
);

136 
	}
}

138 
	gFa¡CgiCodec
::
	$’dReque¡
(
Bufãr
* 
buf
)

140 
RecÜdH—d”
 
h—d”
 =

143 
kFcgiEndReque¡
,

144 
sock‘s
::
	`ho¡ToN‘wÜk16
(1),

145 
sock‘s
::
	`ho¡ToN‘wÜk16
(
kRecÜdH—d”
),

149 
buf
->
	`­³nd
(&
h—d”
, 
kRecÜdH—d”
);

150 
buf
->
	`­³ndIÁ32
(0);

151 
buf
->
	`­³ndIÁ32
(0);

152 
	}
}

154 
	gFa¡CgiCodec
::
	$»¥Úd
(
Bufãr
* 
»¥Ú£
)

156 ià(
»¥Ú£
->
	`»adabËBy‹s
() < 65536

157 && 
»¥Ú£
->
	`´•’dabËBy‹s
(è>ğ
kRecÜdH—d”
)

159 
RecÜdH—d”
 
h—d”
 =

162 
kFcgiStdout
,

163 
sock‘s
::
	`ho¡ToN‘wÜk16
(1),

164 
sock‘s
::
	`ho¡ToN‘wÜk16
(
¡©ic_ÿ¡
<
ušt16_t
>(
»¥Ú£
->
	`»adabËBy‹s
())),

165 
¡©ic_ÿ¡
<
ušt8_t
>(-
»¥Ú£
->
	`»adabËBy‹s
() & 7),

168 
»¥Ú£
->
	`´•’d
(&
h—d”
, 
kRecÜdH—d”
);

169 
»¥Ú£
->
	`­³nd
("\0\0\0\0\0\0\0\0", 
h—d”
.
·ddšg
);

176 
	`’dStdout
(
»¥Ú£
);

177 
	`’dReque¡
(
»¥Ú£
);

178 
	}
}

180 
boŞ
 
	gFa¡CgiCodec
::
	$·r£Reque¡
(
Bufãr
* 
buf
)

182 
buf
->
	`»adabËBy‹s
(è>ğ
kRecÜdH—d”
)

184 
RecÜdH—d”
 
h—d”
;

185 
	`memıy
(&
h—d”
, 
buf
->
	`³ek
(), 
kRecÜdH—d”
);

186 
h—d”
.
id
 = 
sock‘s
::
	`ÃtwÜkToHo¡16
(header.id);

187 
h—d”
.
Ëngth
 = 
sock‘s
::
	`ÃtwÜkToHo¡16
(header.length);

188 
size_t
 
tÙ®
 = 
kRecÜdH—d”
 + 
h—d”
.
Ëngth
 + h—d”.
·ddšg
;

189 ià(
buf
->
	`»adabËBy‹s
(è>ğ
tÙ®
)

191 
h—d”
.
ty³
)

193 
kFcgiBegšReque¡
:

194 
	`ÚBegšReque¡
(
h—d”
, 
buf
);

197 
kFcgiP¬ams
:

198 
	`ÚP¬ams
(
buf
->
	`³ek
(è+ 
kRecÜdH—d”
, 
h—d”
.
Ëngth
);

201 
kFcgiStdš
:

202 
	`ÚStdš
(
buf
->
	`³ek
(è+ 
kRecÜdH—d”
, 
h—d”
.
Ëngth
);

204 
kFcgiD©a
:

207 
kFcgiG‘V®ues
:

214 
buf
->
	`»Œ›ve
(
tÙ®
);

221  
Œue
;

222 
	}
}

224 
ušt16_t
 
	$»adIÁ16
(cÚ¡ * 
p
)

226 
ušt16_t
 
be16
 = 0;

227 ::
	`memıy
(&
be16
, 
p
,  be16);

228  
sock‘s
::
	`ÃtwÜkToHo¡16
(
be16
);

229 
	}
}

231 
boŞ
 
	gFa¡CgiCodec
::
	$ÚBegšReque¡
(cÚ¡ 
RecÜdH—d”
& 
h—d”
, cÚ¡ 
Bufãr
* 
buf
)

233 
	`as£¹
(
buf
->
	`»adabËBy‹s
(è>ğ
h—d”
.
Ëngth
);

234 
	`as£¹
(
h—d”
.
ty³
 =ğ
kFcgiBegšReque¡
);

236 ià(
h—d”
.
Ëngth
 >ğ
kRecÜdH—d”
)

238 
ušt16_t
 
rŞe
 = 
	`»adIÁ16
(
buf
->
	`³ek
()+
kRecÜdH—d”
);

239 
ušt8_t
 
æags
 = 
buf
->
	`³ek
()[
kRecÜdH—d”
 + (
št16_t
)];

240 ià(
rŞe
 =ğ
kFcgiRe¥Úd”
)

242 
k“pCÚn_
 = 
æags
 =ğ
kFcgiK“pCÚn
;

243  
Œue
;

246  
çl£
;

247 
	}
}

	@examples/fastcgi/fastcgi.h

1 #iâdeà
MUDUO_EXAMPLES_FASTCGI_FASTCGI_H


2 
	#MUDUO_EXAMPLES_FASTCGI_FASTCGI_H


	)

4 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

5 
	~<m­
>

7 
usšg
 
	gmuduo
::
¡ršg
;

12 şas 
	cFa¡CgiCodec
 : 
boo¡
::
nÚcİyabË


14 
public
:

15 
¡d
::
	tm­
<
	t¡ršg
, sŒšg> 
	tP¬amM­
;

16 
	mboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
& 
	tcÚn
,

17 
	tP¬amM­
&,

18 
	tmuduo
::
	tÃt
::
	tBufãr
*)> 
	tC®lback
;

20 
ex¶ic™
 
	$Fa¡CgiCodec
(cÚ¡ 
C®lback
& 
cb
)

21 : 
	`cb_
(
cb
),

22 
	`gÙReque¡_
(
çl£
),

23 
	$k“pCÚn_
(
çl£
)

27 
	`ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

28 
muduo
::
Ãt
::
Bufãr
* 
buf
,

29 
muduo
::
Time¡amp
 
»ûiveTime
)

31 
	`·r£Reque¡
(
buf
);

32 ià(
gÙReque¡_
)

34 
	`cb_
(
cÚn
, 
·¿ms_
, &
¡dš_
);

35 
¡dš_
.
	`»Œ›veAÎ
();

36 
·¿msSŒ—m_
.
	`»Œ›veAÎ
();

37 
·¿ms_
.
	`ş—r
();

38 
gÙReque¡_
 = 
çl£
;

39 ià(!
k“pCÚn_
)

41 
cÚn
->
	`shutdown
();

44 
	}
}

46 
»¥Úd
(
muduo
::
Ãt
::
Bufãr
* 
»¥Ú£
);

48 
	g´iv©e
:

49 
RecÜdH—d”
;

50 
boŞ
 
·r£Reque¡
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

51 
boŞ
 
ÚBegšReque¡
(cÚ¡ 
RecÜdH—d”
& 
h—d”
, cÚ¡ 
muduo
::
Ãt
::
Bufãr
* 
buf
);

52 
ÚStdš
(cÚ¡ * 
cÚ‹Á
, 
ušt16_t
 
Ëngth
);

53 
boŞ
 
ÚP¬ams
(cÚ¡ * 
cÚ‹Á
, 
ušt16_t
 
Ëngth
);

54 
boŞ
 
·r£AÎP¬ams
();

55 
ušt32_t
 
»adL’
();

57 
’dStdout
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

58 
’dReque¡
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

60 
C®lback
 
	gcb_
;

61 
boŞ
 
	ggÙReque¡_
;

62 
boŞ
 
	gk“pCÚn_
;

63 
	gmuduo
::
Ãt
::
Bufãr
 
¡dš_
;

64 
	gmuduo
::
Ãt
::
Bufãr
 
·¿msSŒ—m_
;

65 
P¬amM­
 
	g·¿ms_
;

67 cÚ¡ 
	gkRecÜdH—d”
;

	@examples/fastcgi/fastcgi.h

1 #iâdeà
MUDUO_EXAMPLES_FASTCGI_FASTCGI_H


2 
	#MUDUO_EXAMPLES_FASTCGI_FASTCGI_H


	)

4 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

5 
	~<m­
>

7 
usšg
 
	gmuduo
::
¡ršg
;

12 şas 
	cFa¡CgiCodec
 : 
boo¡
::
nÚcİyabË


14 
public
:

15 
¡d
::
	tm­
<
	t¡ršg
, sŒšg> 
	tP¬amM­
;

16 
	mboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
& 
	tcÚn
,

17 
	tP¬amM­
&,

18 
	tmuduo
::
	tÃt
::
	tBufãr
*)> 
	tC®lback
;

20 
ex¶ic™
 
	$Fa¡CgiCodec
(cÚ¡ 
C®lback
& 
cb
)

21 : 
	`cb_
(
cb
),

22 
	`gÙReque¡_
(
çl£
),

23 
	$k“pCÚn_
(
çl£
)

27 
	`ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

28 
muduo
::
Ãt
::
Bufãr
* 
buf
,

29 
muduo
::
Time¡amp
 
»ûiveTime
)

31 
	`·r£Reque¡
(
buf
);

32 ià(
gÙReque¡_
)

34 
	`cb_
(
cÚn
, 
·¿ms_
, &
¡dš_
);

35 
¡dš_
.
	`»Œ›veAÎ
();

36 
·¿msSŒ—m_
.
	`»Œ›veAÎ
();

37 
·¿ms_
.
	`ş—r
();

38 
gÙReque¡_
 = 
çl£
;

39 ià(!
k“pCÚn_
)

41 
cÚn
->
	`shutdown
();

44 
	}
}

46 
»¥Úd
(
muduo
::
Ãt
::
Bufãr
* 
»¥Ú£
);

48 
	g´iv©e
:

49 
RecÜdH—d”
;

50 
boŞ
 
·r£Reque¡
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

51 
boŞ
 
ÚBegšReque¡
(cÚ¡ 
RecÜdH—d”
& 
h—d”
, cÚ¡ 
muduo
::
Ãt
::
Bufãr
* 
buf
);

52 
ÚStdš
(cÚ¡ * 
cÚ‹Á
, 
ušt16_t
 
Ëngth
);

53 
boŞ
 
ÚP¬ams
(cÚ¡ * 
cÚ‹Á
, 
ušt16_t
 
Ëngth
);

54 
boŞ
 
·r£AÎP¬ams
();

55 
ušt32_t
 
»adL’
();

57 
’dStdout
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

58 
’dReque¡
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

60 
C®lback
 
	gcb_
;

61 
boŞ
 
	ggÙReque¡_
;

62 
boŞ
 
	gk“pCÚn_
;

63 
	gmuduo
::
Ãt
::
Bufãr
 
¡dš_
;

64 
	gmuduo
::
Ãt
::
Bufãr
 
·¿msSŒ—m_
;

65 
P¬amM­
 
	g·¿ms_
;

67 cÚ¡ 
	gkRecÜdH—d”
;

	@examples/fastcgi/fastcgi_test.cc

1 
	~<exam¶es/ç¡cgi/ç¡cgi.h
>

2 
	~<exam¶es/sudoku/sudoku.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/TıS”v”.h
>

8 
	~<boo¡/bšd.hµ
>

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

12 cÚ¡ 
¡ršg
 
	gkP©h
 = "/sudoku/";

14 
ÚReque¡
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

15 
Fa¡CgiCodec
::
P¬amM­
& 
·¿ms
,

16 
Bufãr
* 
š
)

18 
¡ršg
 
	guri
 = 
·¿ms
["REQUEST_URI"];

19 
	gLOG_INFO
 << 
	gcÚn
->
Çme
(è<< ": " << 
	guri
;

21 
	gFa¡CgiCodec
::
P¬amM­
::
cÚ¡_™”©Ü
 
™
 = 
·¿ms
.
begš
();

22 
	g™
 !ğ
·¿ms
.
’d
(); ++it)

24 
	gLOG_DEBUG
 << 
	g™
->
	gfœ¡
 << " = " << it->
	g£cÚd
;

26 ià(
	gš
->
»adabËBy‹s
() > 0)

27 
	gLOG_DEBUG
 << "¡dš " << 
	gš
->
»Œ›veAÎAsSŒšg
();

28 
Bufãr
 
	g»¥Ú£
;

29 
	g»¥Ú£
.
­³nd
("Context-Type:ext/plain\r\n\r\n");

30 ià(
	guri
.
size
(è=ğ
kC–ls
 + 
kP©h
.size(è&& 
uri
.
fšd
(kPath) == 0)

32 
»¥Ú£
.
­³nd
(
sŞveSudoku
(
uri
.
sub¡r
(
kP©h
.
size
())));

37 
	g»¥Ú£
.
­³nd
("bad„equest");

40 
	gFa¡CgiCodec
::
»¥Úd
(&
»¥Ú£
);

41 
	gcÚn
->
£nd
(&
»¥Ú£
);

44 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

46 ià(
cÚn
->
	`cÚÃùed
())

48 
boo¡
::
	tsh¬ed_±r
<
	tFa¡CgiCodec
> 
	tCodecPŒ
;

49 
CodecPŒ
 
	`codec
(
Ãw
 
	`Fa¡CgiCodec
(
ÚReque¡
));

50 
cÚn
->
	`£tCÚ‹xt
(
codec
);

51 
cÚn
->
	`£tMes§geC®lback
(

52 
boo¡
::
	`bšd
(&
Fa¡CgiCodec
::
ÚMes§ge
, 
codec
, 
_1
, 
_2
, 
_3
));

53 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

55 
	}
}

57 
	$maš
(
¬gc
, * 
¬gv
[])

59 
pÜt
 = 19981;

60 
th»ads
 = 0;

61 ià(
¬gc
 > 1)

62 
pÜt
 = 
	`©oi
(
¬gv
[1]);

63 ià(
¬gc
 > 2)

64 
th»ads
 = 
	`©oi
(
¬gv
[2]);

65 
IÃtAdd»ss
 
	`addr
(
¡©ic_ÿ¡
<
ušt16_t
>(
pÜt
));

66 
LOG_INFO
 << "Sudoku Fa¡CGI†i¡’ Ú " << 
addr
.
	`toIpPÜt
()

67 << "h»ad " << 
th»ads
;

68 
muduo
::
Ãt
::
Ev’tLoİ
 
loİ
;

69 
TıS”v”
 
	`£rv”
(&
loİ
, 
addr
, "FastCGI");

70 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚCÚÃùiÚ
);

71 
£rv”
.
	`£tTh»adNum
(
th»ads
);

72 
£rv”
.
	`¡¬t
();

73 
loİ
.
	`loİ
();

74 
	}
}

	@examples/filetransfer/download.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/TıS”v”.h
>

5 
	~<¡dio.h
>

6 
	~<uni¡d.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 cÚ¡ * 
	gg_fe
 = 
NULL
;

14 
¡ršg
 
	$»adFe
(cÚ¡ * 
f’ame
)

16 
¡ršg
 
cÚ‹Á
;

17 
FILE
* 
å
 = ::
	`fİ’
(
f’ame
, "rb");

18 ià(
å
)

21 cÚ¡ 
kBufSize
 = 1024*1024;

22 
iobuf
[
kBufSize
];

23 ::
	`£tbufãr
(
å
, 
iobuf
,  iobuf);

25 
buf
[
kBufSize
];

26 
size_t
 
Ä—d
 = 0;

27  (
Ä—d
 = ::
	`ä—d
(
buf
, 1,  buf, 
å
)) > 0)

29 
cÚ‹Á
.
	`­³nd
(
buf
, 
Ä—d
);

31 ::
	`fşo£
(
å
);

33  
cÚ‹Á
;

34 
	}
}

36 
	$ÚHighW©”M¬k
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
size_t
 
Ën
)

38 
LOG_INFO
 << "HighW©”M¬k " << 
Ën
;

39 
	}
}

41 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

43 
LOG_INFO
 << "FeS”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

44 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

45 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

46 ià(
cÚn
->
	`cÚÃùed
())

48 
LOG_INFO
 << "FeS”v” - S’dšg f" << 
g_fe


49 << "Ø" << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
();

50 
cÚn
->
	`£tHighW©”M¬kC®lback
(
ÚHighW©”M¬k
, 64*1024);

51 
¡ršg
 
feCÚ‹Á
 = 
	`»adFe
(
g_fe
);

52 
cÚn
->
	`£nd
(
feCÚ‹Á
);

53 
cÚn
->
	`shutdown
();

54 
LOG_INFO
 << "FileServer - done";

56 
	}
}

58 
	$maš
(
¬gc
, * 
¬gv
[])

60 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

61 ià(
¬gc
 > 1)

63 
g_fe
 = 
¬gv
[1];

65 
Ev’tLoİ
 
loİ
;

66 
IÃtAdd»ss
 
	`li¡’Addr
(2021);

67 
TıS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, "FileServer");

68 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚCÚÃùiÚ
);

69 
£rv”
.
	`¡¬t
();

70 
loİ
.
	`loİ
();

74 
	`årštf
(
¡d”r
, "U§ge: % fe_fÜ_dowÆßdšg\n", 
¬gv
[0]);

76 
	}
}

	@examples/filetransfer/download2.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/TıS”v”.h
>

5 
	~<¡dio.h
>

6 
	~<uni¡d.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
	$ÚHighW©”M¬k
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
size_t
 
Ën
)

13 
LOG_INFO
 << "HighW©”M¬k " << 
Ën
;

14 
	}
}

16 cÚ¡ 
	gkBufSize
 = 64*1024;

17 cÚ¡ * 
	gg_fe
 = 
NULL
;

19 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

21 
LOG_INFO
 << "FeS”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

22 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

23 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

24 ià(
cÚn
->
	`cÚÃùed
())

26 
LOG_INFO
 << "FeS”v” - S’dšg f" << 
g_fe


27 << "Ø" << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
();

28 
cÚn
->
	`£tHighW©”M¬kC®lback
(
ÚHighW©”M¬k
, 
kBufSize
+1);

30 
FILE
* 
å
 = ::
	`fİ’
(
g_fe
, "rb");

31 ià(
å
)

33 
cÚn
->
	`£tCÚ‹xt
(
å
);

34 
buf
[
kBufSize
];

35 
size_t
 
Ä—d
 = ::
	`ä—d
(
buf
, 1,  buf, 
å
);

36 
cÚn
->
	`£nd
(
buf
, 
¡©ic_ÿ¡
<>(
Ä—d
));

40 
cÚn
->
	`shutdown
();

41 
LOG_INFO
 << "FileServer -‚o such file";

46 ià(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
())

48 
FILE
* 
å
 = 
boo¡
::
ªy_ÿ¡
<FILE*>(
cÚn
->
	`g‘CÚ‹xt
());

49 ià(
å
)

51 ::
	`fşo£
(
å
);

55 
	}
}

57 
	$ÚWr™eCom¶‘e
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

59 
FILE
* 
å
 = 
boo¡
::
ªy_ÿ¡
<FILE*>(
cÚn
->
	`g‘CÚ‹xt
());

60 
buf
[
kBufSize
];

61 
size_t
 
Ä—d
 = ::
	`ä—d
(
buf
, 1,  buf, 
å
);

62 ià(
Ä—d
 > 0)

64 
cÚn
->
	`£nd
(
buf
, 
¡©ic_ÿ¡
<>(
Ä—d
));

68 ::
	`fşo£
(
å
);

69 
å
 = 
NULL
;

70 
cÚn
->
	`£tCÚ‹xt
(
å
);

71 
cÚn
->
	`shutdown
();

72 
LOG_INFO
 << "FileServer - done";

74 
	}
}

76 
	$maš
(
¬gc
, * 
¬gv
[])

78 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

79 ià(
¬gc
 > 1)

81 
g_fe
 = 
¬gv
[1];

83 
Ev’tLoİ
 
loİ
;

84 
IÃtAdd»ss
 
	`li¡’Addr
(2021);

85 
TıS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, "FileServer");

86 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚCÚÃùiÚ
);

87 
£rv”
.
	`£tWr™eCom¶‘eC®lback
(
ÚWr™eCom¶‘e
);

88 
£rv”
.
	`¡¬t
();

89 
loİ
.
	`loİ
();

93 
	`årštf
(
¡d”r
, "U§ge: % fe_fÜ_dowÆßdšg\n", 
¬gv
[0]);

95 
	}
}

	@examples/filetransfer/download3.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/TıS”v”.h
>

5 
	~<boo¡/sh¬ed_±r.hµ
>

7 
	~<¡dio.h
>

8 
	~<uni¡d.h
>

10 
usšg
 
Çme¥aû
 
	gmuduo
;

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 
	$ÚHighW©”M¬k
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
size_t
 
Ën
)

15 
LOG_INFO
 << "HighW©”M¬k " << 
Ën
;

16 
	}
}

18 cÚ¡ 
	gkBufSize
 = 64*1024;

19 cÚ¡ * 
	gg_fe
 = 
NULL
;

20 
	gboo¡
::
	tsh¬ed_±r
<
	tFILE
> 
	tFePŒ
;

22 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

24 
LOG_INFO
 << "FeS”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

25 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

26 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

27 ià(
cÚn
->
	`cÚÃùed
())

29 
LOG_INFO
 << "FeS”v” - S’dšg f" << 
g_fe


30 << "Ø" << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
();

31 
cÚn
->
	`£tHighW©”M¬kC®lback
(
ÚHighW©”M¬k
, 
kBufSize
+1);

33 
FILE
* 
å
 = ::
	`fİ’
(
g_fe
, "rb");

34 ià(
å
)

36 
FePŒ
 
	`ùx
(
å
, ::
fşo£
);

37 
cÚn
->
	`£tCÚ‹xt
(
ùx
);

38 
buf
[
kBufSize
];

39 
size_t
 
Ä—d
 = ::
	`ä—d
(
buf
, 1,  buf, 
å
);

40 
cÚn
->
	`£nd
(
buf
, 
¡©ic_ÿ¡
<>(
Ä—d
));

44 
cÚn
->
	`shutdown
();

45 
LOG_INFO
 << "FileServer -‚o such file";

48 
	}
}

50 
	$ÚWr™eCom¶‘e
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

52 cÚ¡ 
FePŒ
& 
å
 = 
boo¡
::
ªy_ÿ¡
<cÚ¡ FePŒ&>(
cÚn
->
	`g‘CÚ‹xt
());

53 
buf
[
kBufSize
];

54 
size_t
 
Ä—d
 = ::
	`ä—d
(
buf
, 1,  buf, 
	`g‘_poš‹r
(
å
));

55 ià(
Ä—d
 > 0)

57 
cÚn
->
	`£nd
(
buf
, 
¡©ic_ÿ¡
<>(
Ä—d
));

61 
cÚn
->
	`shutdown
();

62 
LOG_INFO
 << "FileServer - done";

64 
	}
}

66 
	$maš
(
¬gc
, * 
¬gv
[])

68 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

69 ià(
¬gc
 > 1)

71 
g_fe
 = 
¬gv
[1];

73 
Ev’tLoİ
 
loİ
;

74 
IÃtAdd»ss
 
	`li¡’Addr
(2021);

75 
TıS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, "FileServer");

76 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚCÚÃùiÚ
);

77 
£rv”
.
	`£tWr™eCom¶‘eC®lback
(
ÚWr™eCom¶‘e
);

78 
£rv”
.
	`¡¬t
();

79 
loİ
.
	`loİ
();

83 
	`årštf
(
¡d”r
, "U§ge: % fe_fÜ_dowÆßdšg\n", 
¬gv
[0]);

85 
	}
}

	@examples/hub/codec.cc

1 
	~"codec.h
"

3 
usšg
 
Çme¥aû
 
	gmuduo
;

4 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

5 
usšg
 
Çme¥aû
 
	gpubsub
;

7 
P¬£ResuÉ
 
	gpubsub
::
	$·r£Mes§ge
(
Bufãr
* 
buf
,

8 
¡ršg
* 
cmd
,

9 
¡ršg
* 
tİic
,

10 
¡ršg
* 
cÚ‹Á
)

12 
P¬£ResuÉ
 
»suÉ
 = 
kE¼Ü
;

13 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

14 ià(
ülf
)

16 cÚ¡ * 
¥aû
 = 
¡d
::
	`fšd
(
buf
->
	`³ek
(), 
ülf
, ' ');

17 ià(
¥aû
 !ğ
ülf
)

19 
cmd
->
	`assign
(
buf
->
	`³ek
(), 
¥aû
);

20 
tİic
->
	`assign
(
¥aû
+1, 
ülf
);

21 ià(*
cmd
 == "pub")

23 cÚ¡ * 
¡¬t
 = 
ülf
 + 2;

24 
ülf
 = 
buf
->
	`fšdCRLF
(
¡¬t
);

25 ià(
ülf
)

27 
cÚ‹Á
->
	`assign
(
¡¬t
, 
ülf
);

28 
buf
->
	`»Œ›veUÁ
(
ülf
+2);

29 
»suÉ
 = 
kSucûss
;

33 
»suÉ
 = 
kCÚtšue
;

38 
buf
->
	`»Œ›veUÁ
(
ülf
+2);

39 
»suÉ
 = 
kSucûss
;

44 
»suÉ
 = 
kE¼Ü
;

49 
»suÉ
 = 
kCÚtšue
;

51  
»suÉ
;

52 
	}
}

	@examples/hub/codec.h

1 #iâdeà
MUDUO_EXAMPLES_HUB_CODEC_H


2 
	#MUDUO_EXAMPLES_HUB_CODEC_H


	)

6 
	~<muduo/ba£/Ty³s.h
>

7 
	~<muduo/Ãt/Bufãr.h
>

9 
	~<boo¡/nÚcİyabË.hµ
>

11 
Çme¥aû
 
	gpubsub


13 
usšg
 
	gmuduo
::
¡ršg
;

15 
	eP¬£ResuÉ


17 
	gkE¼Ü
,

18 
	gkSucûss
,

19 
	gkCÚtšue
,

22 
P¬£ResuÉ
 
·r£Mes§ge
(
muduo
::
Ãt
::
Bufãr
* 
buf
,

23 
¡ršg
* 
cmd
,

24 
¡ršg
* 
tİic
,

25 
¡ršg
* 
cÚ‹Á
);

	@examples/hub/codec.h

1 #iâdeà
MUDUO_EXAMPLES_HUB_CODEC_H


2 
	#MUDUO_EXAMPLES_HUB_CODEC_H


	)

6 
	~<muduo/ba£/Ty³s.h
>

7 
	~<muduo/Ãt/Bufãr.h
>

9 
	~<boo¡/nÚcİyabË.hµ
>

11 
Çme¥aû
 
	gpubsub


13 
usšg
 
	gmuduo
::
¡ršg
;

15 
	eP¬£ResuÉ


17 
	gkE¼Ü
,

18 
	gkSucûss
,

19 
	gkCÚtšue
,

22 
P¬£ResuÉ
 
·r£Mes§ge
(
muduo
::
Ãt
::
Bufãr
* 
buf
,

23 
¡ršg
* 
cmd
,

24 
¡ršg
* 
tİic
,

25 
¡ršg
* 
cÚ‹Á
);

	@examples/hub/hub.cc

1 
	~"codec.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/TıS”v”.h
>

7 
	~<boo¡/bšd.hµ
>

9 
	~<m­
>

10 
	~<£t
>

11 
	~<¡dio.h
>

13 
usšg
 
Çme¥aû
 
	gmuduo
;

14 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

16 
Çme¥aû
 
	gpubsub


19 
	g¡d
::
	t£t
<
	t¡ršg
> 
	tCÚÃùiÚSubsütiÚ
;

21 şas 
	cTİic
 : 
public
 
muduo
::
cİyabË


23 
public
:

24 
Tİic
(cÚ¡ 
¡ršg
& 
tİic
)

25 : 
tİic_
(
tİic
)

29 
add
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

31 
aud›nûs_
.
š£¹
(
cÚn
);

32 ià(
	gÏ¡PubTime_
.
v®id
())

34 
	gcÚn
->
£nd
(
makeMes§ge
());

38 
»move
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

40 
	gaud›nûs_
.
”a£
(
cÚn
);

43 
publish
(cÚ¡ 
¡ršg
& 
cÚ‹Á
, 
Time¡amp
 
time
)

45 
	gcÚ‹Á_
 = 
cÚ‹Á
;

46 
	gÏ¡PubTime_
 = 
time
;

47 
¡ršg
 
	gmes§ge
 = 
makeMes§ge
();

48 
	g¡d
::
£t
<
TıCÚÃùiÚPŒ
>::
™”©Ü
 
™
 = 
aud›nûs_
.
begš
();

49 
	g™
 !ğ
aud›nûs_
.
’d
();

50 ++
	g™
)

52 (*
	g™
)->
£nd
(
mes§ge
);

56 
	g´iv©e
:

58 
¡ršg
 
makeMes§ge
()

60  "pub " + 
tİic_
 + "\r\n" + 
cÚ‹Á_
 + "\r\n";

63 
¡ršg
 
	gtİic_
;

64 
¡ršg
 
	gcÚ‹Á_
;

65 
Time¡amp
 
	gÏ¡PubTime_
;

66 
	g¡d
::
£t
<
TıCÚÃùiÚPŒ
> 
aud›nûs_
;

69 şas 
	cPubSubS”v”
 : 
boo¡
::
nÚcİyabË


71 
public
:

72 
PubSubS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

73 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
)

74 : 
loİ_
(
loİ
),

75 
£rv”_
(
loİ
, 
li¡’Addr
, "PubSubServer")

77 
	g£rv”_
.
£tCÚÃùiÚC®lback
(

78 
boo¡
::
bšd
(&
PubSubS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

79 
	g£rv”_
.
£tMes§geC®lback
(

80 
boo¡
::
bšd
(&
PubSubS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

81 
	gloİ_
->
runEv”y
(1.0, 
boo¡
::
bšd
(&
PubSubS”v”
::
timePublish
, 
this
));

84 
¡¬t
()

86 
	g£rv”_
.
¡¬t
();

89 
	g´iv©e
:

90 
ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

92 ià(
cÚn
->
cÚÃùed
())

94 
cÚn
->
£tCÚ‹xt
(
CÚÃùiÚSubsütiÚ
());

98 cÚ¡ 
	gCÚÃùiÚSubsütiÚ
& 
	gcÚnSub


99 ğ
boo¡
::
ªy_ÿ¡
<cÚ¡ 
CÚÃùiÚSubsütiÚ
&>(
cÚn
->
g‘CÚ‹xt
());

101 
	gCÚÃùiÚSubsütiÚ
::
cÚ¡_™”©Ü
 
™
 = 
cÚnSub
.
begš
();

102 
	g™
 !ğ
cÚnSub
.
’d
();)

104 
doUnsubsüibe
(
cÚn
, *
™
++);

109 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

110 
Bufãr
* 
buf
,

111 
Time¡amp
 
»ûiveTime
)

113 
P¬£ResuÉ
 
	g»suÉ
 = 
kSucûss
;

114 
	g»suÉ
 =ğ
kSucûss
)

116 
¡ršg
 
cmd
;

117 
¡ršg
 
	gtİic
;

118 
¡ršg
 
	gcÚ‹Á
;

119 
	g»suÉ
 = 
·r£Mes§ge
(
buf
, &
cmd
, &
tİic
, &
cÚ‹Á
);

120 ià(
	g»suÉ
 =ğ
kSucûss
)

122 ià(
cmd
 == "pub")

124 
doPublish
(
cÚn
->
Çme
(), 
tİic
, 
cÚ‹Á
, 
»ûiveTime
);

126 ià(
	gcmd
 == "sub")

128 
LOG_INFO
 << 
cÚn
->
Çme
(è<< " subsüibe " << 
tİic
;

129 
doSubsüibe
(
cÚn
, 
tİic
);

131 ià(
	gcmd
 == "unsub")

133 
doUnsubsüibe
(
cÚn
, 
tİic
);

137 
	gcÚn
->
shutdown
();

138 
	g»suÉ
 = 
kE¼Ü
;

141 ià(
	g»suÉ
 =ğ
kE¼Ü
)

143 
cÚn
->
shutdown
();

148 
timePublish
()

150 
Time¡amp
 
	gnow
 = Time¡amp::
now
();

151 
doPublish
("š‹º®", "utc_time", 
now
.
toFÜm©‹dSŒšg
(),‚ow);

154 
doSubsüibe
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

155 cÚ¡ 
¡ršg
& 
tİic
)

157 
CÚÃùiÚSubsütiÚ
* 
	gcÚnSub


158 ğ
boo¡
::
ªy_ÿ¡
<
CÚÃùiÚSubsütiÚ
>(
cÚn
->
g‘MubËCÚ‹xt
());

160 
	gcÚnSub
->
š£¹
(
tİic
);

161 
g‘Tİic
(
tİic
).
add
(
cÚn
);

164 
doUnsubsüibe
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

165 cÚ¡ 
¡ršg
& 
tİic
)

167 
	gLOG_INFO
 << 
	gcÚn
->
Çme
(è<< " unsubsüibe " << 
	gtİic
;

168 
g‘Tİic
(
tİic
).
»move
(
cÚn
);

170 
CÚÃùiÚSubsütiÚ
* 
	gcÚnSub


171 ğ
boo¡
::
ªy_ÿ¡
<
CÚÃùiÚSubsütiÚ
>(
cÚn
->
g‘MubËCÚ‹xt
());

172 
	gcÚnSub
->
”a£
(
tİic
);

175 
doPublish
(cÚ¡ 
¡ršg
& 
sourû
,

176 cÚ¡ 
¡ršg
& 
tİic
,

177 cÚ¡ 
¡ršg
& 
cÚ‹Á
,

178 
Time¡amp
 
time
)

180 
g‘Tİic
(
tİic
).
publish
(
cÚ‹Á
, 
time
);

183 
	gTİic
& 
g‘Tİic
(cÚ¡ 
¡ršg
& 
tİic
)

185 
	g¡d
::
m­
<
¡ršg
, 
	gTİic
>::
™”©Ü
 
™
 = 
tİics_
.
fšd
(
tİic
);

186 ià(
	g™
 =ğ
tİics_
.
’d
())

188 
™
 = 
tİics_
.
š£¹
(
make_·œ
(
tİic
, 
Tİic
Ñİic))).
	gfœ¡
;

190  
	g™
->
	g£cÚd
;

193 
Ev’tLoİ
* 
	gloİ_
;

194 
TıS”v”
 
	g£rv”_
;

195 
	g¡d
::
m­
<
¡ršg
, 
	gTİic
> 
	gtİics_
;

200 
	$maš
(
¬gc
, * 
¬gv
[])

202 ià(
¬gc
 > 1)

204 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

205 
Ev’tLoİ
 
loİ
;

206 ià(
¬gc
 > 2)

210 
pubsub
::
PubSubS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(
pÜt
));

211 
£rv”
.
	`¡¬t
();

212 
loİ
.
	`loİ
();

216 
	`´štf
("U§ge: % pubsub_pÜˆ[š¥eù_pÜt]\n", 
¬gv
[0]);

218 
	}
}

	@examples/hub/pub.cc

1 
	~"pubsub.h
"

2 
	~<muduo/ba£/ProûssInfo.h
>

3 
	~<muduo/Ãt/Ev’tLoİ.h
>

4 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

6 
	~<io¡»am
>

7 
	~<¡dio.h
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
usšg
 
Çme¥aû
 
	gpubsub
;

13 
Ev’tLoİ
* 
	gg_loİ
 = 
NULL
;

14 
¡ršg
 
	gg_tİic
;

15 
¡ršg
 
	gg_cÚ‹Á
;

17 
	$cÚÃùiÚ
(
PubSubCl›Á
* 
ş›Á
)

19 ià(
ş›Á
->
	`cÚÃùed
())

21 
ş›Á
->
	`publish
(
g_tİic
, 
g_cÚ‹Á
);

22 
ş›Á
->
	`¡İ
();

26 
g_loİ
->
	`qu™
();

28 
	}
}

30 
	$maš
(
¬gc
, * 
¬gv
[])

32 ià(
¬gc
 == 4)

34 
¡ršg
 
ho¡pÜt
 = 
¬gv
[1];

35 
size_t
 
cŞÚ
 = 
ho¡pÜt
.
	`fšd
(':');

36 ià(
cŞÚ
 !ğ
¡ršg
::
Åos
)

38 
¡ršg
 
ho¡
 = 
ho¡pÜt
.
	`sub¡r
(0, 
cŞÚ
);

39 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
ho¡pÜt
.
	`c_¡r
()+
cŞÚ
+1));

40 
g_tİic
 = 
¬gv
[2];

41 
g_cÚ‹Á
 = 
¬gv
[3];

43 
¡ršg
 
Çme
 = 
ProûssInfo
::
	`u£ºame
()+"@"+ProûssInfo::
	`ho¡Çme
();

44 
Çme
 +ğ":" + 
ProûssInfo
::
	`pidSŒšg
();

46 ià(
g_cÚ‹Á
 == "-")

48 
Ev’tLoİTh»ad
 
loİTh»ad
;

49 
g_loİ
 = 
loİTh»ad
.
	`¡¬tLoİ
();

50 
PubSubCl›Á
 
	`ş›Á
(
g_loİ
, 
	`IÃtAdd»ss
(
ho¡
, 
pÜt
), 
Çme
);

51 
ş›Á
.
	`¡¬t
();

53 
¡ršg
 
lše
;

54 
	`g‘lše
(
¡d
::
cš
, 
lše
))

56 
ş›Á
.
	`publish
(
g_tİic
, 
lše
);

58 
ş›Á
.
	`¡İ
();

59 
Cu¼’tTh»ad
::
	`¦“pU£c
(1000*1000);

63 
Ev’tLoİ
 
loİ
;

64 
g_loİ
 = &
loİ
;

65 
PubSubCl›Á
 
	`ş›Á
(
g_loİ
, 
	`IÃtAdd»ss
(
ho¡
, 
pÜt
), 
Çme
);

66 
ş›Á
.
	`£tCÚÃùiÚC®lback
(
cÚÃùiÚ
);

67 
ş›Á
.
	`¡¬t
();

68 
loİ
.
	`loİ
();

73 
	`´štf
("U§ge: % hub_:pÜˆtİiøcÚ‹Á\n", 
¬gv
[0]);

78 
	`´štf
("Usage: %s hub_ip:portopic content\n"

80 " % hub_:pÜˆtİiø-\n", 
¬gv
[0],‡rgv[0]);

82 
	}
}

	@examples/hub/pubsub.cc

1 
	~"pubsub.h
"

2 
	~"codec.h
"

4 
	~<boo¡/bšd.hµ
>

6 
usšg
 
Çme¥aû
 
	gmuduo
;

7 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

8 
usšg
 
Çme¥aû
 
	gpubsub
;

10 
	gPubSubCl›Á
::
	$PubSubCl›Á
(
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
IÃtAdd»ss
& 
hubAddr
,

12 cÚ¡ 
¡ršg
& 
Çme
)

13 : 
	$ş›Á_
(
loİ
, 
hubAddr
, 
Çme
)

16 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

17 
boo¡
::
	`bšd
(&
PubSubCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

18 
ş›Á_
.
	`£tMes§geC®lback
(

19 
boo¡
::
	`bšd
(&
PubSubCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

20 
	}
}

22 
	gPubSubCl›Á
::
	$¡¬t
()

24 
ş›Á_
.
	`cÚÃù
();

25 
	}
}

27 
	gPubSubCl›Á
::
	$¡İ
()

29 
ş›Á_
.
	`discÚÃù
();

30 
	}
}

32 
boŞ
 
	gPubSubCl›Á
::
	$cÚÃùed
() const

34  
cÚn_
 && cÚn_->
	`cÚÃùed
();

35 
	}
}

37 
boŞ
 
	gPubSubCl›Á
::
	$subsüibe
(cÚ¡ 
¡ršg
& 
tİic
, cÚ¡ 
SubsüibeC®lback
& 
cb
)

39 
¡ršg
 
mes§ge
 = "sub " + 
tİic
 + "\r\n";

40 
subsüibeC®lback_
 = 
cb
;

41  
	`£nd
(
mes§ge
);

42 
	}
}

44 
	gPubSubCl›Á
::
	$unsubsüibe
(cÚ¡ 
¡ršg
& 
tİic
)

46 
¡ršg
 
mes§ge
 = "unsub " + 
tİic
 + "\r\n";

47 
	`£nd
(
mes§ge
);

48 
	}
}

51 
boŞ
 
	gPubSubCl›Á
::
	$publish
(cÚ¡ 
¡ršg
& 
tİic
, cÚ¡ sŒšg& 
cÚ‹Á
)

53 
¡ršg
 
mes§ge
 = "pub " + 
tİic
 + "\r\n" + 
cÚ‹Á
 + "\r\n";

54  
	`£nd
(
mes§ge
);

55 
	}
}

57 
	gPubSubCl›Á
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

59 ià(
cÚn
->
	`cÚÃùed
())

61 
cÚn_
 = 
cÚn
;

66 
cÚn_
.
	`»£t
();

68 ià(
cÚÃùiÚC®lback_
)

70 
	`cÚÃùiÚC®lback_
(
this
);

72 
	}
}

74 
	gPubSubCl›Á
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

75 
Bufãr
* 
buf
,

76 
Time¡amp
 
»ûiveTime
)

78 
P¬£ResuÉ
 
»suÉ
 = 
kSucûss
;

79 
»suÉ
 =ğ
kSucûss
)

81 
¡ršg
 
cmd
;

82 
¡ršg
 
tİic
;

83 
¡ršg
 
cÚ‹Á
;

84 
»suÉ
 = 
	`·r£Mes§ge
(
buf
, &
cmd
, &
tİic
, &
cÚ‹Á
);

85 ià(
»suÉ
 =ğ
kSucûss
)

87 ià(
cmd
 =ğ"pub" && 
subsüibeC®lback_
)

89 
	`subsüibeC®lback_
(
tİic
, 
cÚ‹Á
, 
»ûiveTime
);

92 ià(
»suÉ
 =ğ
kE¼Ü
)

94 
cÚn
->
	`shutdown
();

97 
	}
}

99 
boŞ
 
	gPubSubCl›Á
::
	$£nd
(cÚ¡ 
¡ršg
& 
mes§ge
)

101 
boŞ
 
sucûed
 = 
çl£
;

102 ià(
cÚn_
 && cÚn_->
	`cÚÃùed
())

104 
cÚn_
->
	`£nd
(
mes§ge
);

105 
sucûed
 = 
Œue
;

107  
sucûed
;

108 
	}
}

	@examples/hub/pubsub.h

1 #iâdeà
MUDUO_EXAMPLES_HUB_PUBSUB_H


2 
	#MUDUO_EXAMPLES_HUB_PUBSUB_H


	)

4 
	~<muduo/Ãt/TıCl›Á.h
>

6 
Çme¥aû
 
	gpubsub


8 
usšg
 
	gmuduo
::
¡ršg
;

9 
usšg
 
	gmuduo
::
Time¡amp
;

12 şas 
	cPubSubCl›Á
 : 
boo¡
::
nÚcİyabË


14 
public
:

15 
boo¡
::
	tfunùiÚ
<(
	tPubSubCl›Á
*)> 
	tCÚÃùiÚC®lback
;

16 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	t¡ršg
& 
	ttİic
,

17 cÚ¡ 
	t¡ršg
& 
	tcÚ‹Á
,

18 
	tTime¡amp
)> 
	tSubsüibeC®lback
;

20 
PubSubCl›Á
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

21 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
hubAddr
,

22 cÚ¡ 
¡ršg
& 
Çme
);

23 
¡¬t
();

24 
¡İ
();

25 
boŞ
 
cÚÃùed
() const;

27 
£tCÚÃùiÚC®lback
(cÚ¡ 
CÚÃùiÚC®lback
& 
cb
)

28 { 
	gcÚÃùiÚC®lback_
 = 
cb
; }

30 
boŞ
 
subsüibe
(cÚ¡ 
¡ršg
& 
tİic
, cÚ¡ 
SubsüibeC®lback
& 
cb
);

31 
unsubsüibe
(cÚ¡ 
¡ršg
& 
tİic
);

32 
boŞ
 
publish
(cÚ¡ 
¡ršg
& 
tİic
, cÚ¡ sŒšg& 
cÚ‹Á
);

34 
	g´iv©e
:

35 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

36 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

37 
muduo
::
Ãt
::
Bufãr
* 
buf
,

38 
muduo
::
Time¡amp
 
»ûiveTime
);

39 
boŞ
 
£nd
(cÚ¡ 
¡ršg
& 
mes§ge
);

41 
	gmuduo
::
Ãt
::
TıCl›Á
 
ş›Á_
;

42 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn_
;

43 
CÚÃùiÚC®lback
 
	gcÚÃùiÚC®lback_
;

44 
SubsüibeC®lback
 
	gsubsüibeC®lback_
;

	@examples/hub/pubsub.h

1 #iâdeà
MUDUO_EXAMPLES_HUB_PUBSUB_H


2 
	#MUDUO_EXAMPLES_HUB_PUBSUB_H


	)

4 
	~<muduo/Ãt/TıCl›Á.h
>

6 
Çme¥aû
 
	gpubsub


8 
usšg
 
	gmuduo
::
¡ršg
;

9 
usšg
 
	gmuduo
::
Time¡amp
;

12 şas 
	cPubSubCl›Á
 : 
boo¡
::
nÚcİyabË


14 
public
:

15 
boo¡
::
	tfunùiÚ
<(
	tPubSubCl›Á
*)> 
	tCÚÃùiÚC®lback
;

16 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	t¡ršg
& 
	ttİic
,

17 cÚ¡ 
	t¡ršg
& 
	tcÚ‹Á
,

18 
	tTime¡amp
)> 
	tSubsüibeC®lback
;

20 
PubSubCl›Á
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

21 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
hubAddr
,

22 cÚ¡ 
¡ršg
& 
Çme
);

23 
¡¬t
();

24 
¡İ
();

25 
boŞ
 
cÚÃùed
() const;

27 
£tCÚÃùiÚC®lback
(cÚ¡ 
CÚÃùiÚC®lback
& 
cb
)

28 { 
	gcÚÃùiÚC®lback_
 = 
cb
; }

30 
boŞ
 
subsüibe
(cÚ¡ 
¡ršg
& 
tİic
, cÚ¡ 
SubsüibeC®lback
& 
cb
);

31 
unsubsüibe
(cÚ¡ 
¡ršg
& 
tİic
);

32 
boŞ
 
publish
(cÚ¡ 
¡ršg
& 
tİic
, cÚ¡ sŒšg& 
cÚ‹Á
);

34 
	g´iv©e
:

35 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

36 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

37 
muduo
::
Ãt
::
Bufãr
* 
buf
,

38 
muduo
::
Time¡amp
 
»ûiveTime
);

39 
boŞ
 
£nd
(cÚ¡ 
¡ršg
& 
mes§ge
);

41 
	gmuduo
::
Ãt
::
TıCl›Á
 
ş›Á_
;

42 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn_
;

43 
CÚÃùiÚC®lback
 
	gcÚÃùiÚC®lback_
;

44 
SubsüibeC®lback
 
	gsubsüibeC®lback_
;

	@examples/hub/sub.cc

1 
	~"pubsub.h
"

2 
	~<muduo/ba£/ProûssInfo.h
>

3 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<boo¡/bšd.hµ
>

6 
	~<veùÜ
>

7 
	~<¡dio.h
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
usšg
 
Çme¥aû
 
	gpubsub
;

13 
Ev’tLoİ
* 
	gg_loİ
 = 
NULL
;

14 
	g¡d
::
veùÜ
<
¡ršg
> 
g_tİics
;

16 
	$subsütiÚ
(cÚ¡ 
¡ršg
& 
tİic
, cÚ¡ sŒšg& 
cÚ‹Á
, 
Time¡amp
)

18 
	`´štf
("%s: %s\n", 
tİic
.
	`c_¡r
(), 
cÚ‹Á
.c_str());

19 
	}
}

21 
	$cÚÃùiÚ
(
PubSubCl›Á
* 
ş›Á
)

23 ià(
ş›Á
->
	`cÚÃùed
())

25 
¡d
::
veùÜ
<
¡ršg
>::
™”©Ü
 
™
 = 
g_tİics
.
	`begš
();

26 
™
 !ğ
g_tİics
.
	`’d
(); ++it)

28 
ş›Á
->
	`subsüibe
(*
™
, 
subsütiÚ
);

33 
g_loİ
->
	`qu™
();

35 
	}
}

37 
	$maš
(
¬gc
, * 
¬gv
[])

39 ià(
¬gc
 > 2)

41 
¡ršg
 
ho¡pÜt
 = 
¬gv
[1];

42 
size_t
 
cŞÚ
 = 
ho¡pÜt
.
	`fšd
(':');

43 ià(
cŞÚ
 !ğ
¡ršg
::
Åos
)

45 
¡ršg
 
ho¡
 = 
ho¡pÜt
.
	`sub¡r
(0, 
cŞÚ
);

46 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
ho¡pÜt
.
	`c_¡r
()+
cŞÚ
+1));

47 
i
 = 2; i < 
¬gc
; ++i)

49 
g_tİics
.
	`push_back
(
¬gv
[
i
]);

52 
Ev’tLoİ
 
loİ
;

53 
g_loİ
 = &
loİ
;

54 
¡ršg
 
Çme
 = 
ProûssInfo
::
	`u£ºame
()+"@"+ProûssInfo::
	`ho¡Çme
();

55 
Çme
 +ğ":" + 
ProûssInfo
::
	`pidSŒšg
();

56 
PubSubCl›Á
 
	`ş›Á
(&
loİ
, 
	`IÃtAdd»ss
(
ho¡
, 
pÜt
), 
Çme
);

57 
ş›Á
.
	`£tCÚÃùiÚC®lback
(
cÚÃùiÚ
);

58 
ş›Á
.
	`¡¬t
();

59 
loİ
.
	`loİ
();

63 
	`´štf
("U§ge: % hub_:pÜˆtİiø[tİiø...]\n", 
¬gv
[0]);

68 
	`´štf
("U§ge: % hub_:pÜˆtİiø[tİiø...]\n", 
¬gv
[0]);

70 
	}
}

	@examples/idleconnection/echo.cc

1 
	~"echo.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<boo¡/bšd.hµ
>

8 
	~<as£¹.h
>

9 
	~<¡dio.h
>

11 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

15 
	gEchoS”v”
::
	$EchoS”v”
(
Ev’tLoİ
* 
loİ
,

16 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

17 
idËSecÚds
)

18 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "EchoServer"),

19 
	$cÚÃùiÚBuck‘s_
(
idËSecÚds
)

21 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

22 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

23 
£rv”_
.
	`£tMes§geC®lback
(

24 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

25 
loİ
->
	`runEv”y
(1.0, 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚTim”
, 
this
));

26 
cÚÃùiÚBuck‘s_
.
	`»size
(
idËSecÚds
);

27 
	`dumpCÚÃùiÚBuck‘s
();

28 
	}
}

30 
	gEchoS”v”
::
	$¡¬t
()

32 
£rv”_
.
	`¡¬t
();

33 
	}
}

35 
	gEchoS”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

37 
LOG_INFO
 << "EchoS”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

38 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

39 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

41 ià(
cÚn
->
	`cÚÃùed
())

43 
EÁryPŒ
 
	`’Œy
(
Ãw
 
	`EÁry
(
cÚn
));

44 
cÚÃùiÚBuck‘s_
.
	`back
().
	`š£¹
(
’Œy
);

45 
	`dumpCÚÃùiÚBuck‘s
();

46 
W—kEÁryPŒ
 
	`w—kEÁry
(
’Œy
);

47 
cÚn
->
	`£tCÚ‹xt
(
w—kEÁry
);

51 
	`as£¹
(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
());

52 
W—kEÁryPŒ
 
	`w—kEÁry
(
boo¡
::
ªy_ÿ¡
<W—kEÁryPŒ>(
cÚn
->
	`g‘CÚ‹xt
()));

53 
LOG_DEBUG
 << "EÁry u£_couÁ = " << 
w—kEÁry
.
	`u£_couÁ
();

55 
	}
}

57 
	gEchoS”v”
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

58 
Bufãr
* 
buf
,

59 
Time¡amp
 
time
)

61 
¡ršg
 
	`msg
(
buf
->
	`»Œ›veAÎAsSŒšg
());

62 
LOG_INFO
 << 
cÚn
->
	`Çme
(è<< "ƒchØ" << 
msg
.
	`size
()

63 << " by‹ © " << 
time
.
	`toSŒšg
();

64 
cÚn
->
	`£nd
(
msg
);

66 
	`as£¹
(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
());

67 
W—kEÁryPŒ
 
	`w—kEÁry
(
boo¡
::
ªy_ÿ¡
<W—kEÁryPŒ>(
cÚn
->
	`g‘CÚ‹xt
()));

68 
EÁryPŒ
 
	`’Œy
(
w—kEÁry
.
	`lock
());

69 ià(
’Œy
)

71 
cÚÃùiÚBuck‘s_
.
	`back
().
	`š£¹
(
’Œy
);

72 
	`dumpCÚÃùiÚBuck‘s
();

74 
	}
}

76 
	gEchoS”v”
::
	$ÚTim”
()

78 
cÚÃùiÚBuck‘s_
.
	`push_back
(
	`Buck‘
());

79 
	`dumpCÚÃùiÚBuck‘s
();

80 
	}
}

82 
	gEchoS”v”
::
	$dumpCÚÃùiÚBuck‘s
() const

84 
LOG_INFO
 << "sizğ" << 
cÚÃùiÚBuck‘s_
.
	`size
();

85 
idx
 = 0;

86 
W—kCÚÃùiÚLi¡
::
cÚ¡_™”©Ü
 
buck‘I
 = 
cÚÃùiÚBuck‘s_
.
	`begš
();

87 
buck‘I
 !ğ
cÚÃùiÚBuck‘s_
.
	`’d
();

88 ++
buck‘I
, ++
idx
)

90 cÚ¡ 
Buck‘
& 
buck‘
 = *
buck‘I
;

91 
	`´štf
("[%d]†’ = %zd : ", 
idx
, 
buck‘
.
	`size
());

92 
Buck‘
::
cÚ¡_™”©Ü
 
™
 = 
buck‘
.
	`begš
();

93 
™
 !ğ
buck‘
.
	`’d
();

94 ++
™
)

96 
boŞ
 
cÚÃùiÚD—d
 = (*
™
)->
w—kCÚn_
.
	`expœed
();

97 
	`´štf
("%p(%ld)%s, ", 
	`g‘_poš‹r
(*
™
), it->
	`u£_couÁ
(),

98 
cÚÃùiÚD—d
 ? " DEAD" : "");

100 
	`puts
("");

102 
	}
}

	@examples/idleconnection/echo.h

1 #iâdeà
MUDUO_EXAMPLES_IDLECONNECTION_ECHO_H


2 
	#MUDUO_EXAMPLES_IDLECONNECTION_ECHO_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 
	~<boo¡/cœcuÏr_bufãr.hµ
>

8 
	~<boo¡/unÜd”ed_£t.hµ
>

9 
	~<boo¡/v”siÚ.hµ
>

11 #ià
BOOST_VERSION
 < 104700

12 
Çme¥aû
 
	gboo¡


14 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

15 
šlše
 
size_t
 
hash_v®ue
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
T
>& 
x
)

17  
boo¡
::
hash_v®ue
(
x
.
g‘
());

23 şas 
	cEchoS”v”


25 
	mpublic
:

26 
EchoS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

27 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
,

28 
idËSecÚds
);

30 
¡¬t
();

32 
	m´iv©e
:

33 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

35 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

36 
muduo
::
Ãt
::
Bufãr
* 
buf
,

37 
muduo
::
Time¡amp
 
time
);

39 
ÚTim”
();

41 
	$dumpCÚÃùiÚBuck‘s
() const;

43 
boo¡
::
	tw—k_±r
<
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚ
> 
	tW—kTıCÚÃùiÚPŒ
;

45 
EÁry
 : 
public
 
muduo
::
cİyabË


47 
ex¶ic™
 
	`EÁry
(cÚ¡ 
W—kTıCÚÃùiÚPŒ
& 
w—kCÚn
)

48 : 
	`w—kCÚn_
(
w—kCÚn
)

52 ~
	`EÁry
()

54 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn
 = 
w—kCÚn_
.
	`lock
();

55 ià(
cÚn
)

57 
cÚn
->
	`shutdown
();

61 
W—kTıCÚÃùiÚPŒ
 
w—kCÚn_
;

63 
boo¡
::
	tsh¬ed_±r
<
	tEÁry
> 
	tEÁryPŒ
;

64 
boo¡
::
	tw—k_±r
<
	tEÁry
> 
	tW—kEÁryPŒ
;

65 
boo¡
::
	tunÜd”ed_£t
<
	tEÁryPŒ
> 
	tBuck‘
;

66 
boo¡
::
	tcœcuÏr_bufãr
<
	tBuck‘
> 
	tW—kCÚÃùiÚLi¡
;

68 
muduo
::
Ãt
::
TıS”v”
 
£rv”_
;

69 
W—kCÚÃùiÚLi¡
 
cÚÃùiÚBuck‘s_
;

70 
	}
};

	@examples/idleconnection/echo.h

1 #iâdeà
MUDUO_EXAMPLES_IDLECONNECTION_ECHO_H


2 
	#MUDUO_EXAMPLES_IDLECONNECTION_ECHO_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 
	~<boo¡/cœcuÏr_bufãr.hµ
>

8 
	~<boo¡/unÜd”ed_£t.hµ
>

9 
	~<boo¡/v”siÚ.hµ
>

11 #ià
BOOST_VERSION
 < 104700

12 
Çme¥aû
 
	gboo¡


14 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

15 
šlše
 
size_t
 
hash_v®ue
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
T
>& 
x
)

17  
boo¡
::
hash_v®ue
(
x
.
g‘
());

23 şas 
	cEchoS”v”


25 
	mpublic
:

26 
EchoS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

27 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
,

28 
idËSecÚds
);

30 
¡¬t
();

32 
	m´iv©e
:

33 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

35 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

36 
muduo
::
Ãt
::
Bufãr
* 
buf
,

37 
muduo
::
Time¡amp
 
time
);

39 
ÚTim”
();

41 
	$dumpCÚÃùiÚBuck‘s
() const;

43 
boo¡
::
	tw—k_±r
<
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚ
> 
	tW—kTıCÚÃùiÚPŒ
;

45 
EÁry
 : 
public
 
muduo
::
cİyabË


47 
ex¶ic™
 
	`EÁry
(cÚ¡ 
W—kTıCÚÃùiÚPŒ
& 
w—kCÚn
)

48 : 
	`w—kCÚn_
(
w—kCÚn
)

52 ~
	`EÁry
()

54 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn
 = 
w—kCÚn_
.
	`lock
();

55 ià(
cÚn
)

57 
cÚn
->
	`shutdown
();

61 
W—kTıCÚÃùiÚPŒ
 
w—kCÚn_
;

63 
boo¡
::
	tsh¬ed_±r
<
	tEÁry
> 
	tEÁryPŒ
;

64 
boo¡
::
	tw—k_±r
<
	tEÁry
> 
	tW—kEÁryPŒ
;

65 
boo¡
::
	tunÜd”ed_£t
<
	tEÁryPŒ
> 
	tBuck‘
;

66 
boo¡
::
	tcœcuÏr_bufãr
<
	tBuck‘
> 
	tW—kCÚÃùiÚLi¡
;

68 
muduo
::
Ãt
::
TıS”v”
 
£rv”_
;

69 
W—kCÚÃùiÚLi¡
 
cÚÃùiÚBuck‘s_
;

70 
	}
};

	@examples/idleconnection/main.cc

1 
	~"echo.h
"

2 
	~<¡dio.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
usšg
 
Çme¥aû
 
	gmuduo
;

8 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

10 
	$‹¡Hash
()

12 
boo¡
::
hash
<boo¡::
sh¬ed_±r
<> > 
h
;

13 
boo¡
::
sh¬ed_±r
<> 
	`x1
(
Ãw
 (10));

14 
boo¡
::
sh¬ed_±r
<> 
	`x2
(
Ãw
 (10));

15 
	`h
(
x1
);

16 
	`as£¹
(
	`h
(
x1
è!ğh(
x2
));

17 
x1
 = 
x2
;

18 
	`as£¹
(
	`h
(
x1
è=ğh(
x2
));

19 
x1
.
	`»£t
();

20 
	`as£¹
(
	`h
(
x1
è!ğh(
x2
));

21 
x2
.
	`»£t
();

22 
	`as£¹
(
	`h
(
x1
è=ğh(
x2
));

23 
	}
}

25 
	$maš
(
¬gc
, * 
¬gv
[])

27 
	`‹¡Hash
();

28 
Ev’tLoİ
 
loİ
;

29 
IÃtAdd»ss
 
	`li¡’Addr
(2007);

30 
idËSecÚds
 = 10;

31 ià(
¬gc
 > 1)

33 
idËSecÚds
 = 
	`©oi
(
¬gv
[1]);

35 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ", idË secÚd ğ" << 
idËSecÚds
;

36 
EchoS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
idËSecÚds
);

37 
£rv”
.
	`¡¬t
();

38 
loİ
.
	`loİ
();

39 
	}
}

	@examples/idleconnection/sortedlist.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/TıS”v”.h
>

4 
	~<boo¡/bšd.hµ
>

5 
	~<li¡
>

6 
	~<¡dio.h
>

7 
	~<uni¡d.h
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 şas 
	cEchoS”v”


15 
	mpublic
:

16 
EchoS”v”
(
Ev’tLoİ
* 
loİ
,

17 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

18 
idËSecÚds
);

20 
	$¡¬t
()

22 
£rv”_
.
	`¡¬t
();

25 
´iv©e
:

26 
	`ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

28 
	`ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

29 
Bufãr
* 
buf
,

30 
Time¡amp
 
time
);

32 
	`ÚTim”
();

34 
	$dumpCÚÃùiÚLi¡
() const;

36 
boo¡
::
	tw—k_±r
<
	tTıCÚÃùiÚ
> 
	tW—kTıCÚÃùiÚPŒ
;

37 
¡d
::
	tli¡
<
	tW—kTıCÚÃùiÚPŒ
> 
	tW—kCÚÃùiÚLi¡
;

39 
Node
 : 
public
 
muduo
::
cİyabË


41 
Time¡amp
 
Ï¡ReûiveTime
;

42 
W—kCÚÃùiÚLi¡
::
™”©Ü
 
pos™iÚ
;

43 
	}
};

45 
TıS”v”
 
	g£rv”_
;

46 
	gidËSecÚds_
;

47 
W—kCÚÃùiÚLi¡
 
	gcÚÃùiÚLi¡_
;

50 
	gEchoS”v”
::
	$EchoS”v”
(
Ev’tLoİ
* 
loİ
,

51 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

52 
idËSecÚds
)

53 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "EchoServer"),

54 
	$idËSecÚds_
(
idËSecÚds
)

56 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

57 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

58 
£rv”_
.
	`£tMes§geC®lback
(

59 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

60 
loİ
->
	`runEv”y
(1.0, 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚTim”
, 
this
));

61 
	`dumpCÚÃùiÚLi¡
();

62 
	}
}

64 
	gEchoS”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

66 
LOG_INFO
 << "EchoS”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

67 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

68 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

70 ià(
cÚn
->
	`cÚÃùed
())

72 
Node
 
node
;

73 
node
.
Ï¡ReûiveTime
 = 
Time¡amp
::
	`now
();

74 
cÚÃùiÚLi¡_
.
	`push_back
(
cÚn
);

75 
node
.
pos™iÚ
 = --
cÚÃùiÚLi¡_
.
	`’d
();

76 
cÚn
->
	`£tCÚ‹xt
(
node
);

80 
	`as£¹
(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
());

81 cÚ¡ 
Node
& 
node
 = 
boo¡
::
ªy_ÿ¡
<cÚ¡ Node&>(
cÚn
->
	`g‘CÚ‹xt
());

82 
cÚÃùiÚLi¡_
.
	`”a£
(
node
.
pos™iÚ
);

84 
	`dumpCÚÃùiÚLi¡
();

85 
	}
}

87 
	gEchoS”v”
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

88 
Bufãr
* 
buf
,

89 
Time¡amp
 
time
)

91 
¡ršg
 
	`msg
(
buf
->
	`»Œ›veAÎAsSŒšg
());

92 
LOG_INFO
 << 
cÚn
->
	`Çme
(è<< "ƒchØ" << 
msg
.
	`size
()

93 << " by‹ © " << 
time
.
	`toSŒšg
();

94 
cÚn
->
	`£nd
(
msg
);

96 
	`as£¹
(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
());

97 
Node
* 
node
 = 
boo¡
::
ªy_ÿ¡
<Node>(
cÚn
->
	`g‘MubËCÚ‹xt
());

98 
node
->
Ï¡ReûiveTime
 = 
time
;

99 
cÚÃùiÚLi¡_
.
	`¥liû
(cÚÃùiÚLi¡_.
	`’d
(), cÚÃùiÚLi¡_, 
node
->
pos™iÚ
);

100 
	`as£¹
(
node
->
pos™iÚ
 =ğ--
cÚÃùiÚLi¡_
.
	`’d
());

102 
	`dumpCÚÃùiÚLi¡
();

103 
	}
}

105 
	gEchoS”v”
::
	$ÚTim”
()

107 
	`dumpCÚÃùiÚLi¡
();

108 
Time¡amp
 
now
 = Time¡amp::
	`now
();

109 
W—kCÚÃùiÚLi¡
::
™”©Ü
 
™
 = 
cÚÃùiÚLi¡_
.
	`begš
();

110 
™
 !ğ
cÚÃùiÚLi¡_
.
	`’d
();)

112 
TıCÚÃùiÚPŒ
 
cÚn
 = 
™
->
	`lock
();

113 ià(
cÚn
)

115 
Node
* 
n
 = 
boo¡
::
ªy_ÿ¡
<Node>(
cÚn
->
	`g‘MubËCÚ‹xt
());

116 
age
 = 
	`timeDifã»nû
(
now
, 
n
->
Ï¡ReûiveTime
);

117 ià(
age
 > 
idËSecÚds_
)

119 ià(
cÚn
->
	`cÚÃùed
())

121 
cÚn
->
	`shutdown
();

122 
LOG_INFO
 << "shu‰šg dowÀ" << 
cÚn
->
	`Çme
();

123 
cÚn
->
	`fÜûClo£W™hD–ay
(3.5);

126 ià(
age
 < 0)

128 
LOG_WARN
 << "Time jump";

129 
n
->
Ï¡ReûiveTime
 = 
now
;

135 ++
™
;

139 
LOG_WARN
 << "Expired";

140 
™
 = 
cÚÃùiÚLi¡_
.
	`”a£
(it);

143 
	}
}

145 
	gEchoS”v”
::
	$dumpCÚÃùiÚLi¡
() const

147 
LOG_INFO
 << "sizğ" << 
cÚÃùiÚLi¡_
.
	`size
();

149 
W—kCÚÃùiÚLi¡
::
cÚ¡_™”©Ü
 
™
 = 
cÚÃùiÚLi¡_
.
	`begš
();

150 
™
 !ğ
cÚÃùiÚLi¡_
.
	`’d
(); ++it)

152 
TıCÚÃùiÚPŒ
 
cÚn
 = 
™
->
	`lock
();

153 ià(
cÚn
)

155 
	`´štf
("cÚÀ%p\n", 
	`g‘_poš‹r
(
cÚn
));

156 cÚ¡ 
Node
& 
n
 = 
boo¡
::
ªy_ÿ¡
<cÚ¡ Node&>(
cÚn
->
	`g‘CÚ‹xt
());

157 
	`´štf
("im%s\n", 
n
.
Ï¡ReûiveTime
.
	`toSŒšg
().
	`c_¡r
());

161 
	`´štf
("expired\n");

164 
	}
}

166 
	$maš
(
¬gc
, * 
¬gv
[])

168 
Ev’tLoİ
 
loİ
;

169 
IÃtAdd»ss
 
	`li¡’Addr
(2007);

170 
idËSecÚds
 = 10;

171 ià(
¬gc
 > 1)

173 
idËSecÚds
 = 
	`©oi
(
¬gv
[1]);

175 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ", idË secÚd ğ" << 
idËSecÚds
;

176 
EchoS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
idËSecÚds
);

177 
£rv”
.
	`¡¬t
();

178 
loİ
.
	`loİ
();

179 
	}
}

	@examples/maxconnection/echo.cc

1 
	~"echo.h
"

3 
	~<muduo/ba£/Loggšg.h
>

5 
	~<boo¡/bšd.hµ
>

7 
usšg
 
Çme¥aû
 
	gmuduo
;

8 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

10 
	gEchoS”v”
::
	$EchoS”v”
(
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

12 
maxCÚÃùiÚs
)

13 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "EchoServer"),

14 
	`numCÚÃùed_
(0),

15 
	$kMaxCÚÃùiÚs_
(
maxCÚÃùiÚs
)

17 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

18 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

19 
£rv”_
.
	`£tMes§geC®lback
(

20 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

21 
	}
}

23 
	gEchoS”v”
::
	$¡¬t
()

25 
£rv”_
.
	`¡¬t
();

26 
	}
}

28 
	gEchoS”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

30 
LOG_INFO
 << "EchoS”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

31 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

32 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

34 ià(
cÚn
->
	`cÚÃùed
())

36 ++
numCÚÃùed_
;

37 ià(
numCÚÃùed_
 > 
kMaxCÚÃùiÚs_
)

39 
cÚn
->
	`shutdown
();

40 
cÚn
->
	`fÜûClo£W™hD–ay
(3.0);

45 --
numCÚÃùed_
;

47 
LOG_INFO
 << "numCÚÃùed = " << 
numCÚÃùed_
;

48 
	}
}

50 
	gEchoS”v”
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

51 
Bufãr
* 
buf
,

52 
Time¡amp
 
time
)

54 
¡ršg
 
	`msg
(
buf
->
	`»Œ›veAÎAsSŒšg
());

55 
LOG_INFO
 << 
cÚn
->
	`Çme
(è<< "ƒchØ" << 
msg
.
	`size
(è<< " by‹ © " << 
time
.
	`toSŒšg
();

56 
cÚn
->
	`£nd
(
msg
);

57 
	}
}

	@examples/maxconnection/echo.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H


2 
	#MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cEchoS”v”


9 
	mpublic
:

10 
EchoS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
,

12 
maxCÚÃùiÚs
);

14 
¡¬t
();

16 
	m´iv©e
:

17 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

19 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

20 
muduo
::
Ãt
::
Bufãr
* 
buf
,

21 
muduo
::
Time¡amp
 
time
);

23 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

24 
	mnumCÚÃùed_
;

25 cÚ¡ 
	mkMaxCÚÃùiÚs_
;

	@examples/maxconnection/echo.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H


2 
	#MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cEchoS”v”


9 
	mpublic
:

10 
EchoS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
,

12 
maxCÚÃùiÚs
);

14 
¡¬t
();

16 
	m´iv©e
:

17 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

19 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

20 
muduo
::
Ãt
::
Bufãr
* 
buf
,

21 
muduo
::
Time¡amp
 
time
);

23 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

24 
	mnumCÚÃùed_
;

25 cÚ¡ 
	mkMaxCÚÃùiÚs_
;

	@examples/maxconnection/main.cc

1 
	~"echo.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<uni¡d.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
	$maš
(
¬gc
, * 
¬gv
[])

13 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

14 
Ev’tLoİ
 
loİ
;

15 
IÃtAdd»ss
 
	`li¡’Addr
(2007);

16 
maxCÚÃùiÚs
 = 5;

17 ià(
¬gc
 > 1)

19 
maxCÚÃùiÚs
 = 
	`©oi
(
¬gv
[1]);

21 
LOG_INFO
 << "maxCÚÃùiÚ ğ" << 
maxCÚÃùiÚs
;

22 
EchoS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
maxCÚÃùiÚs
);

23 
£rv”
.
	`¡¬t
();

24 
loİ
.
	`loİ
();

25 
	}
}

	@examples/memcached/client/bench.cc

1 
	~<muduo/ba£/CouÁDownL©ch.h
>

2 
	~<muduo/ba£/Loggšg.h
>

3 
	~<muduo/Ãt/Ev’tLoİ.h
>

4 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

5 
	~<muduo/Ãt/TıCl›Á.h
>

7 
	~<boo¡/bšd.hµ
>

8 
	~<boo¡/´og¿m_İtiÚs.hµ
>

9 
	~<io¡»am
>

11 
	~<¡dio.h
>

13 
Çme¥aû
 
	gpo
 = 
boo¡
::
´og¿m_İtiÚs
;

14 
usšg
 
Çme¥aû
 
	gmuduo
;

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 şas 
	cCl›Á
 : 
boo¡
::
nÚcİyabË


19 
public
:

20 
	eO³¿tiÚ


22 
kG‘
,

23 
	mkS‘
,

26 
	$Cl›Á
(cÚ¡ 
¡ršg
& 
Çme
,

27 
Ev’tLoİ
* 
loİ
,

28 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

29 
O³¿tiÚ
 
İ
,

30 
»que¡s
,

31 
keys
,

32 
v®u–’
,

33 
CouÁDownL©ch
* 
cÚÃùed
,

34 
CouÁDownL©ch
* 
fšished
)

35 : 
	`Çme_
(
Çme
),

36 
	`ş›Á_
(
loİ
, 
£rv”Addr
, 
Çme
),

37 
	`İ_
(
İ
),

38 
	`£Á_
(0),

39 
	`acked_
(0),

40 
	`»que¡s_
(
»que¡s
),

41 
	`keys_
(
keys
),

42 
	`v®u–’_
(
v®u–’
),

43 
	`v®ue_
(
v®u–’_
, 'a'),

44 
	`cÚÃùed_
(
cÚÃùed
),

45 
	$fšished_
(
fšished
)

47 
v®ue_
 += "\r\n";

48 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(
boo¡
::
	`bšd
(&
Cl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

49 
ş›Á_
.
	`£tMes§geC®lback
(
boo¡
::
	`bšd
(&
Cl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

50 
ş›Á_
.
	`cÚÃù
();

51 
	}
}

53 
	$£nd
()

55 
Bufãr
 
buf
;

56 
	`fl
(&
buf
);

57 
cÚn_
->
	`£nd
(&
buf
);

58 
	}
}

60 
	g´iv©e
:

62 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

64 ià(
cÚn
->
	`cÚÃùed
())

66 
cÚn_
 = 
cÚn
;

67 
cÚÃùed_
->
	`couÁDown
();

71 
cÚn_
.
	`»£t
();

72 
ş›Á_
.
	`g‘Loİ
()->
	`queueInLoİ
(
boo¡
::
	`bšd
(&
CouÁDownL©ch
::
couÁDown
, 
fšished_
));

74 
	}
}

76 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

77 
Bufãr
* 
bufãr
,

78 
Time¡amp
 
»ûiveTime
)

80 ià(
İ_
 =ğ
kS‘
)

82 
bufãr
->
	`»adabËBy‹s
() > 0)

84 cÚ¡ * 
ülf
 = 
bufãr
->
	`fšdCRLF
();

85 ià(
ülf
)

87 
bufãr
->
	`»Œ›veUÁ
(
ülf
+2);

88 ++
acked_
;

89 ià(
£Á_
 < 
»que¡s_
)

91 
	`£nd
();

102 
bufãr
->
	`»adabËBy‹s
() > 0)

104 cÚ¡ * 
’d
 = 
¡©ic_ÿ¡
<cÚ¡ *>(
	`memmem
(
bufãr
->
	`³ek
(),

105 
bufãr
->
	`»adabËBy‹s
(),

107 ià(
’d
)

109 
bufãr
->
	`»Œ›veUÁ
(
’d
+5);

110 ++
acked_
;

111 ià(
£Á_
 < 
»que¡s_
)

113 
	`£nd
();

122 ià(
acked_
 =ğ
»que¡s_
)

124 
cÚn_
->
	`shutdown
();

126 
	}
}

128 
	$fl
(
Bufãr
* 
buf
)

130 
»q
[256];

131 ià(
İ_
 =ğ
kS‘
)

133 
	`¢´štf
(
»q
, „eq, "£ˆ%s%d 42 0 %d\r\n", 
Çme_
.
	`c_¡r
(), 
£Á_
 % 
keys_
, 
v®u–’_
);

134 ++
£Á_
;

135 
buf
->
	`­³nd
(
»q
);

136 
buf
->
	`­³nd
(
v®ue_
);

140 
	`¢´štf
(
»q
, „eq, "g‘ %s%d\r\n", 
Çme_
.
	`c_¡r
(), 
£Á_
 % 
keys_
);

141 ++
£Á_
;

142 
buf
->
	`­³nd
(
»q
);

144 
	}
}

146 
¡ršg
 
	gÇme_
;

147 
TıCl›Á
 
	gş›Á_
;

148 
TıCÚÃùiÚPŒ
 
	gcÚn_
;

149 cÚ¡ 
O³¿tiÚ
 
	gİ_
;

150 
	g£Á_
;

151 
	gacked_
;

152 cÚ¡ 
	g»que¡s_
;

153 cÚ¡ 
	gkeys_
;

154 cÚ¡ 
	gv®u–’_
;

155 
¡ršg
 
	gv®ue_
;

156 
CouÁDownL©ch
* cÚ¡ 
	gcÚÃùed_
;

157 
CouÁDownL©ch
* cÚ¡ 
	gfšished_
;

160 
	$maš
(
¬gc
, * 
¬gv
[])

162 
Logg”
::
	`£tLogLev–
(Logg”::
WARN
);

164 
ušt16_t
 
tıpÜt
 = 11211;

165 
¡ršg
 
ho¡Ip
 = "127.0.0.1";

166 
th»ads
 = 4;

167 
ş›Ás
 = 100;

168 
»que¡s
 = 100000;

169 
keys
 = 10000;

170 
boŞ
 
£t
 = 
çl£
;

172 
po
::
İtiÚs_desütiÚ
 
	`desc
("Allowed options");

173 
desc
.
	`add_İtiÚs
()

175 ("pÜt,p", 
po
::
v®ue
<
ušt16_t
>(&
tıpÜt
), "TCP…ort")

176 (",i", 
po
::
v®ue
<
¡ršg
>(&
ho¡Ip
), "Host IP")

177 ("th»ads,t", 
po
::
v®ue
<>(&
th»ads
), "Number of workerhreads")

178 ("ş›Ás,c", 
po
::
v®ue
<>(&
ş›Ás
), "Number of concurrent clients")

179 ("»que¡s,r", 
po
::
v®ue
<>(&
»que¡s
), "Number of„equests…er clients")

180 ("keys,k", 
po
::
v®ue
<>(&
keys
), "Number of keys…er clients")

184 
po
::
v¬ŸbËs_m­
 
vm
;

185 
po
::
	`¡Üe
Õo::
	`·r£_commªd_lše
(
¬gc
, 
¬gv
, 
desc
), 
vm
);

186 
po
::
	`nÙify
(
vm
);

188 ià(
vm
.
	`couÁ
("help"))

190 
¡d
::
cout
 << 
desc
 << "\n";

193 
£t
 = 
vm
.
	`couÁ
("set");

195 
IÃtAdd»ss
 
	`£rv”Addr
(
ho¡Ip
, 
tıpÜt
);

196 
LOG_WARN
 << "CÚÃùšg " << 
£rv”Addr
.
	`toIpPÜt
();

198 
Ev’tLoİ
 
loİ
;

199 
Ev’tLoİTh»adPoŞ
 
	`poŞ
(&
loİ
, "bench-memcache");

201 
v®u–’
 = 100;

202 
Cl›Á
::
O³¿tiÚ
 
İ
 = 
£t
 ? Cl›Á::
kS‘
 : Cl›Á::
kG‘
;

204 
memÜyMiB
 = 1.0 * 
ş›Ás
 * 
keys
 * (32+80+
v®u–’
+8) / 1024 / 1024;

205 
LOG_WARN
 << "e¡im©ed memÿched-debug memÜy u§g" << (
memÜyMiB
) << " MiB";

207 
poŞ
.
	`£tTh»adNum
(
th»ads
);

208 
poŞ
.
	`¡¬t
();

210 
buf
[32];

211 
CouÁDownL©ch
 
	`cÚÃùed
(
ş›Ás
);

212 
CouÁDownL©ch
 
	`fšished
(
ş›Ás
);

213 
boo¡
::
±r_veùÜ
<
Cl›Á
> 
hŞd”
;

214 
i
 = 0; i < 
ş›Ás
; ++i)

216 
	`¢´štf
(
buf
,  buf, "%d-", 
i
+1);

217 
hŞd”
.
	`push_back
(
Ãw
 
	`Cl›Á
(
buf
,

218 
poŞ
.
	`g‘NextLoİ
(),

219 
£rv”Addr
,

220 
İ
,

221 
»que¡s
,

222 
keys
,

223 
v®u–’
,

224 &
cÚÃùed
,

225 &
fšished
));

227 
cÚÃùed
.
	`wa™
();

228 
LOG_WARN
 << 
ş›Ás
 << " clients‡ll connected";

229 
Time¡amp
 
¡¬t
 = Time¡amp::
	`now
();

230 
i
 = 0; i < 
ş›Ás
; ++i)

232 
hŞd”
[
i
].
	`£nd
();

234 
fšished
.
	`wa™
();

235 
Time¡amp
 
’d
 = Time¡amp::
	`now
();

236 
LOG_WARN
 << "All finished";

237 
£cÚds
 = 
	`timeDifã»nû
(
’d
, 
¡¬t
);

238 
LOG_WARN
 << 
£cÚds
 << " sec";

239 
LOG_WARN
 << 1.0 * 
ş›Ás
 * 
»que¡s
 / 
£cÚds
 << " QPS";

240 
	}
}

	@examples/memcached/server/Item.cc

1 
	~"I‹m.h
"

3 
	~<muduo/ba£/LogSŒ—m.h
>

4 
	~<muduo/Ãt/Bufãr.h
>

6 
	~<boo¡/unÜd”ed_m­.hµ
>

8 
	~<¡ršg.h
>

9 
	~<¡dio.h
>

11 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

14 
	gI‹m
::
	$I‹m
(
SŒšgP›û
 
keyArg
,

15 
ušt32_t
 
æagsArg
,

16 
ex±imeArg
,

17 
v®u–’
,

18 
ušt64_t
 
ÿsArg
)

19 : 
	`keyËn_
(
keyArg
.
	`size
()),

20 
	`æags_
(
æagsArg
),

21 
	`»l_ex±ime_
(
ex±imeArg
),

22 
	`v®u–’_
(
v®u–’
),

23 
	`»ûivedBy‹s_
(0),

24 
	`ÿs_
(
ÿsArg
),

25 
	`hash_
(
boo¡
::
	`hash_¿nge
(
keyArg
.
	`begš
(), keyArg.
	`’d
())),

26 
	`d©a_
(
¡©ic_ÿ¡
<*>(::
	`m®loc
(
	$tÙ®L’
())))

28 
	`as£¹
(
v®u–’_
 >= 2);

29 
	`as£¹
(
»ûivedBy‹s_
 < 
	`tÙ®L’
());

30 
	`­³nd
(
keyArg
.
	`d©a
(), 
keyËn_
);

31 
	}
}

33 
	gI‹m
::
	$­³nd
(cÚ¡ * 
d©a
, 
size_t
 
Ën
)

35 
	`as£¹
(
Ën
 <ğ
	`ÃededBy‹s
());

36 
	`memıy
(
d©a_
 + 
»ûivedBy‹s_
, 
d©a
, 
Ën
);

37 
»ûivedBy‹s_
 +ğ
¡©ic_ÿ¡
<>(
Ën
);

38 
	`as£¹
(
»ûivedBy‹s_
 <ğ
	`tÙ®L’
());

39 
	}
}

41 
	gI‹m
::
	$ouut
(
Bufãr
* 
out
, 
boŞ
 
ÃedCas
) const

43 
out
->
	`­³nd
("VALUE ");

44 
out
->
	`­³nd
(
d©a_
, 
keyËn_
);

45 
LogSŒ—m
 
buf
;

46 
buf
 << ' ' << 
æags_
 << ' ' << 
v®u–’_
-2;

47 ià(
ÃedCas
)

49 
buf
 << ' ' << 
ÿs_
;

51 
buf
 << "\r\n";

52 
out
->
	`­³nd
(
buf
.
	`bufãr
().
	`d©a
(), buf.bufãr().
	`Ëngth
());

53 
out
->
	`­³nd
(
	`v®ue
(), 
v®u–’_
);

54 
	}
}

56 
	gI‹m
::
	$»£tKey
(
SŒšgP›û
 
k
)

58 
	`as£¹
(
k
.
	`size
() <= 250);

59 
keyËn_
 = 
k
.
	`size
();

60 
»ûivedBy‹s_
 = 0;

61 
	`­³nd
(
k
.
	`d©a
(), k.
	`size
());

62 
hash_
 = 
boo¡
::
	`hash_¿nge
(
k
.
	`begš
(), k.
	`’d
());

63 
	}
}

	@examples/memcached/server/Item.h

1 #iâdeà
MUDUO_EXAMPLES_MEMCACHED_SERVER_ITEM_H


2 
	#MUDUO_EXAMPLES_MEMCACHED_SERVER_ITEM_H


	)

4 
	~<muduo/ba£/Atomic.h
>

5 
	~<muduo/ba£/SŒšgP›û.h
>

6 
	~<muduo/ba£/Ty³s.h
>

8 
	~<boo¡/make_sh¬ed.hµ
>

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<boo¡/sh¬ed_±r.hµ
>

12 
usšg
 
	gmuduo
::
¡ršg
;

13 
usšg
 
	gmuduo
::
SŒšgP›û
;

15 
Çme¥aû
 
	gmuduo


17 
Çme¥aû
 
	gÃt


19 
şass
 
	gBufãr
;

23 
şass
 
	gI‹m
;

24 
	gboo¡
::
	tsh¬ed_±r
<
	tI‹m
> 
	tI‹mPŒ
;

25 
	gboo¡
::
	tsh¬ed_±r
<cÚ¡ 
	tI‹m
> 
	tCÚ¡I‹mPŒ
;

28 şas 
	cI‹m
 : 
boo¡
::
nÚcİyabË


30 
public
:

31 
	eUpd©ePŞicy


33 
kInv®id
,

34 
	mkS‘
,

35 
	mkAdd
,

36 
	mkR•Ïû
,

37 
	mkAµ’d
,

38 
	mkP»³nd
,

39 
	mkCas
,

42 
I‹mPŒ
 
	$makeI‹m
(
SŒšgP›û
 
keyArg
,

43 
ušt32_t
 
æagsArg
,

44 
ex±imeArg
,

45 
v®u–’
,

46 
ušt64_t
 
ÿsArg
)

48  
boo¡
::
make_sh¬ed
<
I‹m
>(
keyArg
, 
æagsArg
, 
ex±imeArg
, 
v®u–’
, 
ÿsArg
);

50 
	}
}

52 
I‹m
(
SŒšgP›û
 
keyArg
,

53 
ušt32_t
 
æagsArg
,

54 
ex±imeArg
,

55 
v®u–’
,

56 
ušt64_t
 
ÿsArg
);

58 ~
	$I‹m
()

60 ::
	`ä“
(
d©a_
);

61 
	}
}

63 
	gmuduo
::
SŒšgP›û
 
	$key
() const

65  
muduo
::
	`SŒšgP›û
(
d©a_
, 
keyËn_
);

66 
	}
}

68 
ušt32_t
 
	$æags
() const

70  
æags_
;

71 
	}
}

73 
	$»l_ex±ime
() const

75  
»l_ex±ime_
;

76 
	}
}

78 cÚ¡ * 
	$v®ue
() const

80  
d©a_
+
keyËn_
;

81 
	}
}

83 
size_t
 
	$v®ueL’gth
() const

85  
v®u–’_
;

86 
	}
}

88 
ušt64_t
 
	$ÿs
() const

90  
ÿs_
;

91 
	}
}

93 
size_t
 
	$hash
() const

95  
hash_
;

96 
	}
}

98 
	$£tCas
(
ušt64_t
 
ÿsArg
)

100 
ÿs_
 = 
ÿsArg
;

101 
	}
}

103 
size_t
 
	$ÃededBy‹s
() const

105  
	`tÙ®L’
(è- 
»ûivedBy‹s_
;

106 
	}
}

108 
­³nd
(cÚ¡ * 
d©a
, 
size_t
 
Ën
);

110 
boŞ
 
	$’dsW™hCRLF
() const

112  
»ûivedBy‹s_
 =ğ
	`tÙ®L’
()

113 && 
d©a_
[
	`tÙ®L’
()-2] == '\r'

114 && 
d©a_
[
	`tÙ®L’
()-1] == '\n';

115 
	}
}

117 
ouut
(
muduo
::
Ãt
::
Bufãr
* 
out
, 
boŞ
 
ÃedCas
 = 
çl£
) const;

119 
»£tKey
(
SŒšgP›û
 
k
);

121 
	g´iv©e
:

122 
	$tÙ®L’
(ècÚ¡ {  
keyËn_
 + 
v®u–’_
; 
	}
}

124 
	gkeyËn_
;

125 cÚ¡ 
ušt32_t
 
	gæags_
;

126 cÚ¡ 
	g»l_ex±ime_
;

127 cÚ¡ 
	gv®u–’_
;

128 
	g»ûivedBy‹s_
;

129 
ušt64_t
 
	gÿs_
;

130 
size_t
 
	ghash_
;

131 * 
	gd©a_
;

	@examples/memcached/server/Item.h

1 #iâdeà
MUDUO_EXAMPLES_MEMCACHED_SERVER_ITEM_H


2 
	#MUDUO_EXAMPLES_MEMCACHED_SERVER_ITEM_H


	)

4 
	~<muduo/ba£/Atomic.h
>

5 
	~<muduo/ba£/SŒšgP›û.h
>

6 
	~<muduo/ba£/Ty³s.h
>

8 
	~<boo¡/make_sh¬ed.hµ
>

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<boo¡/sh¬ed_±r.hµ
>

12 
usšg
 
	gmuduo
::
¡ršg
;

13 
usšg
 
	gmuduo
::
SŒšgP›û
;

15 
Çme¥aû
 
	gmuduo


17 
Çme¥aû
 
	gÃt


19 
şass
 
	gBufãr
;

23 
şass
 
	gI‹m
;

24 
	gboo¡
::
	tsh¬ed_±r
<
	tI‹m
> 
	tI‹mPŒ
;

25 
	gboo¡
::
	tsh¬ed_±r
<cÚ¡ 
	tI‹m
> 
	tCÚ¡I‹mPŒ
;

28 şas 
	cI‹m
 : 
boo¡
::
nÚcİyabË


30 
public
:

31 
	eUpd©ePŞicy


33 
kInv®id
,

34 
	mkS‘
,

35 
	mkAdd
,

36 
	mkR•Ïû
,

37 
	mkAµ’d
,

38 
	mkP»³nd
,

39 
	mkCas
,

42 
I‹mPŒ
 
	$makeI‹m
(
SŒšgP›û
 
keyArg
,

43 
ušt32_t
 
æagsArg
,

44 
ex±imeArg
,

45 
v®u–’
,

46 
ušt64_t
 
ÿsArg
)

48  
boo¡
::
make_sh¬ed
<
I‹m
>(
keyArg
, 
æagsArg
, 
ex±imeArg
, 
v®u–’
, 
ÿsArg
);

50 
	}
}

52 
I‹m
(
SŒšgP›û
 
keyArg
,

53 
ušt32_t
 
æagsArg
,

54 
ex±imeArg
,

55 
v®u–’
,

56 
ušt64_t
 
ÿsArg
);

58 ~
	$I‹m
()

60 ::
	`ä“
(
d©a_
);

61 
	}
}

63 
	gmuduo
::
SŒšgP›û
 
	$key
() const

65  
muduo
::
	`SŒšgP›û
(
d©a_
, 
keyËn_
);

66 
	}
}

68 
ušt32_t
 
	$æags
() const

70  
æags_
;

71 
	}
}

73 
	$»l_ex±ime
() const

75  
»l_ex±ime_
;

76 
	}
}

78 cÚ¡ * 
	$v®ue
() const

80  
d©a_
+
keyËn_
;

81 
	}
}

83 
size_t
 
	$v®ueL’gth
() const

85  
v®u–’_
;

86 
	}
}

88 
ušt64_t
 
	$ÿs
() const

90  
ÿs_
;

91 
	}
}

93 
size_t
 
	$hash
() const

95  
hash_
;

96 
	}
}

98 
	$£tCas
(
ušt64_t
 
ÿsArg
)

100 
ÿs_
 = 
ÿsArg
;

101 
	}
}

103 
size_t
 
	$ÃededBy‹s
() const

105  
	`tÙ®L’
(è- 
»ûivedBy‹s_
;

106 
	}
}

108 
­³nd
(cÚ¡ * 
d©a
, 
size_t
 
Ën
);

110 
boŞ
 
	$’dsW™hCRLF
() const

112  
»ûivedBy‹s_
 =ğ
	`tÙ®L’
()

113 && 
d©a_
[
	`tÙ®L’
()-2] == '\r'

114 && 
d©a_
[
	`tÙ®L’
()-1] == '\n';

115 
	}
}

117 
ouut
(
muduo
::
Ãt
::
Bufãr
* 
out
, 
boŞ
 
ÃedCas
 = 
çl£
) const;

119 
»£tKey
(
SŒšgP›û
 
k
);

121 
	g´iv©e
:

122 
	$tÙ®L’
(ècÚ¡ {  
keyËn_
 + 
v®u–’_
; 
	}
}

124 
	gkeyËn_
;

125 cÚ¡ 
ušt32_t
 
	gæags_
;

126 cÚ¡ 
	g»l_ex±ime_
;

127 cÚ¡ 
	gv®u–’_
;

128 
	g»ûivedBy‹s_
;

129 
ušt64_t
 
	gÿs_
;

130 
size_t
 
	ghash_
;

131 * 
	gd©a_
;

	@examples/memcached/server/MemcacheServer.cc

1 
	~"MemÿcheS”v”.h
"

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<boo¡/bšd.hµ
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

12 
	gmuduo
::
AtomicIÁ64
 
g_ÿs
;

14 
	gMemÿcheS”v”
::
O±iÚs
::
	$O±iÚs
()

16 
	`bz”o
(
this
, (*this));

17 
	}
}

19 
	gMemÿcheS”v”
::
Sts


23 
	gMemÿcheS”v”
::
MemÿcheS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
, cÚ¡ 
O±iÚs
& 
İtiÚs
)

24 : 
loİ_
(
loİ
),

25 
İtiÚs_
(
İtiÚs
),

26 
¡¬tTime_
(::
time
(
NULL
)-1),

27 
£rv”_
(
loİ
, 
IÃtAdd»ss
(
İtiÚs
.
tıpÜt
), "muduo-memcached"),

28 
	$¡©s_
(
Ãw
 
Sts
)

30 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

31 
boo¡
::
	`bšd
(&
MemÿcheS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

32 
	}
}

34 
	gMemÿcheS”v”
::~
	$MemÿcheS”v”
()

36 
	}
}

38 
MemÿcheS”v”
::
	$¡¬t
()

40 
£rv”_
.
	`¡¬t
();

41 
	}
}

43 
	gMemÿcheS”v”
::
	$¡İ
()

45 
loİ_
->
	`runAá”
(3.0, 
boo¡
::
	`bšd
(&
Ev’tLoİ
::
qu™
,†oop_));

46 
	}
}

48 
boŞ
 
	gMemÿcheS”v”
::
¡ÜeI‹m
(cÚ¡ 
I‹mPŒ
& 
™em
, cÚ¡ 
I‹m
::
Upd©ePŞicy
 
pŞicy
, boŞ* 
exi¡s
)

50 
as£¹
(
™em
->
ÃededBy‹s
() == 0);

51 
	gMu‹xLock
& 
	gmu‹x
 = 
sh¬ds_
[
™em
->
hash
(è% 
kSh¬ds
].
mu‹x
;

52 
	gI‹mM­
& 
	g™ems
 = 
sh¬ds_
[
™em
->
hash
(è% 
kSh¬ds
].
™ems
;

53 
Mu‹xLockGu¬d
 
lock
(
mu‹x
);

54 
	gI‹mM­
::
cÚ¡_™”©Ü
 
™
 = 
™ems
.
fšd
(
™em
);

55 *
	gexi¡s
 = 
™
 !ğ
™ems
.
’d
();

56 ià(
	gpŞicy
 =ğ
I‹m
::
kS‘
)

58 
™em
->
£tCas
(
g_ÿs
.
šüem’tAndG‘
());

59 ià(*
	gexi¡s
)

61 
	g™ems
.
”a£
(
™
);

63 
	g™ems
.
š£¹
(
™em
);

67 ià(
	gpŞicy
 =ğ
I‹m
::
kAdd
)

69 ià(*
exi¡s
)

71  
çl£
;

75 
	g™em
->
£tCas
(
g_ÿs
.
šüem’tAndG‘
());

76 
	g™ems
.
š£¹
(
™em
);

79 ià(
	gpŞicy
 =ğ
I‹m
::
kR•Ïû
)

81 ià(*
exi¡s
)

83 
™em
->
£tCas
(
g_ÿs
.
šüem’tAndG‘
());

84 
	g™ems
.
”a£
(
™
);

85 
	g™ems
.
š£¹
(
™em
);

89  
	gçl£
;

92 ià(
	gpŞicy
 =ğ
I‹m
::
kAµ’d
 || 
pŞicy
 =ğI‹m::
kP»³nd
)

94 ià(*
exi¡s
)

96 cÚ¡ 
CÚ¡I‹mPŒ
& 
ŞdI‹m
 = *
™
;

97 
	gÃwL’
 = 
¡©ic_ÿ¡
<>(
™em
->
v®ueL’gth
(è+ 
ŞdI‹m
->valueLength() - 2);

98 
I‹mPŒ
 
ÃwI‹m
(
I‹m
::
makeI‹m
(
™em
->
key
(),

99 
ŞdI‹m
->
æags
(),

100 
ŞdI‹m
->
»l_ex±ime
(),

101 
ÃwL’
,

102 
g_ÿs
.
šüem’tAndG‘
()));

103 ià(
	gpŞicy
 =ğ
I‹m
::
kAµ’d
)

105 
ÃwI‹m
->
­³nd
(
ŞdI‹m
->
v®ue
(), oldI‹m->
v®ueL’gth
() - 2);

106 
	gÃwI‹m
->
­³nd
(
™em
->
v®ue
(), i‹m->
v®ueL’gth
());

110 
	gÃwI‹m
->
­³nd
(
™em
->
v®ue
(), i‹m->
v®ueL’gth
() - 2);

111 
	gÃwI‹m
->
­³nd
(
ŞdI‹m
->
v®ue
(), oldI‹m->
v®ueL’gth
());

113 
as£¹
(
ÃwI‹m
->
ÃededBy‹s
() == 0);

114 
as£¹
(
ÃwI‹m
->
’dsW™hCRLF
());

115 
	g™ems
.
”a£
(
™
);

116 
	g™ems
.
š£¹
(
ÃwI‹m
);

120  
	gçl£
;

123 ià(
	gpŞicy
 =ğ
I‹m
::
kCas
)

125 ià(*
exi¡s
 && (*
™
)->
ÿs
(è=ğ
™em
->cas())

127 
™em
->
£tCas
(
g_ÿs
.
šüem’tAndG‘
());

128 
	g™ems
.
”a£
(
™
);

129 
	g™ems
.
š£¹
(
™em
);

133  
	gçl£
;

138 
as£¹
(
çl£
);

141  
	gŒue
;

144 
CÚ¡I‹mPŒ
 
	gMemÿcheS”v”
::
	$g‘I‹m
(cÚ¡ 
CÚ¡I‹mPŒ
& 
key
) const

146 
Mu‹xLock
& 
mu‹x
 = 
sh¬ds_
[
key
->
	`hash
(è% 
kSh¬ds
].mutex;

147 cÚ¡ 
I‹mM­
& 
™ems
 = 
sh¬ds_
[
key
->
	`hash
(è% 
kSh¬ds
].items;

148 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x
);

149 
I‹mM­
::
cÚ¡_™”©Ü
 
™
 = 
™ems
.
	`fšd
(
key
);

150  
™
 !ğ
™ems
.
	`’d
(è? *™ : 
	`CÚ¡I‹mPŒ
();

151 
	}
}

153 
boŞ
 
	gMemÿcheS”v”
::
	$d–‘eI‹m
(cÚ¡ 
CÚ¡I‹mPŒ
& 
key
)

155 
Mu‹xLock
& 
mu‹x
 = 
sh¬ds_
[
key
->
	`hash
(è% 
kSh¬ds
].mutex;

156 
I‹mM­
& 
™ems
 = 
sh¬ds_
[
key
->
	`hash
(è% 
kSh¬ds
].items;

157 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x
);

158  
™ems
.
	`”a£
(
key
) == 1;

159 
	}
}

161 
	gMemÿcheS”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

163 ià(
cÚn
->
	`cÚÃùed
())

165 
SessiÚPŒ
 
	`£ssiÚ
(
Ãw
 
	`SessiÚ
(
this
, 
cÚn
));

166 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

167 
	`as£¹
(
£ssiÚs_
.
	`fšd
(
cÚn
->
	`Çme
()è=ğ£ssiÚs_.
	`’d
());

168 
£ssiÚs_
[
cÚn
->
	`Çme
()] = 
£ssiÚ
;

173 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

174 
	`as£¹
(
£ssiÚs_
.
	`fšd
(
cÚn
->
	`Çme
()è!ğ£ssiÚs_.
	`’d
());

175 
£ssiÚs_
.
	`”a£
(
cÚn
->
	`Çme
());

178 
	}
}

	@examples/memcached/server/MemcacheServer.h

1 #iâdeà
MUDUO_EXAMPLES_MEMCACHED_SERVER_MEMCACHESERVER_H


2 
	#MUDUO_EXAMPLES_MEMCACHED_SERVER_MEMCACHESERVER_H


	)

4 
	~"I‹m.h
"

5 
	~"SessiÚ.h
"

7 
	~<muduo/ba£/Mu‹x.h
>

8 
	~<muduo/Ãt/TıS”v”.h
>

9 
	~<exam¶es/wÜdcouÁ/hash.h
>

11 
	~<boo¡/¬¿y.hµ
>

12 
	~<boo¡/nÚcİyabË.hµ
>

13 
	~<boo¡/unÜd”ed_m­.hµ
>

14 
	~<boo¡/unÜd”ed_£t.hµ
>

16 şas 
	cMemÿcheS”v”
 : 
boo¡
::
nÚcİyabË


18 
public
:

19 
	sO±iÚs


21 
O±iÚs
();

22 
ušt16_t
 
	mtıpÜt
;

23 
ušt16_t
 
	mudµÜt
;

24 
ušt16_t
 
	mg³råÜt
;

25 
	mth»ads
;

28 
MemÿcheS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
, cÚ¡ 
O±iÚs
&);

29 ~
MemÿcheS”v”
();

31 
	$£tTh»adNum
(
th»ads
è{ 
£rv”_
.
	`£tTh»adNum
Ñh»ads); 
	}
}

32 
¡¬t
();

33 
¡İ
();

35 
time_t
 
	$¡¬tTime
(ècÚ¡ {  
¡¬tTime_
; 
	}
}

37 
boŞ
 
¡ÜeI‹m
(cÚ¡ 
I‹mPŒ
& 
™em
, 
I‹m
::
Upd©ePŞicy
 
pŞicy
, boŞ* 
exi¡s
);

38 
CÚ¡I‹mPŒ
 
	$g‘I‹m
(cÚ¡ 
CÚ¡I‹mPŒ
& 
key
) const;

39 
boŞ
 
	`d–‘eI‹m
(cÚ¡ 
CÚ¡I‹mPŒ
& 
key
);

41 
´iv©e
:

42 
	`ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

44 
Sts
;

46 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ_
;

47 
O±iÚs
 
İtiÚs_
;

48 cÚ¡ 
time_t
 
¡¬tTime_
;

50 
mubË
 
muduo
::
Mu‹xLock
 
mu‹x_
;

51 
boo¡
::
unÜd”ed_m­
<
¡ršg
, 
SessiÚPŒ
> 
£ssiÚs_
;

54 
	sHash


56 
size_t
 
	`İ”©Ü
()(cÚ¡ 
CÚ¡I‹mPŒ
& 
x
) const

58  
x
->
	`hash
();

60 
	}
};

62 
	sEqu®


64 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gCÚ¡I‹mPŒ
& 
	gx
, cÚ¡ CÚ¡I‹mPŒ& 
	gy
) const

66  
	gx
->
key
(è=ğ
y
->key();

70 
	gboo¡
::
	tunÜd”ed_£t
<
	tCÚ¡I‹mPŒ
, 
	tHash
, 
	tEqu®
> 
	tI‹mM­
;

72 
	sM­W™hLock


74 
I‹mM­
 
	g™ems
;

75 
mubË
 
	gmuduo
::
Mu‹xLock
 
mu‹x
;

78 cÚ¡ 
	gkSh¬ds
 = 4096;

80 
	gboo¡
::
¬¿y
<
M­W™hLock
, 
	gkSh¬ds
> 
	gsh¬ds_
;

84 
	gmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

85 
	gboo¡
::
scİed_±r
<
Sts
> 
¡©s_
;

	@examples/memcached/server/MemcacheServer.h

1 #iâdeà
MUDUO_EXAMPLES_MEMCACHED_SERVER_MEMCACHESERVER_H


2 
	#MUDUO_EXAMPLES_MEMCACHED_SERVER_MEMCACHESERVER_H


	)

4 
	~"I‹m.h
"

5 
	~"SessiÚ.h
"

7 
	~<muduo/ba£/Mu‹x.h
>

8 
	~<muduo/Ãt/TıS”v”.h
>

9 
	~<exam¶es/wÜdcouÁ/hash.h
>

11 
	~<boo¡/¬¿y.hµ
>

12 
	~<boo¡/nÚcİyabË.hµ
>

13 
	~<boo¡/unÜd”ed_m­.hµ
>

14 
	~<boo¡/unÜd”ed_£t.hµ
>

16 şas 
	cMemÿcheS”v”
 : 
boo¡
::
nÚcİyabË


18 
public
:

19 
	sO±iÚs


21 
O±iÚs
();

22 
ušt16_t
 
	mtıpÜt
;

23 
ušt16_t
 
	mudµÜt
;

24 
ušt16_t
 
	mg³råÜt
;

25 
	mth»ads
;

28 
MemÿcheS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
, cÚ¡ 
O±iÚs
&);

29 ~
MemÿcheS”v”
();

31 
	$£tTh»adNum
(
th»ads
è{ 
£rv”_
.
	`£tTh»adNum
Ñh»ads); 
	}
}

32 
¡¬t
();

33 
¡İ
();

35 
time_t
 
	$¡¬tTime
(ècÚ¡ {  
¡¬tTime_
; 
	}
}

37 
boŞ
 
¡ÜeI‹m
(cÚ¡ 
I‹mPŒ
& 
™em
, 
I‹m
::
Upd©ePŞicy
 
pŞicy
, boŞ* 
exi¡s
);

38 
CÚ¡I‹mPŒ
 
	$g‘I‹m
(cÚ¡ 
CÚ¡I‹mPŒ
& 
key
) const;

39 
boŞ
 
	`d–‘eI‹m
(cÚ¡ 
CÚ¡I‹mPŒ
& 
key
);

41 
´iv©e
:

42 
	`ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

44 
Sts
;

46 
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ_
;

47 
O±iÚs
 
İtiÚs_
;

48 cÚ¡ 
time_t
 
¡¬tTime_
;

50 
mubË
 
muduo
::
Mu‹xLock
 
mu‹x_
;

51 
boo¡
::
unÜd”ed_m­
<
¡ršg
, 
SessiÚPŒ
> 
£ssiÚs_
;

54 
	sHash


56 
size_t
 
	`İ”©Ü
()(cÚ¡ 
CÚ¡I‹mPŒ
& 
x
) const

58  
x
->
	`hash
();

60 
	}
};

62 
	sEqu®


64 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gCÚ¡I‹mPŒ
& 
	gx
, cÚ¡ CÚ¡I‹mPŒ& 
	gy
) const

66  
	gx
->
key
(è=ğ
y
->key();

70 
	gboo¡
::
	tunÜd”ed_£t
<
	tCÚ¡I‹mPŒ
, 
	tHash
, 
	tEqu®
> 
	tI‹mM­
;

72 
	sM­W™hLock


74 
I‹mM­
 
	g™ems
;

75 
mubË
 
	gmuduo
::
Mu‹xLock
 
mu‹x
;

78 cÚ¡ 
	gkSh¬ds
 = 4096;

80 
	gboo¡
::
¬¿y
<
M­W™hLock
, 
	gkSh¬ds
> 
	gsh¬ds_
;

84 
	gmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

85 
	gboo¡
::
scİed_±r
<
Sts
> 
¡©s_
;

	@examples/memcached/server/Session.cc

1 
	~"SessiÚ.h
"

2 
	~"MemÿcheS”v”.h
"

4 #ifdeà
HAVE_TCMALLOC


5 
	~<g³ráoŞs/m®loc_ex‹nsiÚ.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
boŞ
 
	$isBš¬yPrÙocŞ
(
ušt8_t
 
fœ¡By‹
)

13  
fœ¡By‹
 == 0x80;

14 
	}
}

16 cÚ¡ 
	gkLÚge¡KeySize
 = 250;

17 
¡ršg
 
	gSessiÚ
::
kLÚge¡Key
(
kLÚge¡KeySize
, 'x');

19 
	g‹m¶©e
 <
ty³Çme
 
	gIÅutI‹¿tÜ
,y³Çm
	gTok’
>

20 
boŞ
 
	gSessiÚ
::
S·ûS•¬©Ü
::
	$İ”©Ü
()(
IÅutI‹¿tÜ
& 
Ãxt
, IÅutI‹¿tÜ 
’d
, 
Tok’
& 
tok
)

22 
Ãxt
 !ğ
’d
 && *next == ' ')

23 ++
Ãxt
;

24 ià(
Ãxt
 =ğ
’d
)

26 
tok
.
	`ş—r
();

27  
çl£
;

29 
IÅutI‹¿tÜ
 
	`¡¬t
(
Ãxt
);

30 cÚ¡ * 
¥
 = 
¡©ic_ÿ¡
<cÚ¡ *>(
	`memchr
(
¡¬t
, ' ', 
’d
 - start));

31 ià(
¥
)

33 
tok
.
	`£t
(
¡¬t
, 
¡©ic_ÿ¡
<>(
¥
 - start));

34 
Ãxt
 = 
¥
;

38 
tok
.
	`£t
(
¡¬t
, 
¡©ic_ÿ¡
<>(
’d
 - 
Ãxt
));

39 
Ãxt
 = 
’d
;

41  
Œue
;

42 
	}
}

44 
	gSessiÚ
::
R—d”


46 
R—d”
(
Tok’iz”
::
™”©Ü
& 
beg
, Tok’iz”::™”©Ü 
’d
)

47 : 
fœ¡_
(
beg
),

48 
Ï¡_
(
’d
)

52 
	g‹m¶©e
<
ty³Çme
 
	gT
>

53 
boŞ
 
»ad
(
T
* 
v®
)

55 ià(
	gfœ¡_
 =ğ
Ï¡_
)

56  
çl£
;

57 * 
	g’d
 = 
NULL
;

58 
ušt64_t
 
	gx
 = 
¡¹ouÎ
((*
fœ¡_
).
d©a
(), &
’d
, 10);

59 ià(
	g’d
 =ğ(*
fœ¡_
).
’d
())

61 *
v®
 = 
¡©ic_ÿ¡
<
T
>(
x
);

62 ++
	gfœ¡_
;

63  
	gŒue
;

65  
	gçl£
;

68 
	g´iv©e
:

69 
Tok’iz”
::
™”©Ü
 
fœ¡_
;

70 
	gTok’iz”
::
™”©Ü
 
Ï¡_
;;

73 
	gSessiÚ
::
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

74 
muduo
::
Ãt
::
Bufãr
* 
buf
,

75 
muduo
::
Time¡amp
)

78 cÚ¡ 
size_t
 
š™ŸlR—dabË
 = 
buf
->
»adabËBy‹s
();

80 
	gbuf
->
»adabËBy‹s
() > 0)

82 ià(
	g¡©e_
 =ğ
kNewCommªd
)

84 ià(
´ÙocŞ_
 =ğ
kAuto
)

86 
as£¹
(
by‹sR—d_
 == 0);

87 
	g´ÙocŞ_
 = 
isBš¬yPrÙocŞ
(
buf
->
³ek
()[0]è? 
kBš¬y
 : 
kAscii
;

90 
as£¹
(
´ÙocŞ_
 =ğ
kAscii
 ||…rÙocŞ_ =ğ
kBš¬y
);

91 ià(
	g´ÙocŞ_
 =ğ
kBš¬y
)

97 cÚ¡ * 
ülf
 = 
buf
->
fšdCRLF
();

98 ià(
	gülf
)

100 
	gËn
 = 
¡©ic_ÿ¡
<>(
ülf
 - 
buf
->
³ek
());

101 
SŒšgP›û
 
»que¡
(
buf
->
³ek
(), 
Ën
);

102 ià(
´oûssReque¡
(
»que¡
))

104 
»£tReque¡
();

106 
	gbuf
->
»Œ›veUÁ
(
ülf
 + 2);

110 ià(
	gbuf
->
»adabËBy‹s
() > 1024)

113 
	gcÚn_
->
shutdown
();

120 ià(
	g¡©e_
 =ğ
kReûiveV®ue
)

122 
»ûiveV®ue
(
buf
);

124 ià(
	g¡©e_
 =ğ
kDisÿrdV®ue
)

126 
disÿrdV®ue
(
buf
);

130 
as£¹
(
çl£
);

133 
	gby‹sR—d_
 +ğ
š™ŸlR—dabË
 - 
buf
->
»adabËBy‹s
();

136 
	gSessiÚ
::
»ûiveV®ue
(
muduo
::
Ãt
::
Bufãr
* 
buf
)

138 
as£¹
(
cu¼I‹m_
.
g‘
());

139 
as£¹
(
¡©e_
 =ğ
kReûiveV®ue
);

142 cÚ¡ 
size_t
 
	gava
 = 
¡d
::
mš
(
buf
->
»adabËBy‹s
(), 
cu¼I‹m_
->
ÃededBy‹s
());

143 
as£¹
(
cu¼I‹m_
.
unique
());

144 
	gcu¼I‹m_
->
­³nd
(
buf
->
³ek
(), 
ava
);

145 
	gbuf
->
»Œ›ve
(
ava
);

146 ià(
	gcu¼I‹m_
->
ÃededBy‹s
() == 0)

148 ià(
cu¼I‹m_
->
’dsW™hCRLF
())

150 
boŞ
 
exi¡s
 = 
çl£
;

151 ià(
	gowÃr_
->
¡ÜeI‹m
(
cu¼I‹m_
, 
pŞicy_
, &
exi¡s
))

153 
»¶y
("STORED\r\n");

157 ià(
	gpŞicy_
 =ğ
I‹m
::
kCas
)

159 ià(
exi¡s
)

161 
»¶y
("EXISTS\r\n");

165 
»¶y
("NOT_FOUND\r\n");

170 
»¶y
("NOT_STORED\r\n");

176 
»¶y
("CLIENT_ERROR bad data chunk\r\n");

178 
»£tReque¡
();

179 
	g¡©e_
 = 
kNewCommªd
;

183 
	gSessiÚ
::
disÿrdV®ue
(
muduo
::
Ãt
::
Bufãr
* 
buf
)

185 
as£¹
(!
cu¼I‹m_
);

186 
as£¹
(
¡©e_
 =ğ
kDisÿrdV®ue
);

187 ià(
	gbuf
->
»adabËBy‹s
(è< 
	gby‹sToDisÿrd_
)

189 
	gby‹sToDisÿrd_
 -ğ
buf
->
»adabËBy‹s
();

190 
	gbuf
->
»Œ›veAÎ
();

194 
	gbuf
->
»Œ›ve
(
by‹sToDisÿrd_
);

195 
	gby‹sToDisÿrd_
 = 0;

196 
»£tReque¡
();

197 
	g¡©e_
 = 
kNewCommªd
;

201 
boŞ
 
	gSessiÚ
::
	$´oûssReque¡
(
SŒšgP›û
 
»que¡
)

203 
	`as£¹
(
commªd_
.
	`em±y
());

204 
	`as£¹
(!
nÜ•ly_
);

205 
	`as£¹
(
pŞicy_
 =ğ
I‹m
::
kInv®id
);

206 
	`as£¹
(!
cu¼I‹m_
);

207 
	`as£¹
(
by‹sToDisÿrd_
 == 0);

208 ++
»que¡sProûs£d_
;

211 ià(
»que¡
.
	`size
() >= 8)

213 
SŒšgP›û
 
	`’d
(
»que¡
.end() - 8, 8);

214 ià(
’d
 == "‚oreply")

216 
nÜ•ly_
 = 
Œue
;

217 
»que¡
.
	`»move_suffix
(8);

221 
S·ûS•¬©Ü
 
£p
;

222 
Tok’iz”
 
	`tok
(
»que¡
.
	`begš
(),„eque¡.
	`’d
(), 
£p
);

223 
Tok’iz”
::
™”©Ü
 
beg
 = 
tok
.
	`begš
();

224 ià(
beg
 =ğ
tok
.
	`’d
())

226 
	`»¶y
("ERROR\r\n");

227  
Œue
;

229 (*
beg
).
	`CİyToSŒšg
(&
commªd_
);

230 ++
beg
;

231 ià(
commªd_
 == "set" || command_ == "add" || command_ == "replace"

232 || 
commªd_
 == "append" || command_ == "prepend" || command_ == "cas")

235  
	`doUpd©e
(
beg
, 
tok
.
	`’d
());

237 ià(
commªd_
 == "get" || command_ == "gets")

239 
boŞ
 
ÿs
 = 
commªd_
 == "gets";

242 
beg
 !ğ
tok
.
	`’d
())

244 
SŒšgP›û
 
key
 = *
beg
;

245 
boŞ
 
good
 = 
key
.
	`size
(è<ğ
kLÚge¡KeySize
;

246 ià(!
good
)

248 
	`»¶y
("CLIENT_ERROR bad command†ine format\r\n");

249  
Œue
;

252 
ÃedË_
->
	`»£tKey
(
key
);

253 
CÚ¡I‹mPŒ
 
™em
 = 
owÃr_
->
	`g‘I‹m
(
ÃedË_
);

254 ++
beg
;

255 ià(
™em
)

257 
™em
->
	`ouut
(&
ouutBuf_
, 
ÿs
);

260 
ouutBuf_
.
	`­³nd
("END\r\n");

262 ià(
cÚn_
->
	`ouutBufãr
()->
	`wr™abËBy‹s
(è> 65536 + 
ouutBuf_
.
	`»adabËBy‹s
())

264 
LOG_DEBUG
 << "shršk ouuˆbufã¸äom " << 
cÚn_
->
	`ouutBufãr
()->
	`š‹º®C­ac™y
();

265 
cÚn_
->
	`ouutBufãr
()->
	`shršk
(65536 + 
ouutBuf_
.
	`»adabËBy‹s
());

268 
cÚn_
->
	`£nd
(&
ouutBuf_
);

270 ià(
commªd_
 == "delete")

272 
	`doD–‘e
(
beg
, 
tok
.
	`’d
());

274 ià(
commªd_
 == "version")

276 #ifdeà
HAVE_TCMALLOC


277 
	`»¶y
("VERSION 0.01 muduo withcmalloc\r\n");

279 
	`»¶y
("VERSION 0.01 muduo\r\n");

282 #ifdeà
HAVE_TCMALLOC


283 ià(
commªd_
 == "memstat")

285 
buf
[1024*64];

286 
M®locEx‹nsiÚ
::
	`š¡ªû
()->
	`G‘Sts
(
buf
,  buf);

287 
	`»¶y
(
buf
);

290 ià(
commªd_
 == "quit")

292 
cÚn_
->
	`shutdown
();

294 ià(
commªd_
 == "shutdown")

297 
cÚn_
->
	`shutdown
();

298 
owÃr_
->
	`¡İ
();

302 
	`»¶y
("ERROR\r\n");

303 
LOG_INFO
 << "UnknowÀcommªd: " << 
commªd_
;

305  
Œue
;

306 
	}
}

308 
	gSessiÚ
::
	$»£tReque¡
()

310 
commªd_
.
	`ş—r
();

311 
nÜ•ly_
 = 
çl£
;

312 
pŞicy_
 = 
I‹m
::
kInv®id
;

313 
cu¼I‹m_
.
	`»£t
();

314 
by‹sToDisÿrd_
 = 0;

315 
	}
}

317 
	gSessiÚ
::
»¶y
(
muduo
::
SŒšgP›û
 
msg
)

319 ià(!
nÜ•ly_
)

321 
cÚn_
->
£nd
(
msg
.
d©a
(), msg.
size
());

325 
boŞ
 
	gSessiÚ
::
doUpd©e
(
SessiÚ
::
Tok’iz”
::
™”©Ü
& 
beg
, SessiÚ::Tok’iz”::™”©Ü 
’d
)

327 ià(
commªd_
 == "set")

328 
pŞicy_
 = 
I‹m
::
kS‘
;

329 ià(
	gcommªd_
 == "add")

330 
pŞicy_
 = 
I‹m
::
kAdd
;

331 ià(
	gcommªd_
 == "replace")

332 
pŞicy_
 = 
I‹m
::
kR•Ïû
;

333 ià(
	gcommªd_
 == "append")

334 
pŞicy_
 = 
I‹m
::
kAµ’d
;

335 ià(
	gcommªd_
 == "prepend")

336 
pŞicy_
 = 
I‹m
::
kP»³nd
;

337 ià(
	gcommªd_
 == "cas")

338 
pŞicy_
 = 
I‹m
::
kCas
;

340 
as£¹
(
çl£
);

343 
SŒšgP›û
 
	gkey
 = (*
beg
);

344 ++
	gbeg
;

345 
boŞ
 
	ggood
 = 
key
.
size
(è<ğ
kLÚge¡KeySize
;

347 
ušt32_t
 
	gæags
 = 0;

348 
time_t
 
	gex±ime
 = 1;

349 
	gby‹s
 = -1;

350 
ušt64_t
 
	gÿs
 = 0;

352 
R—d”
 
r
(
beg
, 
’d
);

353 
	ggood
 = 
good
 && 
r
.
»ad
(&
æags
è&&„.»ad(&
ex±ime
è&&„.»ad(&
by‹s
);

355 
	g»l_ex±ime
 = 
¡©ic_ÿ¡
<>(
ex±ime
);

356 ià(
	gex±ime
 > 60*60*24*30)

358 
	g»l_ex±ime
 = 
¡©ic_ÿ¡
<>(
ex±ime
 - 
owÃr_
->
¡¬tTime
());

359 ià(
	g»l_ex±ime
 < 1)

361 
	g»l_ex±ime
 = 1;

369 ià(
	ggood
 && 
	gpŞicy_
 =ğ
I‹m
::
kCas
)

371 
good
 = 
r
.
»ad
(&
ÿs
);

374 ià(!
	ggood
)

376 
»¶y
("CLIENT_ERROR bad command†ine format\r\n");

377  
	gŒue
;

379 ià(
	gby‹s
 > 1024*1024)

381 
»¶y
("SERVER_ERROR objectoo†arge for cache\r\n");

382 
	gÃedË_
->
»£tKey
(
key
);

383 
	gowÃr_
->
d–‘eI‹m
(
ÃedË_
);

384 
	gby‹sToDisÿrd_
 = 
by‹s
 + 2;

385 
	g¡©e_
 = 
kDisÿrdV®ue
;

386  
	gçl£
;

390 
	gcu¼I‹m_
 = 
I‹m
::
makeI‹m
(
key
, 
æags
, 
»l_ex±ime
, 
by‹s
 + 2, 
ÿs
);

391 
	g¡©e_
 = 
kReûiveV®ue
;

392  
	gçl£
;

396 
	gSessiÚ
::
doD–‘e
(
SessiÚ
::
Tok’iz”
::
™”©Ü
& 
beg
, SessiÚ::Tok’iz”::™”©Ü 
’d
)

398 
as£¹
(
commªd_
 == "delete");

400 
SŒšgP›û
 
	gkey
 = *
beg
;

401 
boŞ
 
	ggood
 = 
key
.
size
(è<ğ
kLÚge¡KeySize
;

402 ++
	gbeg
;

403 ià(!
	ggood
)

405 
»¶y
("CLIENT_ERROR bad command†ine format\r\n");

407 ià(
	gbeg
 !ğ
’d
 && *
beg
 != "0")

409 
»¶y
("CLIENT_ERROR bad command†ine format. Usage: delete <key> [noreply]\r\n");

413 
	gÃedË_
->
»£tKey
(
key
);

414 ià(
	gowÃr_
->
d–‘eI‹m
(
ÃedË_
))

416 
»¶y
("DELETED\r\n");

420 
»¶y
("NOT_FOUND\r\n");

	@examples/memcached/server/Session.h

1 #iâdeà
MUDUO_EXAMPLES_MEMCACHED_SERVER_SESSION_H


2 
	#MUDUO_EXAMPLES_MEMCACHED_SERVER_SESSION_H


	)

4 
	~"I‹m.h
"

6 
	~<muduo/ba£/Loggšg.h
>

8 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

10 
	~<boo¡/bšd.hµ
>

11 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

12 
	~<boo¡/nÚcİyabË.hµ
>

13 
	~<boo¡/tok’iz”.hµ
>

15 
usšg
 
	gmuduo
::
¡ršg
;

17 
şass
 
	gMemÿcheS”v”
;

19 
şass
 
	gSessiÚ
 : 
boo¡
::
nÚcİyabË
,

20 
public
 
	gboo¡
::
’abË_sh¬ed_äom_this
<
SessiÚ
>

22 
public
:

23 
SessiÚ
(
MemÿcheS”v”
* 
owÃr
, cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

24 : 
owÃr_
(
owÃr
),

25 
cÚn_
(
cÚn
),

26 
¡©e_
(
kNewCommªd
),

27 
´ÙocŞ_
(
kAscii
),

28 
nÜ•ly_
(
çl£
),

29 
pŞicy_
(
I‹m
::
kInv®id
),

30 
by‹sToDisÿrd_
(0),

31 
ÃedË_
(
I‹m
::
makeI‹m
(
kLÚge¡Key
, 0, 0, 2, 0)),

32 
by‹sR—d_
(0),

33 
»que¡sProûs£d_
(0)

35 
	gcÚn_
->
£tMes§geC®lback
(

36 
boo¡
::
bšd
(&
SessiÚ
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

39 ~
SessiÚ
()

41 
	gLOG_INFO
 << "»que¡ ´oûs£d: " << 
	g»que¡sProûs£d_


42 << " iÅuˆbufã¸size: " << 
	gcÚn_
->
šputBufãr
()->
š‹º®C­ac™y
()

43 << " ouuˆbufã¸size: " << 
	gcÚn_
->
ouutBufãr
()->
š‹º®C­ac™y
();

46 
	g´iv©e
:

47 
	eS‹


49 
kNewCommªd
,

50 
	gkReûiveV®ue
,

51 
	gkDisÿrdV®ue
,

54 
	ePrÙocŞ


56 
	gkAscii
,

57 
	gkBš¬y
,

58 
	gkAuto
,

61 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

62 
muduo
::
Ãt
::
Bufãr
* 
buf
,

63 
muduo
::
Time¡amp
);

64 
ÚWr™eCom¶‘e
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

65 
»ûiveV®ue
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

66 
disÿrdV®ue
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

71 
boŞ
 
´oûssReque¡
(
muduo
::
SŒšgP›û
 
»que¡
);

72 
»£tReque¡
();

73 
»¶y
(
muduo
::
SŒšgP›û
 
msg
);

75 
	sS·ûS•¬©Ü


77 
»£t
() {}

78 
	g‹m¶©e
 <
ty³Çme
 
	gIÅutI‹¿tÜ
,y³Çm
	gTok’
>

79 
boŞ
 
İ”©Ü
()(
	gIÅutI‹¿tÜ
& 
	gÃxt
, 
IÅutI‹¿tÜ
 
	g’d
, 
	gTok’
& 
	gtok
);

82 
	gboo¡
::
	ttok’iz”
<
	tS·ûS•¬©Ü
,

84 
	tmuduo
::
	tSŒšgP›û
> 
	tTok’iz”
;

85 
	gR—d”
;

86 
boŞ
 
doUpd©e
(
Tok’iz”
::
™”©Ü
& 
beg
, Tok’iz”::™”©Ü 
’d
);

87 
doD–‘e
(
Tok’iz”
::
™”©Ü
& 
beg
, Tok’iz”::™”©Ü 
’d
);

89 
MemÿcheS”v”
* 
	gowÃr_
;

90 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn_
;

91 
S‹
 
	g¡©e_
;

92 
PrÙocŞ
 
	g´ÙocŞ_
;

95 
¡ršg
 
	gcommªd_
;

96 
boŞ
 
	gnÜ•ly_
;

97 
	gI‹m
::
Upd©ePŞicy
 
pŞicy_
;

98 
I‹mPŒ
 
	gcu¼I‹m_
;

99 
size_t
 
	gby‹sToDisÿrd_
;

101 
I‹mPŒ
 
	gÃedË_
;

102 
	gmuduo
::
Ãt
::
Bufãr
 
ouutBuf_
;

105 
size_t
 
	gby‹sR—d_
;

106 
size_t
 
	g»que¡sProûs£d_
;

108 
¡ršg
 
	gkLÚge¡Key
;

111 
	gboo¡
::
	tsh¬ed_±r
<
	tSessiÚ
> 
	tSessiÚPŒ
;

	@examples/memcached/server/Session.h

1 #iâdeà
MUDUO_EXAMPLES_MEMCACHED_SERVER_SESSION_H


2 
	#MUDUO_EXAMPLES_MEMCACHED_SERVER_SESSION_H


	)

4 
	~"I‹m.h
"

6 
	~<muduo/ba£/Loggšg.h
>

8 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

10 
	~<boo¡/bšd.hµ
>

11 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

12 
	~<boo¡/nÚcİyabË.hµ
>

13 
	~<boo¡/tok’iz”.hµ
>

15 
usšg
 
	gmuduo
::
¡ršg
;

17 
şass
 
	gMemÿcheS”v”
;

19 
şass
 
	gSessiÚ
 : 
boo¡
::
nÚcİyabË
,

20 
public
 
	gboo¡
::
’abË_sh¬ed_äom_this
<
SessiÚ
>

22 
public
:

23 
SessiÚ
(
MemÿcheS”v”
* 
owÃr
, cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

24 : 
owÃr_
(
owÃr
),

25 
cÚn_
(
cÚn
),

26 
¡©e_
(
kNewCommªd
),

27 
´ÙocŞ_
(
kAscii
),

28 
nÜ•ly_
(
çl£
),

29 
pŞicy_
(
I‹m
::
kInv®id
),

30 
by‹sToDisÿrd_
(0),

31 
ÃedË_
(
I‹m
::
makeI‹m
(
kLÚge¡Key
, 0, 0, 2, 0)),

32 
by‹sR—d_
(0),

33 
»que¡sProûs£d_
(0)

35 
	gcÚn_
->
£tMes§geC®lback
(

36 
boo¡
::
bšd
(&
SessiÚ
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

39 ~
SessiÚ
()

41 
	gLOG_INFO
 << "»que¡ ´oûs£d: " << 
	g»que¡sProûs£d_


42 << " iÅuˆbufã¸size: " << 
	gcÚn_
->
šputBufãr
()->
š‹º®C­ac™y
()

43 << " ouuˆbufã¸size: " << 
	gcÚn_
->
ouutBufãr
()->
š‹º®C­ac™y
();

46 
	g´iv©e
:

47 
	eS‹


49 
kNewCommªd
,

50 
	gkReûiveV®ue
,

51 
	gkDisÿrdV®ue
,

54 
	ePrÙocŞ


56 
	gkAscii
,

57 
	gkBš¬y
,

58 
	gkAuto
,

61 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

62 
muduo
::
Ãt
::
Bufãr
* 
buf
,

63 
muduo
::
Time¡amp
);

64 
ÚWr™eCom¶‘e
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

65 
»ûiveV®ue
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

66 
disÿrdV®ue
(
muduo
::
Ãt
::
Bufãr
* 
buf
);

71 
boŞ
 
´oûssReque¡
(
muduo
::
SŒšgP›û
 
»que¡
);

72 
»£tReque¡
();

73 
»¶y
(
muduo
::
SŒšgP›û
 
msg
);

75 
	sS·ûS•¬©Ü


77 
»£t
() {}

78 
	g‹m¶©e
 <
ty³Çme
 
	gIÅutI‹¿tÜ
,y³Çm
	gTok’
>

79 
boŞ
 
İ”©Ü
()(
	gIÅutI‹¿tÜ
& 
	gÃxt
, 
IÅutI‹¿tÜ
 
	g’d
, 
	gTok’
& 
	gtok
);

82 
	gboo¡
::
	ttok’iz”
<
	tS·ûS•¬©Ü
,

84 
	tmuduo
::
	tSŒšgP›û
> 
	tTok’iz”
;

85 
	gR—d”
;

86 
boŞ
 
doUpd©e
(
Tok’iz”
::
™”©Ü
& 
beg
, Tok’iz”::™”©Ü 
’d
);

87 
doD–‘e
(
Tok’iz”
::
™”©Ü
& 
beg
, Tok’iz”::™”©Ü 
’d
);

89 
MemÿcheS”v”
* 
	gowÃr_
;

90 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn_
;

91 
S‹
 
	g¡©e_
;

92 
PrÙocŞ
 
	g´ÙocŞ_
;

95 
¡ršg
 
	gcommªd_
;

96 
boŞ
 
	gnÜ•ly_
;

97 
	gI‹m
::
Upd©ePŞicy
 
pŞicy_
;

98 
I‹mPŒ
 
	gcu¼I‹m_
;

99 
size_t
 
	gby‹sToDisÿrd_
;

101 
I‹mPŒ
 
	gÃedË_
;

102 
	gmuduo
::
Ãt
::
Bufãr
 
ouutBuf_
;

105 
size_t
 
	gby‹sR—d_
;

106 
size_t
 
	g»que¡sProûs£d_
;

108 
¡ršg
 
	gkLÚge¡Key
;

111 
	gboo¡
::
	tsh¬ed_±r
<
	tSessiÚ
> 
	tSessiÚPŒ
;

	@examples/memcached/server/footprint_test.cc

1 
	~"MemÿcheS”v”.h
"

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/š¥eù/ProûssIn¥eùÜ.h
>

5 
	~<¡dio.h
>

6 #ifdeà
HAVE_TCMALLOC


7 
	~<g³ráoŞs/h—p-´of”.h
>

8 
	~<g³ráoŞs/m®loc_ex‹nsiÚ.h
>

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 
	$maš
(
¬gc
, * 
¬gv
[])

15 #ifdeà
HAVE_TCMALLOC


16 
M®locEx‹nsiÚ
::
	`In™Ÿlize
();

18 
™ems
 = 
¬gc
 > 1 ? 
	`©oi
(
¬gv
[1]) : 10000;

19 
keyËn
 = 
¬gc
 > 2 ? 
	`©oi
(
¬gv
[2]) : 10;

20 
v®u–’
 = 
¬gc
 > 3 ? 
	`©oi
(
¬gv
[3]) : 100;

21 
Ev’tLoİ
 
loİ
;

22 
MemÿcheS”v”
::
O±iÚs
 
İtiÚs
;

23 
MemÿcheS”v”
 
	`£rv”
(&
loİ
, 
İtiÚs
);

25 
	`´štf
("sizeof(Item) = %zd\npid = %d\nitems = %d\nkeylen = %d\nvaluelen = %d\n",

26 (
I‹m
), 
	`g‘pid
(), 
™ems
, 
keyËn
, 
v®u–’
);

27 
key
[256] = { 0 };

28 
¡ršg
 
v®ue
;

29 
i
 = 0; i < 
™ems
; ++i)

31 
	`¢´štf
(
key
,  key, "%0*d", 
keyËn
, 
i
);

32 
v®ue
.
	`assign
(
v®u–’
, "0123456789"[
i
 % 10]);

33 
I‹mPŒ
 
	`™em
(
I‹m
::
	`makeI‹m
(
key
, 0, 0, 
v®u–’
+2, 1));

34 
™em
->
	`­³nd
(
v®ue
.
	`d©a
(), v®ue.
	`size
());

35 
™em
->
	`­³nd
("\r\n", 2);

36 
	`as£¹
(
™em
->
	`’dsW™hCRLF
());

37 
boŞ
 
exi¡s
 = 
çl£
;

38 
boŞ
 
¡Üed
 = 
£rv”
.
	`¡ÜeI‹m
(
™em
, 
I‹m
::
kAdd
, &
exi¡s
);

39 
	`as£¹
(
¡Üed
); () stored;

40 
	`as£¹
(!
exi¡s
);

42 
In¥eùÜ
::
ArgLi¡
 
¬g
;

43 
	`´štf
("==========\n%s\n",

44 
ProûssIn¥eùÜ
::
	`ov”v›w
(
H‰pReque¡
::
kG‘
, 
¬g
).
	`c_¡r
());

46 
	`fæush
(
¡dout
);

47 #ifdeà
HAVE_TCMALLOC


48 
buf
[8192];

49 
M®locEx‹nsiÚ
::
	`š¡ªû
()->
	`G‘Sts
(
buf
,  buf);

50 
	`´štf
("%s\n", 
buf
);

51 
	`H—pProf”Dump
("end");

66 
	}
}

	@examples/memcached/server/server.cc

1 
	~"MemÿcheS”v”.h
"

3 
	~<muduo/Ãt/Ev’tLoİ.h
>

4 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

5 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

7 
	~<boo¡/´og¿m_İtiÚs.hµ
>

9 
Çme¥aû
 
	gpo
 = 
boo¡
::
´og¿m_İtiÚs
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

12 
boŞ
 
·r£CommªdLše
(
¬gc
, * 
¬gv
[], 
MemÿcheS”v”
::
O±iÚs
* 
İtiÚs
)

14 
İtiÚs
->
tıpÜt
 = 11211;

15 
	gİtiÚs
->
	gg³råÜt
 = 11212;

16 
	gİtiÚs
->
	gth»ads
 = 4;

18 
	gpo
::
İtiÚs_desütiÚ
 
desc
("Allowed options");

19 
	gdesc
.
add_İtiÚs
()

21 ("pÜt,p", 
	gpo
::
v®ue
<
ušt16_t
>(&
İtiÚs
->
tıpÜt
), "TCP…ort")

22 ("udµÜt,U", 
	gpo
::
v®ue
<
ušt16_t
>(&
İtiÚs
->
udµÜt
), "UDP…ort")

23 ("g³rf,g", 
	gpo
::
v®ue
<
ušt16_t
>(&
İtiÚs
->
g³råÜt
), "port for gperftools")

24 ("th»ads,t", 
	gpo
::
v®ue
<>(&
İtiÚs
->
th»ads
), "Number of workerhreads")

27 
	gpo
::
v¬ŸbËs_m­
 
vm
;

28 
	gpo
::
¡Üe
(
po
::
·r£_commªd_lše
(
¬gc
, 
¬gv
, 
desc
), 
vm
);

29 
	gpo
::
nÙify
(
vm
);

31 ià(
	gvm
.
couÁ
("help"))

34  
	gçl£
;

36  
	gŒue
;

39 
	$maš
(
¬gc
, * 
¬gv
[])

41 
Ev’tLoİ
 
loİ
;

42 
Ev’tLoİTh»ad
 
š¥eùTh»ad
;

43 
MemÿcheS”v”
::
O±iÚs
 
İtiÚs
;

44 ià(
	`·r£CommªdLše
(
¬gc
, 
¬gv
, &
İtiÚs
))

47 
Ãw
 
	`In¥eùÜ
(
š¥eùTh»ad
.
	`¡¬tLoİ
(), 
	`IÃtAdd»ss
(
İtiÚs
.
g³råÜt
), "memcached-debug");

49 
MemÿcheS”v”
 
	`£rv”
(&
loİ
, 
İtiÚs
);

50 
£rv”
.
	`£tTh»adNum
(
İtiÚs
.
th»ads
);

51 
£rv”
.
	`¡¬t
();

52 
loİ
.
	`loİ
();

54 
	}
}

	@examples/multiplexer/demux.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/IÃtAdd»ss.h
>

4 
	~<muduo/Ãt/TıCl›Á.h
>

5 
	~<muduo/Ãt/TıS”v”.h
>

7 
	~<boo¡/bšd.hµ
>

9 
	~<queue
>

10 
	~<ut™y
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 
	gboo¡
::
	tsh¬ed_±r
<
	tTıCl›Á
> 
	tTıCl›ÁPŒ
;

21 cÚ¡ 
size_t
 
	gkMaxPack‘L’
 = 255;

22 cÚ¡ 
size_t
 
	gkH—d”L’
 = 3;

24 cÚ¡ 
ušt16_t
 
	gkLi¡’PÜt
 = 9999;

25 cÚ¡ * 
	gsocksIp
 = "127.0.0.1";

26 cÚ¡ 
ušt16_t
 
	gkSocksPÜt
 = 7777;

28 
	sEÁry


30 
	mcÚnId
;

31 
TıCl›ÁPŒ
 
	mş›Á
;

32 
TıCÚÃùiÚPŒ
 
	mcÚÃùiÚ
;

33 
Bufãr
 
	m³ndšg
;

36 şas 
	cDemuxS”v”
 : 
boo¡
::
nÚcİyabË


38 
public
:

39 
	$DemuxS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, cÚ¡ IÃtAdd»ss& 
socksAddr
)

40 : 
	`loİ_
(
loİ
),

41 
	`£rv”_
(
loİ
, 
li¡’Addr
, "DemuxServer"),

42 
	$socksAddr_
(
socksAddr
)

44 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

45 
boo¡
::
	`bšd
(&
DemuxS”v”
::
ÚS”v”CÚÃùiÚ
, 
this
, 
_1
));

46 
£rv”_
.
	`£tMes§geC®lback
(

47 
boo¡
::
	`bšd
(&
DemuxS”v”
::
ÚS”v”Mes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

50 
	$¡¬t
()

52 
£rv”_
.
	`¡¬t
();

53 
	}
}

55 
	$ÚS”v”CÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

57 ià(
cÚn
->
	`cÚÃùed
())

59 ià(
£rv”CÚn_
)

61 
cÚn
->
	`shutdown
();

65 
£rv”CÚn_
 = 
cÚn
;

66 
LOG_INFO
 << "onServerConnection set serverConn_";

71 ià(
£rv”CÚn_
 =ğ
cÚn
)

73 
£rv”CÚn_
.
	`»£t
();

74 
socksCÚns_
.
	`ş—r
();

76 
LOG_INFO
 << "onServerConnection„eset serverConn_";

79 
	}
}

81 
	$ÚS”v”Mes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

83 
buf
->
	`»adabËBy‹s
(è> 
kH—d”L’
)

85 
Ën
 = 
¡©ic_ÿ¡
<
ušt8_t
>(*
buf
->
	`³ek
());

86 ià(
buf
->
	`»adabËBy‹s
(è< 
Ën
 + 
kH—d”L’
)

92 
cÚnId
 = 
¡©ic_ÿ¡
<
ušt8_t
>(
buf
->
	`³ek
()[1]);

93 
cÚnId
 |ğ(
¡©ic_ÿ¡
<
ušt8_t
>(
buf
->
	`³ek
()[2]) << 8);

95 ià(
cÚnId
 != 0)

97 
	`as£¹
(
socksCÚns_
.
	`fšd
(
cÚnId
è!ğsocksCÚns_.
	`’d
());

98 
TıCÚÃùiÚPŒ
& 
socksCÚn
 = 
socksCÚns_
[
cÚnId
].
cÚÃùiÚ
;

99 ià(
socksCÚn
)

101 
	`as£¹
(
socksCÚns_
[
cÚnId
].
³ndšg
.
	`»adabËBy‹s
() == 0);

102 
socksCÚn
->
	`£nd
(
buf
->
	`³ek
(è+ 
kH—d”L’
, 
Ën
);

106 
socksCÚns_
[
cÚnId
].
³ndšg
.
	`­³nd
(
buf
->
	`³ek
(è+ 
kH—d”L’
, 
Ën
);

111 
¡ršg
 
	`cmd
(
buf
->
	`³ek
(è+ 
kH—d”L’
, 
Ën
);

112 
	`doCommªd
(
cmd
);

114 
buf
->
	`»Œ›ve
(
Ën
 + 
kH—d”L’
);

117 
	}
}

119 
	$doCommªd
(cÚ¡ 
¡ršg
& 
cmd
)

121 cÚ¡ 
¡ršg
 
kCÚn
 = "CONN ";

123 
cÚnId
 = 
	`©oi
(&
cmd
[
kCÚn
.
	`size
()]);

124 
boŞ
 
isUp
 = 
cmd
.
	`fšd
(" IS UP"è!ğ
¡ršg
::
Åos
;

125 
LOG_INFO
 << "doCommªd " << 
cÚnId
 << " " << 
isUp
;

126 ià(
isUp
)

128 
	`as£¹
(
socksCÚns_
.
	`fšd
(
cÚnId
è=ğsocksCÚns_.
	`’d
());

129 
cÚnName
[256];

130 
	`¢´štf
(
cÚnName
,  cÚnName, "SocksCl›Á %d", 
cÚnId
);

131 
EÁry
 
’Œy
;

132 
’Œy
.
cÚnId
 = connId;

133 
’Œy
.
ş›Á
.
	`»£t
(
Ãw
 
	`TıCl›Á
(
loİ_
, 
socksAddr_
, 
cÚnName
));

134 
’Œy
.
ş›Á
->
	`£tCÚÃùiÚC®lback
(

135 
boo¡
::
	`bšd
(&
DemuxS”v”
::
ÚSocksCÚÃùiÚ
, 
this
, 
cÚnId
, 
_1
));

136 
’Œy
.
ş›Á
->
	`£tMes§geC®lback
(

137 
boo¡
::
	`bšd
(&
DemuxS”v”
::
ÚSocksMes§ge
, 
this
, 
cÚnId
, 
_1
, 
_2
, 
_3
));

139 
socksCÚns_
[
cÚnId
] = 
’Œy
;

140 
’Œy
.
ş›Á
->
	`cÚÃù
();

144 
	`as£¹
(
socksCÚns_
.
	`fšd
(
cÚnId
è!ğsocksCÚns_.
	`’d
());

145 
TıCÚÃùiÚPŒ
& 
socksCÚn
 = 
socksCÚns_
[
cÚnId
].
cÚÃùiÚ
;

146 ià(
socksCÚn
)

148 
socksCÚn
->
	`shutdown
();

152 
socksCÚns_
.
	`”a£
(
cÚnId
);

155 
	}
}

157 
	$ÚSocksCÚÃùiÚ
(
cÚnId
, cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

159 
	`as£¹
(
socksCÚns_
.
	`fšd
(
cÚnId
è!ğsocksCÚns_.
	`’d
());

160 ià(
cÚn
->
	`cÚÃùed
())

162 
socksCÚns_
[
cÚnId
].
cÚÃùiÚ
 = 
cÚn
;

163 
Bufãr
& 
³ndšgD©a
 = 
socksCÚns_
[
cÚnId
].
³ndšg
;

164 ià(
³ndšgD©a
.
	`»adabËBy‹s
() > 0)

166 
cÚn
->
	`£nd
(&
³ndšgD©a
);

171 ià(
£rv”CÚn_
)

173 
buf
[256];

174 
Ën
 = 
	`¢´štf
(
buf
, (buf), "DISCONNECT %d\r\n", 
cÚnId
);

175 
Bufãr
 
bufãr
;

176 
bufãr
.
	`­³nd
(
buf
, 
Ën
);

177 
	`£ndS”v”Pack‘
(0, &
bufãr
);

181 
socksCÚns_
.
	`”a£
(
cÚnId
);

184 
	}
}

186 
	$ÚSocksMes§ge
(
cÚnId
, cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

188 
	`as£¹
(
socksCÚns_
.
	`fšd
(
cÚnId
è!ğsocksCÚns_.
	`’d
());

189 
buf
->
	`»adabËBy‹s
(è> 
kMaxPack‘L’
)

191 
Bufãr
 
·ck‘
;

192 
·ck‘
.
	`­³nd
(
buf
->
	`³ek
(), 
kMaxPack‘L’
);

193 
buf
->
	`»Œ›ve
(
kMaxPack‘L’
);

194 
	`£ndS”v”Pack‘
(
cÚnId
, &
·ck‘
);

196 ià(
buf
->
	`»adabËBy‹s
() > 0)

198 
	`£ndS”v”Pack‘
(
cÚnId
, 
buf
);

200 
	}
}

202 
	$£ndS”v”Pack‘
(
cÚnId
, 
Bufãr
* 
buf
)

204 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

205 
LOG_DEBUG
 << 
Ën
;

206 
	`as£¹
(
Ën
 <ğ
kMaxPack‘L’
);

207 
ušt8_t
 
h—d”
[
kH—d”L’
] = {

208 
¡©ic_ÿ¡
<
ušt8_t
>(
Ën
),

209 
¡©ic_ÿ¡
<
ušt8_t
>(
cÚnId
 & 0xFF),

210 
¡©ic_ÿ¡
<
ušt8_t
>((
cÚnId
 & 0xFF00) >> 8)

212 
buf
->
	`´•’d
(
h—d”
, 
kH—d”L’
);

213 ià(
£rv”CÚn_
)

215 
£rv”CÚn_
->
	`£nd
(
buf
);

217 
	}
}

219 
Ev’tLoİ
* 
	gloİ_
;

220 
TıS”v”
 
	g£rv”_
;

221 
TıCÚÃùiÚPŒ
 
	g£rv”CÚn_
;

222 cÚ¡ 
IÃtAdd»ss
 
	gsocksAddr_
;

223 
	g¡d
::
m­
<, 
	gEÁry
> 
	gsocksCÚns_
;

226 
	$maš
(
¬gc
, * 
¬gv
[])

228 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

229 
Ev’tLoİ
 
loİ
;

230 
IÃtAdd»ss
 
	`li¡’Addr
(
kLi¡’PÜt
);

231 ià(
¬gc
 > 1)

233 
socksIp
 = 
¬gv
[1];

235 
IÃtAdd»ss
 
	`socksAddr
(
socksIp
, 
kSocksPÜt
);

236 
DemuxS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
socksAddr
);

238 
£rv”
.
	`¡¬t
();

240 
loİ
.
	`loİ
();

241 
	}
}

	@examples/multiplexer/multiplexer.cc

1 
	~<muduo/ba£/Atomic.h
>

2 
	~<muduo/ba£/Loggšg.h
>

3 
	~<muduo/ba£/Mu‹x.h
>

4 
	~<muduo/ba£/Th»ad.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

7 
	~<muduo/Ãt/TıCl›Á.h
>

8 
	~<muduo/Ãt/TıS”v”.h
>

10 
	~<boo¡/bšd.hµ
>

12 
	~<queue
>

13 
	~<ut™y
>

15 
	~<¡dio.h
>

16 
	~<uni¡d.h
>

18 
usšg
 
Çme¥aû
 
	gmuduo
;

19 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

21 cÚ¡ 
	gkMaxCÚns
 = 10;

22 cÚ¡ 
size_t
 
	gkMaxPack‘L’
 = 255;

23 cÚ¡ 
size_t
 
	gkH—d”L’
 = 3;

25 cÚ¡ 
ušt16_t
 
	gkCl›ÁPÜt
 = 3333;

26 cÚ¡ * 
	gback’dIp
 = "127.0.0.1";

27 cÚ¡ 
ušt16_t
 
	gkBack’dPÜt
 = 9999;

29 şas 
	cMuÉËxS”v”


31 
	mpublic
:

32 
	$MuÉËxS”v”
(
Ev’tLoİ
* 
loİ
,

33 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

34 cÚ¡ 
IÃtAdd»ss
& 
back’dAddr
,

35 
numTh»ads
)

36 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "MultiplexServer"),

37 
	`back’d_
(
loİ
, 
back’dAddr
, "MultiplexBackend"),

38 
	`numTh»ads_
(
numTh»ads
),

39 
	`ŞdCouÁ”_
(0),

40 
	`¡¬tTime_
(
Time¡amp
::
	$now
())

42 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

43 
boo¡
::
	`bšd
(&
MuÉËxS”v”
::
ÚCl›ÁCÚÃùiÚ
, 
this
, 
_1
));

44 
£rv”_
.
	`£tMes§geC®lback
(

45 
boo¡
::
	`bšd
(&
MuÉËxS”v”
::
ÚCl›ÁMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

46 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

48 
back’d_
.
	`£tCÚÃùiÚC®lback
(

49 
boo¡
::
	`bšd
(&
MuÉËxS”v”
::
ÚBack’dCÚÃùiÚ
, 
this
, 
_1
));

50 
back’d_
.
	`£tMes§geC®lback
(

51 
boo¡
::
	`bšd
(&
MuÉËxS”v”
::
ÚBack’dMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

52 
back’d_
.
	`’abËR‘ry
();

58 
	$¡¬t
()

60 
LOG_INFO
 << "¡¬tšg " << 
numTh»ads_
 << "hreads.";

61 
back’d_
.
	`cÚÃù
();

62 
£rv”_
.
	`¡¬t
();

63 
	}
}

65 
	g´iv©e
:

66 
	$£ndBack’dPack‘
(
id
, 
Bufãr
* 
buf
)

68 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

69 
	`as£¹
(
Ën
 <ğ
kMaxPack‘L’
);

70 
ušt8_t
 
h—d”
[
kH—d”L’
] = {

71 
¡©ic_ÿ¡
<
ušt8_t
>(
Ën
),

72 
¡©ic_ÿ¡
<
ušt8_t
>(
id
 & 0xFF),

73 
¡©ic_ÿ¡
<
ušt8_t
>((
id
 & 0xFF00) >> 8)

75 
buf
->
	`´•’d
(
h—d”
, 
kH—d”L’
);

76 
TıCÚÃùiÚPŒ
 
back’dCÚn
;

78 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

79 
back’dCÚn
 = 
back’dCÚn_
;

81 ià(
back’dCÚn
)

83 
back’dCÚn
->
	`£nd
(
buf
);

85 
	}
}

87 
	$£ndBack’dSŒšg
(
id
, cÚ¡ 
¡ršg
& 
msg
)

89 
	`as£¹
(
msg
.
	`size
(è<ğ
kMaxPack‘L’
);

90 
Bufãr
 
buf
;

91 
buf
.
	`­³nd
(
msg
);

92 
	`£ndBack’dPack‘
(
id
, &
buf
);

93 
	}
}

95 
	$£ndBack’dBufãr
(
id
, 
Bufãr
* 
buf
)

97 
buf
->
	`»adabËBy‹s
(è> 
kMaxPack‘L’
)

99 
Bufãr
 
·ck‘
;

100 
·ck‘
.
	`­³nd
(
buf
->
	`³ek
(), 
kMaxPack‘L’
);

101 
buf
->
	`»Œ›ve
(
kMaxPack‘L’
);

102 
	`£ndBack’dPack‘
(
id
, &
·ck‘
);

104 ià(
buf
->
	`»adabËBy‹s
() > 0)

106 
	`£ndBack’dPack‘
(
id
, 
buf
);

108 
	}
}

110 
	$£ndToCl›Á
(
Bufãr
* 
buf
)

112 
buf
->
	`»adabËBy‹s
(è> 
kH—d”L’
)

114 
Ën
 = 
¡©ic_ÿ¡
<
ušt8_t
>(*
buf
->
	`³ek
());

115 ià(
buf
->
	`»adabËBy‹s
(è< 
Ën
 + 
kH—d”L’
)

121 
id
 = 
¡©ic_ÿ¡
<
ušt8_t
>(
buf
->
	`³ek
()[1]);

122 
id
 |ğ(
¡©ic_ÿ¡
<
ušt8_t
>(
buf
->
	`³ek
()[2]) << 8);

124 
TıCÚÃùiÚPŒ
 
ş›ÁCÚn
;

126 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

127 
¡d
::
m­
<, 
TıCÚÃùiÚPŒ
>::
™”©Ü
 
™
 = 
ş›ÁCÚns_
.
	`fšd
(
id
);

128 ià(
™
 !ğ
ş›ÁCÚns_
.
	`’d
())

130 
ş›ÁCÚn
 = 
™
->
£cÚd
;

133 ià(
ş›ÁCÚn
)

135 
ş›ÁCÚn
->
	`£nd
(
buf
->
	`³ek
(è+ 
kH—d”L’
, 
Ën
);

137 
buf
->
	`»Œ›ve
(
Ën
 + 
kH—d”L’
);

140 
	}
}

142 
	$ÚCl›ÁCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

144 
LOG_TRACE
 << "Cl›Á " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

145 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

146 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

147 ià(
cÚn
->
	`cÚÃùed
())

149 
id
 = -1;

151 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

152 ià(!
avaIds_
.
	`em±y
())

154 
id
 = 
avaIds_
.
	`äÚt
();

155 
avaIds_
.
	`pİ
();

156 
ş›ÁCÚns_
[
id
] = 
cÚn
;

160 ià(
id
 <= 0)

162 
cÚn
->
	`shutdown
();

166 
cÚn
->
	`£tCÚ‹xt
(
id
);

167 
buf
[256];

168 
	`¢´štf
(
buf
, (buf), "CONN %d FROM % IS UP\r\n", 
id
,

169 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
().
	`c_¡r
());

170 
	`£ndBack’dSŒšg
(0, 
buf
);

175 ià(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
())

177 
id
 = 
boo¡
::
ªy_ÿ¡
<>(
cÚn
->
	`g‘CÚ‹xt
());

178 
	`as£¹
(
id
 > 0 && id <ğ
kMaxCÚns
);

179 
buf
[256];

180 
	`¢´štf
(
buf
, (buf), "CONN %d FROM %s IS DOWN\r\n",

181 
id
, 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
().
	`c_¡r
());

182 
	`£ndBack’dSŒšg
(0, 
buf
);

184 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

185 ià(
back’dCÚn_
)

187 
avaIds_
.
	`push
(
id
);

188 
ş›ÁCÚns_
.
	`”a£
(
id
);

192 
	`as£¹
(
avaIds_
.
	`em±y
());

193 
	`as£¹
(
ş›ÁCÚns_
.
	`em±y
());

197 
	}
}

199 
	$ÚCl›ÁMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

201 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

202 
Œªsã¼ed_
.
	`addAndG‘
(
Ën
);

203 
»ûivedMes§ges_
.
	`šüem’tAndG‘
();

204 ià(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
())

206 
id
 = 
boo¡
::
ªy_ÿ¡
<>(
cÚn
->
	`g‘CÚ‹xt
());

207 
	`£ndBack’dBufãr
(
id
, 
buf
);

212 
buf
->
	`»Œ›veAÎ
();

215 
	}
}

217 
	$ÚBack’dCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

219 
LOG_TRACE
 << "Back’d " << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

220 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

221 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

222 
¡d
::
veùÜ
<
TıCÚÃùiÚPŒ
> 
cÚnsToDe¡roy
;

223 ià(
cÚn
->
	`cÚÃùed
())

225 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

226 
back’dCÚn_
 = 
cÚn
;

227 
	`as£¹
(
avaIds_
.
	`em±y
());

228 
i
 = 1; i <ğ
kMaxCÚns
; ++i)

230 
avaIds_
.
	`push
(
i
);

235 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

236 
back’dCÚn_
.
	`»£t
();

237 
cÚnsToDe¡roy
.
	`»£rve
(
ş›ÁCÚns_
.
	`size
());

238 
¡d
::
m­
<, 
TıCÚÃùiÚPŒ
>::
™”©Ü
 
™
 = 
ş›ÁCÚns_
.
	`begš
();

239 
™
 !ğ
ş›ÁCÚns_
.
	`’d
();

240 ++
™
)

242 
cÚnsToDe¡roy
.
	`push_back
(
™
->
£cÚd
);

244 
ş›ÁCÚns_
.
	`ş—r
();

245 !
avaIds_
.
	`em±y
())

247 
avaIds_
.
	`pİ
();

251 
¡d
::
veùÜ
<
TıCÚÃùiÚPŒ
>::
™”©Ü
 
™
 = 
cÚnsToDe¡roy
.
	`begš
();

252 
™
 !ğ
cÚnsToDe¡roy
.
	`’d
();

253 ++
™
)

255 (*
™
)->
	`shutdown
();

257 
	}
}

259 
	$ÚBack’dMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

261 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

262 
Œªsã¼ed_
.
	`addAndG‘
(
Ën
);

263 
»ûivedMes§ges_
.
	`šüem’tAndG‘
();

264 
	`£ndToCl›Á
(
buf
);

265 
	}
}

267 
	$´štSti¡ics
()

269 
Time¡amp
 
’dTime
 = Time¡amp::
	`now
();

270 
št64_t
 
ÃwCouÁ”
 = 
Œªsã¼ed_
.
	`g‘
();

271 
št64_t
 
by‹s
 = 
ÃwCouÁ”
 - 
ŞdCouÁ”_
;

272 
št64_t
 
msgs
 = 
»ûivedMes§ges_
.
	`g‘AndS‘
(0);

273 
time
 = 
	`timeDifã»nû
(
’dTime
, 
¡¬tTime_
);

274 
	`´štf
("%4.3f MiB/s %4.3f Ki Msgs/s %6.2f bytes…er msg\n",

275 
¡©ic_ÿ¡
<>(
by‹s
)/
time
/1024/1024,

276 
¡©ic_ÿ¡
<>(
msgs
)/
time
/1024,

277 
¡©ic_ÿ¡
<>(
by‹s
)/¡©ic_ÿ¡<>(
msgs
));

279 
ŞdCouÁ”_
 = 
ÃwCouÁ”
;

280 
¡¬tTime_
 = 
’dTime
;

281 
	}
}

283 
TıS”v”
 
	g£rv”_
;

284 
TıCl›Á
 
	gback’d_
;

285 
	gnumTh»ads_
;

286 
AtomicIÁ64
 
	gŒªsã¼ed_
;

287 
AtomicIÁ64
 
	g»ûivedMes§ges_
;

288 
št64_t
 
	gŞdCouÁ”_
;

289 
Time¡amp
 
	g¡¬tTime_
;

290 
Mu‹xLock
 
	gmu‹x_
;

291 
TıCÚÃùiÚPŒ
 
	gback’dCÚn_
;

292 
	g¡d
::
m­
<, 
	gTıCÚÃùiÚPŒ
> 
	gş›ÁCÚns_
;

293 
	g¡d
::
queue
<> 
avaIds_
;

296 
	$maš
(
¬gc
, * 
¬gv
[])

298 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

299 
numTh»ads
 = 4;

300 ià(
¬gc
 > 1)

302 
back’dIp
 = 
¬gv
[1];

304 ià(
¬gc
 > 2)

306 
numTh»ads
 = 
	`©oi
(
¬gv
[2]);

308 
Ev’tLoİ
 
loİ
;

309 
IÃtAdd»ss
 
	`li¡’Addr
(
kCl›ÁPÜt
);

310 
IÃtAdd»ss
 
	`back’dAddr
(
back’dIp
, 
kBack’dPÜt
);

311 
MuÉËxS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
back’dAddr
, 
numTh»ads
);

313 
£rv”
.
	`¡¬t
();

315 
loİ
.
	`loİ
();

316 
	}
}

	@examples/multiplexer/multiplexer_simple.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/IÃtAdd»ss.h
>

4 
	~<muduo/Ãt/TıCl›Á.h
>

5 
	~<muduo/Ãt/TıS”v”.h
>

7 
	~<boo¡/bšd.hµ
>

9 
	~<queue
>

10 
	~<ut™y
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 cÚ¡ 
	gkMaxCÚns
 = 10;

19 cÚ¡ 
size_t
 
	gkMaxPack‘L’
 = 255;

20 cÚ¡ 
size_t
 
	gkH—d”L’
 = 3;

22 cÚ¡ 
ušt16_t
 
	gkCl›ÁPÜt
 = 3333;

23 cÚ¡ * 
	gback’dIp
 = "127.0.0.1";

24 cÚ¡ 
ušt16_t
 
	gkBack’dPÜt
 = 9999;

26 şas 
	cMuÉËxS”v”
 : 
boo¡
::
nÚcİyabË


28 
public
:

29 
	$MuÉËxS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, cÚ¡ IÃtAdd»ss& 
back’dAddr
)

30 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "MultiplexServer"),

31 
	`back’d_
(
loİ
, 
back’dAddr
, "MultiplexBackend")

33 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

34 
boo¡
::
	`bšd
(&
MuÉËxS”v”
::
ÚCl›ÁCÚÃùiÚ
, 
this
, 
_1
));

35 
£rv”_
.
	`£tMes§geC®lback
(

36 
boo¡
::
	`bšd
(&
MuÉËxS”v”
::
ÚCl›ÁMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

37 
back’d_
.
	`£tCÚÃùiÚC®lback
(

38 
boo¡
::
	`bšd
(&
MuÉËxS”v”
::
ÚBack’dCÚÃùiÚ
, 
this
, 
_1
));

39 
back’d_
.
	`£tMes§geC®lback
(

40 
boo¡
::
	`bšd
(&
MuÉËxS”v”
::
ÚBack’dMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

41 
back’d_
.
	`’abËR‘ry
();

44 
	$¡¬t
()

46 
back’d_
.
	`cÚÃù
();

47 
£rv”_
.
	`¡¬t
();

48 
	}
}

50 
	g´iv©e
:

52 
	$ÚCl›ÁCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

54 
LOG_TRACE
 << "Cl›Á " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

55 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

56 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

57 ià(
cÚn
->
	`cÚÃùed
())

59 
id
 = -1;

60 ià(!
avaIds_
.
	`em±y
())

62 
id
 = 
avaIds_
.
	`äÚt
();

63 
avaIds_
.
	`pİ
();

64 
ş›ÁCÚns_
[
id
] = 
cÚn
;

67 ià(
id
 <= 0)

70 
cÚn
->
	`shutdown
();

74 
cÚn
->
	`£tCÚ‹xt
(
id
);

75 
buf
[256];

76 
	`¢´štf
(
buf
, (buf), "CONN %d FROM %s IS UP\r\n",

77 
id
, 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
().
	`c_¡r
());

78 
	`£ndBack’dSŒšg
(0, 
buf
);

83 ià(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
())

85 
id
 = 
boo¡
::
ªy_ÿ¡
<>(
cÚn
->
	`g‘CÚ‹xt
());

86 
	`as£¹
(
id
 > 0 && id <ğ
kMaxCÚns
);

87 
buf
[256];

88 
	`¢´štf
(
buf
, (buf), "CONN %d FROM %s IS DOWN\r\n",

89 
id
, 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
().
	`c_¡r
());

90 
	`£ndBack’dSŒšg
(0, 
buf
);

92 ià(
back’dCÚn_
)

95 
avaIds_
.
	`push
(
id
);

96 
ş›ÁCÚns_
.
	`”a£
(
id
);

100 
	`as£¹
(
avaIds_
.
	`em±y
());

101 
	`as£¹
(
ş›ÁCÚns_
.
	`em±y
());

105 
	}
}

107 
	$£ndBack’dSŒšg
(
id
, cÚ¡ 
¡ršg
& 
msg
)

109 
	`as£¹
(
msg
.
	`size
(è<ğ
kMaxPack‘L’
);

110 
Bufãr
 
buf
;

111 
buf
.
	`­³nd
(
msg
);

112 
	`£ndBack’dPack‘
(
id
, &
buf
);

113 
	}
}

115 
	$ÚCl›ÁMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

117 ià(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
())

119 
id
 = 
boo¡
::
ªy_ÿ¡
<>(
cÚn
->
	`g‘CÚ‹xt
());

120 
	`£ndBack’dBufãr
(
id
, 
buf
);

124 
buf
->
	`»Œ›veAÎ
();

127 
	}
}

129 
	$£ndBack’dBufãr
(
id
, 
Bufãr
* 
buf
)

131 
buf
->
	`»adabËBy‹s
(è> 
kMaxPack‘L’
)

133 
Bufãr
 
·ck‘
;

134 
·ck‘
.
	`­³nd
(
buf
->
	`³ek
(), 
kMaxPack‘L’
);

135 
buf
->
	`»Œ›ve
(
kMaxPack‘L’
);

136 
	`£ndBack’dPack‘
(
id
, &
·ck‘
);

138 ià(
buf
->
	`»adabËBy‹s
() > 0)

140 
	`£ndBack’dPack‘
(
id
, 
buf
);

142 
	}
}

144 
	$£ndBack’dPack‘
(
id
, 
Bufãr
* 
buf
)

146 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

147 
LOG_DEBUG
 << "£ndBack’dPack‘ " << 
Ën
;

148 
	`as£¹
(
Ën
 <ğ
kMaxPack‘L’
);

149 
ušt8_t
 
h—d”
[
kH—d”L’
] = {

150 
¡©ic_ÿ¡
<
ušt8_t
>(
Ën
),

151 
¡©ic_ÿ¡
<
ušt8_t
>(
id
 & 0xFF),

152 
¡©ic_ÿ¡
<
ušt8_t
>((
id
 & 0xFF00) >> 8)

154 
buf
->
	`´•’d
(
h—d”
, 
kH—d”L’
);

155 ià(
back’dCÚn_
)

157 
back’dCÚn_
->
	`£nd
(
buf
);

159 
	}
}

161 
	$ÚBack’dCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

163 
LOG_TRACE
 << "Back’d " << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

164 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

165 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

167 ià(
cÚn
->
	`cÚÃùed
())

169 
back’dCÚn_
 = 
cÚn
;

170 
	`as£¹
(
avaIds_
.
	`em±y
());

171 
i
 = 1; i <ğ
kMaxCÚns
; ++i)

173 
avaIds_
.
	`push
(
i
);

178 
back’dCÚn_
.
	`»£t
();

179 
¡d
::
m­
<, 
TıCÚÃùiÚPŒ
>::
™”©Ü
 
™
 = 
ş›ÁCÚns_
.
	`begš
();

180 
™
 !ğ
ş›ÁCÚns_
.
	`’d
();

181 ++
™
)

183 
™
->
£cÚd
->
	`shutdown
();

185 
ş›ÁCÚns_
.
	`ş—r
();

186 !
avaIds_
.
	`em±y
())

188 
avaIds_
.
	`pİ
();

191 
	}
}

193 
	$ÚBack’dMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

195 
	`£ndToCl›Á
(
buf
);

196 
	}
}

198 
	$£ndToCl›Á
(
Bufãr
* 
buf
)

200 
buf
->
	`»adabËBy‹s
(è> 
kH—d”L’
)

202 
Ën
 = 
¡©ic_ÿ¡
<
ušt8_t
>(*
buf
->
	`³ek
());

203 ià(
buf
->
	`»adabËBy‹s
(è< 
Ën
 + 
kH—d”L’
)

209 
id
 = 
¡©ic_ÿ¡
<
ušt8_t
>(
buf
->
	`³ek
()[1]);

210 
id
 |ğ(
¡©ic_ÿ¡
<
ušt8_t
>(
buf
->
	`³ek
()[2]) << 8);

212 ià(
id
 != 0)

214 
¡d
::
m­
<, 
TıCÚÃùiÚPŒ
>::
™”©Ü
 
™
 = 
ş›ÁCÚns_
.
	`fšd
(
id
);

215 ià(
™
 !ğ
ş›ÁCÚns_
.
	`’d
())

217 
™
->
£cÚd
->
	`£nd
(
buf
->
	`³ek
(è+ 
kH—d”L’
, 
Ën
);

222 
¡ršg
 
	`cmd
(
buf
->
	`³ek
(è+ 
kH—d”L’
, 
Ën
);

223 
LOG_INFO
 << "Back’d cmd " << 
cmd
;

224 
	`doCommªd
(
cmd
);

226 
buf
->
	`»Œ›ve
(
Ën
 + 
kH—d”L’
);

229 
	}
}

231 
	$doCommªd
(cÚ¡ 
¡ršg
& 
cmd
)

233 cÚ¡ 
¡ršg
 
kDiscÚÃùCmd
 = "DISCONNECT ";

235 ià(
cmd
.
	`size
(è> 
kDiscÚÃùCmd
.size()

236 && 
¡d
::
	`equ®
(
kDiscÚÃùCmd
.
	`begš
(), kDiscÚÃùCmd.
	`’d
(), 
cmd
.begin()))

238 
cÚnId
 = 
	`©oi
(&
cmd
[
kDiscÚÃùCmd
.
	`size
()]);

239 
¡d
::
m­
<, 
TıCÚÃùiÚPŒ
>::
™”©Ü
 
™
 = 
ş›ÁCÚns_
.
	`fšd
(
cÚnId
);

240 ià(
™
 !ğ
ş›ÁCÚns_
.
	`’d
())

242 
™
->
£cÚd
->
	`shutdown
();

245 
	}
}

247 
TıS”v”
 
	g£rv”_
;

248 
TıCl›Á
 
	gback’d_
;

250 
TıCÚÃùiÚPŒ
 
	gback’dCÚn_
;

251 
	g¡d
::
m­
<, 
	gTıCÚÃùiÚPŒ
> 
	gş›ÁCÚns_
;

252 
	g¡d
::
queue
<> 
avaIds_
;

255 
	$maš
(
¬gc
, * 
¬gv
[])

257 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

258 
Ev’tLoİ
 
loİ
;

259 
IÃtAdd»ss
 
	`li¡’Addr
(
kCl›ÁPÜt
);

260 ià(
¬gc
 > 1)

262 
back’dIp
 = 
¬gv
[1];

264 
IÃtAdd»ss
 
	`back’dAddr
(
back’dIp
, 
kBack’dPÜt
);

265 
MuÉËxS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
back’dAddr
);

267 
£rv”
.
	`¡¬t
();

269 
loİ
.
	`loİ
();

270 
	}
}

	@examples/netty/discard/client.cc

1 
	~<muduo/Ãt/TıCl›Á.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Th»ad.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<boo¡/bšd.hµ
>

10 
	~<ut™y
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 şas 
	cDisÿrdCl›Á
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
	$DisÿrdCl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, 
size
)

22 : 
	`loİ_
(
loİ
),

23 
	`ş›Á_
(
loİ
, 
li¡’Addr
, "DiscardClient"),

24 
	`mes§ge_
(
size
, 'H')

26 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

27 
boo¡
::
	`bšd
(&
DisÿrdCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

28 
ş›Á_
.
	`£tMes§geC®lback
(

29 
boo¡
::
	`bšd
(&
DisÿrdCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

30 
ş›Á_
.
	`£tWr™eCom¶‘eC®lback
(

31 
boo¡
::
	`bšd
(&
DisÿrdCl›Á
::
ÚWr™eCom¶‘e
, 
this
, 
_1
));

35 
	$cÚÃù
()

37 
ş›Á_
.
	`cÚÃù
();

38 
	}
}

40 
	g´iv©e
:

41 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

43 
LOG_TRACE
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

44 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

45 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

47 ià(
cÚn
->
	`cÚÃùed
())

49 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

50 
cÚn
->
	`£nd
(
mes§ge_
);

54 
loİ_
->
	`qu™
();

56 
	}
}

58 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
time
)

60 
buf
->
	`»Œ›veAÎ
();

61 
	}
}

63 
	$ÚWr™eCom¶‘e
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

65 
LOG_INFO
 << "wr™com¶‘" << 
mes§ge_
.
	`size
();

66 
cÚn
->
	`£nd
(
mes§ge_
);

67 
	}
}

69 
Ev’tLoİ
* 
	gloİ_
;

70 
TıCl›Á
 
	gş›Á_
;

71 
¡ršg
 
	gmes§ge_
;

74 
	$maš
(
¬gc
, * 
¬gv
[])

76 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

77 ià(
¬gc
 > 1)

79 
Ev’tLoİ
 
loİ
;

80 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 2009);

82 
size
 = 256;

83 ià(
¬gc
 > 2)

85 
size
 = 
	`©oi
(
¬gv
[2]);

88 
DisÿrdCl›Á
 
	`ş›Á
(&
loİ
, 
£rv”Addr
, 
size
);

89 
ş›Á
.
	`cÚÃù
();

90 
loİ
.
	`loİ
();

94 
	`´štf
("U§ge: % ho¡_ [msg_size]\n", 
¬gv
[0]);

96 
	}
}

	@examples/netty/discard/server.cc

1 
	~<muduo/Ãt/TıS”v”.h
>

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<muduo/Ãt/IÃtAdd»ss.h
>

9 
	~<boo¡/bšd.hµ
>

11 
	~<ut™y
>

13 
	~<¡dio.h
>

14 
	~<uni¡d.h
>

16 
usšg
 
Çme¥aû
 
	gmuduo
;

17 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

19 
	gnumTh»ads
 = 0;

21 şas 
	cDisÿrdS”v”


23 
	mpublic
:

24 
	$DisÿrdS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

25 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "DiscardServer"),

26 
	`ŞdCouÁ”_
(0),

27 
	`¡¬tTime_
(
Time¡amp
::
	$now
())

29 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

30 
boo¡
::
	`bšd
(&
DisÿrdS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

31 
£rv”_
.
	`£tMes§geC®lback
(

32 
boo¡
::
	`bšd
(&
DisÿrdS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

33 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

34 
loİ
->
	`runEv”y
(3.0, 
boo¡
::
	`bšd
(&
DisÿrdS”v”
::
´štThroughput
, 
this
));

37 
	$¡¬t
()

39 
LOG_INFO
 << "¡¬tšg " << 
numTh»ads
 << "hreads.";

40 
£rv”_
.
	`¡¬t
();

41 
	}
}

43 
	g´iv©e
:

44 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

46 
LOG_TRACE
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

47 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

48 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

49 
	}
}

51 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

53 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

54 
Œªsã¼ed_
.
	`add
(
Ën
);

55 
»ûivedMes§ges_
.
	`šüem’tAndG‘
();

56 
buf
->
	`»Œ›veAÎ
();

57 
	}
}

59 
	$´štThroughput
()

61 
Time¡amp
 
’dTime
 = Time¡amp::
	`now
();

62 
št64_t
 
ÃwCouÁ”
 = 
Œªsã¼ed_
.
	`g‘
();

63 
št64_t
 
by‹s
 = 
ÃwCouÁ”
 - 
ŞdCouÁ”_
;

64 
št64_t
 
msgs
 = 
»ûivedMes§ges_
.
	`g‘AndS‘
(0);

65 
time
 = 
	`timeDifã»nû
(
’dTime
, 
¡¬tTime_
);

66 
	`´štf
("%4.3f MiB/s %4.3f Ki Msgs/s %6.2f bytes…er msg\n",

67 
¡©ic_ÿ¡
<>(
by‹s
)/
time
/1024/1024,

68 
¡©ic_ÿ¡
<>(
msgs
)/
time
/1024,

69 
¡©ic_ÿ¡
<>(
by‹s
)/¡©ic_ÿ¡<>(
msgs
));

71 
ŞdCouÁ”_
 = 
ÃwCouÁ”
;

72 
¡¬tTime_
 = 
’dTime
;

73 
	}
}

75 
TıS”v”
 
	g£rv”_
;

77 
AtomicIÁ64
 
	gŒªsã¼ed_
;

78 
AtomicIÁ64
 
	g»ûivedMes§ges_
;

79 
št64_t
 
	gŞdCouÁ”_
;

80 
Time¡amp
 
	g¡¬tTime_
;

83 
	$maš
(
¬gc
, * 
¬gv
[])

85 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

86 ià(
¬gc
 > 1)

88 
numTh»ads
 = 
	`©oi
(
¬gv
[1]);

90 
Ev’tLoİ
 
loİ
;

91 
IÃtAdd»ss
 
	`li¡’Addr
(2009);

92 
DisÿrdS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

94 
£rv”
.
	`¡¬t
();

96 
loİ
.
	`loİ
();

97 
	}
}

	@examples/netty/echo/client.cc

1 
	~<muduo/Ãt/TıCl›Á.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Th»ad.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<boo¡/bšd.hµ
>

10 
	~<ut™y
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 şas 
	cEchoCl›Á
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
	$EchoCl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, 
size
)

22 : 
	`loİ_
(
loİ
),

23 
	`ş›Á_
(
loİ
, 
li¡’Addr
, "EchoClient"),

24 
	`mes§ge_
(
size
, 'H')

26 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

27 
boo¡
::
	`bšd
(&
EchoCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

28 
ş›Á_
.
	`£tMes§geC®lback
(

29 
boo¡
::
	`bšd
(&
EchoCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

33 
	$cÚÃù
()

35 
ş›Á_
.
	`cÚÃù
();

36 
	}
}

38 
	g´iv©e
:

39 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

41 
LOG_TRACE
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

42 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

43 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

45 ià(
cÚn
->
	`cÚÃùed
())

47 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

48 
cÚn
->
	`£nd
(
mes§ge_
);

52 
loİ_
->
	`qu™
();

54 
	}
}

56 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
time
)

58 
cÚn
->
	`£nd
(
buf
);

59 
	}
}

61 
Ev’tLoİ
* 
	gloİ_
;

62 
TıCl›Á
 
	gş›Á_
;

63 
¡ršg
 
	gmes§ge_
;

66 
	$maš
(
¬gc
, * 
¬gv
[])

68 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

69 ià(
¬gc
 > 1)

71 
Ev’tLoİ
 
loİ
;

72 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 2007);

74 
size
 = 256;

75 ià(
¬gc
 > 2)

77 
size
 = 
	`©oi
(
¬gv
[2]);

80 
EchoCl›Á
 
	`ş›Á
(&
loİ
, 
£rv”Addr
, 
size
);

81 
ş›Á
.
	`cÚÃù
();

82 
loİ
.
	`loİ
();

86 
	`´štf
("U§ge: % ho¡_ [msg_size]\n", 
¬gv
[0]);

88 
	}
}

	@examples/netty/echo/server.cc

1 
	~<muduo/Ãt/TıS”v”.h
>

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<muduo/Ãt/IÃtAdd»ss.h
>

9 
	~<boo¡/bšd.hµ
>

11 
	~<ut™y
>

13 
	~<¡dio.h
>

14 
	~<uni¡d.h
>

16 
usšg
 
Çme¥aû
 
	gmuduo
;

17 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

19 
	gnumTh»ads
 = 0;

21 şas 
	cEchoS”v”


23 
	mpublic
:

24 
	$EchoS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

25 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "EchoServer"),

26 
	`ŞdCouÁ”_
(0),

27 
	`¡¬tTime_
(
Time¡amp
::
	$now
())

29 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

30 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

31 
£rv”_
.
	`£tMes§geC®lback
(

32 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

33 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

34 
loİ
->
	`runEv”y
(3.0, 
boo¡
::
	`bšd
(&
EchoS”v”
::
´štThroughput
, 
this
));

37 
	$¡¬t
()

39 
LOG_INFO
 << "¡¬tšg " << 
numTh»ads
 << "hreads.";

40 
£rv”_
.
	`¡¬t
();

41 
	}
}

43 
	g´iv©e
:

44 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

46 
LOG_TRACE
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

47 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

48 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

49 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

50 
	}
}

52 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

54 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

55 
Œªsã¼ed_
.
	`addAndG‘
(
Ën
);

56 
»ûivedMes§ges_
.
	`šüem’tAndG‘
();

57 
cÚn
->
	`£nd
(
buf
);

58 
	}
}

60 
	$´štThroughput
()

62 
Time¡amp
 
’dTime
 = Time¡amp::
	`now
();

63 
št64_t
 
ÃwCouÁ”
 = 
Œªsã¼ed_
.
	`g‘
();

64 
št64_t
 
by‹s
 = 
ÃwCouÁ”
 - 
ŞdCouÁ”_
;

65 
št64_t
 
msgs
 = 
»ûivedMes§ges_
.
	`g‘AndS‘
(0);

66 
time
 = 
	`timeDifã»nû
(
’dTime
, 
¡¬tTime_
);

67 
	`´štf
("%4.3f MiB/s %4.3f Ki Msgs/s %6.2f bytes…er msg\n",

68 
¡©ic_ÿ¡
<>(
by‹s
)/
time
/1024/1024,

69 
¡©ic_ÿ¡
<>(
msgs
)/
time
/1024,

70 
¡©ic_ÿ¡
<>(
by‹s
)/¡©ic_ÿ¡<>(
msgs
));

72 
ŞdCouÁ”_
 = 
ÃwCouÁ”
;

73 
¡¬tTime_
 = 
’dTime
;

74 
	}
}

76 
TıS”v”
 
	g£rv”_
;

77 
AtomicIÁ64
 
	gŒªsã¼ed_
;

78 
AtomicIÁ64
 
	g»ûivedMes§ges_
;

79 
št64_t
 
	gŞdCouÁ”_
;

80 
Time¡amp
 
	g¡¬tTime_
;

83 
	$maš
(
¬gc
, * 
¬gv
[])

85 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

86 ià(
¬gc
 > 1)

88 
numTh»ads
 = 
	`©oi
(
¬gv
[1]);

90 
Ev’tLoİ
 
loİ
;

91 
IÃtAdd»ss
 
	`li¡’Addr
(2007);

92 
EchoS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

94 
£rv”
.
	`¡¬t
();

96 
loİ
.
	`loİ
();

97 
	}
}

	@examples/netty/echo/server2.cc

1 
	~<muduo/Ãt/TıS”v”.h
>

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/FeUt.h
>

5 
	~<muduo/ba£/Loggšg.h
>

6 
	~<muduo/ba£/ProûssInfo.h
>

7 
	~<muduo/ba£/Th»ad.h
>

8 
	~<muduo/Ãt/Ev’tLoİ.h
>

9 
	~<muduo/Ãt/IÃtAdd»ss.h
>

11 
	~<boo¡/bšd.hµ
>

13 
	~<ut™y
>

15 
	~<¡dio.h
>

16 
	~<uni¡d.h
>

18 
usšg
 
Çme¥aû
 
	gmuduo
;

19 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

21 
	gnumTh»ads
 = 0;

23 şas 
	cEchoS”v”


25 
	mpublic
:

26 
	$EchoS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

27 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "EchoServer"),

28 
	`¡¬tTime_
(
Time¡amp
::
	$now
())

30 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

31 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

32 
£rv”_
.
	`£tMes§geC®lback
(

33 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

34 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

35 
loİ
->
	`runEv”y
(5.0, 
boo¡
::
	`bšd
(&
EchoS”v”
::
´štThroughput
, 
this
));

38 
	$¡¬t
()

40 
LOG_INFO
 << "¡¬tšg " << 
numTh»ads
 << "hreads.";

41 
£rv”_
.
	`¡¬t
();

42 
	}
}

44 
	g´iv©e
:

45 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

47 
LOG_TRACE
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

48 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

49 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

50 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

51 ià(
cÚn
->
	`cÚÃùed
())

53 
cÚÃùiÚs_
.
	`šüem’t
();

57 
cÚÃùiÚs_
.
	`deüem’t
();

59 
	}
}

61 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

63 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

64 
Œªsã¼edBy‹s_
.
	`addAndG‘
(
Ën
);

65 
»ûivedMes§ges_
.
	`šüem’tAndG‘
();

66 
cÚn
->
	`£nd
(
buf
);

67 
	}
}

69 
	$´štThroughput
()

71 
Time¡amp
 
’dTime
 = Time¡amp::
	`now
();

72 
by‹s
 = 
¡©ic_ÿ¡
<>(
Œªsã¼edBy‹s_
.
	`g‘AndS‘
(0));

73 
msgs
 = 
»ûivedMes§ges_
.
	`g‘AndS‘
(0);

74 
by‹sP”Msg
 = 
msgs
 > 0 ? 
by‹s
/msgs : 0;

75 
time
 = 
	`timeDifã»nû
(
’dTime
, 
¡¬tTime_
);

76 
	`´štf
("%.3f MiB/s %.2f Kilo Msgs/s %.2f bytes…er msg, ",

77 
by‹s
/
time
/1024/1024,

78 
¡©ic_ÿ¡
<>(
msgs
)/
time
/1000,

79 
by‹sP”Msg
);

81 
	`´štCÚÃùiÚ
();

82 
	`fæush
(
¡dout
);

83 
¡¬tTime_
 = 
’dTime
;

84 
	}
}

86 
	$´štCÚÃùiÚ
()

88 
¡ršg
 
´ocStus
 = 
ProûssInfo
::
	`´ocStus
();

89 
	`´štf
("%d conn, files %d , VmSize %ld KiB, RSS %ld KiB, ",

90 
cÚÃùiÚs_
.
	`g‘
(),

91 
ProûssInfo
::
	`İ’edFes
(),

92 
	`g‘LÚg
(
´ocStus
, "VmSize:"),

93 
	`g‘LÚg
(
´ocStus
, "VmRSS:"));

95 
¡ršg
 
memšfo
;

96 
FeUt
::
	`»adFe
("/´oc/memšfo", 65536, &
memšfo
);

97 
tÙ®_kb
 = 
	`g‘LÚg
(
memšfo
, "MemTotal:");

98 
ä“_kb
 = 
	`g‘LÚg
(
memšfo
, "MemFree:");

99 
bufãrs_kb
 = 
	`g‘LÚg
(
memšfo
, "Buffers:");

100 
ÿched_kb
 = 
	`g‘LÚg
(
memšfo
, "Cached:");

101 
	`´štf
("system memory used %ld KiB\n",

102 
tÙ®_kb
 - 
ä“_kb
 - 
bufãrs_kb
 - 
ÿched_kb
);

103 
	}
}

105 
	$g‘LÚg
(cÚ¡ 
¡ršg
& 
´ocStus
, cÚ¡ * 
key
)

107 
»suÉ
 = 0;

108 
size_t
 
pos
 = 
´ocStus
.
	`fšd
(
key
);

109 ià(
pos
 !ğ
¡ršg
::
Åos
)

111 
»suÉ
 = ::
	`©Ş
(
´ocStus
.
	`c_¡r
(è+ 
pos
 + 
	`¡¾’
(
key
));

113  
»suÉ
;

114 
	}
}

116 
TıS”v”
 
	g£rv”_
;

117 
AtomicIÁ32
 
	gcÚÃùiÚs_
;

118 
AtomicIÁ32
 
	g»ûivedMes§ges_
;

119 
AtomicIÁ64
 
	gŒªsã¼edBy‹s_
;

120 
Time¡amp
 
	g¡¬tTime_
;

123 
	$maš
(
¬gc
, * 
¬gv
[])

125 
LOG_INFO
 << "pid = " << 
	`g‘pid
()

126 << ",id = " << 
Cu¼’tTh»ad
::
	`tid
()

127 << ", max fe ğ" << 
ProûssInfo
::
	`maxO³nFes
();

128 
Logg”
::
	`£tLogLev–
(Logg”::
WARN
);

129 ià(
¬gc
 > 1)

131 
numTh»ads
 = 
	`©oi
(
¬gv
[1]);

133 
Ev’tLoİ
 
loİ
;

134 
IÃtAdd»ss
 
	`li¡’Addr
(2007);

135 
EchoS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

137 
£rv”
.
	`¡¬t
();

139 
loİ
.
	`loİ
();

140 
	}
}

	@examples/netty/uptime/uptime.cc

1 
	~<muduo/Ãt/TıCl›Á.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Th»ad.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<boo¡/bšd.hµ
>

10 
	~<ut™y
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 şas 
	cU±imeCl›Á
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
	$U±imeCl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

22 : 
	`ş›Á_
(
loİ
, 
li¡’Addr
, "UptimeClient")

24 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

25 
boo¡
::
	`bšd
(&
U±imeCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

26 
ş›Á_
.
	`£tMes§geC®lback
(

27 
boo¡
::
	`bšd
(&
U±imeCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

31 
	$cÚÃù
()

33 
ş›Á_
.
	`cÚÃù
();

34 
	}
}

36 
	g´iv©e
:

37 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

39 
LOG_TRACE
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

40 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

41 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

42 
	}
}

44 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
time
)

46 
	}
}

48 
TıCl›Á
 
	gş›Á_
;

51 
	$maš
(
¬gc
, * 
¬gv
[])

53 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

54 ià(
¬gc
 > 2)

56 
Ev’tLoİ
 
loİ
;

57 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

58 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 
pÜt
);

60 
U±imeCl›Á
 
	`ş›Á
(&
loİ
, 
£rv”Addr
);

61 
ş›Á
.
	`cÚÃù
();

62 
loİ
.
	`loİ
();

66 
	`´štf
("U§ge: % ho¡_…Üt\n", 
¬gv
[0]);

68 
	}
}

	@examples/pingpong/bench.cc

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/Ãt/ChªÃl.h
>

7 
	~<muduo/Ãt/Ev’tLoİ.h
>

9 
	~<boo¡/bšd.hµ
>

10 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

12 
	~<¡dio.h
>

13 
	~<sys/»sourû.h
>

14 
	~<sys/sock‘.h
>

15 
	~<uni¡d.h
>

17 
usšg
 
Çme¥aû
 
	gmuduo
;

18 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

20 
	g¡d
::
veùÜ
<> 
g_pes
;

21 
	gnumPes
;

22 
	gnumAùive
;

23 
	gnumWr™es
;

24 
Ev’tLoİ
* 
	gg_loİ
;

25 
	gboo¡
::
±r_veùÜ
<
ChªÃl
> 
g_chªÃls
;

27 
	gg_»ads
, 
	gg_wr™es
, 
	gg_fœed
;

29 
	$»adC®lback
(
Time¡amp
, 
fd
, 
idx
)

31 
ch
;

33 
g_»ads
 +ğ
¡©ic_ÿ¡
<>(::
	`»cv
(
fd
, &
ch
, (ch), 0));

34 ià(
g_wr™es
 > 0)

36 
widx
 = 
idx
+1;

37 ià(
widx
 >ğ
numPes
)

39 
widx
 -ğ
numPes
;

41 ::
	`£nd
(
g_pes
[2 * 
widx
 + 1], "m", 1, 0);

42 
g_wr™es
--;

43 
g_fœed
++;

45 ià(
g_fœed
 =ğ
g_»ads
)

47 
g_loİ
->
	`qu™
();

49 
	}
}

51 
	g¡d
::
·œ
<, > 
	$runOnû
()

53 
Time¡amp
 
	`befÜeIn™
(Time¡amp::
	`now
());

54 
i
 = 0; i < 
numPes
; ++i)

56 
ChªÃl
& 
chªÃl
 = 
g_chªÃls
[
i
];

57 
chªÃl
.
	`£tR—dC®lback
(
boo¡
::
	`bšd
(
»adC®lback
, 
_1
, chªÃl.
	`fd
(), 
i
));

58 
chªÃl
.
	`’abËR—dšg
();

61 
¥aû
 = 
numPes
 / 
numAùive
;

62 
¥aû
 *= 2;

63 
i
 = 0; i < 
numAùive
; ++i)

65 ::
	`£nd
(
g_pes
[
i
 * 
¥aû
 + 1], "m", 1, 0);

68 
g_fœed
 = 
numAùive
;

69 
g_»ads
 = 0;

70 
g_wr™es
 = 
numWr™es
;

71 
Time¡amp
 
	`befÜeLoİ
(Time¡amp::
	`now
());

72 
g_loİ
->
	`loİ
();

74 
Time¡amp
 
	`’d
(Time¡amp::
	`now
());

76 
™”Time
 = 
¡©ic_ÿ¡
<>(
’d
.
	`miüoSecÚdsSšûEpoch
(è- 
befÜeIn™
.microSecondsSinceEpoch());

77 
loİTime
 = 
¡©ic_ÿ¡
<>(
’d
.
	`miüoSecÚdsSšûEpoch
(è- 
befÜeLoİ
.microSecondsSinceEpoch());

78  
¡d
::
	`make_·œ
(
™”Time
, 
loİTime
);

79 
	}
}

81 
	$maš
(
¬gc
, * 
¬gv
[])

83 
numPes
 = 100;

84 
numAùive
 = 1;

85 
numWr™es
 = 100;

86 
c
;

87 (
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "n:a:w:")) != -1)

89 
c
)

92 
numPes
 = 
	`©oi
(
İrg
);

95 
numAùive
 = 
	`©oi
(
İrg
);

98 
numWr™es
 = 
	`©oi
(
İrg
);

101 
	`årštf
(
¡d”r
, "IÎeg®‡rgum’ˆ\"%c\"\n", 
c
);

106 
¾im™
 
¾
;

107 
¾
.
¾im_cur
 =„l.
¾im_max
 = 
numPes
 * 2 + 50;

108 ià(::
	`£Œlim™
(
RLIMIT_NOFILE
, &
¾
) == -1)

110 
	`³¼Ü
("setrlimit");

113 
g_pes
.
	`»size
(2 * 
numPes
);

114 
i
 = 0; i < 
numPes
; ++i)

116 ià(::
	`sock‘·œ
(
AF_UNIX
, 
SOCK_STREAM
, 0, &
g_pes
[
i
*2]) == -1)

118 
	`³¼Ü
("pipe");

123 
Ev’tLoİ
 
loİ
;

124 
g_loİ
 = &
loİ
;

126 
i
 = 0; i < 
numPes
; ++i)

128 
ChªÃl
* 
chªÃl
 = 
Ãw
 
	`ChªÃl
(&
loİ
, 
g_pes
[
i
*2]);

129 
g_chªÃls
.
	`push_back
(
chªÃl
);

132 
i
 = 0; i < 25; ++i)

134 
¡d
::
·œ
<, > 
t
 = 
	`runOnû
();

135 
	`´štf
("%8d %8d\n", 
t
.
fœ¡
,.
£cÚd
);

138 
boo¡
::
±r_veùÜ
<
ChªÃl
>::
™”©Ü
 
™
 = 
g_chªÃls
.
	`begš
();

139 
™
 !ğ
g_chªÃls
.
	`’d
(); ++it)

141 
™
->
	`di§bËAÎ
();

142 
™
->
	`»move
();

144 
g_chªÃls
.
	`ş—r
();

145 
	}
}

	@examples/pingpong/client.cc

1 
	~<muduo/Ãt/TıCl›Á.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Th»ad.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

7 
	~<muduo/Ãt/IÃtAdd»ss.h
>

9 
	~<boo¡/bšd.hµ
>

10 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

12 
	~<ut™y
>

14 
	~<¡dio.h
>

15 
	~<uni¡d.h
>

17 
usšg
 
Çme¥aû
 
	gmuduo
;

18 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

20 
şass
 
	gCl›Á
;

22 şas 
	cSessiÚ
 : 
boo¡
::
nÚcİyabË


24 
public
:

25 
	$SessiÚ
(
Ev’tLoİ
* 
loİ
,

26 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

27 cÚ¡ 
¡ršg
& 
Çme
,

28 
Cl›Á
* 
owÃr
)

29 : 
	`ş›Á_
(
loİ
, 
£rv”Addr
, 
Çme
),

30 
	`owÃr_
(
owÃr
),

31 
	`by‹sR—d_
(0),

32 
	`by‹sWr™‹n_
(0),

33 
	$mes§gesR—d_
(0)

35 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

36 
boo¡
::
	`bšd
(&
SessiÚ
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

37 
ş›Á_
.
	`£tMes§geC®lback
(

38 
boo¡
::
	`bšd
(&
SessiÚ
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

41 
	$¡¬t
()

43 
ş›Á_
.
	`cÚÃù
();

44 
	}
}

46 
	$¡İ
()

48 
ş›Á_
.
	`discÚÃù
();

49 
	}
}

51 
št64_t
 
	$by‹sR—d
() const

53  
by‹sR—d_
;

54 
	}
}

56 
št64_t
 
	$mes§gesR—d
() const

58  
mes§gesR—d_
;

59 
	}
}

61 
	g´iv©e
:

63 
ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

65 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

67 ++
mes§gesR—d_
;

68 
by‹sR—d_
 +ğ
buf
->
	`»adabËBy‹s
();

69 
by‹sWr™‹n_
 +ğ
buf
->
	`»adabËBy‹s
();

70 
cÚn
->
	`£nd
(
buf
);

71 
	}
}

73 
TıCl›Á
 
	gş›Á_
;

74 
Cl›Á
* 
	gowÃr_
;

75 
št64_t
 
	gby‹sR—d_
;

76 
št64_t
 
	gby‹sWr™‹n_
;

77 
št64_t
 
	gmes§gesR—d_
;

80 şas 
	cCl›Á
 : 
boo¡
::
nÚcİyabË


82 
public
:

83 
	$Cl›Á
(
Ev’tLoİ
* 
loİ
,

84 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

85 
blockSize
,

86 
£ssiÚCouÁ
,

87 
timeout
,

88 
th»adCouÁ
)

89 : 
	`loİ_
(
loİ
),

90 
	`th»adPoŞ_
(
loİ
, "pingpong-client"),

91 
	`£ssiÚCouÁ_
(
£ssiÚCouÁ
),

92 
	$timeout_
(
timeout
)

94 
loİ
->
	`runAá”
(
timeout
, 
boo¡
::
	`bšd
(&
Cl›Á
::
hªdËTimeout
, 
this
));

95 ià(
th»adCouÁ
 > 1)

97 
th»adPoŞ_
.
	`£tTh»adNum
(
th»adCouÁ
);

99 
th»adPoŞ_
.
	`¡¬t
();

101 
i
 = 0; i < 
blockSize
; ++i)

103 
mes§ge_
.
	`push_back
(
¡©ic_ÿ¡
<>(
i
 % 128));

106 
i
 = 0; i < 
£ssiÚCouÁ
; ++i)

108 
buf
[32];

109 
	`¢´štf
(
buf
,  buf, "C%05d", 
i
);

110 
SessiÚ
* 
£ssiÚ
 = 
Ãw
 
	`SessiÚ
(
th»adPoŞ_
.
	`g‘NextLoİ
(), 
£rv”Addr
, 
buf
, 
this
);

111 
£ssiÚ
->
	`¡¬t
();

112 
£ssiÚs_
.
	`push_back
(
£ssiÚ
);

116 cÚ¡ 
¡ršg
& 
	$mes§ge
() const

118  
mes§ge_
;

119 
	}
}

121 
	$ÚCÚÃù
()

123 ià(
numCÚÃùed_
.
	`šüem’tAndG‘
(è=ğ
£ssiÚCouÁ_
)

125 
LOG_WARN
 << "all connected";

127 
	}
}

129 
	$ÚDiscÚÃù
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

131 ià(
numCÚÃùed_
.
	`deüem’tAndG‘
() == 0)

133 
LOG_WARN
 << "all disconnected";

135 
št64_t
 
tÙ®By‹sR—d
 = 0;

136 
št64_t
 
tÙ®Mes§gesR—d
 = 0;

137 
boo¡
::
±r_veùÜ
<
SessiÚ
>::
™”©Ü
 
™
 = 
£ssiÚs_
.
	`begš
();

138 
™
 !ğ
£ssiÚs_
.
	`’d
(); ++it)

140 
tÙ®By‹sR—d
 +ğ
™
->
	`by‹sR—d
();

141 
tÙ®Mes§gesR—d
 +ğ
™
->
	`mes§gesR—d
();

143 
LOG_WARN
 << 
tÙ®By‹sR—d
 << "otal bytes„ead";

144 
LOG_WARN
 << 
tÙ®Mes§gesR—d
 << "otal messages„ead";

145 
LOG_WARN
 << 
¡©ic_ÿ¡
<>(
tÙ®By‹sR—d
è/ stic_ÿ¡<>(
tÙ®Mes§gesR—d
)

147 
LOG_WARN
 << 
¡©ic_ÿ¡
<>(
tÙ®By‹sR—d
è/ (
timeout_
 * 1024 * 1024)

149 
cÚn
->
	`g‘Loİ
()->
	`queueInLoİ
(
boo¡
::
	`bšd
(&
Cl›Á
::
qu™
, 
this
));

151 
	}
}

153 
	g´iv©e
:

155 
	$qu™
()

157 
loİ_
->
	`queueInLoİ
(
boo¡
::
	`bšd
(&
Ev’tLoİ
::
qu™
,†oop_));

158 
	}
}

160 
	$hªdËTimeout
()

162 
LOG_WARN
 << "stop";

163 
¡d
::
	`fÜ_—ch
(
£ssiÚs_
.
	`begš
(), sessiÚs_.
	`’d
(),

164 
boo¡
::
	`mem_â
(&
SessiÚ
::
¡İ
));

165 
	}
}

167 
Ev’tLoİ
* 
	gloİ_
;

168 
Ev’tLoİTh»adPoŞ
 
	gth»adPoŞ_
;

169 
	g£ssiÚCouÁ_
;

170 
	gtimeout_
;

171 
	gboo¡
::
±r_veùÜ
<
SessiÚ
> 
£ssiÚs_
;

172 
¡ršg
 
	gmes§ge_
;

173 
AtomicIÁ32
 
	gnumCÚÃùed_
;

176 
	gSessiÚ
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

178 ià(
cÚn
->
	`cÚÃùed
())

180 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

181 
cÚn
->
	`£nd
(
owÃr_
->
	`mes§ge
());

182 
owÃr_
->
	`ÚCÚÃù
();

186 
owÃr_
->
	`ÚDiscÚÃù
(
cÚn
);

188 
	}
}

190 
	$maš
(
¬gc
, * 
¬gv
[])

192 ià(
¬gc
 != 7)

194 
	`årštf
(
¡d”r
, "Usage: client <host_ip> <port> <threads> <blocksize> ");

195 
	`årštf
(
¡d”r
, "<sessions> <time>\n");

199 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

200 
Logg”
::
	`£tLogLev–
(Logg”::
WARN
);

202 cÚ¡ * 

 = 
¬gv
[1];

203 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

204 
th»adCouÁ
 = 
	`©oi
(
¬gv
[3]);

205 
blockSize
 = 
	`©oi
(
¬gv
[4]);

206 
£ssiÚCouÁ
 = 
	`©oi
(
¬gv
[5]);

207 
timeout
 = 
	`©oi
(
¬gv
[6]);

209 
Ev’tLoİ
 
loİ
;

210 
IÃtAdd»ss
 
	`£rv”Addr
(

, 
pÜt
);

212 
Cl›Á
 
	`ş›Á
(&
loİ
, 
£rv”Addr
, 
blockSize
, 
£ssiÚCouÁ
, 
timeout
, 
th»adCouÁ
);

213 
loİ
.
	`loİ
();

215 
	}
}

	@examples/pingpong/server.cc

1 
	~<muduo/Ãt/TıS”v”.h
>

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<muduo/Ãt/IÃtAdd»ss.h
>

9 
	~<boo¡/bšd.hµ
>

11 
	~<ut™y
>

13 
	~<¡dio.h
>

14 
	~<uni¡d.h
>

16 
usšg
 
Çme¥aû
 
	gmuduo
;

17 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

19 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

21 ià(
cÚn
->
	`cÚÃùed
())

23 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

25 
	}
}

27 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

29 
cÚn
->
	`£nd
(
buf
);

30 
	}
}

32 
	$maš
(
¬gc
, * 
¬gv
[])

34 ià(
¬gc
 < 4)

36 
	`årštf
(
¡d”r
, "Usage: server <address> <port> <threads>\n");

40 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

41 
Logg”
::
	`£tLogLev–
(Logg”::
WARN
);

43 cÚ¡ * 

 = 
¬gv
[1];

44 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

45 
IÃtAdd»ss
 
	`li¡’Addr
(

, 
pÜt
);

46 
th»adCouÁ
 = 
	`©oi
(
¬gv
[3]);

48 
Ev’tLoİ
 
loİ
;

50 
TıS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, "PingPong");

52 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚCÚÃùiÚ
);

53 
£rv”
.
	`£tMes§geC®lback
(
ÚMes§ge
);

55 ià(
th»adCouÁ
 > 1)

57 
£rv”
.
	`£tTh»adNum
(
th»adCouÁ
);

60 
£rv”
.
	`¡¬t
();

62 
loİ
.
	`loİ
();

64 
	}
}

	@examples/procmon/dummyload.cc

1 
	~<muduo/ba£/Atomic.h
>

2 
	~<muduo/ba£/CÚd™iÚ.h
>

3 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

4 
	~<muduo/ba£/Mu‹x.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/ba£/Time¡amp.h
>

7 
	~<muduo/Ãt/Ev’tLoİ.h
>

9 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

11 
	~<m©h.h
>

12 
	~<¡dio.h
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 
	gg_cyşes
 = 0;

18 
	gg_³rûÁ
 = 82;

19 
AtomicIÁ32
 
	gg_dÚe
;

20 
boŞ
 
	gg_busy
 = 
çl£
;

21 
Mu‹xLock
 
	gg_mu‹x
;

22 
CÚd™iÚ
 
g_cÚd
(
g_mu‹x
);

24 
	$busy
(
cyşes
)

26 
»suÉ
 = 0;

27 
i
 = 0; i < 
cyşes
; ++i)

29 
»suÉ
 +ğ
	`sq¹
(
i
) * sqrt(i+1);

31  
»suÉ
;

32 
	}
}

34 
	$g‘SecÚds
(
cyşes
)

36 
Time¡amp
 
¡¬t
 = Time¡amp::
	`now
();

37 
	`busy
(
cyşes
);

38  
	`timeDifã»nû
(
Time¡amp
::
	`now
(), 
¡¬t
);

39 
	}
}

41 
	$fšdCyşes
()

43 
g_cyşes
 = 1000;

44 
	`g‘SecÚds
(
g_cyşes
) < 0.001)

45 
g_cyşes
 = g_cycles + g_cycles / 4;

46 
	`´štf
("cyşe %d\n", 
g_cyşes
);

47 
	}
}

49 
	$th»adFunc
()

51 
g_dÚe
.
	`g‘
() == 0)

54 
Mu‹xLockGu¬d
 
	`gu¬d
(
g_mu‹x
);

55 !
g_busy
)

56 
g_cÚd
.
	`wa™
();

58 
	`busy
(
g_cyşes
);

60 
	`´štf
("threadƒxit\n");

61 
	}
}

64 
	$lßd
(
³rûÁ
)

66 
³rûÁ
 = 
¡d
::
	`max
(0,…ercent);

67 
³rûÁ
 = 
¡d
::
	`mš
(100,…ercent);

70 
”r
 = 2*
³rûÁ
 - 100;

71 
couÁ
 = 0;

73 
i
 = 0; i < 100; ++i)

75 
boŞ
 
busy
 = 
çl£
;

76 ià(
”r
 > 0)

78 
busy
 = 
Œue
;

79 
”r
 +ğ2*(
³rûÁ
 - 100);

80 ++
couÁ
;

85 
”r
 +ğ2*
³rûÁ
;

89 
Mu‹xLockGu¬d
 
	`gu¬d
(
g_mu‹x
);

90 
g_busy
 = 
busy
;

91 
g_cÚd
.
	`nÙifyAÎ
();

94 
Cu¼’tTh»ad
::
	`¦“pU£c
(10*1000);

96 
	`as£¹
(
couÁ
 =ğ
³rûÁ
);

97 
	}
}

99 
	$fixed
()

101 
Œue
)

103 
	`lßd
(
g_³rûÁ
);

105 
	}
}

107 
	$cosše
()

109 
Œue
)

110 
i
 = 0; i < 200; ++i)

112 
³rûÁ
 = 
¡©ic_ÿ¡
<>((1.0 + 
	`cos
(
i
 * 3.14159 / 100)è/ 2 * 
g_³rûÁ
 + 0.5);

113 
	`lßd
(
³rûÁ
);

115 
	}
}

117 
	$§wtoÙh
()

119 
Œue
)

120 
i
 = 0; i <= 100; ++i)

122 
³rûÁ
 = 
¡©ic_ÿ¡
<>(
i
 / 100.0 * 
g_³rûÁ
);

123 
	`lßd
(
³rûÁ
);

125 
	}
}

127 
	$maš
(
¬gc
, * 
¬gv
[])

129 ià(
¬gc
 < 2)

131 
	`´štf
("U§ge: % [fùsz] [³rûÁ] [num_th»ads]\n", 
¬gv
[0]);

135 
	`´štf
("pid %d\n", 
	`g‘pid
());

136 
	`fšdCyşes
();

138 
g_³rûÁ
 = 
¬gc
 > 2 ? 
	`©oi
(
¬gv
[2]) : 43;

139 
numTh»ads
 = 
¬gc
 > 3 ? 
	`©oi
(
¬gv
[3]) : 1;

140 
boo¡
::
±r_veùÜ
<
Th»ad
> 
th»ads
;

141 
i
 = 0; i < 
numTh»ads
; ++i)

143 
th»ads
.
	`push_back
(
Ãw
 
	`Th»ad
(
th»adFunc
));

144 
th»ads
.
	`back
().
	`¡¬t
();

147 
¬gv
[1][0])

151 
	`fixed
();

157 
	`cosše
();

163 
	`§wtoÙh
();

173 
g_dÚe
.
	`g‘AndS‘
(1);

175 
Mu‹xLockGu¬d
 
	`gu¬d
(
g_mu‹x
);

176 
g_busy
 = 
Œue
;

177 
g_cÚd
.
	`nÙifyAÎ
();

179 
i
 = 0; i < 
numTh»ads
; ++i)

181 
th»ads
[
i
].
	`još
();

183 
	}
}

	@examples/procmon/plot.cc

1 
	~"¶Ù.h
"

2 
	~<®gÜ™hm
>

4 
	~<m©h.h
>

6 
	~<gd.h
>

7 
	~<gdfÚts.h
>

9 
	gPlÙ
::
MyGdFÚt
 : 
public
 
gdFÚt
 {};

11 
	gPlÙ
::
	$PlÙ
(
width
, 
height
, 
tÙ®SecÚds
, 
§m¶šgP”iod
)

12 : 
	`width_
(
width
),

13 
	`height_
(
height
),

14 
	`tÙ®SecÚds_
(
tÙ®SecÚds
),

15 
	`§m¶šgP”iod_
(
§m¶šgP”iod
),

16 
	`image_
(
	`gdImageC»©e
(
width_
, 
height_
)),

17 
	`fÚt_
(
¡©ic_ÿ¡
<
MyGdFÚt
*>(
	`gdFÚtG‘Sm®l
())),

18 
	`fÚtWidth_
(
fÚt_
->
w
),

19 
	`fÚtHeight_
(
fÚt_
->
h
),

20 
	`background_
(
	`gdImageCŞÜAÎoÿ‹
(
image_
, 255, 255, 240)),

21 
	`bÏck_
(
	`gdImageCŞÜAÎoÿ‹
(
image_
, 0, 0, 0)),

22 
	`g¿y_
(
	`gdImageCŞÜAÎoÿ‹
(
image_
, 200, 200, 200)),

23 
	`blue_
(
	`gdImageCŞÜAÎoÿ‹
(
image_
, 128, 128, 255)),

24 
	`kRightM¬gš_
(3 * 
fÚtWidth_
 + 5),

25 
	`¿tioX_
(
¡©ic_ÿ¡
<>(
§m¶šgP”iod_
 * (
width_
 - 
kLeáM¬gš_
 - 
kRightM¬gš_
)è/ 
tÙ®SecÚds_
)

28 
	}
}

30 
	gPlÙ
::~
	$PlÙ
()

32 
	`gdImageDe¡roy
(
image_
);

33 
	}
}

35 
	gmuduo
::
¡ršg
 
PlÙ
::
¶ÙCpu
(cÚ¡ 
¡d
::
veùÜ
<>& 
d©a
)

37 
gdImageFËdReùªgË
(
image_
, 0, 0, 
width_
, 
height_
, 
background_
);

38 ià(
	gd©a
.
size
() > 1)

40 
gdImageS‘ThickÃss
(
image_
, 2);

41 
	gmax
 = *
¡d
::
max_–em’t
(
d©a
.
begš
(), d©a.
’d
());

42 ià(
	gmax
 >= 10.0)

44 
max
 = 
û
(max);

48 
	gmax
 = 
¡d
::
max
(0.1, 
û
(max*10.0) / 10.0);

50 
Ïb–
(
max
);

52 
size_t
 
	gi
 = 0; i < 
	gd©a
.
size
()-1; ++i)

54 
gdImageLše
(
image_
,

55 
g‘X
(
i
, 
d©a
.
size
()),

56 
g‘Y
(
d©a
[
i
] / 
max
),

57 
g‘X
(
i
+1, 
d©a
.
size
()),

58 
g‘Y
(
d©a
[
i
+1]/
max
),

59 
bÏck_
);

63 
	gtÙ®
 = 
tÙ®SecÚds_
/
§m¶šgP”iod_
;

64 
gdImageS‘ThickÃss
(
image_
, 1);

65 
gdImageLše
(
image_
, 
g‘X
(0, 
tÙ®
), 
g‘Y
(0)+2, g‘XÑÙ®,Ù®), g‘Y(0)+2, 
g¿y_
);

66 
gdImageLše
(
image_
, 
g‘X
(
tÙ®
,Ù®), 
g‘Y
(0)+2, g‘XÑÙ®,Ù®), g‘Y(1)+2, 
g¿y_
);

67  
toPng
();

70 
	gPlÙ
::
	$Ïb–
(
maxV®ue
)

72 
buf
[64];

73 ià(
maxV®ue
 >= 10.0)

74 
	`¢´štf
(
buf
,  buf, "%.0f", 
maxV®ue
);

76 
	`¢´štf
(
buf
,  buf, "%.1f", 
maxV®ue
);

78 
	`gdImageSŒšg
(
image_
,

79 
fÚt_
,

80 
width_
 - 
kRightM¬gš_
 + 3,

81 
kM¬gšY_
 - 3,

82 
»š‹½»t_ÿ¡
<*>(
buf
),

83 
bÏck_
);

85 
	`¢´štf
(
buf
,  buf, "0");

86 
	`gdImageSŒšg
(
image_
,

87 
fÚt_
,

88 
width_
 - 
kRightM¬gš_
 + 3,

89 
height_
 - 
kM¬gšY_
 - 3 - 
fÚtHeight_
 / 2,

90 
»š‹½»t_ÿ¡
<*>(
buf
),

91 
g¿y_
);

93 
	`¢´štf
(
buf
,  buf, "-%ds", 
tÙ®SecÚds_
);

94 
	`gdImageSŒšg
(
image_
,

95 
fÚt_
,

96 
kLeáM¬gš_
,

97 
height_
 - 
kM¬gšY_
 - 
fÚtHeight_
,

98 
»š‹½»t_ÿ¡
<*>(
buf
),

99 
blue_
);

100 
	}
}

102 
	gPlÙ
::
	$g‘X
(
ssize_t
 
i
, ssize_ˆ
tÙ®
) const

104 
x
 = (
width_
 - 
kLeáM¬gš_
 - 
kRightM¬gš_
è+ 
¡©ic_ÿ¡
<>(
i
 - 
tÙ®
è* 
¿tioX_
;

105  
¡©ic_ÿ¡
<>(
x
 + 0.5è+ 
kLeáM¬gš_
;

106 
	}
}

108 
	gPlÙ
::
	$g‘Y
(
v®ue
) const

110  
¡©ic_ÿ¡
<>((1.0 - 
v®ue
è* (
height_
-2*
kM¬gšY_
) + 0.5) + kMarginY_;

111 
	}
}

113 
	gmuduo
::
¡ršg
 
PlÙ
::
	$toPng
()

115 
size
 = 0;

116 * 
²g
 = 
	`gdImagePngPŒ
(
image_
, &
size
);

117 
muduo
::
¡ršg
 
	`»suÉ
(
¡©ic_ÿ¡
<*>(
²g
), 
size
);

118 
	`gdF»e
(
²g
);

119  
»suÉ
;

120 
	}
}

	@examples/procmon/plot.h

1 
	~<muduo/ba£/Ty³s.h
>

2 
	~<veùÜ
>

3 
	~<boo¡/nÚcİyabË.hµ
>

4 
	~<¡dlib.h
>

6 
gdImageSŒuù
* 
	tgdImagePŒ
;

8 şas 
	cPlÙ
 : 
boo¡
::
nÚcİyabË


10 
public
:

11 
PlÙ
(
width
, 
height
, 
tÙ®SecÚds
, 
§m¶šgP”iod
);

12 ~
PlÙ
();

13 
	mmuduo
::
¡ršg
 
¶ÙCpu
(cÚ¡ 
¡d
::
veùÜ
<>& 
d©a
);

15 
	m´iv©e
:

16 
muduo
::
¡ršg
 
toPng
();

18 
	$g‘X
(
ssize_t
 
x
, ssize_ˆ
tÙ®
) const;

19 
	$g‘Y
(
v®ue
) const;

20 
	`Ïb–
(
maxV®ue
);

24 
MyGdFÚt
;

25 
MyGdFÚt
* 
	tMyGdFÚtPŒ
;

27 cÚ¡ 
width_
;

28 cÚ¡ 
height_
;

29 cÚ¡ 
tÙ®SecÚds_
;

30 cÚ¡ 
§m¶šgP”iod_
;

31 cÚ¡ 
gdImagePŒ
 
image_
;

32 cÚ¡ 
MyGdFÚtPŒ
 
fÚt_
;

33 cÚ¡ 
fÚtWidth_
;

34 cÚ¡ 
fÚtHeight_
;

35 cÚ¡ 
background_
;

36 cÚ¡ 
bÏck_
;

37 cÚ¡ 
g¿y_
;

38 cÚ¡ 
blue_
;

40 cÚ¡ 
kRightM¬gš_
;

41 cÚ¡ 
kLeáM¬gš_
 = 5;

42 cÚ¡ 
kM¬gšY_
 = 5;

44 cÚ¡ 
¿tioX_
;

	@examples/procmon/plot.h

1 
	~<muduo/ba£/Ty³s.h
>

2 
	~<veùÜ
>

3 
	~<boo¡/nÚcİyabË.hµ
>

4 
	~<¡dlib.h
>

6 
gdImageSŒuù
* 
	tgdImagePŒ
;

8 şas 
	cPlÙ
 : 
boo¡
::
nÚcİyabË


10 
public
:

11 
PlÙ
(
width
, 
height
, 
tÙ®SecÚds
, 
§m¶šgP”iod
);

12 ~
PlÙ
();

13 
	mmuduo
::
¡ršg
 
¶ÙCpu
(cÚ¡ 
¡d
::
veùÜ
<>& 
d©a
);

15 
	m´iv©e
:

16 
muduo
::
¡ršg
 
toPng
();

18 
	$g‘X
(
ssize_t
 
x
, ssize_ˆ
tÙ®
) const;

19 
	$g‘Y
(
v®ue
) const;

20 
	`Ïb–
(
maxV®ue
);

24 
MyGdFÚt
;

25 
MyGdFÚt
* 
	tMyGdFÚtPŒ
;

27 cÚ¡ 
width_
;

28 cÚ¡ 
height_
;

29 cÚ¡ 
tÙ®SecÚds_
;

30 cÚ¡ 
§m¶šgP”iod_
;

31 cÚ¡ 
gdImagePŒ
 
image_
;

32 cÚ¡ 
MyGdFÚtPŒ
 
fÚt_
;

33 cÚ¡ 
fÚtWidth_
;

34 cÚ¡ 
fÚtHeight_
;

35 cÚ¡ 
background_
;

36 cÚ¡ 
bÏck_
;

37 cÚ¡ 
g¿y_
;

38 cÚ¡ 
blue_
;

40 cÚ¡ 
kRightM¬gš_
;

41 cÚ¡ 
kLeáM¬gš_
 = 5;

42 cÚ¡ 
kM¬gšY_
 = 5;

44 cÚ¡ 
¿tioX_
;

	@examples/procmon/plot_test.cc

1 
	~"¶Ù.h
"

2 
	~<muduo/ba£/Time¡amp.h
>

3 
	~<veùÜ
>

4 
	~<m©h.h
>

5 
	~<¡dio.h
>

7 
	$maš
()

9 
¡d
::
veùÜ
<> 
ıu_u§ge
;

10 
i
 = 0; i < 300; ++i)

11 
ıu_u§ge
.
	`push_back
(1.0 + 
	`sš
(
	`pow
(
i
 / 30.0, 2)));

12 
PlÙ
 
	`¶Ù
(640, 100, 600, 2);

13 
muduo
::
Time¡amp
 
	`¡¬t
(muduo::Time¡amp::
	`now
());

14 cÚ¡ 
N
 = 10000;

15 
i
 = 0; i < 
N
; ++i)

16 
muduo
::
¡ršg
 
²g
 = 
¶Ù
.
	`¶ÙCpu
(
ıu_u§ge
);

17 
–­£d
 = 
	`timeDifã»nû
(
muduo
::
Time¡amp
::
	`now
(), 
¡¬t
);

18 
	`´štf
("%d…lots in %f seconds, %f PNG…er second, %f ms…er PNG\n",

19 
N
, 
–­£d
, N /ƒlapsed,ƒlapsed * 1000 / N);

20 
muduo
::
¡ršg
 
²g
 = 
¶Ù
.
	`¶ÙCpu
(
ıu_u§ge
);

22 
FILE
* 
å
 = 
	`fİ’
("test.png", "wb");

23 
	`fwr™e
(
²g
.
	`d©a
(), 1,…ng.
	`size
(), 
å
);

24 
	`fşo£
(
å
);

25 
	`´štf
("Image savedoest.png\n");

26 
	}
}

	@examples/procmon/procmon.cc

1 
	~"¶Ù.h
"

3 
	~<muduo/ba£/FeUt.h
>

4 
	~<muduo/ba£/ProûssInfo.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/h‰p/H‰pReque¡.h
>

7 
	~<muduo/Ãt/h‰p/H‰pRe¥Ú£.h
>

8 
	~<muduo/Ãt/h‰p/H‰pS”v”.h
>

10 
	~<boo¡/®gÜ™hm/¡ršg/»¶aû.hµ
>

11 
	~<boo¡/bšd.hµ
>

12 
	~<boo¡/cœcuÏr_bufãr.hµ
>

13 
	~<boo¡/ty³_Œa™s/is_pod.hµ
>

15 
	~<s¡»am
>

16 
	~<¡d¬g.h
>

17 
	~<¡dio.h
>

19 
usšg
 
Çme¥aû
 
	gmuduo
;

20 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

27 
	sStD©a


29 
·r£
(cÚ¡ * 
¡¬tAtS‹
, 
kbP”Page
)

33 
	m¡d
::
i¡ršg¡»am
 
iss
(
¡¬tAtS‹
);

42 
	miss
 >> 
	m¡©e
;

43 
	miss
 >> 
	mµid
 >> 
	mpg½
 >> 
	m£ssiÚ
 >> 
	m‰y_Ä
 >> 
	mgid
 >> 
	mæags
;

44 
	miss
 >> 
	mmšæt
 >> 
	mcmšæt
 >> 
	mmajæt
 >> 
	mcmajæt
;

45 
	miss
 >> 
	mutime
 >> 
	m¡ime
 >> 
	mcutime
 >> 
	mc¡ime
;

46 
	miss
 >> 
	m´iÜ™y
 >> 
	mniû
 >> 
	mnum_th»ads
 >> 
	m™»®v®ue
 >> 
	m¡¬‰ime
;

47 
	mvsize
, 
	mrss
;

48 
	miss
 >> 
	mvsize
 >> 
	mrss
 >> 
	mrs¦im
;

49 
	mvsizeKb
 = 
vsize
 / 1024;

50 
	mrssKb
 = 
rss
 * 
kbP”Page
;

53 
	m¡©e
;

54 
	mµid
;

55 
	mpg½
;

56 
	m£ssiÚ
;

57 
	m‰y_Ä
;

58 
	mgid
;

59 
	mæags
;

61 
	mmšæt
;

62 
	mcmšæt
;

63 
	mmajæt
;

64 
	mcmajæt
;

66 
	mutime
;

67 
	m¡ime
;

68 
	mcutime
;

69 
	mc¡ime
;

71 
	m´iÜ™y
;

72 
	mniû
;

73 
	mnum_th»ads
;

74 
	m™»®v®ue
;

75 
	m¡¬‰ime
;

77 
	mvsizeKb
;

78 
	mrssKb
;

79 
	mrs¦im
;

82 
BOOST_STATIC_ASSERT
(
boo¡
::
is_pod
<
StD©a
>::
v®ue
);

84 şas 
	cProcmÚ
 : 
boo¡
::
nÚcİyabË


86 
public
:

87 
	$ProcmÚ
(
Ev’tLoİ
* 
loİ
, 
pid_t
 
pid
, 
ušt16_t
 
pÜt
, cÚ¡ * 
´oúame
)

88 : 
	`kClockTicksP”SecÚd_
(
muduo
::
ProûssInfo
::
	`şockTicksP”SecÚd
()),

89 
	`kbP”Page_
(
muduo
::
ProûssInfo
::
	`·geSize
() / 1024),

90 
	`kBoÙTime_
(
	`g‘BoÙTime
()),

91 
	`pid_
(
pid
),

92 
	`£rv”_
(
loİ
, 
	`IÃtAdd»ss
(
pÜt
), 
	`g‘Name
()),

93 
	`´oúame_
(
ProûssInfo
::
	`´oúame
(
	`»adProcFe
("¡©")).
	`as_¡ršg
()),

94 
	`ho¡Çme_
(
ProûssInfo
::
	`ho¡Çme
()),

95 
	`cmdlše_
(
	`g‘CmdLše
()),

96 
	`ticks_
(0),

97 
	`ıu_u§ge_
(600 / 
kP”iod_
),

98 
	`ıu_ch¬t_
(640, 100, 600, 
kP”iod_
),

99 
	$¿m_ch¬t_
(640, 100, 7200, 30)

101 
	`bz”o
(&
Ï¡StD©a_
, †astStatData_);

102 
£rv”_
.
	`£tH‰pC®lback
(
boo¡
::
	`bšd
(&
ProcmÚ
::
ÚReque¡
, 
this
, 
_1
, 
_2
));

105 
	$¡¬t
()

107 
	`tick
();

108 
£rv”_
.
	`g‘Loİ
()->
	`runEv”y
(
kP”iod_
, 
boo¡
::
	`bšd
(&
ProcmÚ
::
tick
, 
this
));

109 
£rv”_
.
	`¡¬t
();

110 
	}
}

112 
	g´iv©e
:

114 
¡ršg
 
	$g‘Name
() const

116 
Çme
[256];

117 
	`¢´štf
(
Çme
, ‚ame, "´ocmÚ-%d", 
pid_
);

118  
Çme
;

119 
	}
}

121 
	$ÚReque¡
(cÚ¡ 
H‰pReque¡
& 
»q
, 
H‰pRe¥Ú£
* 
»¥
)

123 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k200Ok
);

124 
»¥
->
	`£tStusMes§ge
("OK");

125 
»¥
->
	`£tCÚ‹ÁTy³
("text/plain");

126 
»¥
->
	`addH—d”
("Server", "Muduo-Procmon");

138 ià(
»q
.
	`·th
() == "/")

140 
»¥
->
	`£tCÚ‹ÁTy³
("text/html");

141 
	`flOv”v›w
(
»q
.
	`qu”y
());

142 
»¥
->
	`£tBody
(
»¥Ú£_
.
	`»Œ›veAÎAsSŒšg
());

144 ià(
»q
.
	`·th
() == "/cmdline")

146 
»¥
->
	`£tBody
(
cmdlše_
);

148 ià(
»q
.
	`·th
() == "/cpu.png")

150 
¡d
::
veùÜ
<> 
ıu_u§ge
;

151 
size_t
 
i
 = 0; i < 
ıu_u§ge_
.
	`size
(); ++i)

152 
ıu_u§ge
.
	`push_back
(
ıu_u§ge_
[
i
].
	`ıuU§ge
(
kP”iod_
, 
kClockTicksP”SecÚd_
));

153 
¡ršg
 
²g
 = 
ıu_ch¬t_
.
	`¶ÙCpu
(
ıu_u§ge
);

154 
»¥
->
	`£tCÚ‹ÁTy³
("image/png");

155 
»¥
->
	`£tBody
(
²g
);

158 ià(
»q
.
	`·th
() == "/environ")

160 
»¥
->
	`£tBody
(
	`g‘EnvœÚ
());

162 ià(
»q
.
	`·th
() == "/io")

164 
»¥
->
	`£tBody
(
	`»adProcFe
("io"));

166 ià(
»q
.
	`·th
() == "/limits")

168 
»¥
->
	`£tBody
(
	`»adProcFe
("limits"));

170 ià(
»q
.
	`·th
() == "/maps")

172 
»¥
->
	`£tBody
(
	`»adProcFe
("maps"));

175 ià(
»q
.
	`·th
() == "/smaps")

177 
»¥
->
	`£tBody
(
	`»adProcFe
("smaps"));

179 ià(
»q
.
	`·th
() == "/status")

181 
»¥
->
	`£tBody
(
	`»adProcFe
("status"));

183 ià(
»q
.
	`·th
() == "/threads")

185 
	`flTh»ads
();

186 
»¥
->
	`£tBody
(
»¥Ú£_
.
	`»Œ›veAÎAsSŒšg
());

190 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k404NÙFound
);

191 
»¥
->
	`£tStusMes§ge
("Not Found");

192 
»¥
->
	`£tClo£CÚÃùiÚ
(
Œue
);

194 
	}
}

196 
	$flOv”v›w
(cÚ¡ 
¡ršg
& 
qu”y
)

198 
»¥Ú£_
.
	`»Œ›veAÎ
();

199 
Time¡amp
 
now
 = Time¡amp::
	`now
();

200 
	`­³ndRe¥Ú£
("<html><head><title>%s on %s</title>\n",

201 
´oúame_
.
	`c_¡r
(), 
ho¡Çme_
.c_str());

202 
	`flReäesh
(
qu”y
);

203 
	`­³ndRe¥Ú£
("</head><body>\n");

205 
¡ršg
 
¡©
 = 
	`»adProcFe
("stat");

206 ià(
¡©
.
	`em±y
())

208 
	`­³ndRe¥Ú£
("<h1>PID %d dÛ¢'ˆexi¡.</h1></body></html>", 
pid_
);

211 
pid
 = 
	`©oi
(
¡©
.
	`c_¡r
());

212 
	`as£¹
(
pid
 =ğ
pid_
);

213 
SŒšgP›û
 
´oúame
 = 
ProûssInfo
::
	`´oúame
(
¡©
);

214 
	`­³ndRe¥Ú£
("<h1>%s on %s</h1>\n",

215 
´oúame
.
	`as_¡ršg
().
	`c_¡r
(), 
ho¡Çme_
.c_str());

216 
»¥Ú£_
.
	`­³nd
("<p>Refresh <a href=\"?refresh=1\">1s</a> ");

217 
»¥Ú£_
.
	`­³nd
("<a href=\"?refresh=2\">2s</a> ");

218 
»¥Ú£_
.
	`­³nd
("<a href=\"?refresh=5\">5s</a> ");

219 
»¥Ú£_
.
	`­³nd
("<a href=\"?refresh=15\">15s</a> ");

220 
»¥Ú£_
.
	`­³nd
("<a href=\"?refresh=60\">60s</a>\n");

221 
»¥Ú£_
.
	`­³nd
("<p><a href=\"/cmdline\">Command†ine</a>\n");

222 
»¥Ú£_
.
	`­³nd
("<a href=\"/environ\">Environment variables</a>\n");

223 
»¥Ú£_
.
	`­³nd
("<a href=\"/threads\">Threads</a>\n");

225 
	`­³ndRe¥Ú£
("<p>Pagg’”©ed‡ˆ% (UTC)", 
now
.
	`toFÜm©‹dSŒšg
().
	`c_¡r
());

227 
»¥Ú£_
.
	`­³nd
("<p><table>");

228 
StD©a
 
¡©D©a
;

229 
	`bz”o
(&
¡©D©a
,  statData);

230 
¡©D©a
.
	`·r£
(
´oúame
.
	`’d
()+1, 
kbP”Page_
);

232 
	`­³ndTabËRow
("PID", 
pid
);

233 
Time¡amp
 
	`¡¬‹d
(
	`g‘S¹Time
(
¡©D©a
.
¡¬‰ime
));

234 
	`­³ndTabËRow
("S¹ed‡t", 
¡¬‹d
.
	`toFÜm©‹dSŒšg
(
çl£
 ) + " (UTC)");

235 
	`­³ndTabËRowFlßt
("U±im(s)", 
	`timeDifã»nû
(
now
, 
¡¬‹d
));

236 
	`­³ndTabËRow
("ExecubË", 
	`»adLšk
("exe"));

237 
	`­³ndTabËRow
("Cu¼’ˆdœ", 
	`»adLšk
("cwd"));

239 
	`­³ndTabËRow
("S‹", 
	`g‘S‹
(
¡©D©a
.
¡©e
));

240 
	`­³ndTabËRowFlßt
("U£¸tim(s)", 
	`g‘SecÚds
(
¡©D©a
.
utime
));

241 
	`­³ndTabËRowFlßt
("Sy¡emim(s)", 
	`g‘SecÚds
(
¡©D©a
.
¡ime
));

243 
	`­³ndTabËRow
("VmSiz(KiB)", 
¡©D©a
.
vsizeKb
);

244 
	`­³ndTabËRow
("VmRSS (KiB)", 
¡©D©a
.
rssKb
);

245 
	`­³ndTabËRow
("Th»ads", 
¡©D©a
.
num_th»ads
);

246 
	`­³ndTabËRow
("CPU usage", "<img src=\"/cpu.png\" height=\"100\" witdh=\"640\">");

248 
	`­³ndTabËRow
("PriÜ™y", 
¡©D©a
.
´iÜ™y
);

249 
	`­³ndTabËRow
("Niû", 
¡©D©a
.
niû
);

251 
	`­³ndTabËRow
("MšÜ…agçuÉs", 
¡©D©a
.
mšæt
);

252 
	`­³ndTabËRow
("MajÜ…agçuÉs", 
¡©D©a
.
majæt
);

255 
»¥Ú£_
.
	`­³nd
("</table>");

256 
»¥Ú£_
.
	`­³nd
("</body></html>");

257 
	}
}

259 
	$flReäesh
(cÚ¡ 
¡ršg
& 
qu”y
)

261 
size_t
 
p
 = 
qu”y
.
	`fšd
("refresh=");

262 ià(
p
 !ğ
¡ršg
::
Åos
)

264 
£cÚds
 = 
	`©oi
(
qu”y
.
	`c_¡r
()+
p
+8);

265 ià(
£cÚds
 > 0)

267 
	`­³ndRe¥Ú£
("<m‘¨h‰p-equiv=\"»äesh\" cÚ‹Á=\"%d\">\n", 
£cÚds
);

270 
	}
}

272 
	$flTh»ads
()

274 
»¥Ú£_
.
	`»Œ›veAÎ
();

276 
	}
}

278 
¡ršg
 
	$»adProcFe
(cÚ¡ * 
ba£Çme
)

280 
f’ame
[256];

281 
	`¢´štf
(
f’ame
,  f’ame, "/´oc/%d/%s", 
pid_
, 
ba£Çme
);

282 
¡ršg
 
cÚ‹Á
;

283 
FeUt
::
	`»adFe
(
f’ame
, 1024*1024, &
cÚ‹Á
);

284  
cÚ‹Á
;

285 
	}
}

287 
¡ršg
 
	$»adLšk
(cÚ¡ * 
ba£Çme
)

289 
f’ame
[256];

290 
	`¢´štf
(
f’ame
,  f’ame, "/´oc/%d/%s", 
pid_
, 
ba£Çme
);

291 
lšk
[1024];

292 
ssize_t
 
Ën
 = ::
	`»adlšk
(
f’ame
, 
lšk
, †ink);

293 
¡ršg
 
»suÉ
;

294 ià(
Ën
 > 0)

296 
»suÉ
.
	`assign
(
lšk
, 
Ën
);

298  
»suÉ
;

299 
	}
}

301 
	$­³ndRe¥Ú£
(cÚ¡ * 
fmt
, ...è
	`__©Œibu‹__
 ((
	`fÜm©
 (
´štf
, 2, 3)));

303 
	$­³ndTabËRow
(cÚ¡ * 
Çme
, 
v®ue
)

305 
	`­³ndRe¥Ú£
("<Œ><td>%s</td><td>%ld</td></Œ>\n", 
Çme
, 
v®ue
);

306 
	}
}

308 
	$­³ndTabËRowFlßt
(cÚ¡ * 
Çme
, 
v®ue
)

310 
	`­³ndRe¥Ú£
("<Œ><td>%s</td><td>%.2f</td></Œ>\n", 
Çme
, 
v®ue
);

311 
	}
}

313 
	$­³ndTabËRow
(cÚ¡ * 
Çme
, 
SŒšgArg
 
v®ue
)

315 
	`­³ndRe¥Ú£
("<Œ><td>%s</td><td>%s</td></Œ>\n", 
Çme
, 
v®ue
.
	`c_¡r
());

316 
	}
}

318 
¡ršg
 
	$g‘CmdLše
()

320  
boo¡
::
	`»¶aû_®l_cİy
(
	`»adProcFe
("cmdlše"), 
	`¡ršg
(1, '\0'), "\n\t");

321 
	}
}

323 
¡ršg
 
	$g‘EnvœÚ
()

325  
boo¡
::
	`»¶aû_®l_cİy
(
	`»adProcFe
("’vœÚ"), 
	`¡ršg
(1, '\0'), "\n");

326 
	}
}

328 
Time¡amp
 
	$g‘S¹Time
(
¡¬‰ime
)

330  
	`Time¡amp
(
Time¡amp
::
kMiüoSecÚdsP”SecÚd
 * 
kBoÙTime_


331 + 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
 * 
¡¬‰ime
 / 
kClockTicksP”SecÚd_
);

332 
	}
}

334 
	$g‘SecÚds
(
ticks
)

336  
¡©ic_ÿ¡
<>(
ticks
è/ 
kClockTicksP”SecÚd_
;

337 
	}
}

339 
	$tick
()

341 
¡ršg
 
¡©
 = 
	`»adProcFe
("stat");

342 ià(
¡©
.
	`em±y
())

344 
SŒšgP›û
 
´oúame
 = 
ProûssInfo
::
	`´oúame
(
¡©
);

345 
StD©a
 
¡©D©a
;

346 
	`bz”o
(&
¡©D©a
,  statData);

347 
¡©D©a
.
	`·r£
(
´oúame
.
	`’d
()+1, 
kbP”Page_
);

348 ià(
ticks_
 > 0)

350 
CpuTime
 
time
;

351 
time
.
u£rTime_
 = 
¡d
::
	`max
(0, 
¡©ic_ÿ¡
<>(
¡©D©a
.
utime
 - 
Ï¡StD©a_
.utime));

352 
time
.
sysTime_
 = 
¡d
::
	`max
(0, 
¡©ic_ÿ¡
<>(
¡©D©a
.
¡ime
 - 
Ï¡StD©a_
.stime));

353 
ıu_u§ge_
.
	`push_back
(
time
);

356 
Ï¡StD©a_
 = 
¡©D©a
;

357 ++
ticks_
;

358 
	}
}

364 cÚ¡ * 
	$g‘S‹
(
¡©e
)

369 
¡©e
)

382 
	}
}

384 
	$g‘LÚg
(cÚ¡ 
¡ršg
& 
¡©us
, cÚ¡ * 
key
)

386 
»suÉ
 = 0;

387 
size_t
 
pos
 = 
¡©us
.
	`fšd
(
key
);

388 ià(
pos
 !ğ
¡ršg
::
Åos
)

390 
»suÉ
 = ::
	`©Ş
(
¡©us
.
	`c_¡r
(è+ 
pos
 + 
	`¡¾’
(
key
));

392  
»suÉ
;

393 
	}
}

395 
	$g‘BoÙTime
()

397 
¡ršg
 
¡©
;

398 
FeUt
::
	`»adFe
("/´oc/¡©", 65536, &
¡©
);

399  
	`g‘LÚg
(
¡©
, "btime ");

400 
	}
}

402 
	sCpuTime


404 
	gu£rTime_
;

405 
	gsysTime_
;

406 
ıuU§ge
(
kP”iod
, 
kClockTicksP”SecÚd
) const

408  (
	gu£rTime_
 + 
	gsysTime_
è/ (
kClockTicksP”SecÚd
 * 
	gkP”iod
);

412 cÚ¡ 
	gkP”iod_
 = 2.0;

413 cÚ¡ 
	gkClockTicksP”SecÚd_
;

414 cÚ¡ 
	gkbP”Page_
;

415 cÚ¡ 
	gkBoÙTime_
;

416 cÚ¡ 
pid_t
 
	gpid_
;

417 
H‰pS”v”
 
	g£rv”_
;

418 cÚ¡ 
¡ršg
 
	g´oúame_
;

419 cÚ¡ 
¡ršg
 
	gho¡Çme_
;

420 cÚ¡ 
¡ršg
 
	gcmdlše_
;

421 
	gticks_
;

422 
StD©a
 
	gÏ¡StD©a_
;

423 
	gboo¡
::
cœcuÏr_bufãr
<
CpuTime
> 
ıu_u§ge_
;

424 
PlÙ
 
	gıu_ch¬t_
;

425 
PlÙ
 
	g¿m_ch¬t_
;

427 
Bufãr
 
	g»¥Ú£_
;

431 
	gProcmÚ
::
	$­³ndRe¥Ú£
(cÚ¡ * 
fmt
, ...)

433 
buf
[1024];

434 
va_li¡
 
¬gs
;

435 
	`va_¡¬t
(
¬gs
, 
fmt
);

436 
»t
 = 
	`v¢´štf
(
buf
,  buf, 
fmt
, 
¬gs
);

437 
	`va_’d
(
¬gs
);

438 
»¥Ú£_
.
	`­³nd
(
buf
);

439  
»t
;

440 
	}
}

442 
boŞ
 
	$´oûssExi¡s
(
pid_t
 
pid
)

444 
f’ame
[256];

445 
	`¢´štf
(
f’ame
,  f’ame, "/´oc/%d/¡©", 
pid
);

446  ::
	`acûss
(
f’ame
, 
R_OK
) == 0;

447 
	}
}

449 
	$maš
(
¬gc
, * 
¬gv
[])

451 ià(
¬gc
 < 3)

453 
	`´štf
("U§ge: % pid…Üˆ[Çme]\n", 
¬gv
[0]);

456 
pid
 = 
	`©oi
(
¬gv
[1]);

457 ià(!
	`´oûssExi¡s
(
pid
))

459 
	`´štf
("Proûs %d dÛ¢'ˆexi¡.\n", 
pid
);

463 
Ev’tLoİ
 
loİ
;

464 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

465 
ProcmÚ
 
	`´ocmÚ
(&
loİ
, 
pid
, 
pÜt
, 
¬gc
 > 3 ? 
¬gv
[3] : "");

466 
´ocmÚ
.
	`¡¬t
();

467 
loİ
.
	`loİ
();

468 
	}
}

	@examples/protobuf/codec/client.cc

1 
	~"di¥©ch”.h
"

2 
	~"codec.h
"

3 
	~<exam¶es/´Ùobuf/codec/qu”y.pb.h
>

5 
	~<muduo/ba£/Loggšg.h
>

6 
	~<muduo/ba£/Mu‹x.h
>

7 
	~<muduo/Ãt/Ev’tLoİ.h
>

8 
	~<muduo/Ãt/TıCl›Á.h
>

10 
	~<boo¡/bšd.hµ
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 
	gboo¡
::
	tsh¬ed_±r
<
	tmuduo
::
	tEm±y
> 
	tEm±yPŒ
;

19 
	gboo¡
::
	tsh¬ed_±r
<
	tmuduo
::
	tAnsw”
> 
	tAnsw”PŒ
;

21 
	ggoogË
::
´Ùobuf
::
Mes§ge
* 
mes§geToS’d
;

23 şas 
	cQu”yCl›Á
 : 
boo¡
::
nÚcİyabË


25 
public
:

26 
	$Qu”yCl›Á
(
Ev’tLoİ
* 
loİ
,

27 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
)

28 : 
	`loİ_
(
loİ
),

29 
	`ş›Á_
(
loİ
, 
£rv”Addr
, "QueryClient"),

30 
	`di¥©ch”_
(
boo¡
::
	`bšd
(&
Qu”yCl›Á
::
ÚUnknownMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

31 
	`codec_
(
boo¡
::
	`bšd
(&
PrÙobufDi¥©ch”
::
ÚPrÙobufMes§ge
, &
di¥©ch”_
, 
_1
, 
_2
, 
_3
))

33 
di¥©ch”_
.
»gi¡”Mes§geC®lback
<
muduo
::
Answ”
>(

34 
boo¡
::
	`bšd
(&
Qu”yCl›Á
::
ÚAnsw”
, 
this
, 
_1
, 
_2
, 
_3
));

35 
di¥©ch”_
.
»gi¡”Mes§geC®lback
<
muduo
::
Em±y
>(

36 
boo¡
::
	`bšd
(&
Qu”yCl›Á
::
ÚEm±y
, 
this
, 
_1
, 
_2
, 
_3
));

37 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

38 
boo¡
::
	`bšd
(&
Qu”yCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

39 
ş›Á_
.
	`£tMes§geC®lback
(

40 
boo¡
::
	`bšd
(&
PrÙobufCodec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

43 
	$cÚÃù
()

45 
ş›Á_
.
	`cÚÃù
();

46 
	}
}

48 
	g´iv©e
:

50 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

52 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

53 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

54 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

56 ià(
cÚn
->
	`cÚÃùed
())

58 
codec_
.
	`£nd
(
cÚn
, *
mes§geToS’d
);

62 
loİ_
->
	`qu™
();

64 
	}
}

66 
	$ÚUnknownMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

67 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

68 
Time¡amp
)

70 
LOG_INFO
 << "ÚUnknownMes§ge: " << 
mes§ge
->
	`G‘Ty³Name
();

71 
	}
}

73 
ÚAnsw”
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

74 cÚ¡ 
Answ”PŒ
& 
mes§ge
,

75 
muduo
::
Time¡amp
)

77 
LOG_INFO
 << "ÚAnsw”:\n" << 
mes§ge
->
G‘Ty³Name
(è<< mes§ge->
DebugSŒšg
();

80 
ÚEm±y
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

81 cÚ¡ 
Em±yPŒ
& 
mes§ge
,

82 
muduo
::
Time¡amp
)

84 
LOG_INFO
 << "ÚEm±y: " << 
mes§ge
->
G‘Ty³Name
();

87 
Ev’tLoİ
* 
	gloİ_
;

88 
TıCl›Á
 
	gş›Á_
;

89 
PrÙobufDi¥©ch”
 
	gdi¥©ch”_
;

90 
PrÙobufCodec
 
	gcodec_
;

93 
	$maš
(
¬gc
, * 
¬gv
[])

95 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

96 ià(
¬gc
 > 2)

98 
Ev’tLoİ
 
loİ
;

99 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

100 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 
pÜt
);

102 
muduo
::
Qu”y
 
qu”y
;

103 
qu”y
.
	`£t_id
(1);

104 
qu”y
.
	`£t_que¡iÚ”
("Chen Shuo");

105 
qu”y
.
	`add_que¡iÚ
("Running?");

106 
muduo
::
Em±y
 
em±y
;

107 
mes§geToS’d
 = &
qu”y
;

109 ià(
¬gc
 > 3 && 
¬gv
[3][0] == 'e')

111 
mes§geToS’d
 = &
em±y
;

114 
Qu”yCl›Á
 
	`ş›Á
(&
loİ
, 
£rv”Addr
);

115 
ş›Á
.
	`cÚÃù
();

116 
loİ
.
	`loİ
();

120 
	`´štf
("U§ge: % ho¡_…Üˆ[q|e]\n", 
¬gv
[0]);

122 
	}
}

	@examples/protobuf/codec/codec.cc

9 
	~"codec.h
"

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/Ãt/EndŸn.h
>

13 
	~<muduo/Ãt/´ÙÜpc/googË-šl.h
>

15 
	~<googË/´Ùobuf/desütÜ.h
>

17 
	~<zlib.h
>

19 
usšg
 
Çme¥aû
 
	gmuduo
;

20 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

22 
	gPrÙobufCodec
::
flEm±yBufãr
(
Bufãr
* 
buf
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
)

25 
as£¹
(
buf
->
»adabËBy‹s
() == 0);

27 cÚ¡ 
	g¡d
::
¡ršg
& 
ty³Name
 = 
mes§ge
.
G‘Ty³Name
();

28 
št32_t
 
	gÇmeL’
 = 
¡©ic_ÿ¡
<št32_t>(
ty³Name
.
size
()+1);

29 
	gbuf
->
­³ndIÁ32
(
ÇmeL’
);

30 
	gbuf
->
­³nd
(
ty³Name
.
c_¡r
(), 
ÇmeL’
);

33 
GOOGLE_DCHECK
(
mes§ge
.
IsIn™Ÿlized
()è<< 
In™Ÿliz©iÚE¼ÜMes§ge
("serialize", message);

35 
	gby‹_size
 = 
mes§ge
.
By‹Size
();

36 
	gbuf
->
’su»Wr™abËBy‹s
(
by‹_size
);

38 
ušt8_t
* 
	g¡¬t
 = 
»š‹½»t_ÿ¡
<ušt8_t*>(
buf
->
begšWr™e
());

39 
ušt8_t
* 
	g’d
 = 
mes§ge
.
S”ŸlizeW™hCachedSizesToA¼ay
(
¡¬t
);

40 ià(
	g’d
 - 
	g¡¬t
 !ğ
by‹_size
)

42 
By‹SizeCÚsi¡’cyE¼Ü
(
by‹_size
, 
mes§ge
.
By‹Size
(), 
¡©ic_ÿ¡
<>(
’d
 - 
¡¬t
));

44 
	gbuf
->
hasWr™‹n
(
by‹_size
);

46 
št32_t
 
	gcheckSum
 = 
¡©ic_ÿ¡
<int32_t>(

47 ::
adËr32
(1,

48 
»š‹½»t_ÿ¡
<cÚ¡ 
By‹f
*>(
buf
->
³ek
()),

49 
¡©ic_ÿ¡
<>(
buf
->
»adabËBy‹s
())));

50 
	gbuf
->
­³ndIÁ32
(
checkSum
);

51 
as£¹
(
buf
->
»adabËBy‹s
(è=ğ 
ÇmeL’
 +‚ameL’ + 
by‹_size
 +  
checkSum
);

52 
št32_t
 
	gËn
 = 
sock‘s
::
ho¡ToN‘wÜk32
(
¡©ic_ÿ¡
<št32_t>(
buf
->
»adabËBy‹s
()));

53 
	gbuf
->
´•’d
(&
Ën
, †en);

64 
	gÇme¥aû


66 cÚ¡ 
¡ršg
 
	gkNoE¼ÜSŒ
 = "NoError";

67 cÚ¡ 
¡ršg
 
	gkInv®idL’gthSŒ
 = "InvalidLength";

68 cÚ¡ 
¡ršg
 
	gkCheckSumE¼ÜSŒ
 = "CheckSumError";

69 cÚ¡ 
¡ršg
 
	gkInv®idNameL’SŒ
 = "InvalidNameLen";

70 cÚ¡ 
¡ršg
 
	gkUnknownMes§geTy³SŒ
 = "UnknownMessageType";

71 cÚ¡ 
¡ršg
 
	gkP¬£E¼ÜSŒ
 = "ParseError";

72 cÚ¡ 
¡ršg
 
	gkUnknownE¼ÜSŒ
 = "UnknownError";

75 cÚ¡ 
	g¡ršg
& 
	gPrÙobufCodec
::
	$”rÜCodeToSŒšg
(
E¼ÜCode
 
”rÜCode
)

77 
”rÜCode
)

79 
kNoE¼Ü
:

80  
kNoE¼ÜSŒ
;

81 
kInv®idL’gth
:

82  
kInv®idL’gthSŒ
;

83 
kCheckSumE¼Ü
:

84  
kCheckSumE¼ÜSŒ
;

85 
kInv®idNameL’
:

86  
kInv®idNameL’SŒ
;

87 
kUnknownMes§geTy³
:

88  
kUnknownMes§geTy³SŒ
;

89 
kP¬£E¼Ü
:

90  
kP¬£E¼ÜSŒ
;

92  
kUnknownE¼ÜSŒ
;

94 
	}
}

96 
	gPrÙobufCodec
::
deçuÉE¼ÜC®lback
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

97 
muduo
::
Ãt
::
Bufãr
* 
buf
,

98 
muduo
::
Time¡amp
,

99 
E¼ÜCode
 
”rÜCode
)

101 
	gLOG_ERROR
 << "PrÙobufCodec::deçuÉE¼ÜC®lback - " << 
”rÜCodeToSŒšg
(
”rÜCode
);

102 ià(
	gcÚn
 && cÚn->
cÚÃùed
())

104 
	gcÚn
->
shutdown
();

108 
št32_t
 
	$asIÁ32
(cÚ¡ * 
buf
)

110 
št32_t
 
be32
 = 0;

111 ::
	`memıy
(&
be32
, 
buf
, (be32));

112  
sock‘s
::
	`ÃtwÜkToHo¡32
(
be32
);

113 
	}
}

115 
	gPrÙobufCodec
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

116 
Bufãr
* 
buf
,

117 
Time¡amp
 
»ûiveTime
)

119 
buf
->
	`»adabËBy‹s
(è>ğ
kMšMes§geL’
 + 
kH—d”L’
)

121 cÚ¡ 
št32_t
 
Ën
 = 
buf
->
	`³ekIÁ32
();

122 ià(
Ën
 > 
kMaxMes§geL’
 ||†’ < 
kMšMes§geL’
)

124 
	`”rÜC®lback_
(
cÚn
, 
buf
, 
»ûiveTime
, 
kInv®idL’gth
);

127 ià(
buf
->
	`»adabËBy‹s
(è>ğ
im¶ic™_ÿ¡
<
size_t
>(
Ën
 + 
kH—d”L’
))

129 
E¼ÜCode
 
”rÜCode
 = 
kNoE¼Ü
;

130 
Mes§gePŒ
 
mes§ge
 = 
	`·r£
(
buf
->
	`³ek
()+
kH—d”L’
, 
Ën
, &
”rÜCode
);

131 ià(
”rÜCode
 =ğ
kNoE¼Ü
 && 
mes§ge
)

133 
	`mes§geC®lback_
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

134 
buf
->
	`»Œ›ve
(
kH—d”L’
+
Ën
);

138 
	`”rÜC®lback_
(
cÚn
, 
buf
, 
»ûiveTime
, 
”rÜCode
);

147 
	}
}

149 
	ggoogË
::
´Ùobuf
::
Mes§ge
* 
PrÙobufCodec
::
ü—‹Mes§ge
(cÚ¡ 
¡d
::
¡ršg
& 
ty³Name
)

151 
googË
::
´Ùobuf
::
Mes§ge
* 
mes§ge
 = 
NULL
;

152 cÚ¡ 
	ggoogË
::
´Ùobuf
::
DesütÜ
* 
desütÜ
 =

153 
googË
::
´Ùobuf
::
DesütÜPoŞ
::
g’”©ed_poŞ
()->
FšdMes§geTy³ByName
(
ty³Name
);

154 ià(
	gdesütÜ
)

156 cÚ¡ 
	ggoogË
::
´Ùobuf
::
Mes§ge
* 
´ÙÙy³
 =

157 
googË
::
´Ùobuf
::
Mes§geFaùÜy
::
g’”©ed_çùÜy
()->
G‘PrÙÙy³
(
desütÜ
);

158 ià(
	g´ÙÙy³
)

160 
	gmes§ge
 = 
´ÙÙy³
->
New
();

163  
	gmes§ge
;

166 
Mes§gePŒ
 
	gPrÙobufCodec
::
	$·r£
(cÚ¡ * 
buf
, 
Ën
, 
E¼ÜCode
* 
”rÜ
)

168 
Mes§gePŒ
 
mes§ge
;

171 
št32_t
 
ex³ùedCheckSum
 = 
	`asIÁ32
(
buf
 + 
Ën
 - 
kH—d”L’
);

172 
št32_t
 
checkSum
 = 
¡©ic_ÿ¡
<int32_t>(

173 ::
	`adËr32
(1,

174 
»š‹½»t_ÿ¡
<cÚ¡ 
By‹f
*>(
buf
),

175 
¡©ic_ÿ¡
<>(
Ën
 - 
kH—d”L’
)));

176 ià(
checkSum
 =ğ
ex³ùedCheckSum
)

179 
št32_t
 
ÇmeL’
 = 
	`asIÁ32
(
buf
);

180 ià(
ÇmeL’
 >ğ2 &&‚ameL’ <ğ
Ën
 - 2*
kH—d”L’
)

182 
¡d
::
¡ršg
 
	`ty³Name
(
buf
 + 
kH—d”L’
, buà+ kH—d”L’ + 
ÇmeL’
 - 1);

184 
mes§ge
.
	`»£t
(
	`ü—‹Mes§ge
(
ty³Name
));

185 ià(
mes§ge
)

188 cÚ¡ * 
d©a
 = 
buf
 + 
kH—d”L’
 + 
ÇmeL’
;

189 
št32_t
 
d©aL’
 = 
Ën
 - 
ÇmeL’
 - 2*
kH—d”L’
;

190 ià(
mes§ge
->
	`P¬£FromA¼ay
(
d©a
, 
d©aL’
))

192 *
”rÜ
 = 
kNoE¼Ü
;

196 *
”rÜ
 = 
kP¬£E¼Ü
;

201 *
”rÜ
 = 
kUnknownMes§geTy³
;

206 *
”rÜ
 = 
kInv®idNameL’
;

211 *
”rÜ
 = 
kCheckSumE¼Ü
;

214  
mes§ge
;

215 
	}
}

	@examples/protobuf/codec/codec.h

9 #iâdeà
MUDUO_EXAMPLES_PROTOBUF_CODEC_CODEC_H


10 
	#MUDUO_EXAMPLES_PROTOBUF_CODEC_CODEC_H


	)

12 
	~<muduo/Ãt/Bufãr.h
>

13 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

15 
	~<boo¡/funùiÚ.hµ
>

16 
	~<boo¡/nÚcİyabË.hµ
>

17 
	~<boo¡/sh¬ed_±r.hµ
>

19 
	~<googË/´Ùobuf/mes§ge.h
>

30 
	gboo¡
::
	tsh¬ed_±r
<
	tgoogË
::
	t´Ùobuf
::
	tMes§ge
> 
	tMes§gePŒ
;

35 şas 
	cPrÙobufCodec
 : 
boo¡
::
nÚcİyabË


37 
public
:

39 
	eE¼ÜCode


41 
kNoE¼Ü
 = 0,

42 
	mkInv®idL’gth
,

43 
	mkCheckSumE¼Ü
,

44 
	mkInv®idNameL’
,

45 
	mkUnknownMes§geTy³
,

46 
	mkP¬£E¼Ü
,

49 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

50 cÚ¡ 
	tMes§gePŒ
&,

51 
	tmuduo
::
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

53 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

54 
	tmuduo
::
	tÃt
::
	tBufãr
*,

55 
	tmuduo
::
	tTime¡amp
,

56 
	tE¼ÜCode
)> 
	tE¼ÜC®lback
;

58 
ex¶ic™
 
	$PrÙobufCodec
(cÚ¡ 
PrÙobufMes§geC®lback
& 
mes§geCb
)

59 : 
	`mes§geC®lback_
(
mes§geCb
),

60 
	$”rÜC®lback_
(
deçuÉE¼ÜC®lback
)

62 
	}
}

64 
	$PrÙobufCodec
(cÚ¡ 
PrÙobufMes§geC®lback
& 
mes§geCb
, cÚ¡ 
E¼ÜC®lback
& 
”rÜCb
)

65 : 
	`mes§geC®lback_
(
mes§geCb
),

66 
	$”rÜC®lback_
(
”rÜCb
)

68 
	}
}

70 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

71 
muduo
::
Ãt
::
Bufãr
* 
buf
,

72 
muduo
::
Time¡amp
 
»ûiveTime
);

74 
£nd
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

75 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
)

78 
muduo
::
Ãt
::
Bufãr
 
buf
;

79 
flEm±yBufãr
(&
buf
, 
mes§ge
);

80 
	gcÚn
->
£nd
(&
buf
);

83 cÚ¡ 
	gmuduo
::
¡ršg
& 
”rÜCodeToSŒšg
(
E¼ÜCode
 
”rÜCode
);

84 
flEm±yBufãr
(
muduo
::
Ãt
::
Bufãr
* 
buf
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
);

85 
	ggoogË
::
´Ùobuf
::
Mes§ge
* 
ü—‹Mes§ge
(cÚ¡ 
¡d
::
¡ršg
& 
ty³_Çme
);

86 
Mes§gePŒ
 
·r£
(cÚ¡ * 
buf
, 
Ën
, 
E¼ÜCode
* 
”rÜCode
);

88 
	g´iv©e
:

89 
deçuÉE¼ÜC®lback
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

90 
muduo
::
Ãt
::
Bufãr
*,

91 
muduo
::
Time¡amp
,

92 
E¼ÜCode
);

94 
PrÙobufMes§geC®lback
 
	gmes§geC®lback_
;

95 
E¼ÜC®lback
 
	g”rÜC®lback_
;

97 cÚ¡ 
	gkH—d”L’
 = (
št32_t
);

98 cÚ¡ 
	gkMšMes§geL’
 = 2*
kH—d”L’
 + 2;

99 cÚ¡ 
	gkMaxMes§geL’
 = 64*1024*1024;

	@examples/protobuf/codec/codec.h

9 #iâdeà
MUDUO_EXAMPLES_PROTOBUF_CODEC_CODEC_H


10 
	#MUDUO_EXAMPLES_PROTOBUF_CODEC_CODEC_H


	)

12 
	~<muduo/Ãt/Bufãr.h
>

13 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

15 
	~<boo¡/funùiÚ.hµ
>

16 
	~<boo¡/nÚcİyabË.hµ
>

17 
	~<boo¡/sh¬ed_±r.hµ
>

19 
	~<googË/´Ùobuf/mes§ge.h
>

30 
	gboo¡
::
	tsh¬ed_±r
<
	tgoogË
::
	t´Ùobuf
::
	tMes§ge
> 
	tMes§gePŒ
;

35 şas 
	cPrÙobufCodec
 : 
boo¡
::
nÚcİyabË


37 
public
:

39 
	eE¼ÜCode


41 
kNoE¼Ü
 = 0,

42 
	mkInv®idL’gth
,

43 
	mkCheckSumE¼Ü
,

44 
	mkInv®idNameL’
,

45 
	mkUnknownMes§geTy³
,

46 
	mkP¬£E¼Ü
,

49 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

50 cÚ¡ 
	tMes§gePŒ
&,

51 
	tmuduo
::
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

53 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

54 
	tmuduo
::
	tÃt
::
	tBufãr
*,

55 
	tmuduo
::
	tTime¡amp
,

56 
	tE¼ÜCode
)> 
	tE¼ÜC®lback
;

58 
ex¶ic™
 
	$PrÙobufCodec
(cÚ¡ 
PrÙobufMes§geC®lback
& 
mes§geCb
)

59 : 
	`mes§geC®lback_
(
mes§geCb
),

60 
	$”rÜC®lback_
(
deçuÉE¼ÜC®lback
)

62 
	}
}

64 
	$PrÙobufCodec
(cÚ¡ 
PrÙobufMes§geC®lback
& 
mes§geCb
, cÚ¡ 
E¼ÜC®lback
& 
”rÜCb
)

65 : 
	`mes§geC®lback_
(
mes§geCb
),

66 
	$”rÜC®lback_
(
”rÜCb
)

68 
	}
}

70 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

71 
muduo
::
Ãt
::
Bufãr
* 
buf
,

72 
muduo
::
Time¡amp
 
»ûiveTime
);

74 
£nd
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

75 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
)

78 
muduo
::
Ãt
::
Bufãr
 
buf
;

79 
flEm±yBufãr
(&
buf
, 
mes§ge
);

80 
	gcÚn
->
£nd
(&
buf
);

83 cÚ¡ 
	gmuduo
::
¡ršg
& 
”rÜCodeToSŒšg
(
E¼ÜCode
 
”rÜCode
);

84 
flEm±yBufãr
(
muduo
::
Ãt
::
Bufãr
* 
buf
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
);

85 
	ggoogË
::
´Ùobuf
::
Mes§ge
* 
ü—‹Mes§ge
(cÚ¡ 
¡d
::
¡ršg
& 
ty³_Çme
);

86 
Mes§gePŒ
 
·r£
(cÚ¡ * 
buf
, 
Ën
, 
E¼ÜCode
* 
”rÜCode
);

88 
	g´iv©e
:

89 
deçuÉE¼ÜC®lback
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

90 
muduo
::
Ãt
::
Bufãr
*,

91 
muduo
::
Time¡amp
,

92 
E¼ÜCode
);

94 
PrÙobufMes§geC®lback
 
	gmes§geC®lback_
;

95 
E¼ÜC®lback
 
	g”rÜC®lback_
;

97 cÚ¡ 
	gkH—d”L’
 = (
št32_t
);

98 cÚ¡ 
	gkMšMes§geL’
 = 2*
kH—d”L’
 + 2;

99 cÚ¡ 
	gkMaxMes§geL’
 = 64*1024*1024;

	@examples/protobuf/codec/codec_test.cc

1 
	~"codec.h
"

2 
	~<muduo/Ãt/EndŸn.h
>

3 
	~<exam¶es/´Ùobuf/codec/qu”y.pb.h
>

5 
	~<¡dio.h
>

6 
	~<zlib.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
	$´št
(cÚ¡ 
Bufãr
& 
buf
)

13 
	`´štf
("’codedØ%zd by‹s\n", 
buf
.
	`»adabËBy‹s
());

14 
size_t
 
i
 = 0; i < 
buf
.
	`»adabËBy‹s
(); ++i)

16 
ch
 = 
¡©ic_ÿ¡
<>(
buf
.
	`³ek
()[
i
]);

18 
	`´štf
("%2zd: 0x%02x %c\n", 
i
, 
ch
, 
	`isg¿ph
(ch) ? ch : ' ');

20 
	}
}

22 
	$‹¡Qu”y
()

24 
muduo
::
Qu”y
 
qu”y
;

25 
qu”y
.
	`£t_id
(1);

26 
qu”y
.
	`£t_que¡iÚ”
("Chen Shuo");

27 
qu”y
.
	`add_que¡iÚ
("Running?");

29 
Bufãr
 
buf
;

30 
PrÙobufCodec
::
	`flEm±yBufãr
(&
buf
, 
qu”y
);

31 
	`´št
(
buf
);

33 cÚ¡ 
št32_t
 
Ën
 = 
buf
.
	`»adIÁ32
();

34 
	`as£¹
(
Ën
 =ğ
¡©ic_ÿ¡
<
št32_t
>(
buf
.
	`»adabËBy‹s
()));

36 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

37 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
buf
.
	`³ek
(), 
Ën
, &
”rÜCode
);

38 
	`as£¹
(
”rÜCode
 =ğ
PrÙobufCodec
::
kNoE¼Ü
);

39 
	`as£¹
(
mes§ge
 !ğ
NULL
);

40 
mes§ge
->
	`PrštDebugSŒšg
();

41 
	`as£¹
(
mes§ge
->
	`DebugSŒšg
(è=ğ
qu”y
.DebugString());

43 
boo¡
::
sh¬ed_±r
<
muduo
::
Qu”y
> 
ÃwQu”y
 = 
down_poš‹r_ÿ¡
<muduo::Qu”y>(
mes§ge
);

44 
	`as£¹
(
ÃwQu”y
 !ğ
NULL
);

45 
	}
}

47 
	$‹¡Answ”
()

49 
muduo
::
Answ”
 
ªsw”
;

50 
ªsw”
.
	`£t_id
(1);

51 
ªsw”
.
	`£t_que¡iÚ”
("Chen Shuo");

52 
ªsw”
.
	`£t_ªsw””
("blog.csdn.net/Solstice");

53 
ªsw”
.
	`add_sŞutiÚ
("Jump!");

54 
ªsw”
.
	`add_sŞutiÚ
("Win!");

56 
Bufãr
 
buf
;

57 
PrÙobufCodec
::
	`flEm±yBufãr
(&
buf
, 
ªsw”
);

58 
	`´št
(
buf
);

60 cÚ¡ 
št32_t
 
Ën
 = 
buf
.
	`»adIÁ32
();

61 
	`as£¹
(
Ën
 =ğ
¡©ic_ÿ¡
<
št32_t
>(
buf
.
	`»adabËBy‹s
()));

63 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

64 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
buf
.
	`³ek
(), 
Ën
, &
”rÜCode
);

65 
	`as£¹
(
”rÜCode
 =ğ
PrÙobufCodec
::
kNoE¼Ü
);

66 
	`as£¹
(
mes§ge
 !ğ
NULL
);

67 
mes§ge
->
	`PrštDebugSŒšg
();

68 
	`as£¹
(
mes§ge
->
	`DebugSŒšg
(è=ğ
ªsw”
.DebugString());

70 
boo¡
::
sh¬ed_±r
<
muduo
::
Answ”
> 
ÃwAnsw”
 = 
down_poš‹r_ÿ¡
<muduo::Answ”>(
mes§ge
);

71 
	`as£¹
(
ÃwAnsw”
 !ğ
NULL
);

72 
	}
}

74 
	$‹¡Em±y
()

76 
muduo
::
Em±y
 
em±y
;

78 
Bufãr
 
buf
;

79 
PrÙobufCodec
::
	`flEm±yBufãr
(&
buf
, 
em±y
);

80 
	`´št
(
buf
);

82 cÚ¡ 
št32_t
 
Ën
 = 
buf
.
	`»adIÁ32
();

83 
	`as£¹
(
Ën
 =ğ
¡©ic_ÿ¡
<
št32_t
>(
buf
.
	`»adabËBy‹s
()));

85 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

86 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
buf
.
	`³ek
(), 
Ën
, &
”rÜCode
);

87 
	`as£¹
(
mes§ge
 !ğ
NULL
);

88 
mes§ge
->
	`PrštDebugSŒšg
();

89 
	`as£¹
(
mes§ge
->
	`DebugSŒšg
(è=ğ
em±y
.DebugString());

90 
	}
}

92 
	$»doCheckSum
(
¡ršg
& 
d©a
, 
Ën
)

94 
št32_t
 
checkSum
 = 
sock‘s
::
	`ho¡ToN‘wÜk32
(
¡©ic_ÿ¡
<int32_t>(

95 ::
	`adËr32
(1,

96 
»š‹½»t_ÿ¡
<cÚ¡ 
By‹f
*>(
d©a
.
	`c_¡r
()),

97 
¡©ic_ÿ¡
<>(
Ën
 - 4))));

98 
d©a
[
Ën
-4] = 
»š‹½»t_ÿ¡
<cÚ¡ *>(&
checkSum
)[0];

99 
d©a
[
Ën
-3] = 
»š‹½»t_ÿ¡
<cÚ¡ *>(&
checkSum
)[1];

100 
d©a
[
Ën
-2] = 
»š‹½»t_ÿ¡
<cÚ¡ *>(&
checkSum
)[2];

101 
d©a
[
Ën
-1] = 
»š‹½»t_ÿ¡
<cÚ¡ *>(&
checkSum
)[3];

102 
	}
}

104 
	$‹¡BadBufãr
()

106 
muduo
::
Em±y
 
em±y
;

107 
em±y
.
	`£t_id
(43);

109 
Bufãr
 
buf
;

110 
PrÙobufCodec
::
	`flEm±yBufãr
(&
buf
, 
em±y
);

113 cÚ¡ 
št32_t
 
Ën
 = 
buf
.
	`»adIÁ32
();

114 
	`as£¹
(
Ën
 =ğ
¡©ic_ÿ¡
<
št32_t
>(
buf
.
	`»adabËBy‹s
()));

117 
¡ršg
 
	`d©a
(
buf
.
	`³ek
(), 
Ën
);

118 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

119 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
d©a
.
	`c_¡r
(), 
Ën
-1, &
”rÜCode
);

120 
	`as£¹
(
mes§ge
 =ğ
NULL
);

121 
	`as£¹
(
”rÜCode
 =ğ
PrÙobufCodec
::
kCheckSumE¼Ü
);

125 
¡ršg
 
	`d©a
(
buf
.
	`³ek
(), 
Ën
);

126 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

127 
d©a
[
Ën
-1]++;

128 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
d©a
.
	`c_¡r
(), 
Ën
, &
”rÜCode
);

129 
	`as£¹
(
mes§ge
 =ğ
NULL
);

130 
	`as£¹
(
”rÜCode
 =ğ
PrÙobufCodec
::
kCheckSumE¼Ü
);

134 
¡ršg
 
	`d©a
(
buf
.
	`³ek
(), 
Ën
);

135 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

136 
d©a
[0]++;

137 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
d©a
.
	`c_¡r
(), 
Ën
, &
”rÜCode
);

138 
	`as£¹
(
mes§ge
 =ğ
NULL
);

139 
	`as£¹
(
”rÜCode
 =ğ
PrÙobufCodec
::
kCheckSumE¼Ü
);

143 
¡ršg
 
	`d©a
(
buf
.
	`³ek
(), 
Ën
);

144 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

145 
d©a
[3] = 0;

146 
	`»doCheckSum
(
d©a
, 
Ën
);

147 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
d©a
.
	`c_¡r
(), 
Ën
, &
”rÜCode
);

148 
	`as£¹
(
mes§ge
 =ğ
NULL
);

149 
	`as£¹
(
”rÜCode
 =ğ
PrÙobufCodec
::
kInv®idNameL’
);

153 
¡ršg
 
	`d©a
(
buf
.
	`³ek
(), 
Ën
);

154 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

155 
d©a
[3] = 100;

156 
	`»doCheckSum
(
d©a
, 
Ën
);

157 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
d©a
.
	`c_¡r
(), 
Ën
, &
”rÜCode
);

158 
	`as£¹
(
mes§ge
 =ğ
NULL
);

159 
	`as£¹
(
”rÜCode
 =ğ
PrÙobufCodec
::
kInv®idNameL’
);

163 
¡ršg
 
	`d©a
(
buf
.
	`³ek
(), 
Ën
);

164 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

165 
d©a
[3]--;

166 
	`»doCheckSum
(
d©a
, 
Ën
);

167 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
d©a
.
	`c_¡r
(), 
Ën
, &
”rÜCode
);

168 
	`as£¹
(
mes§ge
 =ğ
NULL
);

169 
	`as£¹
(
”rÜCode
 =ğ
PrÙobufCodec
::
kUnknownMes§geTy³
);

173 
¡ršg
 
	`d©a
(
buf
.
	`³ek
(), 
Ën
);

174 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

175 
d©a
[4] = 'M';

176 
	`»doCheckSum
(
d©a
, 
Ën
);

177 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
d©a
.
	`c_¡r
(), 
Ën
, &
”rÜCode
);

178 
	`as£¹
(
mes§ge
 =ğ
NULL
);

179 
	`as£¹
(
”rÜCode
 =ğ
PrÙobufCodec
::
kUnknownMes§geTy³
);

184 
¡ršg
 
	`d©a
(
buf
.
	`³ek
(), 
Ën
);

185 
PrÙobufCodec
::
E¼ÜCode
 
”rÜCode
 = PrÙobufCodec::
kNoE¼Ü
;

186 
	`»doCheckSum
(
d©a
, 
Ën
);

187 
Mes§gePŒ
 
mes§ge
 = 
PrÙobufCodec
::
	`·r£
(
d©a
.
	`c_¡r
(), 
Ën
, &
”rÜCode
);

191 
	}
}

193 
	gg_couÁ
 = 0;

195 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

196 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

197 
muduo
::
Time¡amp
 
»ûiveTime
)

199 
g_couÁ
++;

202 
	$‹¡OnMes§ge
()

204 
muduo
::
Qu”y
 
qu”y
;

205 
qu”y
.
	`£t_id
(1);

206 
qu”y
.
	`£t_que¡iÚ”
("Chen Shuo");

207 
qu”y
.
	`add_que¡iÚ
("Running?");

209 
Bufãr
 
buf1
;

210 
PrÙobufCodec
::
	`flEm±yBufãr
(&
buf1
, 
qu”y
);

212 
muduo
::
Em±y
 
em±y
;

213 
em±y
.
	`£t_id
(43);

214 
em±y
.
	`£t_id
(1982);

216 
Bufãr
 
buf2
;

217 
PrÙobufCodec
::
	`flEm±yBufãr
(&
buf2
, 
em±y
);

219 
size_t
 
tÙ®L’
 = 
buf1
.
	`»adabËBy‹s
(è+ 
buf2
.readableBytes();

220 
Bufãr
 
®l
;

221 
®l
.
	`­³nd
(
buf1
.
	`³ek
(), buf1.
	`»adabËBy‹s
());

222 
®l
.
	`­³nd
(
buf2
.
	`³ek
(), buf2.
	`»adabËBy‹s
());

223 
	`as£¹
(
®l
.
	`»adabËBy‹s
(è=ğ
tÙ®L’
);

224 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn
;

225 
muduo
::
Time¡amp
 
t
;

226 
PrÙobufCodec
 
	`codec
(
ÚMes§ge
);

227 
size_t
 
Ën
 = 0;†’ <ğ
tÙ®L’
; ++len)

229 
Bufãr
 
šput
;

230 
šput
.
	`­³nd
(
®l
.
	`³ek
(), 
Ën
);

232 
g_couÁ
 = 0;

233 
codec
.
	`ÚMes§ge
(
cÚn
, &
šput
, 
t
);

234 
ex³ùed
 = 
Ën
 < 
buf1
.
	`»adabËBy‹s
() ? 0 : 1;

235 ià(
Ën
 =ğ
tÙ®L’
è
ex³ùed
 = 2;

236 
	`as£¹
(
g_couÁ
 =ğ
ex³ùed
); ()ƒxpected;

239 
šput
.
	`­³nd
(
®l
.
	`³ek
(è+ 
Ën
, 
tÙ®L’
 -†en);

240 
codec
.
	`ÚMes§ge
(
cÚn
, &
šput
, 
t
);

241 
	`as£¹
(
g_couÁ
 == 2);

243 
	}
}

245 
	$maš
()

247 
GOOGLE_PROTOBUF_VERIFY_VERSION
;

249 
	`‹¡Qu”y
();

250 
	`puts
("");

251 
	`‹¡Answ”
();

252 
	`puts
("");

253 
	`‹¡Em±y
();

254 
	`puts
("");

255 
	`‹¡BadBufãr
();

256 
	`puts
("");

257 
	`‹¡OnMes§ge
();

258 
	`puts
("");

260 
	`puts
("All…ass!!!");

262 
googË
::
´Ùobuf
::
	`ShutdownPrÙobufLib¿ry
();

263 
	}
}

	@examples/protobuf/codec/dispatcher.h

9 #iâdeà
MUDUO_EXAMPLES_PROTOBUF_CODEC_DISPATCHER_H


10 
	#MUDUO_EXAMPLES_PROTOBUF_CODEC_DISPATCHER_H


	)

12 
	~<muduo/Ãt/C®lbacks.h
>

14 
	~<googË/´Ùobuf/mes§ge.h
>

16 
	~<m­
>

18 
	~<boo¡/funùiÚ.hµ
>

19 
	~<boo¡/nÚcİyabË.hµ
>

20 
	~<boo¡/sh¬ed_±r.hµ
>

22 #iâdeà
NDEBUG


23 
	~<boo¡/¡©ic_as£¹.hµ
>

24 
	~<boo¡/ty³_Œa™s/is_ba£_of.hµ
>

27 
	gboo¡
::
	tsh¬ed_±r
<
	tgoogË
::
	t´Ùobuf
::
	tMes§ge
> 
	tMes§gePŒ
;

29 şas 
	cC®lback
 : 
boo¡
::
nÚcİyabË


31 
public
:

32 
vœtu®
 ~
	$C®lback
() {};

33 
vœtu®
 
	`ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

34 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

35 
muduo
::
Time¡amp
) const = 0;

36 
	}
};

38 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

39 şas 
	cC®lbackT
 : 
public
 
C®lback


41 #iâdeà
NDEBUG


42 
BOOST_STATIC_ASSERT
((
boo¡
::
is_ba£_of
<
googË
::
´Ùobuf
::
Mes§ge
, 
T
>::
v®ue
));

44 
	mpublic
:

45 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

46 cÚ¡ 
	tboo¡
::
	tsh¬ed_±r
<
	tT
>& 
	tmes§ge
,

47 
	tmuduo
::
	tTime¡amp
)> 
	tPrÙobufMes§geTC®lback
;

49 
	$C®lbackT
(cÚ¡ 
PrÙobufMes§geTC®lback
& 
ÿÎback
)

50 : 
	$ÿÎback_
(
ÿÎback
)

54 
vœtu®
 
	`ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

55 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

56 
muduo
::
Time¡amp
 
»ûiveTime
) const

58 
boo¡
::
sh¬ed_±r
<
T
> 
cÚü‘e
 = 
muduo
::
down_poš‹r_ÿ¡
<T>(
mes§ge
);

59 
	`as£¹
(
cÚü‘e
 !ğ
NULL
);

60 
	`ÿÎback_
(
cÚn
, 
cÚü‘e
, 
»ûiveTime
);

61 
	}
}

63 
	g´iv©e
:

64 
PrÙobufMes§geTC®lback
 
ÿÎback_
;

67 şas 
	cPrÙobufDi¥©ch”


69 
	mpublic
:

70 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

71 cÚ¡ 
	tMes§gePŒ
& 
	tmes§ge
,

72 
	tmuduo
::
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

74 
ex¶ic™
 
	$PrÙobufDi¥©ch”
(cÚ¡ 
PrÙobufMes§geC®lback
& 
deçuÉCb
)

75 : 
	$deçuÉC®lback_
(
deçuÉCb
)

79 
	`ÚPrÙobufMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

80 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

81 
muduo
::
Time¡amp
 
»ûiveTime
) const

83 
C®lbackM­
::
cÚ¡_™”©Ü
 
™
 = 
ÿÎbacks_
.
	`fšd
(
mes§ge
->
	`G‘DesütÜ
());

84 ià(
™
 !ğ
ÿÎbacks_
.
	`’d
())

86 
™
->
£cÚd
->
	`ÚMes§ge
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

90 
	`deçuÉC®lback_
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

92 
	}
}

94 
	g‹m¶©e
<
ty³Çme
 
	gT
>

95 
»gi¡”Mes§geC®lback
(cÚ¡ 
ty³Çme
 
C®lbackT
<
T
>::
PrÙobufMes§geTC®lback
& 
ÿÎback
)

97 
boo¡
::
sh¬ed_±r
<
C®lbackT
<
T
> > 
pd
(
Ãw
 C®lbackT<T>(
ÿÎback
));

98 
	gÿÎbacks_
[
T
::
desütÜ
()] = 
pd
;

101 
	g´iv©e
:

102 
¡d
::
	tm­
<cÚ¡ 
	tgoogË
::
	t´Ùobuf
::
	tDesütÜ
*, 
	tboo¡
::
	tsh¬ed_±r
<
	tC®lback
> > 
	tC®lbackM­
;

104 
C®lbackM­
 
	gÿÎbacks_
;

105 
PrÙobufMes§geC®lback
 
	gdeçuÉC®lback_
;

	@examples/protobuf/codec/dispatcher.h

9 #iâdeà
MUDUO_EXAMPLES_PROTOBUF_CODEC_DISPATCHER_H


10 
	#MUDUO_EXAMPLES_PROTOBUF_CODEC_DISPATCHER_H


	)

12 
	~<muduo/Ãt/C®lbacks.h
>

14 
	~<googË/´Ùobuf/mes§ge.h
>

16 
	~<m­
>

18 
	~<boo¡/funùiÚ.hµ
>

19 
	~<boo¡/nÚcİyabË.hµ
>

20 
	~<boo¡/sh¬ed_±r.hµ
>

22 #iâdeà
NDEBUG


23 
	~<boo¡/¡©ic_as£¹.hµ
>

24 
	~<boo¡/ty³_Œa™s/is_ba£_of.hµ
>

27 
	gboo¡
::
	tsh¬ed_±r
<
	tgoogË
::
	t´Ùobuf
::
	tMes§ge
> 
	tMes§gePŒ
;

29 şas 
	cC®lback
 : 
boo¡
::
nÚcİyabË


31 
public
:

32 
vœtu®
 ~
	$C®lback
() {};

33 
vœtu®
 
	`ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

34 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

35 
muduo
::
Time¡amp
) const = 0;

36 
	}
};

38 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

39 şas 
	cC®lbackT
 : 
public
 
C®lback


41 #iâdeà
NDEBUG


42 
BOOST_STATIC_ASSERT
((
boo¡
::
is_ba£_of
<
googË
::
´Ùobuf
::
Mes§ge
, 
T
>::
v®ue
));

44 
	mpublic
:

45 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

46 cÚ¡ 
	tboo¡
::
	tsh¬ed_±r
<
	tT
>& 
	tmes§ge
,

47 
	tmuduo
::
	tTime¡amp
)> 
	tPrÙobufMes§geTC®lback
;

49 
	$C®lbackT
(cÚ¡ 
PrÙobufMes§geTC®lback
& 
ÿÎback
)

50 : 
	$ÿÎback_
(
ÿÎback
)

54 
vœtu®
 
	`ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

55 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

56 
muduo
::
Time¡amp
 
»ûiveTime
) const

58 
boo¡
::
sh¬ed_±r
<
T
> 
cÚü‘e
 = 
muduo
::
down_poš‹r_ÿ¡
<T>(
mes§ge
);

59 
	`as£¹
(
cÚü‘e
 !ğ
NULL
);

60 
	`ÿÎback_
(
cÚn
, 
cÚü‘e
, 
»ûiveTime
);

61 
	}
}

63 
	g´iv©e
:

64 
PrÙobufMes§geTC®lback
 
ÿÎback_
;

67 şas 
	cPrÙobufDi¥©ch”


69 
	mpublic
:

70 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

71 cÚ¡ 
	tMes§gePŒ
& 
	tmes§ge
,

72 
	tmuduo
::
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

74 
ex¶ic™
 
	$PrÙobufDi¥©ch”
(cÚ¡ 
PrÙobufMes§geC®lback
& 
deçuÉCb
)

75 : 
	$deçuÉC®lback_
(
deçuÉCb
)

79 
	`ÚPrÙobufMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

80 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

81 
muduo
::
Time¡amp
 
»ûiveTime
) const

83 
C®lbackM­
::
cÚ¡_™”©Ü
 
™
 = 
ÿÎbacks_
.
	`fšd
(
mes§ge
->
	`G‘DesütÜ
());

84 ià(
™
 !ğ
ÿÎbacks_
.
	`’d
())

86 
™
->
£cÚd
->
	`ÚMes§ge
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

90 
	`deçuÉC®lback_
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

92 
	}
}

94 
	g‹m¶©e
<
ty³Çme
 
	gT
>

95 
»gi¡”Mes§geC®lback
(cÚ¡ 
ty³Çme
 
C®lbackT
<
T
>::
PrÙobufMes§geTC®lback
& 
ÿÎback
)

97 
boo¡
::
sh¬ed_±r
<
C®lbackT
<
T
> > 
pd
(
Ãw
 C®lbackT<T>(
ÿÎback
));

98 
	gÿÎbacks_
[
T
::
desütÜ
()] = 
pd
;

101 
	g´iv©e
:

102 
¡d
::
	tm­
<cÚ¡ 
	tgoogË
::
	t´Ùobuf
::
	tDesütÜ
*, 
	tboo¡
::
	tsh¬ed_±r
<
	tC®lback
> > 
	tC®lbackM­
;

104 
C®lbackM­
 
	gÿÎbacks_
;

105 
PrÙobufMes§geC®lback
 
	gdeçuÉC®lback_
;

	@examples/protobuf/codec/dispatcher_lite.h

9 #iâdeà
MUDUO_EXAMPLES_PROTOBUF_CODEC_DISPATCHER_LITE_H


10 
	#MUDUO_EXAMPLES_PROTOBUF_CODEC_DISPATCHER_LITE_H


	)

12 
	~<muduo/Ãt/C®lbacks.h
>

14 
	~<googË/´Ùobuf/mes§ge.h
>

16 
	~<m­
>

18 
	~<boo¡/funùiÚ.hµ
>

19 
	~<boo¡/nÚcİyabË.hµ
>

20 
	~<boo¡/sh¬ed_±r.hµ
>

22 
	gboo¡
::
	tsh¬ed_±r
<
	tgoogË
::
	t´Ùobuf
::
	tMes§ge
> 
	tMes§gePŒ
;

24 şas 
	cPrÙobufDi¥©ch”L™e
 : 
boo¡
::
nÚcİyabË


26 
public
:

27 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

28 cÚ¡ 
	tMes§gePŒ
&,

29 
	tmuduo
::
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

36 
ex¶ic™
 
	$PrÙobufDi¥©ch”L™e
(cÚ¡ 
PrÙobufMes§geC®lback
& 
deçuÉCb
)

37 : 
	$deçuÉC®lback_
(
deçuÉCb
)

41 
	`ÚPrÙobufMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

42 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

43 
muduo
::
Time¡amp
 
»ûiveTime
) const

45 
C®lbackM­
::
cÚ¡_™”©Ü
 
™
 = 
ÿÎbacks_
.
	`fšd
(
mes§ge
->
	`G‘DesütÜ
());

46 ià(
™
 !ğ
ÿÎbacks_
.
	`’d
())

48 
™
->
	`£cÚd
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

52 
	`deçuÉC®lback_
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

54 
	}
}

56 
»gi¡”Mes§geC®lback
(cÚ¡ 
googË
::
´Ùobuf
::
DesütÜ
* 
desc
,

57 cÚ¡ 
PrÙobufMes§geC®lback
& 
ÿÎback
)

59 
	gÿÎbacks_
[
desc
] = 
ÿÎback
;

62 
	g´iv©e
:

67 
¡d
::
	tm­
<cÚ¡ 
	tgoogË
::
	t´Ùobuf
::
	tDesütÜ
*, 
	tPrÙobufMes§geC®lback
> 
	tC®lbackM­
;

68 
C®lbackM­
 
	gÿÎbacks_
;

69 
PrÙobufMes§geC®lback
 
	gdeçuÉC®lback_
;

	@examples/protobuf/codec/dispatcher_lite.h

9 #iâdeà
MUDUO_EXAMPLES_PROTOBUF_CODEC_DISPATCHER_LITE_H


10 
	#MUDUO_EXAMPLES_PROTOBUF_CODEC_DISPATCHER_LITE_H


	)

12 
	~<muduo/Ãt/C®lbacks.h
>

14 
	~<googË/´Ùobuf/mes§ge.h
>

16 
	~<m­
>

18 
	~<boo¡/funùiÚ.hµ
>

19 
	~<boo¡/nÚcİyabË.hµ
>

20 
	~<boo¡/sh¬ed_±r.hµ
>

22 
	gboo¡
::
	tsh¬ed_±r
<
	tgoogË
::
	t´Ùobuf
::
	tMes§ge
> 
	tMes§gePŒ
;

24 şas 
	cPrÙobufDi¥©ch”L™e
 : 
boo¡
::
nÚcİyabË


26 
public
:

27 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tmuduo
::
	tÃt
::
	tTıCÚÃùiÚPŒ
&,

28 cÚ¡ 
	tMes§gePŒ
&,

29 
	tmuduo
::
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

36 
ex¶ic™
 
	$PrÙobufDi¥©ch”L™e
(cÚ¡ 
PrÙobufMes§geC®lback
& 
deçuÉCb
)

37 : 
	$deçuÉC®lback_
(
deçuÉCb
)

41 
	`ÚPrÙobufMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

42 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

43 
muduo
::
Time¡amp
 
»ûiveTime
) const

45 
C®lbackM­
::
cÚ¡_™”©Ü
 
™
 = 
ÿÎbacks_
.
	`fšd
(
mes§ge
->
	`G‘DesütÜ
());

46 ià(
™
 !ğ
ÿÎbacks_
.
	`’d
())

48 
™
->
	`£cÚd
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

52 
	`deçuÉC®lback_
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

54 
	}
}

56 
»gi¡”Mes§geC®lback
(cÚ¡ 
googË
::
´Ùobuf
::
DesütÜ
* 
desc
,

57 cÚ¡ 
PrÙobufMes§geC®lback
& 
ÿÎback
)

59 
	gÿÎbacks_
[
desc
] = 
ÿÎback
;

62 
	g´iv©e
:

67 
¡d
::
	tm­
<cÚ¡ 
	tgoogË
::
	t´Ùobuf
::
	tDesütÜ
*, 
	tPrÙobufMes§geC®lback
> 
	tC®lbackM­
;

68 
C®lbackM­
 
	gÿÎbacks_
;

69 
PrÙobufMes§geC®lback
 
	gdeçuÉC®lback_
;

	@examples/protobuf/codec/dispatcher_lite_test.cc

1 
	~"di¥©ch”_l™e.h
"

3 
	~<exam¶es/´Ùobuf/codec/qu”y.pb.h
>

5 
	~<io¡»am
>

7 
usšg
 
	g¡d
::
cout
;

8 
usšg
 
	g¡d
::
’dl
;

10 
ÚUnknownMes§geTy³
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

11 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

12 
muduo
::
Time¡amp
)

14 
cout
 << "ÚUnknownMes§geTy³: " << 
mes§ge
->
G‘Ty³Name
(è<< 
’dl
;

17 
ÚQu”y
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

18 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

19 
muduo
::
Time¡amp
)

21 
cout
 << "ÚQu”y: " << 
mes§ge
->
G‘Ty³Name
(è<< 
’dl
;

22 
	gboo¡
::
sh¬ed_±r
<
muduo
::
Qu”y
> 
qu”y
 = muduo::
down_poš‹r_ÿ¡
<muduo::Qu”y>(
mes§ge
);

23 
as£¹
(
qu”y
 !ğ
NULL
);

26 
ÚAnsw”
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

27 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

28 
muduo
::
Time¡amp
)

30 
cout
 << "ÚAnsw”: " << 
mes§ge
->
G‘Ty³Name
(è<< 
’dl
;

31 
	gboo¡
::
sh¬ed_±r
<
muduo
::
Answ”
> 
ªsw”
 = muduo::
down_poš‹r_ÿ¡
<muduo::Answ”>(
mes§ge
);

32 
as£¹
(
ªsw”
 !ğ
NULL
);

35 
	$maš
()

37 
GOOGLE_PROTOBUF_VERIFY_VERSION
;

39 
PrÙobufDi¥©ch”L™e
 
	`di¥©ch”
(
ÚUnknownMes§geTy³
);

40 
di¥©ch”
.
	`»gi¡”Mes§geC®lback
(
muduo
::
Qu”y
::
	`desütÜ
(), 
ÚQu”y
);

41 
di¥©ch”
.
	`»gi¡”Mes§geC®lback
(
muduo
::
Answ”
::
	`desütÜ
(), 
ÚAnsw”
);

43 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn
;

44 
muduo
::
Time¡amp
 
t
;

46 
boo¡
::
sh¬ed_±r
<
muduo
::
Qu”y
> 
	`qu”y
(
Ãw
 muduo::Query);

47 
boo¡
::
sh¬ed_±r
<
muduo
::
Answ”
> 
	`ªsw”
(
Ãw
 muduo::Answer);

48 
boo¡
::
sh¬ed_±r
<
muduo
::
Em±y
> 
	`em±y
(
Ãw
 muduo::Empty);

49 
di¥©ch”
.
	`ÚPrÙobufMes§ge
(
cÚn
, 
qu”y
, 
t
);

50 
di¥©ch”
.
	`ÚPrÙobufMes§ge
(
cÚn
, 
ªsw”
, 
t
);

51 
di¥©ch”
.
	`ÚPrÙobufMes§ge
(
cÚn
, 
em±y
, 
t
);

53 
googË
::
´Ùobuf
::
	`ShutdownPrÙobufLib¿ry
();

54 
	}
}

	@examples/protobuf/codec/dispatcher_test.cc

1 
	~"di¥©ch”.h
"

3 
	~<exam¶es/´Ùobuf/codec/qu”y.pb.h
>

5 
	~<io¡»am
>

7 
usšg
 
	g¡d
::
cout
;

8 
usšg
 
	g¡d
::
’dl
;

10 
	gboo¡
::
	tsh¬ed_±r
<
	tmuduo
::
	tQu”y
> 
	tQu”yPŒ
;

11 
	gboo¡
::
	tsh¬ed_±r
<
	tmuduo
::
	tAnsw”
> 
	tAnsw”PŒ
;

13 
	$‹¡_down_poš‹r_ÿ¡
()

15 ::
boo¡
::
sh¬ed_±r
<
googË
::
´Ùobuf
::
Mes§ge
> 
	`msg
(
Ãw
 
muduo
::
Qu”y
);

16 ::
boo¡
::
sh¬ed_±r
<
muduo
::
Qu”y
> 
	`qu”y
(muduo::
down_poš‹r_ÿ¡
<muduo::Qu”y>(
msg
));

17 
	`as£¹
(
msg
 && 
qu”y
);

18 ià(!
qu”y
)

20 
	`abÜt
();

22 
	}
}

24 
ÚQu”y
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

25 cÚ¡ 
Qu”yPŒ
& 
mes§ge
,

26 
muduo
::
Time¡amp
)

28 
cout
 << "ÚQu”y: " << 
mes§ge
->
G‘Ty³Name
(è<< 
’dl
;

31 
ÚAnsw”
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

32 cÚ¡ 
Answ”PŒ
& 
mes§ge
,

33 
muduo
::
Time¡amp
)

35 
cout
 << "ÚAnsw”: " << 
mes§ge
->
G‘Ty³Name
(è<< 
’dl
;

38 
ÚUnknownMes§geTy³
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
&,

39 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

40 
muduo
::
Time¡amp
)

42 
cout
 << "ÚUnknownMes§geTy³: " << 
mes§ge
->
G‘Ty³Name
(è<< 
’dl
;

45 
	$maš
()

47 
GOOGLE_PROTOBUF_VERIFY_VERSION
;

48 
	`‹¡_down_poš‹r_ÿ¡
();

50 
PrÙobufDi¥©ch”
 
	`di¥©ch”
(
ÚUnknownMes§geTy³
);

51 
di¥©ch”
.
»gi¡”Mes§geC®lback
<
muduo
::
Qu”y
>(
ÚQu”y
);

52 
di¥©ch”
.
»gi¡”Mes§geC®lback
<
muduo
::
Answ”
>(
ÚAnsw”
);

54 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
cÚn
;

55 
muduo
::
Time¡amp
 
t
;

57 
boo¡
::
sh¬ed_±r
<
muduo
::
Qu”y
> 
	`qu”y
(
Ãw
 muduo::Query);

58 
boo¡
::
sh¬ed_±r
<
muduo
::
Answ”
> 
	`ªsw”
(
Ãw
 muduo::Answer);

59 
boo¡
::
sh¬ed_±r
<
muduo
::
Em±y
> 
	`em±y
(
Ãw
 muduo::Empty);

60 
di¥©ch”
.
	`ÚPrÙobufMes§ge
(
cÚn
, 
qu”y
, 
t
);

61 
di¥©ch”
.
	`ÚPrÙobufMes§ge
(
cÚn
, 
ªsw”
, 
t
);

62 
di¥©ch”
.
	`ÚPrÙobufMes§ge
(
cÚn
, 
em±y
, 
t
);

64 
googË
::
´Ùobuf
::
	`ShutdownPrÙobufLib¿ry
();

65 
	}
}

	@examples/protobuf/codec/server.cc

1 
	~"codec.h
"

2 
	~"di¥©ch”.h
"

3 
	~<exam¶es/´Ùobuf/codec/qu”y.pb.h
>

5 
	~<muduo/ba£/Loggšg.h
>

6 
	~<muduo/ba£/Mu‹x.h
>

7 
	~<muduo/Ãt/Ev’tLoİ.h
>

8 
	~<muduo/Ãt/TıS”v”.h
>

10 
	~<boo¡/bšd.hµ
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 
	gboo¡
::
	tsh¬ed_±r
<
	tmuduo
::
	tQu”y
> 
	tQu”yPŒ
;

19 
	gboo¡
::
	tsh¬ed_±r
<
	tmuduo
::
	tAnsw”
> 
	tAnsw”PŒ
;

21 şas 
	cQu”yS”v”
 : 
boo¡
::
nÚcİyabË


23 
public
:

24 
	$Qu”yS”v”
(
Ev’tLoİ
* 
loİ
,

25 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

26 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "QueryServer"),

27 
	`di¥©ch”_
(
boo¡
::
	`bšd
(&
Qu”yS”v”
::
ÚUnknownMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

28 
	`codec_
(
boo¡
::
	`bšd
(&
PrÙobufDi¥©ch”
::
ÚPrÙobufMes§ge
, &
di¥©ch”_
, 
_1
, 
_2
, 
_3
))

30 
di¥©ch”_
.
»gi¡”Mes§geC®lback
<
muduo
::
Qu”y
>(

31 
boo¡
::
	`bšd
(&
Qu”yS”v”
::
ÚQu”y
, 
this
, 
_1
, 
_2
, 
_3
));

32 
di¥©ch”_
.
»gi¡”Mes§geC®lback
<
muduo
::
Answ”
>(

33 
boo¡
::
	`bšd
(&
Qu”yS”v”
::
ÚAnsw”
, 
this
, 
_1
, 
_2
, 
_3
));

34 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

35 
boo¡
::
	`bšd
(&
Qu”yS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

36 
£rv”_
.
	`£tMes§geC®lback
(

37 
boo¡
::
	`bšd
(&
PrÙobufCodec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

40 
	$¡¬t
()

42 
£rv”_
.
	`¡¬t
();

43 
	}
}

45 
	g´iv©e
:

46 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

48 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

49 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

50 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

51 
	}
}

53 
	$ÚUnknownMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

54 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

55 
Time¡amp
)

57 
LOG_INFO
 << "ÚUnknownMes§ge: " << 
mes§ge
->
	`G‘Ty³Name
();

58 
cÚn
->
	`shutdown
();

59 
	}
}

61 
ÚQu”y
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

62 cÚ¡ 
Qu”yPŒ
& 
mes§ge
,

63 
muduo
::
Time¡amp
)

65 
LOG_INFO
 << "ÚQu”y:\n" << 
mes§ge
->
G‘Ty³Name
(è<< mes§ge->
DebugSŒšg
();

66 
Answ”
 
	gªsw”
;

67 
	gªsw”
.
£t_id
(1);

68 
	gªsw”
.
£t_que¡iÚ”
("Chen Shuo");

69 
	gªsw”
.
£t_ªsw””
("blog.csdn.net/Solstice");

70 
	gªsw”
.
add_sŞutiÚ
("Jump!");

71 
	gªsw”
.
add_sŞutiÚ
("Win!");

72 
	gcodec_
.
£nd
(
cÚn
, 
ªsw”
);

74 
	gcÚn
->
shutdown
();

77 
ÚAnsw”
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

78 cÚ¡ 
Answ”PŒ
& 
mes§ge
,

79 
muduo
::
Time¡amp
)

81 
LOG_INFO
 << "ÚAnsw”: " << 
mes§ge
->
G‘Ty³Name
();

82 
	gcÚn
->
shutdown
();

85 
TıS”v”
 
	g£rv”_
;

86 
PrÙobufDi¥©ch”
 
	gdi¥©ch”_
;

87 
PrÙobufCodec
 
	gcodec_
;

90 
	$maš
(
¬gc
, * 
¬gv
[])

92 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

93 ià(
¬gc
 > 1)

95 
Ev’tLoİ
 
loİ
;

96 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

97 
IÃtAdd»ss
 
	`£rv”Addr
(
pÜt
);

98 
Qu”yS”v”
 
	`£rv”
(&
loİ
, 
£rv”Addr
);

99 
£rv”
.
	`¡¬t
();

100 
loİ
.
	`loİ
();

104 
	`´štf
("U§ge: % pÜt\n", 
¬gv
[0]);

106 
	}
}

	@examples/protobuf/resolver/client.cc

1 
	~<exam¶es/´Ùobuf/»sŞv”/»sŞv”.pb.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/IÃtAdd»ss.h
>

6 
	~<muduo/Ãt/TıCl›Á.h
>

7 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

8 
	~<muduo/Ãt/´ÙÜpc/RpcChªÃl.h
>

10 
	~<¬·/š‘.h
>

12 
	~<boo¡/bšd.hµ
>

14 
	~<¡dio.h
>

15 
	~<uni¡d.h
>

17 
usšg
 
Çme¥aû
 
	gmuduo
;

18 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

20 şas 
	cRpcCl›Á
 : 
boo¡
::
nÚcİyabË


22 
public
:

23 
	$RpcCl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
)

24 : 
	`loİ_
(
loİ
),

25 
	`ş›Á_
(
loİ
, 
£rv”Addr
, "RpcClient"),

26 
	`chªÃl_
(
Ãw
 
RpcChªÃl
),

27 
	`gÙ_
(0),

28 
	`tÙ®_
(0),

29 
	`¡ub_
(
	$g‘_poš‹r
(
chªÃl_
))

31 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

32 
boo¡
::
	`bšd
(&
RpcCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

33 
ş›Á_
.
	`£tMes§geC®lback
(

34 
boo¡
::
	`bšd
(&
RpcChªÃl
::
ÚMes§ge
, 
	`g‘_poš‹r
(
chªÃl_
), 
_1
, 
_2
, 
_3
));

38 
	$cÚÃù
()

40 
ş›Á_
.
	`cÚÃù
();

41 
	}
}

43 
	g´iv©e
:

44 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

46 ià(
cÚn
->
	`cÚÃùed
())

49 
chªÃl_
->
	`£tCÚÃùiÚ
(
cÚn
);

50 
tÙ®_
 = 4;

51 
	`»sŞve
("www.example.com");

52 
	`»sŞve
("www.chenshuo.com");

53 
	`»sŞve
("www.google.com");

54 
	`»sŞve
("acme.chenshuo.org");

58 
loİ_
->
	`qu™
();

60 
	}
}

62 
»sŞve
(cÚ¡ 
¡d
::
¡ršg
& 
ho¡
)

64 
»sŞv”
::
ResŞveReque¡
 
»que¡
;

65 
	g»que¡
.
£t_add»ss
(
ho¡
);

66 
	g»sŞv”
::
ResŞveRe¥Ú£
* 
»¥Ú£
 = 
Ãw
 
»sŞv”
::ResolveResponse;

68 
	g¡ub_
.
ResŞve
(
NULL
, &
»que¡
, 
»¥Ú£
,

69 
NewC®lback
(
this
, &
RpcCl›Á
::
»sŞved
, 
»¥Ú£
, 
ho¡
));

72 
»sŞved
(
»sŞv”
::
ResŞveRe¥Ú£
* 
»¥
, 
¡d
::
¡ršg
 
ho¡
)

74 ià(
»¥
->
»sŞved
())

76 
buf
[32];

77 
ušt32_t
 
	g
 = 
»¥
->

(0);

78 
š‘_Áİ
(
AF_INET
, &

, 
buf
,  buf);

80 
	gLOG_INFO
 << "»sŞved " << 
	gho¡
 << " : " << 
	gbuf
 << "\n"

81 << 
	g»¥
->
DebugSŒšg
().
c_¡r
();

85 
	gLOG_INFO
 << "»sŞved " << 
	gho¡
 << " failed";

88 ià(++
	ggÙ_
 >ğ
tÙ®_
)

90 
ş›Á_
.
discÚÃù
();

94 
Ev’tLoİ
* 
	gloİ_
;

95 
TıCl›Á
 
	gş›Á_
;

96 
RpcChªÃlPŒ
 
	gchªÃl_
;

97 
	ggÙ_
;

98 
	gtÙ®_
;

99 
	g»sŞv”
::
ResŞv”S”viû
::
Stub
 
¡ub_
;

102 
	$maš
(
¬gc
, * 
¬gv
[])

104 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

105 ià(
¬gc
 > 1)

107 
Ev’tLoİ
 
loİ
;

108 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 2053);

110 
RpcCl›Á
 
	`½cCl›Á
(&
loİ
, 
£rv”Addr
);

111 
½cCl›Á
.
	`cÚÃù
();

112 
loİ
.
	`loİ
();

116 
	`´štf
("U§ge: % ho¡_\n", 
¬gv
[0]);

118 
	}
}

	@examples/protobuf/resolver/server.cc

1 
	~<exam¶es/´Ùobuf/»sŞv”/»sŞv”.pb.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/´ÙÜpc/RpcS”v”.h
>

6 
	~<exam¶es/cdns/ResŞv”.h
>

8 
	~<boo¡/bšd.hµ
>

10 
	~<uni¡d.h
>

12 
usšg
 
Çme¥aû
 
	gmuduo
;

13 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

15 
Çme¥aû
 
	g»sŞv”


18 şas 
	cResŞv”S”viûIm¶
 : 
public
 
ResŞv”S”viû


20 
public
:

21 
ResŞv”S”viûIm¶
(
Ev’tLoİ
* 
loİ
)

22 : 
»sŞv”_
(
loİ
, 
cdns
::
ResŞv”
::
kDNSÚly
)

26 
vœtu®
 
ResŞve
(::
googË
::
´Ùobuf
::
RpcCÚŒŞËr
* 
cÚŒŞËr
,

27 cÚ¡ ::
»sŞv”
::
ResŞveReque¡
* 
»que¡
,

28 ::
»sŞv”
::
ResŞveRe¥Ú£
* 
»¥Ú£
,

29 ::
googË
::
´Ùobuf
::
Closu»
* 
dÚe
)

31 
LOG_INFO
 << "ResŞv”S”viûIm¶::ResŞv" << 
»que¡
->
add»ss
();

33 
boŞ
 
	gsucûed
 = 
»sŞv”_
.
»sŞve
(
»que¡
->
add»ss
(),

34 
boo¡
::
bšd
(&
ResŞv”S”viûIm¶
::
dÚeC®lback
,

35 
this
,

36 
»que¡
->
add»ss
(),

37 
_1
,

38 
»¥Ú£
,

39 
dÚe
));

40 ià(!
	gsucûed
)

42 
	g»¥Ú£
->
£t_»sŞved
(
çl£
);

43 
	gdÚe
->
Run
();

47 
	g´iv©e
:

49 
dÚeC®lback
(cÚ¡ 
¡d
::
¡ršg
& 
ho¡
,

50 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
add»ss
,

51 ::
»sŞv”
::
ResŞveRe¥Ú£
* 
»¥Ú£
,

52 ::
googË
::
´Ùobuf
::
Closu»
* 
dÚe
)

55 
LOG_INFO
 << "ResŞv”S”viûIm¶::dÚeC®lback " << 
ho¡
;

56 
št32_t
 
	g
 = 
add»ss
.
N‘EndŸn
();

57 ià(
	g
)

59 
	g»¥Ú£
->
£t_»sŞved
(
Œue
);

60 
	g»¥Ú£
->
add_
(

);

61 
	g»¥Ú£
->
add_pÜt
(
add»ss
.
pÜtN‘EndŸn
());

65 
	g»¥Ú£
->
£t_»sŞved
(
çl£
);

67 
	gdÚe
->
Run
();

70 
	gcdns
::
ResŞv”
 
»sŞv”_
;

75 
	$maš
()

77 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

78 
Ev’tLoİ
 
loİ
;

79 
IÃtAdd»ss
 
	`li¡’Addr
(2053);

80 
»sŞv”
::
ResŞv”S”viûIm¶
 
	`im¶
(&
loİ
);

81 
RpcS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

82 
£rv”
.
	`»gi¡”S”viû
(&
im¶
);

83 
£rv”
.
	`¡¬t
();

84 
loİ
.
	`loİ
();

85 
	}
}

	@examples/protobuf/rpc/client.cc

1 
	~<exam¶es/´Ùobuf/½c/sudoku.pb.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/IÃtAdd»ss.h
>

6 
	~<muduo/Ãt/TıCl›Á.h
>

7 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

8 
	~<muduo/Ãt/´ÙÜpc/RpcChªÃl.h
>

10 
	~<boo¡/bšd.hµ
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 şas 
	cRpcCl›Á
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
	$RpcCl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
)

22 : 
	`loİ_
(
loİ
),

23 
	`ş›Á_
(
loİ
, 
£rv”Addr
, "RpcClient"),

24 
	`chªÃl_
(
Ãw
 
RpcChªÃl
),

25 
	`¡ub_
(
	$g‘_poš‹r
(
chªÃl_
))

27 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

28 
boo¡
::
	`bšd
(&
RpcCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

29 
ş›Á_
.
	`£tMes§geC®lback
(

30 
boo¡
::
	`bšd
(&
RpcChªÃl
::
ÚMes§ge
, 
	`g‘_poš‹r
(
chªÃl_
), 
_1
, 
_2
, 
_3
));

34 
	$cÚÃù
()

36 
ş›Á_
.
	`cÚÃù
();

37 
	}
}

39 
	g´iv©e
:

40 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

42 ià(
cÚn
->
	`cÚÃùed
())

45 
chªÃl_
->
	`£tCÚÃùiÚ
(
cÚn
);

46 
sudoku
::
SudokuReque¡
 
»que¡
;

47 
»que¡
.
	`£t_check”bßrd
("001010");

48 
sudoku
::
SudokuRe¥Ú£
* 
»¥Ú£
 = 
Ãw
 sudoku::SudokuResponse;

50 
¡ub_
.
	`SŞve
(
NULL
, &
»que¡
, 
»¥Ú£
, 
	`NewC®lback
(
this
, &
RpcCl›Á
::
sŞved
,„esponse));

54 
loİ_
->
	`qu™
();

56 
	}
}

58 
sŞved
(
sudoku
::
SudokuRe¥Ú£
* 
»¥
)

60 
LOG_INFO
 << "sŞved:\n" << 
»¥
->
DebugSŒšg
().
c_¡r
();

61 
	gş›Á_
.
discÚÃù
();

64 
Ev’tLoİ
* 
	gloİ_
;

65 
TıCl›Á
 
	gş›Á_
;

66 
RpcChªÃlPŒ
 
	gchªÃl_
;

67 
	gsudoku
::
SudokuS”viû
::
Stub
 
¡ub_
;

70 
	$maš
(
¬gc
, * 
¬gv
[])

72 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

73 ià(
¬gc
 > 1)

75 
Ev’tLoİ
 
loİ
;

76 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 9981);

78 
RpcCl›Á
 
	`½cCl›Á
(&
loİ
, 
£rv”Addr
);

79 
½cCl›Á
.
	`cÚÃù
();

80 
loİ
.
	`loİ
();

84 
	`´štf
("U§ge: % ho¡_\n", 
¬gv
[0]);

86 
googË
::
´Ùobuf
::
	`ShutdownPrÙobufLib¿ry
();

87 
	}
}

	@examples/protobuf/rpc/server.cc

1 
	~<exam¶es/´Ùobuf/½c/sudoku.pb.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/´ÙÜpc/RpcS”v”.h
>

7 
	~<boo¡/bšd.hµ
>

9 
	~<uni¡d.h
>

11 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

14 
Çme¥aû
 
	gsudoku


17 şas 
	cSudokuS”viûIm¶
 : 
public
 
SudokuS”viû


19 
public
:

20 
vœtu®
 
SŞve
(::
googË
::
´Ùobuf
::
RpcCÚŒŞËr
* 
cÚŒŞËr
,

21 cÚ¡ ::
sudoku
::
SudokuReque¡
* 
»que¡
,

22 ::
sudoku
::
SudokuRe¥Ú£
* 
»¥Ú£
,

23 ::
googË
::
´Ùobuf
::
Closu»
* 
dÚe
)

25 
LOG_INFO
 << "SudokuServiceImpl::Solve";

26 
	g»¥Ú£
->
£t_sŞved
(
Œue
);

27 
	g»¥Ú£
->
£t_check”bßrd
("1234567");

28 
	gdÚe
->
Run
();

34 
	$maš
()

36 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

37 
Ev’tLoİ
 
loİ
;

38 
IÃtAdd»ss
 
	`li¡’Addr
(9981);

39 
sudoku
::
SudokuS”viûIm¶
 
im¶
;

40 
RpcS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

41 
£rv”
.
	`»gi¡”S”viû
(&
im¶
);

42 
£rv”
.
	`¡¬t
();

43 
loİ
.
	`loİ
();

44 
googË
::
´Ùobuf
::
	`ShutdownPrÙobufLib¿ry
();

45 
	}
}

	@examples/protobuf/rpcbalancer/balancer.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/ba£/Th»adLoÿl.h
>

3 
	~<muduo/Ãt/Ev’tLoİ.h
>

4 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

5 
	~<muduo/Ãt/TıCl›Á.h
>

6 
	~<muduo/Ãt/TıS”v”.h
>

7 
	~<muduo/Ãt/´ÙÜpc/RpcCodec.h
>

8 
	~<muduo/Ãt/´ÙÜpc/½c.pb.h
>

10 
	~<boo¡/bšd.hµ
>

11 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

13 
	~<¡dio.h
>

14 
	~<uni¡d.h
>

16 
usšg
 
Çme¥aû
 
	gmuduo
;

17 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

19 şas 
	cBack’dSessiÚ
 : 
boo¡
::
nÚcİyabË


21 
public
:

22 
	$Back’dSessiÚ
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
back’dAddr
, cÚ¡ 
¡ršg
& 
Çme
)

23 : 
	`loİ_
(
loİ
),

24 
	`ş›Á_
(
loİ
, 
back’dAddr
, 
Çme
),

25 
	`codec_
(
boo¡
::
	`bšd
(&
Back’dSessiÚ
::
ÚRpcMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

26 
	$ÃxtId_
(0)

28 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

29 
boo¡
::
	`bšd
(&
Back’dSessiÚ
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

30 
ş›Á_
.
	`£tMes§geC®lback
(

31 
boo¡
::
	`bšd
(&
RpcCodec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

32 
ş›Á_
.
	`’abËR‘ry
();

35 
	$cÚÃù
()

37 
ş›Á_
.
	`cÚÃù
();

38 
	}
}

41 
boŞ
 
	$£nd
(
RpcMes§ge
& 
msg
, cÚ¡ 
TıCÚÃùiÚPŒ
& 
ş›ÁCÚn
)

43 
loİ_
->
	`as£¹InLoİTh»ad
();

44 ià(
cÚn_
)

46 
ušt64_t
 
id
 = ++
ÃxtId_
;

47 
Reque¡
 
r
 = { 
msg
.
	`id
(), 
ş›ÁCÚn
 };

48 
	`as£¹
(
out¡ªdšgs_
.
	`fšd
(
id
è=ğout¡ªdšgs_.
	`’d
());

49 
out¡ªdšgs_
[
id
] = 
r
;

50 
msg
.
	`£t_id
(
id
);

51 
codec_
.
	`£nd
(
cÚn_
, 
msg
);

54  
Œue
;

57  
çl£
;

58 
	}
}

60 
	g´iv©e
:

61 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

63 
loİ_
->
	`as£¹InLoİTh»ad
();

64 
LOG_INFO
 << "Backend "

65 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

66 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

67 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

68 ià(
cÚn
->
	`cÚÃùed
())

70 
cÚn_
 = 
cÚn
;

74 
cÚn_
.
	`»£t
();

77 
	}
}

79 
	$ÚRpcMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

80 cÚ¡ 
RpcMes§gePŒ
& 
msg
,

81 
Time¡amp
)

83 
loİ_
->
	`as£¹InLoİTh»ad
();

84 
¡d
::
m­
<
ušt64_t
, 
Reque¡
>::
™”©Ü
 
™
 = 
out¡ªdšgs_
.
	`fšd
(
msg
->
	`id
());

85 ià(
™
 !ğ
out¡ªdšgs_
.
	`’d
())

87 
ušt64_t
 
ÜigId
 = 
™
->
£cÚd
.origId;

88 
TıCÚÃùiÚPŒ
 
ş›ÁCÚn
 = 
™
->
£cÚd
.ş›ÁCÚn.
	`lock
();

89 
out¡ªdšgs_
.
	`”a£
(
™
);

91 ià(
ş›ÁCÚn
)

95 
msg
->
	`£t_id
(
ÜigId
);

96 
codec_
.
	`£nd
(
ş›ÁCÚn
, *
msg
);

103 
	}
}

105 
	sReque¡


107 
ušt64_t
 
	gÜigId
;

108 
	gboo¡
::
w—k_±r
<
TıCÚÃùiÚ
> 
ş›ÁCÚn
;

111 
Ev’tLoİ
* 
	gloİ_
;

112 
TıCl›Á
 
	gş›Á_
;

113 
RpcCodec
 
	gcodec_
;

114 
TıCÚÃùiÚPŒ
 
	gcÚn_
;

115 
ušt64_t
 
	gÃxtId_
;

116 
	g¡d
::
m­
<
ušt64_t
, 
	gReque¡
> 
	gout¡ªdšgs_
;

119 şas 
	cB®ªûr
 : 
boo¡
::
nÚcİyabË


121 
public
:

122 
B®ªûr
(
Ev’tLoİ
* 
loİ
,

123 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

124 cÚ¡ 
¡ršg
& 
Çme
,

125 cÚ¡ 
¡d
::
veùÜ
<
IÃtAdd»ss
>& 
back’ds
)

126 : 
loİ_
(
loİ
),

127 
£rv”_
(
loİ
, 
li¡’Addr
, 
Çme
),

128 
codec_
(
boo¡
::
bšd
(&
B®ªûr
::
ÚRpcMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

129 
	$back’ds_
(
back’ds
)

131 
£rv”_
.
	`£tTh»adIn™C®lback
(

132 
boo¡
::
	`bšd
(&
B®ªûr
::
š™P”Th»ad
, 
this
, 
_1
));

133 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

134 
boo¡
::
	`bšd
(&
B®ªûr
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

135 
£rv”_
.
	`£tMes§geC®lback
(

136 
boo¡
::
	`bšd
(&
RpcCodec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

139 ~
	$B®ªûr
()

141 
	}
}

143 
	$£tTh»adNum
(
numTh»ads
)

145 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

146 
	}
}

148 
	$¡¬t
()

150 
£rv”_
.
	`¡¬t
();

151 
	}
}

153 
	g´iv©e
:

154 
	sP”Th»ad


156 
size_t
 
cu¼’t
;

157 
	gboo¡
::
±r_veùÜ
<
Back’dSessiÚ
> 
back’ds
;

158 
P”Th»ad
(è: 
cu¼’t
(0) { }

161 
	$š™P”Th»ad
(
Ev’tLoİ
* 
ioLoİ
)

163 
couÁ
 = 
th»adCouÁ_
.
	`g‘AndAdd
(1);

164 
LOG_INFO
 << "IOh»ad " << 
couÁ
;

165 
P”Th»ad
& 
t
 = 
t_back’ds_
.
	`v®ue
();

166 
t
.
cu¼’t
 = 
couÁ
 % 
back’ds_
.
	`size
();

168 
size_t
 
i
 = 0; i < 
back’ds_
.
	`size
(); ++i)

170 
buf
[32];

171 
	`¢´štf
(
buf
,  buf, "%s#%d", 
back’ds_
[
i
].
	`toIpPÜt
().
	`c_¡r
(), 
couÁ
);

172 
t
.
back’ds
.
	`push_back
(
Ãw
 
	`Back’dSessiÚ
(
ioLoİ
, 
back’ds_
[
i
], 
buf
));

173 
t
.
back’ds
.
	`back
().
	`cÚÃù
();

175 
	}
}

177 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

179 
LOG_INFO
 << "Client "

180 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

181 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

182 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

183 ià(!
cÚn
->
	`cÚÃùed
())

187 
	}
}

189 
	$ÚRpcMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

190 cÚ¡ 
RpcMes§gePŒ
& 
msg
,

191 
Time¡amp
)

193 
P”Th»ad
& 
t
 = 
t_back’ds_
.
	`v®ue
();

194 
boŞ
 
sucûed
 = 
çl£
;

195 
size_t
 
i
 = 0; i < 
t
.
back’ds
.
	`size
(è&& !
sucûed
; ++i)

197 
sucûed
 = 
t
.
back’ds
[t.
cu¼’t
].
	`£nd
(*
msg
, 
cÚn
);

198 
t
.
cu¼’t
 = (t.cu¼’t+1è%.
back’ds
.
	`size
();

200 ià(!
sucûed
)

204 
	}
}

206 
Ev’tLoİ
* 
	gloİ_
;

207 
TıS”v”
 
	g£rv”_
;

208 
RpcCodec
 
	gcodec_
;

209 
	g¡d
::
veùÜ
<
IÃtAdd»ss
> 
back’ds_
;

210 
AtomicIÁ32
 
	gth»adCouÁ_
;

211 
	gTh»adLoÿl
<
	gP”Th»ad
> 
	gt_back’ds_
;

214 
	$maš
(
¬gc
, * 
¬gv
[])

216 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

217 ià(
¬gc
 < 3)

219 
	`årštf
(
¡d”r
, "U§ge: % li¡’_pÜˆback’d_:pÜˆ[back’d_:pÜt]\n", 
¬gv
[0]);

223 
¡d
::
veùÜ
<
IÃtAdd»ss
> 
back’ds
;

224 
i
 = 2; i < 
¬gc
; ++i)

226 
¡ršg
 
ho¡pÜt
 = 
¬gv
[
i
];

227 
size_t
 
cŞÚ
 = 
ho¡pÜt
.
	`fšd
(':');

228 ià(
cŞÚ
 !ğ
¡ršg
::
Åos
)

230 
¡ršg
 

 = 
ho¡pÜt
.
	`sub¡r
(0, 
cŞÚ
);

231 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
ho¡pÜt
.
	`c_¡r
()+
cŞÚ
+1));

232 
back’ds
.
	`push_back
(
	`IÃtAdd»ss
(

, 
pÜt
));

236 
	`årštf
(
¡d”r
, "šv®id back’d‡dd»s %s\n", 
¬gv
[
i
]);

240 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

241 
IÃtAdd»ss
 
	`li¡’Addr
(
pÜt
);

243 
Ev’tLoİ
 
loİ
;

244 
B®ªûr
 
	`b®ªûr
(&
loİ
, 
li¡’Addr
, "RpcB®ªûr", 
back’ds
);

245 
b®ªûr
.
	`£tTh»adNum
(4);

246 
b®ªûr
.
	`¡¬t
();

247 
loİ
.
	`loİ
();

249 
googË
::
´Ùobuf
::
	`ShutdownPrÙobufLib¿ry
();

250 
	}
}

	@examples/protobuf/rpcbalancer/balancer_raw.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/ba£/Th»adLoÿl.h
>

3 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

6 
	~<muduo/Ãt/TıCl›Á.h
>

7 
	~<muduo/Ãt/TıS”v”.h
>

9 
	~<muduo/Ãt/´ÙÜpc/RpcCodec.h
>

10 
	~<muduo/Ãt/´ÙÜpc/½c.pb.h
>

12 
	~<boo¡/bšd.hµ
>

13 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

15 
	~<’dŸn.h
>

16 
	~<¡dio.h
>

17 
	~<uni¡d.h
>

19 
usšg
 
Çme¥aû
 
	gmuduo
;

20 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

22 
	sRawMes§ge


24 
RawMes§ge
(
SŒšgP›û
 
m
)

25 : 
mes§ge_
(
m
), 
id_
(0), 
loc_
(
NULL
)

28 
ušt64_t
 
id
(ècÚ¡ {  
	mid_
; }

29 
£t_id
(
ušt64_t
 
x
è{ 
	mid_
 = x; }

31 
boŞ
 
·r£
(cÚ¡ 
¡ršg
& 
g
)

33 cÚ¡ * cÚ¡ 
	mbody
 = 
mes§ge_
.
d©a
(è+ 
PrÙobufCodecL™e
::
kH—d”L’
;

34 cÚ¡ 
	mbodyËn
 = 
mes§ge_
.
size
(è- 
PrÙobufCodecL™e
::
kH—d”L’
;

35 cÚ¡ 
	mgËn
 = 
¡©ic_ÿ¡
<>(
g
.
size
());

36 ià(
	mPrÙobufCodecL™e
::
v®id©eChecksum
(
body
, 
bodyËn
)

37 && (
memcmp
(
body
, 
g
.
d©a
(),ag.
size
()) == 0)

38 && (
bodyËn
 >ğ
gËn
 + 3 + 8))

40 cÚ¡ * cÚ¡ 
p
 = 
body
 + 
gËn
;

41 
ušt8_t
 
	mty³
 = *(
p
+1);

43 ià(*
	mp
 =ğ0x08 && (
ty³
 =ğ0x01 ||y³ =ğ0x02è&& *(
p
+2) == 0x11)

45 
ušt64_t
 
x
 = 0;

46 
memıy
(&
x
, 
p
+3, (x));

47 
£t_id
(
Ë64toh
(
x
));

48 
	mloc_
 = 
p
+3;

49  
	mŒue
;

52  
	mçl£
;

55 
upd©eId
()

57 
ušt64_t
 
	mË64
 = 
htŞe64
(
id_
);

58 
memıy
(
cÚ¡_ÿ¡
<*>(
loc_
), &
Ë64
, (le64));

60 cÚ¡ * 
	mbody
 = 
mes§ge_
.
d©a
(è+ 
PrÙobufCodecL™e
::
kH—d”L’
;

61 
	mbodyËn
 = 
mes§ge_
.
size
(è- 
PrÙobufCodecL™e
::
kH—d”L’
;

62 
št32_t
 
	mcheckSum
 = 
PrÙobufCodecL™e
::
checksum
(
body
, 
bodyËn
 - PrÙobufCodecL™e::
kChecksumL’
);

63 
št32_t
 
	mbe32
 = 
sock‘s
::
ho¡ToN‘wÜk32
(
checkSum
);

64 
memıy
(
cÚ¡_ÿ¡
<*>(
body
 + 
bodyËn
 - 
PrÙobufCodecL™e
::
kChecksumL’
), &
be32
, (be32));

67 
SŒšgP›û
 
	mmes§ge_
;

69 
	m´iv©e
:

70 
ušt64_t
 
id_
;

71 cÚ¡ * 
	mloc_
;

74 şas 
	cBack’dSessiÚ
 : 
boo¡
::
nÚcİyabË


76 
public
:

77 
	$Back’dSessiÚ
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
back’dAddr
, cÚ¡ 
¡ršg
& 
Çme
)

78 : 
	`loİ_
(
loİ
),

79 
	`ş›Á_
(
loİ
, 
back’dAddr
, 
Çme
),

80 
	`codec_
(
boo¡
::
	`bšd
(&
Back’dSessiÚ
::
ÚRpcMes§ge
, 
this
, 
_1
, 
_2
, 
_3
),

81 
boo¡
::
	`bšd
(&
Back’dSessiÚ
::
ÚRawMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

82 
	$ÃxtId_
(0)

84 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

85 
boo¡
::
	`bšd
(&
Back’dSessiÚ
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

86 
ş›Á_
.
	`£tMes§geC®lback
(

87 
boo¡
::
	`bšd
(&
RpcCodec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

88 
ş›Á_
.
	`’abËR‘ry
();

91 
	$cÚÃù
()

93 
ş›Á_
.
	`cÚÃù
();

94 
	}
}

97 
	g‹m¶©e
<
ty³Çme
 
	gMSG
>

98 
boŞ
 
	$£nd
(
MSG
& 
msg
, cÚ¡ 
TıCÚÃùiÚPŒ
& 
ş›ÁCÚn
)

100 
loİ_
->
	`as£¹InLoİTh»ad
();

101 ià(
cÚn_
)

103 
ušt64_t
 
id
 = ++
ÃxtId_
;

104 
Reque¡
 
r
 = { 
msg
.
	`id
(), 
ş›ÁCÚn
 };

105 
	`as£¹
(
out¡ªdšgs_
.
	`fšd
(
id
è=ğout¡ªdšgs_.
	`’d
());

106 
out¡ªdšgs_
[
id
] = 
r
;

107 
msg
.
	`£t_id
(
id
);

108 
	`£ndTo
(
cÚn_
, 
msg
);

111  
Œue
;

114  
çl£
;

115 
	}
}

117 
	g´iv©e
:

118 
	$£ndTo
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, cÚ¡ 
RpcMes§ge
& 
msg
)

120 
codec_
.
	`£nd
(
cÚn
, 
msg
);

121 
	}
}

123 
	$£ndTo
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
RawMes§ge
& 
msg
)

125 
msg
.
	`upd©eId
();

126 
cÚn
->
	`£nd
(
msg
.
mes§ge_
);

127 
	}
}

129 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

131 
loİ_
->
	`as£¹InLoİTh»ad
();

132 
LOG_INFO
 << "Backend "

133 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

134 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

135 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

136 ià(
cÚn
->
	`cÚÃùed
())

138 
cÚn_
 = 
cÚn
;

142 
cÚn_
.
	`»£t
();

145 
	}
}

147 
	$ÚRpcMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

148 cÚ¡ 
RpcMes§gePŒ
& 
msg
,

149 
Time¡amp
)

151 
	`ÚMes§geT
(*
msg
);

152 
	}
}

154 
boŞ
 
	$ÚRawMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

155 
SŒšgP›û
 
mes§ge
,

156 
Time¡amp
)

158 
RawMes§ge
 
	`¿w
(
mes§ge
);

159 ià(
¿w
.
	`·r£
(
codec_
.
	`g
()))

161 
	`ÚMes§geT
(
¿w
);

162  
çl£
;

165  
Œue
;

166 
	}
}

168 
	g‹m¶©e
<
ty³Çme
 
	gMSG
>

169 
	$ÚMes§geT
(
MSG
& 
msg
)

171 
loİ_
->
	`as£¹InLoİTh»ad
();

172 
¡d
::
m­
<
ušt64_t
, 
Reque¡
>::
™”©Ü
 
™
 = 
out¡ªdšgs_
.
	`fšd
(
msg
.
	`id
());

173 ià(
™
 !ğ
out¡ªdšgs_
.
	`’d
())

175 
ušt64_t
 
ÜigId
 = 
™
->
£cÚd
.origId;

176 
TıCÚÃùiÚPŒ
 
ş›ÁCÚn
 = 
™
->
£cÚd
.ş›ÁCÚn.
	`lock
();

177 
out¡ªdšgs_
.
	`”a£
(
™
);

179 ià(
ş›ÁCÚn
)

183 
msg
.
	`£t_id
(
ÜigId
);

184 
	`£ndTo
(
ş›ÁCÚn
, 
msg
);

191 
	}
}

193 
	sReque¡


195 
ušt64_t
 
	gÜigId
;

196 
	gboo¡
::
w—k_±r
<
TıCÚÃùiÚ
> 
ş›ÁCÚn
;

199 
Ev’tLoİ
* 
	gloİ_
;

200 
TıCl›Á
 
	gş›Á_
;

201 
RpcCodec
 
	gcodec_
;

202 
TıCÚÃùiÚPŒ
 
	gcÚn_
;

203 
ušt64_t
 
	gÃxtId_
;

204 
	g¡d
::
m­
<
ušt64_t
, 
	gReque¡
> 
	gout¡ªdšgs_
;

207 şas 
	cB®ªûr
 : 
boo¡
::
nÚcİyabË


209 
public
:

210 
B®ªûr
(
Ev’tLoİ
* 
loİ
,

211 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

212 cÚ¡ 
¡ršg
& 
Çme
,

213 cÚ¡ 
¡d
::
veùÜ
<
IÃtAdd»ss
>& 
back’ds
)

214 : 
loİ_
(
loİ
),

215 
£rv”_
(
loİ
, 
li¡’Addr
, 
Çme
),

216 
codec_
(
boo¡
::
bšd
(&
B®ªûr
::
ÚRpcMes§ge
, 
this
, 
_1
, 
_2
, 
_3
),

217 
boo¡
::
bšd
(&
B®ªûr
::
ÚRawMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

218 
	$back’ds_
(
back’ds
)

220 
£rv”_
.
	`£tTh»adIn™C®lback
(

221 
boo¡
::
	`bšd
(&
B®ªûr
::
š™P”Th»ad
, 
this
, 
_1
));

222 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

223 
boo¡
::
	`bšd
(&
B®ªûr
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

224 
£rv”_
.
	`£tMes§geC®lback
(

225 
boo¡
::
	`bšd
(&
RpcCodec
::
ÚMes§ge
, &
codec_
, 
_1
, 
_2
, 
_3
));

228 ~
	$B®ªûr
()

230 
	}
}

232 
	$£tTh»adNum
(
numTh»ads
)

234 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

235 
	}
}

237 
	$¡¬t
()

239 
£rv”_
.
	`¡¬t
();

240 
	}
}

242 
	g´iv©e
:

243 
	sP”Th»ad


245 
size_t
 
cu¼’t
;

246 
	gboo¡
::
±r_veùÜ
<
Back’dSessiÚ
> 
back’ds
;

247 
P”Th»ad
(è: 
cu¼’t
(0) { }

250 
	$š™P”Th»ad
(
Ev’tLoİ
* 
ioLoİ
)

252 
couÁ
 = 
th»adCouÁ_
.
	`g‘AndAdd
(1);

253 
LOG_INFO
 << "IOh»ad " << 
couÁ
;

254 
P”Th»ad
& 
t
 = 
t_back’ds_
.
	`v®ue
();

255 
t
.
cu¼’t
 = 
couÁ
 % 
back’ds_
.
	`size
();

257 
size_t
 
i
 = 0; i < 
back’ds_
.
	`size
(); ++i)

259 
buf
[32];

260 
	`¢´štf
(
buf
,  buf, "%s#%d", 
back’ds_
[
i
].
	`toIpPÜt
().
	`c_¡r
(), 
couÁ
);

261 
t
.
back’ds
.
	`push_back
(
Ãw
 
	`Back’dSessiÚ
(
ioLoİ
, 
back’ds_
[
i
], 
buf
));

262 
t
.
back’ds
.
	`back
().
	`cÚÃù
();

264 
	}
}

266 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

268 
LOG_INFO
 << "Client "

269 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

270 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

271 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

272 ià(!
cÚn
->
	`cÚÃùed
())

276 
	}
}

278 
boŞ
 
	$ÚRawMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

279 
SŒšgP›û
 
mes§ge
,

280 
Time¡amp
)

282 
RawMes§ge
 
	`¿w
(
mes§ge
);

283 ià(
¿w
.
	`·r£
(
codec_
.
	`g
()))

285 
	`ÚMes§geT
(
cÚn
, 
¿w
);

286  
çl£
;

289  
Œue
;

290 
	}
}

292 
	$ÚRpcMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

293 cÚ¡ 
RpcMes§gePŒ
& 
msg
,

294 
Time¡amp
)

296 
	`ÚMes§geT
(
cÚn
, *
msg
);

297 
	}
}

299 
	g‹m¶©e
<
ty³Çme
 
	gMSG
>

300 
boŞ
 
	$ÚMes§geT
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
MSG
& 
msg
)

302 
P”Th»ad
& 
t
 = 
t_back’ds_
.
	`v®ue
();

303 
boŞ
 
sucûed
 = 
çl£
;

304 
size_t
 
i
 = 0; i < 
t
.
back’ds
.
	`size
(è&& !
sucûed
; ++i)

306 
sucûed
 = 
t
.
back’ds
[t.
cu¼’t
].
	`£nd
(
msg
, 
cÚn
);

307 
t
.
cu¼’t
 = (t.cu¼’t+1è%.
back’ds
.
	`size
();

309 ià(!
sucûed
)

313  
sucûed
;

314 
	}
}

316 
Ev’tLoİ
* 
	gloİ_
;

317 
TıS”v”
 
	g£rv”_
;

318 
RpcCodec
 
	gcodec_
;

319 
	g¡d
::
veùÜ
<
IÃtAdd»ss
> 
back’ds_
;

320 
AtomicIÁ32
 
	gth»adCouÁ_
;

321 
	gTh»adLoÿl
<
	gP”Th»ad
> 
	gt_back’ds_
;

324 
	$maš
(
¬gc
, * 
¬gv
[])

326 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

327 ià(
¬gc
 < 3)

329 
	`årštf
(
¡d”r
, "U§ge: % li¡’_pÜˆback’d_:pÜˆ[back’d_:pÜt]\n", 
¬gv
[0]);

333 
¡d
::
veùÜ
<
IÃtAdd»ss
> 
back’ds
;

334 
i
 = 2; i < 
¬gc
; ++i)

336 
¡ršg
 
ho¡pÜt
 = 
¬gv
[
i
];

337 
size_t
 
cŞÚ
 = 
ho¡pÜt
.
	`fšd
(':');

338 ià(
cŞÚ
 !ğ
¡ršg
::
Åos
)

340 
¡ršg
 

 = 
ho¡pÜt
.
	`sub¡r
(0, 
cŞÚ
);

341 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
ho¡pÜt
.
	`c_¡r
()+
cŞÚ
+1));

342 
back’ds
.
	`push_back
(
	`IÃtAdd»ss
(

, 
pÜt
));

346 
	`årštf
(
¡d”r
, "šv®id back’d‡dd»s %s\n", 
¬gv
[
i
]);

350 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

351 
IÃtAdd»ss
 
	`li¡’Addr
(
pÜt
);

355 
Ev’tLoİ
 
loİ
;

356 
B®ªûr
 
	`b®ªûr
(&
loİ
, 
li¡’Addr
, "RpcB®ªûr", 
back’ds
);

357 
b®ªûr
.
	`£tTh»adNum
(4);

358 
b®ªûr
.
	`¡¬t
();

359 
loİ
.
	`loİ
();

361 
googË
::
´Ùobuf
::
	`ShutdownPrÙobufLib¿ry
();

362 
	}
}

	@examples/protobuf/rpcbench/client.cc

1 
	~<exam¶es/´Ùobuf/½cb’ch/echo.pb.h
>

3 
	~<muduo/ba£/CouÁDownL©ch.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

7 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<muduo/Ãt/TıCl›Á.h
>

9 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

10 
	~<muduo/Ãt/´ÙÜpc/RpcChªÃl.h
>

12 
	~<boo¡/bšd.hµ
>

13 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

15 
	~<¡dio.h
>

16 
	~<uni¡d.h
>

18 
usšg
 
Çme¥aû
 
	gmuduo
;

19 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

21 cÚ¡ 
	gkReque¡s
 = 50000;

23 şas 
	cRpcCl›Á
 : 
boo¡
::
nÚcİyabË


25 
public
:

27 
	$RpcCl›Á
(
Ev’tLoİ
* 
loİ
,

28 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

29 
CouÁDownL©ch
* 
®lCÚÃùed
,

30 
CouÁDownL©ch
* 
®lFšished
)

32 
	`ş›Á_
(
loİ
, 
£rv”Addr
, "RpcClient"),

33 
	`chªÃl_
(
Ãw
 
RpcChªÃl
),

34 
	`¡ub_
(
	`g‘_poš‹r
(
chªÃl_
)),

35 
	`®lCÚÃùed_
(
®lCÚÃùed
),

36 
	`®lFšished_
(
®lFšished
),

37 
	$couÁ_
(0)

39 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

40 
boo¡
::
	`bšd
(&
RpcCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

41 
ş›Á_
.
	`£tMes§geC®lback
(

42 
boo¡
::
	`bšd
(&
RpcChªÃl
::
ÚMes§ge
, 
	`g‘_poš‹r
(
chªÃl_
), 
_1
, 
_2
, 
_3
));

46 
	$cÚÃù
()

48 
ş›Á_
.
	`cÚÃù
();

49 
	}
}

51 
	$£ndReque¡
()

53 
echo
::
EchoReque¡
 
»que¡
;

54 
»que¡
.
	`£t_·ylßd
("001010");

55 
echo
::
EchoRe¥Ú£
* 
»¥Ú£
 = 
Ãw
ƒcho::EchoResponse;

56 
¡ub_
.
	`Echo
(
NULL
, &
»que¡
, 
»¥Ú£
, 
	`NewC®lback
(
this
, &
RpcCl›Á
::
»¶›d
,„esponse));

57 
	}
}

59 
	g´iv©e
:

60 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

62 ià(
cÚn
->
	`cÚÃùed
())

65 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

66 
chªÃl_
->
	`£tCÚÃùiÚ
(
cÚn
);

67 
®lCÚÃùed_
->
	`couÁDown
();

69 
	}
}

71 
»¶›d
(
echo
::
EchoRe¥Ú£
* 
»¥
)

75 ++
couÁ_
;

76 ià(
	gcouÁ_
 < 
	gkReque¡s
)

78 
£ndReque¡
();

82 
	gLOG_INFO
 << "RpcCl›Á " << 
	gthis
 << " finished";

83 
	g®lFšished_
->
couÁDown
();

88 
TıCl›Á
 
	gş›Á_
;

89 
RpcChªÃlPŒ
 
	gchªÃl_
;

90 
	gecho
::
EchoS”viû
::
Stub
 
¡ub_
;

91 
CouÁDownL©ch
* 
	g®lCÚÃùed_
;

92 
CouÁDownL©ch
* 
	g®lFšished_
;

93 
	gcouÁ_
;

96 
	$maš
(
¬gc
, * 
¬gv
[])

98 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

99 ià(
¬gc
 > 1)

101 
nCl›Ás
 = 1;

103 ià(
¬gc
 > 2)

105 
nCl›Ás
 = 
	`©oi
(
¬gv
[2]);

108 
nTh»ads
 = 1;

110 ià(
¬gc
 > 3)

112 
nTh»ads
 = 
	`©oi
(
¬gv
[3]);

115 
CouÁDownL©ch
 
	`®lCÚÃùed
(
nCl›Ás
);

116 
CouÁDownL©ch
 
	`®lFšished
(
nCl›Ás
);

118 
Ev’tLoİ
 
loİ
;

119 
Ev’tLoİTh»adPoŞ
 
	`poŞ
(&
loİ
, "rpcbench-client");

120 
poŞ
.
	`£tTh»adNum
(
nTh»ads
);

121 
poŞ
.
	`¡¬t
();

122 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 8888);

124 
boo¡
::
±r_veùÜ
<
RpcCl›Á
> 
ş›Ás
;

125 
i
 = 0; i < 
nCl›Ás
; ++i)

127 
ş›Ás
.
	`push_back
(
Ãw
 
	`RpcCl›Á
(
poŞ
.
	`g‘NextLoİ
(), 
£rv”Addr
, &
®lCÚÃùed
, &
®lFšished
));

128 
ş›Ás
.
	`back
().
	`cÚÃù
();

130 
®lCÚÃùed
.
	`wa™
();

131 
Time¡amp
 
	`¡¬t
(Time¡amp::
	`now
());

132 
LOG_INFO
 << "all connected";

133 
i
 = 0; i < 
nCl›Ás
; ++i)

135 
ş›Ás
[
i
].
	`£ndReque¡
();

137 
®lFšished
.
	`wa™
();

138 
Time¡amp
 
	`’d
(Time¡amp::
	`now
());

139 
LOG_INFO
 << "all finished";

140 
£cÚds
 = 
	`timeDifã»nû
(
’d
, 
¡¬t
);

141 
	`´štf
("%à£cÚds\n", 
£cÚds
);

142 
	`´štf
("%.1àÿÎ ³¸£cÚd\n", 
nCl›Ás
 * 
kReque¡s
 / 
£cÚds
);

144 
	`ex™
(0);

148 
	`´štf
("U§ge: % ho¡_‚umCl›Á [numTh»ads]\n", 
¬gv
[0]);

150 
	}
}

	@examples/protobuf/rpcbench/server.cc

1 
	~<exam¶es/´Ùobuf/½cb’ch/echo.pb.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/´ÙÜpc/RpcS”v”.h
>

7 
	~<uni¡d.h
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

12 
Çme¥aû
 
	gecho


15 şas 
	cEchoS”viûIm¶
 : 
public
 
EchoS”viû


17 
public
:

18 
vœtu®
 
Echo
(::
googË
::
´Ùobuf
::
RpcCÚŒŞËr
* 
cÚŒŞËr
,

19 cÚ¡ ::
echo
::
EchoReque¡
* 
»que¡
,

20 ::
echo
::
EchoRe¥Ú£
* 
»¥Ú£
,

21 ::
googË
::
´Ùobuf
::
Closu»
* 
dÚe
)

24 
»¥Ú£
->
£t_·ylßd
(
»que¡
->
·ylßd
());

25 
	gdÚe
->
Run
();

31 
	$maš
(
¬gc
, * 
¬gv
[])

33 
nTh»ads
 = 
¬gc
 > 1 ? 
	`©oi
(
¬gv
[1]) : 1;

34 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< "h»ad ğ" << 
nTh»ads
;

35 
Ev’tLoİ
 
loİ
;

36 
pÜt
 = 
¬gc
 > 2 ? 
	`©oi
(
¬gv
[2]) : 8888;

37 
IÃtAdd»ss
 
	`li¡’Addr
(
¡©ic_ÿ¡
<
ušt16_t
>(
pÜt
));

38 
echo
::
EchoS”viûIm¶
 
im¶
;

39 
RpcS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

40 
£rv”
.
	`£tTh»adNum
(
nTh»ads
);

41 
£rv”
.
	`»gi¡”S”viû
(&
im¶
);

42 
£rv”
.
	`¡¬t
();

43 
loİ
.
	`loİ
();

44 
	}
}

	@examples/roundtrip/roundtrip.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/TıCl›Á.h
>

4 
	~<muduo/Ãt/TıS”v”.h
>

6 
	~<¡dio.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 cÚ¡ 
size_t
 
	gäameL’
 = 2*(
št64_t
);

13 
	$£rv”CÚÃùiÚC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

15 
LOG_TRACE
 << 
cÚn
->
	`Çme
(è<< " " << cÚn->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

16 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

17 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

18 ià(
cÚn
->
	`cÚÃùed
())

20 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

25 
	}
}

27 
£rv”Mes§geC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

28 
Bufãr
* 
bufãr
,

29 
muduo
::
Time¡amp
 
»ûiveTime
)

31 
št64_t
 
mes§ge
[2];

32 
	gbufãr
->
»adabËBy‹s
(è>ğ
äameL’
)

34 
memıy
(
mes§ge
, 
bufãr
->
³ek
(), 
äameL’
);

35 
	gbufãr
->
»Œ›ve
(
äameL’
);

36 
	gmes§ge
[1] = 
»ûiveTime
.
miüoSecÚdsSšûEpoch
();

37 
	gcÚn
->
£nd
(
mes§ge
,  message);

41 
	$runS”v”
(
ušt16_t
 
pÜt
)

43 
Ev’tLoİ
 
loİ
;

44 
TıS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(
pÜt
), "ClockServer");

45 
£rv”
.
	`£tCÚÃùiÚC®lback
(
£rv”CÚÃùiÚC®lback
);

46 
£rv”
.
	`£tMes§geC®lback
(
£rv”Mes§geC®lback
);

47 
£rv”
.
	`¡¬t
();

48 
loİ
.
	`loİ
();

49 
	}
}

51 
TıCÚÃùiÚPŒ
 
	gş›ÁCÚÃùiÚ
;

53 
	$ş›ÁCÚÃùiÚC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

55 
LOG_TRACE
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

56 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

57 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

58 ià(
cÚn
->
	`cÚÃùed
())

60 
ş›ÁCÚÃùiÚ
 = 
cÚn
;

61 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

65 
ş›ÁCÚÃùiÚ
.
	`»£t
();

67 
	}
}

69 
ş›ÁMes§geC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

70 
Bufãr
* 
bufãr
,

71 
muduo
::
Time¡amp
 
»ûiveTime
)

73 
št64_t
 
mes§ge
[2];

74 
	gbufãr
->
»adabËBy‹s
(è>ğ
äameL’
)

76 
memıy
(
mes§ge
, 
bufãr
->
³ek
(), 
äameL’
);

77 
	gbufãr
->
»Œ›ve
(
äameL’
);

78 
št64_t
 
	g£nd
 = 
mes§ge
[0];

79 
št64_t
 
	gtheœ
 = 
mes§ge
[1];

80 
št64_t
 
	gback
 = 
»ûiveTime
.
miüoSecÚdsSšûEpoch
();

81 
št64_t
 
	gmše
 = (
back
+
£nd
)/2;

82 
	gLOG_INFO
 << "roundr " << 
	gback
 - 
	g£nd


83 << " clockƒ¼Ü " << 
	gtheœ
 - 
	gmše
;

87 
	$£ndMyTime
()

89 ià(
ş›ÁCÚÃùiÚ
)

91 
št64_t
 
mes§ge
[2] = { 0, 0 };

92 
mes§ge
[0] = 
Time¡amp
::
	`now
().
	`miüoSecÚdsSšûEpoch
();

93 
ş›ÁCÚÃùiÚ
->
	`£nd
(
mes§ge
,  message);

95 
	}
}

97 
	$runCl›Á
(cÚ¡ * 

, 
ušt16_t
 
pÜt
)

99 
Ev’tLoİ
 
loİ
;

100 
TıCl›Á
 
	`ş›Á
(&
loİ
, 
	`IÃtAdd»ss
(

, 
pÜt
), "ClockClient");

101 
ş›Á
.
	`’abËR‘ry
();

102 
ş›Á
.
	`£tCÚÃùiÚC®lback
(
ş›ÁCÚÃùiÚC®lback
);

103 
ş›Á
.
	`£tMes§geC®lback
(
ş›ÁMes§geC®lback
);

104 
ş›Á
.
	`cÚÃù
();

105 
loİ
.
	`runEv”y
(0.2, 
£ndMyTime
);

106 
loİ
.
	`loİ
();

107 
	}
}

109 
	$maš
(
¬gc
, * 
¬gv
[])

111 ià(
¬gc
 > 2)

113 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

114 ià(
	`¡rcmp
(
¬gv
[1], "-s") == 0)

116 
	`runS”v”
(
pÜt
);

120 
	`runCl›Á
(
¬gv
[1], 
pÜt
);

125 
	`´štf
("U§ge:\n% - pÜt\n% …Üt\n", 
¬gv
[0],‡rgv[0]);

127 
	}
}

	@examples/roundtrip/roundtrip_udp.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/ChªÃl.h
>

3 
	~<muduo/Ãt/Ev’tLoİ.h
>

4 
	~<muduo/Ãt/Sock‘.h
>

5 
	~<muduo/Ãt/Sock‘sOps.h
>

6 
	~<muduo/Ãt/TıCl›Á.h
>

7 
	~<muduo/Ãt/TıS”v”.h
>

9 
	~<boo¡/bšd.hµ
>

11 
	~<¡dio.h
>

13 
usšg
 
Çme¥aû
 
	gmuduo
;

14 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

16 cÚ¡ 
size_t
 
	gäameL’
 = 2*(
št64_t
);

18 
	$ü—‹NÚblockšgUDP
()

20 
sockfd
 = ::
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
 | 
SOCK_NONBLOCK
 | 
SOCK_CLOEXEC
, 
IPPROTO_UDP
);

21 ià(
sockfd
 < 0)

23 
LOG_SYSFATAL
 << "::socket";

25  
sockfd
;

26 
	}
}

30 
£rv”R—dC®lback
(
sockfd
, 
muduo
::
Time¡amp
 
»ûiveTime
)

32 
št64_t
 
mes§ge
[2];

33 
sockaddr
 
	g³”Addr
;

34 
bz”o
(&
³”Addr
, …eerAddr);

35 
sockËn_t
 
	gaddrL’
 =  
³”Addr
;

36 
ssize_t
 
	gÄ
 = ::
»cväom
(
sockfd
, 
mes§ge
,  mes§ge, 0, &
³”Addr
, &
addrL’
);

38 
	gaddrSŒ
[64];

39 
	gsock‘s
::
toIpPÜt
(
addrSŒ
, ‡ddrSŒ, &
³”Addr
);

40 
	gLOG_DEBUG
 << "»ûived " << 
	gÄ
 << " by‹ äom " << 
	gaddrSŒ
;

42 ià(
	gÄ
 < 0)

44 
	gLOG_SYSERR
 << "::recvfrom";

46 ià(
	gim¶ic™_ÿ¡
<
	gsize_t
>(
	gÄ
è=ğ
äameL’
)

48 
mes§ge
[1] = 
»ûiveTime
.
miüoSecÚdsSšûEpoch
();

49 
ssize_t
 
	gnw
 = ::
£ndto
(
sockfd
, 
mes§ge
,  mes§ge, 0, &
³”Addr
, 
addrL’
);

50 ià(
	gnw
 < 0)

52 
	gLOG_SYSERR
 << "::sendto";

54 ià(
	gim¶ic™_ÿ¡
<
	gsize_t
>(
	gnw
è!ğ
äameL’
)

56 
LOG_ERROR
 << "Ex³ù " << 
äameL’
 << " by‹s, wrÙ" << 
nw
 << " bytes.";

61 
	gLOG_ERROR
 << "Ex³ù " << 
	gäameL’
 << " by‹s,„eûived " << 
	gÄ
 << " bytes.";

65 
	$runS”v”
(
ušt16_t
 
pÜt
)

67 
Sock‘
 
	`sock
(
	`ü—‹NÚblockšgUDP
());

68 
sock
.
	`bšdAdd»ss
(
	`IÃtAdd»ss
(
pÜt
));

69 
Ev’tLoİ
 
loİ
;

70 
ChªÃl
 
	`chªÃl
(&
loİ
, 
sock
.
	`fd
());

71 
chªÃl
.
	`£tR—dC®lback
(
boo¡
::
	`bšd
(&
£rv”R—dC®lback
, 
sock
.
	`fd
(), 
_1
));

72 
chªÃl
.
	`’abËR—dšg
();

73 
loİ
.
	`loİ
();

74 
	}
}

78 
ş›ÁR—dC®lback
(
sockfd
, 
muduo
::
Time¡amp
 
»ûiveTime
)

80 
št64_t
 
mes§ge
[2];

81 
ssize_t
 
	gÄ
 = 
sock‘s
::
»ad
(
sockfd
, 
mes§ge
,  message);

83 ià(
	gÄ
 < 0)

85 
	gLOG_SYSERR
 << "::read";

87 ià(
	gim¶ic™_ÿ¡
<
	gsize_t
>(
	gÄ
è=ğ
äameL’
)

89 
št64_t
 
£nd
 = 
mes§ge
[0];

90 
št64_t
 
	gtheœ
 = 
mes§ge
[1];

91 
št64_t
 
	gback
 = 
»ûiveTime
.
miüoSecÚdsSšûEpoch
();

92 
št64_t
 
	gmše
 = (
back
+
£nd
)/2;

93 
	gLOG_INFO
 << "roundr " << 
	gback
 - 
	g£nd


94 << " clockƒ¼Ü " << 
	gtheœ
 - 
	gmše
;

98 
	gLOG_ERROR
 << "Ex³ù " << 
	gäameL’
 << " by‹s,„eûived " << 
	gÄ
 << " bytes.";

102 
	$£ndMyTime
(
sockfd
)

104 
št64_t
 
mes§ge
[2] = { 0, 0 };

105 
mes§ge
[0] = 
Time¡amp
::
	`now
().
	`miüoSecÚdsSšûEpoch
();

106 
ssize_t
 
nw
 = 
sock‘s
::
	`wr™e
(
sockfd
, 
mes§ge
,  message);

107 ià(
nw
 < 0)

109 
LOG_SYSERR
 << "::write";

111 ià(
im¶ic™_ÿ¡
<
size_t
>(
nw
è!ğ
äameL’
)

113 
LOG_ERROR
 << "Ex³ù " << 
äameL’
 << " by‹s, wrÙ" << 
nw
 << " bytes.";

115 
	}
}

117 
	$runCl›Á
(cÚ¡ * 

, 
ušt16_t
 
pÜt
)

119 
Sock‘
 
	`sock
(
	`ü—‹NÚblockšgUDP
());

120 
IÃtAdd»ss
 
	`£rv”Addr
(

, 
pÜt
);

121 
»t
 = 
sock‘s
::
	`cÚÃù
(
sock
.
	`fd
(), 
£rv”Addr
.
	`g‘SockAddr
());

122 ià(
»t
 < 0)

124 
LOG_SYSFATAL
 << "::connect";

126 
Ev’tLoİ
 
loİ
;

127 
ChªÃl
 
	`chªÃl
(&
loİ
, 
sock
.
	`fd
());

128 
chªÃl
.
	`£tR—dC®lback
(
boo¡
::
	`bšd
(&
ş›ÁR—dC®lback
, 
sock
.
	`fd
(), 
_1
));

129 
chªÃl
.
	`’abËR—dšg
();

130 
loİ
.
	`runEv”y
(0.2, 
boo¡
::
	`bšd
(
£ndMyTime
, 
sock
.
	`fd
()));

131 
loİ
.
	`loİ
();

132 
	}
}

134 
	$maš
(
¬gc
, * 
¬gv
[])

136 ià(
¬gc
 > 2)

138 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

139 ià(
	`¡rcmp
(
¬gv
[1], "-s") == 0)

141 
	`runS”v”
(
pÜt
);

145 
	`runCl›Á
(
¬gv
[1], 
pÜt
);

150 
	`´štf
("U§ge:\n% - pÜt\n% …Üt\n", 
¬gv
[0],‡rgv[0]);

152 
	}
}

	@examples/shorturl/shorturl.cc

1 
	~<muduo/Ãt/h‰p/H‰pS”v”.h
>

2 
	~<muduo/Ãt/h‰p/H‰pReque¡.h
>

3 
	~<muduo/Ãt/h‰p/H‰pRe¥Ú£.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

6 
	~<muduo/ba£/Loggšg.h
>

8 
	~<m­
>

9 
	~<boo¡/bšd.hµ
>

10 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

12 
	~<sys/sock‘.h
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 
çvicÚ
[555];

18 
boŞ
 
	gb’chm¬k
 = 
çl£
;

20 
	g¡d
::
m­
<
¡ršg
, 
	g¡ršg
> 
	g»dœeùiÚs
;

22 
	$ÚReque¡
(cÚ¡ 
H‰pReque¡
& 
»q
, 
H‰pRe¥Ú£
* 
»¥
)

24 
LOG_INFO
 << "H—d” " << 
»q
.
	`m‘hodSŒšg
(è<< " " <<„eq.
	`·th
();

25 ià(!
b’chm¬k
)

27 cÚ¡ 
¡d
::
m­
<
¡ršg
, sŒšg>& 
h—d”s
 = 
»q
.
	`h—d”s
();

28 
¡d
::
m­
<
¡ršg
, sŒšg>::
cÚ¡_™”©Ü
 
™
 = 
h—d”s
.
	`begš
();

29 
™
 !ğ
h—d”s
.
	`’d
();

30 ++
™
)

32 
LOG_DEBUG
 << 
™
->
fœ¡
 << ": " << it->
£cÚd
;

38 
¡d
::
m­
<
¡ršg
, sŒšg>::
cÚ¡_™”©Ü
 
™
 = 
»dœeùiÚs
.
	`fšd
(
»q
.
	`·th
());

39 ià(
™
 !ğ
»dœeùiÚs
.
	`’d
())

41 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k301MovedP”mª’y
);

42 
»¥
->
	`£tStusMes§ge
("Moved Permanently");

43 
»¥
->
	`addH—d”
("LoÿtiÚ", 
™
->
£cÚd
);

46 ià(
»q
.
	`·th
() == "/")

48 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k200Ok
);

49 
»¥
->
	`£tStusMes§ge
("OK");

50 
»¥
->
	`£tCÚ‹ÁTy³
("text/html");

51 
¡ršg
 
now
 = 
Time¡amp
::
	`now
().
	`toFÜm©‹dSŒšg
();

52 
¡d
::
m­
<
¡ršg
, sŒšg>::
cÚ¡_™”©Ü
 
i
 = 
»dœeùiÚs
.
	`begš
();

53 
¡ršg
 
‹xt
;

54 ; 
i
 !ğ
»dœeùiÚs
.
	`’d
(); ++i)

56 
‹xt
.
	`­³nd
("<ul>" + 
i
->
fœ¡
 + " =&gt; " + i->
£cÚd
 + "</ul>");

59 
»¥
->
	`£tBody
("<html><head><title>Myiny short url service</title></head>"

61 + 
‹xt
 +

62 "Now i " + 
now
 +

65 ià(
»q
.
	`·th
() == "/favicon.ico")

67 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k200Ok
);

68 
»¥
->
	`£tStusMes§ge
("OK");

69 
»¥
->
	`£tCÚ‹ÁTy³
("image/png");

70 
»¥
->
	`£tBody
(
	`¡ršg
(
çvicÚ
,  favicon));

74 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k404NÙFound
);

75 
»¥
->
	`£tStusMes§ge
("Not Found");

76 
»¥
->
	`£tClo£CÚÃùiÚ
(
Œue
);

78 
	}
}

80 
	$maš
(
¬gc
, * 
¬gv
[])

82 
»dœeùiÚs
["/1"] = "http://chenshuo.com";

83 
»dœeùiÚs
["/2"] = "http://blog.csdn.net/Solstice";

85 
numTh»ads
 = 0;

86 ià(
¬gc
 > 1)

88 
b’chm¬k
 = 
Œue
;

89 
Logg”
::
	`£tLogLev–
(Logg”::
WARN
);

90 
numTh»ads
 = 
	`©oi
(
¬gv
[1]);

93 #ifdeà
SO_REUSEPORT


94 
LOG_WARN
 << "SO_REUSEPORT";

95 
Ev’tLoİ
 
loİ
;

96 
Ev’tLoİTh»adPoŞ
 
	`th»adPoŞ
(&
loİ
, "shorturl");

97 ià(
numTh»ads
 > 1)

99 
th»adPoŞ
.
	`£tTh»adNum
(
numTh»ads
);

103 
numTh»ads
 = 1;

105 
th»adPoŞ
.
	`¡¬t
();

107 
boo¡
::
±r_veùÜ
<
H‰pS”v”
> 
£rv”s
;

108 
i
 = 0; i < 
numTh»ads
; ++i)

110 
£rv”s
.
	`push_back
(
Ãw
 
	`H‰pS”v”
(
th»adPoŞ
.
	`g‘NextLoİ
(),

111 
	`IÃtAdd»ss
(8000),

113 
TıS”v”
::
kReu£PÜt
));

114 
£rv”s
.
	`back
().
	`£tH‰pC®lback
(
ÚReque¡
);

115 
£rv”s
.
	`back
().
	`g‘Loİ
()->
	`runInLoİ
(

116 
boo¡
::
	`bšd
(&
H‰pS”v”
::
¡¬t
, &
£rv”s
.
	`back
()));

118 
loİ
.
	`loİ
();

120 
LOG_WARN
 << "Normal";

121 
Ev’tLoİ
 
loİ
;

122 
H‰pS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(8000), "shorturl");

123 
£rv”
.
	`£tH‰pC®lback
(
ÚReque¡
);

124 
£rv”
.
	`£tTh»adNum
(
numTh»ads
);

125 
£rv”
.
	`¡¬t
();

126 
loİ
.
	`loİ
();

128 
	}
}

130 
	gçvicÚ
[555] = {

	@examples/simple/allinone/allinone.cc

1 
	~"../ch¬g’/ch¬g’.h
"

2 
	~"../daytime/daytime.h
"

3 
	~"../disÿrd/disÿrd.h
"

4 
	~"../echo/echo.h
"

5 
	~"../time/time.h
"

7 
	~<muduo/ba£/Loggšg.h
>

8 
	~<muduo/Ãt/Ev’tLoİ.h
>

10 
	~<uni¡d.h
>

12 
usšg
 
Çme¥aû
 
	gmuduo
;

13 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

15 
	$maš
()

17 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

18 
Ev’tLoİ
 
loİ
;

20 
Ch¬g’S”v”
 
	`ch¬g’S”v”
(&
loİ
, 
	`IÃtAdd»ss
(2019));

21 
ch¬g’S”v”
.
	`¡¬t
();

23 
DaytimeS”v”
 
	`daytimeS”v”
(&
loİ
, 
	`IÃtAdd»ss
(2013));

24 
daytimeS”v”
.
	`¡¬t
();

26 
DisÿrdS”v”
 
	`disÿrdS”v”
(&
loİ
, 
	`IÃtAdd»ss
(2009));

27 
disÿrdS”v”
.
	`¡¬t
();

29 
EchoS”v”
 
	`echoS”v”
(&
loİ
, 
	`IÃtAdd»ss
(2007));

30 
echoS”v”
.
	`¡¬t
();

32 
TimeS”v”
 
	`timeS”v”
(&
loİ
, 
	`IÃtAdd»ss
(2037));

33 
timeS”v”
.
	`¡¬t
();

35 
loİ
.
	`loİ
();

36 
	}
}

	@examples/simple/chargen/chargen.cc

1 
	~"ch¬g’.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<¡dio.h
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

12 
	gCh¬g’S”v”
::
	$Ch¬g’S”v”
(
Ev’tLoİ
* 
loİ
,

13 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

14 
boŞ
 
´št
)

15 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "ChargenServer"),

16 
	`Œªsã¼ed_
(0),

17 
	`¡¬tTime_
(
Time¡amp
::
	$now
())

19 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

20 
boo¡
::
	`bšd
(&
Ch¬g’S”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

21 
£rv”_
.
	`£tMes§geC®lback
(

22 
boo¡
::
	`bšd
(&
Ch¬g’S”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

23 
£rv”_
.
	`£tWr™eCom¶‘eC®lback
(

24 
boo¡
::
	`bšd
(&
Ch¬g’S”v”
::
ÚWr™eCom¶‘e
, 
this
, 
_1
));

25 ià(
´št
)

27 
loİ
->
	`runEv”y
(3.0, 
boo¡
::
	`bšd
(&
Ch¬g’S”v”
::
´štThroughput
, 
this
));

30 
¡ršg
 
lše
;

31 
i
 = 33; i < 127; ++i)

33 
lše
.
	`push_back
((
i
));

35 
lše
 +=†ine;

37 
size_t
 
i
 = 0; i < 127-33; ++i)

39 
mes§ge_
 +ğ
lše
.
	`sub¡r
(
i
, 72) + '\n';

41 
	}
}

43 
	gCh¬g’S”v”
::
	$¡¬t
()

45 
£rv”_
.
	`¡¬t
();

46 
	}
}

48 
	gCh¬g’S”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

50 
LOG_INFO
 << "Ch¬g’S”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

51 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

52 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

53 ià(
cÚn
->
	`cÚÃùed
())

55 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

56 
cÚn
->
	`£nd
(
mes§ge_
);

58 
	}
}

60 
	gCh¬g’S”v”
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

61 
Bufãr
* 
buf
,

62 
Time¡amp
 
time
)

64 
¡ršg
 
	`msg
(
buf
->
	`»Œ›veAÎAsSŒšg
());

65 
LOG_INFO
 << 
cÚn
->
	`Çme
(è<< " disÿrd " << 
msg
.
	`size
()

66 << " by‹ »ûived‡ˆ" << 
time
.
	`toSŒšg
();

67 
	}
}

69 
	gCh¬g’S”v”
::
	$ÚWr™eCom¶‘e
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

71 
Œªsã¼ed_
 +ğ
mes§ge_
.
	`size
();

72 
cÚn
->
	`£nd
(
mes§ge_
);

73 
	}
}

75 
	gCh¬g’S”v”
::
	$´štThroughput
()

77 
Time¡amp
 
’dTime
 = Time¡amp::
	`now
();

78 
time
 = 
	`timeDifã»nû
(
’dTime
, 
¡¬tTime_
);

79 
	`´štf
("%4.3àMiB/s\n", 
¡©ic_ÿ¡
<>(
Œªsã¼ed_
)/
time
/1024/1024);

80 
Œªsã¼ed_
 = 0;

81 
¡¬tTime_
 = 
’dTime
;

82 
	}
}

	@examples/simple/chargen/chargen.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_CHARGEN_CHARGEN_H


2 
	#MUDUO_EXAMPLES_SIMPLE_CHARGEN_CHARGEN_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cCh¬g’S”v”


9 
	mpublic
:

10 
Ch¬g’S”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
,

12 
boŞ
 
´št
 = 
çl£
);

14 
¡¬t
();

16 
	m´iv©e
:

17 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

19 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

20 
muduo
::
Ãt
::
Bufãr
* 
buf
,

21 
muduo
::
Time¡amp
 
time
);

23 
ÚWr™eCom¶‘e
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

24 
´štThroughput
();

26 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

28 
	mmuduo
::
¡ršg
 
mes§ge_
;

29 
št64_t
 
	mŒªsã¼ed_
;

30 
	mmuduo
::
Time¡amp
 
¡¬tTime_
;

	@examples/simple/chargen/chargen.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_CHARGEN_CHARGEN_H


2 
	#MUDUO_EXAMPLES_SIMPLE_CHARGEN_CHARGEN_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cCh¬g’S”v”


9 
	mpublic
:

10 
Ch¬g’S”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
,

12 
boŞ
 
´št
 = 
çl£
);

14 
¡¬t
();

16 
	m´iv©e
:

17 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

19 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

20 
muduo
::
Ãt
::
Bufãr
* 
buf
,

21 
muduo
::
Time¡amp
 
time
);

23 
ÚWr™eCom¶‘e
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

24 
´štThroughput
();

26 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

28 
	mmuduo
::
¡ršg
 
mes§ge_
;

29 
št64_t
 
	mŒªsã¼ed_
;

30 
	mmuduo
::
Time¡amp
 
¡¬tTime_
;

	@examples/simple/chargen/main.cc

1 
	~"ch¬g’.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<uni¡d.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
	$maš
()

13 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

14 
Ev’tLoİ
 
loİ
;

15 
IÃtAdd»ss
 
	`li¡’Addr
(2019);

16 
Ch¬g’S”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
Œue
);

17 
£rv”
.
	`¡¬t
();

18 
loİ
.
	`loİ
();

19 
	}
}

	@examples/simple/chargenclient/chargenclient.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/IÃtAdd»ss.h
>

4 
	~<muduo/Ãt/TıCl›Á.h
>

6 
	~<boo¡/bšd.hµ
>

8 
	~<ut™y
>

10 
	~<¡dio.h
>

11 
	~<uni¡d.h
>

13 
usšg
 
Çme¥aû
 
	gmuduo
;

14 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

16 şas 
	cCh¬g’Cl›Á
 : 
boo¡
::
nÚcİyabË


18 
public
:

19 
	$Ch¬g’Cl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

20 : 
	`loİ_
(
loİ
),

21 
	`ş›Á_
(
loİ
, 
li¡’Addr
, "ChargenClient")

23 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

24 
boo¡
::
	`bšd
(&
Ch¬g’Cl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

25 
ş›Á_
.
	`£tMes§geC®lback
(

26 
boo¡
::
	`bšd
(&
Ch¬g’Cl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

30 
	$cÚÃù
()

32 
ş›Á_
.
	`cÚÃù
();

33 
	}
}

35 
	g´iv©e
:

36 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

38 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

39 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

40 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

42 ià(!
cÚn
->
	`cÚÃùed
())

43 
loİ_
->
	`qu™
();

44 
	}
}

46 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
»ûiveTime
)

48 
buf
->
	`»Œ›veAÎ
();

49 
	}
}

51 
Ev’tLoİ
* 
	gloİ_
;

52 
TıCl›Á
 
	gş›Á_
;

55 
	$maš
(
¬gc
, * 
¬gv
[])

57 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

58 ià(
¬gc
 > 1)

60 
Ev’tLoİ
 
loİ
;

61 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 2019);

63 
Ch¬g’Cl›Á
 
	`ch¬g’Cl›Á
(&
loİ
, 
£rv”Addr
);

64 
ch¬g’Cl›Á
.
	`cÚÃù
();

65 
loİ
.
	`loİ
();

69 
	`´štf
("U§ge: % ho¡_\n", 
¬gv
[0]);

71 
	}
}

	@examples/simple/daytime/daytime.cc

1 
	~"daytime.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<boo¡/bšd.hµ
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
	gDaytimeS”v”
::
	$DaytimeS”v”
(
Ev’tLoİ
* 
loİ
,

12 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

13 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "DaytimeServer")

15 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

16 
boo¡
::
	`bšd
(&
DaytimeS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

17 
£rv”_
.
	`£tMes§geC®lback
(

18 
boo¡
::
	`bšd
(&
DaytimeS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

19 
	}
}

21 
	gDaytimeS”v”
::
	$¡¬t
()

23 
£rv”_
.
	`¡¬t
();

24 
	}
}

26 
	gDaytimeS”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

28 
LOG_INFO
 << "DaytimeS”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

29 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

30 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

31 ià(
cÚn
->
	`cÚÃùed
())

33 
cÚn
->
	`£nd
(
Time¡amp
::
	`now
().
	`toFÜm©‹dSŒšg
() + "\n");

34 
cÚn
->
	`shutdown
();

36 
	}
}

38 
	gDaytimeS”v”
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

39 
Bufãr
* 
buf
,

40 
Time¡amp
 
time
)

42 
¡ršg
 
	`msg
(
buf
->
	`»Œ›veAÎAsSŒšg
());

43 
LOG_INFO
 << 
cÚn
->
	`Çme
(è<< " disÿrd " << 
msg
.
	`size
()

44 << " by‹ »ûived‡ˆ" << 
time
.
	`toSŒšg
();

45 
	}
}

	@examples/simple/daytime/daytime.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_DAYTIME_DAYTIME_H


2 
	#MUDUO_EXAMPLES_SIMPLE_DAYTIME_DAYTIME_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cDaytimeS”v”


9 
	mpublic
:

10 
DaytimeS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
);

13 
¡¬t
();

15 
	m´iv©e
:

16 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

18 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

19 
muduo
::
Ãt
::
Bufãr
* 
buf
,

20 
muduo
::
Time¡amp
 
time
);

22 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

	@examples/simple/daytime/daytime.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_DAYTIME_DAYTIME_H


2 
	#MUDUO_EXAMPLES_SIMPLE_DAYTIME_DAYTIME_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cDaytimeS”v”


9 
	mpublic
:

10 
DaytimeS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
);

13 
¡¬t
();

15 
	m´iv©e
:

16 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

18 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

19 
muduo
::
Ãt
::
Bufãr
* 
buf
,

20 
muduo
::
Time¡amp
 
time
);

22 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

	@examples/simple/daytime/main.cc

1 
	~"daytime.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<uni¡d.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
	$maš
()

13 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

14 
Ev’tLoİ
 
loİ
;

15 
IÃtAdd»ss
 
	`li¡’Addr
(2013);

16 
DaytimeS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

17 
£rv”
.
	`¡¬t
();

18 
loİ
.
	`loİ
();

19 
	}
}

	@examples/simple/discard/discard.cc

1 
	~"disÿrd.h
"

3 
	~<muduo/ba£/Loggšg.h
>

5 
	~<boo¡/bšd.hµ
>

7 
usšg
 
Çme¥aû
 
	gmuduo
;

8 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

10 
	gDisÿrdS”v”
::
	$DisÿrdS”v”
(
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

12 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "DiscardServer")

14 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

15 
boo¡
::
	`bšd
(&
DisÿrdS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

16 
£rv”_
.
	`£tMes§geC®lback
(

17 
boo¡
::
	`bšd
(&
DisÿrdS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

18 
	}
}

20 
	gDisÿrdS”v”
::
	$¡¬t
()

22 
£rv”_
.
	`¡¬t
();

23 
	}
}

25 
	gDisÿrdS”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

27 
LOG_INFO
 << "DisÿrdS”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

28 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

29 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

30 
	}
}

32 
	gDisÿrdS”v”
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

33 
Bufãr
* 
buf
,

34 
Time¡amp
 
time
)

36 
¡ršg
 
	`msg
(
buf
->
	`»Œ›veAÎAsSŒšg
());

37 
LOG_INFO
 << 
cÚn
->
	`Çme
(è<< " disÿrd " << 
msg
.
	`size
()

38 << " by‹ »ûived‡ˆ" << 
time
.
	`toSŒšg
();

39 
	}
}

	@examples/simple/discard/discard.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_DISCARD_DISCARD_H


2 
	#MUDUO_EXAMPLES_SIMPLE_DISCARD_DISCARD_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cDisÿrdS”v”


9 
	mpublic
:

10 
DisÿrdS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
);

13 
¡¬t
();

15 
	m´iv©e
:

16 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

18 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

19 
muduo
::
Ãt
::
Bufãr
* 
buf
,

20 
muduo
::
Time¡amp
 
time
);

22 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

	@examples/simple/discard/discard.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_DISCARD_DISCARD_H


2 
	#MUDUO_EXAMPLES_SIMPLE_DISCARD_DISCARD_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cDisÿrdS”v”


9 
	mpublic
:

10 
DisÿrdS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
);

13 
¡¬t
();

15 
	m´iv©e
:

16 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

18 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

19 
muduo
::
Ãt
::
Bufãr
* 
buf
,

20 
muduo
::
Time¡amp
 
time
);

22 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

	@examples/simple/discard/main.cc

1 
	~"disÿrd.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<uni¡d.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
	$maš
()

13 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

14 
Ev’tLoİ
 
loİ
;

15 
IÃtAdd»ss
 
	`li¡’Addr
(2009);

16 
DisÿrdS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

17 
£rv”
.
	`¡¬t
();

18 
loİ
.
	`loİ
();

19 
	}
}

	@examples/simple/echo/echo.cc

1 
	~"echo.h
"

3 
	~<muduo/ba£/Loggšg.h
>

5 
	~<boo¡/bšd.hµ
>

10 
	gEchoS”v”
::
EchoS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
)

12 : 
£rv”_
(
loİ
, 
li¡’Addr
, "EchoServer")

14 
	g£rv”_
.
£tCÚÃùiÚC®lback
(

15 
boo¡
::
bšd
(&
EchoS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

16 
	g£rv”_
.
£tMes§geC®lback
(

17 
boo¡
::
bšd
(&
EchoS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

20 
	gEchoS”v”
::
	$¡¬t
()

22 
£rv”_
.
	`¡¬t
();

23 
	}
}

25 
	gEchoS”v”
::
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

27 
LOG_INFO
 << "EchoS”v” - " << 
cÚn
->
³”Add»ss
().
toIpPÜt
() << " -> "

28 << 
cÚn
->
loÿlAdd»ss
().
toIpPÜt
() << " is "

29 << (
cÚn
->
cÚÃùed
() ? "UP" : "DOWN");

32 
	gEchoS”v”
::
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

33 
muduo
::
Ãt
::
Bufãr
* 
buf
,

34 
muduo
::
Time¡amp
 
time
)

36 
muduo
::
¡ršg
 
msg
(
buf
->
»Œ›veAÎAsSŒšg
());

37 
	gLOG_INFO
 << 
	gcÚn
->
Çme
(è<< "ƒchØ" << 
	gmsg
.
size
() << " bytes, "

38 << "d©¨»ûived‡ˆ" << 
	gtime
.
toSŒšg
();

39 
	gcÚn
->
£nd
(
msg
);

	@examples/simple/echo/echo.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H


2 
	#MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cEchoS”v”


9 
	mpublic
:

10 
EchoS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
);

13 
¡¬t
();

15 
	m´iv©e
:

16 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

18 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

19 
muduo
::
Ãt
::
Bufãr
* 
buf
,

20 
muduo
::
Time¡amp
 
time
);

22 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

	@examples/simple/echo/echo.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H


2 
	#MUDUO_EXAMPLES_SIMPLE_ECHO_ECHO_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cEchoS”v”


9 
	mpublic
:

10 
EchoS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
);

13 
¡¬t
();

15 
	m´iv©e
:

16 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

18 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

19 
muduo
::
Ãt
::
Bufãr
* 
buf
,

20 
muduo
::
Time¡amp
 
time
);

22 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

	@examples/simple/echo/main.cc

1 
	~"echo.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<uni¡d.h
>

11 
	$maš
()

13 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

14 
muduo
::
Ãt
::
Ev’tLoİ
 
loİ
;

15 
muduo
::
Ãt
::
IÃtAdd»ss
 
	`li¡’Addr
(2007);

16 
EchoS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

17 
£rv”
.
	`¡¬t
();

18 
loİ
.
	`loİ
();

19 
	}
}

	@examples/simple/time/main.cc

1 
	~"time.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<uni¡d.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
	$maš
()

13 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

14 
Ev’tLoİ
 
loİ
;

15 
IÃtAdd»ss
 
	`li¡’Addr
(2037);

16 
TimeS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

17 
£rv”
.
	`¡¬t
();

18 
loİ
.
	`loİ
();

19 
	}
}

	@examples/simple/time/time.cc

1 
	~"time.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/EndŸn.h
>

6 
	~<boo¡/bšd.hµ
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
	gTimeS”v”
::
TimeS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

12 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
)

13 : 
£rv”_
(
loİ
, 
li¡’Addr
, "TimeServer")

15 
	g£rv”_
.
£tCÚÃùiÚC®lback
(

16 
boo¡
::
bšd
(&
TimeS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

17 
	g£rv”_
.
£tMes§geC®lback
(

18 
boo¡
::
bšd
(&
TimeS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

21 
	gTimeS”v”
::
	$¡¬t
()

23 
£rv”_
.
	`¡¬t
();

24 
	}
}

26 
	gTimeS”v”
::
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

28 
LOG_INFO
 << "TimeS”v” - " << 
cÚn
->
³”Add»ss
().
toIpPÜt
() << " -> "

29 << 
cÚn
->
loÿlAdd»ss
().
toIpPÜt
() << " is "

30 << (
cÚn
->
cÚÃùed
() ? "UP" : "DOWN");

31 ià(
	gcÚn
->
cÚÃùed
())

33 
time_t
 
	gnow
 = ::
time
(
NULL
);

34 
št32_t
 
	gbe32
 = 
sock‘s
::
ho¡ToN‘wÜk32
(
¡©ic_ÿ¡
<št32_t>(
now
));

35 
	gcÚn
->
£nd
(&
be32
,  be32);

36 
	gcÚn
->
shutdown
();

40 
	gTimeS”v”
::
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

41 
muduo
::
Ãt
::
Bufãr
* 
buf
,

42 
muduo
::
Time¡amp
 
time
)

44 
¡ršg
 
msg
(
buf
->
»Œ›veAÎAsSŒšg
());

45 
	gLOG_INFO
 << 
	gcÚn
->
Çme
(è<< " disÿrd " << 
	gmsg
.
size
()

46 << " by‹ »ûived‡ˆ" << 
	gtime
.
toSŒšg
();

	@examples/simple/time/time.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_TIME_TIME_H


2 
	#MUDUO_EXAMPLES_SIMPLE_TIME_TIME_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cTimeS”v”


9 
	mpublic
:

10 
TimeS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
);

13 
¡¬t
();

15 
	m´iv©e
:

16 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

18 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

19 
muduo
::
Ãt
::
Bufãr
* 
buf
,

20 
muduo
::
Time¡amp
 
time
);

22 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

	@examples/simple/time/time.h

1 #iâdeà
MUDUO_EXAMPLES_SIMPLE_TIME_TIME_H


2 
	#MUDUO_EXAMPLES_SIMPLE_TIME_TIME_H


	)

4 
	~<muduo/Ãt/TıS”v”.h
>

7 şas 
	cTimeS”v”


9 
	mpublic
:

10 
TimeS”v”
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

11 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
li¡’Addr
);

13 
¡¬t
();

15 
	m´iv©e
:

16 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
);

18 
ÚMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

19 
muduo
::
Ãt
::
Bufãr
* 
buf
,

20 
muduo
::
Time¡amp
 
time
);

22 
	mmuduo
::
Ãt
::
TıS”v”
 
£rv”_
;

	@examples/simple/timeclient/timeclient.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/EndŸn.h
>

3 
	~<muduo/Ãt/Ev’tLoİ.h
>

4 
	~<muduo/Ãt/IÃtAdd»ss.h
>

5 
	~<muduo/Ãt/TıCl›Á.h
>

7 
	~<boo¡/bšd.hµ
>

9 
	~<ut™y
>

11 
	~<¡dio.h
>

12 
	~<uni¡d.h
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 şas 
	cTimeCl›Á
 : 
boo¡
::
nÚcİyabË


19 
public
:

20 
	$TimeCl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
)

21 : 
	`loİ_
(
loİ
),

22 
	`ş›Á_
(
loİ
, 
£rv”Addr
, "TimeClient")

24 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

25 
boo¡
::
	`bšd
(&
TimeCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

26 
ş›Á_
.
	`£tMes§geC®lback
(

27 
boo¡
::
	`bšd
(&
TimeCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

31 
	$cÚÃù
()

33 
ş›Á_
.
	`cÚÃù
();

34 
	}
}

36 
	g´iv©e
:

38 
Ev’tLoİ
* 
loİ_
;

39 
TıCl›Á
 
	gş›Á_
;

41 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

43 
LOG_INFO
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

44 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

45 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

47 ià(!
cÚn
->
	`cÚÃùed
())

49 
loİ_
->
	`qu™
();

51 
	}
}

53 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
»ûiveTime
)

55 ià(
buf
->
	`»adabËBy‹s
(è>ğ(
št32_t
))

57 cÚ¡ * 
d©a
 = 
buf
->
	`³ek
();

58 
št32_t
 
be32
 = *
¡©ic_ÿ¡
<cÚ¡ iÁ32_t*>(
d©a
);

59 
buf
->
	`»Œ›ve
((
št32_t
));

60 
time_t
 
time
 = 
sock‘s
::
	`ÃtwÜkToHo¡32
(
be32
);

61 
Time¡amp
 
	`ts
(
im¶ic™_ÿ¡
<
ušt64_t
>(
time
è* Time¡amp::
kMiüoSecÚdsP”SecÚd
);

62 
LOG_INFO
 << "S”v”imğ" << 
time
 << ", " << 
ts
.
	`toFÜm©‹dSŒšg
();

66 
LOG_INFO
 << 
cÚn
->
	`Çme
(è<< "‚Ø’ough d©¨" << 
buf
->
	`»adabËBy‹s
()

67 << "‡ˆ" << 
»ûiveTime
.
	`toFÜm©‹dSŒšg
();

69 
	}
}

72 
	$maš
(
¬gc
, * 
¬gv
[])

74 
LOG_INFO
 << "pid = " << 
	`g‘pid
();

75 ià(
¬gc
 > 1)

77 
Ev’tLoİ
 
loİ
;

78 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 2037);

80 
TimeCl›Á
 
	`timeCl›Á
(&
loİ
, 
£rv”Addr
);

81 
timeCl›Á
.
	`cÚÃù
();

82 
loİ
.
	`loİ
();

86 
	`´štf
("U§ge: % ho¡_\n", 
¬gv
[0]);

88 
	}
}

	@examples/socks4a/balancer.cc

1 
	~"tuÂ–.h
"

3 
	~<muduo/ba£/Th»adLoÿl.h
>

4 
	~<¡dio.h
>

6 
usšg
 
Çme¥aû
 
	gmuduo
;

7 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

9 
	g¡d
::
veùÜ
<
IÃtAdd»ss
> 
g_back’ds
;

10 
	gTh»adLoÿl
<
	g¡d
::
m­
<
¡ršg
, 
	gTuÂ–PŒ
> > 
	gt_tuÂ–s
;

11 
Mu‹xLock
 
	gg_mu‹x
;

12 
size_t
 
	gg_cu¼’t
 = 0;

14 
	$ÚS”v”CÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

16 
LOG_DEBUG
 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

17 
¡d
::
m­
<
¡ršg
, 
TuÂ–PŒ
>& 
tuÂ–s
 = 
t_tuÂ–s
.
	`v®ue
();

18 ià(
cÚn
->
	`cÚÃùed
())

20 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

21 
cÚn
->
	`¡İR—d
();

22 
size_t
 
cu¼’t
 = 0;

24 
Mu‹xLockGu¬d
 
	`gu¬d
(
g_mu‹x
);

25 
cu¼’t
 = 
g_cu¼’t
;

26 
g_cu¼’t
 = (g_cu¼’t+1è% 
g_back’ds
.
	`size
();

29 
IÃtAdd»ss
 
back’d
 = 
g_back’ds
[
cu¼’t
];

30 
TuÂ–PŒ
 
	`tuÂ–
(
Ãw
 
	`TuÂ–
(
cÚn
->
	`g‘Loİ
(), 
back’d
, conn));

31 
tuÂ–
->
	`£tup
();

32 
tuÂ–
->
	`cÚÃù
();

34 
tuÂ–s
[
cÚn
->
	`Çme
()] = 
tuÂ–
;

38 
	`as£¹
(
tuÂ–s
.
	`fšd
(
cÚn
->
	`Çme
()è!ğtuÂ–s.
	`’d
());

39 
tuÂ–s
[
cÚn
->
	`Çme
()]->
	`discÚÃù
();

40 
tuÂ–s
.
	`”a£
(
cÚn
->
	`Çme
());

42 
	}
}

44 
	$ÚS”v”Mes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

46 ià(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
())

48 cÚ¡ 
TıCÚÃùiÚPŒ
& 
ş›ÁCÚn


49 ğ
boo¡
::
ªy_ÿ¡
<cÚ¡ 
TıCÚÃùiÚPŒ
&>(
cÚn
->
	`g‘CÚ‹xt
());

50 
ş›ÁCÚn
->
	`£nd
(
buf
);

52 
	}
}

54 
	$maš
(
¬gc
, * 
¬gv
[])

56 ià(
¬gc
 < 3)

58 
	`årštf
(
¡d”r
, "U§ge: % li¡’_pÜˆback’d_:pÜˆ[back’d_:pÜt]\n", 
¬gv
[0]);

62 
i
 = 2; i < 
¬gc
; ++i)

64 
¡ršg
 
ho¡pÜt
 = 
¬gv
[
i
];

65 
size_t
 
cŞÚ
 = 
ho¡pÜt
.
	`fšd
(':');

66 ià(
cŞÚ
 !ğ
¡ršg
::
Åos
)

68 
¡ršg
 

 = 
ho¡pÜt
.
	`sub¡r
(0, 
cŞÚ
);

69 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
ho¡pÜt
.
	`c_¡r
()+
cŞÚ
+1));

70 
g_back’ds
.
	`push_back
(
	`IÃtAdd»ss
(

, 
pÜt
));

74 
	`årštf
(
¡d”r
, "šv®id back’d‡dd»s %s\n", 
¬gv
[
i
]);

79 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

80 
IÃtAdd»ss
 
	`li¡’Addr
(
pÜt
);

82 
Ev’tLoİ
 
loİ
;

83 
TıS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, "TcpBalancer");

84 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚS”v”CÚÃùiÚ
);

85 
£rv”
.
	`£tMes§geC®lback
(
ÚS”v”Mes§ge
);

86 
£rv”
.
	`£tTh»adNum
(4);

87 
£rv”
.
	`¡¬t
();

88 
loİ
.
	`loİ
();

90 
	}
}

	@examples/socks4a/socks4a.cc

1 
	~"tuÂ–.h
"

3 
	~<muduo/Ãt/EndŸn.h
>

4 
	~<¡dio.h
>

5 
	~<Ãtdb.h
>

6 
	~<uni¡d.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
Ev’tLoİ
* 
	gg_ev’tLoİ
;

12 
	g¡d
::
m­
<
¡ršg
, 
	gTuÂ–PŒ
> 
	gg_tuÂ–s
;

14 
	$ÚS”v”CÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

16 
LOG_DEBUG
 << 
cÚn
->
	`Çme
(è<< (cÚn->
	`cÚÃùed
() ? " UP" : " DOWN");

17 ià(
cÚn
->
	`cÚÃùed
())

19 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

23 
¡d
::
m­
<
¡ršg
, 
TuÂ–PŒ
>::
™”©Ü
 
™
 = 
g_tuÂ–s
.
	`fšd
(
cÚn
->
	`Çme
());

24 ià(
™
 !ğ
g_tuÂ–s
.
	`’d
())

26 
™
->
£cÚd
->
	`discÚÃù
();

27 
g_tuÂ–s
.
	`”a£
(
™
);

30 
	}
}

32 
	$ÚS”v”Mes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

34 
LOG_DEBUG
 << 
cÚn
->
	`Çme
(è<< " " << 
buf
->
	`»adabËBy‹s
();

35 ià(
g_tuÂ–s
.
	`fšd
(
cÚn
->
	`Çme
()è=ğg_tuÂ–s.
	`’d
())

37 ià(
buf
->
	`»adabËBy‹s
() > 128)

39 
cÚn
->
	`shutdown
();

41 ià(
buf
->
	`»adabËBy‹s
() > 8)

43 cÚ¡ * 
begš
 = 
buf
->
	`³ek
() + 8;

44 cÚ¡ * 
’d
 = 
buf
->
	`³ek
(è+ buf->
	`»adabËBy‹s
();

45 cÚ¡ * 
wh”e
 = 
¡d
::
	`fšd
(
begš
, 
’d
, '\0');

46 ià(
wh”e
 !ğ
’d
)

48 
v”
 = 
buf
->
	`³ek
()[0];

49 
cmd
 = 
buf
->
	`³ek
()[1];

50 cÚ¡ * 
pÜt
 = 
buf
->
	`³ek
() + 2;

51 cÚ¡ * 

 = 
buf
->
	`³ek
() + 4;

53 
sockaddr_š
 
addr
;

54 
	`bz”o
(&
addr
, ‡ddr);

55 
addr
.
sš_çmy
 = 
AF_INET
;

56 
addr
.
sš_pÜt
 = *
¡©ic_ÿ¡
<cÚ¡ 
š_pÜt_t
*>(
pÜt
);

57 
addr
.
sš_addr
.
s_addr
 = *
¡©ic_ÿ¡
<cÚ¡ 
ušt32_t
*>(

);

59 
boŞ
 
socks4a
 = 
sock‘s
::
	`ÃtwÜkToHo¡32
(
addr
.
sš_addr
.
s_addr
) < 256;

60 
boŞ
 
okay
 = 
çl£
;

61 ià(
socks4a
)

63 cÚ¡ * 
’dOfHo¡Name
 = 
¡d
::
	`fšd
(
wh”e
+1, 
’d
, '\0');

64 ià(
’dOfHo¡Name
 !ğ
’d
)

66 
¡ršg
 
ho¡Çme
 = 
wh”e
+1;

67 
wh”e
 = 
’dOfHo¡Name
;

68 
LOG_INFO
 << "Socks4¨ho¡‚am" << 
ho¡Çme
;

69 
IÃtAdd»ss
 
tmp
;

70 ià(
IÃtAdd»ss
::
	`»sŞve
(
ho¡Çme
, &
tmp
))

72 
addr
.
sš_addr
.
s_addr
 = 
tmp
.
	`N‘EndŸn
();

73 
okay
 = 
Œue
;

83 
okay
 = 
Œue
;

86 
IÃtAdd»ss
 
	`£rv”Addr
(
addr
);

87 ià(
v”
 =ğ4 && 
cmd
 =ğ1 && 
okay
)

89 
TuÂ–PŒ
 
	`tuÂ–
(
Ãw
 
	`TuÂ–
(
g_ev’tLoİ
, 
£rv”Addr
, 
cÚn
));

90 
tuÂ–
->
	`£tup
();

91 
tuÂ–
->
	`cÚÃù
();

92 
g_tuÂ–s
[
cÚn
->
	`Çme
()] = 
tuÂ–
;

93 
buf
->
	`»Œ›veUÁ
(
wh”e
+1);

94 
»¥Ú£
[] = "\000\x5aUVWXYZ";

95 
	`memıy
(
»¥Ú£
+2, &
addr
.
sš_pÜt
, 2);

96 
	`memıy
(
»¥Ú£
+4, &
addr
.
sš_addr
.
s_addr
, 4);

97 
cÚn
->
	`£nd
(
»¥Ú£
, 8);

101 
»¥Ú£
[] = "\000\x5bUVWXYZ";

102 
cÚn
->
	`£nd
(
»¥Ú£
, 8);

103 
cÚn
->
	`shutdown
();

108 ià(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
())

110 cÚ¡ 
TıCÚÃùiÚPŒ
& 
ş›ÁCÚn


111 ğ
boo¡
::
ªy_ÿ¡
<cÚ¡ 
TıCÚÃùiÚPŒ
&>(
cÚn
->
	`g‘CÚ‹xt
());

112 
ş›ÁCÚn
->
	`£nd
(
buf
);

114 
	}
}

116 
	$maš
(
¬gc
, * 
¬gv
[])

118 ià(
¬gc
 < 2)

120 
	`årštf
(
¡d”r
, "U§ge: % <li¡’_pÜt>\n", 
¬gv
[0]);

124 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

126 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

127 
IÃtAdd»ss
 
	`li¡’Addr
(
pÜt
);

129 
Ev’tLoİ
 
loİ
;

130 
g_ev’tLoİ
 = &
loİ
;

132 
TıS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, "Socks4");

134 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚS”v”CÚÃùiÚ
);

135 
£rv”
.
	`£tMes§geC®lback
(
ÚS”v”Mes§ge
);

137 
£rv”
.
	`¡¬t
();

139 
loİ
.
	`loİ
();

141 
	}
}

	@examples/socks4a/tcprelay.cc

1 
	~"tuÂ–.h
"

3 
	~<m®loc.h
>

4 
	~<¡dio.h
>

5 
	~<sys/»sourû.h
>

6 
	~<uni¡d.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

11 
Ev’tLoİ
* 
	gg_ev’tLoİ
;

12 
IÃtAdd»ss
* 
	gg_£rv”Addr
;

13 
	g¡d
::
m­
<
¡ršg
, 
	gTuÂ–PŒ
> 
	gg_tuÂ–s
;

15 
	$ÚS”v”CÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

17 
LOG_DEBUG
 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

18 ià(
cÚn
->
	`cÚÃùed
())

20 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

21 
cÚn
->
	`¡İR—d
();

22 
TuÂ–PŒ
 
	`tuÂ–
(
Ãw
 
	`TuÂ–
(
g_ev’tLoİ
, *
g_£rv”Addr
, 
cÚn
));

23 
tuÂ–
->
	`£tup
();

24 
tuÂ–
->
	`cÚÃù
();

25 
g_tuÂ–s
[
cÚn
->
	`Çme
()] = 
tuÂ–
;

29 
	`as£¹
(
g_tuÂ–s
.
	`fšd
(
cÚn
->
	`Çme
()è!ğg_tuÂ–s.
	`’d
());

30 
g_tuÂ–s
[
cÚn
->
	`Çme
()]->
	`discÚÃù
();

31 
g_tuÂ–s
.
	`”a£
(
cÚn
->
	`Çme
());

33 
	}
}

35 
	$ÚS”v”Mes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

37 
LOG_DEBUG
 << 
buf
->
	`»adabËBy‹s
();

38 ià(!
cÚn
->
	`g‘CÚ‹xt
().
	`em±y
())

40 cÚ¡ 
TıCÚÃùiÚPŒ
& 
ş›ÁCÚn


41 ğ
boo¡
::
ªy_ÿ¡
<cÚ¡ 
TıCÚÃùiÚPŒ
&>(
cÚn
->
	`g‘CÚ‹xt
());

42 
ş›ÁCÚn
->
	`£nd
(
buf
);

44 
	}
}

46 
	$mem¡©
()

48 
	`m®loc_¡©s
();

49 
	}
}

51 
	$maš
(
¬gc
, * 
¬gv
[])

53 ià(
¬gc
 < 4)

55 
	`årštf
(
¡d”r
, "U§ge: % <ho¡_> <pÜt> <li¡’_pÜt>\n", 
¬gv
[0]);

59 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

62 
size_t
 
kOÃMB
 = 1024*1024;

63 
¾im™
 
¾
 = { 256*
kOÃMB
, 256*kOneMB };

64 
	`£Œlim™
(
RLIMIT_AS
, &
¾
);

66 cÚ¡ * 

 = 
¬gv
[1];

67 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

68 
IÃtAdd»ss
 
	`£rv”Addr
(

, 
pÜt
);

69 
g_£rv”Addr
 = &
£rv”Addr
;

71 
ušt16_t
 
acû±PÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[3]));

72 
IÃtAdd»ss
 
	`li¡’Addr
(
acû±PÜt
);

74 
Ev’tLoİ
 
loİ
;

75 
g_ev’tLoİ
 = &
loİ
;

76 
loİ
.
	`runEv”y
(3, 
mem¡©
);

78 
TıS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, "TcpRelay");

80 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚS”v”CÚÃùiÚ
);

81 
£rv”
.
	`£tMes§geC®lback
(
ÚS”v”Mes§ge
);

83 
£rv”
.
	`¡¬t
();

85 
loİ
.
	`loİ
();

87 
	}
}

	@examples/socks4a/tunnel.h

1 #iâdeà
MUDUO_EXAMPLES_SOCKS4A_TUNNEL_H


2 
	#MUDUO_EXAMPLES_SOCKS4A_TUNNEL_H


	)

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

7 
	~<muduo/Ãt/TıCl›Á.h
>

8 
	~<muduo/Ãt/TıS”v”.h
>

10 
	~<boo¡/bšd.hµ
>

11 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

13 
şass
 
	gTuÂ–
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<
TuÂ–
>,

14 
	gboo¡
::
nÚcİyabË


16 
public
:

17 
TuÂ–
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

18 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
£rv”Addr
,

19 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
£rv”CÚn
)

20 : 
ş›Á_
(
loİ
, 
£rv”Addr
, 
£rv”CÚn
->
Çme
()),

21 
£rv”CÚn_
(
£rv”CÚn
)

23 
	gLOG_INFO
 << "TuÂ– " << 
	g£rv”CÚn
->
³”Add»ss
().
toIpPÜt
()

24 << " <-> " << 
	g£rv”Addr
.
toIpPÜt
();

27 ~
TuÂ–
()

29 
	gLOG_INFO
 << "~Tunnel";

32 
£tup
()

34 
	gş›Á_
.
£tCÚÃùiÚC®lback
(

35 
boo¡
::
bšd
(&
TuÂ–
::
ÚCl›ÁCÚÃùiÚ
, 
sh¬ed_äom_this
(), 
_1
));

36 
	gş›Á_
.
£tMes§geC®lback
(

37 
boo¡
::
bšd
(&
TuÂ–
::
ÚCl›ÁMes§ge
, 
sh¬ed_äom_this
(), 
_1
, 
_2
, 
_3
));

38 
	g£rv”CÚn_
->
£tHighW©”M¬kC®lback
(

39 
boo¡
::
bšd
(&
TuÂ–
::
ÚHighW©”M¬kW—k
,

40 
boo¡
::
w—k_±r
<
TuÂ–
>(
sh¬ed_äom_this
()), 
kS”v”
, 
_1
, 
_2
),

44 
cÚÃù
()

46 
	gş›Á_
.
cÚÃù
();

49 
discÚÃù
()

51 
	gş›Á_
.
discÚÃù
();

55 
	g´iv©e
:

56 
‹¬down
()

58 
ş›Á_
.
£tCÚÃùiÚC®lback
(
muduo
::
Ãt
::
deçuÉCÚÃùiÚC®lback
);

59 
	gş›Á_
.
£tMes§geC®lback
(
muduo
::
Ãt
::
deçuÉMes§geC®lback
);

60 ià(
	g£rv”CÚn_
)

62 
	g£rv”CÚn_
->
£tCÚ‹xt
(
boo¡
::
ªy
());

63 
	g£rv”CÚn_
->
shutdown
();

65 
	gş›ÁCÚn_
.
»£t
();

68 
ÚCl›ÁCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

70 
LOG_DEBUG
 << (
cÚn
->
cÚÃùed
() ? "UP" : "DOWN");

71 ià(
	gcÚn
->
cÚÃùed
())

73 
	gcÚn
->
£tTıNoD–ay
(
Œue
);

74 
	gcÚn
->
£tHighW©”M¬kC®lback
(

75 
boo¡
::
bšd
(&
TuÂ–
::
ÚHighW©”M¬kW—k
,

76 
boo¡
::
w—k_±r
<
TuÂ–
>(
sh¬ed_äom_this
()), 
kCl›Á
, 
_1
, 
_2
),

78 
	g£rv”CÚn_
->
£tCÚ‹xt
(
cÚn
);

79 
	g£rv”CÚn_
->
¡¬tR—d
();

80 
	gş›ÁCÚn_
 = 
cÚn
;

81 ià(
	g£rv”CÚn_
->
šputBufãr
()->
»adabËBy‹s
() > 0)

83 
	gcÚn
->
£nd
(
£rv”CÚn_
->
šputBufãr
());

88 
‹¬down
();

92 
ÚCl›ÁMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

93 
muduo
::
Ãt
::
Bufãr
* 
buf
,

94 
muduo
::
Time¡amp
)

96 
LOG_DEBUG
 << 
cÚn
->
Çme
(è<< " " << 
buf
->
»adabËBy‹s
();

97 ià(
	g£rv”CÚn_
)

99 
	g£rv”CÚn_
->
£nd
(
buf
);

103 
	gbuf
->
»Œ›veAÎ
();

104 
abÜt
();

108 
	eS”v”Cl›Á


110 
	gkS”v”
, 
	gkCl›Á


113 
ÚHighW©”M¬k
(
S”v”Cl›Á
 
which
,

114 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

115 
size_t
 
by‹sToS’t
)

117 
	gLOG_INFO
 << (
	gwhich
 =ğ
kS”v”
 ? "server" : "client")

118 << " onHighW©”M¬k " << 
cÚn
->
Çme
()

119 << " by‹ " << 
by‹sToS’t
;

121 ià(
	gwhich
 =ğ
kS”v”
)

123 ià(
£rv”CÚn_
->
ouutBufãr
()->
»adabËBy‹s
() > 0)

125 
ş›ÁCÚn_
->
¡İR—d
();

126 
	g£rv”CÚn_
->
£tWr™eCom¶‘eC®lback
(

127 
boo¡
::
bšd
(&
TuÂ–
::
ÚWr™eCom¶‘eW—k
,

128 
boo¡
::
w—k_±r
<
TuÂ–
>(
sh¬ed_äom_this
()), 
kS”v”
, 
_1
));

133 ià(
	gş›ÁCÚn_
->
ouutBufãr
()->
»adabËBy‹s
() > 0)

135 
	g£rv”CÚn_
->
¡İR—d
();

136 
	gş›ÁCÚn_
->
£tWr™eCom¶‘eC®lback
(

137 
boo¡
::
bšd
(&
TuÂ–
::
ÚWr™eCom¶‘eW—k
,

138 
boo¡
::
w—k_±r
<
TuÂ–
>(
sh¬ed_äom_this
()), 
kCl›Á
, 
_1
));

143 
ÚHighW©”M¬kW—k
(cÚ¡ 
boo¡
::
w—k_±r
<
TuÂ–
>& 
wkTuÂ–
,

144 
S”v”Cl›Á
 
which
,

145 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

146 
size_t
 
by‹sToS’t
)

148 
	gboo¡
::
sh¬ed_±r
<
TuÂ–
> 
tuÂ–
 = 
wkTuÂ–
.
lock
();

149 ià(
	gtuÂ–
)

151 
	gtuÂ–
->
ÚHighW©”M¬k
(
which
, 
cÚn
, 
by‹sToS’t
);

155 
ÚWr™eCom¶‘e
(
S”v”Cl›Á
 
which
, cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

157 
LOG_INFO
 << (
which
 =ğ
kS”v”
 ? "server" : "client")

158 << " onWr™eCom¶‘" << 
cÚn
->
Çme
();

159 ià(
	gwhich
 =ğ
kS”v”
)

161 
ş›ÁCÚn_
->
¡¬tR—d
();

162 
	g£rv”CÚn_
->
£tWr™eCom¶‘eC®lback
(
muduo
::
Ãt
::
Wr™eCom¶‘eC®lback
());

166 
	g£rv”CÚn_
->
¡¬tR—d
();

167 
	gş›ÁCÚn_
->
£tWr™eCom¶‘eC®lback
(
muduo
::
Ãt
::
Wr™eCom¶‘eC®lback
());

171 
ÚWr™eCom¶‘eW—k
(cÚ¡ 
boo¡
::
w—k_±r
<
TuÂ–
>& 
wkTuÂ–
,

172 
S”v”Cl›Á
 
which
,

173 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

175 
boo¡
::
sh¬ed_±r
<
TuÂ–
> 
tuÂ–
 = 
wkTuÂ–
.
lock
();

176 ià(
	gtuÂ–
)

178 
	gtuÂ–
->
ÚWr™eCom¶‘e
(
which
, 
cÚn
);

182 
	g´iv©e
:

183 
muduo
::
Ãt
::
TıCl›Á
 
ş›Á_
;

184 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
£rv”CÚn_
;

185 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
ş›ÁCÚn_
;

187 
	gboo¡
::
	tsh¬ed_±r
<
	tTuÂ–
> 
	tTuÂ–PŒ
;

	@examples/socks4a/tunnel.h

1 #iâdeà
MUDUO_EXAMPLES_SOCKS4A_TUNNEL_H


2 
	#MUDUO_EXAMPLES_SOCKS4A_TUNNEL_H


	)

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

7 
	~<muduo/Ãt/TıCl›Á.h
>

8 
	~<muduo/Ãt/TıS”v”.h
>

10 
	~<boo¡/bšd.hµ
>

11 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

13 
şass
 
	gTuÂ–
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<
TuÂ–
>,

14 
	gboo¡
::
nÚcİyabË


16 
public
:

17 
TuÂ–
(
muduo
::
Ãt
::
Ev’tLoİ
* 
loİ
,

18 cÚ¡ 
muduo
::
Ãt
::
IÃtAdd»ss
& 
£rv”Addr
,

19 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
£rv”CÚn
)

20 : 
ş›Á_
(
loİ
, 
£rv”Addr
, 
£rv”CÚn
->
Çme
()),

21 
£rv”CÚn_
(
£rv”CÚn
)

23 
	gLOG_INFO
 << "TuÂ– " << 
	g£rv”CÚn
->
³”Add»ss
().
toIpPÜt
()

24 << " <-> " << 
	g£rv”Addr
.
toIpPÜt
();

27 ~
TuÂ–
()

29 
	gLOG_INFO
 << "~Tunnel";

32 
£tup
()

34 
	gş›Á_
.
£tCÚÃùiÚC®lback
(

35 
boo¡
::
bšd
(&
TuÂ–
::
ÚCl›ÁCÚÃùiÚ
, 
sh¬ed_äom_this
(), 
_1
));

36 
	gş›Á_
.
£tMes§geC®lback
(

37 
boo¡
::
bšd
(&
TuÂ–
::
ÚCl›ÁMes§ge
, 
sh¬ed_äom_this
(), 
_1
, 
_2
, 
_3
));

38 
	g£rv”CÚn_
->
£tHighW©”M¬kC®lback
(

39 
boo¡
::
bšd
(&
TuÂ–
::
ÚHighW©”M¬kW—k
,

40 
boo¡
::
w—k_±r
<
TuÂ–
>(
sh¬ed_äom_this
()), 
kS”v”
, 
_1
, 
_2
),

44 
cÚÃù
()

46 
	gş›Á_
.
cÚÃù
();

49 
discÚÃù
()

51 
	gş›Á_
.
discÚÃù
();

55 
	g´iv©e
:

56 
‹¬down
()

58 
ş›Á_
.
£tCÚÃùiÚC®lback
(
muduo
::
Ãt
::
deçuÉCÚÃùiÚC®lback
);

59 
	gş›Á_
.
£tMes§geC®lback
(
muduo
::
Ãt
::
deçuÉMes§geC®lback
);

60 ià(
	g£rv”CÚn_
)

62 
	g£rv”CÚn_
->
£tCÚ‹xt
(
boo¡
::
ªy
());

63 
	g£rv”CÚn_
->
shutdown
();

65 
	gş›ÁCÚn_
.
»£t
();

68 
ÚCl›ÁCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

70 
LOG_DEBUG
 << (
cÚn
->
cÚÃùed
() ? "UP" : "DOWN");

71 ià(
	gcÚn
->
cÚÃùed
())

73 
	gcÚn
->
£tTıNoD–ay
(
Œue
);

74 
	gcÚn
->
£tHighW©”M¬kC®lback
(

75 
boo¡
::
bšd
(&
TuÂ–
::
ÚHighW©”M¬kW—k
,

76 
boo¡
::
w—k_±r
<
TuÂ–
>(
sh¬ed_äom_this
()), 
kCl›Á
, 
_1
, 
_2
),

78 
	g£rv”CÚn_
->
£tCÚ‹xt
(
cÚn
);

79 
	g£rv”CÚn_
->
¡¬tR—d
();

80 
	gş›ÁCÚn_
 = 
cÚn
;

81 ià(
	g£rv”CÚn_
->
šputBufãr
()->
»adabËBy‹s
() > 0)

83 
	gcÚn
->
£nd
(
£rv”CÚn_
->
šputBufãr
());

88 
‹¬down
();

92 
ÚCl›ÁMes§ge
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

93 
muduo
::
Ãt
::
Bufãr
* 
buf
,

94 
muduo
::
Time¡amp
)

96 
LOG_DEBUG
 << 
cÚn
->
Çme
(è<< " " << 
buf
->
»adabËBy‹s
();

97 ià(
	g£rv”CÚn_
)

99 
	g£rv”CÚn_
->
£nd
(
buf
);

103 
	gbuf
->
»Œ›veAÎ
();

104 
abÜt
();

108 
	eS”v”Cl›Á


110 
	gkS”v”
, 
	gkCl›Á


113 
ÚHighW©”M¬k
(
S”v”Cl›Á
 
which
,

114 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

115 
size_t
 
by‹sToS’t
)

117 
	gLOG_INFO
 << (
	gwhich
 =ğ
kS”v”
 ? "server" : "client")

118 << " onHighW©”M¬k " << 
cÚn
->
Çme
()

119 << " by‹ " << 
by‹sToS’t
;

121 ià(
	gwhich
 =ğ
kS”v”
)

123 ià(
£rv”CÚn_
->
ouutBufãr
()->
»adabËBy‹s
() > 0)

125 
ş›ÁCÚn_
->
¡İR—d
();

126 
	g£rv”CÚn_
->
£tWr™eCom¶‘eC®lback
(

127 
boo¡
::
bšd
(&
TuÂ–
::
ÚWr™eCom¶‘eW—k
,

128 
boo¡
::
w—k_±r
<
TuÂ–
>(
sh¬ed_äom_this
()), 
kS”v”
, 
_1
));

133 ià(
	gş›ÁCÚn_
->
ouutBufãr
()->
»adabËBy‹s
() > 0)

135 
	g£rv”CÚn_
->
¡İR—d
();

136 
	gş›ÁCÚn_
->
£tWr™eCom¶‘eC®lback
(

137 
boo¡
::
bšd
(&
TuÂ–
::
ÚWr™eCom¶‘eW—k
,

138 
boo¡
::
w—k_±r
<
TuÂ–
>(
sh¬ed_äom_this
()), 
kCl›Á
, 
_1
));

143 
ÚHighW©”M¬kW—k
(cÚ¡ 
boo¡
::
w—k_±r
<
TuÂ–
>& 
wkTuÂ–
,

144 
S”v”Cl›Á
 
which
,

145 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

146 
size_t
 
by‹sToS’t
)

148 
	gboo¡
::
sh¬ed_±r
<
TuÂ–
> 
tuÂ–
 = 
wkTuÂ–
.
lock
();

149 ià(
	gtuÂ–
)

151 
	gtuÂ–
->
ÚHighW©”M¬k
(
which
, 
cÚn
, 
by‹sToS’t
);

155 
ÚWr™eCom¶‘e
(
S”v”Cl›Á
 
which
, cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

157 
LOG_INFO
 << (
which
 =ğ
kS”v”
 ? "server" : "client")

158 << " onWr™eCom¶‘" << 
cÚn
->
Çme
();

159 ià(
	gwhich
 =ğ
kS”v”
)

161 
ş›ÁCÚn_
->
¡¬tR—d
();

162 
	g£rv”CÚn_
->
£tWr™eCom¶‘eC®lback
(
muduo
::
Ãt
::
Wr™eCom¶‘eC®lback
());

166 
	g£rv”CÚn_
->
¡¬tR—d
();

167 
	gş›ÁCÚn_
->
£tWr™eCom¶‘eC®lback
(
muduo
::
Ãt
::
Wr™eCom¶‘eC®lback
());

171 
ÚWr™eCom¶‘eW—k
(cÚ¡ 
boo¡
::
w—k_±r
<
TuÂ–
>& 
wkTuÂ–
,

172 
S”v”Cl›Á
 
which
,

173 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

175 
boo¡
::
sh¬ed_±r
<
TuÂ–
> 
tuÂ–
 = 
wkTuÂ–
.
lock
();

176 ià(
	gtuÂ–
)

178 
	gtuÂ–
->
ÚWr™eCom¶‘e
(
which
, 
cÚn
);

182 
	g´iv©e
:

183 
muduo
::
Ãt
::
TıCl›Á
 
ş›Á_
;

184 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
£rv”CÚn_
;

185 
	gmuduo
::
Ãt
::
TıCÚÃùiÚPŒ
 
ş›ÁCÚn_
;

187 
	gboo¡
::
	tsh¬ed_±r
<
	tTuÂ–
> 
	tTuÂ–PŒ
;

	@examples/sudoku/batch.cc

1 
	~"sudoku.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/TıCl›Á.h
>

7 
	~<boo¡/bšd.hµ
>

8 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

10 
	~<f¡»am
>

12 
	~<¡dio.h
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 
boŞ
 
	$v”ify
(cÚ¡ 
¡ršg
& 
»suÉ
)

19  
Œue
;

20 
	}
}

22 
runLoÿl
(
¡d
::
i¡»am
& 
š
)

24 
Time¡amp
 
¡¬t
(Time¡amp::
now
());

25 
	g¡d
::
¡ršg
 
lše
;

26 
	gcouÁ
 = 0;

27 
	gsucûed
 = 0;

28 
g‘lše
(
š
, 
lše
))

30 ià(
	glše
.
size
(è=ğ
im¶ic™_ÿ¡
<
size_t
>(
kC–ls
))

32 ++
couÁ
;

33 ià(
v”ify
(
sŞveSudoku
(
lše
)))

35 ++
	gsucûed
;

39 
	g–­£d
 = 
timeDifã»nû
(
Time¡amp
::
now
(), 
¡¬t
);

40 
´štf
("%.3à£c, %.3àu ³¸sudoku.\n", 
–­£d
, 1000 * 1000 *ƒÏp£d / 
couÁ
);

43 
	g¡d
::
	tveùÜ
<
	t¡ršg
> 
	tIÅut
;

44 
	gboo¡
::
	tsh¬ed_±r
<
	tIÅut
> 
	tIÅutPŒ
;

46 
IÅutPŒ
 
»adIÅut
(
¡d
::
i¡»am
& 
š
)

48 
IÅutPŒ
 
šput
(
Ãw
 
IÅut
);

49 
	g¡d
::
¡ršg
 
lše
;

50 
g‘lše
(
š
, 
lše
))

52 ià(
	glše
.
size
(è=ğ
im¶ic™_ÿ¡
<
size_t
>(
kC–ls
))

54 
šput
->
push_back
(
lše
.
c_¡r
());

57  
	gšput
;

60 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	t¡ršg
&, , )> 
	tDÚeC®lback
;

62 şas 
	cSudokuCl›Á
 : 
boo¡
::
nÚcİyabË


64 
public
:

65 
	$SudokuCl›Á
(
Ev’tLoİ
* 
loİ
,

66 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

67 cÚ¡ 
IÅutPŒ
& 
šput
,

68 cÚ¡ 
¡ršg
& 
Çme
,

69 cÚ¡ 
DÚeC®lback
& 
cb


71 : 
	`Çme_
(
Çme
),

72 
	`ş›Á_
(
loİ
, 
£rv”Addr
, 
Çme_
),

73 
	`šput_
(
šput
),

74 
	`cb_
(
cb
),

75 
	$couÁ_
(0)

77 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

78 
boo¡
::
	`bšd
(&
SudokuCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

79 
ş›Á_
.
	`£tMes§geC®lback
(

80 
boo¡
::
	`bšd
(&
SudokuCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

83 
	$cÚÃù
()

85 
ş›Á_
.
	`cÚÃù
();

86 
	}
}

88 
	g´iv©e
:

89 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

91 ià(
cÚn
->
	`cÚÃùed
())

93 
LOG_INFO
 << 
Çme_
 << " connected";

94 
¡¬t_
 = 
Time¡amp
::
	`now
();

95 
size_t
 
i
 = 0; i < 
šput_
->
	`size
(); ++i)

97 
LogSŒ—m
 
buf
;

98 
buf
 << 
i
+1 << ":" << (*
šput_
)[i] << "\r\n";

99 
cÚn
->
	`£nd
(
buf
.
	`bufãr
().
	`d©a
(), buf.bufãr().
	`Ëngth
());

101 
LOG_INFO
 << 
Çme_
 << " sent„equests";

105 
LOG_INFO
 << 
Çme_
 << " disconnected";

107 
	}
}

109 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

113 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

114 
Ën
 >ğ
kC–ls
 + 2)

116 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

117 ià(
ülf
)

119 
¡ršg
 
	`»¥Ú£
(
buf
->
	`³ek
(), 
ülf
);

120 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

121 
Ën
 = 
buf
->
	`»adabËBy‹s
();

122 ++
couÁ_
;

123 ià(!
	`v”ify
(
»¥Ú£
))

125 
LOG_ERROR
 << "Bad„e¥Ú£:" << 
»¥Ú£
;

126 
cÚn
->
	`shutdown
();

130 ià(
Ën
 > 100)

132 
LOG_ERROR
 << "Line isoo†ong!";

133 
cÚn
->
	`shutdown
();

142 ià(
couÁ_
 =ğ
¡©ic_ÿ¡
<>(
šput_
->
	`size
()))

144 
LOG_INFO
 << 
Çme_
 << " done.";

145 
–­£d
 = 
	`timeDifã»nû
(
Time¡amp
::
	`now
(), 
¡¬t_
);

146 
	`cb_
(
Çme_
, 
–­£d
, 
couÁ_
);

147 
cÚn
->
	`shutdown
();

149 
	}
}

151 
¡ršg
 
	gÇme_
;

152 
TıCl›Á
 
	gş›Á_
;

153 
IÅutPŒ
 
	gšput_
;

154 
DÚeC®lback
 
	gcb_
;

155 
	gcouÁ_
;

156 
Time¡amp
 
	g¡¬t_
;

159 
Time¡amp
 
	gg_¡¬t
;

160 
	gg_cÚÃùiÚs
;

161 
	gg_fšished
;

162 
Ev’tLoİ
* 
	gg_loİ
;

164 
	$dÚe
(cÚ¡ 
¡ršg
& 
Çme
, 
–­£d
, 
couÁ
)

166 
LOG_INFO
 << 
Çme
 << " " << 
–­£d
 << " seconds "

167 << 
	`Fmt
("%.3f", 1000 * 1000 * 
–­£d
 / 
couÁ
)

169 ++
g_fšished
;

170 ià(
g_fšished
 =ğ
g_cÚÃùiÚs
)

172 
g_loİ
->
	`runAá”
(1.0, 
boo¡
::
	`bšd
(&
Ev’tLoİ
::
qu™
, g_loop));

173 
tÙ®
 = 
	`timeDifã»nû
(
Time¡amp
::
	`now
(), 
g_¡¬t
);

174 
LOG_INFO
 << "tÙ® " << 
tÙ®
 << " seconds, "

175 << (
tÙ®
/
g_cÚÃùiÚs
) << " seconds…er client";

177 
	}
}

179 
runCl›Á
(
¡d
::
i¡»am
& 
š
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
, 
cÚn
)

181 
IÅutPŒ
 
šput
(
»adIÅut
(
š
));

182 
Ev’tLoİ
 
	gloİ
;

183 
	gg_loİ
 = &
loİ
;

184 
	gg_cÚÃùiÚs
 = 
cÚn
;

186 
	gg_¡¬t
 = 
Time¡amp
::
now
();

187 
	gboo¡
::
±r_veùÜ
<
SudokuCl›Á
> 
ş›Ás
;

188 
	gi
 = 0; i < 
	gcÚn
; ++i)

190 
Fmt
 
f
("ş›Á-%03d", 
i
+1);

191 
¡ršg
 
Çme
(
f
.
d©a
(), f.
Ëngth
());

192 
	gş›Ás
.
push_back
(
Ãw
 
SudokuCl›Á
(&
loİ
, 
£rv”Addr
, 
šput
, 
Çme
, 
dÚe
));

193 
	gş›Ás
.
back
().
cÚÃù
();

196 
	gloİ
.
loİ
();

199 
	$maš
(
¬gc
, * 
¬gv
[])

201 
cÚn
 = 1;

202 
IÃtAdd»ss
 
	`£rv”Addr
("127.0.0.1", 9981);

203 cÚ¡ * 
šput
 = 
NULL
;

204 
boŞ
 
loÿl
 = 
Œue
;

205 
¬gc
)

208 
cÚn
 = 
	`©oi
(
¬gv
[3]);

211 
£rv”Addr
 = 
	`IÃtAdd»ss
(
¬gv
[2], 9981);

212 
loÿl
 = 
çl£
;

215 
šput
 = 
¬gv
[1];

218 
	`´štf
("U§ge: % špuˆ£rv”_ [cÚÃùiÚs]\n", 
¬gv
[0]);

222 
¡d
::
if¡»am
 
	`š
(
šput
);

223 ià(
š
)

225 ià(
loÿl
)

227 
	`runLoÿl
(
š
);

231 
	`runCl›Á
(
š
, 
£rv”Addr
, 
cÚn
);

236 
	`´štf
("CªnÙ o³À%s\n", 
šput
);

238 
	}
}

	@examples/sudoku/loadtest.cc

1 
	~"sudoku.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/FeUt.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/TıCl›Á.h
>

8 
	~<boo¡/bšd.hµ
>

9 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

10 
	~<boo¡/unÜd”ed_m­.hµ
>

12 
	~<f¡»am
>

13 
	~<num”ic
>

15 
	~"³rûÁe.h
"

17 
	~<¡dio.h
>

19 
usšg
 
Çme¥aû
 
	gmuduo
;

20 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

22 
	g¡d
::
	tveùÜ
<
	t¡ršg
> 
	tIÅut
;

23 
	gboo¡
::
	tsh¬ed_±r
<cÚ¡ 
	tIÅut
> 
	tIÅutPŒ
;

25 
IÅutPŒ
 
»adIÅut
(
¡d
::
i¡»am
& 
š
)

27 
boo¡
::
sh¬ed_±r
<
IÅut
> 
šput
(
Ãw
 Input);

28 
	g¡d
::
¡ršg
 
lše
;

29 
g‘lše
(
š
, 
lše
))

31 ià(
	glše
.
size
(è=ğ
im¶ic™_ÿ¡
<
size_t
>(
kC–ls
))

33 
šput
->
push_back
(
lše
.
c_¡r
());

36  
	gšput
;

39 şas 
	cSudokuCl›Á
 : 
boo¡
::
nÚcİyabË


41 
public
:

42 
	$SudokuCl›Á
(
Ev’tLoİ
* 
loİ
,

43 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

44 cÚ¡ 
IÅutPŒ
& 
šput
,

45 cÚ¡ 
¡ršg
& 
Çme
,

46 
boŞ
 
nod–ay
)

47 : 
	`Çme_
(
Çme
),

48 
	`tıNoD–ay_
(
nod–ay
),

49 
	`ş›Á_
(
loİ
, 
£rv”Addr
, 
Çme_
),

50 
	`šput_
(
šput
),

51 
	$couÁ_
(0)

53 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

54 
boo¡
::
	`bšd
(&
SudokuCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

55 
ş›Á_
.
	`£tMes§geC®lback
(

56 
boo¡
::
	`bšd
(&
SudokuCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

59 
	$cÚÃù
()

61 
ş›Á_
.
	`cÚÃù
();

62 
	}
}

64 
	$£nd
(
n
)

66 
	`as£¹
(
n
 > 0);

67 ià(!
cÚn_
)

70 
Time¡amp
 
	`now
(Timestamp::now());

71 
i
 = 0; i < 
n
; ++i)

73 
buf
[256];

74 cÚ¡ 
¡ršg
& 
»q
 = (*
šput_
)[
couÁ_
 % iÅut_->
	`size
()];

75 
Ën
 = 
	`¢´štf
(
buf
,  buf, "%s-%08d:%s\r\n",

76 
Çme_
.
	`c_¡r
(), 
couÁ_
, 
»q
.c_str());

77 
»que¡s_
.
	`­³nd
(
buf
, 
Ën
);

78 
£ndTime_
[
couÁ_
] = 
now
;

79 ++
couÁ_
;

82 
cÚn_
->
	`£nd
(&
»que¡s_
);

83 
	}
}

85 
»pÜt
(
¡d
::
veùÜ
<>* 
Ï‹ncy
, * 
šæy
)

87 
	gÏ‹ncy
->
š£¹
(
Ï‹ncy
->
’d
(), 
Ï‹nc›s_
.
begš
(),†atencies_.end());

88 
	gÏ‹nc›s_
.
ş—r
();

89 *
	gšæy
 +ğ
¡©ic_ÿ¡
<>(
£ndTime_
.
size
());

92 
	g´iv©e
:

93 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

95 ià(
cÚn
->
	`cÚÃùed
())

97 
LOG_INFO
 << 
Çme_
 << " connected";

98 ià(
tıNoD–ay_
)

99 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

100 
cÚn_
 = 
cÚn
;

104 
LOG_INFO
 << 
Çme_
 << " disconnected";

105 
cÚn_
.
	`»£t
();

108 
	}
}

110 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
»cvTime
)

112 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

113 
Ën
 >ğ
kC–ls
 + 2)

115 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

116 ià(
ülf
)

118 
¡ršg
 
	`»¥Ú£
(
buf
->
	`³ek
(), 
ülf
);

119 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

120 
Ën
 = 
buf
->
	`»adabËBy‹s
();

121 ià(!
	`v”ify
(
»¥Ú£
, 
»cvTime
))

123 
LOG_ERROR
 << "Bad„e¥Ú£:" << 
»¥Ú£
;

124 
cÚn
->
	`shutdown
();

128 ià(
Ën
 > 100)

130 
LOG_ERROR
 << "Line isoo†ong!";

131 
cÚn
->
	`shutdown
();

139 
	}
}

141 
boŞ
 
	$v”ify
(cÚ¡ 
¡ršg
& 
»¥Ú£
, 
Time¡amp
 
»cvTime
)

143 
size_t
 
cŞÚ
 = 
»¥Ú£
.
	`fšd
(':');

144 ià(
cŞÚ
 !ğ
¡ršg
::
Åos
)

146 
size_t
 
dash
 = 
»¥Ú£
.
	`fšd
('-');

147 ià(
dash
 !ğ
¡ršg
::
Åos
 && dash < 
cŞÚ
)

149 
id
 = 
	`©oi
(
»¥Ú£
.
	`c_¡r
()+
dash
+1);

150 
boo¡
::
unÜd”ed_m­
<, 
Time¡amp
>::
™”©Ü
 
£ndTime
 = 
£ndTime_
.
	`fšd
(
id
);

151 ià(
£ndTime
 !ğ
£ndTime_
.
	`’d
())

153 
št64_t
 
Ï‹ncy_us
 = 
»cvTime
.
	`miüoSecÚdsSšûEpoch
(è- 
£ndTime
->
£cÚd
.microSecondsSinceEpoch();

154 
Ï‹nc›s_
.
	`push_back
(
¡©ic_ÿ¡
<>(
Ï‹ncy_us
));

155 
£ndTime_
.
	`”a£
(
£ndTime
);

159 
LOG_ERROR
 << "UnknowÀid " << 
id
 << " oà" << 
Çme_
;

164  
Œue
;

165 
	}
}

167 cÚ¡ 
¡ršg
 
	gÇme_
;

168 cÚ¡ 
boŞ
 
	gtıNoD–ay_
;

169 
TıCl›Á
 
	gş›Á_
;

170 
TıCÚÃùiÚPŒ
 
	gcÚn_
;

171 
Bufãr
 
	g»que¡s_
;

172 cÚ¡ 
IÅutPŒ
 
	gšput_
;

173 
	gcouÁ_
;

174 
	gboo¡
::
unÜd”ed_m­
<, 
	gTime¡amp
> 
	g£ndTime_
;

175 
	g¡d
::
veùÜ
<> 
Ï‹nc›s_
;

178 şas 
	cSudokuLßd‹¡
 : 
boo¡
::
nÚcİyabË


180 
public
:

181 
	$SudokuLßd‹¡
()

182 : 
	`couÁ_
(0),

183 
	`ticks_
(0),

184 
	$soçr_
(0)

188 
	$runCl›Á
(cÚ¡ 
IÅutPŒ
& 
šput
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
, 
½s
, 
cÚn
, 
boŞ
 
nod–ay
)

190 
Ev’tLoİ
 
loİ
;

192 
i
 = 0; i < 
cÚn
; ++i)

194 
Fmt
 
	`f
("c%04d", 
i
+1);

195 
¡ršg
 
	`Çme
(
f
.
	`d©a
(), f.
	`Ëngth
());

196 
ş›Ás_
.
	`push_back
(
Ãw
 
	`SudokuCl›Á
(&
loİ
, 
£rv”Addr
, 
šput
, 
Çme
, 
nod–ay
));

197 
ş›Ás_
.
	`back
().
	`cÚÃù
();

200 
loİ
.
	`runEv”y
(1.0 / 
kHz
, 
boo¡
::
	`bšd
(&
SudokuLßd‹¡
::
tick
, 
this
, 
½s
));

201 
loİ
.
	`runEv”y
(1.0, 
boo¡
::
	`bšd
(&
SudokuLßd‹¡
::
tock
, 
this
));

202 
loİ
.
	`loİ
();

203 
	}
}

205 
	g´iv©e
:

206 
	$tick
(
½s
)

208 ++
ticks_
;

209 
št64_t
 
»qs
 = 
½s
 * 
ticks_
 / 
kHz
 - 
soçr_
;

210 
soçr_
 +ğ
»qs
;

212 ià(
»qs
 > 0)

214 
boo¡
::
±r_veùÜ
<
SudokuCl›Á
>::
™”©Ü
 
™
 = 
ş›Ás_
.
	`begš
();

215 
™
 !ğ
ş›Ás_
.
	`’d
(); ++it)

217 
™
->
	`£nd
(
¡©ic_ÿ¡
<>(
»qs
));

220 
	}
}

222 
	$tock
()

224 
¡d
::
veùÜ
<> 
Ï‹nc›s
;

225 
šæy
 = 0;

226 
boo¡
::
±r_veùÜ
<
SudokuCl›Á
>::
™”©Ü
 
™
 = 
ş›Ás_
.
	`begš
();

227 
™
 !ğ
ş›Ás_
.
	`’d
(); ++it)

229 
™
->
	`»pÜt
(&
Ï‹nc›s
, &
šæy
);

232 
P”ûÁe
 
	`p
(
Ï‹nc›s
, 
šæy
);

233 
LOG_INFO
 << 
p
.
	`»pÜt
();

234 
buf
[64];

235 
	`¢´štf
(
buf
,  buf, "r%04d", 
couÁ_
);

236 
p
.
	`§ve
(
Ï‹nc›s
, 
buf
);

237 ++
couÁ_
;

238 
	}
}

240 
	gboo¡
::
±r_veùÜ
<
SudokuCl›Á
> 
ş›Ás_
;

241 
	gcouÁ_
;

242 
št64_t
 
	gticks_
;

243 
št64_t
 
	gsoçr_
;

244 cÚ¡ 
	gkHz
 = 100;

247 
	$maš
(
¬gc
, * 
¬gv
[])

249 
cÚn
 = 1;

250 
½s
 = 100;

251 
boŞ
 
nod–ay
 = 
çl£
;

252 
IÃtAdd»ss
 
	`£rv”Addr
("127.0.0.1", 9981);

253 
¬gc
)

256 
nod–ay
 = 
	`¡ršg
(
¬gv
[5]) == "-n";

259 
cÚn
 = 
	`©oi
(
¬gv
[4]);

262 
½s
 = 
	`©oi
(
¬gv
[3]);

265 
£rv”Addr
 = 
	`IÃtAdd»ss
(
¬gv
[2], 9981);

270 
	`´štf
("U§ge: % špuˆ£rv”_ [»que¡s_³r_£cÚd] [cÚÃùiÚs] [-n]\n", 
¬gv
[0]);

274 
¡d
::
if¡»am
 
	`š
(
¬gv
[1]);

275 ià(
š
)

277 
IÅutPŒ
 
	`šput
(
	`»adIÅut
(
š
));

278 
	`´štf
("%zd„eque¡ äom %s\n", 
šput
->
	`size
(), 
¬gv
[1]);

279 
SudokuLßd‹¡
 
‹¡
;

280 
‹¡
.
	`runCl›Á
(
šput
, 
£rv”Addr
, 
½s
, 
cÚn
, 
nod–ay
);

284 
	`´štf
("CªnÙ o³À%s\n", 
¬gv
[1]);

286 
	}
}

	@examples/sudoku/percentile.h

4 şas 
	cP”ûÁe


6 
	mpublic
:

7 
P”ûÁe
(
¡d
::
veùÜ
<>& 
Ï‹nc›s
, 
šæy
)

9 
	m¡©
 << "»cv " << 
	mmuduo
::
Fmt
("%6zd", 
Ï‹nc›s
.
size
()è<< " in-æy " << 
	mšæy
;

11 ià(!
	mÏ‹nc›s
.
em±y
())

13 
	m¡d
::
sÜt
(
Ï‹nc›s
.
begš
(),†©’c›s.
’d
());

14 
	mmš
 = 
Ï‹nc›s
.
äÚt
();

15 
	mmax
 = 
Ï‹nc›s
.
back
();

16 
	msum
 = 
¡d
::
accumuÏ‹
(
Ï‹nc›s
.
begš
(),†©’c›s.
’d
(), 0);

17 
	mm—n
 = 
sum
 / 
¡©ic_ÿ¡
<>(
Ï‹nc›s
.
size
());

18 
	mmedŸn
 = 
g‘P”ûÁe
(
Ï‹nc›s
, 50);

19 
	mp90
 = 
g‘P”ûÁe
(
Ï‹nc›s
, 90);

20 
	mp99
 = 
g‘P”ûÁe
(
Ï‹nc›s
, 99);

21 
	m¡©
 << " mš " << 
	mmš


22 << " max " << 
	mmax


23 << "‡vg " << 
	mm—n


24 << " medŸÀ" << 
	mmedŸn


25 << "…90 " << 
	mp90


26 << "…99 " << 
	mp99
;

30 cÚ¡ 
	gmuduo
::
LogSŒ—m
::
Bufãr
& 
	$»pÜt
() const

32  
¡©
.
	`bufãr
();

33 
	}
}

35 
§ve
(cÚ¡ 
¡d
::
veùÜ
<>& 
Ï‹nc›s
, 
muduo
::
SŒšgArg
 
Çme
) const

37 ià(
Ï‹nc›s
.
em±y
())

39 
	gmuduo
::
FeUt
::
Aµ’dFe
 
f
(
Çme
);

40 
	gf
.
­³nd
("# ", 2);

41 
	gf
.
­³nd
(
¡©
.
bufãr
().
d©a
(), st.bufãr().
Ëngth
());

42 
	gf
.
­³nd
("\n", 1);

44 cÚ¡ 
	gkIÁ”v®
 = 5;

45 
	glow
 = 
Ï‹nc›s
.
äÚt
(è/ 
kIÁ”v®
 * kInterval;

46 
	gcouÁ
 = 0;

47 
	gsum
 = 0;

48 cÚ¡ 
	gtÙ®
 = 
¡©ic_ÿ¡
<>(
Ï‹nc›s
.
size
());

49 
	gbuf
[64];

50 #iâdeà
NDEBUG


51 
size_t
 
	gi
 = 0; i < 
	gÏ‹nc›s
.
size
(); ++i)

53 
	gn
 = 
¢´štf
(
buf
,  buf, "# %d\n", 
Ï‹nc›s
[
i
]);

54 
	gf
.
­³nd
(
buf
, 
n
);

58 
size_t
 
	gi
 = 0; i < 
	gÏ‹nc›s
.
size
(); ++i)

60 ià(
	gÏ‹nc›s
[
i
] < 
	glow
 + 
	gkIÁ”v®
)

61 ++
	gcouÁ
;

64 
	gsum
 +ğ
couÁ
;

65 
	gn
 = 
¢´štf
(
buf
,  buf, "%4d %5d %5.2f\n", 
low
, 
couÁ
, 100 * 
sum
 / 
tÙ®
);

66 
	gf
.
­³nd
(
buf
, 
n
);

67 
	glow
 = 
Ï‹nc›s
[
i
] / 
kIÁ”v®
 * kInterval;

68 
as£¹
(
Ï‹nc›s
[
i
] < 
low
 + 
kIÁ”v®
);

69 
	gcouÁ
 = 1;

72 
	gsum
 +ğ
couÁ
;

73 
as£¹
(
sum
 =ğ
tÙ®
);

74 
	gn
 = 
¢´štf
(
buf
,  buf, "%4d %5d %5.1f\n", 
low
, 
couÁ
, 100 * 
sum
 / 
tÙ®
);

75 
	gf
.
­³nd
(
buf
, 
n
);

78 
	g´iv©e
:

80 
g‘P”ûÁe
(cÚ¡ 
¡d
::
veùÜ
<>& 
Ï‹nc›s
, 
³rûÁ
)

83 
as£¹
(
Ï‹nc›s
.
size
() > 0);

84 
size_t
 
	gidx
 = 0;

85 ià(
	g³rûÁ
 > 0)

87 
	gidx
 = (
Ï‹nc›s
.
size
(è* 
³rûÁ
 + 99) / 100 - 1;

88 
as£¹
(
idx
 < 
Ï‹nc›s
.
size
());

90  
	gÏ‹nc›s
[
idx
];

93 
	gmuduo
::
LogSŒ—m
 
¡©
;

	@examples/sudoku/percentile.h

4 şas 
	cP”ûÁe


6 
	mpublic
:

7 
P”ûÁe
(
¡d
::
veùÜ
<>& 
Ï‹nc›s
, 
šæy
)

9 
	m¡©
 << "»cv " << 
	mmuduo
::
Fmt
("%6zd", 
Ï‹nc›s
.
size
()è<< " in-æy " << 
	mšæy
;

11 ià(!
	mÏ‹nc›s
.
em±y
())

13 
	m¡d
::
sÜt
(
Ï‹nc›s
.
begš
(),†©’c›s.
’d
());

14 
	mmš
 = 
Ï‹nc›s
.
äÚt
();

15 
	mmax
 = 
Ï‹nc›s
.
back
();

16 
	msum
 = 
¡d
::
accumuÏ‹
(
Ï‹nc›s
.
begš
(),†©’c›s.
’d
(), 0);

17 
	mm—n
 = 
sum
 / 
¡©ic_ÿ¡
<>(
Ï‹nc›s
.
size
());

18 
	mmedŸn
 = 
g‘P”ûÁe
(
Ï‹nc›s
, 50);

19 
	mp90
 = 
g‘P”ûÁe
(
Ï‹nc›s
, 90);

20 
	mp99
 = 
g‘P”ûÁe
(
Ï‹nc›s
, 99);

21 
	m¡©
 << " mš " << 
	mmš


22 << " max " << 
	mmax


23 << "‡vg " << 
	mm—n


24 << " medŸÀ" << 
	mmedŸn


25 << "…90 " << 
	mp90


26 << "…99 " << 
	mp99
;

30 cÚ¡ 
	gmuduo
::
LogSŒ—m
::
Bufãr
& 
	$»pÜt
() const

32  
¡©
.
	`bufãr
();

33 
	}
}

35 
§ve
(cÚ¡ 
¡d
::
veùÜ
<>& 
Ï‹nc›s
, 
muduo
::
SŒšgArg
 
Çme
) const

37 ià(
Ï‹nc›s
.
em±y
())

39 
	gmuduo
::
FeUt
::
Aµ’dFe
 
f
(
Çme
);

40 
	gf
.
­³nd
("# ", 2);

41 
	gf
.
­³nd
(
¡©
.
bufãr
().
d©a
(), st.bufãr().
Ëngth
());

42 
	gf
.
­³nd
("\n", 1);

44 cÚ¡ 
	gkIÁ”v®
 = 5;

45 
	glow
 = 
Ï‹nc›s
.
äÚt
(è/ 
kIÁ”v®
 * kInterval;

46 
	gcouÁ
 = 0;

47 
	gsum
 = 0;

48 cÚ¡ 
	gtÙ®
 = 
¡©ic_ÿ¡
<>(
Ï‹nc›s
.
size
());

49 
	gbuf
[64];

50 #iâdeà
NDEBUG


51 
size_t
 
	gi
 = 0; i < 
	gÏ‹nc›s
.
size
(); ++i)

53 
	gn
 = 
¢´štf
(
buf
,  buf, "# %d\n", 
Ï‹nc›s
[
i
]);

54 
	gf
.
­³nd
(
buf
, 
n
);

58 
size_t
 
	gi
 = 0; i < 
	gÏ‹nc›s
.
size
(); ++i)

60 ià(
	gÏ‹nc›s
[
i
] < 
	glow
 + 
	gkIÁ”v®
)

61 ++
	gcouÁ
;

64 
	gsum
 +ğ
couÁ
;

65 
	gn
 = 
¢´štf
(
buf
,  buf, "%4d %5d %5.2f\n", 
low
, 
couÁ
, 100 * 
sum
 / 
tÙ®
);

66 
	gf
.
­³nd
(
buf
, 
n
);

67 
	glow
 = 
Ï‹nc›s
[
i
] / 
kIÁ”v®
 * kInterval;

68 
as£¹
(
Ï‹nc›s
[
i
] < 
low
 + 
kIÁ”v®
);

69 
	gcouÁ
 = 1;

72 
	gsum
 +ğ
couÁ
;

73 
as£¹
(
sum
 =ğ
tÙ®
);

74 
	gn
 = 
¢´štf
(
buf
,  buf, "%4d %5d %5.1f\n", 
low
, 
couÁ
, 100 * 
sum
 / 
tÙ®
);

75 
	gf
.
­³nd
(
buf
, 
n
);

78 
	g´iv©e
:

80 
g‘P”ûÁe
(cÚ¡ 
¡d
::
veùÜ
<>& 
Ï‹nc›s
, 
³rûÁ
)

83 
as£¹
(
Ï‹nc›s
.
size
() > 0);

84 
size_t
 
	gidx
 = 0;

85 ià(
	g³rûÁ
 > 0)

87 
	gidx
 = (
Ï‹nc›s
.
size
(è* 
³rûÁ
 + 99) / 100 - 1;

88 
as£¹
(
idx
 < 
Ï‹nc›s
.
size
());

90  
	gÏ‹nc›s
[
idx
];

93 
	gmuduo
::
LogSŒ—m
 
¡©
;

	@examples/sudoku/pipeline.cc

1 
	~"sudoku.h
"

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/FeUt.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/TıCl›Á.h
>

8 
	~<boo¡/bšd.hµ
>

9 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

10 
	~<boo¡/unÜd”ed_m­.hµ
>

12 
	~<f¡»am
>

13 
	~<num”ic
>

15 
	~"³rûÁe.h
"

17 
	~<¡dio.h
>

19 
usšg
 
Çme¥aû
 
	gmuduo
;

20 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

22 
	g¡d
::
	tveùÜ
<
	t¡ršg
> 
	tIÅut
;

23 
	gboo¡
::
	tsh¬ed_±r
<cÚ¡ 
	tIÅut
> 
	tIÅutPŒ
;

25 şas 
	cSudokuCl›Á
 : 
boo¡
::
nÚcİyabË


27 
public
:

28 
	$SudokuCl›Á
(
Ev’tLoİ
* 
loİ
,

29 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

30 cÚ¡ 
IÅutPŒ
& 
šput
,

31 cÚ¡ 
¡ršg
& 
Çme
,

32 
p–šes
,

33 
boŞ
 
nod–ay
)

34 : 
	`Çme_
(
Çme
),

35 
	`p–šes_
(
p–šes
),

36 
	`tıNoD–ay_
(
nod–ay
),

37 
	`ş›Á_
(
loİ
, 
£rv”Addr
, 
Çme_
),

38 
	`šput_
(
šput
),

39 
	$couÁ_
(0)

41 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

42 
boo¡
::
	`bšd
(&
SudokuCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

43 
ş›Á_
.
	`£tMes§geC®lback
(

44 
boo¡
::
	`bšd
(&
SudokuCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

47 
	$cÚÃù
()

49 
ş›Á_
.
	`cÚÃù
();

50 
	}
}

52 
»pÜt
(
¡d
::
veùÜ
<>* 
Ï‹ncy
, * 
šæy
)

54 
	gÏ‹ncy
->
š£¹
(
Ï‹ncy
->
’d
(), 
Ï‹nc›s_
.
begš
(),†atencies_.end());

55 
	gÏ‹nc›s_
.
ş—r
();

56 *
	gšæy
 +ğ
¡©ic_ÿ¡
<>(
£ndTime_
.
size
());

59 
	g´iv©e
:

60 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

62 ià(
cÚn
->
	`cÚÃùed
())

64 
LOG_INFO
 << 
Çme_
 << " connected";

65 ià(
tıNoD–ay_
)

66 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

67 
cÚn_
 = 
cÚn
;

68 
	`£nd
(
p–šes_
);

72 
LOG_INFO
 << 
Çme_
 << " disconnected";

73 
cÚn_
.
	`»£t
();

76 
	}
}

78 
	$£nd
(
n
)

80 
Time¡amp
 
	`now
(Timestamp::now());

81 
Bufãr
 
»que¡s
;

82 
i
 = 0; i < 
n
; ++i)

84 
buf
[256];

85 cÚ¡ 
¡ršg
& 
»q
 = (*
šput_
)[
couÁ_
 % iÅut_->
	`size
()];

86 
Ën
 = 
	`¢´štf
(
buf
,  buf, "%s-%08d:%s\r\n",

87 
Çme_
.
	`c_¡r
(), 
couÁ_
, 
»q
.c_str());

88 
»que¡s
.
	`­³nd
(
buf
, 
Ën
);

89 
£ndTime_
[
couÁ_
] = 
now
;

90 ++
couÁ_
;

93 
cÚn_
->
	`£nd
(&
»que¡s
);

94 
	}
}

96 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
»cvTime
)

98 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

99 
Ën
 >ğ
kC–ls
 + 2)

101 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

102 ià(
ülf
)

104 
¡ršg
 
	`»¥Ú£
(
buf
->
	`³ek
(), 
ülf
);

105 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

106 
Ën
 = 
buf
->
	`»adabËBy‹s
();

107 ià(
	`v”ify
(
»¥Ú£
, 
»cvTime
))

109 
	`£nd
(1);

113 
LOG_ERROR
 << "Bad„e¥Ú£:" << 
»¥Ú£
;

114 
cÚn
->
	`shutdown
();

118 ià(
Ën
 > 100)

120 
LOG_ERROR
 << "Line isoo†ong!";

121 
cÚn
->
	`shutdown
();

129 
	}
}

131 
boŞ
 
	$v”ify
(cÚ¡ 
¡ršg
& 
»¥Ú£
, 
Time¡amp
 
»cvTime
)

133 
size_t
 
cŞÚ
 = 
»¥Ú£
.
	`fšd
(':');

134 ià(
cŞÚ
 !ğ
¡ršg
::
Åos
)

136 
size_t
 
dash
 = 
»¥Ú£
.
	`fšd
('-');

137 ià(
dash
 !ğ
¡ršg
::
Åos
 && dash < 
cŞÚ
)

139 
id
 = 
	`©oi
(
»¥Ú£
.
	`c_¡r
()+
dash
+1);

140 
boo¡
::
unÜd”ed_m­
<, 
Time¡amp
>::
™”©Ü
 
£ndTime
 = 
£ndTime_
.
	`fšd
(
id
);

141 ià(
£ndTime
 !ğ
£ndTime_
.
	`’d
())

143 
št64_t
 
Ï‹ncy_us
 = 
»cvTime
.
	`miüoSecÚdsSšûEpoch
(è- 
£ndTime
->
£cÚd
.microSecondsSinceEpoch();

144 
Ï‹nc›s_
.
	`push_back
(
¡©ic_ÿ¡
<>(
Ï‹ncy_us
));

145 
£ndTime_
.
	`”a£
(
£ndTime
);

149 
LOG_ERROR
 << "UnknowÀid " << 
id
 << " oà" << 
Çme_
;

154  
Œue
;

155 
	}
}

157 cÚ¡ 
¡ršg
 
	gÇme_
;

158 cÚ¡ 
	gp–šes_
;

159 cÚ¡ 
boŞ
 
	gtıNoD–ay_
;

160 
TıCl›Á
 
	gş›Á_
;

161 
TıCÚÃùiÚPŒ
 
	gcÚn_
;

162 cÚ¡ 
IÅutPŒ
 
	gšput_
;

163 
	gcouÁ_
;

164 
	gboo¡
::
unÜd”ed_m­
<, 
	gTime¡amp
> 
	g£ndTime_
;

165 
	g¡d
::
veùÜ
<> 
Ï‹nc›s_
;

168 
»pÜt
(
boo¡
::
±r_veùÜ
<
SudokuCl›Á
>* 
ş›Ás
)

170 
couÁ
 = 0;

172 
	g¡d
::
veùÜ
<> 
Ï‹nc›s
;

173 
	gšæy
 = 0;

174 
	gboo¡
::
±r_veùÜ
<
SudokuCl›Á
>::
™”©Ü
 
™
 = 
ş›Ás
->
begš
();

175 
	g™
 !ğ
ş›Ás
->
’d
(); ++it)

177 
	g™
->
»pÜt
(&
Ï‹nc›s
, &
šæy
);

180 
P”ûÁe
 
p
(
Ï‹nc›s
, 
šæy
);

181 
	gLOG_INFO
 << 
	gp
.
»pÜt
();

182 
	gbuf
[64];

183 
¢´štf
(
buf
,  buf, "p%04d", 
couÁ
);

184 
	gp
.
§ve
(
Ï‹nc›s
, 
buf
);

185 ++
	gcouÁ
;

188 
IÅutPŒ
 
»adIÅut
(
¡d
::
i¡»am
& 
š
)

190 
boo¡
::
sh¬ed_±r
<
IÅut
> 
šput
(
Ãw
 Input);

191 
	g¡d
::
¡ršg
 
lše
;

192 
g‘lše
(
š
, 
lše
))

194 ià(
	glše
.
size
(è=ğ
im¶ic™_ÿ¡
<
size_t
>(
kC–ls
))

196 
šput
->
push_back
(
lše
.
c_¡r
());

199  
	gšput
;

202 
	$runCl›Á
(cÚ¡ 
IÅutPŒ
& 
šput
,

203 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

204 
cÚn
,

205 
p–šes
,

206 
boŞ
 
nod–ay
)

208 
Ev’tLoİ
 
loİ
;

209 
boo¡
::
±r_veùÜ
<
SudokuCl›Á
> 
ş›Ás
;

210 
i
 = 0; i < 
cÚn
; ++i)

212 
Fmt
 
	`f
("c%04d", 
i
+1);

213 
¡ršg
 
	`Çme
(
f
.
	`d©a
(), f.
	`Ëngth
());

214 
ş›Ás
.
	`push_back
(
Ãw
 
	`SudokuCl›Á
(&
loİ
, 
£rv”Addr
, 
šput
, 
Çme
, 
p–šes
, 
nod–ay
));

215 
ş›Ás
.
	`back
().
	`cÚÃù
();

218 
loİ
.
	`runEv”y
(1.0, 
boo¡
::
	`bšd
(
»pÜt
, &
ş›Ás
));

219 
loİ
.
	`loİ
();

220 
	}
}

222 
	$maš
(
¬gc
, * 
¬gv
[])

224 
cÚn
 = 1;

225 
p–šes
 = 1;

226 
boŞ
 
nod–ay
 = 
çl£
;

227 
IÃtAdd»ss
 
	`£rv”Addr
("127.0.0.1", 9981);

228 
¬gc
)

231 
nod–ay
 = 
	`¡ršg
(
¬gv
[5]) == "-n";

234 
p–šes
 = 
	`©oi
(
¬gv
[4]);

237 
cÚn
 = 
	`©oi
(
¬gv
[3]);

240 
£rv”Addr
 = 
	`IÃtAdd»ss
(
¬gv
[2], 9981);

245 
	`´štf
("U§ge: % špuˆ£rv”_ [cÚÃùiÚs] [p–šes] [-n]\n", 
¬gv
[0]);

249 
¡d
::
if¡»am
 
	`š
(
¬gv
[1]);

250 ià(
š
)

252 
IÅutPŒ
 
	`šput
(
	`»adIÅut
(
š
));

253 
	`´štf
("%zd„eque¡ äom %s\n", 
šput
->
	`size
(), 
¬gv
[1]);

254 
	`runCl›Á
(
šput
, 
£rv”Addr
, 
cÚn
, 
p–šes
, 
nod–ay
);

258 
	`´štf
("CªnÙ o³À%s\n", 
¬gv
[1]);

260 
	}
}

	@examples/sudoku/server_basic.cc

1 
	~"sudoku.h
"

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<muduo/Ãt/TıS”v”.h
>

10 
	~<boo¡/bšd.hµ
>

12 
	~<ut™y
>

14 
	~<¡dio.h
>

15 
	~<uni¡d.h
>

17 
usšg
 
Çme¥aû
 
	gmuduo
;

18 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

20 şas 
	cSudokuS”v”


22 
	mpublic
:

23 
	$SudokuS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

24 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "SudokuServer"),

25 
	`¡¬tTime_
(
Time¡amp
::
	$now
())

27 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

28 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

29 
£rv”_
.
	`£tMes§geC®lback
(

30 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

33 
	$¡¬t
()

35 
£rv”_
.
	`¡¬t
();

36 
	}
}

38 
	g´iv©e
:

39 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

41 
LOG_TRACE
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

42 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

43 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

44 
	}
}

46 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

48 
LOG_DEBUG
 << 
cÚn
->
	`Çme
();

49 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

50 
Ën
 >ğ
kC–ls
 + 2)

52 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

53 ià(
ülf
)

55 
¡ršg
 
	`»que¡
(
buf
->
	`³ek
(), 
ülf
);

56 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

57 
Ën
 = 
buf
->
	`»adabËBy‹s
();

58 ià(!
	`´oûssReque¡
(
cÚn
, 
»que¡
))

60 
cÚn
->
	`£nd
("Bad Request!\r\n");

61 
cÚn
->
	`shutdown
();

65 ià(
Ën
 > 100)

67 
cÚn
->
	`£nd
("Idoo†ong!\r\n");

68 
cÚn
->
	`shutdown
();

76 
	}
}

78 
boŞ
 
	$´oûssReque¡
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, cÚ¡ 
¡ršg
& 
»que¡
)

80 
¡ršg
 
id
;

81 
¡ršg
 
puzzË
;

82 
boŞ
 
goodReque¡
 = 
Œue
;

84 
¡ršg
::
cÚ¡_™”©Ü
 
cŞÚ
 = 
	`fšd
(
»que¡
.
	`begš
(),„eque¡.
	`’d
(), ':');

85 ià(
cŞÚ
 !ğ
»que¡
.
	`’d
())

87 
id
.
	`assign
(
»que¡
.
	`begš
(), 
cŞÚ
);

88 
puzzË
.
	`assign
(
cŞÚ
+1, 
»que¡
.
	`’d
());

92 
puzzË
 = 
»que¡
;

95 ià(
puzzË
.
	`size
(è=ğ
im¶ic™_ÿ¡
<
size_t
>(
kC–ls
))

97 
LOG_DEBUG
 << 
cÚn
->
	`Çme
();

98 
¡ršg
 
»suÉ
 = 
	`sŞveSudoku
(
puzzË
);

99 ià(
id
.
	`em±y
())

101 
cÚn
->
	`£nd
(
»suÉ
+"\r\n");

105 
cÚn
->
	`£nd
(
id
+":"+
»suÉ
+"\r\n");

110 
goodReque¡
 = 
çl£
;

112  
goodReque¡
;

113 
	}
}

115 
TıS”v”
 
	g£rv”_
;

116 
Time¡amp
 
	g¡¬tTime_
;

119 
	$maš
(
¬gc
, * 
¬gv
[])

121 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

122 
Ev’tLoİ
 
loİ
;

123 
IÃtAdd»ss
 
	`li¡’Addr
(9981);

124 
SudokuS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

126 
£rv”
.
	`¡¬t
();

128 
loİ
.
	`loİ
();

129 
	}
}

	@examples/sudoku/server_hybrid.cc

1 
	~"sudoku.h
"

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/ba£/Th»adPoŞ.h
>

7 
	~<muduo/Ãt/Ev’tLoİ.h
>

8 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

9 
	~<muduo/Ãt/IÃtAdd»ss.h
>

10 
	~<muduo/Ãt/TıS”v”.h
>

11 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

13 
	~<boo¡/bšd.hµ
>

14 
	~<boo¡/cœcuÏr_bufãr.hµ
>

15 
	~<boo¡/nÚcİyabË.hµ
>

20 
usšg
 
Çme¥aû
 
	gmuduo
;

21 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

23 
	~"¡©.h
"

25 şas 
	cSudokuS”v”
 : 
boo¡
::
nÚcİyabË


27 
public
:

28 
	$SudokuS”v”
(
Ev’tLoİ
* 
loİ
,

29 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

30 
numEv’tLoİs
,

31 
numTh»ads
,

32 
boŞ
 
nod–ay
)

33 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "SudokuServer"),

34 
	`th»adPoŞ_
(),

35 
	`numTh»ads_
(
numTh»ads
),

36 
	`tıNoD–ay_
(
nod–ay
),

37 
	`¡¬tTime_
(
Time¡amp
::
	`now
()),

38 
	`¡©_
(
th»adPoŞ_
),

39 
	`š¥eùTh»ad_
(),

40 
	`š¥eùÜ_
(
š¥eùTh»ad_
.
	`¡¬tLoİ
(), 
	`IÃtAdd»ss
(9982), "sudoku-solver")

42 
LOG_INFO
 << "U£ " << 
numEv’tLoİs
 << " IOhreads.";

43 
LOG_INFO
 << "TCP‚Ød–ay " << 
nod–ay
;

45 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

46 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

47 
£rv”_
.
	`£tMes§geC®lback
(

48 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

49 
£rv”_
.
	`£tTh»adNum
(
numEv’tLoİs
);

51 
š¥eùÜ_
.
	`add
("sudoku", "¡©s", 
boo¡
::
	`bšd
(&
SudokuSt
::
»pÜt
, &
¡©_
),

53 
š¥eùÜ_
.
	`add
("sudoku", "»£t", 
boo¡
::
	`bšd
(&
SudokuSt
::
»£t
, &
¡©_
),

57 
	$¡¬t
()

59 
LOG_INFO
 << "S¹šg " << 
numTh»ads_
 << " computinghreads.";

60 
th»adPoŞ_
.
	`¡¬t
(
numTh»ads_
);

61 
£rv”_
.
	`¡¬t
();

62 
	}
}

64 
	g´iv©e
:

65 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

67 
LOG_TRACE
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

68 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

69 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

70 ià(
cÚn
->
	`cÚÃùed
(è&& 
tıNoD–ay_
)

71 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

72 
	}
}

74 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
»ûiveTime
)

76 
LOG_DEBUG
 << 
cÚn
->
	`Çme
();

77 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

78 
Ën
 >ğ
kC–ls
 + 2)

80 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

81 ià(
ülf
)

83 
¡ršg
 
	`»que¡
(
buf
->
	`³ek
(), 
ülf
);

84 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

85 
Ën
 = 
buf
->
	`»adabËBy‹s
();

86 
¡©_
.
	`»cÜdReque¡
();

87 ià(!
	`´oûssReque¡
(
cÚn
, 
»que¡
, 
»ûiveTime
))

89 
cÚn
->
	`£nd
("Bad Request!\r\n");

90 
cÚn
->
	`shutdown
();

91 
¡©_
.
	`»cÜdBadReque¡
();

95 ià(
Ën
 > 100)

97 
cÚn
->
	`£nd
("Idoo†ong!\r\n");

98 
cÚn
->
	`shutdown
();

99 
¡©_
.
	`»cÜdBadReque¡
();

107 
	}
}

109 
	sReque¡


111 
¡ršg
 
	gid
;

112 
¡ršg
 
	gpuzzË
;

113 
Time¡amp
 
	g»ûiveTime
;

116 
boŞ
 
	$´oûssReque¡
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, cÚ¡ 
¡ršg
& 
»que¡
, 
Time¡amp
 
»ûiveTime
)

118 
Reque¡
 
»q
;

119 
»q
.
»ûiveTime
 =„eceiveTime;

121 
¡ršg
::
cÚ¡_™”©Ü
 
cŞÚ
 = 
	`fšd
(
»que¡
.
	`begš
(),„eque¡.
	`’d
(), ':');

122 ià(
cŞÚ
 !ğ
»que¡
.
	`’d
())

124 
»q
.
id
.
	`assign
(
»que¡
.
	`begš
(), 
cŞÚ
);

125 
»q
.
puzzË
.
	`assign
(
cŞÚ
+1, 
»que¡
.
	`’d
());

130 ià(
numTh»ads_
 > 1)

131  
çl£
;

132 
»q
.
puzzË
 = 
»que¡
;

135 ià(
»q
.
puzzË
.
	`size
(è=ğ
im¶ic™_ÿ¡
<
size_t
>(
kC–ls
))

137 
th»adPoŞ_
.
	`run
(
boo¡
::
	`bšd
(&
SudokuS”v”
::
sŞve
, 
this
, 
cÚn
, 
»q
));

138  
Œue
;

140  
çl£
;

141 
	}
}

143 
	$sŞve
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, cÚ¡ 
Reque¡
& 
»q
)

145 
LOG_DEBUG
 << 
cÚn
->
	`Çme
();

146 
¡ršg
 
»suÉ
 = 
	`sŞveSudoku
(
»q
.
puzzË
);

147 ià(
»q
.
id
.
	`em±y
())

149 
cÚn
->
	`£nd
(
»suÉ
 + "\r\n");

153 
cÚn
->
	`£nd
(
»q
.
id
 + ":" + 
»suÉ
 + "\r\n");

155 
¡©_
.
	`»cÜdRe¥Ú£
(
Time¡amp
::
	`now
(), 
»q
.
»ûiveTime
, 
»suÉ
 !ğ
kNoSŞutiÚ
);

156 
	}
}

158 
TıS”v”
 
	g£rv”_
;

159 
Th»adPoŞ
 
	gth»adPoŞ_
;

160 cÚ¡ 
	gnumTh»ads_
;

161 cÚ¡ 
boŞ
 
	gtıNoD–ay_
;

162 cÚ¡ 
Time¡amp
 
	g¡¬tTime_
;

164 
SudokuSt
 
	g¡©_
;

165 
Ev’tLoİTh»ad
 
	gš¥eùTh»ad_
;

166 
In¥eùÜ
 
	gš¥eùÜ_
;

169 
	$maš
(
¬gc
, * 
¬gv
[])

171 
LOG_INFO
 << 
¬gv
[0] << " [number of IOhreads] [number of workerhreads] [-n]";

172 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

173 
numEv’tLoİs
 = 0;

174 
numTh»ads
 = 0;

175 
boŞ
 
nod–ay
 = 
çl£
;

176 ià(
¬gc
 > 1)

178 
numEv’tLoİs
 = 
	`©oi
(
¬gv
[1]);

180 ià(
¬gc
 > 2)

182 
numTh»ads
 = 
	`©oi
(
¬gv
[2]);

184 ià(
¬gc
 > 3 && 
	`¡ršg
(
¬gv
[3]) == "-n")

186 
nod–ay
 = 
Œue
;

189 
Ev’tLoİ
 
loİ
;

190 
IÃtAdd»ss
 
	`li¡’Addr
(9981);

191 
SudokuS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
numEv’tLoİs
, 
numTh»ads
, 
nod–ay
);

193 
£rv”
.
	`¡¬t
();

195 
loİ
.
	`loİ
();

196 
	}
}

	@examples/sudoku/server_multiloop.cc

1 
	~"sudoku.h
"

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/Ãt/Ev’tLoİ.h
>

7 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<muduo/Ãt/TıS”v”.h
>

10 
	~<boo¡/bšd.hµ
>

12 
	~<ut™y
>

14 
	~<¡dio.h
>

15 
	~<uni¡d.h
>

17 
usšg
 
Çme¥aû
 
	gmuduo
;

18 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

20 şas 
	cSudokuS”v”


22 
	mpublic
:

23 
	$SudokuS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, 
numTh»ads
)

24 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "SudokuServer"),

25 
	`numTh»ads_
(
numTh»ads
),

26 
	`¡¬tTime_
(
Time¡amp
::
	$now
())

28 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

29 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

30 
£rv”_
.
	`£tMes§geC®lback
(

31 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

32 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

35 
	$¡¬t
()

37 
LOG_INFO
 << "¡¬tšg " << 
numTh»ads_
 << "hreads.";

38 
£rv”_
.
	`¡¬t
();

39 
	}
}

41 
	g´iv©e
:

42 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

44 
LOG_TRACE
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

45 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

46 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

47 
	}
}

49 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

51 
LOG_DEBUG
 << 
cÚn
->
	`Çme
();

52 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

53 
Ën
 >ğ
kC–ls
 + 2)

55 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

56 ià(
ülf
)

58 
¡ršg
 
	`»que¡
(
buf
->
	`³ek
(), 
ülf
);

59 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

60 
Ën
 = 
buf
->
	`»adabËBy‹s
();

61 ià(!
	`´oûssReque¡
(
cÚn
, 
»que¡
))

63 
cÚn
->
	`£nd
("Bad Request!\r\n");

64 
cÚn
->
	`shutdown
();

68 ià(
Ën
 > 100)

70 
cÚn
->
	`£nd
("Idoo†ong!\r\n");

71 
cÚn
->
	`shutdown
();

79 
	}
}

81 
boŞ
 
	$´oûssReque¡
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, cÚ¡ 
¡ršg
& 
»que¡
)

83 
¡ršg
 
id
;

84 
¡ršg
 
puzzË
;

85 
boŞ
 
goodReque¡
 = 
Œue
;

87 
¡ršg
::
cÚ¡_™”©Ü
 
cŞÚ
 = 
	`fšd
(
»que¡
.
	`begš
(),„eque¡.
	`’d
(), ':');

88 ià(
cŞÚ
 !ğ
»que¡
.
	`’d
())

90 
id
.
	`assign
(
»que¡
.
	`begš
(), 
cŞÚ
);

91 
puzzË
.
	`assign
(
cŞÚ
+1, 
»que¡
.
	`’d
());

95 
puzzË
 = 
»que¡
;

98 ià(
puzzË
.
	`size
(è=ğ
im¶ic™_ÿ¡
<
size_t
>(
kC–ls
))

100 
LOG_DEBUG
 << 
cÚn
->
	`Çme
();

101 
¡ršg
 
»suÉ
 = 
	`sŞveSudoku
(
puzzË
);

102 ià(
id
.
	`em±y
())

104 
cÚn
->
	`£nd
(
»suÉ
+"\r\n");

108 
cÚn
->
	`£nd
(
id
+":"+
»suÉ
+"\r\n");

113 
goodReque¡
 = 
çl£
;

115  
goodReque¡
;

116 
	}
}

118 
TıS”v”
 
	g£rv”_
;

119 
	gnumTh»ads_
;

120 
Time¡amp
 
	g¡¬tTime_
;

123 
	$maš
(
¬gc
, * 
¬gv
[])

125 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

126 
numTh»ads
 = 0;

127 ià(
¬gc
 > 1)

129 
numTh»ads
 = 
	`©oi
(
¬gv
[1]);

131 
Ev’tLoİ
 
loİ
;

132 
IÃtAdd»ss
 
	`li¡’Addr
(9981);

133 
SudokuS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
numTh»ads
);

135 
£rv”
.
	`¡¬t
();

137 
loİ
.
	`loİ
();

138 
	}
}

	@examples/sudoku/server_prod.cc

1 
	~"sudoku.h
"

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/ba£/Th»adPoŞ.h
>

7 
	~<muduo/Ãt/Ev’tLoİ.h
>

8 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

9 
	~<muduo/Ãt/IÃtAdd»ss.h
>

10 
	~<muduo/Ãt/TıS”v”.h
>

11 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

13 
	~<boo¡/bšd.hµ
>

14 
	~<boo¡/cœcuÏr_bufãr.hµ
>

15 
	~<boo¡/nÚcİyabË.hµ
>

20 
usšg
 
Çme¥aû
 
	gmuduo
;

21 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

23 
	~"¡©.h
"

25 şas 
	cSudokuS”v”
 : 
boo¡
::
nÚcİyabË


27 
public
:

28 
	$SudokuS”v”
(
Ev’tLoİ
* 
loİ
,

29 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

30 
numEv’tLoİs
,

31 
numTh»ads
,

32 
boŞ
 
nod–ay
)

33 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "SudokuServer"),

34 
	`th»adPoŞ_
(),

35 
	`numTh»ads_
(
numTh»ads
),

36 
	`tıNoD–ay_
(
nod–ay
),

37 
	`¡¬tTime_
(
Time¡amp
::
	`now
()),

38 
	`¡©_
(
th»adPoŞ_
),

39 
	`š¥eùTh»ad_
(),

40 
	`š¥eùÜ_
(
š¥eùTh»ad_
.
	`¡¬tLoİ
(), 
	`IÃtAdd»ss
(9982), "sudoku-solver")

42 
LOG_INFO
 << "U£ " << 
numEv’tLoİs
 << " IOhreads.";

43 
LOG_INFO
 << "TCP‚Ød–ay " << 
nod–ay
;

45 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

46 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

47 
£rv”_
.
	`£tMes§geC®lback
(

48 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

49 
£rv”_
.
	`£tTh»adNum
(
numEv’tLoİs
);

51 
š¥eùÜ_
.
	`add
("sudoku", "¡©s", 
boo¡
::
	`bšd
(&
SudokuSt
::
»pÜt
, &
¡©_
),

53 
š¥eùÜ_
.
	`add
("sudoku", "»£t", 
boo¡
::
	`bšd
(&
SudokuSt
::
»£t
, &
¡©_
),

57 
	$¡¬t
()

59 
LOG_INFO
 << "S¹šg " << 
numTh»ads_
 << " computinghreads.";

60 
th»adPoŞ_
.
	`¡¬t
(
numTh»ads_
);

61 
£rv”_
.
	`¡¬t
();

62 
	}
}

64 
	g´iv©e
:

65 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

67 
LOG_TRACE
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

68 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

69 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

70 ià(
cÚn
->
	`cÚÃùed
())

72 ià(
tıNoD–ay_
)

73 
cÚn
->
	`£tTıNoD–ay
(
Œue
);

74 
cÚn
->
	`£tHighW©”M¬kC®lback
(

75 
boo¡
::
	`bšd
(&
SudokuS”v”
::
highW©”M¬k
, 
this
, 
_1
, 
_2
), 5 * 1024 * 1024);

76 
boŞ
 
thrÙe
 = 
çl£
;

77 
cÚn
->
	`£tCÚ‹xt
(
thrÙe
);

79 
	}
}

81 
	$highW©”M¬k
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
size_t
 
to£nd
)

83 
LOG_WARN
 << 
cÚn
->
	`Çme
(è<< " high w©” m¬k " << 
to£nd
;

84 ià(
to£nd
 < 10 * 1024 * 1024)

86 
cÚn
->
	`£tHighW©”M¬kC®lback
(

87 
boo¡
::
	`bšd
(&
SudokuS”v”
::
highW©”M¬k
, 
this
, 
_1
, 
_2
), 10 * 1024 * 1024);

88 
cÚn
->
	`£tWr™eCom¶‘eC®lback
(
boo¡
::
	`bšd
(&
SudokuS”v”
::
wr™eCom¶‘e
, 
this
, 
_1
));

89 
boŞ
 
thrÙe
 = 
Œue
;

90 
cÚn
->
	`£tCÚ‹xt
(
thrÙe
);

94 
cÚn
->
	`£nd
("Bad Request!\r\n");

95 
cÚn
->
	`shutdown
();

96 
¡©_
.
	`»cÜdBadReque¡
();

98 
	}
}

100 
	$wr™eCom¶‘e
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

102 
LOG_INFO
 << 
cÚn
->
	`Çme
() << " write complete";

103 
cÚn
->
	`£tHighW©”M¬kC®lback
(

104 
boo¡
::
	`bšd
(&
SudokuS”v”
::
highW©”M¬k
, 
this
, 
_1
, 
_2
), 5 * 1024 * 1024);

105 
cÚn
->
	`£tWr™eCom¶‘eC®lback
(
	`Wr™eCom¶‘eC®lback
());

106 
boŞ
 
thrÙe
 = 
çl£
;

107 
cÚn
->
	`£tCÚ‹xt
(
thrÙe
);

108 
	}
}

110 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
»ûiveTime
)

112 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

113 
Ën
 >ğ
kC–ls
 + 2)

115 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

116 ià(
ülf
)

118 
¡ršg
 
	`»que¡
(
buf
->
	`³ek
(), 
ülf
);

119 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

120 
Ën
 = 
buf
->
	`»adabËBy‹s
();

121 
¡©_
.
	`»cÜdReque¡
();

122 ià(!
	`´oûssReque¡
(
cÚn
, 
»que¡
, 
»ûiveTime
))

124 
cÚn
->
	`£nd
("Bad Request!\r\n");

125 
cÚn
->
	`shutdown
();

126 
¡©_
.
	`»cÜdBadReque¡
();

130 ià(
Ën
 > 100)

132 
cÚn
->
	`£nd
("Idoo†ong!\r\n");

133 
cÚn
->
	`shutdown
();

134 
¡©_
.
	`»cÜdBadReque¡
();

142 
	}
}

144 
	sReque¡


146 
¡ršg
 
	gid
;

147 
¡ršg
 
	gpuzzË
;

148 
Time¡amp
 
	g»ûiveTime
;

151 
boŞ
 
	$´oûssReque¡
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, cÚ¡ 
¡ršg
& 
»que¡
, 
Time¡amp
 
»ûiveTime
)

153 
Reque¡
 
»q
;

154 
»q
.
»ûiveTime
 =„eceiveTime;

156 
¡ršg
::
cÚ¡_™”©Ü
 
cŞÚ
 = 
	`fšd
(
»que¡
.
	`begš
(),„eque¡.
	`’d
(), ':');

157 ià(
cŞÚ
 !ğ
»que¡
.
	`’d
())

159 
»q
.
id
.
	`assign
(
»que¡
.
	`begš
(), 
cŞÚ
);

160 
»q
.
puzzË
.
	`assign
(
cŞÚ
+1, 
»que¡
.
	`’d
());

165 ià(
numTh»ads_
 > 1)

166  
çl£
;

167 
»q
.
puzzË
 = 
»que¡
;

170 ià(
»q
.
puzzË
.
	`size
(è=ğ
im¶ic™_ÿ¡
<
size_t
>(
kC–ls
))

172 
boŞ
 
thrÙe
 = 
boo¡
::
ªy_ÿ¡
<boŞ>(
cÚn
->
	`g‘CÚ‹xt
());

173 ià(
th»adPoŞ_
.
	`queueSize
(è< 1000 * 1000 && !
thrÙe
)

175 
th»adPoŞ_
.
	`run
(
boo¡
::
	`bšd
(&
SudokuS”v”
::
sŞve
, 
this
, 
cÚn
, 
»q
));

179 ià(
»q
.
id
.
	`em±y
())

181 
cÚn
->
	`£nd
("ServerTooBusy\r\n");

185 
cÚn
->
	`£nd
(
»q
.
id
 + ":ServerTooBusy\r\n");

187 
¡©_
.
	`»cÜdDrİ³dReque¡
();

189  
Œue
;

191  
çl£
;

192 
	}
}

194 
	$sŞve
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, cÚ¡ 
Reque¡
& 
»q
)

196 
LOG_DEBUG
 << 
cÚn
->
	`Çme
();

197 
¡ršg
 
»suÉ
 = 
	`sŞveSudoku
(
»q
.
puzzË
);

198 ià(
»q
.
id
.
	`em±y
())

200 
cÚn
->
	`£nd
(
»suÉ
 + "\r\n");

204 
cÚn
->
	`£nd
(
»q
.
id
 + ":" + 
»suÉ
 + "\r\n");

206 
¡©_
.
	`»cÜdRe¥Ú£
(
Time¡amp
::
	`now
(), 
»q
.
»ûiveTime
, 
»suÉ
 !ğ
kNoSŞutiÚ
);

207 
	}
}

209 
TıS”v”
 
	g£rv”_
;

210 
Th»adPoŞ
 
	gth»adPoŞ_
;

211 cÚ¡ 
	gnumTh»ads_
;

212 cÚ¡ 
boŞ
 
	gtıNoD–ay_
;

213 cÚ¡ 
Time¡amp
 
	g¡¬tTime_
;

215 
SudokuSt
 
	g¡©_
;

216 
Ev’tLoİTh»ad
 
	gš¥eùTh»ad_
;

217 
In¥eùÜ
 
	gš¥eùÜ_
;

220 
	$maš
(
¬gc
, * 
¬gv
[])

222 
LOG_INFO
 << 
¬gv
[0] << " [number of IOhreads] [number of workerhreads] [-n]";

223 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

224 
numEv’tLoİs
 = 0;

225 
numTh»ads
 = 0;

226 
boŞ
 
nod–ay
 = 
çl£
;

227 ià(
¬gc
 > 1)

229 
numEv’tLoİs
 = 
	`©oi
(
¬gv
[1]);

231 ià(
¬gc
 > 2)

233 
numTh»ads
 = 
	`©oi
(
¬gv
[2]);

235 ià(
¬gc
 > 3 && 
	`¡ršg
(
¬gv
[3]) == "-n")

237 
nod–ay
 = 
Œue
;

240 
Ev’tLoİ
 
loİ
;

241 
IÃtAdd»ss
 
	`li¡’Addr
(9981);

242 
SudokuS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
numEv’tLoİs
, 
numTh»ads
, 
nod–ay
);

244 
£rv”
.
	`¡¬t
();

246 
loİ
.
	`loİ
();

247 
	}
}

	@examples/sudoku/server_threadpool.cc

1 
	~"sudoku.h
"

3 
	~<muduo/ba£/Atomic.h
>

4 
	~<muduo/ba£/Loggšg.h
>

5 
	~<muduo/ba£/Th»ad.h
>

6 
	~<muduo/ba£/Th»adPoŞ.h
>

7 
	~<muduo/Ãt/Ev’tLoİ.h
>

8 
	~<muduo/Ãt/IÃtAdd»ss.h
>

9 
	~<muduo/Ãt/TıS”v”.h
>

11 
	~<boo¡/bšd.hµ
>

13 
	~<ut™y
>

15 
	~<¡dio.h
>

16 
	~<uni¡d.h
>

18 
usšg
 
Çme¥aû
 
	gmuduo
;

19 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

21 şas 
	cSudokuS”v”


23 
	mpublic
:

24 
	$SudokuS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, 
numTh»ads
)

25 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "SudokuServer"),

26 
	`numTh»ads_
(
numTh»ads
),

27 
	`¡¬tTime_
(
Time¡amp
::
	$now
())

29 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

30 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

31 
£rv”_
.
	`£tMes§geC®lback
(

32 
boo¡
::
	`bšd
(&
SudokuS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

35 
	$¡¬t
()

37 
LOG_INFO
 << "¡¬tšg " << 
numTh»ads_
 << "hreads.";

38 
th»adPoŞ_
.
	`¡¬t
(
numTh»ads_
);

39 
£rv”_
.
	`¡¬t
();

40 
	}
}

42 
	g´iv©e
:

43 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

45 
LOG_TRACE
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

46 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

47 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

48 
	}
}

50 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

52 
LOG_DEBUG
 << 
cÚn
->
	`Çme
();

53 
size_t
 
Ën
 = 
buf
->
	`»adabËBy‹s
();

54 
Ën
 >ğ
kC–ls
 + 2)

56 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

57 ià(
ülf
)

59 
¡ršg
 
	`»que¡
(
buf
->
	`³ek
(), 
ülf
);

60 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

61 
Ën
 = 
buf
->
	`»adabËBy‹s
();

62 ià(!
	`´oûssReque¡
(
cÚn
, 
»que¡
))

64 
cÚn
->
	`£nd
("Bad Request!\r\n");

65 
cÚn
->
	`shutdown
();

69 ià(
Ën
 > 100)

71 
cÚn
->
	`£nd
("Idoo†ong!\r\n");

72 
cÚn
->
	`shutdown
();

80 
	}
}

82 
boŞ
 
	$´oûssReque¡
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, cÚ¡ 
¡ršg
& 
»que¡
)

84 
¡ršg
 
id
;

85 
¡ršg
 
puzzË
;

86 
boŞ
 
goodReque¡
 = 
Œue
;

88 
¡ršg
::
cÚ¡_™”©Ü
 
cŞÚ
 = 
	`fšd
(
»que¡
.
	`begš
(),„eque¡.
	`’d
(), ':');

89 ià(
cŞÚ
 !ğ
»que¡
.
	`’d
())

91 
id
.
	`assign
(
»que¡
.
	`begš
(), 
cŞÚ
);

92 
puzzË
.
	`assign
(
cŞÚ
+1, 
»que¡
.
	`’d
());

96 
puzzË
 = 
»que¡
;

99 ià(
puzzË
.
	`size
(è=ğ
im¶ic™_ÿ¡
<
size_t
>(
kC–ls
))

101 
th»adPoŞ_
.
	`run
(
boo¡
::
	`bšd
(&
sŞve
, 
cÚn
, 
puzzË
, 
id
));

105 
goodReque¡
 = 
çl£
;

107  
goodReque¡
;

108 
	}
}

110 
	$sŞve
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

111 cÚ¡ 
¡ršg
& 
puzzË
,

112 cÚ¡ 
¡ršg
& 
id
)

114 
LOG_DEBUG
 << 
cÚn
->
	`Çme
();

115 
¡ršg
 
»suÉ
 = 
	`sŞveSudoku
(
puzzË
);

116 ià(
id
.
	`em±y
())

118 
cÚn
->
	`£nd
(
»suÉ
+"\r\n");

122 
cÚn
->
	`£nd
(
id
+":"+
»suÉ
+"\r\n");

124 
	}
}

126 
TıS”v”
 
	g£rv”_
;

127 
Th»adPoŞ
 
	gth»adPoŞ_
;

128 
	gnumTh»ads_
;

129 
Time¡amp
 
	g¡¬tTime_
;

132 
	$maš
(
¬gc
, * 
¬gv
[])

134 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

135 
numTh»ads
 = 0;

136 ià(
¬gc
 > 1)

138 
numTh»ads
 = 
	`©oi
(
¬gv
[1]);

140 
Ev’tLoİ
 
loİ
;

141 
IÃtAdd»ss
 
	`li¡’Addr
(9981);

142 
SudokuS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, 
numTh»ads
);

144 
£rv”
.
	`¡¬t
();

146 
loİ
.
	`loİ
();

147 
	}
}

	@examples/sudoku/stat.h

3 şas 
	cSudokuSt
 : 
boo¡
::
nÚcİyabË


5 
public
:

6 
	$SudokuSt
(cÚ¡ 
Th»adPoŞ
& 
poŞ
)

7 : 
	`poŞ_
(
poŞ
),

8 
	`Ï¡SecÚd_
(0),

9 
	`»que¡s_
(
kSecÚds
),

10 
	`Ï‹nc›s_
(
kSecÚds
),

11 
	`tÙ®Reque¡s_
(0),

12 
	`tÙ®Re¥Ú£s_
(0),

13 
	`tÙ®SŞved_
(0),

14 
	`badReque¡s_
(0),

15 
	`drİ³dReque¡s_
(0),

16 
	`tÙ®L©’cy_
(0),

17 
	$badL©’cy_
(0)

21 
¡ršg
 
	$»pÜt
() const

23 
LogSŒ—m
 
»suÉ
;

24 
size_t
 
queueSize
 = 
poŞ_
.
	`queueSize
();

25 
»suÉ
 << "sk_queue_siz" << 
queueSize
 << '\n';

28 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

29 
»suÉ
 << "tÙ®_»que¡ " << 
tÙ®Reque¡s_
 << '\n';

30 
»suÉ
 << "tÙ®_»¥Ú£ " << 
tÙ®Re¥Ú£s_
 << '\n';

31 
»suÉ
 << "tÙ®_sŞved " << 
tÙ®SŞved_
 << '\n';

32 
»suÉ
 << "bad_»que¡ " << 
badReque¡s_
 << '\n';

33 
»suÉ
 << "drİ³d_»que¡ " << 
drİ³dReque¡s_
 << '\n';

34 
»suÉ
 << "Ï‹ncy_sum_u " << 
tÙ®L©’cy_
 << '\n';

35 ià(
badL©’cy_
 > 0)

37 
»suÉ
 << "bad_Ï‹ncy" << 
badL©’cy_
 << '\n';

40 
»suÉ
 << "Ï¡_£cÚd " << 
Ï¡SecÚd_
 << '\n';

41 
št64_t
 
»que¡s
 = 0;

42 
»suÉ
 << "requests_per_second";

43 
size_t
 
i
 = 0; i < 
»que¡s_
.
	`size
(); ++i)

45 
»que¡s
 +ğ
»que¡s_
[
i
];

46 
»suÉ
 << ' ' << 
»que¡s_
[
i
];

48 
»suÉ
 << '\n';

49 
»suÉ
 << "»que¡s_60 " << 
»que¡s
 << '\n';

51 
št64_t
 
Ï‹ncy
 = 0;

52 
»suÉ
 << "latency_sum_us_per_second";

53 
size_t
 
i
 = 0; i < 
Ï‹nc›s_
.
	`size
(); ++i)

55 
Ï‹ncy
 +ğ
Ï‹nc›s_
[
i
];

56 
»suÉ
 << ' ' << 
Ï‹nc›s_
[
i
];

58 
»suÉ
 << '\n';

59 
»suÉ
 << "Ï‹ncy_sum_us_60 " << 
Ï‹ncy
 << '\n';

60 
št64_t
 
Ï‹ncyAvg60s
 = 
»que¡s
 =ğ0 ? 0 : 
Ï‹ncy
 /„equests;

61 
»suÉ
 << "Ï‹ncy_us_60 " << 
Ï‹ncyAvg60s
 << '\n';

62 
št64_t
 
Ï‹ncyAvg
 = 
tÙ®Re¥Ú£s_
 =ğ0 ? 0 : 
tÙ®L©’cy_
 /otalResponses_;

63 
»suÉ
 << "Ï‹ncy_us_avg " << 
Ï‹ncyAvg
 << '\n';

65  
»suÉ
.
	`bufãr
().
	`toSŒšg
();

66 
	}
}

68 
¡ršg
 
	$»£t
()

71 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

72 
Ï¡SecÚd_
 = 0;

73 
»que¡s_
.
	`ş—r
();

74 
Ï‹nc›s_
.
	`ş—r
();

75 
tÙ®Reque¡s_
 = 0;

76 
tÙ®Re¥Ú£s_
 = 0;

77 
tÙ®SŞved_
 = 0;

78 
badReque¡s_
 = 0;

79 
tÙ®L©’cy_
 = 0;

80 
badL©’cy_
 = 0;

83 
	}
}

85 
	$»cÜdRe¥Ú£
(
Time¡amp
 
now
, Time¡am°
»ûive
, 
boŞ
 
sŞved
)

87 cÚ¡ 
time_t
 
£cÚd
 = 
now
.
	`£cÚdsSšûEpoch
();

88 cÚ¡ 
št64_t
 
–­£d_us
 = 
now
.
	`miüoSecÚdsSšûEpoch
(è- 
»ûive
.microSecondsSinceEpoch();

89 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

90 
	`as£¹
(
»que¡s_
.
	`size
(è=ğ
Ï‹nc›s_
.size());

91 ++
tÙ®Re¥Ú£s_
;

92 ià(
sŞved
)

93 ++
tÙ®SŞved_
;

94 ià(
–­£d_us
 < 0)

96 ++
badL©’cy_
;

99 
tÙ®L©’cy_
 +ğ
–­£d_us
;

101 cÚ¡ 
time_t
 
fœ¡SecÚd
 = 
Ï¡SecÚd_
 - 
¡©ic_ÿ¡
<
ssize_t
>(
»que¡s_
.
	`size
()) + 1;

102 ià(
Ï¡SecÚd_
 =ğ
£cÚd
)

105 ++
»que¡s_
.
	`back
();

106 
Ï‹nc›s_
.
	`back
(è+ğ
–­£d_us
;

108 ià(
Ï¡SecÚd_
 + 1 =ğ
£cÚd
 ||†astSecond_ == 0)

111 
Ï¡SecÚd_
 = 
£cÚd
;

112 
»que¡s_
.
	`push_back
(0);

113 
Ï‹nc›s_
.
	`push_back
(0);

114 ++
»que¡s_
.
	`back
();

115 
Ï‹nc›s_
.
	`back
(è+ğ
–­£d_us
;

117 ià(
£cÚd
 > 
Ï¡SecÚd_
)

120 ià(
£cÚd
 < 
Ï¡SecÚd_
 + 
kSecÚds
)

123 
Ï¡SecÚd_
 < 
£cÚd
)

125 
»que¡s_
.
	`push_back
(0);

126 
Ï‹nc›s_
.
	`push_back
(0);

127 ++
Ï¡SecÚd_
;

133 
»que¡s_
.
	`ş—r
();

134 
Ï‹nc›s_
.
	`ş—r
();

135 
Ï¡SecÚd_
 = 
£cÚd
;

136 
»que¡s_
.
	`push_back
(0);

137 
Ï‹nc›s_
.
	`push_back
(0);

139 ++
»que¡s_
.
	`back
();

140 
Ï‹nc›s_
.
	`back
(è+ğ
–­£d_us
;

142 ià(
£cÚd
 >ğ
fœ¡SecÚd
)

148 
size_t
 
idx
 = 
£cÚd
 - 
fœ¡SecÚd
;

149 
	`as£¹
(
idx
 < 
»que¡s_
.
	`size
());

150 ++
»que¡s_
[
idx
];

151 
Ï‹nc›s_
[
idx
] +ğ
–­£d_us
;

155 
	`as£¹
(
£cÚd
 < 
fœ¡SecÚd
);

159 
	`as£¹
(
»que¡s_
.
	`size
(è=ğ
Ï‹nc›s_
.size());

160 
	}
}

162 
	$»cÜdReque¡
()

164 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

165 ++
tÙ®Reque¡s_
;

166 
	}
}

168 
	$»cÜdBadReque¡
()

170 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

171 ++
badReque¡s_
;

172 
	}
}

174 
	$»cÜdDrİ³dReque¡
()

176 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

177 ++
drİ³dReque¡s_
;

178 
	}
}

180 
	g´iv©e
:

181 cÚ¡ 
Th»adPoŞ
& 
poŞ_
;

182 
mubË
 
Mu‹xLock
 
	gmu‹x_
;

187 
time_t
 
	gÏ¡SecÚd_
;

188 
	gboo¡
::
cœcuÏr_bufãr
<
št64_t
> 
»que¡s_
;

189 
	gboo¡
::
cœcuÏr_bufãr
<
št64_t
> 
Ï‹nc›s_
;

190 
št64_t
 
	gtÙ®Reque¡s_
, 
	gtÙ®Re¥Ú£s_
, 
	gtÙ®SŞved_
, 
	gbadReque¡s_
, 
	gdrİ³dReque¡s_
, 
	gtÙ®L©’cy_
, 
	gbadL©’cy_
;

193 cÚ¡ 
	gkSecÚds
 = 60;

	@examples/sudoku/stat.h

3 şas 
	cSudokuSt
 : 
boo¡
::
nÚcİyabË


5 
public
:

6 
	$SudokuSt
(cÚ¡ 
Th»adPoŞ
& 
poŞ
)

7 : 
	`poŞ_
(
poŞ
),

8 
	`Ï¡SecÚd_
(0),

9 
	`»que¡s_
(
kSecÚds
),

10 
	`Ï‹nc›s_
(
kSecÚds
),

11 
	`tÙ®Reque¡s_
(0),

12 
	`tÙ®Re¥Ú£s_
(0),

13 
	`tÙ®SŞved_
(0),

14 
	`badReque¡s_
(0),

15 
	`drİ³dReque¡s_
(0),

16 
	`tÙ®L©’cy_
(0),

17 
	$badL©’cy_
(0)

21 
¡ršg
 
	$»pÜt
() const

23 
LogSŒ—m
 
»suÉ
;

24 
size_t
 
queueSize
 = 
poŞ_
.
	`queueSize
();

25 
»suÉ
 << "sk_queue_siz" << 
queueSize
 << '\n';

28 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

29 
»suÉ
 << "tÙ®_»que¡ " << 
tÙ®Reque¡s_
 << '\n';

30 
»suÉ
 << "tÙ®_»¥Ú£ " << 
tÙ®Re¥Ú£s_
 << '\n';

31 
»suÉ
 << "tÙ®_sŞved " << 
tÙ®SŞved_
 << '\n';

32 
»suÉ
 << "bad_»que¡ " << 
badReque¡s_
 << '\n';

33 
»suÉ
 << "drİ³d_»que¡ " << 
drİ³dReque¡s_
 << '\n';

34 
»suÉ
 << "Ï‹ncy_sum_u " << 
tÙ®L©’cy_
 << '\n';

35 ià(
badL©’cy_
 > 0)

37 
»suÉ
 << "bad_Ï‹ncy" << 
badL©’cy_
 << '\n';

40 
»suÉ
 << "Ï¡_£cÚd " << 
Ï¡SecÚd_
 << '\n';

41 
št64_t
 
»que¡s
 = 0;

42 
»suÉ
 << "requests_per_second";

43 
size_t
 
i
 = 0; i < 
»que¡s_
.
	`size
(); ++i)

45 
»que¡s
 +ğ
»que¡s_
[
i
];

46 
»suÉ
 << ' ' << 
»que¡s_
[
i
];

48 
»suÉ
 << '\n';

49 
»suÉ
 << "»que¡s_60 " << 
»que¡s
 << '\n';

51 
št64_t
 
Ï‹ncy
 = 0;

52 
»suÉ
 << "latency_sum_us_per_second";

53 
size_t
 
i
 = 0; i < 
Ï‹nc›s_
.
	`size
(); ++i)

55 
Ï‹ncy
 +ğ
Ï‹nc›s_
[
i
];

56 
»suÉ
 << ' ' << 
Ï‹nc›s_
[
i
];

58 
»suÉ
 << '\n';

59 
»suÉ
 << "Ï‹ncy_sum_us_60 " << 
Ï‹ncy
 << '\n';

60 
št64_t
 
Ï‹ncyAvg60s
 = 
»que¡s
 =ğ0 ? 0 : 
Ï‹ncy
 /„equests;

61 
»suÉ
 << "Ï‹ncy_us_60 " << 
Ï‹ncyAvg60s
 << '\n';

62 
št64_t
 
Ï‹ncyAvg
 = 
tÙ®Re¥Ú£s_
 =ğ0 ? 0 : 
tÙ®L©’cy_
 /otalResponses_;

63 
»suÉ
 << "Ï‹ncy_us_avg " << 
Ï‹ncyAvg
 << '\n';

65  
»suÉ
.
	`bufãr
().
	`toSŒšg
();

66 
	}
}

68 
¡ršg
 
	$»£t
()

71 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

72 
Ï¡SecÚd_
 = 0;

73 
»que¡s_
.
	`ş—r
();

74 
Ï‹nc›s_
.
	`ş—r
();

75 
tÙ®Reque¡s_
 = 0;

76 
tÙ®Re¥Ú£s_
 = 0;

77 
tÙ®SŞved_
 = 0;

78 
badReque¡s_
 = 0;

79 
tÙ®L©’cy_
 = 0;

80 
badL©’cy_
 = 0;

83 
	}
}

85 
	$»cÜdRe¥Ú£
(
Time¡amp
 
now
, Time¡am°
»ûive
, 
boŞ
 
sŞved
)

87 cÚ¡ 
time_t
 
£cÚd
 = 
now
.
	`£cÚdsSšûEpoch
();

88 cÚ¡ 
št64_t
 
–­£d_us
 = 
now
.
	`miüoSecÚdsSšûEpoch
(è- 
»ûive
.microSecondsSinceEpoch();

89 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

90 
	`as£¹
(
»que¡s_
.
	`size
(è=ğ
Ï‹nc›s_
.size());

91 ++
tÙ®Re¥Ú£s_
;

92 ià(
sŞved
)

93 ++
tÙ®SŞved_
;

94 ià(
–­£d_us
 < 0)

96 ++
badL©’cy_
;

99 
tÙ®L©’cy_
 +ğ
–­£d_us
;

101 cÚ¡ 
time_t
 
fœ¡SecÚd
 = 
Ï¡SecÚd_
 - 
¡©ic_ÿ¡
<
ssize_t
>(
»que¡s_
.
	`size
()) + 1;

102 ià(
Ï¡SecÚd_
 =ğ
£cÚd
)

105 ++
»que¡s_
.
	`back
();

106 
Ï‹nc›s_
.
	`back
(è+ğ
–­£d_us
;

108 ià(
Ï¡SecÚd_
 + 1 =ğ
£cÚd
 ||†astSecond_ == 0)

111 
Ï¡SecÚd_
 = 
£cÚd
;

112 
»que¡s_
.
	`push_back
(0);

113 
Ï‹nc›s_
.
	`push_back
(0);

114 ++
»que¡s_
.
	`back
();

115 
Ï‹nc›s_
.
	`back
(è+ğ
–­£d_us
;

117 ià(
£cÚd
 > 
Ï¡SecÚd_
)

120 ià(
£cÚd
 < 
Ï¡SecÚd_
 + 
kSecÚds
)

123 
Ï¡SecÚd_
 < 
£cÚd
)

125 
»que¡s_
.
	`push_back
(0);

126 
Ï‹nc›s_
.
	`push_back
(0);

127 ++
Ï¡SecÚd_
;

133 
»que¡s_
.
	`ş—r
();

134 
Ï‹nc›s_
.
	`ş—r
();

135 
Ï¡SecÚd_
 = 
£cÚd
;

136 
»que¡s_
.
	`push_back
(0);

137 
Ï‹nc›s_
.
	`push_back
(0);

139 ++
»que¡s_
.
	`back
();

140 
Ï‹nc›s_
.
	`back
(è+ğ
–­£d_us
;

142 ià(
£cÚd
 >ğ
fœ¡SecÚd
)

148 
size_t
 
idx
 = 
£cÚd
 - 
fœ¡SecÚd
;

149 
	`as£¹
(
idx
 < 
»que¡s_
.
	`size
());

150 ++
»que¡s_
[
idx
];

151 
Ï‹nc›s_
[
idx
] +ğ
–­£d_us
;

155 
	`as£¹
(
£cÚd
 < 
fœ¡SecÚd
);

159 
	`as£¹
(
»que¡s_
.
	`size
(è=ğ
Ï‹nc›s_
.size());

160 
	}
}

162 
	$»cÜdReque¡
()

164 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

165 ++
tÙ®Reque¡s_
;

166 
	}
}

168 
	$»cÜdBadReque¡
()

170 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

171 ++
badReque¡s_
;

172 
	}
}

174 
	$»cÜdDrİ³dReque¡
()

176 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

177 ++
drİ³dReque¡s_
;

178 
	}
}

180 
	g´iv©e
:

181 cÚ¡ 
Th»adPoŞ
& 
poŞ_
;

182 
mubË
 
Mu‹xLock
 
	gmu‹x_
;

187 
time_t
 
	gÏ¡SecÚd_
;

188 
	gboo¡
::
cœcuÏr_bufãr
<
št64_t
> 
»que¡s_
;

189 
	gboo¡
::
cœcuÏr_bufãr
<
št64_t
> 
Ï‹nc›s_
;

190 
št64_t
 
	gtÙ®Reque¡s_
, 
	gtÙ®Re¥Ú£s_
, 
	gtÙ®SŞved_
, 
	gbadReque¡s_
, 
	gdrİ³dReque¡s_
, 
	gtÙ®L©’cy_
, 
	gbadL©’cy_
;

193 cÚ¡ 
	gkSecÚds
 = 60;

	@examples/sudoku/stat_unittest.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/ba£/Th»ad.h
>

3 
	~<muduo/ba£/Th»adPoŞ.h
>

5 
	~<boo¡/cœcuÏr_bufãr.hµ
>

6 
	~<boo¡/nÚcİyabË.hµ
>

7 
	#BOOST_TEST_MAIN


	)

8 
	#BOOST_TEST_DYN_LINK


	)

9 
	~<boo¡/‹¡/un™_‹¡.hµ
>

11 
usšg
 
Çme¥aû
 
	gmuduo
;

13 
	~"¡©.h
"

15 
	~<¡dio.h
>

17 
	$BOOST_AUTO_TEST_CASE
(
‹¡SudokuStSameSecÚd
)

19 
Th»adPoŞ
 
p
;

20 
SudokuSt
 
	`s
(
p
);

22 
i
 = 0; i < 100; ++i)

24 
time_t
 
¡¬t
 = 1234567890;

25 
Time¡amp
 
»cv
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 0);

26 
Time¡amp
 
£nd
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 
i
);

27 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
i
 % 3 != 0);

29 
	`´štf
("§m£cÚd:\n%s\n", 
s
.
	`»pÜt
().
	`c_¡r
());

30 
	}
}

32 
	$BOOST_AUTO_TEST_CASE
(
‹¡SudokuStNextSecÚd
)

34 
Th»adPoŞ
 
p
;

35 
SudokuSt
 
	`s
(
p
);

37 
time_t
 
¡¬t
 = 1234567890;

38 
Time¡amp
 
»cv
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 0);

39 
Time¡amp
 
£nd
 = 
	`addTime
(
»cv
, 0.002);

40 
i
 = 0; i < 10000; ++i)

42 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

43 
»cv
 = 
	`addTime
(
£nd
, 0.01);

44 
£nd
 = 
	`addTime
(
»cv
, 0.02);

46 
	`´štf
("Ãxˆ£cÚd:\n%s\n", 
s
.
	`»pÜt
().
	`c_¡r
());

47 
	}
}

49 
	$BOOST_AUTO_TEST_CASE
(
‹¡SudokuStFuzz
)

51 
Th»adPoŞ
 
p
;

52 
SudokuSt
 
	`s
(
p
);

54 
time_t
 
¡¬t
 = 1234567890;

55 
	`¤ªd
(
¡©ic_ÿ¡
<>(
	`time
(
NULL
)));

56 
i
 = 0; i < 10000; ++i)

58 
Time¡amp
 
»cv
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 0);

59 
Time¡amp
 
£nd
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 200);

60 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

61 
jump
 = (
	`¿nd
() % 200) - 100;

63 
¡¬t
 +ğ
jump
;

65 
	}
}

67 
	$BOOST_AUTO_TEST_CASE
(
‹¡SudokuStJumpAh—d5
)

69 
Th»adPoŞ
 
p
;

70 
SudokuSt
 
	`s
(
p
);

72 
time_t
 
¡¬t
 = 1234567890;

73 
Time¡amp
 
»cv
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 0);

74 
Time¡amp
 
£nd
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 200);

75 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

77 
»cv
 = 
	`addTime
(recv, 4);

78 
£nd
 = 
	`addTime
(send, 5);

79 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

80 
	`´štf
("jum°ah—d 5 secÚds:\n%s\n", 
s
.
	`»pÜt
().
	`c_¡r
());

81 
	}
}

83 
	$BOOST_AUTO_TEST_CASE
(
‹¡SudokuStJumpAh—d59
)

85 
Th»adPoŞ
 
p
;

86 
SudokuSt
 
	`s
(
p
);

88 
time_t
 
¡¬t
 = 1234567890;

89 
Time¡amp
 
»cv
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 0);

90 
Time¡amp
 
£nd
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 200);

91 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

93 
»cv
 = 
	`addTime
(recv, 55);

94 
£nd
 = 
	`addTime
(send, 59);

95 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

96 
	`´štf
("jum°ah—d 59 secÚds:\n%s\n", 
s
.
	`»pÜt
().
	`c_¡r
());

97 
	}
}

99 
	$BOOST_AUTO_TEST_CASE
(
‹¡SudokuStJumpAh—d60
)

101 
Th»adPoŞ
 
p
;

102 
SudokuSt
 
	`s
(
p
);

104 
time_t
 
¡¬t
 = 1234567890;

105 
Time¡amp
 
»cv
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 0);

106 
Time¡amp
 
£nd
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 200);

107 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

109 
»cv
 = 
	`addTime
(recv, 58);

110 
£nd
 = 
	`addTime
(send, 60);

111 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

112 
	`´štf
("jum°ah—d 60 secÚds:\n%s\n", 
s
.
	`»pÜt
().
	`c_¡r
());

113 
	}
}

115 
	$BOOST_AUTO_TEST_CASE
(
‹¡SudokuStJumpBack3
)

117 
Th»adPoŞ
 
p
;

118 
SudokuSt
 
	`s
(
p
);

120 
time_t
 
¡¬t
 = 1234567890;

121 
Time¡amp
 
»cv
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 0);

122 
Time¡amp
 
£nd
 = Time¡amp::
	`äomUnixTime
(
¡¬t
, 200);

123 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

125 
»cv
 = 
	`addTime
(recv, 9);

126 
£nd
 = 
	`addTime
(send, 10);

127 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

129 
»cv
 = 
	`addTime
(recv, -4);

130 
£nd
 = 
	`addTime
(send, -3);

131 
s
.
	`»cÜdRe¥Ú£
(
£nd
, 
»cv
, 
Œue
);

133 
	`´štf
("jum°back 3 secÚds:\n%s\n", 
s
.
	`»pÜt
().
	`c_¡r
());

134 
	}
}

	@examples/sudoku/sudoku.cc

1 
	~"sudoku.h
"

3 
	~<veùÜ
>

4 
	~<as£¹.h
>

5 
	~<¡ršg.h
>

7 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
	gNode
;

13 
Node
 
	tCŞumn
;

14 
	sNode


16 
Node
* 
	mËá
;

17 
Node
* 
	mright
;

18 
Node
* 
	mup
;

19 
Node
* 
	mdown
;

20 
CŞumn
* 
	mcŞ
;

21 
	mÇme
;

22 
	msize
;

25 cÚ¡ 
	gkMaxNodes
 = 1 + 81*4 + 9*9*9*4;

27 cÚ¡ 
	gkRow
 = 100, 
	gkCŞ
 = 200, 
	gkBox
 = 300;

28 cÚ¡ 
kNoSŞutiÚ
[] = "NoSolution";

30 şas 
	cSudokuSŞv”


32 
	mpublic
:

33 
	$SudokuSŞv”
(
bßrd
[
kC–ls
])

34 : 
	`šout_
(
bßrd
),

35 
	$cur_node_
(0)

37 
¡ack_
.
	`»£rve
(100);

39 
roÙ_
 = 
	`Ãw_cŞumn
();

40 
roÙ_
->
Ëá
 =„oÙ_->
right
 =„oot_;

41 
	`mem£t
(
cŞumns_
, 0, (columns_));

43 
boŞ
 
rows
[
kC–ls
][10] = { {
çl£
} };

44 
boŞ
 
cŞs
[
kC–ls
][10] = { {
çl£
} };

45 
boŞ
 
boxes
[
kC–ls
][10] = { {
çl£
} };

47 
i
 = 0; i < 
kC–ls
; ++i) {

48 
row
 = 
i
 / 9;

49 
cŞ
 = 
i
 % 9;

50 
box
 = 
row
/3*3 + 
cŞ
/3;

51 
v®
 = 
šout_
[
i
];

52 
rows
[
row
][
v®
] = 
Œue
;

53 
cŞs
[
cŞ
][
v®
] = 
Œue
;

54 
boxes
[
box
][
v®
] = 
Œue
;

57 
i
 = 0; i < 
kC–ls
; ++i) {

58 ià(
šout_
[
i
] == 0) {

59 
	`­³nd_cŞumn
(
i
);

63 
i
 = 0; i < 9; ++i) {

64 
v
 = 1; v < 10; ++v) {

65 ià(!
rows
[
i
][
v
])

66 
	`­³nd_cŞumn
(
	`g‘_row_cŞ
(
i
, 
v
));

67 ià(!
cŞs
[
i
][
v
])

68 
	`­³nd_cŞumn
(
	`g‘_cŞ_cŞ
(
i
, 
v
));

69 ià(!
boxes
[
i
][
v
])

70 
	`­³nd_cŞumn
(
	`g‘_box_cŞ
(
i
, 
v
));

74 
i
 = 0; i < 
kC–ls
; ++i) {

75 ià(
šout_
[
i
] == 0) {

76 
row
 = 
i
 / 9;

77 
cŞ
 = 
i
 % 9;

78 
box
 = 
row
/3*3 + 
cŞ
/3;

80 
v
 = 1; v < 10; ++v) {

81 ià(!(
rows
[
row
][
v
] || 
cŞs
[
cŞ
][v] || 
boxes
[
box
][v])) {

82 
Node
* 
n0
 = 
	`Ãw_row
(
i
);

83 
Node
* 
Ä
 = 
	`Ãw_row
(
	`g‘_row_cŞ
(
row
, 
v
));

84 
Node
* 
nc
 = 
	`Ãw_row
(
	`g‘_cŞ_cŞ
(
cŞ
, 
v
));

85 
Node
* 
nb
 = 
	`Ãw_row
(
	`g‘_box_cŞ
(
box
, 
v
));

86 
	`put_Ëá
(
n0
, 
Ä
);

87 
	`put_Ëá
(
n0
, 
nc
);

88 
	`put_Ëá
(
n0
, 
nb
);

95 
boŞ
 
	$sŞve
()

97 ià(
roÙ_
->
Ëá
 ==„oot_) {

98 
size_t
 
i
 = 0; i < 
¡ack_
.
	`size
(); ++i) {

99 
Node
* 
n
 = 
¡ack_
[
i
];

100 
ûÎ
 = -1;

101 
v®
 = -1;

102 
ûÎ
 =ğ-1 || 
v®
 == -1) {

103 ià(
n
->
Çme
 < 100)

104 
ûÎ
 = 
n
->
Çme
;

106 
v®
 = 
n
->
Çme
 % 10;

107 
n
 =‚->
right
;

111 
šout_
[
ûÎ
] = 
v®
;

113  
Œue
;

116 
CŞumn
* cÚ¡ 
cŞ
 = 
	`g‘_mš_cŞumn
();

117 
	`cov”
(
cŞ
);

118 
Node
* 
row
 = 
cŞ
->
down
;„ow != col;„ow =„ow->down) {

119 
¡ack_
.
	`push_back
(
row
);

120 
Node
* 
j
 = 
row
->
right
; j !=„ow; j = j->right) {

121 
	`cov”
(
j
->
cŞ
);

123 ià(
	`sŞve
()) {

124  
Œue
;

126 
¡ack_
.
	`pİ_back
();

127 
Node
* 
j
 = 
row
->
Ëá
; j !=„ow; j = j->left) {

128 
	`uncov”
(
j
->
cŞ
);

131 
	`uncov”
(
cŞ
);

132  
çl£
;

133 
	}
}

135 
	g´iv©e
:

137 
CŞumn
* 
roÙ_
;

138 * 
	gšout_
;

139 
CŞumn
* 
	gcŞumns_
[400];

140 
	g¡d
::
veùÜ
<
Node
*> 
¡ack_
;

141 
Node
 
	gnodes_
[
kMaxNodes
];

142 
	gcur_node_
;

144 
CŞumn
* 
	$Ãw_cŞumn
(
n
 = 0)

146 
	`as£¹
(
cur_node_
 < 
kMaxNodes
);

147 
CŞumn
* 
c
 = &
nodes_
[
cur_node_
++];

148 
	`mem£t
(
c
, 0, (
CŞumn
));

149 
c
->
Ëá
 = c;

150 
c
->
right
 = c;

151 
c
->
up
 = c;

152 
c
->
down
 = c;

153 
c
->
cŞ
 = c;

154 
c
->
Çme
 = 
n
;

155  
c
;

156 
	}
}

158 
	$­³nd_cŞumn
(
n
)

160 
	`as£¹
(
cŞumns_
[
n
] =ğ
NULL
);

162 
CŞumn
* 
c
 = 
	`Ãw_cŞumn
(
n
);

163 
	`put_Ëá
(
roÙ_
, 
c
);

164 
cŞumns_
[
n
] = 
c
;

165 
	}
}

167 
Node
* 
	$Ãw_row
(
cŞ
)

169 
	`as£¹
(
cŞumns_
[
cŞ
] !ğ
NULL
);

170 
	`as£¹
(
cur_node_
 < 
kMaxNodes
);

172 
Node
* 
r
 = &
nodes_
[
cur_node_
++];

175 
	`mem£t
(
r
, 0, (
Node
));

176 
r
->
Ëá
 =„;

177 
r
->
right
 =„;

178 
r
->
up
 =„;

179 
r
->
down
 =„;

180 
r
->
Çme
 = 
cŞ
;

181 
r
->
cŞ
 = 
cŞumns_
[col];

182 
	`put_up
(
r
->
cŞ
,„);

183  
r
;

184 
	}
}

186 
	$g‘_row_cŞ
(
row
, 
v®
)

188  
kRow
+
row
*10+
v®
;

189 
	}
}

191 
	$g‘_cŞ_cŞ
(
cŞ
, 
v®
)

193  
kCŞ
+
cŞ
*10+
v®
;

194 
	}
}

196 
	$g‘_box_cŞ
(
box
, 
v®
)

198  
kBox
+
box
*10+
v®
;

199 
	}
}

201 
CŞumn
* 
	$g‘_mš_cŞumn
()

203 
CŞumn
* 
c
 = 
roÙ_
->
right
;

204 
mš_size
 = 
c
->
size
;

205 ià(
mš_size
 > 1) {

206 
CŞumn
* 
cc
 = 
c
->
right
; cø!ğ
roÙ_
; cc = cc->right) {

207 ià(
mš_size
 > 
cc
->
size
) {

208 
c
 = 
cc
;

209 
mš_size
 = 
cc
->
size
;

210 ià(
mš_size
 <= 1)

215  
c
;

216 
	}
}

218 
	$cov”
(
CŞumn
* 
c
)

220 
c
->
right
->
Ëá
 = c->left;

221 
c
->
Ëá
->
right
 = c->right;

222 
Node
* 
row
 = 
c
->
down
;„ow != c;„ow =„ow->down) {

223 
Node
* 
j
 = 
row
->
right
; j !=„ow; j = j->right) {

224 
j
->
down
->
up
 = j->up;

225 
j
->
up
->
down
 = j->down;

226 
j
->
cŞ
->
size
--;

229 
	}
}

231 
	$uncov”
(
CŞumn
* 
c
)

233 
Node
* 
row
 = 
c
->
up
;„ow != c;„ow =„ow->up) {

234 
Node
* 
j
 = 
row
->
Ëá
; j !=„ow; j = j->left) {

235 
j
->
cŞ
->
size
++;

236 
j
->
down
->
up
 = j;

237 
j
->
up
->
down
 = j;

240 
c
->
right
->
Ëá
 = c;

241 
c
->
Ëá
->
right
 = c;

242 
	}
}

244 
	$put_Ëá
(
CŞumn
* 
Şd
, CŞumn* 
Âew
)

246 
Âew
->
Ëá
 = 
Şd
->left;

247 
Âew
->
right
 = 
Şd
;

248 
Şd
->
Ëá
->
right
 = 
Âew
;

249 
Şd
->
Ëá
 = 
Âew
;

250 
	}
}

252 
	$put_up
(
CŞumn
* 
Şd
, 
Node
* 
Âew
)

254 
Âew
->
up
 = 
Şd
->up;

255 
Âew
->
down
 = 
Şd
;

256 
Şd
->
up
->
down
 = 
Âew
;

257 
Şd
->
up
 = 
Âew
;

258 
Şd
->
size
++;

259 
Âew
->
cŞ
 = 
Şd
;

260 
	}
}

263 
¡ršg
 
	$sŞveSudoku
(cÚ¡ 
SŒšgP›û
& 
puzzË
)

265 
	`as£¹
(
puzzË
.
	`size
(è=ğ
kC–ls
);

267 
¡ršg
 
»suÉ
 = 
kNoSŞutiÚ
;

269 
bßrd
[
kC–ls
] = { 0 };

270 
boŞ
 
v®id
 = 
Œue
;

271 
i
 = 0; i < 
kC–ls
; ++i)

273 
bßrd
[
i
] = 
puzzË
[i] - '0';

274 
v®id
 = v®id && (0 <ğ
bßrd
[
i
] && board[i] <= 9);

277 ià(
v®id
)

279 
SudokuSŞv”
 
	`s
(
bßrd
);

280 ià(
s
.
	`sŞve
())

282 
»suÉ
.
	`ş—r
();

283 
»suÉ
.
	`»size
(
kC–ls
);

284 
i
 = 0; i < 
kC–ls
; ++i)

286 
»suÉ
[
i
] = 
¡©ic_ÿ¡
<>(
bßrd
[i] + '0');

290  
»suÉ
;

291 
	}
}

	@examples/sudoku/sudoku.h

1 #iâdeà
MUDUO_EXAMPLES_SUDOKU_SUDOKU_H


2 
	#MUDUO_EXAMPLES_SUDOKU_SUDOKU_H


	)

5 
	~<muduo/ba£/Ty³s.h
>

6 
	~<muduo/ba£/SŒšgP›û.h
>

8 
	gmuduo
::
¡ršg
 
sŞveSudoku
(cÚ¡ 
muduo
::
SŒšgP›û
& 
puzzË
);

9 cÚ¡ 
	gkC–ls
 = 81;

10 cÚ¡ 
kNoSŞutiÚ
[];

	@examples/sudoku/sudoku.h

1 #iâdeà
MUDUO_EXAMPLES_SUDOKU_SUDOKU_H


2 
	#MUDUO_EXAMPLES_SUDOKU_SUDOKU_H


	)

5 
	~<muduo/ba£/Ty³s.h
>

6 
	~<muduo/ba£/SŒšgP›û.h
>

8 
	gmuduo
::
¡ršg
 
sŞveSudoku
(cÚ¡ 
muduo
::
SŒšgP›û
& 
puzzË
);

9 cÚ¡ 
	gkC–ls
 = 81;

10 cÚ¡ 
kNoSŞutiÚ
[];

	@examples/twisted/finger/finger01.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
usšg
 
Çme¥aû
 
	gmuduo
;

4 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

6 
	$maš
()

8 
Ev’tLoİ
 
loİ
;

9 
loİ
.
	`loİ
();

10 
	}
}

	@examples/twisted/finger/finger02.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

2 
	~<muduo/Ãt/TıS”v”.h
>

4 
usšg
 
Çme¥aû
 
	gmuduo
;

5 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

7 
	$maš
()

9 
Ev’tLoİ
 
loİ
;

10 
TıS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(1079), "Finger");

11 
£rv”
.
	`¡¬t
();

12 
loİ
.
	`loİ
();

13 
	}
}

	@examples/twisted/finger/finger03.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

2 
	~<muduo/Ãt/TıS”v”.h
>

4 
usšg
 
Çme¥aû
 
	gmuduo
;

5 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

7 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

9 ià(
cÚn
->
	`cÚÃùed
())

11 
cÚn
->
	`shutdown
();

13 
	}
}

15 
	$maš
()

17 
Ev’tLoİ
 
loİ
;

18 
TıS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(1079), "Finger");

19 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚCÚÃùiÚ
);

20 
£rv”
.
	`¡¬t
();

21 
loİ
.
	`loİ
();

22 
	}
}

	@examples/twisted/finger/finger04.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

2 
	~<muduo/Ãt/TıS”v”.h
>

4 
usšg
 
Çme¥aû
 
	gmuduo
;

5 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

7 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

8 
Bufãr
* 
buf
,

9 
Time¡amp
 
»ûiveTime
)

11 ià(
buf
->
	`fšdCRLF
())

13 
cÚn
->
	`shutdown
();

15 
	}
}

17 
	$maš
()

19 
Ev’tLoİ
 
loİ
;

20 
TıS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(1079), "Finger");

21 
£rv”
.
	`£tMes§geC®lback
(
ÚMes§ge
);

22 
£rv”
.
	`¡¬t
();

23 
loİ
.
	`loİ
();

24 
	}
}

	@examples/twisted/finger/finger05.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

2 
	~<muduo/Ãt/TıS”v”.h
>

4 
usšg
 
Çme¥aû
 
	gmuduo
;

5 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

7 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

8 
Bufãr
* 
buf
,

9 
Time¡amp
 
»ûiveTime
)

11 ià(
buf
->
	`fšdCRLF
())

13 
cÚn
->
	`£nd
("No such user\r\n");

14 
cÚn
->
	`shutdown
();

16 
	}
}

18 
	$maš
()

20 
Ev’tLoİ
 
loİ
;

21 
TıS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(1079), "Finger");

22 
£rv”
.
	`£tMes§geC®lback
(
ÚMes§ge
);

23 
£rv”
.
	`¡¬t
();

24 
loİ
.
	`loİ
();

25 
	}
}

	@examples/twisted/finger/finger06.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

2 
	~<muduo/Ãt/TıS”v”.h
>

4 
	~<m­
>

6 
usšg
 
Çme¥aû
 
	gmuduo
;

7 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

9 
	g¡d
::
	tm­
<
	t¡ršg
, sŒšg> 
	tU£rM­
;

10 
U£rM­
 
	gu£rs
;

12 
¡ršg
 
	$g‘U£r
(cÚ¡ 
¡ršg
& 
u£r
)

14 
¡ršg
 
»suÉ
 = "No such user";

15 
U£rM­
::
™”©Ü
 
™
 = 
u£rs
.
	`fšd
(
u£r
);

16 ià(
™
 !ğ
u£rs
.
	`’d
())

18 
»suÉ
 = 
™
->
£cÚd
;

20  
»suÉ
;

21 
	}
}

23 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

24 
Bufãr
* 
buf
,

25 
Time¡amp
 
»ûiveTime
)

27 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

28 ià(
ülf
)

30 
¡ršg
 
	`u£r
(
buf
->
	`³ek
(), 
ülf
);

31 
cÚn
->
	`£nd
(
	`g‘U£r
(
u£r
) + "\r\n");

32 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

33 
cÚn
->
	`shutdown
();

35 
	}
}

37 
	$maš
()

39 
Ev’tLoİ
 
loİ
;

40 
TıS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(1079), "Finger");

41 
£rv”
.
	`£tMes§geC®lback
(
ÚMes§ge
);

42 
£rv”
.
	`¡¬t
();

43 
loİ
.
	`loİ
();

44 
	}
}

	@examples/twisted/finger/finger07.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

2 
	~<muduo/Ãt/TıS”v”.h
>

4 
	~<m­
>

6 
usšg
 
Çme¥aû
 
	gmuduo
;

7 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

9 
	g¡d
::
	tm­
<
	t¡ršg
, sŒšg> 
	tU£rM­
;

10 
U£rM­
 
	gu£rs
;

12 
¡ršg
 
	$g‘U£r
(cÚ¡ 
¡ršg
& 
u£r
)

14 
¡ršg
 
»suÉ
 = "No such user";

15 
U£rM­
::
™”©Ü
 
™
 = 
u£rs
.
	`fšd
(
u£r
);

16 ià(
™
 !ğ
u£rs
.
	`’d
())

18 
»suÉ
 = 
™
->
£cÚd
;

20  
»suÉ
;

21 
	}
}

23 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

24 
Bufãr
* 
buf
,

25 
Time¡amp
 
»ûiveTime
)

27 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

28 ià(
ülf
)

30 
¡ršg
 
	`u£r
(
buf
->
	`³ek
(), 
ülf
);

31 
cÚn
->
	`£nd
(
	`g‘U£r
(
u£r
) + "\r\n");

32 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

33 
cÚn
->
	`shutdown
();

35 
	}
}

37 
	$maš
()

39 
u£rs
["schen"] = "Happy‡nd well";

40 
Ev’tLoİ
 
loİ
;

41 
TıS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(1079), "Finger");

42 
£rv”
.
	`£tMes§geC®lback
(
ÚMes§ge
);

43 
£rv”
.
	`¡¬t
();

44 
loİ
.
	`loİ
();

45 
	}
}

	@examples/wordcount/hash.h

1 #iâdeà
MUDUO_EXAMPLES_WORDCOUNT_HASH_H


2 
	#MUDUO_EXAMPLES_WORDCOUNT_HASH_H


	)

4 
Çme¥aû
 
	gboo¡


6 
	g¡d
::
size_t
 
hash_v®ue
(cÚ¡ 
muduo
::
¡ršg
& 
x
);

9 
	~<boo¡/unÜd”ed_m­.hµ
>

11 
Çme¥aû
 
	gboo¡


13 
šlše
 
	g¡d
::
size_t
 
hash_v®ue
(cÚ¡ 
muduo
::
¡ršg
& 
x
)

15  
hash_¿nge
(
x
.
begš
(), x.
’d
());

26 
	gboo¡
::
	tunÜd”ed_m­
<
	tmuduo
::
	t¡ršg
, 
	tšt64_t
> 
	tWÜdCouÁM­
;

	@examples/wordcount/hash.h

1 #iâdeà
MUDUO_EXAMPLES_WORDCOUNT_HASH_H


2 
	#MUDUO_EXAMPLES_WORDCOUNT_HASH_H


	)

4 
Çme¥aû
 
	gboo¡


6 
	g¡d
::
size_t
 
hash_v®ue
(cÚ¡ 
muduo
::
¡ršg
& 
x
);

9 
	~<boo¡/unÜd”ed_m­.hµ
>

11 
Çme¥aû
 
	gboo¡


13 
šlše
 
	g¡d
::
size_t
 
hash_v®ue
(cÚ¡ 
muduo
::
¡ršg
& 
x
)

15  
hash_¿nge
(
x
.
begš
(), x.
’d
());

26 
	gboo¡
::
	tunÜd”ed_m­
<
	tmuduo
::
	t¡ršg
, 
	tšt64_t
> 
	tWÜdCouÁM­
;

	@examples/wordcount/hasher.cc

1 
	~<muduo/ba£/CouÁDownL©ch.h
>

2 
	~<muduo/ba£/Loggšg.h
>

3 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

4 
	~<muduo/Ãt/TıCl›Á.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

9 
	~<boo¡/tok’iz”.hµ
>

11 
	~<exam¶es/wÜdcouÁ/hash.h
>

13 
	~<f¡»am
>

14 
	~<io¡»am
>

16 
	~<¡dio.h
>

17 
	#__STDC_FORMAT_MACROS


	)

18 
	~<š‰y³s.h
>

20 
usšg
 
Çme¥aû
 
	gmuduo
;

21 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

23 
size_t
 
	gg_b©chSize
 = 65536;

24 cÚ¡ 
size_t
 
	gkMaxHashSize
 = 10 * 1000 * 1000;

26 şas 
	cS’dThrÙ”
 : 
boo¡
::
nÚcİyabË


28 
public
:

29 
	$S’dThrÙ”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
addr
)

30 : 
	`ş›Á_
(
loİ
, 
addr
, "Sender"),

31 
	`cÚÃùL©ch_
(1),

32 
	`discÚÃùL©ch_
(1),

33 
	`cÚd_
(
mu‹x_
),

34 
	$cÚge¡iÚ_
(
çl£
)

36 
LOG_INFO
 << "S’dThrÙ” [" << 
addr
.
	`toIpPÜt
() << "]";

37 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

38 
boo¡
::
	`bšd
(&
S’dThrÙ”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

41 
	$cÚÃù
()

43 
ş›Á_
.
	`cÚÃù
();

44 
cÚÃùL©ch_
.
	`wa™
();

45 
	}
}

47 
	$discÚÃù
()

49 ià(
bufãr_
.
	`»adabËBy‹s
() > 0)

51 
LOG_DEBUG
 << "£nd " << 
bufãr_
.
	`»adabËBy‹s
() << " bytes";

52 
cÚn_
->
	`£nd
(&
bufãr_
);

54 
cÚn_
->
	`shutdown
();

55 
discÚÃùL©ch_
.
	`wa™
();

56 
	}
}

58 
	$£nd
(cÚ¡ 
¡ršg
& 
wÜd
, 
št64_t
 
couÁ
)

60 
bufãr_
.
	`­³nd
(
wÜd
);

62 
buf
[64];

63 
	`¢´štf
(
buf
,  buf, "\t%" 
PRId64
 "\r\n", 
couÁ
);

64 
bufãr_
.
	`­³nd
(
buf
);

65 ià(
bufãr_
.
	`»adabËBy‹s
(è>ğ
g_b©chSize
)

67 
	`thrÙe
();

68 
LOG_TRACE
 << "£nd " << 
bufãr_
.
	`»adabËBy‹s
();

69 
cÚn_
->
	`£nd
(&
bufãr_
);

71 
	}
}

73 
	g´iv©e
:

74 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

76 ià(
cÚn
->
	`cÚÃùed
())

78 
cÚn
->
	`£tHighW©”M¬kC®lback
(

79 
boo¡
::
	`bšd
(&
S’dThrÙ”
::
ÚHighW©”M¬k
, 
this
), 1024*1024);

80 
cÚn
->
	`£tWr™eCom¶‘eC®lback
(

81 
boo¡
::
	`bšd
(&
S’dThrÙ”
::
ÚWr™eCom¶‘e
, 
this
));

83 
cÚn_
 = 
cÚn
;

84 
cÚÃùL©ch_
.
	`couÁDown
();

88 
cÚn_
.
	`»£t
();

89 
discÚÃùL©ch_
.
	`couÁDown
();

91 
	}
}

93 
	$ÚHighW©”M¬k
()

95 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

96 
cÚge¡iÚ_
 = 
Œue
;

97 
	}
}

99 
	$ÚWr™eCom¶‘e
()

101 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

102 
boŞ
 
ŞdCÚg
 = 
cÚge¡iÚ_
;

103 
cÚge¡iÚ_
 = 
çl£
;

104 ià(
ŞdCÚg
)

106 
cÚd_
.
	`nÙify
();

108 
	}
}

110 
	$thrÙe
()

112 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

113 
cÚge¡iÚ_
)

115 
LOG_DEBUG
 << "wait ";

116 
cÚd_
.
	`wa™
();

118 
	}
}

120 
TıCl›Á
 
	gş›Á_
;

121 
TıCÚÃùiÚPŒ
 
	gcÚn_
;

122 
CouÁDownL©ch
 
	gcÚÃùL©ch_
;

123 
CouÁDownL©ch
 
	gdiscÚÃùL©ch_
;

124 
Bufãr
 
	gbufãr_
;

126 
Mu‹xLock
 
	gmu‹x_
;

127 
CÚd™iÚ
 
	gcÚd_
;

128 
boŞ
 
	gcÚge¡iÚ_
;

131 şas 
	cWÜdCouÁS’d”
 : 
boo¡
::
nÚcİyabË


133 
public
:

134 
ex¶ic™
 
WÜdCouÁS’d”
(cÚ¡ 
¡d
::
¡ršg
& 
»ûiv”s
);

136 
	$cÚÃùAÎ
()

138 
size_t
 
i
 = 0; i < 
buck‘s_
.
	`size
(); ++i)

140 
buck‘s_
[
i
].
	`cÚÃù
();

142 
LOG_INFO
 << "All connected";

145 
	$discÚÃùAÎ
()

147 
size_t
 
i
 = 0; i < 
buck‘s_
.
	`size
(); ++i)

149 
buck‘s_
[
i
].
	`discÚÃù
();

151 
LOG_INFO
 << "All disconnected";

152 
	}
}

154 
´oûssFe
(cÚ¡ * 
f’ame
);

156 
	g´iv©e
:

157 
Ev’tLoİTh»ad
 
loİTh»ad_
;

158 
Ev’tLoİ
* 
	gloİ_
;

159 
	gboo¡
::
±r_veùÜ
<
S’dThrÙ”
> 
buck‘s_
;

162 
	gWÜdCouÁS’d”
::
WÜdCouÁS’d”
(cÚ¡ 
¡d
::
¡ršg
& 
»ûiv”s
)

163 : 
loİ_
(
loİTh»ad_
.
	$¡¬tLoİ
())

165 
boo¡
::
	ttok’iz”
<
	tboo¡
::
	tch¬_£·¿tÜ
<> >okenizer;

166 
boo¡
::
ch¬_£·¿tÜ
<> 
	`£p
(", ");

167 
tok’iz”
 
	`tok’s
(
»ûiv”s
, 
£p
);

168 
tok’iz”
::
™”©Ü
 
tok_™”
 = 
tok’s
.
	`begš
();

169 
tok_™”
 !ğ
tok’s
.
	`’d
(); ++tok_iter)

171 
¡d
::
¡ršg
 
pÜt
 = *
tok_™”
;

172 
size_t
 
cŞÚ
 = 
pÜt
.
	`fšd
(':');

173 ià(
cŞÚ
 !ğ
¡d
::
¡ršg
::
Åos
)

175 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(&
pÜt
[
cŞÚ
+1]));

176 
IÃtAdd»ss
 
	`addr
(
pÜt
.
	`sub¡r
(0, 
cŞÚ
), 
pÜt
);

177 
buck‘s_
.
	`push_back
(
Ãw
 
	`S’dThrÙ”
(
loİ_
, 
addr
));

181 
	`as£¹
(0 && "Invalid‡ddress");

184 
	}
}

186 
	gWÜdCouÁS’d”
::
	$´oûssFe
(cÚ¡ * 
f’ame
)

188 
LOG_INFO
 << "´oûssF" << 
f’ame
;

189 
WÜdCouÁM­
 
wÜdcouÁs
;

191 
¡d
::
if¡»am
 
	`š
(
f’ame
);

192 
¡ršg
 
wÜd
;

194 
boo¡
::
hash
<
¡ršg
> hash;

195 
š
)

197 
wÜdcouÁs
.
	`ş—r
();

198 
š
 >> 
wÜd
)

200 
wÜdcouÁs
[
wÜd
] += 1;

201 ià(
wÜdcouÁs
.
	`size
(è> 
kMaxHashSize
)

207 
LOG_INFO
 << "£nd " << 
wÜdcouÁs
.
	`size
() << "„ecords";

208 
WÜdCouÁM­
::
™”©Ü
 
™
 = 
wÜdcouÁs
.
	`begš
();

209 
™
 !ğ
wÜdcouÁs
.
	`’d
(); ++it)

211 
size_t
 
idx
 = 
	`hash
(
™
->
fœ¡
è% 
buck‘s_
.
	`size
();

212 
buck‘s_
[
idx
].
	`£nd
(
™
->
fœ¡
, it->
£cÚd
);

215 
	}
}

217 
	$maš
(
¬gc
, * 
¬gv
[])

219 ià(
¬gc
 < 3)

221 
	`´štf
("U§ge: % add»s£s_of_»ûiv” šput_fe1 [šput_fe2]* \n", 
¬gv
[0]);

222 
	`´štf
("Exam¶e: % '1:pÜt1,2:pÜt2,3:pÜt3' iÅut_fe1 iÅut_fe2 \n", 
¬gv
[0]);

226 cÚ¡ * 
b©chSize
 = ::
	`g‘’v
("BATCH_SIZE");

227 ià(
b©chSize
)

229 
g_b©chSize
 = 
	`©oi
(
b©chSize
);

231 
WÜdCouÁS’d”
 
	`£nd”
(
¬gv
[1]);

232 
£nd”
.
	`cÚÃùAÎ
();

233 
i
 = 2; i < 
¬gc
; ++i)

235 
£nd”
.
	`´oûssFe
(
¬gv
[
i
]);

237 
£nd”
.
	`discÚÃùAÎ
();

239 
	}
}

	@examples/wordcount/receiver.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/TıS”v”.h
>

5 
	~<boo¡/bšd.hµ
>

6 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<exam¶es/wÜdcouÁ/hash.h
>

10 
	~<f¡»am
>

12 
	~<¡dio.h
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 şas 
	cWÜdCouÁReûiv”
 : 
boo¡
::
nÚcİyabË


19 
public
:

20 
	$WÜdCouÁReûiv”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

21 : 
	`loİ_
(
loİ
),

22 
	`£rv”_
(
loİ
, 
li¡’Addr
, "WordCountReceiver"),

23 
	$£nd”s_
(0)

25 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

26 
boo¡
::
	`bšd
(&
WÜdCouÁReûiv”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

27 
£rv”_
.
	`£tMes§geC®lback
(

28 
boo¡
::
	`bšd
(&
WÜdCouÁReûiv”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

31 
	$¡¬t
(
£nd”s
)

33 
LOG_INFO
 << "¡¬ˆ" << 
£nd”s
 << " senders";

34 
£nd”s_
 = 
£nd”s
;

35 
wÜdcouÁs_
.
	`ş—r
();

36 
£rv”_
.
	`¡¬t
();

37 
	}
}

39 
	g´iv©e
:

40 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

42 
LOG_DEBUG
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

43 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

44 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

45 ià(!
cÚn
->
	`cÚÃùed
())

47 ià(--
£nd”s_
 == 0)

49 
	`ouut
();

50 
loİ_
->
	`qu™
();

53 
	}
}

55 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
)

57 cÚ¡ * 
ülf
 = 
NULL
;

58  (
ülf
 = 
buf
->
	`fšdCRLF
()è!ğ
NULL
)

62 cÚ¡ * 
b
 = 
¡d
::
	`fšd
(
buf
->
	`³ek
(), 
ülf
, '\t');

63 ià(
b
 !ğ
ülf
)

65 
¡ršg
 
	`wÜd
(
buf
->
	`³ek
(), 
b
);

66 
št64_t
 
út
 = 
	`©Şl
(
b
);

67 
wÜdcouÁs_
[
wÜd
] +ğ
út
;

71 
LOG_ERROR
 << "Wrong format,‚oab found";

72 
cÚn
->
	`shutdown
();

74 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

76 
	}
}

78 
	$ouut
()

80 
LOG_INFO
 << "Writing shard";

81 
¡d
::
of¡»am
 
	`out
("shard");

82 
WÜdCouÁM­
::
™”©Ü
 
™
 = 
wÜdcouÁs_
.
	`begš
();

83 
™
 !ğ
wÜdcouÁs_
.
	`’d
(); ++it)

85 
out
 << 
™
->
fœ¡
 << '\t' << it->
£cÚd
 << '\n';

87 
	}
}

89 
Ev’tLoİ
* 
	gloİ_
;

90 
TıS”v”
 
	g£rv”_
;

91 
	g£nd”s_
;

92 
WÜdCouÁM­
 
	gwÜdcouÁs_
;

95 
	$maš
(
¬gc
, * 
¬gv
[])

97 ià(
¬gc
 < 3)

99 
	`´štf
("U§ge: % li¡’_pÜˆnumb”_of_£nd”s\n", 
¬gv
[0]);

103 
Ev’tLoİ
 
loİ
;

104 
pÜt
 = 
	`©oi
(
¬gv
[1]);

105 
IÃtAdd»ss
 
	`addr
(
¡©ic_ÿ¡
<
ušt16_t
>(
pÜt
));

106 
WÜdCouÁReûiv”
 
	`»ûiv”
(&
loİ
, 
addr
);

107 
»ûiv”
.
	`¡¬t
(
	`©oi
(
¬gv
[2]));

108 
loİ
.
	`loİ
();

110 
	}
}

	@examples/zeromq/local_lat.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/TıS”v”.h
>

4 
	~<exam¶es/asio/ch©/codec.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<¡dio.h
>

8 
	~<uni¡d.h
>

10 
boŞ
 
	gg_tıNoD–ay
 = 
çl£
;

12 
ÚCÚÃùiÚ
(cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

14 ià(
cÚn
->
cÚÃùed
())

16 
cÚn
->
£tTıNoD–ay
(
g_tıNoD–ay
);

20 
ÚSŒšgMes§ge
(
L’gthH—d”Codec
* 
codec
,

21 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

22 cÚ¡ 
muduo
::
¡ršg
& 
mes§ge
,

23 
muduo
::
Time¡amp
)

25 
codec
->
£nd
(
g‘_poš‹r
(
cÚn
), 
mes§ge
);

28 
	$maš
(
¬gc
, * 
¬gv
[])

30 ià(
¬gc
 > 1)

32 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[1]));

33 
g_tıNoD–ay
 = 
¬gc
 > 2 ? 
	`©oi
(
¬gv
[2]) : 0;

34 
th»adCouÁ
 = 
¬gc
 > 3 ? 
	`©oi
(
¬gv
[3]) : 0;

36 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",†i¡’…Üˆğ" << 
pÜt
;

38 
muduo
::
Ãt
::
Ev’tLoİ
 
loİ
;

39 
muduo
::
Ãt
::
IÃtAdd»ss
 
	`li¡’Addr
(
pÜt
);

40 
muduo
::
Ãt
::
TıS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
, "PingPong");

41 
L’gthH—d”Codec
 
	`codec
(
boo¡
::
	`bšd
(
ÚSŒšgMes§ge
, &
codec
, 
_1
, 
_2
, 
_3
));

43 
£rv”
.
	`£tCÚÃùiÚC®lback
(
ÚCÚÃùiÚ
);

44 
£rv”
.
	`£tMes§geC®lback
(

45 
boo¡
::
	`bšd
(&
L’gthH—d”Codec
::
ÚMes§ge
, &
codec
, 
_1
, 
_2
, 
_3
));

47 ià(
th»adCouÁ
 > 1)

49 
£rv”
.
	`£tTh»adNum
(
th»adCouÁ
);

52 
£rv”
.
	`¡¬t
();

54 
loİ
.
	`loİ
();

58 
	`årštf
(
¡d”r
, "U§ge: % li¡’_pÜˆ[tı_no_d–ay [th»ads]]\n", 
¬gv
[0]);

60 
	}
}

	@examples/zeromq/remote_lat.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/TıCl›Á.h
>

4 
	~<exam¶es/asio/ch©/codec.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<¡dio.h
>

9 
boŞ
 
	gg_tıNoD–ay
 = 
çl£
;

10 
	gg_msgSize
 = 0;

11 
	gg_tÙ®Msgs
 = 0;

12 
	gg_msgCouÁ
 = 0;

13 
	gmuduo
::
¡ršg
 
g_mes§ge
;

14 
	gmuduo
::
Time¡amp
 
g_¡¬t
;

16 
ÚCÚÃùiÚ
(
L’gthH—d”Codec
* 
codec
, cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
)

18 ià(
cÚn
->
cÚÃùed
())

20 
LOG_INFO
 << "connected";

21 
	gg_¡¬t
 = 
muduo
::
Time¡amp
::
now
();

22 
	gcÚn
->
£tTıNoD–ay
(
g_tıNoD–ay
);

23 
	gcodec
->
£nd
(
g‘_poš‹r
(
cÚn
), 
g_mes§ge
);

27 
	gLOG_INFO
 << "disconnected";

28 
	gmuduo
::
Ãt
::
Ev’tLoİ
::
g‘Ev’tLoİOfCu¼’tTh»ad
()->
qu™
();

32 
ÚSŒšgMes§ge
(
L’gthH—d”Codec
* 
codec
,

33 cÚ¡ 
muduo
::
Ãt
::
TıCÚÃùiÚPŒ
& 
cÚn
,

34 cÚ¡ 
muduo
::
¡ršg
& 
mes§ge
,

35 
muduo
::
Time¡amp
)

37 ià(
mes§ge
.
size
(è!ğ
¡©ic_ÿ¡
<
size_t
>(
g_msgSize
))

39 
abÜt
();

42 ++
	gg_msgCouÁ
;

44 ià(
	gg_msgCouÁ
 < 
	gg_tÙ®Msgs
)

46 
	gcodec
->
£nd
(
g‘_poš‹r
(
cÚn
), 
mes§ge
);

50 
	gmuduo
::
Time¡amp
 
’d
 = 
muduo
::Time¡amp::
now
();

51 
	gLOG_INFO
 << "done";

52 
	g–­£d
 = 
timeDifã»nû
(
’d
, 
g_¡¬t
);

53 
	gLOG_INFO
 << 
	gg_msgSize
 << " message bytes";

54 
	gLOG_INFO
 << 
	gg_msgCouÁ
 << "„ound-trips";

55 
	gLOG_INFO
 << 
	g–­£d
 << " seconds";

56 
	gLOG_INFO
 << 
	gmuduo
::
Fmt
("%.3f", 
g_msgCouÁ
 / 
–­£d
) << "„ound-trips…er second";

57 
	gLOG_INFO
 << 
	gmuduo
::
Fmt
("%.3f", (1000000 * 
–­£d
 / 
g_msgCouÁ
 / 2))

59 
	gLOG_INFO
 << 
	gmuduo
::
Fmt
("%.3f", (
g_msgSize
 * 
g_msgCouÁ
 / 
–­£d
 / 1024 / 1024))

61 
	gcÚn
->
shutdown
();

65 
	$maš
(
¬gc
, * 
¬gv
[])

67 ià(
¬gc
 > 3)

69 cÚ¡ * 

 = 
¬gv
[1];

70 
ušt16_t
 
pÜt
 = 
¡©ic_ÿ¡
<ušt16_t>(
	`©oi
(
¬gv
[2]));

71 
g_msgSize
 = 
	`©oi
(
¬gv
[3]);

72 
g_mes§ge
.
	`assign
(
g_msgSize
, 'H');

73 
g_tÙ®Msgs
 = 
¬gc
 > 4 ? 
	`©oi
(
¬gv
[4]) : 10000;

74 
g_tıNoD–ay
 = 
¬gc
 > 5 ? 
	`©oi
(
¬gv
[5]) : 0;

76 
muduo
::
Ãt
::
Ev’tLoİ
 
loİ
;

77 
muduo
::
Ãt
::
IÃtAdd»ss
 
	`£rv”Addr
(

, 
pÜt
);

78 
muduo
::
Ãt
::
TıCl›Á
 
	`ş›Á
(&
loİ
, 
£rv”Addr
, "Client");

79 
L’gthH—d”Codec
 
	`codec
(
boo¡
::
	`bšd
(
ÚSŒšgMes§ge
, &
codec
, 
_1
, 
_2
, 
_3
));

80 
ş›Á
.
	`£tCÚÃùiÚC®lback
(

81 
boo¡
::
	`bšd
(
ÚCÚÃùiÚ
, &
codec
, 
_1
));

82 
ş›Á
.
	`£tMes§geC®lback
(

83 
boo¡
::
	`bšd
(&
L’gthH—d”Codec
::
ÚMes§ge
, &
codec
, 
_1
, 
_2
, 
_3
));

84 
ş›Á
.
	`cÚÃù
();

85 
loİ
.
	`loİ
();

89 
	`årštf
(
¡d”r
, "U§ge: % £rv”_ s”v”_pÜˆmsg_size", 
¬gv
[0]);

90 
	`årštf
(
¡d”r
, " [msg_count [tcp_no_delay]]\n");

92 
	}
}

	@muduo/base/AsyncLogging.cc

1 
	~<muduo/ba£/AsyncLoggšg.h
>

2 
	~<muduo/ba£/LogFe.h
>

3 
	~<muduo/ba£/Time¡amp.h
>

5 
	~<¡dio.h
>

7 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
	gAsyncLoggšg
::
	$AsyncLoggšg
(cÚ¡ 
¡ršg
& 
ba£Çme
,

10 
size_t
 
rŞlSize
,

11 
æushIÁ”v®
)

12 : 
	`æushIÁ”v®_
(
æushIÁ”v®
),

13 
	`ruÂšg_
(
çl£
),

14 
	`ba£Çme_
(
ba£Çme
),

15 
	`rŞlSize_
(
rŞlSize
),

16 
	`th»ad_
(
boo¡
::
	`bšd
(&
AsyncLoggšg
::
th»adFunc
, 
this
), "Logging"),

17 
	`Ïtch_
(1),

18 
	`mu‹x_
(),

19 
	`cÚd_
(
mu‹x_
),

20 
	`cu¼’tBufãr_
(
Ãw
 
Bufãr
),

21 
	`ÃxtBufãr_
(
Ãw
 
Bufãr
),

22 
	$bufãrs_
()

24 
cu¼’tBufãr_
->
	`bz”o
();

25 
ÃxtBufãr_
->
	`bz”o
();

26 
bufãrs_
.
	`»£rve
(16);

27 
	}
}

29 
	gAsyncLoggšg
::
	$­³nd
(cÚ¡ * 
loglše
, 
Ën
)

31 
muduo
::
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

32 ià(
cu¼’tBufãr_
->
	`ava
(è> 
Ën
)

34 
cu¼’tBufãr_
->
	`­³nd
(
loglše
, 
Ën
);

38 
bufãrs_
.
	`push_back
(
cu¼’tBufãr_
.
	`»Ëa£
());

40 ià(
ÃxtBufãr_
)

42 
cu¼’tBufãr_
 = 
boo¡
::
±r_cÚš”
::
	`move
(
ÃxtBufãr_
);

46 
cu¼’tBufãr_
.
	`»£t
(
Ãw
 
Bufãr
);

48 
cu¼’tBufãr_
->
	`­³nd
(
loglše
, 
Ën
);

49 
cÚd_
.
	`nÙify
();

51 
	}
}

53 
	gAsyncLoggšg
::
	$th»adFunc
()

55 
	`as£¹
(
ruÂšg_
 =ğ
Œue
);

56 
Ïtch_
.
	`couÁDown
();

57 
LogFe
 
	`ouut
(
ba£Çme_
, 
rŞlSize_
, 
çl£
);

58 
BufãrPŒ
 
	`ÃwBufãr1
(
Ãw
 
Bufãr
);

59 
BufãrPŒ
 
	`ÃwBufãr2
(
Ãw
 
Bufãr
);

60 
ÃwBufãr1
->
	`bz”o
();

61 
ÃwBufãr2
->
	`bz”o
();

62 
BufãrVeùÜ
 
bufãrsToWr™e
;

63 
bufãrsToWr™e
.
	`»£rve
(16);

64 
ruÂšg_
)

66 
	`as£¹
(
ÃwBufãr1
 &&‚ewBufãr1->
	`Ëngth
() == 0);

67 
	`as£¹
(
ÃwBufãr2
 &&‚ewBufãr2->
	`Ëngth
() == 0);

68 
	`as£¹
(
bufãrsToWr™e
.
	`em±y
());

71 
muduo
::
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

72 ià(
bufãrs_
.
	`em±y
())

74 
cÚd_
.
	`wa™FÜSecÚds
(
æushIÁ”v®_
);

76 
bufãrs_
.
	`push_back
(
cu¼’tBufãr_
.
	`»Ëa£
());

77 
cu¼’tBufãr_
 = 
boo¡
::
±r_cÚš”
::
	`move
(
ÃwBufãr1
);

78 
bufãrsToWr™e
.
	`sw­
(
bufãrs_
);

79 ià(!
ÃxtBufãr_
)

81 
ÃxtBufãr_
 = 
boo¡
::
±r_cÚš”
::
	`move
(
ÃwBufãr2
);

85 
	`as£¹
(!
bufãrsToWr™e
.
	`em±y
());

87 ià(
bufãrsToWr™e
.
	`size
() > 25)

89 
buf
[256];

90 
	`¢´štf
(
buf
,  buf, "Dropped†og messages‡t %s, %zd†arger buffers\n",

91 
Time¡amp
::
	`now
().
	`toFÜm©‹dSŒšg
().
	`c_¡r
(),

92 
bufãrsToWr™e
.
	`size
()-2);

93 
	`åuts
(
buf
, 
¡d”r
);

94 
ouut
.
	`­³nd
(
buf
, 
¡©ic_ÿ¡
<>(
	`¡¾’
(buf)));

95 
bufãrsToWr™e
.
	`”a£
(bufãrsToWr™e.
	`begš
()+2, bufãrsToWr™e.
	`’d
());

98 
size_t
 
i
 = 0; i < 
bufãrsToWr™e
.
	`size
(); ++i)

101 
ouut
.
	`­³nd
(
bufãrsToWr™e
[
i
].
	`d©a
(), bufãrsToWr™e[i].
	`Ëngth
());

104 ià(
bufãrsToWr™e
.
	`size
() > 2)

107 
bufãrsToWr™e
.
	`»size
(2);

110 ià(!
ÃwBufãr1
)

112 
	`as£¹
(!
bufãrsToWr™e
.
	`em±y
());

113 
ÃwBufãr1
 = 
bufãrsToWr™e
.
	`pİ_back
();

114 
ÃwBufãr1
->
	`»£t
();

117 ià(!
ÃwBufãr2
)

119 
	`as£¹
(!
bufãrsToWr™e
.
	`em±y
());

120 
ÃwBufãr2
 = 
bufãrsToWr™e
.
	`pİ_back
();

121 
ÃwBufãr2
->
	`»£t
();

124 
bufãrsToWr™e
.
	`ş—r
();

125 
ouut
.
	`æush
();

127 
ouut
.
	`æush
();

128 
	}
}

	@muduo/base/AsyncLogging.h

1 #iâdeà
MUDUO_BASE_ASYNCLOGGING_H


2 
	#MUDUO_BASE_ASYNCLOGGING_H


	)

4 
	~<muduo/ba£/BlockšgQueue.h
>

5 
	~<muduo/ba£/BoundedBlockšgQueue.h
>

6 
	~<muduo/ba£/CouÁDownL©ch.h
>

7 
	~<muduo/ba£/Mu‹x.h
>

8 
	~<muduo/ba£/Th»ad.h
>

9 
	~<muduo/ba£/LogSŒ—m.h
>

11 
	~<boo¡/bšd.hµ
>

12 
	~<boo¡/nÚcİyabË.hµ
>

13 
	~<boo¡/scİed_±r.hµ
>

14 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

16 
Çme¥aû
 
	gmuduo


19 şas 
	cAsyncLoggšg
 : 
boo¡
::
nÚcİyabË


21 
public
:

23 
AsyncLoggšg
(cÚ¡ 
¡ršg
& 
ba£Çme
,

24 
size_t
 
rŞlSize
,

25 
æushIÁ”v®
 = 3);

27 ~
AsyncLoggšg
()

29 ià(
	gruÂšg_
)

31 
¡İ
();

35 
­³nd
(cÚ¡ * 
loglše
, 
Ën
);

37 
¡¬t
()

39 
	gruÂšg_
 = 
Œue
;

40 
	gth»ad_
.
¡¬t
();

41 
	gÏtch_
.
wa™
();

44 
¡İ
()

46 
	gruÂšg_
 = 
çl£
;

47 
	gcÚd_
.
nÙify
();

48 
	gth»ad_
.
još
();

51 
	g´iv©e
:

54 
AsyncLoggšg
(const AsyncLogging&);

55 
	gİ”©Ü
=(cÚ¡ 
AsyncLoggšg
&);

57 
th»adFunc
();

59 
	gmuduo
::
	td‘a
::
	tFixedBufãr
<
	tmuduo
::d‘a::
	tkL¬geBufãr
> 
	tBufãr
;

60 
	gboo¡
::
	t±r_veùÜ
<
	tBufãr
> 
	tBufãrVeùÜ
;

61 
	gBufãrVeùÜ
::
	tauto_ty³
 
	tBufãrPŒ
;

63 cÚ¡ 
	gæushIÁ”v®_
;

64 
boŞ
 
	gruÂšg_
;

65 
¡ršg
 
	gba£Çme_
;

66 
size_t
 
	grŞlSize_
;

67 
	gmuduo
::
Th»ad
 
th»ad_
;

68 
	gmuduo
::
CouÁDownL©ch
 
Ïtch_
;

69 
	gmuduo
::
Mu‹xLock
 
mu‹x_
;

70 
	gmuduo
::
CÚd™iÚ
 
cÚd_
;

71 
BufãrPŒ
 
	gcu¼’tBufãr_
;

72 
BufãrPŒ
 
	gÃxtBufãr_
;

73 
BufãrVeùÜ
 
	gbufãrs_
;

	@muduo/base/AsyncLogging.h

1 #iâdeà
MUDUO_BASE_ASYNCLOGGING_H


2 
	#MUDUO_BASE_ASYNCLOGGING_H


	)

4 
	~<muduo/ba£/BlockšgQueue.h
>

5 
	~<muduo/ba£/BoundedBlockšgQueue.h
>

6 
	~<muduo/ba£/CouÁDownL©ch.h
>

7 
	~<muduo/ba£/Mu‹x.h
>

8 
	~<muduo/ba£/Th»ad.h
>

9 
	~<muduo/ba£/LogSŒ—m.h
>

11 
	~<boo¡/bšd.hµ
>

12 
	~<boo¡/nÚcİyabË.hµ
>

13 
	~<boo¡/scİed_±r.hµ
>

14 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

16 
Çme¥aû
 
	gmuduo


19 şas 
	cAsyncLoggšg
 : 
boo¡
::
nÚcİyabË


21 
public
:

23 
AsyncLoggšg
(cÚ¡ 
¡ršg
& 
ba£Çme
,

24 
size_t
 
rŞlSize
,

25 
æushIÁ”v®
 = 3);

27 ~
AsyncLoggšg
()

29 ià(
	gruÂšg_
)

31 
¡İ
();

35 
­³nd
(cÚ¡ * 
loglše
, 
Ën
);

37 
¡¬t
()

39 
	gruÂšg_
 = 
Œue
;

40 
	gth»ad_
.
¡¬t
();

41 
	gÏtch_
.
wa™
();

44 
¡İ
()

46 
	gruÂšg_
 = 
çl£
;

47 
	gcÚd_
.
nÙify
();

48 
	gth»ad_
.
još
();

51 
	g´iv©e
:

54 
AsyncLoggšg
(const AsyncLogging&);

55 
	gİ”©Ü
=(cÚ¡ 
AsyncLoggšg
&);

57 
th»adFunc
();

59 
	gmuduo
::
	td‘a
::
	tFixedBufãr
<
	tmuduo
::d‘a::
	tkL¬geBufãr
> 
	tBufãr
;

60 
	gboo¡
::
	t±r_veùÜ
<
	tBufãr
> 
	tBufãrVeùÜ
;

61 
	gBufãrVeùÜ
::
	tauto_ty³
 
	tBufãrPŒ
;

63 cÚ¡ 
	gæushIÁ”v®_
;

64 
boŞ
 
	gruÂšg_
;

65 
¡ršg
 
	gba£Çme_
;

66 
size_t
 
	grŞlSize_
;

67 
	gmuduo
::
Th»ad
 
th»ad_
;

68 
	gmuduo
::
CouÁDownL©ch
 
Ïtch_
;

69 
	gmuduo
::
Mu‹xLock
 
mu‹x_
;

70 
	gmuduo
::
CÚd™iÚ
 
cÚd_
;

71 
BufãrPŒ
 
	gcu¼’tBufãr_
;

72 
BufãrPŒ
 
	gÃxtBufãr_
;

73 
BufãrVeùÜ
 
	gbufãrs_
;

	@muduo/base/Atomic.h

6 #iâdeà
MUDUO_BASE_ATOMIC_H


7 
	#MUDUO_BASE_ATOMIC_H


	)

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<¡dšt.h
>

12 
Çme¥aû
 
	gmuduo


15 
Çme¥aû
 
	gd‘a


17 
	g‹m¶©e
<
ty³Çme
 
	gT
>

18 şas 
	cAtomicIÁeg”T
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
AtomicIÁeg”T
()

22 : 
v®ue_
(0)

38 
T
 
g‘
()

41  
__sync_v®_com·»_ªd_sw­
(&
v®ue_
, 0, 0);

44 
T
 
g‘AndAdd
(T 
x
)

47  
__sync_ãtch_ªd_add
(&
v®ue_
, 
x
);

50 
T
 
addAndG‘
(T 
x
)

52  
g‘AndAdd
(
x
è+ 
	gx
;

55 
T
 
šüem’tAndG‘
()

57  
addAndG‘
(1);

60 
T
 
deüem’tAndG‘
()

62  
addAndG‘
(-1);

65 
add
(
T
 
x
)

67 
g‘AndAdd
(
x
);

70 
šüem’t
()

72 
šüem’tAndG‘
();

75 
deüem’t
()

77 
deüem’tAndG‘
();

80 
T
 
g‘AndS‘
(T 
ÃwV®ue
)

83  
__sync_lock_‹¡_ªd_£t
(&
v®ue_
, 
ÃwV®ue
);

86 
	g´iv©e
:

87 vŞ©
T
 
v®ue_
;

91 
	gd‘a
::
	tAtomicIÁeg”T
<
	tšt32_t
> 
	tAtomicIÁ32
;

92 
	gd‘a
::
	tAtomicIÁeg”T
<
	tšt64_t
> 
	tAtomicIÁ64
;

	@muduo/base/Atomic.h

6 #iâdeà
MUDUO_BASE_ATOMIC_H


7 
	#MUDUO_BASE_ATOMIC_H


	)

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<¡dšt.h
>

12 
Çme¥aû
 
	gmuduo


15 
Çme¥aû
 
	gd‘a


17 
	g‹m¶©e
<
ty³Çme
 
	gT
>

18 şas 
	cAtomicIÁeg”T
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
AtomicIÁeg”T
()

22 : 
v®ue_
(0)

38 
T
 
g‘
()

41  
__sync_v®_com·»_ªd_sw­
(&
v®ue_
, 0, 0);

44 
T
 
g‘AndAdd
(T 
x
)

47  
__sync_ãtch_ªd_add
(&
v®ue_
, 
x
);

50 
T
 
addAndG‘
(T 
x
)

52  
g‘AndAdd
(
x
è+ 
	gx
;

55 
T
 
šüem’tAndG‘
()

57  
addAndG‘
(1);

60 
T
 
deüem’tAndG‘
()

62  
addAndG‘
(-1);

65 
add
(
T
 
x
)

67 
g‘AndAdd
(
x
);

70 
šüem’t
()

72 
šüem’tAndG‘
();

75 
deüem’t
()

77 
deüem’tAndG‘
();

80 
T
 
g‘AndS‘
(T 
ÃwV®ue
)

83  
__sync_lock_‹¡_ªd_£t
(&
v®ue_
, 
ÃwV®ue
);

86 
	g´iv©e
:

87 vŞ©
T
 
v®ue_
;

91 
	gd‘a
::
	tAtomicIÁeg”T
<
	tšt32_t
> 
	tAtomicIÁ32
;

92 
	gd‘a
::
	tAtomicIÁeg”T
<
	tšt64_t
> 
	tAtomicIÁ64
;

	@muduo/base/BlockingQueue.h

6 #iâdeà
MUDUO_BASE_BLOCKINGQUEUE_H


7 
	#MUDUO_BASE_BLOCKINGQUEUE_H


	)

9 
	~<muduo/ba£/CÚd™iÚ.h
>

10 
	~<muduo/ba£/Mu‹x.h
>

12 
	~<boo¡/nÚcİyabË.hµ
>

13 
	~<deque
>

14 
	~<as£¹.h
>

16 
Çme¥aû
 
	gmuduo


19 
	g‹m¶©e
<
ty³Çme
 
	gT
>

20 şas 
	cBlockšgQueue
 : 
boo¡
::
nÚcİyabË


22 
public
:

23 
BlockšgQueue
()

24 : 
mu‹x_
(),

25 
nÙEm±y_
(
mu‹x_
),

26 
queue_
()

30 
put
(cÚ¡ 
T
& 
x
)

32 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

33 
	gqueue_
.
push_back
(
x
);

34 
	gnÙEm±y_
.
nÙify
();

38 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


39 
put
(
T
&& 
x
)

41 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

42 
	gqueue_
.
push_back
(
¡d
::
move
(
x
));

43 
	gnÙEm±y_
.
nÙify
();

48 
T
 
ke
()

50 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

52 
	gqueue_
.
em±y
())

54 
	gnÙEm±y_
.
wa™
();

56 
as£¹
(!
queue_
.
em±y
());

57 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


58 
T
 
äÚt
(
¡d
::
move
(
queue_
.front()));

60 
T
 
äÚt
(
queue_
.front());

62 
	gqueue_
.
pİ_äÚt
();

63  
	gäÚt
;

66 
size_t
 
size
() const

68 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

69  
	gqueue_
.
size
();

72 
	g´iv©e
:

73 
mubË
 
Mu‹xLock
 
mu‹x_
;

74 
CÚd™iÚ
 
	gnÙEm±y_
;

75 
	g¡d
::
deque
<
T
> 
queue_
;

	@muduo/base/BlockingQueue.h

6 #iâdeà
MUDUO_BASE_BLOCKINGQUEUE_H


7 
	#MUDUO_BASE_BLOCKINGQUEUE_H


	)

9 
	~<muduo/ba£/CÚd™iÚ.h
>

10 
	~<muduo/ba£/Mu‹x.h
>

12 
	~<boo¡/nÚcİyabË.hµ
>

13 
	~<deque
>

14 
	~<as£¹.h
>

16 
Çme¥aû
 
	gmuduo


19 
	g‹m¶©e
<
ty³Çme
 
	gT
>

20 şas 
	cBlockšgQueue
 : 
boo¡
::
nÚcİyabË


22 
public
:

23 
BlockšgQueue
()

24 : 
mu‹x_
(),

25 
nÙEm±y_
(
mu‹x_
),

26 
queue_
()

30 
put
(cÚ¡ 
T
& 
x
)

32 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

33 
	gqueue_
.
push_back
(
x
);

34 
	gnÙEm±y_
.
nÙify
();

38 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


39 
put
(
T
&& 
x
)

41 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

42 
	gqueue_
.
push_back
(
¡d
::
move
(
x
));

43 
	gnÙEm±y_
.
nÙify
();

48 
T
 
ke
()

50 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

52 
	gqueue_
.
em±y
())

54 
	gnÙEm±y_
.
wa™
();

56 
as£¹
(!
queue_
.
em±y
());

57 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


58 
T
 
äÚt
(
¡d
::
move
(
queue_
.front()));

60 
T
 
äÚt
(
queue_
.front());

62 
	gqueue_
.
pİ_äÚt
();

63  
	gäÚt
;

66 
size_t
 
size
() const

68 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

69  
	gqueue_
.
size
();

72 
	g´iv©e
:

73 
mubË
 
Mu‹xLock
 
mu‹x_
;

74 
CÚd™iÚ
 
	gnÙEm±y_
;

75 
	g¡d
::
deque
<
T
> 
queue_
;

	@muduo/base/BoundedBlockingQueue.h

6 #iâdeà
MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H


7 
	#MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H


	)

9 
	~<muduo/ba£/CÚd™iÚ.h
>

10 
	~<muduo/ba£/Mu‹x.h
>

12 
	~<boo¡/cœcuÏr_bufãr.hµ
>

13 
	~<boo¡/nÚcİyabË.hµ
>

14 
	~<as£¹.h
>

16 
Çme¥aû
 
	gmuduo


19 
	g‹m¶©e
<
ty³Çme
 
	gT
>

20 şas 
	cBoundedBlockšgQueue
 : 
boo¡
::
nÚcİyabË


22 
public
:

23 
ex¶ic™
 
BoundedBlockšgQueue
(
maxSize
)

24 : 
mu‹x_
(),

25 
nÙEm±y_
(
mu‹x_
),

26 
nÙFuÎ_
(
mu‹x_
),

27 
queue_
(
maxSize
)

31 
put
(cÚ¡ 
T
& 
x
)

33 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

34 
	gqueue_
.
fuÎ
())

36 
	gnÙFuÎ_
.
wa™
();

38 
as£¹
(!
queue_
.
fuÎ
());

39 
	gqueue_
.
push_back
(
x
);

40 
	gnÙEm±y_
.
nÙify
();

43 
T
 
ke
()

45 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

46 
	gqueue_
.
em±y
())

48 
	gnÙEm±y_
.
wa™
();

50 
as£¹
(!
queue_
.
em±y
());

51 
T
 
äÚt
(
queue_
.front());

52 
	gqueue_
.
pİ_äÚt
();

53 
	gnÙFuÎ_
.
nÙify
();

54  
	gäÚt
;

57 
boŞ
 
em±y
() const

59 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

60  
	gqueue_
.
em±y
();

63 
boŞ
 
fuÎ
() const

65 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

66  
	gqueue_
.
fuÎ
();

69 
size_t
 
size
() const

71 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

72  
	gqueue_
.
size
();

75 
size_t
 
ÿ·c™y
() const

77 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

78  
	gqueue_
.
ÿ·c™y
();

81 
	g´iv©e
:

82 
mubË
 
Mu‹xLock
 
mu‹x_
;

83 
CÚd™iÚ
 
	gnÙEm±y_
;

84 
CÚd™iÚ
 
	gnÙFuÎ_
;

85 
	gboo¡
::
cœcuÏr_bufãr
<
T
> 
queue_
;

	@muduo/base/BoundedBlockingQueue.h

6 #iâdeà
MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H


7 
	#MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H


	)

9 
	~<muduo/ba£/CÚd™iÚ.h
>

10 
	~<muduo/ba£/Mu‹x.h
>

12 
	~<boo¡/cœcuÏr_bufãr.hµ
>

13 
	~<boo¡/nÚcİyabË.hµ
>

14 
	~<as£¹.h
>

16 
Çme¥aû
 
	gmuduo


19 
	g‹m¶©e
<
ty³Çme
 
	gT
>

20 şas 
	cBoundedBlockšgQueue
 : 
boo¡
::
nÚcİyabË


22 
public
:

23 
ex¶ic™
 
BoundedBlockšgQueue
(
maxSize
)

24 : 
mu‹x_
(),

25 
nÙEm±y_
(
mu‹x_
),

26 
nÙFuÎ_
(
mu‹x_
),

27 
queue_
(
maxSize
)

31 
put
(cÚ¡ 
T
& 
x
)

33 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

34 
	gqueue_
.
fuÎ
())

36 
	gnÙFuÎ_
.
wa™
();

38 
as£¹
(!
queue_
.
fuÎ
());

39 
	gqueue_
.
push_back
(
x
);

40 
	gnÙEm±y_
.
nÙify
();

43 
T
 
ke
()

45 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

46 
	gqueue_
.
em±y
())

48 
	gnÙEm±y_
.
wa™
();

50 
as£¹
(!
queue_
.
em±y
());

51 
T
 
äÚt
(
queue_
.front());

52 
	gqueue_
.
pİ_äÚt
();

53 
	gnÙFuÎ_
.
nÙify
();

54  
	gäÚt
;

57 
boŞ
 
em±y
() const

59 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

60  
	gqueue_
.
em±y
();

63 
boŞ
 
fuÎ
() const

65 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

66  
	gqueue_
.
fuÎ
();

69 
size_t
 
size
() const

71 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

72  
	gqueue_
.
size
();

75 
size_t
 
ÿ·c™y
() const

77 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

78  
	gqueue_
.
ÿ·c™y
();

81 
	g´iv©e
:

82 
mubË
 
Mu‹xLock
 
mu‹x_
;

83 
CÚd™iÚ
 
	gnÙEm±y_
;

84 
CÚd™iÚ
 
	gnÙFuÎ_
;

85 
	gboo¡
::
cœcuÏr_bufãr
<
T
> 
queue_
;

	@muduo/base/Condition.cc

6 
	~<muduo/ba£/CÚd™iÚ.h
>

8 
	~<”ºo.h
>

11 
boŞ
 
	gmuduo
::
CÚd™iÚ
::
	$wa™FÜSecÚds
(
£cÚds
)

13 
time¥ec
 
ab¡ime
;

15 
	`şock_g‘time
(
CLOCK_REALTIME
, &
ab¡ime
);

17 cÚ¡ 
št64_t
 
kNªoSecÚdsP”SecÚd
 = 1e9;

18 
št64_t
 
Çno£cÚds
 = 
¡©ic_ÿ¡
<št64_t>(
£cÚds
 * 
kNªoSecÚdsP”SecÚd
);

20 
ab¡ime
.
tv_£c
 +ğ
¡©ic_ÿ¡
<
time_t
>(×b¡ime.
tv_n£c
 + 
Çno£cÚds
è/ 
kNªoSecÚdsP”SecÚd
);

21 
ab¡ime
.
tv_n£c
 = 
¡©ic_ÿ¡
<>(×b¡ime.tv_n£ø+ 
Çno£cÚds
è% 
kNªoSecÚdsP”SecÚd
);

23 
Mu‹xLock
::
UÇssignGu¬d
 
	`ug
(
mu‹x_
);

24  
ETIMEDOUT
 =ğ
	`±h»ad_cÚd_timedwa™
(&
pcÚd_
, 
mu‹x_
.
	`g‘Pth»adMu‹x
(), &
ab¡ime
);

25 
	}
}

	@muduo/base/Condition.h

6 #iâdeà
MUDUO_BASE_CONDITION_H


7 
	#MUDUO_BASE_CONDITION_H


	)

9 
	~<muduo/ba£/Mu‹x.h
>

11 
	~<boo¡/nÚcİyabË.hµ
>

12 
	~<±h»ad.h
>

14 
Çme¥aû
 
	gmuduo


17 şas 
	cCÚd™iÚ
 : 
boo¡
::
nÚcİyabË


19 
public
:

20 
ex¶ic™
 
CÚd™iÚ
(
Mu‹xLock
& 
mu‹x
)

21 : 
mu‹x_
(
mu‹x
)

24 
MCHECK
(
±h»ad_cÚd_š™
(&
pcÚd_
, 
NULL
));

27 ~
CÚd™iÚ
()

30 
MCHECK
(
±h»ad_cÚd_de¡roy
(&
pcÚd_
));

33 
wa™
()

36 
	gMu‹xLock
::
UÇssignGu¬d
 
ug
(
mu‹x_
);

38 
MCHECK
(
±h»ad_cÚd_wa™
(&
pcÚd_
, 
mu‹x_
.
g‘Pth»adMu‹x
()));

42 
boŞ
 
wa™FÜSecÚds
(
£cÚds
);

45 
nÙify
()

47 
MCHECK
(
±h»ad_cÚd_sigÇl
(&
pcÚd_
));

50 
nÙifyAÎ
()

52 
MCHECK
(
±h»ad_cÚd_brßdÿ¡
(&
pcÚd_
));

55 
	g´iv©e
:

57 
Mu‹xLock
& 
mu‹x_
;

59 
±h»ad_cÚd_t
 
	gpcÚd_
;

	@muduo/base/Condition.h

6 #iâdeà
MUDUO_BASE_CONDITION_H


7 
	#MUDUO_BASE_CONDITION_H


	)

9 
	~<muduo/ba£/Mu‹x.h
>

11 
	~<boo¡/nÚcİyabË.hµ
>

12 
	~<±h»ad.h
>

14 
Çme¥aû
 
	gmuduo


17 şas 
	cCÚd™iÚ
 : 
boo¡
::
nÚcİyabË


19 
public
:

20 
ex¶ic™
 
CÚd™iÚ
(
Mu‹xLock
& 
mu‹x
)

21 : 
mu‹x_
(
mu‹x
)

24 
MCHECK
(
±h»ad_cÚd_š™
(&
pcÚd_
, 
NULL
));

27 ~
CÚd™iÚ
()

30 
MCHECK
(
±h»ad_cÚd_de¡roy
(&
pcÚd_
));

33 
wa™
()

36 
	gMu‹xLock
::
UÇssignGu¬d
 
ug
(
mu‹x_
);

38 
MCHECK
(
±h»ad_cÚd_wa™
(&
pcÚd_
, 
mu‹x_
.
g‘Pth»adMu‹x
()));

42 
boŞ
 
wa™FÜSecÚds
(
£cÚds
);

45 
nÙify
()

47 
MCHECK
(
±h»ad_cÚd_sigÇl
(&
pcÚd_
));

50 
nÙifyAÎ
()

52 
MCHECK
(
±h»ad_cÚd_brßdÿ¡
(&
pcÚd_
));

55 
	g´iv©e
:

57 
Mu‹xLock
& 
mu‹x_
;

59 
±h»ad_cÚd_t
 
	gpcÚd_
;

	@muduo/base/CountDownLatch.cc

6 
	~<muduo/ba£/CouÁDownL©ch.h
>

8 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
	gCouÁDownL©ch
::
	$CouÁDownL©ch
(
couÁ
)

11 : 
	`mu‹x_
(),

12 
	`cÚd™iÚ_
(
mu‹x_
),

13 
	$couÁ_
(
couÁ
)

15 
	}
}

17 
	gCouÁDownL©ch
::
	$wa™
()

20 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

22 
couÁ_
 > 0)

24 
cÚd™iÚ_
.
	`wa™
();

26 
	}
}

28 
	gCouÁDownL©ch
::
	$couÁDown
()

30 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

31 --
couÁ_
;

32 ià(
couÁ_
 == 0)

34 
cÚd™iÚ_
.
	`nÙifyAÎ
();

36 
	}
}

38 
	gCouÁDownL©ch
::
	$g‘CouÁ
() const

40 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

41  
couÁ_
;

42 
	}
}

	@muduo/base/CountDownLatch.h

6 #iâdeà
MUDUO_BASE_COUNTDOWNLATCH_H


7 
	#MUDUO_BASE_COUNTDOWNLATCH_H


	)

9 
	~<muduo/ba£/CÚd™iÚ.h
>

10 
	~<muduo/ba£/Mu‹x.h
>

12 
	~<boo¡/nÚcİyabË.hµ
>

14 
Çme¥aû
 
	gmuduo


17 şas 
	cCouÁDownL©ch
 : 
boo¡
::
nÚcİyabË


19 
public
:

21 
ex¶ic™
 
CouÁDownL©ch
(
couÁ
);

23 
wa™
();

25 
couÁDown
();

27 
g‘CouÁ
() const;

29 
	g´iv©e
:

30 
mubË
 
Mu‹xLock
 
mu‹x_
;

31 
CÚd™iÚ
 
	gcÚd™iÚ_
;

32 
	gcouÁ_
;

	@muduo/base/CountDownLatch.h

6 #iâdeà
MUDUO_BASE_COUNTDOWNLATCH_H


7 
	#MUDUO_BASE_COUNTDOWNLATCH_H


	)

9 
	~<muduo/ba£/CÚd™iÚ.h
>

10 
	~<muduo/ba£/Mu‹x.h
>

12 
	~<boo¡/nÚcİyabË.hµ
>

14 
Çme¥aû
 
	gmuduo


17 şas 
	cCouÁDownL©ch
 : 
boo¡
::
nÚcİyabË


19 
public
:

21 
ex¶ic™
 
CouÁDownL©ch
(
couÁ
);

23 
wa™
();

25 
couÁDown
();

27 
g‘CouÁ
() const;

29 
	g´iv©e
:

30 
mubË
 
Mu‹xLock
 
mu‹x_
;

31 
CÚd™iÚ
 
	gcÚd™iÚ_
;

32 
	gcouÁ_
;

	@muduo/base/CurrentThread.h

6 #iâdeà
MUDUO_BASE_CURRENTTHREAD_H


7 
	#MUDUO_BASE_CURRENTTHREAD_H


	)

9 
	~<¡dšt.h
>

11 
Çme¥aû
 
	gmuduo


13 
Çme¥aû
 
	gCu¼’tTh»ad


16 
__th»ad
 
t_ÿchedTid
;

17 
__th»ad
 
t_tidSŒšg
[32];

18 
__th»ad
 
t_tidSŒšgL’gth
;

19 
__th»ad
 cÚ¡ * 
t_th»adName
;

20 
ÿcheTid
();

22 
šlše
 
tid
()

24 ià(
__butš_ex³ù
(
t_ÿchedTid
 == 0, 0))

26 
ÿcheTid
();

28  
	gt_ÿchedTid
;

31 
šlše
 cÚ¡ * 
tidSŒšg
()

33  
	gt_tidSŒšg
;

36 
šlše
 
tidSŒšgL’gth
()

38  
	gt_tidSŒšgL’gth
;

41 
šlše
 cÚ¡ * 
Çme
()

43  
	gt_th»adName
;

46 
boŞ
 
isMašTh»ad
();

48 
¦“pU£c
(
št64_t
 
u£c
);

	@muduo/base/CurrentThread.h

6 #iâdeà
MUDUO_BASE_CURRENTTHREAD_H


7 
	#MUDUO_BASE_CURRENTTHREAD_H


	)

9 
	~<¡dšt.h
>

11 
Çme¥aû
 
	gmuduo


13 
Çme¥aû
 
	gCu¼’tTh»ad


16 
__th»ad
 
t_ÿchedTid
;

17 
__th»ad
 
t_tidSŒšg
[32];

18 
__th»ad
 
t_tidSŒšgL’gth
;

19 
__th»ad
 cÚ¡ * 
t_th»adName
;

20 
ÿcheTid
();

22 
šlše
 
tid
()

24 ià(
__butš_ex³ù
(
t_ÿchedTid
 == 0, 0))

26 
ÿcheTid
();

28  
	gt_ÿchedTid
;

31 
šlše
 cÚ¡ * 
tidSŒšg
()

33  
	gt_tidSŒšg
;

36 
šlše
 
tidSŒšgL’gth
()

38  
	gt_tidSŒšgL’gth
;

41 
šlše
 cÚ¡ * 
Çme
()

43  
	gt_th»adName
;

46 
boŞ
 
isMašTh»ad
();

48 
¦“pU£c
(
št64_t
 
u£c
);

	@muduo/base/Date.cc

6 
	~<muduo/ba£/D©e.h
>

7 
	~<¡dio.h
>

9 
Çme¥aû
 
	gmuduo


11 
Çme¥aû
 
	gd‘a


14 
	g»quœe_32_b™_š‹g”_©_Ëa¡
[(è>ğ(
št32_t
) ? 1 : -1];

20 
g‘JulŸnDayNumb”
(
y—r
, 
mÚth
, 
day
)

22 (è
	g»quœe_32_b™_š‹g”_©_Ëa¡
;

23 
	ga
 = (14 - 
mÚth
) / 12;

24 
	gy
 = 
y—r
 + 4800 - 
a
;

25 
	gm
 = 
mÚth
 + 12 * 
a
 - 3;

26  
	gday
 + (153*
	gm
 + 2è/ 5 + 
	gy
*365 + y/4 - y/100 + y/400 - 32045;

29 
	gD©e
::
Y—rMÚthDay
 
g‘Y—rMÚthDay
(
julŸnDayNumb”
)

31 
a
 = 
julŸnDayNumb”
 + 32044;

32 
	gb
 = (4 * 
a
 + 3) / 146097;

33 
	gc
 = 
a
 - ((
b
 * 146097) / 4);

34 
	gd
 = (4 * 
c
 + 3) / 1461;

35 
	ge
 = 
c
 - ((1461 * 
d
) / 4);

36 
	gm
 = (5 * 
e
 + 2) / 153;

37 
	gD©e
::
Y—rMÚthDay
 
ymd
;

38 
	gymd
.
	gday
 = 
e
 - ((153 * 
m
 + 2) / 5) + 1;

39 
	gymd
.
	gmÚth
 = 
m
 + 3 - 12 * (m / 10);

40 
	gymd
.
	gy—r
 = 
b
 * 100 + 
d
 - 4800 + (
m
 / 10);

41  
	gymd
;

44 cÚ¡ 
	gD©e
::
kJulŸnDayOf1970_01_01
 = 
d‘a
::
g‘JulŸnDayNumb”
(1970, 1, 1);

47 
usšg
 
Çme¥aû
 
	gmuduo
;

48 
usšg
 
Çme¥aû
 
	gmuduo
::
d‘a
;

50 
	gD©e
::
	$D©e
(
y
, 
m
, 
d
)

51 : 
	`julŸnDayNumb”_
(
	$g‘JulŸnDayNumb”
(
y
, 
m
, 
d
))

53 
	}
}

55 
	gD©e
::
	$D©e
(cÚ¡ 
tm
& 
t
)

56 : 
	`julŸnDayNumb”_
(
	`g‘JulŸnDayNumb”
(

57 
t
.
tm_y—r
+1900,

58 
t
.
tm_mÚ
+1,

59 
t
.
tm_mday
))

61 
	}
}

63 
¡ršg
 
	gD©e
::
	$toIsoSŒšg
() const

65 
buf
[32];

66 
Y—rMÚthDay
 
	`ymd
(
	`y—rMÚthDay
());

67 
	`¢´štf
(
buf
,  buf, "%4d-%02d-%02d", 
ymd
.
y—r
, ymd.
mÚth
, ymd.
day
);

68  
buf
;

69 
	}
}

71 
	gD©e
::
Y—rMÚthDay
 
D©e
::
	$y—rMÚthDay
() const

73  
	`g‘Y—rMÚthDay
(
julŸnDayNumb”_
);

74 
	}
}

	@muduo/base/Date.h

6 #iâdeà
MUDUO_BASE_DATE_H


7 
	#MUDUO_BASE_DATE_H


	)

9 
	~<muduo/ba£/cİyabË.h
>

10 
	~<muduo/ba£/Ty³s.h
>

12 
	gtm
;

14 
Çme¥aû
 
	gmuduo


23 şas 
	cD©e
 : 
public
 
muduo
::
cİyabË


27 
public
:

29 
	sY—rMÚthDay


31 
y—r
;

32 
	gmÚth
;

33 
	gday
;

36 cÚ¡ 
	gkDaysP”W“k
 = 7;

37 cÚ¡ 
	gkJulŸnDayOf1970_01_01
;

42 
D©e
()

43 : 
julŸnDayNumb”_
(0)

50 
D©e
(
y—r
, 
mÚth
, 
day
);

55 
ex¶ic™
 
D©e
(
julŸnDayNum
)

56 : 
julŸnDayNumb”_
(
julŸnDayNum
)

62 
ex¶ic™
 
D©e
(cÚ¡ 
tm
&);

66 
sw­
(
D©e
& 
th©
)

68 
	g¡d
::
sw­
(
julŸnDayNumb”_
, 
th©
.julianDayNumber_);

71 
boŞ
 
v®id
(ècÚ¡ {  
	gjulŸnDayNumb”_
 > 0; }

76 
¡ršg
 
toIsoSŒšg
() const;

78 
Y—rMÚthDay
 
y—rMÚthDay
() const;

80 
y—r
() const

82  
y—rMÚthDay
().
	gy—r
;

85 
mÚth
() const

87  
y—rMÚthDay
().
	gmÚth
;

90 
day
() const

92  
y—rMÚthDay
().
	gday
;

96 
w“kDay
() const

98  (
	gjulŸnDayNumb”_
+1è% 
	gkDaysP”W“k
;

101 
julŸnDayNumb”
(ècÚ¡ {  
	gjulŸnDayNumb”_
; }

103 
	g´iv©e
:

104 
julŸnDayNumb”_
;

107 
šlše
 
boŞ
 
	gİ”©Ü
<(
D©e
 
	gx
, D©
	gy
)

109  
	gx
.
julŸnDayNumb”
(è< 
	gy
.julianDayNumber();

112 
šlše
 
boŞ
 
	gİ”©Ü
==(
D©e
 
x
, D©
	gy
)

114  
	gx
.
julŸnDayNumb”
(è=ğ
y
.julianDayNumber();

	@muduo/base/Date.h

6 #iâdeà
MUDUO_BASE_DATE_H


7 
	#MUDUO_BASE_DATE_H


	)

9 
	~<muduo/ba£/cİyabË.h
>

10 
	~<muduo/ba£/Ty³s.h
>

12 
	gtm
;

14 
Çme¥aû
 
	gmuduo


23 şas 
	cD©e
 : 
public
 
muduo
::
cİyabË


27 
public
:

29 
	sY—rMÚthDay


31 
y—r
;

32 
	gmÚth
;

33 
	gday
;

36 cÚ¡ 
	gkDaysP”W“k
 = 7;

37 cÚ¡ 
	gkJulŸnDayOf1970_01_01
;

42 
D©e
()

43 : 
julŸnDayNumb”_
(0)

50 
D©e
(
y—r
, 
mÚth
, 
day
);

55 
ex¶ic™
 
D©e
(
julŸnDayNum
)

56 : 
julŸnDayNumb”_
(
julŸnDayNum
)

62 
ex¶ic™
 
D©e
(cÚ¡ 
tm
&);

66 
sw­
(
D©e
& 
th©
)

68 
	g¡d
::
sw­
(
julŸnDayNumb”_
, 
th©
.julianDayNumber_);

71 
boŞ
 
v®id
(ècÚ¡ {  
	gjulŸnDayNumb”_
 > 0; }

76 
¡ršg
 
toIsoSŒšg
() const;

78 
Y—rMÚthDay
 
y—rMÚthDay
() const;

80 
y—r
() const

82  
y—rMÚthDay
().
	gy—r
;

85 
mÚth
() const

87  
y—rMÚthDay
().
	gmÚth
;

90 
day
() const

92  
y—rMÚthDay
().
	gday
;

96 
w“kDay
() const

98  (
	gjulŸnDayNumb”_
+1è% 
	gkDaysP”W“k
;

101 
julŸnDayNumb”
(ècÚ¡ {  
	gjulŸnDayNumb”_
; }

103 
	g´iv©e
:

104 
julŸnDayNumb”_
;

107 
šlše
 
boŞ
 
	gİ”©Ü
<(
D©e
 
	gx
, D©
	gy
)

109  
	gx
.
julŸnDayNumb”
(è< 
	gy
.julianDayNumber();

112 
šlše
 
boŞ
 
	gİ”©Ü
==(
D©e
 
x
, D©
	gy
)

114  
	gx
.
julŸnDayNumb”
(è=ğ
y
.julianDayNumber();

	@muduo/base/Exception.cc

6 
	~<muduo/ba£/Exû±iÚ.h
>

9 
	~<execšfo.h
>

10 
	~<¡dlib.h
>

12 
usšg
 
Çme¥aû
 
	gmuduo
;

14 
	gExû±iÚ
::
	$Exû±iÚ
(cÚ¡ * 
msg
)

15 : 
	$mes§ge_
(
msg
)

17 
	`flSckT¿û
();

18 
	}
}

20 
	gExû±iÚ
::
	$Exû±iÚ
(cÚ¡ 
¡ršg
& 
msg
)

21 : 
	$mes§ge_
(
msg
)

23 
	`flSckT¿û
();

24 
	}
}

26 
	gExû±iÚ
::~
	$Exû±iÚ
(è
	$throw
 ()

28 
	}
}

30 cÚ¡ * 
Exû±iÚ
::
	$wh©
(ècÚ¡ 
	$throw
()

32  
mes§ge_
.
	`c_¡r
();

33 
	}
}

35 cÚ¡ * 
	gExû±iÚ
::
	$¡ackT¿û
(ècÚ¡ 
	$throw
()

37  
¡ack_
.
	`c_¡r
();

38 
	}
}

40 
	gExû±iÚ
::
	$flSckT¿û
()

42 cÚ¡ 
Ën
 = 200;

43 * 
bufãr
[
Ën
];

44 
ÅŒs
 = ::
	`backŒaû
(
bufãr
, 
Ën
);

45 ** 
¡ršgs
 = ::
	`backŒaû_symbŞs
(
bufãr
, 
ÅŒs
);

46 ià(
¡ršgs
)

48 
i
 = 0; i < 
ÅŒs
; ++i)

51 
¡ack_
.
	`­³nd
(
¡ršgs
[
i
]);

52 
¡ack_
.
	`push_back
('\n');

54 
	`ä“
(
¡ršgs
);

56 
	}
}

	@muduo/base/Exception.h

6 #iâdeà
MUDUO_BASE_EXCEPTION_H


7 
	#MUDUO_BASE_EXCEPTION_H


	)

9 
	~<muduo/ba£/Ty³s.h
>

10 
	~<exû±iÚ
>

12 
Çme¥aû
 
	gmuduo


15 şas 
	cExû±iÚ
 : 
public
 
¡d
::
exû±iÚ


17 
public
:

18 
ex¶ic™
 
Exû±iÚ
(cÚ¡ * 
wh©
);

19 
ex¶ic™
 
Exû±iÚ
(cÚ¡ 
¡ršg
& 
wh©
);

20 
	gvœtu®
 ~
Exû±iÚ
(è
throw
();

21 
vœtu®
 cÚ¡ * 
wh©
(ècÚ¡ 
throw
();

22 cÚ¡ * 
¡ackT¿û
(ècÚ¡ 
throw
();

24 
	g´iv©e
:

25 
flSckT¿û
();

27 
¡ršg
 
	gmes§ge_
;

28 
¡ršg
 
	g¡ack_
;

	@muduo/base/Exception.h

6 #iâdeà
MUDUO_BASE_EXCEPTION_H


7 
	#MUDUO_BASE_EXCEPTION_H


	)

9 
	~<muduo/ba£/Ty³s.h
>

10 
	~<exû±iÚ
>

12 
Çme¥aû
 
	gmuduo


15 şas 
	cExû±iÚ
 : 
public
 
¡d
::
exû±iÚ


17 
public
:

18 
ex¶ic™
 
Exû±iÚ
(cÚ¡ * 
wh©
);

19 
ex¶ic™
 
Exû±iÚ
(cÚ¡ 
¡ršg
& 
wh©
);

20 
	gvœtu®
 ~
Exû±iÚ
(è
throw
();

21 
vœtu®
 cÚ¡ * 
wh©
(ècÚ¡ 
throw
();

22 cÚ¡ * 
¡ackT¿û
(ècÚ¡ 
throw
();

24 
	g´iv©e
:

25 
flSckT¿û
();

27 
¡ršg
 
	gmes§ge_
;

28 
¡ršg
 
	g¡ack_
;

	@muduo/base/FileUtil.cc

10 
	~<muduo/ba£/FeUt.h
>

11 
	~<muduo/ba£/Loggšg.h
>

13 
	~<boo¡/¡©ic_as£¹.hµ
>

15 
	~<as£¹.h
>

16 
	~<”ºo.h
>

17 
	~<fú.h
>

18 
	~<¡dio.h
>

19 
	~<sys/¡©.h
>

20 
	~<uni¡d.h
>

22 
usšg
 
Çme¥aû
 
	gmuduo
;

24 
	gFeUt
::
Aµ’dFe
::
	$Aµ’dFe
(
SŒšgArg
 
f’ame
)

25 : 
	`å_
(::
	`fİ’
(
f’ame
.
	`c_¡r
(), "ae")),

26 
	$wr™‹nBy‹s_
(0)

28 
	`as£¹
(
å_
);

29 ::
	`£tbufãr
(
å_
, 
bufãr_
,  buffer_);

31 
	}
}

33 
	gFeUt
::
Aµ’dFe
::~
	$Aµ’dFe
()

35 ::
	`fşo£
(
å_
);

36 
	}
}

38 
	gFeUt
::
Aµ’dFe
::
	$­³nd
(cÚ¡ * 
loglše
, cÚ¡ 
size_t
 
Ën
)

40 
size_t
 
n
 = 
	`wr™e
(
loglše
, 
Ën
);

41 
size_t
 
»maš
 = 
Ën
 - 
n
;

42 
»maš
 > 0)

44 
size_t
 
x
 = 
	`wr™e
(
loglše
 + 
n
, 
»maš
);

45 ià(
x
 == 0)

47 
”r
 = 
	`ã¼Ü
(
å_
);

48 ià(
”r
)

50 
	`årštf
(
¡d”r
, "Aµ’dFe::­³nd(èçed %s\n", 
	`¡»¼Ü_
(
”r
));

54 
n
 +ğ
x
;

55 
»maš
 = 
Ën
 - 
n
;

58 
wr™‹nBy‹s_
 +ğ
Ën
;

59 
	}
}

61 
	gFeUt
::
Aµ’dFe
::
	$æush
()

63 ::
	`fæush
(
å_
);

64 
	}
}

66 
size_t
 
	gFeUt
::
Aµ’dFe
::
	$wr™e
(cÚ¡ * 
loglše
, 
size_t
 
Ën
)

69  ::
	`fwr™e_uÆocked
(
loglše
, 1, 
Ën
, 
å_
);

70 
	}
}

72 
	gFeUt
::
R—dSm®lFe
::
	$R—dSm®lFe
(
SŒšgArg
 
f’ame
)

73 : 
	`fd_
(::
	`İ’
(
f’ame
.
	`c_¡r
(), 
O_RDONLY
 | 
O_CLOEXEC
)),

74 
	$”r_
(0)

76 
buf_
[0] = '\0';

77 ià(
fd_
 < 0)

79 
”r_
 = 
”ºo
;

81 
	}
}

83 
	gFeUt
::
R—dSm®lFe
::~
	$R—dSm®lFe
()

85 ià(
fd_
 >= 0)

87 ::
	`şo£
(
fd_
);

89 
	}
}

92 
	g‹m¶©e
<
ty³Çme
 
	gSŒšg
>

93 
	gFeUt
::
R—dSm®lFe
::
	$»adToSŒšg
(
maxSize
,

94 
SŒšg
* 
cÚ‹Á
,

95 
št64_t
* 
feSize
,

96 
št64_t
* 
modifyTime
,

97 
št64_t
* 
ü—‹Time
)

99 
	`BOOST_STATIC_ASSERT
((
off_t
) == 8);

100 
	`as£¹
(
cÚ‹Á
 !ğ
NULL
);

101 
”r
 = 
”r_
;

102 ià(
fd_
 >= 0)

104 
cÚ‹Á
->
	`ş—r
();

106 ià(
feSize
)

108 
¡©
 
¡©buf
;

109 ià(::
	`f¡©
(
fd_
, &
¡©buf
) == 0)

111 ià(
	`S_ISREG
(
¡©buf
.
¡_mode
))

113 *
feSize
 = 
¡©buf
.
¡_size
;

114 
cÚ‹Á
->
	`»£rve
(
¡©ic_ÿ¡
<>(
¡d
::
	`mš
(
im¶ic™_ÿ¡
<
št64_t
>(
maxSize
), *
feSize
)));

116 ià(
	`S_ISDIR
(
¡©buf
.
¡_mode
))

118 
”r
 = 
EISDIR
;

120 ià(
modifyTime
)

122 *
modifyTime
 = 
¡©buf
.
¡_mtime
;

124 ià(
ü—‹Time
)

126 *
ü—‹Time
 = 
¡©buf
.
¡_ùime
;

131 
”r
 = 
”ºo
;

135 
cÚ‹Á
->
	`size
(è< 
im¶ic™_ÿ¡
<
size_t
>(
maxSize
))

137 
size_t
 
toR—d
 = 
¡d
::
	`mš
(
im¶ic™_ÿ¡
<size_t>(
maxSize
è- 
cÚ‹Á
->
	`size
(), (
buf_
));

138 
ssize_t
 
n
 = ::
	`»ad
(
fd_
, 
buf_
, 
toR—d
);

139 ià(
n
 > 0)

141 
cÚ‹Á
->
	`­³nd
(
buf_
, 
n
);

145 ià(
n
 < 0)

147 
”r
 = 
”ºo
;

153  
”r
;

154 
	}
}

156 
	gFeUt
::
R—dSm®lFe
::
	$»adToBufãr
(* 
size
)

158 
”r
 = 
”r_
;

159 ià(
fd_
 >= 0)

161 
ssize_t
 
n
 = ::
	`´—d
(
fd_
, 
buf_
, (buf_)-1, 0);

162 ià(
n
 >= 0)

164 ià(
size
)

166 *
size
 = 
¡©ic_ÿ¡
<>(
n
);

168 
buf_
[
n
] = '\0';

172 
”r
 = 
”ºo
;

175  
”r
;

176 
	}
}

178 
‹m¶©e
 
	gFeUt
::
»adFe
(
SŒšgArg
 
f’ame
,

179 
maxSize
,

180 
¡ršg
* 
cÚ‹Á
,

181 
št64_t
*, int64_t*, int64_t*);

183 
‹m¶©e
 
	gFeUt
::
R—dSm®lFe
::
»adToSŒšg
(

184 
maxSize
,

185 
¡ršg
* 
cÚ‹Á
,

186 
št64_t
*, int64_t*, int64_t*);

188 #iâdeà
MUDUO_STD_STRING


189 
‹m¶©e
 
	gFeUt
::
»adFe
(
SŒšgArg
 
f’ame
,

190 
maxSize
,

191 
¡d
::
¡ršg
* 
cÚ‹Á
,

192 
št64_t
*, int64_t*, int64_t*);

194 
‹m¶©e
 
	gFeUt
::
R—dSm®lFe
::
»adToSŒšg
(

195 
maxSize
,

196 
¡d
::
¡ršg
* 
cÚ‹Á
,

197 
št64_t
*, int64_t*, int64_t*);

	@muduo/base/FileUtil.h

11 #iâdeà
MUDUO_BASE_FILEUTIL_H


12 
	#MUDUO_BASE_FILEUTIL_H


	)

14 
	~<muduo/ba£/SŒšgP›û.h
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


20 
Çme¥aû
 
	gFeUt


24 şas 
	cR—dSm®lFe
 : 
boo¡
::
nÚcİyabË


26 
public
:

27 
R—dSm®lFe
(
SŒšgArg
 
f’ame
);

28 ~
R—dSm®lFe
();

31 
	g‹m¶©e
<
ty³Çme
 
	gSŒšg
>

32 
»adToSŒšg
(
maxSize
,

33 
SŒšg
* 
cÚ‹Á
,

34 
št64_t
* 
feSize
,

35 
št64_t
* 
modifyTime
,

36 
št64_t
* 
ü—‹Time
);

40 
»adToBufãr
(* 
size
);

42 cÚ¡ * 
bufãr
(ècÚ¡ {  
	gbuf_
; }

44 cÚ¡ 
	gkBufãrSize
 = 64*1024;

46 
	g´iv©e
:

47 
fd_
;

48 
	g”r_
;

49 
	gbuf_
[
kBufãrSize
];

53 
	g‹m¶©e
<
ty³Çme
 
	gSŒšg
>

54 
»adFe
(
SŒšgArg
 
f’ame
,

55 
maxSize
,

56 
SŒšg
* 
cÚ‹Á
,

57 
št64_t
* 
feSize
 = 
NULL
,

58 
št64_t
* 
modifyTime
 = 
NULL
,

59 
št64_t
* 
ü—‹Time
 = 
NULL
)

61 
R—dSm®lFe
 
fe
(
f’ame
);

62  
	gfe
.
»adToSŒšg
(
maxSize
, 
cÚ‹Á
, 
feSize
, 
modifyTime
, 
ü—‹Time
);

66 şas 
	cAµ’dFe
 : 
boo¡
::
nÚcİyabË


68 
public
:

69 
ex¶ic™
 
Aµ’dFe
(
SŒšgArg
 
f’ame
);

71 ~
Aµ’dFe
();

73 
­³nd
(cÚ¡ * 
loglše
, cÚ¡ 
size_t
 
Ën
);

75 
æush
();

77 
size_t
 
wr™‹nBy‹s
(ècÚ¡ {  
	gwr™‹nBy‹s_
; }

79 
	g´iv©e
:

81 
size_t
 
wr™e
(cÚ¡ * 
loglše
, size_ˆ
Ën
);

83 
FILE
* 
	gå_
;

84 
	gbufãr_
[64*1024];

85 
size_t
 
	gwr™‹nBy‹s_
;

	@muduo/base/FileUtil.h

11 #iâdeà
MUDUO_BASE_FILEUTIL_H


12 
	#MUDUO_BASE_FILEUTIL_H


	)

14 
	~<muduo/ba£/SŒšgP›û.h
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


20 
Çme¥aû
 
	gFeUt


24 şas 
	cR—dSm®lFe
 : 
boo¡
::
nÚcİyabË


26 
public
:

27 
R—dSm®lFe
(
SŒšgArg
 
f’ame
);

28 ~
R—dSm®lFe
();

31 
	g‹m¶©e
<
ty³Çme
 
	gSŒšg
>

32 
»adToSŒšg
(
maxSize
,

33 
SŒšg
* 
cÚ‹Á
,

34 
št64_t
* 
feSize
,

35 
št64_t
* 
modifyTime
,

36 
št64_t
* 
ü—‹Time
);

40 
»adToBufãr
(* 
size
);

42 cÚ¡ * 
bufãr
(ècÚ¡ {  
	gbuf_
; }

44 cÚ¡ 
	gkBufãrSize
 = 64*1024;

46 
	g´iv©e
:

47 
fd_
;

48 
	g”r_
;

49 
	gbuf_
[
kBufãrSize
];

53 
	g‹m¶©e
<
ty³Çme
 
	gSŒšg
>

54 
»adFe
(
SŒšgArg
 
f’ame
,

55 
maxSize
,

56 
SŒšg
* 
cÚ‹Á
,

57 
št64_t
* 
feSize
 = 
NULL
,

58 
št64_t
* 
modifyTime
 = 
NULL
,

59 
št64_t
* 
ü—‹Time
 = 
NULL
)

61 
R—dSm®lFe
 
fe
(
f’ame
);

62  
	gfe
.
»adToSŒšg
(
maxSize
, 
cÚ‹Á
, 
feSize
, 
modifyTime
, 
ü—‹Time
);

66 şas 
	cAµ’dFe
 : 
boo¡
::
nÚcİyabË


68 
public
:

69 
ex¶ic™
 
Aµ’dFe
(
SŒšgArg
 
f’ame
);

71 ~
Aµ’dFe
();

73 
­³nd
(cÚ¡ * 
loglše
, cÚ¡ 
size_t
 
Ën
);

75 
æush
();

77 
size_t
 
wr™‹nBy‹s
(ècÚ¡ {  
	gwr™‹nBy‹s_
; }

79 
	g´iv©e
:

81 
size_t
 
wr™e
(cÚ¡ * 
loglše
, size_ˆ
Ën
);

83 
FILE
* 
	gå_
;

84 
	gbufãr_
[64*1024];

85 
size_t
 
	gwr™‹nBy‹s_
;

	@muduo/base/GzipFile.h

1 #´agm¨
Úû


3 
	~<muduo/ba£/SŒšgP›û.h
>

4 
	~<boo¡/nÚcİyabË.hµ
>

5 
	~<zlib.h
>

7 
Çme¥aû
 
	gmuduo


10 şas 
	cGzFe
 : 
boo¡
::
nÚcİyabË


12 
public
:

13 
GzFe
(GzFe&& 
rhs
)

14 : 
fe_
(
rhs
.file_)

16 
rhs
.
fe_
 = 
NULL
;

19 ~
GzFe
()

21 ià(
	gfe_
)

23 ::
gzşo£
(
fe_
);

27 
	gGzFe
& 
	gİ”©Ü
=(
GzFe
&& 
rhs
)

29 
sw­
(
rhs
);

30  *
	gthis
;

33 
boŞ
 
v®id
(ècÚ¡ {  
	gfe_
 !ğ
NULL
; }

34 
sw­
(
GzFe
& 
rhs
è{ 
	g¡d
::sw­(
fe_
,„hs.file_); }

35 #ià
ZLIB_VERNUM
 >= 0x1240

36 
boŞ
 
£tBufãr
(
size
è{  ::
gzbufãr
(
fe_
, size) == 0; }

40 
»ad
(* 
buf
, 
Ën
è{  ::
gz»ad
(
fe_
, buf,†en); }

43 
wr™e
(
SŒšgP›û
 
buf
è{  ::
gzwr™e
(
fe_
, buf.
d©a
(), buf.
size
()); }

46 
off_t
 
‹Î
(ècÚ¡ {  ::
gz‹Î
(
fe_
); }

48 #ià
ZLIB_VERNUM
 >= 0x1240

50 
off_t
 
off£t
(ècÚ¡ {  ::
gzoff£t
(
fe_
); }

55 
GzFe
 
İ’FÜR—d
(
SŒšgArg
 
f’ame
)

57  
GzFe
(::
gzİ’
(
f’ame
.
c_¡r
(), "rbe"));

60 
GzFe
 
İ’FÜAµ’d
(
SŒšgArg
 
f’ame
)

62  
GzFe
(::
gzİ’
(
f’ame
.
c_¡r
(), "abe"));

65 
GzFe
 
İ’FÜWr™eExşusive
(
SŒšgArg
 
f’ame
)

67  
GzFe
(::
gzİ’
(
f’ame
.
c_¡r
(), "wbxe"));

70 
GzFe
 
İ’FÜWr™eTrunÿ‹
(
SŒšgArg
 
f’ame
)

72  
GzFe
(::
gzİ’
(
f’ame
.
c_¡r
(), "wbe"));

75 
	g´iv©e
:

76 
ex¶ic™
 
GzFe
(
gzFe
 
fe
)

77 : 
fe_
(
fe
)

81 
gzFe
 
fe_
;

	@muduo/base/GzipFile.h

1 #´agm¨
Úû


3 
	~<muduo/ba£/SŒšgP›û.h
>

4 
	~<boo¡/nÚcİyabË.hµ
>

5 
	~<zlib.h
>

7 
Çme¥aû
 
	gmuduo


10 şas 
	cGzFe
 : 
boo¡
::
nÚcİyabË


12 
public
:

13 
GzFe
(GzFe&& 
rhs
)

14 : 
fe_
(
rhs
.file_)

16 
rhs
.
fe_
 = 
NULL
;

19 ~
GzFe
()

21 ià(
	gfe_
)

23 ::
gzşo£
(
fe_
);

27 
	gGzFe
& 
	gİ”©Ü
=(
GzFe
&& 
rhs
)

29 
sw­
(
rhs
);

30  *
	gthis
;

33 
boŞ
 
v®id
(ècÚ¡ {  
	gfe_
 !ğ
NULL
; }

34 
sw­
(
GzFe
& 
rhs
è{ 
	g¡d
::sw­(
fe_
,„hs.file_); }

35 #ià
ZLIB_VERNUM
 >= 0x1240

36 
boŞ
 
£tBufãr
(
size
è{  ::
gzbufãr
(
fe_
, size) == 0; }

40 
»ad
(* 
buf
, 
Ën
è{  ::
gz»ad
(
fe_
, buf,†en); }

43 
wr™e
(
SŒšgP›û
 
buf
è{  ::
gzwr™e
(
fe_
, buf.
d©a
(), buf.
size
()); }

46 
off_t
 
‹Î
(ècÚ¡ {  ::
gz‹Î
(
fe_
); }

48 #ià
ZLIB_VERNUM
 >= 0x1240

50 
off_t
 
off£t
(ècÚ¡ {  ::
gzoff£t
(
fe_
); }

55 
GzFe
 
İ’FÜR—d
(
SŒšgArg
 
f’ame
)

57  
GzFe
(::
gzİ’
(
f’ame
.
c_¡r
(), "rbe"));

60 
GzFe
 
İ’FÜAµ’d
(
SŒšgArg
 
f’ame
)

62  
GzFe
(::
gzİ’
(
f’ame
.
c_¡r
(), "abe"));

65 
GzFe
 
İ’FÜWr™eExşusive
(
SŒšgArg
 
f’ame
)

67  
GzFe
(::
gzİ’
(
f’ame
.
c_¡r
(), "wbxe"));

70 
GzFe
 
İ’FÜWr™eTrunÿ‹
(
SŒšgArg
 
f’ame
)

72  
GzFe
(::
gzİ’
(
f’ame
.
c_¡r
(), "wbe"));

75 
	g´iv©e
:

76 
ex¶ic™
 
GzFe
(
gzFe
 
fe
)

77 : 
fe_
(
fe
)

81 
gzFe
 
fe_
;

	@muduo/base/LogFile.cc

1 
	~<muduo/ba£/LogFe.h
>

3 
	~<muduo/ba£/FeUt.h
>

4 
	~<muduo/ba£/ProûssInfo.h
>

6 
	~<as£¹.h
>

7 
	~<¡dio.h
>

8 
	~<time.h
>

10 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
	gLogFe
::
	$LogFe
(cÚ¡ 
¡ršg
& 
ba£Çme
,

13 
size_t
 
rŞlSize
,

14 
boŞ
 
th»adSaã
,

15 
æushIÁ”v®
,

16 
checkEv”yN
)

17 : 
	`ba£Çme_
(
ba£Çme
),

18 
	`rŞlSize_
(
rŞlSize
),

19 
	`æushIÁ”v®_
(
æushIÁ”v®
),

20 
	`checkEv”yN_
(
checkEv”yN
),

21 
	`couÁ_
(0),

22 
	`mu‹x_
(
th»adSaã
 ? 
Ãw
 
Mu‹xLock
 : 
NULL
),

23 
	`¡¬tOfP”iod_
(0),

24 
	`Ï¡RŞl_
(0),

25 
	$Ï¡Flush_
(0)

27 
	`as£¹
(
ba£Çme
.
	`fšd
('/'è=ğ
¡ršg
::
Åos
);

28 
	`rŞlFe
();

29 
	}
}

31 
	gLogFe
::~
	$LogFe
()

33 
	}
}

35 
LogFe
::
	$­³nd
(cÚ¡ * 
loglše
, 
Ën
)

37 ià(
mu‹x_
)

39 
Mu‹xLockGu¬d
 
	`lock
(*
mu‹x_
);

40 
	`­³nd_uÆocked
(
loglše
, 
Ën
);

44 
	`­³nd_uÆocked
(
loglše
, 
Ën
);

46 
	}
}

48 
	gLogFe
::
	$æush
()

50 ià(
mu‹x_
)

52 
Mu‹xLockGu¬d
 
	`lock
(*
mu‹x_
);

53 
fe_
->
	`æush
();

57 
fe_
->
	`æush
();

59 
	}
}

61 
	gLogFe
::
	$­³nd_uÆocked
(cÚ¡ * 
loglše
, 
Ën
)

63 
fe_
->
	`­³nd
(
loglše
, 
Ën
);

65 ià(
fe_
->
	`wr™‹nBy‹s
(è> 
rŞlSize_
)

67 
	`rŞlFe
();

71 ++
couÁ_
;

72 ià(
couÁ_
 >ğ
checkEv”yN_
)

74 
couÁ_
 = 0;

75 
time_t
 
now
 = ::
	`time
(
NULL
);

76 
time_t
 
thisP”iod_
 = 
now
 / 
kRŞlP”SecÚds_
 * kRollPerSeconds_;

77 ià(
thisP”iod_
 !ğ
¡¬tOfP”iod_
)

79 
	`rŞlFe
();

81 ià(
now
 - 
Ï¡Flush_
 > 
æushIÁ”v®_
)

83 
Ï¡Flush_
 = 
now
;

84 
fe_
->
	`æush
();

88 
	}
}

90 
boŞ
 
	gLogFe
::
	$rŞlFe
()

92 
time_t
 
now
 = 0;

93 
¡ršg
 
f’ame
 = 
	`g‘LogFeName
(
ba£Çme_
, &
now
);

94 
time_t
 
¡¬t
 = 
now
 / 
kRŞlP”SecÚds_
 * kRollPerSeconds_;

96 ià(
now
 > 
Ï¡RŞl_
)

98 
Ï¡RŞl_
 = 
now
;

99 
Ï¡Flush_
 = 
now
;

100 
¡¬tOfP”iod_
 = 
¡¬t
;

101 
fe_
.
	`»£t
(
Ãw
 
FeUt
::
	`Aµ’dFe
(
f’ame
));

102  
Œue
;

104  
çl£
;

105 
	}
}

107 
¡ršg
 
	gLogFe
::
	$g‘LogFeName
(cÚ¡ 
¡ršg
& 
ba£Çme
, 
time_t
* 
now
)

109 
¡ršg
 
f’ame
;

110 
f’ame
.
	`»£rve
(
ba£Çme
.
	`size
() + 64);

111 
f’ame
 = 
ba£Çme
;

113 
timebuf
[32];

114 
tm
m;

115 *
now
 = 
	`time
(
NULL
);

116 
	`gmtime_r
(
now
, &
tm
);

117 
	`¡ráime
(
timebuf
, imebuf, ".%Y%m%d-%H%M%S.", &
tm
);

118 
f’ame
 +ğ
timebuf
;

120 
f’ame
 +ğ
ProûssInfo
::
	`ho¡Çme
();

122 
pidbuf
[32];

123 
	`¢´štf
(
pidbuf
, …idbuf, ".%d", 
ProûssInfo
::
	`pid
());

124 
f’ame
 +ğ
pidbuf
;

126 
f’ame
 += ".log";

128  
f’ame
;

129 
	}
}

	@muduo/base/LogFile.h

1 #iâdeà
MUDUO_BASE_LOGFILE_H


2 
	#MUDUO_BASE_LOGFILE_H


	)

4 
	~<muduo/ba£/Mu‹x.h
>

5 
	~<muduo/ba£/Ty³s.h
>

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<boo¡/scİed_±r.hµ
>

10 
Çme¥aû
 
	gmuduo


13 
Çme¥aû
 
	gFeUt


15 
şass
 
	gAµ’dFe
;

18 şas 
	cLogFe
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
LogFe
(cÚ¡ 
¡ršg
& 
ba£Çme
,

22 
size_t
 
rŞlSize
,

23 
boŞ
 
th»adSaã
 = 
Œue
,

24 
æushIÁ”v®
 = 3,

25 
checkEv”yN
 = 1024);

26 ~
LogFe
();

28 
­³nd
(cÚ¡ * 
loglše
, 
Ën
);

29 
æush
();

30 
boŞ
 
rŞlFe
();

32 
	g´iv©e
:

33 
­³nd_uÆocked
(cÚ¡ * 
loglše
, 
Ën
);

35 
¡ršg
 
g‘LogFeName
(cÚ¡ sŒšg& 
ba£Çme
, 
time_t
* 
now
);

37 cÚ¡ 
¡ršg
 
	gba£Çme_
;

38 cÚ¡ 
size_t
 
	grŞlSize_
;

39 cÚ¡ 
	gæushIÁ”v®_
;

40 cÚ¡ 
	gcheckEv”yN_
;

42 
	gcouÁ_
;

44 
	gboo¡
::
scİed_±r
<
Mu‹xLock
> 
mu‹x_
;

45 
time_t
 
	g¡¬tOfP”iod_
;

46 
time_t
 
	gÏ¡RŞl_
;

47 
time_t
 
	gÏ¡Flush_
;

48 
	gboo¡
::
scİed_±r
<
FeUt
::
Aµ’dFe
> 
fe_
;

50 cÚ¡ 
	gkRŞlP”SecÚds_
 = 60*60*24;

	@muduo/base/LogFile.h

1 #iâdeà
MUDUO_BASE_LOGFILE_H


2 
	#MUDUO_BASE_LOGFILE_H


	)

4 
	~<muduo/ba£/Mu‹x.h
>

5 
	~<muduo/ba£/Ty³s.h
>

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<boo¡/scİed_±r.hµ
>

10 
Çme¥aû
 
	gmuduo


13 
Çme¥aû
 
	gFeUt


15 
şass
 
	gAµ’dFe
;

18 şas 
	cLogFe
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
LogFe
(cÚ¡ 
¡ršg
& 
ba£Çme
,

22 
size_t
 
rŞlSize
,

23 
boŞ
 
th»adSaã
 = 
Œue
,

24 
æushIÁ”v®
 = 3,

25 
checkEv”yN
 = 1024);

26 ~
LogFe
();

28 
­³nd
(cÚ¡ * 
loglše
, 
Ën
);

29 
æush
();

30 
boŞ
 
rŞlFe
();

32 
	g´iv©e
:

33 
­³nd_uÆocked
(cÚ¡ * 
loglše
, 
Ën
);

35 
¡ršg
 
g‘LogFeName
(cÚ¡ sŒšg& 
ba£Çme
, 
time_t
* 
now
);

37 cÚ¡ 
¡ršg
 
	gba£Çme_
;

38 cÚ¡ 
size_t
 
	grŞlSize_
;

39 cÚ¡ 
	gæushIÁ”v®_
;

40 cÚ¡ 
	gcheckEv”yN_
;

42 
	gcouÁ_
;

44 
	gboo¡
::
scİed_±r
<
Mu‹xLock
> 
mu‹x_
;

45 
time_t
 
	g¡¬tOfP”iod_
;

46 
time_t
 
	gÏ¡RŞl_
;

47 
time_t
 
	gÏ¡Flush_
;

48 
	gboo¡
::
scİed_±r
<
FeUt
::
Aµ’dFe
> 
fe_
;

50 cÚ¡ 
	gkRŞlP”SecÚds_
 = 60*60*24;

	@muduo/base/LogStream.cc

1 
	~<muduo/ba£/LogSŒ—m.h
>

3 
	~<®gÜ™hm
>

4 
	~<lim™s
>

5 
	~<boo¡/¡©ic_as£¹.hµ
>

6 
	~<boo¡/ty³_Œa™s/is_¬™hm‘ic.hµ
>

7 
	~<as£¹.h
>

8 
	~<¡ršg.h
>

9 
	~<¡dšt.h
>

10 
	~<¡dio.h
>

12 
usšg
 
Çme¥aû
 
	gmuduo
;

13 
usšg
 
Çme¥aû
 
	gmuduo
::
d‘a
;

15 #ià
defšed
(
__şªg__
)

16 #´agm¨
şªg
 
dŸgno¡ic
 
ignÜed
 "-Wtautological-compare"

18 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wtype-limits"

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gd‘a


26 cÚ¡ 
	gdig™s
[] = "9876543210123456789";

27 cÚ¡ * 
	gz”o
 = 
dig™s
 + 9;

28 
BOOST_STATIC_ASSERT
((
dig™s
) == 20);

30 cÚ¡ 
	gdig™sHex
[] = "0123456789ABCDEF";

31 
BOOST_STATIC_ASSERT
( 
dig™sHex
 == 17);

34 
	g‹m¶©e
<
ty³Çme
 
	gT
>

35 
size_t
 
cÚv”t
(
buf
[], 
T
 
v®ue
)

37 
T
 
	gi
 = 
v®ue
;

38 * 
	gp
 = 
buf
;

42 
	glsd
 = 
¡©ic_ÿ¡
<>(
i
 % 10);

43 
	gi
 /= 10;

44 *
	gp
++ = 
z”o
[
lsd
];

45 } 
	gi
 != 0);

47 ià(
	gv®ue
 < 0)

49 *
	gp
++ = '-';

51 *
	gp
 = '\0';

52 
	g¡d
::
»v”£
(
buf
, 
p
);

54  
	gp
 - 
	gbuf
;

57 
size_t
 
cÚv”tHex
(
buf
[], 
ušŒ_t
 
v®ue
)

59 
ušŒ_t
 
	gi
 = 
v®ue
;

60 * 
	gp
 = 
buf
;

64 
	glsd
 = 
¡©ic_ÿ¡
<>(
i
 % 16);

65 
	gi
 /= 16;

66 *
	gp
++ = 
dig™sHex
[
lsd
];

67 } 
	gi
 != 0);

69 *
	gp
 = '\0';

70 
	g¡d
::
»v”£
(
buf
, 
p
);

72  
	gp
 - 
	gbuf
;

75 
‹m¶©e
 
şass
 
	gFixedBufãr
<
	gkSm®lBufãr
>;

76 
‹m¶©e
 
şass
 
	gFixedBufãr
<
	gkL¬geBufãr
>;

81 
	g‹m¶©e
<
	gSIZE
>

82 cÚ¡ * 
	gFixedBufãr
<
	gSIZE
>::
	$debugSŒšg
()

84 *
cur_
 = '\0';

85  
d©a_
;

86 
	}
}

88 
	g‹m¶©e
<
	gSIZE
>

89 
	gFixedBufãr
<
	gSIZE
>::
	$cook›S¹
()

91 
	}
}

93 
‹m¶©e
<
SIZE
>

94 
FixedBufãr
<
SIZE
>::
	$cook›End
()

96 
	}
}

98 
LogSŒ—m
::
	$¡©icCheck
()

100 
	`BOOST_STATIC_ASSERT
(
kMaxNum”icSize
 - 10 > 
¡d
::
num”ic_lim™s
<>::
dig™s10
);

101 
	`BOOST_STATIC_ASSERT
(
kMaxNum”icSize
 - 10 > 
¡d
::
num”ic_lim™s
<>::
dig™s10
);

102 
	`BOOST_STATIC_ASSERT
(
kMaxNum”icSize
 - 10 > 
¡d
::
num”ic_lim™s
<>::
dig™s10
);

103 
	`BOOST_STATIC_ASSERT
(
kMaxNum”icSize
 - 10 > 
¡d
::
num”ic_lim™s
<>::
dig™s10
);

104 
	}
}

106 
	g‹m¶©e
<
ty³Çme
 
	gT
>

107 
	gLogSŒ—m
::
	$fÜm©IÁeg”
(
T
 
v
)

109 ià(
bufãr_
.
	`ava
(è>ğ
kMaxNum”icSize
)

111 
size_t
 
Ën
 = 
	`cÚv”t
(
bufãr_
.
	`cu¼’t
(), 
v
);

112 
bufãr_
.
	`add
(
Ën
);

114 
	}
}

116 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(
v
)

118 *
this
 << 
¡©ic_ÿ¡
<>(
v
);

119  *
	gthis
;

122 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(
v
)

124 *
this
 << 
¡©ic_ÿ¡
<>(
v
);

125  *
	gthis
;

128 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(
v
)

130 
fÜm©IÁeg”
(
v
);

131  *
	gthis
;

134 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(
v
)

136 
fÜm©IÁeg”
(
v
);

137  *
	gthis
;

140 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(
v
)

142 
fÜm©IÁeg”
(
v
);

143  *
	gthis
;

146 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(
v
)

148 
fÜm©IÁeg”
(
v
);

149  *
	gthis
;

152 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(
v
)

154 
fÜm©IÁeg”
(
v
);

155  *
	gthis
;

158 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(
v
)

160 
fÜm©IÁeg”
(
v
);

161  *
	gthis
;

164 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(cÚ¡ * 
p
)

166 
ušŒ_t
 
v
 = 
»š‹½»t_ÿ¡
<ušŒ_t>(
p
);

167 ià(
	gbufãr_
.
ava
(è>ğ
kMaxNum”icSize
)

169 * 
buf
 = 
bufãr_
.
cu¼’t
();

170 
	gbuf
[0] = '0';

171 
	gbuf
[1] = 'x';

172 
size_t
 
	gËn
 = 
cÚv”tHex
(
buf
+2, 
v
);

173 
	gbufãr_
.
add
(
Ën
+2);

175  *
	gthis
;

179 
	gLogSŒ—m
& LogSŒ—m::
İ”©Ü
<<(
v
)

181 ià(
bufãr_
.
ava
(è>ğ
kMaxNum”icSize
)

183 
Ën
 = 
¢´štf
(
bufãr_
.
cu¼’t
(), 
kMaxNum”icSize
, "%.12g", 
v
);

184 
	gbufãr_
.
add
(
Ën
);

186  *
	gthis
;

189 
	g‹m¶©e
<
ty³Çme
 
	gT
>

190 
	gFmt
::
	$Fmt
(cÚ¡ * 
fmt
, 
T
 
v®
)

192 
	`BOOST_STATIC_ASSERT
(
boo¡
::
is_¬™hm‘ic
<
T
>::
v®ue
 =ğ
Œue
);

194 
Ëngth_
 = 
	`¢´štf
(
buf_
,  buf_, 
fmt
, 
v®
);

195 
	`as£¹
(
¡©ic_ÿ¡
<
size_t
>(
Ëngth_
è<  
buf_
);

196 
	}
}

200 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

202 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

203 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

204 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

205 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

206 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

207 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

208 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

209 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

211 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

212 
‹m¶©e
 
	gFmt
::
Fmt
(cÚ¡ * 
fmt
, );

	@muduo/base/LogStream.h

1 #iâdeà
MUDUO_BASE_LOGSTREAM_H


2 
	#MUDUO_BASE_LOGSTREAM_H


	)

4 
	~<muduo/ba£/SŒšgP›û.h
>

5 
	~<muduo/ba£/Ty³s.h
>

6 
	~<as£¹.h
>

7 
	~<¡ršg.h
>

8 #iâdeà
MUDUO_STD_STRING


9 
	~<¡ršg
>

11 
	~<boo¡/nÚcİyabË.hµ
>

13 
Çme¥aû
 
	gmuduo


16 
Çme¥aû
 
	gd‘a


19 cÚ¡ 
	gkSm®lBufãr
 = 4000;

20 cÚ¡ 
	gkL¬geBufãr
 = 4000*1000;

22 
	g‹m¶©e
<
	gSIZE
>

23 şas 
	cFixedBufãr
 : 
boo¡
::
nÚcİyabË


25 
public
:

26 
FixedBufãr
()

27 : 
cur_
(
d©a_
)

29 
£tCook›
(
cook›S¹
);

32 ~
FixedBufãr
()

34 
£tCook›
(
cook›End
);

37 
­³nd
(cÚ¡ * 
buf
, 
size_t
 
Ën
)

40 ià(
	gim¶ic™_ÿ¡
<
	gsize_t
>(
ava
()è> 
	gËn
)

42 
memıy
(
cur_
, 
buf
, 
Ën
);

43 
	gcur_
 +ğ
Ën
;

47 cÚ¡ * 
d©a
(ècÚ¡ {  
	gd©a_
; }

48 
Ëngth
(ècÚ¡ {  
	g¡©ic_ÿ¡
<>(
	gcur_
 - 
	gd©a_
); }

51 * 
cu¼’t
(è{  
	gcur_
; }

52 
ava
(ècÚ¡ {  
	g¡©ic_ÿ¡
<>(
’d
(è- 
	gcur_
); }

53 
add
(
size_t
 
Ën
è{ 
	gcur_
 +=†en; }

55 
»£t
(è{ 
	gcur_
 = 
d©a_
; }

56 
bz”o
(è{ ::bz”o(
d©a_
,  data_); }

59 cÚ¡ * 
debugSŒšg
();

60 
£tCook›
((*
cook›
)()è{ 
	gcook›_
 = cookie; }

62 
¡ršg
 
toSŒšg
(ècÚ¡ {  sŒšg(
d©a_
, 
Ëngth
()); }

63 
SŒšgP›û
 
toSŒšgP›û
(ècÚ¡ {  SŒšgP›û(
d©a_
, 
Ëngth
()); }

65 
	g´iv©e
:

66 cÚ¡ * 
’d
(ècÚ¡ {  
d©a_
 +  data_; }

68 
cook›S¹
();

69 
cook›End
();

71 (*
	gcook›_
)();

72 
	gd©a_
[
SIZE
];

73 * 
	gcur_
;

78 şas 
	cLogSŒ—m
 : 
boo¡
::
nÚcİyabË


80 
LogSŒ—m
 
	t£lf
;

81 
	gpublic
:

82 
d‘a
::
	tFixedBufãr
<
	td‘a
::
	tkSm®lBufãr
> 
	tBufãr
;

84 
	g£lf
& 
	gİ”©Ü
<<(
boŞ
 
	gv
)

86 
	gbufãr_
.
­³nd
(
v
 ? "1" : "0", 1);

87  *
	gthis
;

90 
	g£lf
& 
	gİ”©Ü
<<();

91 
	g£lf
& 
	gİ”©Ü
<<();

92 
	g£lf
& 
	gİ”©Ü
<<();

93 
	g£lf
& 
	gİ”©Ü
<<();

94 
	g£lf
& 
	gİ”©Ü
<<();

95 
	g£lf
& 
	gİ”©Ü
<<();

96 
	g£lf
& 
	gİ”©Ü
<<();

97 
	g£lf
& 
	gİ”©Ü
<<();

99 
	g£lf
& 
	gİ”©Ü
<<(const *);

101 
	g£lf
& 
	gİ”©Ü
<<(
	gv
)

103 *
	gthis
 << 
	g¡©ic_ÿ¡
<>(
	gv
);

104  *
	gthis
;

106 
	g£lf
& 
	gİ”©Ü
<<();

109 
	g£lf
& 
	gİ”©Ü
<<(
	gv
)

111 
	gbufãr_
.
­³nd
(&
v
, 1);

112  *
	gthis
;

118 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ * 
	g¡r
)

120 ià(
	g¡r
)

122 
	gbufãr_
.
­³nd
(
¡r
, 
¡¾’
(str));

126 
	gbufãr_
.
­³nd
("(null)", 6);

128  *
	gthis
;

131 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ * 
	g¡r
)

133  
	gİ”©Ü
<<(
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	g¡r
));

136 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ 
	g¡ršg
& 
	gv
)

138 
	gbufãr_
.
­³nd
(
v
.
c_¡r
(), v.
size
());

139  *
	gthis
;

142 #iâdeà
MUDUO_STD_STRING


143 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ 
	g¡d
::
¡ršg
& 
v
)

145 
bufãr_
.
­³nd
(
v
.
c_¡r
(), v.
size
());

146  *
	gthis
;

150 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ 
	gSŒšgP›û
& 
	gv
)

152 
	gbufãr_
.
­³nd
(
v
.
d©a
(), v.
size
());

153  *
	gthis
;

156 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ 
	gBufãr
& 
	gv
)

158 *
	gthis
 << 
	gv
.
toSŒšgP›û
();

159  *
	gthis
;

162 
­³nd
(cÚ¡ * 
d©a
, 
Ën
è{ 
	gbufãr_
.append(data,†en); }

163 cÚ¡ 
	gBufãr
& 
bufãr
(ècÚ¡ {  
	gbufãr_
; }

164 
»£tBufãr
(è{ 
	gbufãr_
.
»£t
(); }

166 
	g´iv©e
:

167 
¡©icCheck
();

169 
	g‹m¶©e
<
ty³Çme
 
	gT
>

170 
fÜm©IÁeg”
(
T
);

172 
Bufãr
 
	gbufãr_
;

174 cÚ¡ 
	gkMaxNum”icSize
 = 32;

177 şas 
	cFmt


179 
	gpublic
:

180 
‹m¶©e
<
ty³Çme
 
T
>

181 
Fmt
(cÚ¡ * 
fmt
, 
T
 
v®
);

183 cÚ¡ * 
d©a
(ècÚ¡ {  
	gbuf_
; }

184 
Ëngth
(ècÚ¡ {  
	gËngth_
; }

186 
	g´iv©e
:

187 
buf_
[32];

188 
	gËngth_
;

191 
šlše
 
	gLogSŒ—m
& 
	gİ”©Ü
<<(LogSŒ—m& 
	gs
, cÚ¡ 
	gFmt
& 
	gfmt
)

193 
	gs
.
­³nd
(
fmt
.
d©a
(), fmt.
Ëngth
());

194  
	gs
;

	@muduo/base/LogStream.h

1 #iâdeà
MUDUO_BASE_LOGSTREAM_H


2 
	#MUDUO_BASE_LOGSTREAM_H


	)

4 
	~<muduo/ba£/SŒšgP›û.h
>

5 
	~<muduo/ba£/Ty³s.h
>

6 
	~<as£¹.h
>

7 
	~<¡ršg.h
>

8 #iâdeà
MUDUO_STD_STRING


9 
	~<¡ršg
>

11 
	~<boo¡/nÚcİyabË.hµ
>

13 
Çme¥aû
 
	gmuduo


16 
Çme¥aû
 
	gd‘a


19 cÚ¡ 
	gkSm®lBufãr
 = 4000;

20 cÚ¡ 
	gkL¬geBufãr
 = 4000*1000;

22 
	g‹m¶©e
<
	gSIZE
>

23 şas 
	cFixedBufãr
 : 
boo¡
::
nÚcİyabË


25 
public
:

26 
FixedBufãr
()

27 : 
cur_
(
d©a_
)

29 
£tCook›
(
cook›S¹
);

32 ~
FixedBufãr
()

34 
£tCook›
(
cook›End
);

37 
­³nd
(cÚ¡ * 
buf
, 
size_t
 
Ën
)

40 ià(
	gim¶ic™_ÿ¡
<
	gsize_t
>(
ava
()è> 
	gËn
)

42 
memıy
(
cur_
, 
buf
, 
Ën
);

43 
	gcur_
 +ğ
Ën
;

47 cÚ¡ * 
d©a
(ècÚ¡ {  
	gd©a_
; }

48 
Ëngth
(ècÚ¡ {  
	g¡©ic_ÿ¡
<>(
	gcur_
 - 
	gd©a_
); }

51 * 
cu¼’t
(è{  
	gcur_
; }

52 
ava
(ècÚ¡ {  
	g¡©ic_ÿ¡
<>(
’d
(è- 
	gcur_
); }

53 
add
(
size_t
 
Ën
è{ 
	gcur_
 +=†en; }

55 
»£t
(è{ 
	gcur_
 = 
d©a_
; }

56 
bz”o
(è{ ::bz”o(
d©a_
,  data_); }

59 cÚ¡ * 
debugSŒšg
();

60 
£tCook›
((*
cook›
)()è{ 
	gcook›_
 = cookie; }

62 
¡ršg
 
toSŒšg
(ècÚ¡ {  sŒšg(
d©a_
, 
Ëngth
()); }

63 
SŒšgP›û
 
toSŒšgP›û
(ècÚ¡ {  SŒšgP›û(
d©a_
, 
Ëngth
()); }

65 
	g´iv©e
:

66 cÚ¡ * 
’d
(ècÚ¡ {  
d©a_
 +  data_; }

68 
cook›S¹
();

69 
cook›End
();

71 (*
	gcook›_
)();

72 
	gd©a_
[
SIZE
];

73 * 
	gcur_
;

78 şas 
	cLogSŒ—m
 : 
boo¡
::
nÚcİyabË


80 
LogSŒ—m
 
	t£lf
;

81 
	gpublic
:

82 
d‘a
::
	tFixedBufãr
<
	td‘a
::
	tkSm®lBufãr
> 
	tBufãr
;

84 
	g£lf
& 
	gİ”©Ü
<<(
boŞ
 
	gv
)

86 
	gbufãr_
.
­³nd
(
v
 ? "1" : "0", 1);

87  *
	gthis
;

90 
	g£lf
& 
	gİ”©Ü
<<();

91 
	g£lf
& 
	gİ”©Ü
<<();

92 
	g£lf
& 
	gİ”©Ü
<<();

93 
	g£lf
& 
	gİ”©Ü
<<();

94 
	g£lf
& 
	gİ”©Ü
<<();

95 
	g£lf
& 
	gİ”©Ü
<<();

96 
	g£lf
& 
	gİ”©Ü
<<();

97 
	g£lf
& 
	gİ”©Ü
<<();

99 
	g£lf
& 
	gİ”©Ü
<<(const *);

101 
	g£lf
& 
	gİ”©Ü
<<(
	gv
)

103 *
	gthis
 << 
	g¡©ic_ÿ¡
<>(
	gv
);

104  *
	gthis
;

106 
	g£lf
& 
	gİ”©Ü
<<();

109 
	g£lf
& 
	gİ”©Ü
<<(
	gv
)

111 
	gbufãr_
.
­³nd
(&
v
, 1);

112  *
	gthis
;

118 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ * 
	g¡r
)

120 ià(
	g¡r
)

122 
	gbufãr_
.
­³nd
(
¡r
, 
¡¾’
(str));

126 
	gbufãr_
.
­³nd
("(null)", 6);

128  *
	gthis
;

131 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ * 
	g¡r
)

133  
	gİ”©Ü
<<(
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	g¡r
));

136 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ 
	g¡ršg
& 
	gv
)

138 
	gbufãr_
.
­³nd
(
v
.
c_¡r
(), v.
size
());

139  *
	gthis
;

142 #iâdeà
MUDUO_STD_STRING


143 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ 
	g¡d
::
¡ršg
& 
v
)

145 
bufãr_
.
­³nd
(
v
.
c_¡r
(), v.
size
());

146  *
	gthis
;

150 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ 
	gSŒšgP›û
& 
	gv
)

152 
	gbufãr_
.
­³nd
(
v
.
d©a
(), v.
size
());

153  *
	gthis
;

156 
	g£lf
& 
	gİ”©Ü
<<(cÚ¡ 
	gBufãr
& 
	gv
)

158 *
	gthis
 << 
	gv
.
toSŒšgP›û
();

159  *
	gthis
;

162 
­³nd
(cÚ¡ * 
d©a
, 
Ën
è{ 
	gbufãr_
.append(data,†en); }

163 cÚ¡ 
	gBufãr
& 
bufãr
(ècÚ¡ {  
	gbufãr_
; }

164 
»£tBufãr
(è{ 
	gbufãr_
.
»£t
(); }

166 
	g´iv©e
:

167 
¡©icCheck
();

169 
	g‹m¶©e
<
ty³Çme
 
	gT
>

170 
fÜm©IÁeg”
(
T
);

172 
Bufãr
 
	gbufãr_
;

174 cÚ¡ 
	gkMaxNum”icSize
 = 32;

177 şas 
	cFmt


179 
	gpublic
:

180 
‹m¶©e
<
ty³Çme
 
T
>

181 
Fmt
(cÚ¡ * 
fmt
, 
T
 
v®
);

183 cÚ¡ * 
d©a
(ècÚ¡ {  
	gbuf_
; }

184 
Ëngth
(ècÚ¡ {  
	gËngth_
; }

186 
	g´iv©e
:

187 
buf_
[32];

188 
	gËngth_
;

191 
šlše
 
	gLogSŒ—m
& 
	gİ”©Ü
<<(LogSŒ—m& 
	gs
, cÚ¡ 
	gFmt
& 
	gfmt
)

193 
	gs
.
­³nd
(
fmt
.
d©a
(), fmt.
Ëngth
());

194  
	gs
;

	@muduo/base/Logging.cc

1 
	~<muduo/ba£/Loggšg.h
>

3 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

4 
	~<muduo/ba£/Time¡amp.h
>

5 
	~<muduo/ba£/TimeZÚe.h
>

7 
	~<”ºo.h
>

8 
	~<¡dio.h
>

9 
	~<¡ršg.h
>

11 
	~<s¡»am
>

13 
Çme¥aû
 
	gmuduo


33 
__th»ad
 
	gt_”ºobuf
[512];

34 
__th»ad
 
	gt_time
[32];

35 
__th»ad
 
time_t
 
	gt_Ï¡SecÚd
;

37 cÚ¡ * 
¡»¼Ü_
(
§vedE¼no
)

39  
¡»¼Ü_r
(
§vedE¼no
, 
t_”ºobuf
, _errnobuf);

42 
	gLogg”
::
LogLev–
 
š™LogLev–
()

44 ià(::
g‘’v
("MUDUO_LOG_TRACE"))

45  
Logg”
::
TRACE
;

46 ià(::
g‘’v
("MUDUO_LOG_DEBUG"))

47  
Logg”
::
DEBUG
;

49  
	gLogg”
::
INFO
;

52 
	gLogg”
::
LogLev–
 
g_logLev–
 = 
š™LogLev–
();

54 cÚ¡ * 
	gLogLev–Name
[
Logg”
::
NUM_LOG_LEVELS
] =

65 şas 
	cT


67 
	gpublic
:

68 
T
(cÚ¡ * 
¡r
, 
Ën
)

69 :
¡r_
(
¡r
),

70 
Ën_
(
Ën
)

72 
as£¹
(
¡¾’
(
¡r
è=ğ
Ën_
);

75 cÚ¡ * 
	g¡r_
;

76 cÚ¡ 
	gËn_
;

79 
šlše
 
	gLogSŒ—m
& 
	gİ”©Ü
<<(LogSŒ—m& 
	gs
, 
T
 
	gv
)

81 
	gs
.
­³nd
(
v
.
¡r_
, v.
Ën_
);

82  
	gs
;

85 
šlše
 
	gLogSŒ—m
& 
	gİ”©Ü
<<(LogSŒ—m& 
	gs
, cÚ¡ 
	gLogg”
::
SourûFe
& 
v
)

87 
s
.
­³nd
(
v
.
d©a_
, v.
size_
);

88  
	gs
;

91 
	$deçuÉOuut
(cÚ¡ * 
msg
, 
Ën
)

93 
size_t
 
n
 = 
	`fwr™e
(
msg
, 1, 
Ën
, 
¡dout
);

95 ()
n
;

96 
	}
}

98 
	$deçuÉFlush
()

100 
	`fæush
(
¡dout
);

101 
	}
}

103 
	gLogg”
::
OuutFunc
 
g_ouut
 = 
deçuÉOuut
;

104 
	gLogg”
::
FlushFunc
 
g_æush
 = 
deçuÉFlush
;

105 
TimeZÚe
 
	gg_logTimeZÚe
;

109 
usšg
 
Çme¥aû
 
	gmuduo
;

111 
	gLogg”
::
Im¶
::
	$Im¶
(
LogLev–
 
Ëv–
, 
§vedE¼no
, cÚ¡ 
SourûFe
& 
fe
, 
lše
)

112 : 
	`time_
(
Time¡amp
::
	`now
()),

113 
	`¡»am_
(),

114 
	`Ëv–_
(
Ëv–
),

115 
	`lše_
(
lše
),

116 
	$ba£Çme_
(
fe
)

118 
	`fÜm©Time
();

119 
Cu¼’tTh»ad
::
	`tid
();

120 
¡»am_
 << 
	`T
(
Cu¼’tTh»ad
::
	`tidSŒšg
(), Cu¼’tTh»ad::
	`tidSŒšgL’gth
());

121 
¡»am_
 << 
	`T
(
LogLev–Name
[
Ëv–
], 6);

122 ià(
§vedE¼no
 != 0)

124 
¡»am_
 << 
	`¡»¼Ü_
(
§vedE¼no
) << " (errno=" << savedErrno << ") ";

126 
	}
}

128 
	gLogg”
::
Im¶
::
	$fÜm©Time
()

130 
št64_t
 
miüoSecÚdsSšûEpoch
 = 
time_
.
	`miüoSecÚdsSšûEpoch
();

131 
time_t
 
£cÚds
 = 
¡©ic_ÿ¡
<time_t>(
miüoSecÚdsSšûEpoch
 / 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
);

132 
miüo£cÚds
 = 
¡©ic_ÿ¡
<>(
miüoSecÚdsSšûEpoch
 % 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
);

133 ià(
£cÚds
 !ğ
t_Ï¡SecÚd
)

135 
t_Ï¡SecÚd
 = 
£cÚds
;

136 
tm
 
tm_time
;

137 ià(
g_logTimeZÚe
.
	`v®id
())

139 
tm_time
 = 
g_logTimeZÚe
.
	`toLoÿlTime
(
£cÚds
);

143 ::
	`gmtime_r
(&
£cÚds
, &
tm_time
);

146 
Ën
 = 
	`¢´štf
(
t_time
, (t_time), "%4d%02d%02d %02d:%02d:%02d",

147 
tm_time
.
tm_y—r
 + 1900,m_time.
tm_mÚ
 + 1,m_time.
tm_mday
,

148 
tm_time
.
tm_hour
,m_time.
tm_mš
,m_time.
tm_£c
);

149 
	`as£¹
(
Ën
 == 17); ()len;

152 ià(
g_logTimeZÚe
.
	`v®id
())

154 
Fmt
 
	`us
(".%06d ", 
miüo£cÚds
);

155 
	`as£¹
(
us
.
	`Ëngth
() == 8);

156 
¡»am_
 << 
	`T
(
t_time
, 17è<< T(
us
.
	`d©a
(), 8);

160 
Fmt
 
	`us
(".%06dZ ", 
miüo£cÚds
);

161 
	`as£¹
(
us
.
	`Ëngth
() == 9);

162 
¡»am_
 << 
	`T
(
t_time
, 17è<< T(
us
.
	`d©a
(), 9);

164 
	}
}

166 
	gLogg”
::
Im¶
::
	$fšish
()

168 
¡»am_
 << " - " << 
ba£Çme_
 << ':' << 
lše_
 << '\n';

169 
	}
}

171 
	gLogg”
::
	$Logg”
(
SourûFe
 
fe
, 
lše
)

172 : 
	$im¶_
(
INFO
, 0, 
fe
, 
lše
)

174 
	}
}

176 
	gLogg”
::
	$Logg”
(
SourûFe
 
fe
, 
lše
, 
LogLev–
 
Ëv–
, cÚ¡ * 
func
)

177 : 
	$im¶_
(
Ëv–
, 0, 
fe
, 
lše
)

179 
im¶_
.
¡»am_
 << 
func
 << ' ';

180 
	}
}

182 
	gLogg”
::
	$Logg”
(
SourûFe
 
fe
, 
lše
, 
LogLev–
 
Ëv–
)

183 : 
	$im¶_
(
Ëv–
, 0, 
fe
, 
lše
)

185 
	}
}

187 
	gLogg”
::
	$Logg”
(
SourûFe
 
fe
, 
lše
, 
boŞ
 
toAbÜt
)

188 : 
	`im¶_
(
toAbÜt
?
FATAL
:
ERROR
, 
”ºo
, 
fe
, 
lše
)

190 
	}
}

192 
	gLogg”
::~
	$Logg”
()

194 
im¶_
.
	`fšish
();

195 cÚ¡ 
LogSŒ—m
::
Bufãr
& 
	`buf
(
	`¡»am
().
	`bufãr
());

196 
	`g_ouut
(
buf
.
	`d©a
(), buf.
	`Ëngth
());

197 ià(
im¶_
.
Ëv–_
 =ğ
FATAL
)

199 
	`g_æush
();

200 
	`abÜt
();

202 
	}
}

204 
	gLogg”
::
£tLogLev–
(
Logg”
::
LogLev–
 
Ëv–
)

206 
g_logLev–
 = 
Ëv–
;

209 
	gLogg”
::
	$£tOuut
(
OuutFunc
 
out
)

211 
g_ouut
 = 
out
;

212 
	}
}

214 
	gLogg”
::
	$£tFlush
(
FlushFunc
 
æush
)

216 
g_æush
 = 
æush
;

217 
	}
}

219 
	gLogg”
::
	$£tTimeZÚe
(cÚ¡ 
TimeZÚe
& 
tz
)

221 
g_logTimeZÚe
 = 
tz
;

222 
	}
}

	@muduo/base/Logging.h

1 #iâdeà
MUDUO_BASE_LOGGING_H


2 
	#MUDUO_BASE_LOGGING_H


	)

4 
	~<muduo/ba£/LogSŒ—m.h
>

5 
	~<muduo/ba£/Time¡amp.h
>

7 
Çme¥aû
 
	gmuduo


10 
şass
 
	gTimeZÚe
;

12 şas 
	cLogg”


14 
	gpublic
:

15 
	eLogLev–


17 
TRACE
,

18 
	gDEBUG
,

19 
	gINFO
,

20 
	gWARN
,

21 
	gERROR
,

22 
	gFATAL
,

23 
	gNUM_LOG_LEVELS
,

27 şas 
	cSourûFe


29 
	gpublic
:

30 
‹m¶©e
<
N
>

31 
šlše
 
SourûFe
(cÚ¡ (&
¬r
)[
N
])

32 : 
d©a_
(
¬r
),

33 
size_
(
N
-1)

35 cÚ¡ * 
	g¦ash
 = 
¡¼chr
(
d©a_
, '/');

36 ià(
	g¦ash
)

38 
	gd©a_
 = 
¦ash
 + 1;

39 
	gsize_
 -ğ
¡©ic_ÿ¡
<>(
d©a_
 - 
¬r
);

43 
ex¶ic™
 
SourûFe
(cÚ¡ * 
f’ame
)

44 : 
d©a_
(
f’ame
)

46 cÚ¡ * 
¦ash
 = 
¡¼chr
(
f’ame
, '/');

47 ià(
	g¦ash
)

49 
	gd©a_
 = 
¦ash
 + 1;

51 
	gsize_
 = 
¡©ic_ÿ¡
<>(
¡¾’
(
d©a_
));

54 cÚ¡ * 
	gd©a_
;

55 
	gsize_
;

58 
Logg”
(
SourûFe
 
fe
, 
lše
);

59 
Logg”
(
SourûFe
 
fe
, 
lše
, 
LogLev–
 
Ëv–
);

60 
Logg”
(
SourûFe
 
fe
, 
lše
, 
LogLev–
 
Ëv–
, cÚ¡ * 
func
);

61 
Logg”
(
SourûFe
 
fe
, 
lše
, 
boŞ
 
toAbÜt
);

62 ~
Logg”
();

64 
	gLogSŒ—m
& 
¡»am
(è{  
	gim¶_
.
	g¡»am_
; }

66 
LogLev–
 
logLev–
();

67 
£tLogLev–
(
LogLev–
 
Ëv–
);

69 (*
	gOuutFunc
)(cÚ¡ * 
	tmsg
, 
	tËn
);

70 (*
	gFlushFunc
)();

71 
£tOuut
(
OuutFunc
);

72 
£tFlush
(
FlushFunc
);

73 
£tTimeZÚe
(cÚ¡ 
TimeZÚe
& 
tz
);

75 
	g´iv©e
:

77 şas 
	cIm¶


79 
public
:

80 
Logg”
::
	tLogLev–
 LogLevel;

81 
Im¶
(
LogLev–
 
Ëv–
, 
Şd_”ºo
, cÚ¡ 
SourûFe
& 
fe
, 
lše
);

82 
fÜm©Time
();

83 
fšish
();

85 
Time¡amp
 
	gtime_
;

86 
LogSŒ—m
 
	g¡»am_
;

87 
LogLev–
 
	gËv–_
;

88 
	glše_
;

89 
SourûFe
 
	gba£Çme_
;

92 
Im¶
 
	gim¶_
;

96 
Logg”
::
LogLev–
 
g_logLev–
;

98 
šlše
 
	gLogg”
::
LogLev–
 
Logg”
::
	$logLev–
()

100  
g_logLev–
;

101 
	}
}

119 
	#LOG_TRACE
 ià(
muduo
::
Logg”
::
	`logLev–
(è<ğmuduo::Logg”::
TRACE
) \

120 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
TRACE
, 
__func__
).
	$¡»am
()

	)

121 
	#LOG_DEBUG
 ià(
muduo
::
Logg”
::
	`logLev–
(è<ğmuduo::Logg”::
DEBUG
) \

122 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
DEBUG
, 
__func__
).
	$¡»am
()

	)

123 
	#LOG_INFO
 ià(
muduo
::
Logg”
::
	`logLev–
(è<ğmuduo::Logg”::
INFO
) \

124 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
).
	$¡»am
()

	)

125 
	#LOG_WARN
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
WARN
).
	$¡»am
()

	)

126 
	#LOG_ERROR
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
ERROR
).
	$¡»am
()

	)

127 
	#LOG_FATAL
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
FATAL
).
	$¡»am
()

	)

128 
	#LOG_SYSERR
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, 
çl£
).
	$¡»am
()

	)

129 
	#LOG_SYSFATAL
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, 
Œue
).
	$¡»am
()

	)

131 cÚ¡ * 
	`¡»¼Ü_
(
§vedE¼no
);

138 
	#CHECK_NOTNULL
(
v®
) \

139 ::
muduo
::
	`CheckNÙNuÎ
(
__FILE__
, 
__LINE__
, "'" #v® "' Mu¡ bnÚ NULL", (
v®
))

	)

142 
‹m¶©e
 <
ty³Çme
 
T
>

143 
T
* 
	`CheckNÙNuÎ
(
Logg”
::
SourûFe
 
fe
, 
lše
, cÚ¡ *
Çmes
, T* 
±r
)

145 ià(
±r
 =ğ
NULL
)

147 
	`Logg”
(
fe
, 
lše
, 
Logg”
::
FATAL
).
	`¡»am
(è<< 
Çmes
;

149  
±r
;

150 
	}
}

	@muduo/base/Logging.h

1 #iâdeà
MUDUO_BASE_LOGGING_H


2 
	#MUDUO_BASE_LOGGING_H


	)

4 
	~<muduo/ba£/LogSŒ—m.h
>

5 
	~<muduo/ba£/Time¡amp.h
>

7 
Çme¥aû
 
	gmuduo


10 
şass
 
	gTimeZÚe
;

12 şas 
	cLogg”


14 
	gpublic
:

15 
	eLogLev–


17 
TRACE
,

18 
	gDEBUG
,

19 
	gINFO
,

20 
	gWARN
,

21 
	gERROR
,

22 
	gFATAL
,

23 
	gNUM_LOG_LEVELS
,

27 şas 
	cSourûFe


29 
	gpublic
:

30 
‹m¶©e
<
N
>

31 
šlše
 
SourûFe
(cÚ¡ (&
¬r
)[
N
])

32 : 
d©a_
(
¬r
),

33 
size_
(
N
-1)

35 cÚ¡ * 
	g¦ash
 = 
¡¼chr
(
d©a_
, '/');

36 ià(
	g¦ash
)

38 
	gd©a_
 = 
¦ash
 + 1;

39 
	gsize_
 -ğ
¡©ic_ÿ¡
<>(
d©a_
 - 
¬r
);

43 
ex¶ic™
 
SourûFe
(cÚ¡ * 
f’ame
)

44 : 
d©a_
(
f’ame
)

46 cÚ¡ * 
¦ash
 = 
¡¼chr
(
f’ame
, '/');

47 ià(
	g¦ash
)

49 
	gd©a_
 = 
¦ash
 + 1;

51 
	gsize_
 = 
¡©ic_ÿ¡
<>(
¡¾’
(
d©a_
));

54 cÚ¡ * 
	gd©a_
;

55 
	gsize_
;

58 
Logg”
(
SourûFe
 
fe
, 
lše
);

59 
Logg”
(
SourûFe
 
fe
, 
lše
, 
LogLev–
 
Ëv–
);

60 
Logg”
(
SourûFe
 
fe
, 
lše
, 
LogLev–
 
Ëv–
, cÚ¡ * 
func
);

61 
Logg”
(
SourûFe
 
fe
, 
lše
, 
boŞ
 
toAbÜt
);

62 ~
Logg”
();

64 
	gLogSŒ—m
& 
¡»am
(è{  
	gim¶_
.
	g¡»am_
; }

66 
LogLev–
 
logLev–
();

67 
£tLogLev–
(
LogLev–
 
Ëv–
);

69 (*
	gOuutFunc
)(cÚ¡ * 
	tmsg
, 
	tËn
);

70 (*
	gFlushFunc
)();

71 
£tOuut
(
OuutFunc
);

72 
£tFlush
(
FlushFunc
);

73 
£tTimeZÚe
(cÚ¡ 
TimeZÚe
& 
tz
);

75 
	g´iv©e
:

77 şas 
	cIm¶


79 
public
:

80 
Logg”
::
	tLogLev–
 LogLevel;

81 
Im¶
(
LogLev–
 
Ëv–
, 
Şd_”ºo
, cÚ¡ 
SourûFe
& 
fe
, 
lše
);

82 
fÜm©Time
();

83 
fšish
();

85 
Time¡amp
 
	gtime_
;

86 
LogSŒ—m
 
	g¡»am_
;

87 
LogLev–
 
	gËv–_
;

88 
	glše_
;

89 
SourûFe
 
	gba£Çme_
;

92 
Im¶
 
	gim¶_
;

96 
Logg”
::
LogLev–
 
g_logLev–
;

98 
šlše
 
	gLogg”
::
LogLev–
 
Logg”
::
	$logLev–
()

100  
g_logLev–
;

101 
	}
}

119 
	#LOG_TRACE
 ià(
muduo
::
Logg”
::
	`logLev–
(è<ğmuduo::Logg”::
TRACE
) \

120 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
TRACE
, 
__func__
).
	$¡»am
()

	)

121 
	#LOG_DEBUG
 ià(
muduo
::
Logg”
::
	`logLev–
(è<ğmuduo::Logg”::
DEBUG
) \

122 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
DEBUG
, 
__func__
).
	$¡»am
()

	)

123 
	#LOG_INFO
 ià(
muduo
::
Logg”
::
	`logLev–
(è<ğmuduo::Logg”::
INFO
) \

124 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
).
	$¡»am
()

	)

125 
	#LOG_WARN
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
WARN
).
	$¡»am
()

	)

126 
	#LOG_ERROR
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
ERROR
).
	$¡»am
()

	)

127 
	#LOG_FATAL
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, muduo::
Logg”
::
FATAL
).
	$¡»am
()

	)

128 
	#LOG_SYSERR
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, 
çl£
).
	$¡»am
()

	)

129 
	#LOG_SYSFATAL
 
muduo
::
	`Logg”
(
__FILE__
, 
__LINE__
, 
Œue
).
	$¡»am
()

	)

131 cÚ¡ * 
	`¡»¼Ü_
(
§vedE¼no
);

138 
	#CHECK_NOTNULL
(
v®
) \

139 ::
muduo
::
	`CheckNÙNuÎ
(
__FILE__
, 
__LINE__
, "'" #v® "' Mu¡ bnÚ NULL", (
v®
))

	)

142 
‹m¶©e
 <
ty³Çme
 
T
>

143 
T
* 
	`CheckNÙNuÎ
(
Logg”
::
SourûFe
 
fe
, 
lše
, cÚ¡ *
Çmes
, T* 
±r
)

145 ià(
±r
 =ğ
NULL
)

147 
	`Logg”
(
fe
, 
lše
, 
Logg”
::
FATAL
).
	`¡»am
(è<< 
Çmes
;

149  
±r
;

150 
	}
}

	@muduo/base/Mutex.h

6 #iâdeà
MUDUO_BASE_MUTEX_H


7 
	#MUDUO_BASE_MUTEX_H


	)

9 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

10 
	~<boo¡/nÚcİyabË.hµ
>

11 
	~<as£¹.h
>

12 
	~<±h»ad.h
>

14 #ifdeà
CHECK_PTHREAD_RETURN_VALUE


16 #ifdeà
NDEBUG


17 
__BEGIN_DECLS


18 
	$__as£¹_³¼Ü_ç
 (
”ºum
,

19 cÚ¡ *
fe
,

20 
lše
,

21 cÚ¡ *
funùiÚ
)

22 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

23 
__END_DECLS


26 
	#MCHECK
(
»t
è({ 
	`__ty³of__
 (»tè
”ºum
 = (ret); \

27 ià(
	`__butš_ex³ù
(
”ºum
 != 0, 0)) \

28 
	`__as£¹_³¼Ü_ç
 (
”ºum
, 
__FILE__
, 
__LINE__
, 
__func__
);
	}
})

	)

32 
	#MCHECK
(
»t
è({ 
	`__ty³of__
 (»tè
”ºum
 = (ret); \

33 
	`as£¹
(
”ºum
 =ğ0); (è”ºum;})

	)

37 
Çme¥aû
 
	gmuduo


51 şas 
	cMu‹xLock
 : 
boo¡
::
nÚcİyabË


53 
public
:

54 
Mu‹xLock
()

55 : 
hŞd”_
(0)

57 
MCHECK
(
±h»ad_mu‹x_š™
(&
mu‹x_
, 
NULL
));

60 ~
Mu‹xLock
()

62 
as£¹
(
hŞd”_
 == 0);

63 
MCHECK
(
±h»ad_mu‹x_de¡roy
(&
mu‹x_
));

67 
boŞ
 
isLockedByThisTh»ad
() const

69  
	ghŞd”_
 =ğ
Cu¼’tTh»ad
::
tid
();

72 
as£¹Locked
() const

74 
as£¹
(
isLockedByThisTh»ad
());

79 
lock
()

81 
MCHECK
(
±h»ad_mu‹x_lock
(&
mu‹x_
));

82 
assignHŞd”
();

85 
uÆock
()

87 
uÇssignHŞd”
();

88 
MCHECK
(
±h»ad_mu‹x_uÆock
(&
mu‹x_
));

91 
±h»ad_mu‹x_t
* 
g‘Pth»adMu‹x
()

93  &
	gmu‹x_
;

96 
	g´iv©e
:

97 
ä›nd
 
şass
 
CÚd™iÚ
;

99 şas 
	cUÇssignGu¬d
 : 
boo¡
::
nÚcİyabË


101 
public
:

102 
UÇssignGu¬d
(
Mu‹xLock
& 
owÃr
)

103 : 
owÃr_
(
owÃr
)

105 
owÃr_
.
uÇssignHŞd”
();

108 ~
UÇssignGu¬d
()

110 
	gowÃr_
.
assignHŞd”
();

113 
	g´iv©e
:

114 
Mu‹xLock
& 
owÃr_
;

117 
uÇssignHŞd”
()

119 
	ghŞd”_
 = 0;

122 
assignHŞd”
()

124 
	ghŞd”_
 = 
Cu¼’tTh»ad
::
tid
();

127 
±h»ad_mu‹x_t
 
	gmu‹x_
;

128 
pid_t
 
	ghŞd”_
;

137 şas 
	cMu‹xLockGu¬d
 : 
boo¡
::
nÚcİyabË


139 
public
:

140 
ex¶ic™
 
Mu‹xLockGu¬d
(
Mu‹xLock
& 
mu‹x
)

141 : 
mu‹x_
(
mu‹x
)

143 
mu‹x_
.
lock
();

146 ~
Mu‹xLockGu¬d
()

148 
	gmu‹x_
.
uÆock
();

151 
	g´iv©e
:

153 
Mu‹xLock
& 
mu‹x_
;

161 
	#Mu‹xLockGu¬d
(
x
è
”rÜ
 "Missšg gu¬d objeù‚ame"

	)

	@muduo/base/Mutex.h

6 #iâdeà
MUDUO_BASE_MUTEX_H


7 
	#MUDUO_BASE_MUTEX_H


	)

9 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

10 
	~<boo¡/nÚcİyabË.hµ
>

11 
	~<as£¹.h
>

12 
	~<±h»ad.h
>

14 #ifdeà
CHECK_PTHREAD_RETURN_VALUE


16 #ifdeà
NDEBUG


17 
__BEGIN_DECLS


18 
	$__as£¹_³¼Ü_ç
 (
”ºum
,

19 cÚ¡ *
fe
,

20 
lše
,

21 cÚ¡ *
funùiÚ
)

22 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

23 
__END_DECLS


26 
	#MCHECK
(
»t
è({ 
	`__ty³of__
 (»tè
”ºum
 = (ret); \

27 ià(
	`__butš_ex³ù
(
”ºum
 != 0, 0)) \

28 
	`__as£¹_³¼Ü_ç
 (
”ºum
, 
__FILE__
, 
__LINE__
, 
__func__
);
	}
})

	)

32 
	#MCHECK
(
»t
è({ 
	`__ty³of__
 (»tè
”ºum
 = (ret); \

33 
	`as£¹
(
”ºum
 =ğ0); (è”ºum;})

	)

37 
Çme¥aû
 
	gmuduo


51 şas 
	cMu‹xLock
 : 
boo¡
::
nÚcİyabË


53 
public
:

54 
Mu‹xLock
()

55 : 
hŞd”_
(0)

57 
MCHECK
(
±h»ad_mu‹x_š™
(&
mu‹x_
, 
NULL
));

60 ~
Mu‹xLock
()

62 
as£¹
(
hŞd”_
 == 0);

63 
MCHECK
(
±h»ad_mu‹x_de¡roy
(&
mu‹x_
));

67 
boŞ
 
isLockedByThisTh»ad
() const

69  
	ghŞd”_
 =ğ
Cu¼’tTh»ad
::
tid
();

72 
as£¹Locked
() const

74 
as£¹
(
isLockedByThisTh»ad
());

79 
lock
()

81 
MCHECK
(
±h»ad_mu‹x_lock
(&
mu‹x_
));

82 
assignHŞd”
();

85 
uÆock
()

87 
uÇssignHŞd”
();

88 
MCHECK
(
±h»ad_mu‹x_uÆock
(&
mu‹x_
));

91 
±h»ad_mu‹x_t
* 
g‘Pth»adMu‹x
()

93  &
	gmu‹x_
;

96 
	g´iv©e
:

97 
ä›nd
 
şass
 
CÚd™iÚ
;

99 şas 
	cUÇssignGu¬d
 : 
boo¡
::
nÚcİyabË


101 
public
:

102 
UÇssignGu¬d
(
Mu‹xLock
& 
owÃr
)

103 : 
owÃr_
(
owÃr
)

105 
owÃr_
.
uÇssignHŞd”
();

108 ~
UÇssignGu¬d
()

110 
	gowÃr_
.
assignHŞd”
();

113 
	g´iv©e
:

114 
Mu‹xLock
& 
owÃr_
;

117 
uÇssignHŞd”
()

119 
	ghŞd”_
 = 0;

122 
assignHŞd”
()

124 
	ghŞd”_
 = 
Cu¼’tTh»ad
::
tid
();

127 
±h»ad_mu‹x_t
 
	gmu‹x_
;

128 
pid_t
 
	ghŞd”_
;

137 şas 
	cMu‹xLockGu¬d
 : 
boo¡
::
nÚcİyabË


139 
public
:

140 
ex¶ic™
 
Mu‹xLockGu¬d
(
Mu‹xLock
& 
mu‹x
)

141 : 
mu‹x_
(
mu‹x
)

143 
mu‹x_
.
lock
();

146 ~
Mu‹xLockGu¬d
()

148 
	gmu‹x_
.
uÆock
();

151 
	g´iv©e
:

153 
Mu‹xLock
& 
mu‹x_
;

161 
	#Mu‹xLockGu¬d
(
x
è
”rÜ
 "Missšg gu¬d objeù‚ame"

	)

	@muduo/base/ProcessInfo.cc

10 
	~<muduo/ba£/ProûssInfo.h
>

11 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

12 
	~<muduo/ba£/FeUt.h
>

14 
	~<®gÜ™hm
>

16 
	~<as£¹.h
>

17 
	~<dœ’t.h
>

18 
	~<pwd.h
>

19 
	~<¡dio.h
>

20 
	~<¡dlib.h
>

21 
	~<uni¡d.h
>

22 
	~<sys/»sourû.h
>

23 
	~<sys/times.h
>

25 
Çme¥aû
 
	gmuduo


27 
Çme¥aû
 
	gd‘a


29 
__th»ad
 
	gt_numO³ÃdFes
 = 0;

30 
fdDœF‹r
(cÚ¡ 
dœ’t
* 
d
)

32 ià(::
isdig™
(
d
->
d_Çme
[0]))

34 ++
t_numO³ÃdFes
;

39 
__th»ad
 
	g¡d
::
veùÜ
<
pid_t
>* 
t_pids
 = 
NULL
;

40 
skDœF‹r
(cÚ¡ 
dœ’t
* 
d
)

42 ià(::
isdig™
(
d
->
d_Çme
[0]))

44 
t_pids
->
push_back
(
©oi
(
d
->
d_Çme
));

49 
sÿnDœ
(cÚ¡ *
dœ·th
, (*
f‹r
)(cÚ¡ 
dœ’t
 *))

51 
dœ’t
** 
	gÇm–i¡
 = 
NULL
;

52 
	g»suÉ
 = ::
sÿndœ
(
dœ·th
, &
Çm–i¡
, 
f‹r
, 
®phasÜt
);

53 
as£¹
(
Çm–i¡
 =ğ
NULL
);

54  
	g»suÉ
;

57 
Time¡amp
 
	gg_¡¬tTime
 = Time¡amp::
now
();

59 
	gg_şockTicks
 = 
¡©ic_ÿ¡
<>(::
syscÚf
(
_SC_CLK_TCK
));

60 
	gg_·geSize
 = 
¡©ic_ÿ¡
<>(::
syscÚf
(
_SC_PAGE_SIZE
));

64 
usšg
 
Çme¥aû
 
	gmuduo
;

65 
usšg
 
Çme¥aû
 
	gmuduo
::
d‘a
;

67 
pid_t
 
	gProûssInfo
::
	$pid
()

69  ::
	`g‘pid
();

70 
	}
}

72 
¡ršg
 
	gProûssInfo
::
	$pidSŒšg
()

74 
buf
[32];

75 
	`¢´štf
(
buf
,  buf, "%d", 
	`pid
());

76  
buf
;

77 
	}
}

79 
uid_t
 
	gProûssInfo
::
	$uid
()

81  ::
	`g‘uid
();

82 
	}
}

84 
¡ršg
 
	gProûssInfo
::
	$u£ºame
()

86 
·sswd
 
pwd
;

87 
·sswd
* 
»suÉ
 = 
NULL
;

88 
buf
[8192];

89 cÚ¡ * 
Çme
 = "unknownuser";

91 
	`g‘pwuid_r
(
	`uid
(), &
pwd
, 
buf
,  buf, &
»suÉ
);

92 ià(
»suÉ
)

94 
Çme
 = 
pwd
.
pw_Çme
;

96  
Çme
;

97 
	}
}

99 
uid_t
 
	gProûssInfo
::
	$euid
()

101  ::
	`g‘euid
();

102 
	}
}

104 
Time¡amp
 
	gProûssInfo
::
	$¡¬tTime
()

106  
g_¡¬tTime
;

107 
	}
}

109 
	gProûssInfo
::
	$şockTicksP”SecÚd
()

111  
g_şockTicks
;

112 
	}
}

114 
	gProûssInfo
::
	$·geSize
()

116  
g_·geSize
;

117 
	}
}

119 
boŞ
 
	gProûssInfo
::
	$isDebugBud
()

121 #ifdeà
NDEBUG


122  
çl£
;

124  
Œue
;

126 
	}
}

128 
¡ršg
 
	gProûssInfo
::
	$ho¡Çme
()

132 
buf
[256];

133 ià(::
	`g‘ho¡Çme
(
buf
,  buf) == 0)

135 
buf
[(buf)-1] = '\0';

136  
buf
;

142 
	}
}

144 
¡ršg
 
	gProûssInfo
::
	$´oúame
()

146  
	`´oúame
(
	`´ocSt
()).
	`as_¡ršg
();

147 
	}
}

149 
SŒšgP›û
 
	gProûssInfo
::
	$´oúame
(cÚ¡ 
¡ršg
& 
¡©
)

151 
SŒšgP›û
 
Çme
;

152 
size_t
 
Í
 = 
¡©
.
	`fšd
('(');

153 
size_t
 
½
 = 
¡©
.
	`rfšd
(')');

154 ià(
Í
 !ğ
¡ršg
::
Åos
 && 
½
 != string::npos &&†p <„p)

156 
Çme
.
	`£t
(
¡©
.
	`d©a
()+
Í
+1, 
¡©ic_ÿ¡
<>(
½
-lp-1));

158  
Çme
;

159 
	}
}

161 
¡ršg
 
	gProûssInfo
::
	$´ocStus
()

163 
¡ršg
 
»suÉ
;

164 
FeUt
::
	`»adFe
("/´oc/£lf/¡©us", 65536, &
»suÉ
);

165  
»suÉ
;

166 
	}
}

168 
¡ršg
 
	gProûssInfo
::
	$´ocSt
()

170 
¡ršg
 
»suÉ
;

171 
FeUt
::
	`»adFe
("/´oc/£lf/¡©", 65536, &
»suÉ
);

172  
»suÉ
;

173 
	}
}

175 
¡ršg
 
	gProûssInfo
::
	$th»adSt
()

177 
buf
[64];

178 
	`¢´štf
(
buf
,  buf, "/´oc/£lf/sk/%d/¡©", 
Cu¼’tTh»ad
::
	`tid
());

179 
¡ršg
 
»suÉ
;

180 
FeUt
::
	`»adFe
(
buf
, 65536, &
»suÉ
);

181  
»suÉ
;

182 
	}
}

184 
¡ršg
 
	gProûssInfo
::
	$exeP©h
()

186 
¡ršg
 
»suÉ
;

187 
buf
[1024];

188 
ssize_t
 
n
 = ::
	`»adlšk
("/´oc/£lf/exe", 
buf
,  buf);

189 ià(
n
 > 0)

191 
»suÉ
.
	`assign
(
buf
, 
n
);

193  
»suÉ
;

194 
	}
}

196 
	gProûssInfo
::
	$İ’edFes
()

198 
t_numO³ÃdFes
 = 0;

199 
	`sÿnDœ
("/´oc/£lf/fd", 
fdDœF‹r
);

200  
t_numO³ÃdFes
;

201 
	}
}

203 
	gProûssInfo
::
	$maxO³nFes
()

205 
¾im™
 
¾
;

206 ià(::
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾
))

208  
	`İ’edFes
();

212  
¡©ic_ÿ¡
<>(
¾
.
¾im_cur
);

214 
	}
}

216 
	gProûssInfo
::
CpuTime
 
ProûssInfo
::
	$ıuTime
()

218 
ProûssInfo
::
CpuTime
 
t
;

219 
tms
ms;

220 ià(::
	`times
(&
tms
) >= 0)

222 cÚ¡ 
hz
 = 
¡©ic_ÿ¡
<>(
	`şockTicksP”SecÚd
());

223 
t
.
u£rSecÚds
 = 
¡©ic_ÿ¡
<>(
tms
.
tms_utime
è/ 
hz
;

224 
t
.
sy¡emSecÚds
 = 
¡©ic_ÿ¡
<>(
tms
.
tms_¡ime
è/ 
hz
;

226  
t
;

227 
	}
}

229 
	gProûssInfo
::
	$numTh»ads
()

231 
»suÉ
 = 0;

232 
¡ršg
 
¡©us
 = 
	`´ocStus
();

233 
size_t
 
pos
 = 
¡©us
.
	`fšd
("Threads:");

234 ià(
pos
 !ğ
¡ršg
::
Åos
)

236 
»suÉ
 = ::
	`©oi
(
¡©us
.
	`c_¡r
(è+ 
pos
 + 8);

238  
»suÉ
;

239 
	}
}

241 
	g¡d
::
veùÜ
<
pid_t
> 
ProûssInfo
::
	$th»ads
()

243 
¡d
::
veùÜ
<
pid_t
> 
»suÉ
;

244 
t_pids
 = &
»suÉ
;

245 
	`sÿnDœ
("/´oc/£lf/sk", 
skDœF‹r
);

246 
t_pids
 = 
NULL
;

247 
¡d
::
	`sÜt
(
»suÉ
.
	`begš
(),„esuÉ.
	`’d
());

248  
»suÉ
;

249 
	}
}

	@muduo/base/ProcessInfo.h

11 #iâdeà
MUDUO_BASE_PROCESSINFO_H


12 
	#MUDUO_BASE_PROCESSINFO_H


	)

14 
	~<muduo/ba£/SŒšgP›û.h
>

15 
	~<muduo/ba£/Ty³s.h
>

16 
	~<muduo/ba£/Time¡amp.h
>

17 
	~<veùÜ
>

18 
	~<sys/ty³s.h
>

20 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gProûssInfo


25 
pid_t
 
pid
();

26 
¡ršg
 
pidSŒšg
();

27 
uid_t
 
uid
();

28 
¡ršg
 
u£ºame
();

29 
uid_t
 
euid
();

30 
Time¡amp
 
¡¬tTime
();

31 
şockTicksP”SecÚd
();

32 
·geSize
();

33 
boŞ
 
isDebugBud
();

35 
¡ršg
 
ho¡Çme
();

36 
¡ršg
 
´oúame
();

37 
SŒšgP›û
 
´oúame
(cÚ¡ 
¡ršg
& 
¡©
);

40 
¡ršg
 
´ocStus
();

43 
¡ršg
 
´ocSt
();

46 
¡ršg
 
th»adSt
();

49 
¡ršg
 
exeP©h
();

51 
İ’edFes
();

52 
maxO³nFes
();

54 
	sCpuTime


56 
	gu£rSecÚds
;

57 
	gsy¡emSecÚds
;

59 
CpuTime
(è: 
u£rSecÚds
(0.0), 
sy¡emSecÚds
(0.0) { }

61 
CpuTime
 
ıuTime
();

63 
numTh»ads
();

64 
	g¡d
::
veùÜ
<
pid_t
> 
th»ads
();

	@muduo/base/ProcessInfo.h

11 #iâdeà
MUDUO_BASE_PROCESSINFO_H


12 
	#MUDUO_BASE_PROCESSINFO_H


	)

14 
	~<muduo/ba£/SŒšgP›û.h
>

15 
	~<muduo/ba£/Ty³s.h
>

16 
	~<muduo/ba£/Time¡amp.h
>

17 
	~<veùÜ
>

18 
	~<sys/ty³s.h
>

20 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gProûssInfo


25 
pid_t
 
pid
();

26 
¡ršg
 
pidSŒšg
();

27 
uid_t
 
uid
();

28 
¡ršg
 
u£ºame
();

29 
uid_t
 
euid
();

30 
Time¡amp
 
¡¬tTime
();

31 
şockTicksP”SecÚd
();

32 
·geSize
();

33 
boŞ
 
isDebugBud
();

35 
¡ršg
 
ho¡Çme
();

36 
¡ršg
 
´oúame
();

37 
SŒšgP›û
 
´oúame
(cÚ¡ 
¡ršg
& 
¡©
);

40 
¡ršg
 
´ocStus
();

43 
¡ršg
 
´ocSt
();

46 
¡ršg
 
th»adSt
();

49 
¡ršg
 
exeP©h
();

51 
İ’edFes
();

52 
maxO³nFes
();

54 
	sCpuTime


56 
	gu£rSecÚds
;

57 
	gsy¡emSecÚds
;

59 
CpuTime
(è: 
u£rSecÚds
(0.0), 
sy¡emSecÚds
(0.0) { }

61 
CpuTime
 
ıuTime
();

63 
numTh»ads
();

64 
	g¡d
::
veùÜ
<
pid_t
> 
th»ads
();

	@muduo/base/Singleton.h

6 #iâdeà
MUDUO_BASE_SINGLETON_H


7 
	#MUDUO_BASE_SINGLETON_H


	)

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<as£¹.h
>

11 
	~<¡dlib.h
>

12 
	~<±h»ad.h
>

14 
Çme¥aû
 
	gmuduo


17 
Çme¥aû
 
	gd‘a


21 
	g‹m¶©e
<
ty³Çme
 
	gT
>

22 
	shas_no_de¡roy


24 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


25 
	g‹m¶©e
 <
ty³Çme
 
	gC
> 
‹¡
(
deşty³
(&
C
::
no_de¡roy
));

27 
	g‹m¶©e
 <
ty³Çme
 
	gC
> 
‹¡
(
ty³of
(&
C
::
no_de¡roy
));

29 
	g‹m¶©e
 <
ty³Çme
 
	gC
> 
št32_t
 
‹¡
(...);

30 cÚ¡ 
boŞ
 
	gv®ue
 = (
‹¡
<
T
>(0)) == 1;

34 
	g‹m¶©e
<
ty³Çme
 
	gT
>

35 şas 
	cSšgËtÚ
 : 
boo¡
::
nÚcİyabË


37 
public
:

38 
T
& 
š¡ªû
()

40 
±h»ad_Úû
(&
pÚû_
, &
SšgËtÚ
::
š™
);

41 
as£¹
(
v®ue_
 !ğ
NULL
);

42  *
	gv®ue_
;

45 
	g´iv©e
:

46 
SšgËtÚ
();

47 ~
SšgËtÚ
();

49 
š™
()

51 
	gv®ue_
 = 
Ãw
 
T
();

52 ià(!
	gd‘a
::
has_no_de¡roy
<
T
>::
v®ue
)

54 ::
©ex™
(
de¡roy
);

58 
de¡roy
()

60 
	tT_mu¡_be_com¶‘e_ty³
[(
T
) == 0 ? -1 : 1];

61 
T_mu¡_be_com¶‘e_ty³
 
	gdummy
; () dummy;

63 
d–‘e
 
	gv®ue_
;

64 
	gv®ue_
 = 
NULL
;

67 
	g´iv©e
:

68 
±h»ad_Úû_t
 
pÚû_
;

69 
T
* 
	gv®ue_
;

72 
	g‹m¶©e
<
ty³Çme
 
	gT
>

73 
±h»ad_Úû_t
 
	gSšgËtÚ
<
	gT
>::
pÚû_
 = 
PTHREAD_ONCE_INIT
;

75 
	g‹m¶©e
<
ty³Çme
 
	gT
>

76 
T
* 
	gSšgËtÚ
<
	gT
>::
v®ue_
 = 
NULL
;

	@muduo/base/Singleton.h

6 #iâdeà
MUDUO_BASE_SINGLETON_H


7 
	#MUDUO_BASE_SINGLETON_H


	)

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<as£¹.h
>

11 
	~<¡dlib.h
>

12 
	~<±h»ad.h
>

14 
Çme¥aû
 
	gmuduo


17 
Çme¥aû
 
	gd‘a


21 
	g‹m¶©e
<
ty³Çme
 
	gT
>

22 
	shas_no_de¡roy


24 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


25 
	g‹m¶©e
 <
ty³Çme
 
	gC
> 
‹¡
(
deşty³
(&
C
::
no_de¡roy
));

27 
	g‹m¶©e
 <
ty³Çme
 
	gC
> 
‹¡
(
ty³of
(&
C
::
no_de¡roy
));

29 
	g‹m¶©e
 <
ty³Çme
 
	gC
> 
št32_t
 
‹¡
(...);

30 cÚ¡ 
boŞ
 
	gv®ue
 = (
‹¡
<
T
>(0)) == 1;

34 
	g‹m¶©e
<
ty³Çme
 
	gT
>

35 şas 
	cSšgËtÚ
 : 
boo¡
::
nÚcİyabË


37 
public
:

38 
T
& 
š¡ªû
()

40 
±h»ad_Úû
(&
pÚû_
, &
SšgËtÚ
::
š™
);

41 
as£¹
(
v®ue_
 !ğ
NULL
);

42  *
	gv®ue_
;

45 
	g´iv©e
:

46 
SšgËtÚ
();

47 ~
SšgËtÚ
();

49 
š™
()

51 
	gv®ue_
 = 
Ãw
 
T
();

52 ià(!
	gd‘a
::
has_no_de¡roy
<
T
>::
v®ue
)

54 ::
©ex™
(
de¡roy
);

58 
de¡roy
()

60 
	tT_mu¡_be_com¶‘e_ty³
[(
T
) == 0 ? -1 : 1];

61 
T_mu¡_be_com¶‘e_ty³
 
	gdummy
; () dummy;

63 
d–‘e
 
	gv®ue_
;

64 
	gv®ue_
 = 
NULL
;

67 
	g´iv©e
:

68 
±h»ad_Úû_t
 
pÚû_
;

69 
T
* 
	gv®ue_
;

72 
	g‹m¶©e
<
ty³Çme
 
	gT
>

73 
±h»ad_Úû_t
 
	gSšgËtÚ
<
	gT
>::
pÚû_
 = 
PTHREAD_ONCE_INIT
;

75 
	g‹m¶©e
<
ty³Çme
 
	gT
>

76 
T
* 
	gSšgËtÚ
<
	gT
>::
v®ue_
 = 
NULL
;

	@muduo/base/StringPiece.h

40 #iâdeà
MUDUO_BASE_STRINGPIECE_H


41 
	#MUDUO_BASE_STRINGPIECE_H


	)

43 
	~<¡ršg.h
>

44 
	~<iosfwd
>

46 
	~<muduo/ba£/Ty³s.h
>

47 #iâdeà
MUDUO_STD_STRING


48 
	~<¡ršg
>

51 
Çme¥aû
 
	gmuduo
 {

54 şas 
	cSŒšgArg


56 
	gpublic
:

57 
SŒšgArg
(cÚ¡ * 
¡r
)

58 : 
¡r_
(
¡r
)

61 
SŒšgArg
(cÚ¡ 
¡ršg
& 
¡r
)

62 : 
¡r_
(
¡r
.
c_¡r
())

65 #iâdeà
MUDUO_STD_STRING


66 
SŒšgArg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
)

67 : 
¡r_
(
¡r
.
c_¡r
())

71 cÚ¡ * 
c_¡r
(ècÚ¡ {  
¡r_
; }

73 
	g´iv©e
:

74 cÚ¡ * 
¡r_
;

77 şas 
	cSŒšgP›û
 {

78 
	g´iv©e
:

79 cÚ¡ * 
±r_
;

80 
	gËngth_
;

82 
	gpublic
:

86 
SŒšgP›û
()

87 : 
±r_
(
NULL
), 
Ëngth_
(0) { }

88 
SŒšgP›û
(cÚ¡ * 
¡r
)

89 : 
±r_
(
¡r
), 
Ëngth_
(
¡©ic_ÿ¡
<>(
¡¾’
(ptr_))) { }

90 
SŒšgP›û
(cÚ¡ * 
¡r
)

91 : 
±r_
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
¡r
)),

92 
Ëngth_
(
¡©ic_ÿ¡
<>(
¡¾’
(
±r_
))) { }

93 
SŒšgP›û
(cÚ¡ 
¡ršg
& 
¡r
)

94 : 
±r_
(
¡r
.
d©a
()), 
Ëngth_
(
¡©ic_ÿ¡
<>(¡r.
size
())) { }

95 #iâdeà
MUDUO_STD_STRING


96 
SŒšgP›û
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
)

97 : 
±r_
(
¡r
.
d©a
()), 
Ëngth_
(
¡©ic_ÿ¡
<>(¡r.
size
())) { }

99 
SŒšgP›û
(cÚ¡ * 
off£t
, 
Ën
)

100 : 
±r_
(
off£t
), 
Ëngth_
(
Ën
) { }

108 cÚ¡ * 
d©a
(ècÚ¡ {  
	g±r_
; }

109 
size
(ècÚ¡ {  
	gËngth_
; }

110 
boŞ
 
em±y
(ècÚ¡ {  
	gËngth_
 == 0; }

111 cÚ¡ * 
begš
(ècÚ¡ {  
	g±r_
; }

112 cÚ¡ * 
’d
(ècÚ¡ {  
	g±r_
 + 
	gËngth_
; }

114 
ş—r
(è{ 
	g±r_
 = 
NULL
; 
	gËngth_
 = 0; }

115 
£t
(cÚ¡ * 
bufãr
, 
Ën
è{ 
	g±r_
 = bufãr; 
	gËngth_
 =†en; }

116 
£t
(cÚ¡ * 
¡r
) {

117 
	g±r_
 = 
¡r
;

118 
	gËngth_
 = 
¡©ic_ÿ¡
<>(
¡¾’
(
¡r
));

120 
£t
(cÚ¡ * 
bufãr
, 
Ën
) {

121 
	g±r_
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
bufãr
);

122 
	gËngth_
 = 
Ën
;

125 
	gİ”©Ü
[](
	gi
ècÚ¡ {  
	g±r_
[
i
]; }

127 
»move_´efix
(
n
) {

128 
	g±r_
 +ğ
n
;

129 
	gËngth_
 -ğ
n
;

132 
»move_suffix
(
n
) {

133 
	gËngth_
 -ğ
n
;

136 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
SŒšgP›û
& 
x
) const {

137  ((
Ëngth_
 =ğ
x
.length_) &&

138 (
memcmp
(
±r_
, 
x
.±r_, 
Ëngth_
) == 0));

140 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
SŒšgP›û
& 
x
) const {

141  !(*
this
 =ğ
x
);

144 
	#STRINGPIECE_BINARY_PREDICATE
(
cmp
,
auxcmp
) \

145 
boŞ
 
İ”©Ü
 
	`cmp
 (cÚ¡ 
SŒšgP›û
& 
x
) const { \

146 
r
 = 
	`memcmp
(
±r_
, 
x
.±r_, 
Ëngth_
 < x.length_ ?†ength_ : x.length_); \

147  ((
r
 
auxcmp
 0è|| (Ô =ğ0è&& (
Ëngth_
 
cmp
 
x
.length_))); \

148 }

	)

149 
STRINGPIECE_BINARY_PREDICATE
(<, <);

150 
STRINGPIECE_BINARY_PREDICATE
(<=, <);

151 
STRINGPIECE_BINARY_PREDICATE
(>=, >);

152 
STRINGPIECE_BINARY_PREDICATE
(>, >);

153 #undeà
STRINGPIECE_BINARY_PREDICATE


155 
com·»
(cÚ¡ 
SŒšgP›û
& 
x
) const {

156 
	gr
 = 
memcmp
(
±r_
, 
x
.±r_, 
Ëngth_
 < x.length_ ?†ength_ : x.length_);

157 ià(
	gr
 == 0) {

158 ià(
Ëngth_
 < 
x
.Ëngth_è
r
 = -1;

159 ià(
	gËngth_
 > 
	gx
.Ëngth_è
	gr
 = +1;

161  
	gr
;

164 
¡ršg
 
as_¡ršg
() const {

165  
¡ršg
(
d©a
(), 
size
());

168 
CİyToSŒšg
(
¡ršg
* 
rg‘
) const {

169 
	grg‘
->
assign
(
±r_
, 
Ëngth_
);

172 #iâdeà
MUDUO_STD_STRING


173 
CİyToStdSŒšg
(
¡d
::
¡ršg
* 
rg‘
) const {

174 
rg‘
->
assign
(
±r_
, 
Ëngth_
);

179 
boŞ
 
¡¬ts_w™h
(cÚ¡ 
SŒšgP›û
& 
x
) const {

180  ((
	gËngth_
 >ğ
x
.
Ëngth_
è&& (
memcmp
(
±r_
, x.ptr_, x.length_) == 0));

193 #ifdeà
HAVE_TYPE_TRAITS


195 
	g‹m¶©e
<> 
	g__ty³_Œa™s
<
	gmuduo
::
SŒšgP›û
> {

196 
__Œue_ty³
 
	thas_ŒivŸl_deçuÉ_cÚ¡ruùÜ
;

197 
__Œue_ty³
 
	thas_ŒivŸl_cİy_cÚ¡ruùÜ
;

198 
__Œue_ty³
 
	thas_ŒivŸl_assignm’t_İ”©Ü
;

199 
__Œue_ty³
 
	thas_ŒivŸl_de¡ruùÜ
;

200 
__Œue_ty³
 
	tis_POD_ty³
;

205 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
o
, cÚ¡ 
	gmuduo
::
SŒšgP›û
& 
p›û
);

	@muduo/base/StringPiece.h

40 #iâdeà
MUDUO_BASE_STRINGPIECE_H


41 
	#MUDUO_BASE_STRINGPIECE_H


	)

43 
	~<¡ršg.h
>

44 
	~<iosfwd
>

46 
	~<muduo/ba£/Ty³s.h
>

47 #iâdeà
MUDUO_STD_STRING


48 
	~<¡ršg
>

51 
Çme¥aû
 
	gmuduo
 {

54 şas 
	cSŒšgArg


56 
	gpublic
:

57 
SŒšgArg
(cÚ¡ * 
¡r
)

58 : 
¡r_
(
¡r
)

61 
SŒšgArg
(cÚ¡ 
¡ršg
& 
¡r
)

62 : 
¡r_
(
¡r
.
c_¡r
())

65 #iâdeà
MUDUO_STD_STRING


66 
SŒšgArg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
)

67 : 
¡r_
(
¡r
.
c_¡r
())

71 cÚ¡ * 
c_¡r
(ècÚ¡ {  
¡r_
; }

73 
	g´iv©e
:

74 cÚ¡ * 
¡r_
;

77 şas 
	cSŒšgP›û
 {

78 
	g´iv©e
:

79 cÚ¡ * 
±r_
;

80 
	gËngth_
;

82 
	gpublic
:

86 
SŒšgP›û
()

87 : 
±r_
(
NULL
), 
Ëngth_
(0) { }

88 
SŒšgP›û
(cÚ¡ * 
¡r
)

89 : 
±r_
(
¡r
), 
Ëngth_
(
¡©ic_ÿ¡
<>(
¡¾’
(ptr_))) { }

90 
SŒšgP›û
(cÚ¡ * 
¡r
)

91 : 
±r_
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
¡r
)),

92 
Ëngth_
(
¡©ic_ÿ¡
<>(
¡¾’
(
±r_
))) { }

93 
SŒšgP›û
(cÚ¡ 
¡ršg
& 
¡r
)

94 : 
±r_
(
¡r
.
d©a
()), 
Ëngth_
(
¡©ic_ÿ¡
<>(¡r.
size
())) { }

95 #iâdeà
MUDUO_STD_STRING


96 
SŒšgP›û
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
)

97 : 
±r_
(
¡r
.
d©a
()), 
Ëngth_
(
¡©ic_ÿ¡
<>(¡r.
size
())) { }

99 
SŒšgP›û
(cÚ¡ * 
off£t
, 
Ën
)

100 : 
±r_
(
off£t
), 
Ëngth_
(
Ën
) { }

108 cÚ¡ * 
d©a
(ècÚ¡ {  
	g±r_
; }

109 
size
(ècÚ¡ {  
	gËngth_
; }

110 
boŞ
 
em±y
(ècÚ¡ {  
	gËngth_
 == 0; }

111 cÚ¡ * 
begš
(ècÚ¡ {  
	g±r_
; }

112 cÚ¡ * 
’d
(ècÚ¡ {  
	g±r_
 + 
	gËngth_
; }

114 
ş—r
(è{ 
	g±r_
 = 
NULL
; 
	gËngth_
 = 0; }

115 
£t
(cÚ¡ * 
bufãr
, 
Ën
è{ 
	g±r_
 = bufãr; 
	gËngth_
 =†en; }

116 
£t
(cÚ¡ * 
¡r
) {

117 
	g±r_
 = 
¡r
;

118 
	gËngth_
 = 
¡©ic_ÿ¡
<>(
¡¾’
(
¡r
));

120 
£t
(cÚ¡ * 
bufãr
, 
Ën
) {

121 
	g±r_
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
bufãr
);

122 
	gËngth_
 = 
Ën
;

125 
	gİ”©Ü
[](
	gi
ècÚ¡ {  
	g±r_
[
i
]; }

127 
»move_´efix
(
n
) {

128 
	g±r_
 +ğ
n
;

129 
	gËngth_
 -ğ
n
;

132 
»move_suffix
(
n
) {

133 
	gËngth_
 -ğ
n
;

136 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
SŒšgP›û
& 
x
) const {

137  ((
Ëngth_
 =ğ
x
.length_) &&

138 (
memcmp
(
±r_
, 
x
.±r_, 
Ëngth_
) == 0));

140 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
SŒšgP›û
& 
x
) const {

141  !(*
this
 =ğ
x
);

144 
	#STRINGPIECE_BINARY_PREDICATE
(
cmp
,
auxcmp
) \

145 
boŞ
 
İ”©Ü
 
	`cmp
 (cÚ¡ 
SŒšgP›û
& 
x
) const { \

146 
r
 = 
	`memcmp
(
±r_
, 
x
.±r_, 
Ëngth_
 < x.length_ ?†ength_ : x.length_); \

147  ((
r
 
auxcmp
 0è|| (Ô =ğ0è&& (
Ëngth_
 
cmp
 
x
.length_))); \

148 }

	)

149 
STRINGPIECE_BINARY_PREDICATE
(<, <);

150 
STRINGPIECE_BINARY_PREDICATE
(<=, <);

151 
STRINGPIECE_BINARY_PREDICATE
(>=, >);

152 
STRINGPIECE_BINARY_PREDICATE
(>, >);

153 #undeà
STRINGPIECE_BINARY_PREDICATE


155 
com·»
(cÚ¡ 
SŒšgP›û
& 
x
) const {

156 
	gr
 = 
memcmp
(
±r_
, 
x
.±r_, 
Ëngth_
 < x.length_ ?†ength_ : x.length_);

157 ià(
	gr
 == 0) {

158 ià(
Ëngth_
 < 
x
.Ëngth_è
r
 = -1;

159 ià(
	gËngth_
 > 
	gx
.Ëngth_è
	gr
 = +1;

161  
	gr
;

164 
¡ršg
 
as_¡ršg
() const {

165  
¡ršg
(
d©a
(), 
size
());

168 
CİyToSŒšg
(
¡ršg
* 
rg‘
) const {

169 
	grg‘
->
assign
(
±r_
, 
Ëngth_
);

172 #iâdeà
MUDUO_STD_STRING


173 
CİyToStdSŒšg
(
¡d
::
¡ršg
* 
rg‘
) const {

174 
rg‘
->
assign
(
±r_
, 
Ëngth_
);

179 
boŞ
 
¡¬ts_w™h
(cÚ¡ 
SŒšgP›û
& 
x
) const {

180  ((
	gËngth_
 >ğ
x
.
Ëngth_
è&& (
memcmp
(
±r_
, x.ptr_, x.length_) == 0));

193 #ifdeà
HAVE_TYPE_TRAITS


195 
	g‹m¶©e
<> 
	g__ty³_Œa™s
<
	gmuduo
::
SŒšgP›û
> {

196 
__Œue_ty³
 
	thas_ŒivŸl_deçuÉ_cÚ¡ruùÜ
;

197 
__Œue_ty³
 
	thas_ŒivŸl_cİy_cÚ¡ruùÜ
;

198 
__Œue_ty³
 
	thas_ŒivŸl_assignm’t_İ”©Ü
;

199 
__Œue_ty³
 
	thas_ŒivŸl_de¡ruùÜ
;

200 
__Œue_ty³
 
	tis_POD_ty³
;

205 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
o
, cÚ¡ 
	gmuduo
::
SŒšgP›û
& 
p›û
);

	@muduo/base/Thread.cc

6 
	~<muduo/ba£/Th»ad.h
>

7 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

8 
	~<muduo/ba£/Exû±iÚ.h
>

9 
	~<muduo/ba£/Loggšg.h
>

11 
	~<boo¡/¡©ic_as£¹.hµ
>

12 
	~<boo¡/ty³_Œa™s/is_§me.hµ
>

13 
	~<boo¡/w—k_±r.hµ
>

15 
	~<”ºo.h
>

16 
	~<¡dio.h
>

17 
	~<uni¡d.h
>

18 
	~<sys/´ùl.h
>

19 
	~<sys/sysÿÎ.h
>

20 
	~<sys/ty³s.h
>

21 
	~<lšux/uni¡d.h
>

23 
Çme¥aû
 
	gmuduo


25 
Çme¥aû
 
	gCu¼’tTh»ad


27 
__th»ad
 
	gt_ÿchedTid
 = 0;

28 
__th»ad
 
	gt_tidSŒšg
[32];

29 
__th»ad
 
	gt_tidSŒšgL’gth
 = 6;

30 
__th»ad
 cÚ¡ * 
	gt_th»adName
 = "unknown";

31 cÚ¡ 
boŞ
 
	g§meTy³
 = 
boo¡
::
is_§me
<, 
	gpid_t
>::
v®ue
;

32 
BOOST_STATIC_ASSERT
(
§meTy³
);

35 
Çme¥aû
 
	gd‘a


38 
pid_t
 
g‘tid
()

40  
	g¡©ic_ÿ¡
<
	gpid_t
>(::
sysÿÎ
(
SYS_g‘tid
));

43 
aá”FÜk
()

45 
	gmuduo
::
Cu¼’tTh»ad
::
t_ÿchedTid
 = 0;

46 
	gmuduo
::
Cu¼’tTh»ad
::
t_th»adName
 = "main";

47 
	gCu¼’tTh»ad
::
tid
();

51 şas 
	cTh»adNameIn™Ÿliz”


53 
	gpublic
:

54 
Th»adNameIn™Ÿliz”
()

56 
muduo
::
Cu¼’tTh»ad
::
t_th»adName
 = "main";

57 
	gCu¼’tTh»ad
::
tid
();

58 
±h»ad_©fÜk
(
NULL
, NULL, &
aá”FÜk
);

62 
Th»adNameIn™Ÿliz”
 
	gš™
;

64 
	sTh»adD©a


66 
	gmuduo
::
	tTh»ad
::
	tTh»adFunc
 ThreadFunc;

67 
Th»adFunc
 
	gfunc_
;

68 
¡ršg
 
	gÇme_
;

69 
pid_t
* 
	gtid_
;

70 
CouÁDownL©ch
* 
	gÏtch_
;

72 
Th»adD©a
(cÚ¡ 
Th»adFunc
& 
func
,

73 cÚ¡ 
¡ršg
& 
Çme
,

74 
pid_t
* 
tid
,

75 
CouÁDownL©ch
* 
Ïtch
)

76 : 
func_
(
func
),

77 
Çme_
(
Çme
),

78 
tid_
(
tid
),

79 
Ïtch_
(
Ïtch
)

82 
runInTh»ad
()

84 *
	gtid_
 = 
muduo
::
Cu¼’tTh»ad
::
tid
();

85 
	gtid_
 = 
NULL
;

86 
	gÏtch_
->
couÁDown
();

87 
	gÏtch_
 = 
NULL
;

90 
	gmuduo
::
Cu¼’tTh»ad
::
t_th»adName
 = 
Çme_
.
em±y
(è? "muduoTh»ad" :‚ame_.
c_¡r
();

91 ::
´ùl
(
PR_SET_NAME
, 
muduo
::
Cu¼’tTh»ad
::
t_th»adName
);

92 
	gŒy


94 
func_
();

95 
	gmuduo
::
Cu¼’tTh»ad
::
t_th»adName
 = "finished";

97 
ÿtch
 (cÚ¡ 
Exû±iÚ
& 
ex
)

99 
	gmuduo
::
Cu¼’tTh»ad
::
t_th»adName
 = "crashed";

100 
årštf
(
¡d”r
, "exû±iÚ caughˆš Th»ad %s\n", 
Çme_
.
c_¡r
());

101 
årštf
(
¡d”r
, "»asÚ: %s\n", 
ex
.
wh©
());

102 
årštf
(
¡d”r
, "¡ack¿û: %s\n", 
ex
.
¡ackT¿û
());

103 
abÜt
();

105 
ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
ex
)

107 
muduo
::
Cu¼’tTh»ad
::
t_th»adName
 = "crashed";

108 
årštf
(
¡d”r
, "exû±iÚ caughˆš Th»ad %s\n", 
Çme_
.
c_¡r
());

109 
årštf
(
¡d”r
, "»asÚ: %s\n", 
ex
.
wh©
());

110 
abÜt
();

112 
ÿtch
 (...)

114 
	gmuduo
::
Cu¼’tTh»ad
::
t_th»adName
 = "crashed";

115 
årštf
(
¡d”r
, "unknowÀexû±iÚ caughˆš Th»ad %s\n", 
Çme_
.
c_¡r
());

116 
	gthrow
;

121 * 
¡¬tTh»ad
(* 
obj
)

123 
Th»adD©a
* 
	gd©a
 = 
¡©ic_ÿ¡
<Th»adD©a*>(
obj
);

125 
	gd©a
->
runInTh»ad
();

126 
d–‘e
 
	gd©a
;

127  
	gNULL
;

133 
usšg
 
Çme¥aû
 
	gmuduo
;

135 
	gCu¼’tTh»ad
::
	$ÿcheTid
()

137 ià(
t_ÿchedTid
 == 0)

139 
t_ÿchedTid
 = 
d‘a
::
	`g‘tid
();

140 
t_tidSŒšgL’gth
 = 
	`¢´štf
(
t_tidSŒšg
, _tidSŒšg, "%5d ", 
t_ÿchedTid
);

142 
	}
}

144 
boŞ
 
	gCu¼’tTh»ad
::
	$isMašTh»ad
()

146  
	`tid
(è=ğ::
	`g‘pid
();

147 
	}
}

149 
	gCu¼’tTh»ad
::
	$¦“pU£c
(
št64_t
 
u£c
)

151 
time¥ec
 
ts
 = { 0, 0 };

152 
ts
.
tv_£c
 = 
¡©ic_ÿ¡
<
time_t
>(
u£c
 / 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
);

153 
ts
.
tv_n£c
 = 
¡©ic_ÿ¡
<>(
u£c
 % 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
 * 1000);

154 ::
	`Çno¦“p
(&
ts
, 
NULL
);

155 
	}
}

157 
AtomicIÁ32
 
	gTh»ad
::
numC»©ed_
;

159 
	gTh»ad
::
	$Th»ad
(cÚ¡ 
Th»adFunc
& 
func
, cÚ¡ 
¡ršg
& 
n
)

160 : 
	`¡¬‹d_
(
çl£
),

161 
	`jošed_
(
çl£
),

162 
	`±h»adId_
(0),

163 
	`tid_
(0),

164 
	`func_
(
func
),

165 
	`Çme_
(
n
),

166 
	$Ïtch_
(1)

168 
	`£tDeçuÉName
();

169 
	}
}

171 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


172 
	gTh»ad
::
	$Th»ad
(
Th»adFunc
&& 
func
, cÚ¡ 
¡ršg
& 
n
)

173 : 
	`¡¬‹d_
(
çl£
),

174 
	`jošed_
(
çl£
),

175 
	`±h»adId_
(0),

176 
	`tid_
(0),

177 
	`func_
(
¡d
::
	`move
(
func
)),

178 
	`Çme_
(
n
),

179 
	$Ïtch_
(1)

181 
	`£tDeçuÉName
();

182 
	}
}

186 
	gTh»ad
::~
	$Th»ad
()

188 ià(
¡¬‹d_
 && !
jošed_
)

190 
	`±h»ad_d‘ach
(
±h»adId_
);

192 
	}
}

194 
	gTh»ad
::
	$£tDeçuÉName
()

196 
num
 = 
numC»©ed_
.
	`šüem’tAndG‘
();

197 ià(
Çme_
.
	`em±y
())

199 
buf
[32];

200 
	`¢´štf
(
buf
,  buf, "Th»ad%d", 
num
);

201 
Çme_
 = 
buf
;

203 
	}
}

205 
	gTh»ad
::
	$¡¬t
()

207 
	`as£¹
(!
¡¬‹d_
);

208 
¡¬‹d_
 = 
Œue
;

210 
d‘a
::
Th»adD©a
* 
d©a
 = 
Ãw
 d‘a::
	`Th»adD©a
(
func_
, 
Çme_
, &
tid_
, &
Ïtch_
);

211 ià(
	`±h»ad_ü—‹
(&
±h»adId_
, 
NULL
, &
d‘a
::
¡¬tTh»ad
, 
d©a
))

213 
¡¬‹d_
 = 
çl£
;

214 
d–‘e
 
d©a
;

215 
LOG_SYSFATAL
 << "Failed in…thread_create";

219 
Ïtch_
.
	`wa™
();

220 
	`as£¹
(
tid_
 > 0);

222 
	}
}

224 
	gTh»ad
::
	$još
()

226 
	`as£¹
(
¡¬‹d_
);

227 
	`as£¹
(!
jošed_
);

228 
jošed_
 = 
Œue
;

229  
	`±h»ad_još
(
±h»adId_
, 
NULL
);

230 
	}
}

	@muduo/base/Thread.h

6 #iâdeà
MUDUO_BASE_THREAD_H


7 
	#MUDUO_BASE_THREAD_H


	)

9 
	~<muduo/ba£/Atomic.h
>

10 
	~<muduo/ba£/CouÁDownL©ch.h
>

11 
	~<muduo/ba£/Ty³s.h
>

13 
	~<boo¡/funùiÚ.hµ
>

14 
	~<boo¡/nÚcİyabË.hµ
>

15 
	~<boo¡/sh¬ed_±r.hµ
>

16 
	~<±h»ad.h
>

18 
Çme¥aû
 
	gmuduo


21 şas 
	cTh»ad
 : 
boo¡
::
nÚcİyabË


23 
public
:

24 
boo¡
::
	tfunùiÚ
<()> 
	tTh»adFunc
;

26 
ex¶ic™
 
Th»ad
(cÚ¡ 
Th»adFunc
&, cÚ¡ 
¡ršg
& 
Çme
 = string());

27 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


28 
ex¶ic™
 
Th»ad
(
Th»adFunc
&&, cÚ¡ 
¡ršg
& 
Çme
 = string());

30 ~
Th»ad
();

32 
¡¬t
();

33 
još
();

35 
boŞ
 
¡¬‹d
(ècÚ¡ {  
	g¡¬‹d_
; }

37 
pid_t
 
tid
(ècÚ¡ {  
	gtid_
; }

38 cÚ¡ 
	g¡ršg
& 
Çme
(ècÚ¡ {  
	gÇme_
; }

40 
numC»©ed
(è{  
	gnumC»©ed_
.
g‘
(); }

42 
	g´iv©e
:

43 
£tDeçuÉName
();

45 
boŞ
 
	g¡¬‹d_
;

46 
boŞ
 
	gjošed_
;

48 
±h»ad_t
 
	g±h»adId_
;

49 
pid_t
 
	gtid_
;

51 
Th»adFunc
 
	gfunc_
;

52 
¡ršg
 
	gÇme_
;

53 
CouÁDownL©ch
 
	gÏtch_
;

55 
AtomicIÁ32
 
	gnumC»©ed_
;

	@muduo/base/Thread.h

6 #iâdeà
MUDUO_BASE_THREAD_H


7 
	#MUDUO_BASE_THREAD_H


	)

9 
	~<muduo/ba£/Atomic.h
>

10 
	~<muduo/ba£/CouÁDownL©ch.h
>

11 
	~<muduo/ba£/Ty³s.h
>

13 
	~<boo¡/funùiÚ.hµ
>

14 
	~<boo¡/nÚcİyabË.hµ
>

15 
	~<boo¡/sh¬ed_±r.hµ
>

16 
	~<±h»ad.h
>

18 
Çme¥aû
 
	gmuduo


21 şas 
	cTh»ad
 : 
boo¡
::
nÚcİyabË


23 
public
:

24 
boo¡
::
	tfunùiÚ
<()> 
	tTh»adFunc
;

26 
ex¶ic™
 
Th»ad
(cÚ¡ 
Th»adFunc
&, cÚ¡ 
¡ršg
& 
Çme
 = string());

27 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


28 
ex¶ic™
 
Th»ad
(
Th»adFunc
&&, cÚ¡ 
¡ršg
& 
Çme
 = string());

30 ~
Th»ad
();

32 
¡¬t
();

33 
još
();

35 
boŞ
 
¡¬‹d
(ècÚ¡ {  
	g¡¬‹d_
; }

37 
pid_t
 
tid
(ècÚ¡ {  
	gtid_
; }

38 cÚ¡ 
	g¡ršg
& 
Çme
(ècÚ¡ {  
	gÇme_
; }

40 
numC»©ed
(è{  
	gnumC»©ed_
.
g‘
(); }

42 
	g´iv©e
:

43 
£tDeçuÉName
();

45 
boŞ
 
	g¡¬‹d_
;

46 
boŞ
 
	gjošed_
;

48 
±h»ad_t
 
	g±h»adId_
;

49 
pid_t
 
	gtid_
;

51 
Th»adFunc
 
	gfunc_
;

52 
¡ršg
 
	gÇme_
;

53 
CouÁDownL©ch
 
	gÏtch_
;

55 
AtomicIÁ32
 
	gnumC»©ed_
;

	@muduo/base/ThreadLocal.h

6 #iâdeà
MUDUO_BASE_THREADLOCAL_H


7 
	#MUDUO_BASE_THREADLOCAL_H


	)

9 
	~<muduo/ba£/Mu‹x.h
>

11 
	~<boo¡/nÚcİyabË.hµ
>

12 
	~<±h»ad.h
>

14 
Çme¥aû
 
	gmuduo


17 
	g‹m¶©e
<
ty³Çme
 
	gT
>

18 şas 
	cTh»adLoÿl
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
Th»adLoÿl
()

23 
MCHECK
(
±h»ad_key_ü—‹
(&
pkey_
, &
Th»adLoÿl
::
de¡ruùÜ
));

26 ~
Th»adLoÿl
()

28 
MCHECK
(
±h»ad_key_d–‘e
(
pkey_
));

31 
	gT
& 
v®ue
()

33 
T
* 
	g³rTh»adV®ue
 = 
¡©ic_ÿ¡
<T*>(
±h»ad_g‘¥ecific
(
pkey_
));

34 ià(!
	g³rTh»adV®ue
)

36 
T
* 
	gÃwObj
 = 
Ãw
 T();

37 
MCHECK
(
±h»ad_£t¥ecific
(
pkey_
, 
ÃwObj
));

38 
	g³rTh»adV®ue
 = 
ÃwObj
;

40  *
	g³rTh»adV®ue
;

43 
	g´iv©e
:

45 
de¡ruùÜ
(*
x
)

47 
T
* 
obj
 = 
¡©ic_ÿ¡
<T*>(
x
);

48 
	tT_mu¡_be_com¶‘e_ty³
[(
T
) == 0 ? -1 : 1];

49 
T_mu¡_be_com¶‘e_ty³
 
	gdummy
; () dummy;

50 
d–‘e
 
	gobj
;

53 
	g´iv©e
:

54 
±h»ad_key_t
 
pkey_
;

	@muduo/base/ThreadLocal.h

6 #iâdeà
MUDUO_BASE_THREADLOCAL_H


7 
	#MUDUO_BASE_THREADLOCAL_H


	)

9 
	~<muduo/ba£/Mu‹x.h
>

11 
	~<boo¡/nÚcİyabË.hµ
>

12 
	~<±h»ad.h
>

14 
Çme¥aû
 
	gmuduo


17 
	g‹m¶©e
<
ty³Çme
 
	gT
>

18 şas 
	cTh»adLoÿl
 : 
boo¡
::
nÚcİyabË


20 
public
:

21 
Th»adLoÿl
()

23 
MCHECK
(
±h»ad_key_ü—‹
(&
pkey_
, &
Th»adLoÿl
::
de¡ruùÜ
));

26 ~
Th»adLoÿl
()

28 
MCHECK
(
±h»ad_key_d–‘e
(
pkey_
));

31 
	gT
& 
v®ue
()

33 
T
* 
	g³rTh»adV®ue
 = 
¡©ic_ÿ¡
<T*>(
±h»ad_g‘¥ecific
(
pkey_
));

34 ià(!
	g³rTh»adV®ue
)

36 
T
* 
	gÃwObj
 = 
Ãw
 T();

37 
MCHECK
(
±h»ad_£t¥ecific
(
pkey_
, 
ÃwObj
));

38 
	g³rTh»adV®ue
 = 
ÃwObj
;

40  *
	g³rTh»adV®ue
;

43 
	g´iv©e
:

45 
de¡ruùÜ
(*
x
)

47 
T
* 
obj
 = 
¡©ic_ÿ¡
<T*>(
x
);

48 
	tT_mu¡_be_com¶‘e_ty³
[(
T
) == 0 ? -1 : 1];

49 
T_mu¡_be_com¶‘e_ty³
 
	gdummy
; () dummy;

50 
d–‘e
 
	gobj
;

53 
	g´iv©e
:

54 
±h»ad_key_t
 
pkey_
;

	@muduo/base/ThreadLocalSingleton.h

6 #iâdeà
MUDUO_BASE_THREADLOCALSINGLETON_H


7 
	#MUDUO_BASE_THREADLOCALSINGLETON_H


	)

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<as£¹.h
>

11 
	~<±h»ad.h
>

13 
Çme¥aû
 
	gmuduo


16 
	g‹m¶©e
<
ty³Çme
 
	gT
>

17 şas 
	cTh»adLoÿlSšgËtÚ
 : 
boo¡
::
nÚcİyabË


19 
public
:

21 
T
& 
š¡ªû
()

23 ià(!
t_v®ue_
)

25 
t_v®ue_
 = 
Ãw
 
T
();

26 
	gd–‘”_
.
£t
(
t_v®ue_
);

28  *
	gt_v®ue_
;

31 
T
* 
poš‹r
()

33  
	gt_v®ue_
;

36 
	g´iv©e
:

37 
Th»adLoÿlSšgËtÚ
();

38 ~
Th»adLoÿlSšgËtÚ
();

40 
de¡ruùÜ
(* 
obj
)

42 
as£¹
(
obj
 =ğ
t_v®ue_
);

43 
	tT_mu¡_be_com¶‘e_ty³
[(
T
) == 0 ? -1 : 1];

44 
T_mu¡_be_com¶‘e_ty³
 
	gdummy
; () dummy;

45 
d–‘e
 
	gt_v®ue_
;

46 
	gt_v®ue_
 = 0;

49 şas 
	cD–‘”


51 
	gpublic
:

52 
D–‘”
()

54 
±h»ad_key_ü—‹
(&
pkey_
, &
Th»adLoÿlSšgËtÚ
::
de¡ruùÜ
);

57 ~
D–‘”
()

59 
±h»ad_key_d–‘e
(
pkey_
);

62 
£t
(
T
* 
ÃwObj
)

64 
as£¹
(
±h»ad_g‘¥ecific
(
pkey_
è=ğ
NULL
);

65 
±h»ad_£t¥ecific
(
pkey_
, 
ÃwObj
);

68 
±h»ad_key_t
 
	gpkey_
;

71 
__th»ad
 
T
* 
	gt_v®ue_
;

72 
D–‘”
 
	gd–‘”_
;

75 
	g‹m¶©e
<
ty³Çme
 
	gT
>

76 
__th»ad
 
T
* 
	gTh»adLoÿlSšgËtÚ
<
	gT
>::
t_v®ue_
 = 0;

78 
	g‹m¶©e
<
ty³Çme
 
	gT
>

79 
ty³Çme
 
	gTh»adLoÿlSšgËtÚ
<
	gT
>::
D–‘”
 
Th»adLoÿlSšgËtÚ
<
T
>::
d–‘”_
;

	@muduo/base/ThreadLocalSingleton.h

6 #iâdeà
MUDUO_BASE_THREADLOCALSINGLETON_H


7 
	#MUDUO_BASE_THREADLOCALSINGLETON_H


	)

9 
	~<boo¡/nÚcİyabË.hµ
>

10 
	~<as£¹.h
>

11 
	~<±h»ad.h
>

13 
Çme¥aû
 
	gmuduo


16 
	g‹m¶©e
<
ty³Çme
 
	gT
>

17 şas 
	cTh»adLoÿlSšgËtÚ
 : 
boo¡
::
nÚcİyabË


19 
public
:

21 
T
& 
š¡ªû
()

23 ià(!
t_v®ue_
)

25 
t_v®ue_
 = 
Ãw
 
T
();

26 
	gd–‘”_
.
£t
(
t_v®ue_
);

28  *
	gt_v®ue_
;

31 
T
* 
poš‹r
()

33  
	gt_v®ue_
;

36 
	g´iv©e
:

37 
Th»adLoÿlSšgËtÚ
();

38 ~
Th»adLoÿlSšgËtÚ
();

40 
de¡ruùÜ
(* 
obj
)

42 
as£¹
(
obj
 =ğ
t_v®ue_
);

43 
	tT_mu¡_be_com¶‘e_ty³
[(
T
) == 0 ? -1 : 1];

44 
T_mu¡_be_com¶‘e_ty³
 
	gdummy
; () dummy;

45 
d–‘e
 
	gt_v®ue_
;

46 
	gt_v®ue_
 = 0;

49 şas 
	cD–‘”


51 
	gpublic
:

52 
D–‘”
()

54 
±h»ad_key_ü—‹
(&
pkey_
, &
Th»adLoÿlSšgËtÚ
::
de¡ruùÜ
);

57 ~
D–‘”
()

59 
±h»ad_key_d–‘e
(
pkey_
);

62 
£t
(
T
* 
ÃwObj
)

64 
as£¹
(
±h»ad_g‘¥ecific
(
pkey_
è=ğ
NULL
);

65 
±h»ad_£t¥ecific
(
pkey_
, 
ÃwObj
);

68 
±h»ad_key_t
 
	gpkey_
;

71 
__th»ad
 
T
* 
	gt_v®ue_
;

72 
D–‘”
 
	gd–‘”_
;

75 
	g‹m¶©e
<
ty³Çme
 
	gT
>

76 
__th»ad
 
T
* 
	gTh»adLoÿlSšgËtÚ
<
	gT
>::
t_v®ue_
 = 0;

78 
	g‹m¶©e
<
ty³Çme
 
	gT
>

79 
ty³Çme
 
	gTh»adLoÿlSšgËtÚ
<
	gT
>::
D–‘”
 
Th»adLoÿlSšgËtÚ
<
T
>::
d–‘”_
;

	@muduo/base/ThreadPool.cc

6 
	~<muduo/ba£/Th»adPoŞ.h
>

8 
	~<muduo/ba£/Exû±iÚ.h
>

10 
	~<boo¡/bšd.hµ
>

11 
	~<as£¹.h
>

12 
	~<¡dio.h
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
	gTh»adPoŞ
::
	$Th»adPoŞ
(cÚ¡ 
¡ršg
& 
ÇmeArg
)

17 : 
	`mu‹x_
(),

18 
	`nÙEm±y_
(
mu‹x_
),

19 
	`nÙFuÎ_
(
mu‹x_
),

20 
	`Çme_
(
ÇmeArg
),

21 
	`maxQueueSize_
(0),

22 
	$ruÂšg_
(
çl£
)

24 
	}
}

26 
	gTh»adPoŞ
::~
	$Th»adPoŞ
()

28 ià(
ruÂšg_
)

30 
	`¡İ
();

32 
	}
}

34 
	gTh»adPoŞ
::
	$¡¬t
(
numTh»ads
)

36 
	`as£¹
(
th»ads_
.
	`em±y
());

37 
ruÂšg_
 = 
Œue
;

38 
th»ads_
.
	`»£rve
(
numTh»ads
);

39 
i
 = 0; i < 
numTh»ads
; ++i)

41 
id
[32];

42 
	`¢´štf
(
id
,  id, "%d", 
i
+1);

43 
th»ads_
.
	`push_back
(
Ãw
 
muduo
::
	`Th»ad
(

44 
boo¡
::
	`bšd
(&
Th»adPoŞ
::
runInTh»ad
, 
this
), 
Çme_
+
id
));

45 
th»ads_
[
i
].
	`¡¬t
();

47 ià(
numTh»ads
 =ğ0 && 
th»adIn™C®lback_
)

49 
	`th»adIn™C®lback_
();

51 
	}
}

53 
	gTh»adPoŞ
::
	$¡İ
()

56 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

57 
ruÂšg_
 = 
çl£
;

58 
nÙEm±y_
.
	`nÙifyAÎ
();

60 
	`fÜ_—ch
(
th»ads_
.
	`begš
(),

61 
th»ads_
.
	`’d
(),

62 
boo¡
::
	`bšd
(&
muduo
::
Th»ad
::
još
, 
_1
));

63 
	}
}

65 
size_t
 
	gTh»adPoŞ
::
	$queueSize
() const

67 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

68  
queue_
.
	`size
();

69 
	}
}

71 
	gTh»adPoŞ
::
	$run
(cÚ¡ 
Task
& 
sk
)

73 ià(
th»ads_
.
	`em±y
())

75 
	`sk
();

79 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

80 
	`isFuÎ
())

82 
nÙFuÎ_
.
	`wa™
();

84 
	`as£¹
(!
	`isFuÎ
());

86 
queue_
.
	`push_back
(
sk
);

87 
nÙEm±y_
.
	`nÙify
();

89 
	}
}

91 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


92 
	gTh»adPoŞ
::
	$run
(
Task
&& 
sk
)

94 ià(
th»ads_
.
	`em±y
())

96 
	`sk
();

100 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

101 
	`isFuÎ
())

103 
nÙFuÎ_
.
	`wa™
();

105 
	`as£¹
(!
	`isFuÎ
());

107 
queue_
.
	`push_back
(
¡d
::
	`move
(
sk
));

108 
nÙEm±y_
.
	`nÙify
();

110 
	}
}

113 
	gTh»adPoŞ
::
Task
 
Th»adPoŞ
::
	$ke
()

115 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

117 
queue_
.
	`em±y
(è&& 
ruÂšg_
)

119 
nÙEm±y_
.
	`wa™
();

121 
Task
 
sk
;

122 ià(!
queue_
.
	`em±y
())

124 
sk
 = 
queue_
.
	`äÚt
();

125 
queue_
.
	`pİ_äÚt
();

126 ià(
maxQueueSize_
 > 0)

128 
nÙFuÎ_
.
	`nÙify
();

131  
sk
;

132 
	}
}

134 
boŞ
 
	gTh»adPoŞ
::
	$isFuÎ
() const

136 
mu‹x_
.
	`as£¹Locked
();

137  
maxQueueSize_
 > 0 && 
queue_
.
	`size
() >= maxQueueSize_;

138 
	}
}

140 
	gTh»adPoŞ
::
	$runInTh»ad
()

142 
Œy


144 ià(
th»adIn™C®lback_
)

146 
	`th»adIn™C®lback_
();

148 
ruÂšg_
)

150 
Task
 
	`sk
(
	`ke
());

151 ià(
sk
)

153 
	`sk
();

157 
	`ÿtch
 (cÚ¡ 
Exû±iÚ
& 
ex
)

159 
	`årštf
(
¡d”r
, "exû±iÚ caughˆš Th»adPoŞ %s\n", 
Çme_
.
	`c_¡r
());

160 
	`årštf
(
¡d”r
, "»asÚ: %s\n", 
ex
.
	`wh©
());

161 
	`årštf
(
¡d”r
, "¡ack¿û: %s\n", 
ex
.
	`¡ackT¿û
());

162 
	`abÜt
();

164 
	`ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
ex
)

166 
	`årštf
(
¡d”r
, "exû±iÚ caughˆš Th»adPoŞ %s\n", 
Çme_
.
	`c_¡r
());

167 
	`årštf
(
¡d”r
, "»asÚ: %s\n", 
ex
.
	`wh©
());

168 
	`abÜt
();

170 
	`ÿtch
 (...)

172 
	`årštf
(
¡d”r
, "unknowÀexû±iÚ caughˆš Th»adPoŞ %s\n", 
Çme_
.
	`c_¡r
());

173 
throw
;

175 
	}
}

	@muduo/base/ThreadPool.h

6 #iâdeà
MUDUO_BASE_THREADPOOL_H


7 
	#MUDUO_BASE_THREADPOOL_H


	)

9 
	~<muduo/ba£/CÚd™iÚ.h
>

10 
	~<muduo/ba£/Mu‹x.h
>

11 
	~<muduo/ba£/Th»ad.h
>

12 
	~<muduo/ba£/Ty³s.h
>

14 
	~<boo¡/funùiÚ.hµ
>

15 
	~<boo¡/nÚcİyabË.hµ
>

16 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

18 
	~<deque
>

20 
Çme¥aû
 
	gmuduo


23 şas 
	cTh»adPoŞ
 : 
boo¡
::
nÚcİyabË


25 
public
:

26 
boo¡
::
	tfunùiÚ
<()> 
	tTask
;

28 
ex¶ic™
 
Th»adPoŞ
(cÚ¡ 
¡ršg
& 
ÇmeArg
 = string("ThreadPool"));

29 ~
Th»adPoŞ
();

32 
£tMaxQueueSize
(
maxSize
è{ 
	gmaxQueueSize_
 = maxSize; }

33 
£tTh»adIn™C®lback
(cÚ¡ 
Task
& 
cb
)

34 { 
	gth»adIn™C®lback_
 = 
cb
; }

36 
¡¬t
(
numTh»ads
);

37 
¡İ
();

39 cÚ¡ 
	g¡ršg
& 
Çme
() const

40 {  
	gÇme_
; }

42 
size_t
 
queueSize
() const;

45 
run
(cÚ¡ 
Task
& 
f
);

46 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


47 
run
(
Task
&& 
f
);

50 
	g´iv©e
:

51 
boŞ
 
isFuÎ
() const;

52 
runInTh»ad
();

53 
Task
 
ke
();

55 
mubË
 
Mu‹xLock
 
	gmu‹x_
;

56 
CÚd™iÚ
 
	gnÙEm±y_
;

57 
CÚd™iÚ
 
	gnÙFuÎ_
;

58 
¡ršg
 
	gÇme_
;

59 
Task
 
	gth»adIn™C®lback_
;

60 
	gboo¡
::
±r_veùÜ
<
muduo
::
Th»ad
> 
th»ads_
;

61 
	g¡d
::
deque
<
Task
> 
queue_
;

62 
size_t
 
	gmaxQueueSize_
;

63 
boŞ
 
	gruÂšg_
;

	@muduo/base/ThreadPool.h

6 #iâdeà
MUDUO_BASE_THREADPOOL_H


7 
	#MUDUO_BASE_THREADPOOL_H


	)

9 
	~<muduo/ba£/CÚd™iÚ.h
>

10 
	~<muduo/ba£/Mu‹x.h
>

11 
	~<muduo/ba£/Th»ad.h
>

12 
	~<muduo/ba£/Ty³s.h
>

14 
	~<boo¡/funùiÚ.hµ
>

15 
	~<boo¡/nÚcİyabË.hµ
>

16 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

18 
	~<deque
>

20 
Çme¥aû
 
	gmuduo


23 şas 
	cTh»adPoŞ
 : 
boo¡
::
nÚcİyabË


25 
public
:

26 
boo¡
::
	tfunùiÚ
<()> 
	tTask
;

28 
ex¶ic™
 
Th»adPoŞ
(cÚ¡ 
¡ršg
& 
ÇmeArg
 = string("ThreadPool"));

29 ~
Th»adPoŞ
();

32 
£tMaxQueueSize
(
maxSize
è{ 
	gmaxQueueSize_
 = maxSize; }

33 
£tTh»adIn™C®lback
(cÚ¡ 
Task
& 
cb
)

34 { 
	gth»adIn™C®lback_
 = 
cb
; }

36 
¡¬t
(
numTh»ads
);

37 
¡İ
();

39 cÚ¡ 
	g¡ršg
& 
Çme
() const

40 {  
	gÇme_
; }

42 
size_t
 
queueSize
() const;

45 
run
(cÚ¡ 
Task
& 
f
);

46 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


47 
run
(
Task
&& 
f
);

50 
	g´iv©e
:

51 
boŞ
 
isFuÎ
() const;

52 
runInTh»ad
();

53 
Task
 
ke
();

55 
mubË
 
Mu‹xLock
 
	gmu‹x_
;

56 
CÚd™iÚ
 
	gnÙEm±y_
;

57 
CÚd™iÚ
 
	gnÙFuÎ_
;

58 
¡ršg
 
	gÇme_
;

59 
Task
 
	gth»adIn™C®lback_
;

60 
	gboo¡
::
±r_veùÜ
<
muduo
::
Th»ad
> 
th»ads_
;

61 
	g¡d
::
deque
<
Task
> 
queue_
;

62 
size_t
 
	gmaxQueueSize_
;

63 
boŞ
 
	gruÂšg_
;

	@muduo/base/TimeZone.cc

1 
	~<muduo/ba£/TimeZÚe.h
>

2 
	~<muduo/ba£/D©e.h
>

4 
	~<boo¡/nÚcİyabË.hµ
>

5 
	~<®gÜ™hm
>

6 
	~<¡dexû±
>

7 
	~<¡ršg
>

8 
	~<veùÜ
>

11 
	~<’dŸn.h
>

13 
	~<¡dšt.h
>

14 
	~<¡dio.h
>

15 
	~<¡ršgs.h
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gd‘a


22 
	sT¿ns™iÚ


24 
time_t
 
	ggm‰ime
;

25 
time_t
 
	gloÿÉime
;

26 
	gloÿÉimeIdx
;

28 
T¿ns™iÚ
(
time_t
 
t
,ime_ˆ
l
, 
loÿlIdx
)

29 : 
gm‰ime
(
t
), 
loÿÉime
(
l
), 
loÿÉimeIdx
(
loÿlIdx
)

34 
	sComp


36 
boŞ
 
	gcom·»Gmt
;

38 
Comp
(
boŞ
 
gmt
)

39 : 
com·»Gmt
(
gmt
)

43 
boŞ
 
İ”©Ü
()(cÚ¡ 
T¿ns™iÚ
& 
lhs
, cÚ¡ 
	gT¿ns™iÚ
& 
	grhs
) const

45 ià(
	gcom·»Gmt
)

46  
	glhs
.
	ggm‰ime
 < 
	grhs
.gmttime;

48  
	glhs
.
	gloÿÉime
 < 
	grhs
.localtime;

51 
boŞ
 
equ®
(cÚ¡ 
T¿ns™iÚ
& 
lhs
, cÚ¡ T¿ns™iÚ& 
rhs
) const

53 ià(
	gcom·»Gmt
)

54  
	glhs
.
	ggm‰ime
 =ğ
rhs
.
gm‰ime
;

56  
	glhs
.
	gloÿÉime
 =ğ
rhs
.
loÿÉime
;

60 
	sLoÿÉime


62 
time_t
 
	ggmtOff£t
;

63 
boŞ
 
	gisD¡
;

64 
	g¬rbIdx
;

66 
LoÿÉime
(
time_t
 
off£t
, 
boŞ
 
d¡
, 
¬rb
)

67 : 
gmtOff£t
(
off£t
), 
isD¡
(
d¡
), 
¬rbIdx
(
¬rb
)

71 
šlše
 
flHMS
(
£cÚds
, 
tm
* 
utc
)

73 
	gutc
->
	gtm_£c
 = 
£cÚds
 % 60;

74 
	gmšu‹s
 = 
£cÚds
 / 60;

75 
	gutc
->
	gtm_mš
 = 
mšu‹s
 % 60;

76 
	gutc
->
	gtm_hour
 = 
mšu‹s
 / 60;

80 cÚ¡ 
	gkSecÚdsP”Day
 = 24*60*60;

83 
usšg
 
Çme¥aû
 
	gmuduo
;

84 
usšg
 
Çme¥aû
 
	g¡d
;

86 
	gTimeZÚe
::
D©a


88 
veùÜ
<
d‘a
::
T¿ns™iÚ
> 
Œªs™iÚs
;

89 
	gveùÜ
<
	gd‘a
::
LoÿÉime
> 
loÿÉimes
;

90 
	gveùÜ
<
	g¡ršg
> 
	gÇmes
;

91 
¡ršg
 
	gabb»vŸtiÚ
;

94 
Çme¥aû
 
	gmuduo


96 
Çme¥aû
 
	gd‘a


99 şas 
	cFe
 : 
boo¡
::
nÚcİyabË


101 
public
:

102 
Fe
(cÚ¡ * 
fe
)

103 : 
å_
(::
fİ’
(
fe
, "rb"))

107 ~
Fe
()

109 ià(
	gå_
)

111 ::
fşo£
(
å_
);

115 
boŞ
 
v®id
(ècÚ¡ {  
	gå_
; }

117 
¡ršg
 
»adBy‹s
(
n
)

119 
	gbuf
[
n
];

120 
ssize_t
 
	gÄ
 = ::
ä—d
(
buf
, 1, 
n
, 
å_
);

121 ià(
	gÄ
 !ğ
n
)

122 
throw
 
logic_”rÜ
("noƒnough data");

123  
¡ršg
(
buf
, 
n
);

126 
št32_t
 
»adIÁ32
()

128 
št32_t
 
	gx
 = 0;

129 
ssize_t
 
	gÄ
 = ::
ä—d
(&
x
, 1, (
št32_t
), 
å_
);

130 ià(
	gÄ
 !ğ(
št32_t
))

131 
throw
 
logic_”rÜ
("bad int32_t data");

132  
be32toh
(
x
);

135 
ušt8_t
 
»adUIÁ8
()

137 
ušt8_t
 
	gx
 = 0;

138 
ssize_t
 
	gÄ
 = ::
ä—d
(&
x
, 1, (
ušt8_t
), 
å_
);

139 ià(
	gÄ
 !ğ(
ušt8_t
))

140 
throw
 
logic_”rÜ
("bad uint8_t data");

141  
	gx
;

144 
	g´iv©e
:

145 
FILE
* 
å_
;

148 
boŞ
 
»adTimeZÚeFe
(cÚ¡ * 
zÚefe
, 
TimeZÚe
::
D©a
* 
d©a
)

150 
Fe
 
f
(
zÚefe
);

151 ià(
	gf
.
v®id
())

153 
	gŒy


155 
¡ršg
 
	gh—d
 = 
f
.
»adBy‹s
(4);

156 ià(
	gh—d
 != "TZif")

157 
throw
 
logic_”rÜ
("bad head");

158 
¡ršg
 
	gv”siÚ
 = 
f
.
»adBy‹s
(1);

159 
	gf
.
»adBy‹s
(15);

161 
št32_t
 
	gisgmtút
 = 
f
.
»adIÁ32
();

162 
št32_t
 
	gis¡dút
 = 
f
.
»adIÁ32
();

163 
št32_t
 
	gË­út
 = 
f
.
»adIÁ32
();

164 
št32_t
 
	gtimeút
 = 
f
.
»adIÁ32
();

165 
št32_t
 
	gty³út
 = 
f
.
»adIÁ32
();

166 
št32_t
 
	gch¬út
 = 
f
.
»adIÁ32
();

168 
	gveùÜ
<
	gšt32_t
> 
	gŒªs
;

169 
	gveùÜ
<> 
	gloÿÉimes
;

170 
	gŒªs
.
»£rve
(
timeút
);

171 
	gi
 = 0; i < 
	gtimeút
; ++i)

173 
	gŒªs
.
push_back
(
f
.
»adIÁ32
());

176 
	gi
 = 0; i < 
	gtimeút
; ++i)

178 
ušt8_t
 
	gloÿl
 = 
f
.
»adUIÁ8
();

179 
	gloÿÉimes
.
push_back
(
loÿl
);

182 
	gi
 = 0; i < 
	gty³út
; ++i)

184 
št32_t
 
	ggmtoff
 = 
f
.
»adIÁ32
();

185 
ušt8_t
 
	gisd¡
 = 
f
.
»adUIÁ8
();

186 
ušt8_t
 
	gabbršd
 = 
f
.
»adUIÁ8
();

188 
	gd©a
->
	gloÿÉimes
.
push_back
(
LoÿÉime
(
gmtoff
, 
isd¡
, 
abbršd
));

191 
	gi
 = 0; i < 
	gtimeút
; ++i)

193 
	gloÿlIdx
 = 
loÿÉimes
[
i
];

194 
time_t
 
	gloÿÉime
 = 
Œªs
[
i
] + 
d©a
->
loÿÉimes
[
loÿlIdx
].
gmtOff£t
;

195 
	gd©a
->
	gŒªs™iÚs
.
push_back
(
T¿ns™iÚ
(
Œªs
[
i
], 
loÿÉime
, 
loÿlIdx
));

198 
	gd©a
->
	gabb»vŸtiÚ
 = 
f
.
»adBy‹s
(
ch¬út
);

201 
	gi
 = 0; i < 
	gË­út
; ++i)

207 (è
	gis¡dút
;

208 (è
	gisgmtút
;

210 
ÿtch
 (
logic_”rÜ
& 
e
)

212 
årštf
(
¡d”r
, "%s\n", 
e
.
wh©
());

215  
	gŒue
;

218 cÚ¡ 
LoÿÉime
* 
fšdLoÿÉime
(cÚ¡ 
TimeZÚe
::
D©a
& 
d©a
, 
T¿ns™iÚ
 
£Áry
, 
Comp
 
comp
)

220 cÚ¡ 
LoÿÉime
* 
	gloÿl
 = 
NULL
;

222 ià(
	gd©a
.
	gŒªs™iÚs
.
em±y
(è|| 
comp
(
£Áry
, 
d©a
.
Œªs™iÚs
.
äÚt
()))

225 
	gloÿl
 = &
d©a
.
loÿÉimes
.
äÚt
();

229 
	gveùÜ
<
	gT¿ns™iÚ
>::
cÚ¡_™”©Ü
 
ŒªsI
 = 
low”_bound
(
d©a
.
Œªs™iÚs
.
begš
(),

230 
d©a
.
Œªs™iÚs
.
’d
(),

231 
£Áry
,

232 
comp
);

233 ià(
	gŒªsI
 !ğ
d©a
.
Œªs™iÚs
.
’d
())

235 ià(!
comp
.
equ®
(
£Áry
, *
ŒªsI
))

237 
as£¹
(
ŒªsI
 !ğ
d©a
.
Œªs™iÚs
.
begš
());

238 --
	gŒªsI
;

240 
	gloÿl
 = &
d©a
.
loÿÉimes
[
ŒªsI
->
loÿÉimeIdx
];

245 
	gloÿl
 = &
d©a
.
loÿÉimes
[d©a.
Œªs™iÚs
.
back
().
loÿÉimeIdx
];

249  
	gloÿl
;

256 
	gTimeZÚe
::
	$TimeZÚe
(cÚ¡ * 
zÚefe
)

257 : 
	`d©a_
(
Ãw
 
TimeZÚe
::
D©a
)

259 ià(!
d‘a
::
	`»adTimeZÚeFe
(
zÚefe
, 
d©a_
.
	`g‘
()))

261 
d©a_
.
	`»£t
();

263 
	}
}

265 
	gTimeZÚe
::
	$TimeZÚe
(
—¡OfUtc
, cÚ¡ * 
Çme
)

266 : 
	`d©a_
(
Ãw
 
TimeZÚe
::
D©a
)

268 
d©a_
->
loÿÉimes
.
	`push_back
(
d‘a
::
	`LoÿÉime
(
—¡OfUtc
, 
çl£
, 0));

269 
d©a_
->
abb»vŸtiÚ
 = 
Çme
;

270 
	}
}

272 
tm
 
	gTimeZÚe
::
	$toLoÿlTime
(
time_t
 
£cÚds
) const

274 
tm
 
loÿlTime
;

275 
	`bz”o
(&
loÿlTime
, (localTime));

276 
	`as£¹
(
d©a_
 !ğ
NULL
);

277 cÚ¡ 
D©a
& 
	`d©a
(*
d©a_
);

279 
d‘a
::
T¿ns™iÚ
 
	`£Áry
(
£cÚds
, 0, 0);

280 cÚ¡ 
d‘a
::
LoÿÉime
* 
loÿl
 = 
	`fšdLoÿÉime
(
d©a
, 
£Áry
, d‘a::
	`Comp
(
Œue
));

282 ià(
loÿl
)

284 
time_t
 
loÿlSecÚds
 = 
£cÚds
 + 
loÿl
->
gmtOff£t
;

285 ::
	`gmtime_r
(&
loÿlSecÚds
, &
loÿlTime
);

286 
loÿlTime
.
tm_isd¡
 = 
loÿl
->
isD¡
;

287 
loÿlTime
.
tm_gmtoff
 = 
loÿl
->
gmtOff£t
;

288 
loÿlTime
.
tm_zÚe
 = &
d©a
.
abb»vŸtiÚ
[
loÿl
->
¬rbIdx
];

291  
loÿlTime
;

292 
	}
}

294 
time_t
 
	gTimeZÚe
::
	$äomLoÿlTime
(cÚ¡ 
tm
& 
loÿlTm
) const

296 
	`as£¹
(
d©a_
 !ğ
NULL
);

297 cÚ¡ 
D©a
& 
	`d©a
(*
d©a_
);

299 
tm
 
tmp
 = 
loÿlTm
;

300 
time_t
 
£cÚds
 = ::
	`timegm
(&
tmp
);

301 
d‘a
::
T¿ns™iÚ
 
	`£Áry
(0, 
£cÚds
, 0);

302 cÚ¡ 
d‘a
::
LoÿÉime
* 
loÿl
 = 
	`fšdLoÿÉime
(
d©a
, 
£Áry
, d‘a::
	`Comp
(
çl£
));

303 ià(
loÿlTm
.
tm_isd¡
)

305 
tm
 
ŒyTm
 = 
	`toLoÿlTime
(
£cÚds
 - 
loÿl
->
gmtOff£t
);

306 ià(!
ŒyTm
.
tm_isd¡


307 && 
ŒyTm
.
tm_hour
 =ğ
loÿlTm
.tm_hour

308 && 
ŒyTm
.
tm_mš
 =ğ
loÿlTm
.tm_min)

311 
£cÚds
 -= 3600;

314  
£cÚds
 - 
loÿl
->
gmtOff£t
;

315 
	}
}

317 
tm
 
	gTimeZÚe
::
	$toUtcTime
(
time_t
 
£cÚdsSšûEpoch
, 
boŞ
 
yday
)

319 
tm
 
utc
;

320 
	`bz”o
(&
utc
, (utc));

321 
utc
.
tm_zÚe
 = "GMT";

322 
£cÚds
 = 
¡©ic_ÿ¡
<>(
£cÚdsSšûEpoch
 % 
kSecÚdsP”Day
);

323 
days
 = 
¡©ic_ÿ¡
<>(
£cÚdsSšûEpoch
 / 
kSecÚdsP”Day
);

324 ià(
£cÚds
 < 0)

326 
£cÚds
 +ğ
kSecÚdsP”Day
;

327 --
days
;

329 
d‘a
::
	`flHMS
(
£cÚds
, &
utc
);

330 
D©e
 
	`d©e
(
days
 + D©e::
kJulŸnDayOf1970_01_01
);

331 
D©e
::
Y—rMÚthDay
 
ymd
 = 
d©e
.
	`y—rMÚthDay
();

332 
utc
.
tm_y—r
 = 
ymd
.
y—r
 - 1900;

333 
utc
.
tm_mÚ
 = 
ymd
.
mÚth
 - 1;

334 
utc
.
tm_mday
 = 
ymd
.
day
;

335 
utc
.
tm_wday
 = 
d©e
.
	`w“kDay
();

337 ià(
yday
)

339 
D©e
 
	`¡¬tOfY—r
(
ymd
.
y—r
, 1, 1);

340 
utc
.
tm_yday
 = 
d©e
.
	`julŸnDayNumb”
(è- 
¡¬tOfY—r
.julianDayNumber();

342  
utc
;

343 
	}
}

345 
time_t
 
	gTimeZÚe
::
	$äomUtcTime
(cÚ¡ 
tm
& 
utc
)

347  
	`äomUtcTime
(
utc
.
tm_y—r
 + 1900, utc.
tm_mÚ
 + 1, utc.
tm_mday
,

348 
utc
.
tm_hour
, utc.
tm_mš
, utc.
tm_£c
);

349 
	}
}

351 
time_t
 
	gTimeZÚe
::
	$äomUtcTime
(
y—r
, 
mÚth
, 
day
,

352 
hour
, 
mšu‹
, 
£cÚds
)

354 
D©e
 
	`d©e
(
y—r
, 
mÚth
, 
day
);

355 
£cÚdsInDay
 = 
hour
 * 3600 + 
mšu‹
 * 60 + 
£cÚds
;

356 
time_t
 
days
 = 
d©e
.
	`julŸnDayNumb”
(è- 
D©e
::
kJulŸnDayOf1970_01_01
;

357  
days
 * 
kSecÚdsP”Day
 + 
£cÚdsInDay
;

358 
	}
}

	@muduo/base/TimeZone.h

6 #iâdeà
MUDUO_BASE_TIMEZONE_H


7 
	#MUDUO_BASE_TIMEZONE_H


	)

9 
	~<muduo/ba£/cİyabË.h
>

10 
	~<boo¡/sh¬ed_±r.hµ
>

11 
	~<time.h
>

13 
Çme¥aû
 
	gmuduo


17 şas 
	cTimeZÚe
 : 
public
 
muduo
::
cİyabË


19 
public
:

20 
ex¶ic™
 
TimeZÚe
(cÚ¡ * 
zÚefe
);

21 
TimeZÚe
(
—¡OfUtc
, cÚ¡ * 
tzÇme
);

22 
TimeZÚe
() {}

26 
boŞ
 
v®id
() const

29  
	g¡©ic_ÿ¡
<
	gboŞ
>(
	gd©a_
);

32 
tm
 
toLoÿlTime
(
time_t
 
£cÚdsSšûEpoch
) const;

33 
time_t
 
äomLoÿlTime
(cÚ¡ 
tm
&) const;

36 
tm
 
toUtcTime
(
time_t
 
£cÚdsSšûEpoch
, 
boŞ
 
yday
 = 
çl£
);

38 
time_t
 
äomUtcTime
(cÚ¡ 
tm
&);

40 
time_t
 
äomUtcTime
(
y—r
, 
mÚth
, 
day
,

41 
hour
, 
mšu‹
, 
£cÚds
);

43 
	gD©a
;

45 
	g´iv©e
:

47 
boo¡
::
sh¬ed_±r
<
D©a
> 
d©a_
;

	@muduo/base/TimeZone.h

6 #iâdeà
MUDUO_BASE_TIMEZONE_H


7 
	#MUDUO_BASE_TIMEZONE_H


	)

9 
	~<muduo/ba£/cİyabË.h
>

10 
	~<boo¡/sh¬ed_±r.hµ
>

11 
	~<time.h
>

13 
Çme¥aû
 
	gmuduo


17 şas 
	cTimeZÚe
 : 
public
 
muduo
::
cİyabË


19 
public
:

20 
ex¶ic™
 
TimeZÚe
(cÚ¡ * 
zÚefe
);

21 
TimeZÚe
(
—¡OfUtc
, cÚ¡ * 
tzÇme
);

22 
TimeZÚe
() {}

26 
boŞ
 
v®id
() const

29  
	g¡©ic_ÿ¡
<
	gboŞ
>(
	gd©a_
);

32 
tm
 
toLoÿlTime
(
time_t
 
£cÚdsSšûEpoch
) const;

33 
time_t
 
äomLoÿlTime
(cÚ¡ 
tm
&) const;

36 
tm
 
toUtcTime
(
time_t
 
£cÚdsSšûEpoch
, 
boŞ
 
yday
 = 
çl£
);

38 
time_t
 
äomUtcTime
(cÚ¡ 
tm
&);

40 
time_t
 
äomUtcTime
(
y—r
, 
mÚth
, 
day
,

41 
hour
, 
mšu‹
, 
£cÚds
);

43 
	gD©a
;

45 
	g´iv©e
:

47 
boo¡
::
sh¬ed_±r
<
D©a
> 
d©a_
;

	@muduo/base/Timestamp.cc

1 
	~<muduo/ba£/Time¡amp.h
>

3 
	~<sys/time.h
>

4 
	~<¡dio.h
>

6 #iâdeà
__STDC_FORMAT_MACROS


7 
	#__STDC_FORMAT_MACROS


	)

10 
	~<š‰y³s.h
>

12 
	~<boo¡/¡©ic_as£¹.hµ
>

14 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
BOOST_STATIC_ASSERT
((
Time¡amp
è=ğ(
št64_t
));

18 
¡ršg
 
	gTime¡amp
::
	$toSŒšg
() const

20 
buf
[32] = {0};

21 
št64_t
 
£cÚds
 = 
miüoSecÚdsSšûEpoch_
 / 
kMiüoSecÚdsP”SecÚd
;

22 
št64_t
 
miüo£cÚds
 = 
miüoSecÚdsSšûEpoch_
 % 
kMiüoSecÚdsP”SecÚd
;

23 
	`¢´štf
(
buf
, (buf)-1, "%" 
PRId64
 ".%06" PRId64 "", 
£cÚds
, 
miüo£cÚds
);

24  
buf
;

25 
	}
}

27 
¡ršg
 
	gTime¡amp
::
	$toFÜm©‹dSŒšg
(
boŞ
 
showMiüo£cÚds
) const

29 
buf
[32] = {0};

30 
time_t
 
£cÚds
 = 
¡©ic_ÿ¡
<time_t>(
miüoSecÚdsSšûEpoch_
 / 
kMiüoSecÚdsP”SecÚd
);

31 
tm
 
tm_time
;

32 
	`gmtime_r
(&
£cÚds
, &
tm_time
);

34 ià(
showMiüo£cÚds
)

36 
miüo£cÚds
 = 
¡©ic_ÿ¡
<>(
miüoSecÚdsSšûEpoch_
 % 
kMiüoSecÚdsP”SecÚd
);

37 
	`¢´štf
(
buf
, (buf), "%4d%02d%02d %02d:%02d:%02d.%06d",

38 
tm_time
.
tm_y—r
 + 1900,m_time.
tm_mÚ
 + 1,m_time.
tm_mday
,

39 
tm_time
.
tm_hour
,m_time.
tm_mš
,m_time.
tm_£c
,

40 
miüo£cÚds
);

44 
	`¢´štf
(
buf
, (buf), "%4d%02d%02d %02d:%02d:%02d",

45 
tm_time
.
tm_y—r
 + 1900,m_time.
tm_mÚ
 + 1,m_time.
tm_mday
,

46 
tm_time
.
tm_hour
,m_time.
tm_mš
,m_time.
tm_£c
);

48  
buf
;

49 
	}
}

51 
Time¡amp
 
	gTime¡amp
::
	$now
()

53 
timev®
 
tv
;

54 
	`g‘timeofday
(&
tv
, 
NULL
);

55 
št64_t
 
£cÚds
 = 
tv
.
tv_£c
;

56  
	`Time¡amp
(
£cÚds
 * 
kMiüoSecÚdsP”SecÚd
 + 
tv
.
tv_u£c
);

57 
	}
}

	@muduo/base/Timestamp.h

1 #iâdeà
MUDUO_BASE_TIMESTAMP_H


2 
	#MUDUO_BASE_TIMESTAMP_H


	)

4 
	~<muduo/ba£/cİyabË.h
>

5 
	~<muduo/ba£/Ty³s.h
>

7 
	~<boo¡/İ”©Üs.hµ
>

9 
Çme¥aû
 
	gmuduo


21 
şass
 
	gTime¡amp
 : 
public
 
muduo
::
cİyabË
,

22 
public
 
	gboo¡
::
equ®™y_com·¿bË
<
Time¡amp
>,

23 
public
 
	gboo¡
::
Ëss_thª_com·¿bË
<
Time¡amp
>

25 
public
:

29 
Time¡amp
()

30 : 
miüoSecÚdsSšûEpoch_
(0)

38 
ex¶ic™
 
Time¡amp
(
št64_t
 
miüoSecÚdsSšûEpochArg
)

39 : 
miüoSecÚdsSšûEpoch_
(
miüoSecÚdsSšûEpochArg
)

43 
sw­
(
Time¡amp
& 
th©
)

45 
¡d
::
sw­
(
miüoSecÚdsSšûEpoch_
, 
th©
.microSecondsSinceEpoch_);

50 
¡ršg
 
toSŒšg
() const;

51 
¡ršg
 
toFÜm©‹dSŒšg
(
boŞ
 
showMiüo£cÚds
 = 
Œue
) const;

54 
boŞ
 
v®id
(ècÚ¡ {  
	gmiüoSecÚdsSšûEpoch_
 > 0; }

57 
št64_t
 
miüoSecÚdsSšûEpoch
(ècÚ¡ {  
	gmiüoSecÚdsSšûEpoch_
; }

58 
time_t
 
£cÚdsSšûEpoch
() const

59 {  
	g¡©ic_ÿ¡
<
	gtime_t
>(
	gmiüoSecÚdsSšûEpoch_
 / 
	gkMiüoSecÚdsP”SecÚd
); }

65 
Time¡amp
 
now
();

67 
Time¡amp
 
šv®id
()

69  
Time¡amp
();

72 
Time¡amp
 
äomUnixTime
(
time_t
 
t
)

74  
äomUnixTime
(
t
, 0);

77 
Time¡amp
 
äomUnixTime
(
time_t
 
t
, 
miüo£cÚds
)

79  
Time¡amp
(
¡©ic_ÿ¡
<
št64_t
>(
t
è* 
kMiüoSecÚdsP”SecÚd
 + 
miüo£cÚds
);

82 cÚ¡ 
	gkMiüoSecÚdsP”SecÚd
 = 1000 * 1000;

84 
	g´iv©e
:

85 
št64_t
 
miüoSecÚdsSšûEpoch_
;

88 
šlše
 
boŞ
 
	gİ”©Ü
<(
Time¡amp
 
	glhs
, Time¡am°
	grhs
)

90  
	glhs
.
miüoSecÚdsSšûEpoch
(è< 
	grhs
.microSecondsSinceEpoch();

93 
šlše
 
boŞ
 
	gİ”©Ü
==(
Time¡amp
 
lhs
, Time¡am°
	grhs
)

95  
	glhs
.
miüoSecÚdsSšûEpoch
(è=ğ
rhs
.microSecondsSinceEpoch();

105 
šlše
 
timeDifã»nû
(
Time¡amp
 
high
, Time¡am°
low
)

107 
št64_t
 
	gdiff
 = 
high
.
miüoSecÚdsSšûEpoch
(è- 
low
.microSecondsSinceEpoch();

108  
	g¡©ic_ÿ¡
<>(
	gdiff
è/ 
	gTime¡amp
::
kMiüoSecÚdsP”SecÚd
;

116 
šlše
 
Time¡amp
 
addTime
(Time¡am°
time¡amp
, 
£cÚds
)

118 
št64_t
 
	gd–
 = 
¡©ic_ÿ¡
<št64_t>(
£cÚds
 * 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
);

119  
Time¡amp
(
time¡amp
.
miüoSecÚdsSšûEpoch
(è+ 
d–
);

	@muduo/base/Timestamp.h

1 #iâdeà
MUDUO_BASE_TIMESTAMP_H


2 
	#MUDUO_BASE_TIMESTAMP_H


	)

4 
	~<muduo/ba£/cİyabË.h
>

5 
	~<muduo/ba£/Ty³s.h
>

7 
	~<boo¡/İ”©Üs.hµ
>

9 
Çme¥aû
 
	gmuduo


21 
şass
 
	gTime¡amp
 : 
public
 
muduo
::
cİyabË
,

22 
public
 
	gboo¡
::
equ®™y_com·¿bË
<
Time¡amp
>,

23 
public
 
	gboo¡
::
Ëss_thª_com·¿bË
<
Time¡amp
>

25 
public
:

29 
Time¡amp
()

30 : 
miüoSecÚdsSšûEpoch_
(0)

38 
ex¶ic™
 
Time¡amp
(
št64_t
 
miüoSecÚdsSšûEpochArg
)

39 : 
miüoSecÚdsSšûEpoch_
(
miüoSecÚdsSšûEpochArg
)

43 
sw­
(
Time¡amp
& 
th©
)

45 
¡d
::
sw­
(
miüoSecÚdsSšûEpoch_
, 
th©
.microSecondsSinceEpoch_);

50 
¡ršg
 
toSŒšg
() const;

51 
¡ršg
 
toFÜm©‹dSŒšg
(
boŞ
 
showMiüo£cÚds
 = 
Œue
) const;

54 
boŞ
 
v®id
(ècÚ¡ {  
	gmiüoSecÚdsSšûEpoch_
 > 0; }

57 
št64_t
 
miüoSecÚdsSšûEpoch
(ècÚ¡ {  
	gmiüoSecÚdsSšûEpoch_
; }

58 
time_t
 
£cÚdsSšûEpoch
() const

59 {  
	g¡©ic_ÿ¡
<
	gtime_t
>(
	gmiüoSecÚdsSšûEpoch_
 / 
	gkMiüoSecÚdsP”SecÚd
); }

65 
Time¡amp
 
now
();

67 
Time¡amp
 
šv®id
()

69  
Time¡amp
();

72 
Time¡amp
 
äomUnixTime
(
time_t
 
t
)

74  
äomUnixTime
(
t
, 0);

77 
Time¡amp
 
äomUnixTime
(
time_t
 
t
, 
miüo£cÚds
)

79  
Time¡amp
(
¡©ic_ÿ¡
<
št64_t
>(
t
è* 
kMiüoSecÚdsP”SecÚd
 + 
miüo£cÚds
);

82 cÚ¡ 
	gkMiüoSecÚdsP”SecÚd
 = 1000 * 1000;

84 
	g´iv©e
:

85 
št64_t
 
miüoSecÚdsSšûEpoch_
;

88 
šlše
 
boŞ
 
	gİ”©Ü
<(
Time¡amp
 
	glhs
, Time¡am°
	grhs
)

90  
	glhs
.
miüoSecÚdsSšûEpoch
(è< 
	grhs
.microSecondsSinceEpoch();

93 
šlše
 
boŞ
 
	gİ”©Ü
==(
Time¡amp
 
lhs
, Time¡am°
	grhs
)

95  
	glhs
.
miüoSecÚdsSšûEpoch
(è=ğ
rhs
.microSecondsSinceEpoch();

105 
šlše
 
timeDifã»nû
(
Time¡amp
 
high
, Time¡am°
low
)

107 
št64_t
 
	gdiff
 = 
high
.
miüoSecÚdsSšûEpoch
(è- 
low
.microSecondsSinceEpoch();

108  
	g¡©ic_ÿ¡
<>(
	gdiff
è/ 
	gTime¡amp
::
kMiüoSecÚdsP”SecÚd
;

116 
šlše
 
Time¡amp
 
addTime
(Time¡am°
time¡amp
, 
£cÚds
)

118 
št64_t
 
	gd–
 = 
¡©ic_ÿ¡
<št64_t>(
£cÚds
 * 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
);

119  
Time¡amp
(
time¡amp
.
miüoSecÚdsSšûEpoch
(è+ 
d–
);

	@muduo/base/Types.h

1 #iâdeà
MUDUO_BASE_TYPES_H


2 
	#MUDUO_BASE_TYPES_H


	)

4 
	~<¡dšt.h
>

5 #ifdeà
MUDUO_STD_STRING


6 
	~<¡ršg
>

8 
	~<ext/v¡ršg.h
>

9 
	~<ext/v¡ršg_fwd.h
>

12 #iâdeà
NDEBUG


13 
	~<as£¹.h
>

19 
Çme¥aû
 
	gmuduo


22 #ifdeà
MUDUO_STD_STRING


23 
usšg
 
	g¡d
::
¡ršg
;

25 
	g__gnu_cxx
::
	t__sso_¡ršg
 
	t¡ršg
;

82 
	g‹m¶©e
<
ty³Çme
 
	gTo
,y³Çm
	gFrom
>

83 
šlše
 
To
 
im¶ic™_ÿ¡
(
From
 cÚ¡ &
f
)

85  
	gf
;

106 
	g‹m¶©e
<
ty³Çme
 
	gTo
,y³Çm
	gFrom
>

107 
šlše
 
To
 
down_ÿ¡
(
From
* 
f
)

113 ià(
	gçl£
)

115 
	gim¶ic™_ÿ¡
<
	gFrom
*, 
	gTo
>(0);

118 #ià!
defšed
(
NDEBUG
è&& !defšed(
GOOGLE_PROTOBUF_NO_RTTI
)

119 
as£¹
(
f
 =ğ
NULL
 || 
dyÇmic_ÿ¡
<
To
>(f) != NULL);

121  
	g¡©ic_ÿ¡
<
	gTo
>(
	gf
);

	@muduo/base/Types.h

1 #iâdeà
MUDUO_BASE_TYPES_H


2 
	#MUDUO_BASE_TYPES_H


	)

4 
	~<¡dšt.h
>

5 #ifdeà
MUDUO_STD_STRING


6 
	~<¡ršg
>

8 
	~<ext/v¡ršg.h
>

9 
	~<ext/v¡ršg_fwd.h
>

12 #iâdeà
NDEBUG


13 
	~<as£¹.h
>

19 
Çme¥aû
 
	gmuduo


22 #ifdeà
MUDUO_STD_STRING


23 
usšg
 
	g¡d
::
¡ršg
;

25 
	g__gnu_cxx
::
	t__sso_¡ršg
 
	t¡ršg
;

82 
	g‹m¶©e
<
ty³Çme
 
	gTo
,y³Çm
	gFrom
>

83 
šlše
 
To
 
im¶ic™_ÿ¡
(
From
 cÚ¡ &
f
)

85  
	gf
;

106 
	g‹m¶©e
<
ty³Çme
 
	gTo
,y³Çm
	gFrom
>

107 
šlše
 
To
 
down_ÿ¡
(
From
* 
f
)

113 ià(
	gçl£
)

115 
	gim¶ic™_ÿ¡
<
	gFrom
*, 
	gTo
>(0);

118 #ià!
defšed
(
NDEBUG
è&& !defšed(
GOOGLE_PROTOBUF_NO_RTTI
)

119 
as£¹
(
f
 =ğ
NULL
 || 
dyÇmic_ÿ¡
<
To
>(f) != NULL);

121  
	g¡©ic_ÿ¡
<
	gTo
>(
	gf
);

	@muduo/base/WeakCallback.h

9 #iâdeà
MUDUO_BASE_WEAKCALLBACK_H


10 
	#MUDUO_BASE_WEAKCALLBACK_H


	)

12 
	~<funùiÚ®
>

13 
	~<boo¡/funùiÚ.hµ
>

14 
	~<boo¡/sh¬ed_±r.hµ
>

16 
Çme¥aû
 
	gmuduo


21 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


25 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
, 
	gty³Çme
... 
	gARGS
>

26 şas 
	cW—kC®lback


28 
	gpublic
:

30 
W—kC®lback
(cÚ¡ 
boo¡
::
w—k_±r
<
CLASS
>& 
objeù
,

31 cÚ¡ 
¡d
::
funùiÚ
<(
CLASS
*, 
ARGS
...)>& function)

32 : 
objeù_
(
objeù
), 
funùiÚ_
(
funùiÚ
)

38 
İ”©Ü
()(
	gARGS
&&... 
	g¬gs
) const

40 
	gboo¡
::
sh¬ed_±r
<
CLASS
> 
±r
(
objeù_
.
lock
());

41 ià(
	g±r
)

43 
funùiÚ_
(
±r
.
g‘
(), 
¡d
::
fÜw¬d
<
ARGS
>(
¬gs
)...);

51 
	g´iv©e
:

53 
boo¡
::
w—k_±r
<
CLASS
> 
objeù_
;

54 
	g¡d
::
funùiÚ
<(
CLASS
*, 
	gARGS
...)> 
	gfunùiÚ_
;

57 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
, 
	gty³Çme
... 
	gARGS
>

58 
	gW—kC®lback
<
	gCLASS
, 
	gARGS
...> 
makeW—kC®lback
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
CLASS
>& 
objeù
,

59 (
CLASS
::*
funùiÚ
)(
ARGS
...))

61  
W—kC®lback
<
CLASS
, 
	gARGS
...>(
	gobjeù
, 
	gfunùiÚ
);

64 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
, 
	gty³Çme
... 
	gARGS
>

65 
	gW—kC®lback
<
	gCLASS
, 
	gARGS
...> 
makeW—kC®lback
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
CLASS
>& 
objeù
,

66 (
CLASS
::*
funùiÚ
)(
ARGS
...) const)

68  
W—kC®lback
<
CLASS
, 
	gARGS
...>(
	gobjeù
, 
	gfunùiÚ
);

75 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
>

76 şas 
	cW—kC®lback


78 
	gpublic
:

80 
W—kC®lback
(cÚ¡ 
boo¡
::
w—k_±r
<
CLASS
>& 
objeù
,

81 cÚ¡ 
boo¡
::
funùiÚ
<(
CLASS
*)>& function)

82 : 
objeù_
(
objeù
), 
funùiÚ_
(
funùiÚ
)

88 
İ”©Ü
()() const

90 
	gboo¡
::
sh¬ed_±r
<
CLASS
> 
±r
(
objeù_
.
lock
());

91 ià(
	g±r
)

93 
funùiÚ_
(
±r
.
g‘
());

101 
	g´iv©e
:

103 
boo¡
::
w—k_±r
<
CLASS
> 
objeù_
;

104 
	gboo¡
::
funùiÚ
<(
CLASS
*)> 
funùiÚ_
;

107 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
>

108 
	gW—kC®lback
<
	gCLASS
> 
makeW—kC®lback
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
CLASS
>& 
objeù
,

109 (
CLASS
::*
funùiÚ
)())

111  
W—kC®lback
<
CLASS
>(
objeù
, 
	gfunùiÚ
);

114 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
>

115 
	gW—kC®lback
<
	gCLASS
> 
makeW—kC®lback
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
CLASS
>& 
objeù
,

116 (
CLASS
::*
funùiÚ
)() const)

118  
W—kC®lback
<
CLASS
>(
objeù
, 
	gfunùiÚ
);

	@muduo/base/WeakCallback.h

9 #iâdeà
MUDUO_BASE_WEAKCALLBACK_H


10 
	#MUDUO_BASE_WEAKCALLBACK_H


	)

12 
	~<funùiÚ®
>

13 
	~<boo¡/funùiÚ.hµ
>

14 
	~<boo¡/sh¬ed_±r.hµ
>

16 
Çme¥aû
 
	gmuduo


21 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


25 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
, 
	gty³Çme
... 
	gARGS
>

26 şas 
	cW—kC®lback


28 
	gpublic
:

30 
W—kC®lback
(cÚ¡ 
boo¡
::
w—k_±r
<
CLASS
>& 
objeù
,

31 cÚ¡ 
¡d
::
funùiÚ
<(
CLASS
*, 
ARGS
...)>& function)

32 : 
objeù_
(
objeù
), 
funùiÚ_
(
funùiÚ
)

38 
İ”©Ü
()(
	gARGS
&&... 
	g¬gs
) const

40 
	gboo¡
::
sh¬ed_±r
<
CLASS
> 
±r
(
objeù_
.
lock
());

41 ià(
	g±r
)

43 
funùiÚ_
(
±r
.
g‘
(), 
¡d
::
fÜw¬d
<
ARGS
>(
¬gs
)...);

51 
	g´iv©e
:

53 
boo¡
::
w—k_±r
<
CLASS
> 
objeù_
;

54 
	g¡d
::
funùiÚ
<(
CLASS
*, 
	gARGS
...)> 
	gfunùiÚ_
;

57 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
, 
	gty³Çme
... 
	gARGS
>

58 
	gW—kC®lback
<
	gCLASS
, 
	gARGS
...> 
makeW—kC®lback
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
CLASS
>& 
objeù
,

59 (
CLASS
::*
funùiÚ
)(
ARGS
...))

61  
W—kC®lback
<
CLASS
, 
	gARGS
...>(
	gobjeù
, 
	gfunùiÚ
);

64 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
, 
	gty³Çme
... 
	gARGS
>

65 
	gW—kC®lback
<
	gCLASS
, 
	gARGS
...> 
makeW—kC®lback
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
CLASS
>& 
objeù
,

66 (
CLASS
::*
funùiÚ
)(
ARGS
...) const)

68  
W—kC®lback
<
CLASS
, 
	gARGS
...>(
	gobjeù
, 
	gfunùiÚ
);

75 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
>

76 şas 
	cW—kC®lback


78 
	gpublic
:

80 
W—kC®lback
(cÚ¡ 
boo¡
::
w—k_±r
<
CLASS
>& 
objeù
,

81 cÚ¡ 
boo¡
::
funùiÚ
<(
CLASS
*)>& function)

82 : 
objeù_
(
objeù
), 
funùiÚ_
(
funùiÚ
)

88 
İ”©Ü
()() const

90 
	gboo¡
::
sh¬ed_±r
<
CLASS
> 
±r
(
objeù_
.
lock
());

91 ià(
	g±r
)

93 
funùiÚ_
(
±r
.
g‘
());

101 
	g´iv©e
:

103 
boo¡
::
w—k_±r
<
CLASS
> 
objeù_
;

104 
	gboo¡
::
funùiÚ
<(
CLASS
*)> 
funùiÚ_
;

107 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
>

108 
	gW—kC®lback
<
	gCLASS
> 
makeW—kC®lback
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
CLASS
>& 
objeù
,

109 (
CLASS
::*
funùiÚ
)())

111  
W—kC®lback
<
CLASS
>(
objeù
, 
	gfunùiÚ
);

114 
	g‹m¶©e
<
ty³Çme
 
	gCLASS
>

115 
	gW—kC®lback
<
	gCLASS
> 
makeW—kC®lback
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
CLASS
>& 
objeù
,

116 (
CLASS
::*
funùiÚ
)() const)

118  
W—kC®lback
<
CLASS
>(
objeù
, 
	gfunùiÚ
);

	@muduo/base/copyable.h

1 #iâdeà
MUDUO_BASE_COPYABLE_H


2 
	#MUDUO_BASE_COPYABLE_H


	)

4 
Çme¥aû
 
	gmuduo


10 şas 
	ccİyabË


	@muduo/base/copyable.h

1 #iâdeà
MUDUO_BASE_COPYABLE_H


2 
	#MUDUO_BASE_COPYABLE_H


	)

4 
Çme¥aû
 
	gmuduo


10 şas 
	ccİyabË


	@muduo/base/tests/AsyncLogging_test.cc

1 
	~<muduo/ba£/AsyncLoggšg.h
>

2 
	~<muduo/ba£/Loggšg.h
>

3 
	~<muduo/ba£/Time¡amp.h
>

5 
	~<¡dio.h
>

6 
	~<sys/»sourû.h
>

7 
	~<uni¡d.h
>

9 
	gkRŞlSize
 = 500*1000*1000;

11 
	gmuduo
::
AsyncLoggšg
* 
g_asyncLog
 = 
NULL
;

13 
	$asyncOuut
(cÚ¡ * 
msg
, 
Ën
)

15 
g_asyncLog
->
	`­³nd
(
msg
, 
Ën
);

16 
	}
}

18 
	$b’ch
(
boŞ
 
lÚgLog
)

20 
muduo
::
Logg”
::
	`£tOuut
(
asyncOuut
);

22 
út
 = 0;

23 cÚ¡ 
kB©ch
 = 1000;

24 
muduo
::
¡ršg
 
em±y
 = " ";

25 
muduo
::
¡ršg
 
	`lÚgSŒ
(3000, 'X');

26 
lÚgSŒ
 += " ";

28 
t
 = 0; < 30; ++t)

30 
muduo
::
Time¡amp
 
¡¬t
 = muduo::Time¡amp::
	`now
();

31 
i
 = 0; i < 
kB©ch
; ++i)

33 
LOG_INFO
 << "Hello 0123456789" << "‡bcdefghijklmnopqrstuvwxyz "

34 << (
lÚgLog
 ? 
lÚgSŒ
 : 
em±y
)

35 << 
út
;

36 ++
út
;

38 
muduo
::
Time¡amp
 
’d
 = muduo::Time¡amp::
	`now
();

39 
	`´štf
("%f\n", 
	`timeDifã»nû
(
’d
, 
¡¬t
)*1000000/
kB©ch
);

40 
time¥ec
 
ts
 = { 0, 500*1000*1000 };

41 
	`Çno¦“p
(&
ts
, 
NULL
);

43 
	}
}

45 
	$maš
(
¬gc
, * 
¬gv
[])

49 
size_t
 
kOÃGB
 = 1000*1024*1024;

50 
¾im™
 
¾
 = { 2*
kOÃGB
, 2*kOneGB };

51 
	`£Œlim™
(
RLIMIT_AS
, &
¾
);

54 
	`´štf
("pid = %d\n", 
	`g‘pid
());

56 
Çme
[256];

57 
	`¡ºıy
(
Çme
, 
¬gv
[0], 256);

58 
muduo
::
AsyncLoggšg
 
	`log
(::
	`ba£Çme
(
Çme
), 
kRŞlSize
);

59 
log
.
	`¡¬t
();

60 
g_asyncLog
 = &
log
;

62 
boŞ
 
lÚgLog
 = 
¬gc
 > 1;

63 
	`b’ch
(
lÚgLog
);

64 
	}
}

	@muduo/base/tests/Atomic_unittest.cc

1 
	~<muduo/ba£/Atomic.h
>

2 
	~<as£¹.h
>

4 
	$maš
()

7 
muduo
::
AtomicIÁ64
 
a0
;

8 
	`as£¹
(
a0
.
	`g‘
() == 0);

9 
	`as£¹
(
a0
.
	`g‘AndAdd
(1) == 0);

10 
	`as£¹
(
a0
.
	`g‘
() == 1);

11 
	`as£¹
(
a0
.
	`addAndG‘
(2) == 3);

12 
	`as£¹
(
a0
.
	`g‘
() == 3);

13 
	`as£¹
(
a0
.
	`šüem’tAndG‘
() == 4);

14 
	`as£¹
(
a0
.
	`g‘
() == 4);

15 
a0
.
	`šüem’t
();

16 
	`as£¹
(
a0
.
	`g‘
() == 5);

17 
	`as£¹
(
a0
.
	`addAndG‘
(-3) == 2);

18 
	`as£¹
(
a0
.
	`g‘AndS‘
(100) == 2);

19 
	`as£¹
(
a0
.
	`g‘
() == 100);

23 
muduo
::
AtomicIÁ32
 
a1
;

24 
	`as£¹
(
a1
.
	`g‘
() == 0);

25 
	`as£¹
(
a1
.
	`g‘AndAdd
(1) == 0);

26 
	`as£¹
(
a1
.
	`g‘
() == 1);

27 
	`as£¹
(
a1
.
	`addAndG‘
(2) == 3);

28 
	`as£¹
(
a1
.
	`g‘
() == 3);

29 
	`as£¹
(
a1
.
	`šüem’tAndG‘
() == 4);

30 
	`as£¹
(
a1
.
	`g‘
() == 4);

31 
a1
.
	`šüem’t
();

32 
	`as£¹
(
a1
.
	`g‘
() == 5);

33 
	`as£¹
(
a1
.
	`addAndG‘
(-3) == 2);

34 
	`as£¹
(
a1
.
	`g‘AndS‘
(100) == 2);

35 
	`as£¹
(
a1
.
	`g‘
() == 100);

37 
	}
}

	@muduo/base/tests/BlockingQueue_bench.cc

1 
	~<muduo/ba£/BlockšgQueue.h
>

2 
	~<muduo/ba£/CouÁDownL©ch.h
>

3 
	~<muduo/ba£/Th»ad.h
>

4 
	~<muduo/ba£/Time¡amp.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

8 
	~<m­
>

9 
	~<¡ršg
>

10 
	~<¡dio.h
>

11 
	~<uni¡d.h
>

13 şas 
	cB’ch


15 
	mpublic
:

16 
	$B’ch
(
numTh»ads
)

17 : 
	`Ïtch_
(
numTh»ads
),

18 
	$th»ads_
(
numTh»ads
)

20 
i
 = 0; i < 
numTh»ads
; ++i)

22 
Çme
[32];

23 
	`¢´štf
(
Çme
, ‚ame, "wÜkh»ad %d", 
i
);

24 
th»ads_
.
	`push_back
(
Ãw
 
muduo
::
	`Th»ad
(

25 
boo¡
::
	`bšd
(&
B’ch
::
th»adFunc
, 
this
), 
muduo
::
	`¡ršg
(
Çme
)));

27 
	`fÜ_—ch
(
th»ads_
.
	`begš
(),h»ads_.
	`’d
(), 
boo¡
::
	`bšd
(&
muduo
::
Th»ad
::
¡¬t
, 
_1
));

30 
	$run
(
times
)

32 
	`´štf
("waiting for count down†atch\n");

33 
Ïtch_
.
	`wa™
();

34 
	`´štf
("allhreads started\n");

35 
i
 = 0; i < 
times
; ++i)

37 
muduo
::
Time¡amp
 
	`now
(muduo::Timestamp::now());

38 
queue_
.
	`put
(
now
);

39 
	`u¦“p
(1000);

41 
	}
}

43 
	$jošAÎ
()

45 
size_t
 
i
 = 0; i < 
th»ads_
.
	`size
(); ++i)

47 
queue_
.
	`put
(
muduo
::
Time¡amp
::
	`šv®id
());

50 
	`fÜ_—ch
(
th»ads_
.
	`begš
(),h»ads_.
	`’d
(), 
boo¡
::
	`bšd
(&
muduo
::
Th»ad
::
još
, 
_1
));

51 
	}
}

53 
	g´iv©e
:

55 
	$th»adFunc
()

57 
	`´štf
("tid=%d, %s started\n",

58 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

59 
muduo
::
Cu¼’tTh»ad
::
	`Çme
());

61 
¡d
::
m­
<, > 
d–ays
;

62 
Ïtch_
.
	`couÁDown
();

63 
boŞ
 
ruÂšg
 = 
Œue
;

64 
ruÂšg
)

66 
muduo
::
Time¡amp
 
	`t
(
queue_
.
	`ke
());

67 
muduo
::
Time¡amp
 
	`now
(muduo::Timestamp::now());

68 ià(
t
.
	`v®id
())

70 
d–ay
 = 
¡©ic_ÿ¡
<>(
	`timeDifã»nû
(
now
, 
t
) * 1000000);

73 ++
d–ays
[
d–ay
];

75 
ruÂšg
 = 
t
.
	`v®id
();

78 
	`´štf
("tid=%d, %s stopped\n",

79 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

80 
muduo
::
Cu¼’tTh»ad
::
	`Çme
());

81 
¡d
::
m­
<, >::
™”©Ü
 
™
 = 
d–ays
.
	`begš
();

82 
™
 !ğ
d–ays
.
	`’d
(); ++it)

84 
	`´štf
("tid = %d, delay = %d, count = %d\n",

85 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

86 
™
->
fœ¡
, it->
£cÚd
);

88 
	}
}

90 
	gmuduo
::
BlockšgQueue
<
muduo
::
Time¡amp
> 
queue_
;

91 
	gmuduo
::
CouÁDownL©ch
 
Ïtch_
;

92 
	gboo¡
::
±r_veùÜ
<
muduo
::
Th»ad
> 
th»ads_
;

95 
	$maš
(
¬gc
, * 
¬gv
[])

97 
th»ads
 = 
¬gc
 > 1 ? 
	`©oi
(
¬gv
[1]) : 1;

99 
B’ch
 
	`t
(
th»ads
);

100 
t
.
	`run
(10000);

101 
t
.
	`jošAÎ
();

102 
	}
}

	@muduo/base/tests/BlockingQueue_test.cc

1 
	~<muduo/ba£/BlockšgQueue.h
>

2 
	~<muduo/ba£/CouÁDownL©ch.h
>

3 
	~<muduo/ba£/Th»ad.h
>

5 
	~<boo¡/bšd.hµ
>

6 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

7 
	~<memÜy
>

8 
	~<¡ršg
>

9 
	~<¡dio.h
>

10 
	~<uni¡d.h
>

12 şas 
	cTe¡


14 
	mpublic
:

15 
	$Te¡
(
numTh»ads
)

16 : 
	`Ïtch_
(
numTh»ads
),

17 
	$th»ads_
(
numTh»ads
)

19 
i
 = 0; i < 
numTh»ads
; ++i)

21 
Çme
[32];

22 
	`¢´štf
(
Çme
, ‚ame, "wÜkh»ad %d", 
i
);

23 
th»ads_
.
	`push_back
(
Ãw
 
muduo
::
	`Th»ad
(

24 
boo¡
::
	`bšd
(&
Te¡
::
th»adFunc
, 
this
), 
muduo
::
	`¡ršg
(
Çme
)));

26 
	`fÜ_—ch
(
th»ads_
.
	`begš
(),h»ads_.
	`’d
(), 
boo¡
::
	`bšd
(&
muduo
::
Th»ad
::
¡¬t
, 
_1
));

29 
	$run
(
times
)

31 
	`´štf
("waiting for count down†atch\n");

32 
Ïtch_
.
	`wa™
();

33 
	`´štf
("allhreads started\n");

34 
i
 = 0; i < 
times
; ++i)

36 
buf
[32];

37 
	`¢´štf
(
buf
,  buf, "h–lØ%d", 
i
);

38 
queue_
.
	`put
(
buf
);

39 
	`´štf
("tid=%d,…uˆd©¨ğ%s, sizğ%zd\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
buf
, 
queue_
.
	`size
());

41 
	}
}

43 
	$jošAÎ
()

45 
size_t
 
i
 = 0; i < 
th»ads_
.
	`size
(); ++i)

47 
queue_
.
	`put
("stop");

50 
	`fÜ_—ch
(
th»ads_
.
	`begš
(),h»ads_.
	`’d
(), 
boo¡
::
	`bšd
(&
muduo
::
Th»ad
::
još
, 
_1
));

51 
	}
}

53 
	g´iv©e
:

55 
	$th»adFunc
()

57 
	`´štf
("tid=%d, %s started\n",

58 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

59 
muduo
::
Cu¼’tTh»ad
::
	`Çme
());

61 
Ïtch_
.
	`couÁDown
();

62 
boŞ
 
ruÂšg
 = 
Œue
;

63 
ruÂšg
)

65 
¡d
::
¡ršg
 
	`d
(
queue_
.
	`ke
());

66 
	`´štf
("tid=%d, g‘ d©¨ğ%s, sizğ%zd\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
d
.
	`c_¡r
(), 
queue_
.
	`size
());

67 
ruÂšg
 = (
d
 != "stop");

70 
	`´štf
("tid=%d, %s stopped\n",

71 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

72 
muduo
::
Cu¼’tTh»ad
::
	`Çme
());

73 
	}
}

75 
	gmuduo
::
BlockšgQueue
<
¡d
::
¡ršg
> 
queue_
;

76 
	gmuduo
::
CouÁDownL©ch
 
Ïtch_
;

77 
	gboo¡
::
±r_veùÜ
<
muduo
::
Th»ad
> 
th»ads_
;

80 
	$‹¡Move
()

82 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


85 #ià
	`__GNUC_PREREQ
 (4,4)

86 
muduo
::
BlockšgQueue
<
¡d
::
unique_±r
<>> 
queue
;

87 
queue
.
	`put
(
¡d
::
unique_±r
<>(
Ãw
 (42)));

88 
¡d
::
unique_±r
<> 
x
 = 
queue
.
	`ke
();

89 
	`´štf
("took %d\n", *
x
);

90 *
x
 = 123;

91 
queue
.
	`put
(
¡d
::
	`move
(
x
));

92 
¡d
::
unique_±r
<> 
y
 = 
queue
.
	`ke
();

93 
	`´štf
("took %d\n", *
y
);

97 
	}
}

99 
	$maš
()

101 
	`´štf
("pid=%d,id=%d\n", ::
	`g‘pid
(), 
muduo
::
Cu¼’tTh»ad
::
	`tid
());

102 
Te¡
 
	`t
(5);

103 
t
.
	`run
(100);

104 
t
.
	`jošAÎ
();

106 
	`‹¡Move
();

108 
	`´štf
("numb” oàü—‹dh»ad %d\n", 
muduo
::
Th»ad
::
	`numC»©ed
());

109 
	}
}

	@muduo/base/tests/BoundedBlockingQueue_test.cc

1 
	~<muduo/ba£/BoundedBlockšgQueue.h
>

2 
	~<muduo/ba£/CouÁDownL©ch.h
>

3 
	~<muduo/ba£/Th»ad.h
>

5 
	~<boo¡/bšd.hµ
>

6 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

7 
	~<¡ršg
>

8 
	~<veùÜ
>

10 
	~<¡dio.h
>

11 
	~<uni¡d.h
>

13 şas 
	cTe¡


15 
	mpublic
:

16 
	$Te¡
(
numTh»ads
)

17 : 
	`queue_
(20),

18 
	`Ïtch_
(
numTh»ads
),

19 
	$th»ads_
(
numTh»ads
)

21 
i
 = 0; i < 
numTh»ads
; ++i)

23 
Çme
[32];

24 
	`¢´štf
(
Çme
, ‚ame, "wÜkh»ad %d", 
i
);

25 
th»ads_
.
	`push_back
(
Ãw
 
muduo
::
	`Th»ad
(

26 
boo¡
::
	`bšd
(&
Te¡
::
th»adFunc
, 
this
), 
muduo
::
	`¡ršg
(
Çme
)));

28 
	`fÜ_—ch
(
th»ads_
.
	`begš
(),h»ads_.
	`’d
(), 
boo¡
::
	`bšd
(&
muduo
::
Th»ad
::
¡¬t
, 
_1
));

31 
	$run
(
times
)

33 
	`´štf
("waiting for count down†atch\n");

34 
Ïtch_
.
	`wa™
();

35 
	`´štf
("allhreads started\n");

36 
i
 = 0; i < 
times
; ++i)

38 
buf
[32];

39 
	`¢´štf
(
buf
,  buf, "h–lØ%d", 
i
);

40 
queue_
.
	`put
(
buf
);

41 
	`´štf
("tid=%d,…uˆd©¨ğ%s, sizğ%zd\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
buf
, 
queue_
.
	`size
());

43 
	}
}

45 
	$jošAÎ
()

47 
size_t
 
i
 = 0; i < 
th»ads_
.
	`size
(); ++i)

49 
queue_
.
	`put
("stop");

52 
	`fÜ_—ch
(
th»ads_
.
	`begš
(),h»ads_.
	`’d
(), 
boo¡
::
	`bšd
(&
muduo
::
Th»ad
::
još
, 
_1
));

53 
	}
}

55 
	g´iv©e
:

57 
	$th»adFunc
()

59 
	`´štf
("tid=%d, %s started\n",

60 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

61 
muduo
::
Cu¼’tTh»ad
::
	`Çme
());

63 
Ïtch_
.
	`couÁDown
();

64 
boŞ
 
ruÂšg
 = 
Œue
;

65 
ruÂšg
)

67 
¡d
::
¡ršg
 
	`d
(
queue_
.
	`ke
());

68 
	`´štf
("tid=%d, g‘ d©¨ğ%s, sizğ%zd\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
d
.
	`c_¡r
(), 
queue_
.
	`size
());

69 
ruÂšg
 = (
d
 != "stop");

72 
	`´štf
("tid=%d, %s stopped\n",

73 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

74 
muduo
::
Cu¼’tTh»ad
::
	`Çme
());

75 
	}
}

77 
	gmuduo
::
BoundedBlockšgQueue
<
¡d
::
¡ršg
> 
queue_
;

78 
	gmuduo
::
CouÁDownL©ch
 
Ïtch_
;

79 
	gboo¡
::
±r_veùÜ
<
muduo
::
Th»ad
> 
th»ads_
;

82 
	$maš
()

84 
	`´štf
("pid=%d,id=%d\n", ::
	`g‘pid
(), 
muduo
::
Cu¼’tTh»ad
::
	`tid
());

85 
Te¡
 
	`t
(5);

86 
t
.
	`run
(100);

87 
t
.
	`jošAÎ
();

89 
	`´štf
("numb” oàü—‹dh»ad %d\n", 
muduo
::
Th»ad
::
	`numC»©ed
());

90 
	}
}

	@muduo/base/tests/Date_unittest.cc

1 
	~<muduo/ba£/D©e.h
>

2 
	~<as£¹.h
>

3 
	~<¡dio.h
>

5 
usšg
 
	gmuduo
::
D©e
;

7 cÚ¡ 
	gkMÚthsOfY—r
 = 12;

9 
	$isL—pY—r
(
y—r
)

11 ià(
y—r
 % 400 == 0)

13 ià(
y—r
 % 100 == 0)

15 ià(
y—r
 % 4 == 0)

19 
	}
}

21 
	$daysOfMÚth
(
y—r
, 
mÚth
)

23 
days
[2][
kMÚthsOfY—r
+1] =

28  
days
[
	`isL—pY—r
(
y—r
)][
mÚth
];

29 
	}
}

31 
	$·ssByCÚ¡Reã»nû
(cÚ¡ 
D©e
& 
x
)

33 
	`´štf
("%s\n", 
x
.
	`toIsoSŒšg
().
	`c_¡r
());

34 
	}
}

36 
	$·ssByV®ue
(
D©e
 
x
)

38 
	`´štf
("%s\n", 
x
.
	`toIsoSŒšg
().
	`c_¡r
());

39 
	}
}

41 
	$maš
()

43 
time_t
 
now
 = 
	`time
(
NULL
);

44 
tm
 
t1
 = *
	`gmtime
(&
now
);

45 
tm
 
t2
 = *
	`loÿÉime
(&
now
);

46 
D©e
 
	`someDay
(2008, 9, 10);

47 
	`´štf
("%s\n", 
someDay
.
	`toIsoSŒšg
().
	`c_¡r
());

48 
	`·ssByV®ue
(
someDay
);

49 
	`·ssByCÚ¡Reã»nû
(
someDay
);

50 
D©e
 
	`todayUtc
(
t1
);

51 
	`´štf
("%s\n", 
todayUtc
.
	`toIsoSŒšg
().
	`c_¡r
());

52 
D©e
 
	`todayLoÿl
(
t2
);

53 
	`´štf
("%s\n", 
todayLoÿl
.
	`toIsoSŒšg
().
	`c_¡r
());

55 
julŸnDayNumb”
 = 2415021;

56 
w“kDay
 = 1;

58 
y—r
 = 1900; year < 2500; ++year)

60 
	`as£¹
(
	`D©e
(
y—r
, 3, 1).
	`julŸnDayNumb”
() - Date(year, 2, 29).julianDayNumber()

61 =ğ
	`isL—pY—r
(
y—r
));

62 
mÚth
 = 1; mÚth <ğ
kMÚthsOfY—r
; ++month)

64 
day
 = 1; day <ğ
	`daysOfMÚth
(
y—r
, 
mÚth
); ++day)

66 
D©e
 
	`d
(
y—r
, 
mÚth
, 
day
);

68 
	`as£¹
(
y—r
 =ğ
d
.
	`y—r
());

69 
	`as£¹
(
mÚth
 =ğ
d
.
	`mÚth
());

70 
	`as£¹
(
day
 =ğ
d
.
	`day
());

71 
	`as£¹
(
w“kDay
 =ğ
d
.
	`w“kDay
());

72 
	`as£¹
(
julŸnDayNumb”
 =ğ
d
.
	`julŸnDayNumb”
());

74 
D©e
 
	`d2
(
julŸnDayNumb”
);

75 
	`as£¹
(
y—r
 =ğ
d2
.
	`y—r
());

76 
	`as£¹
(
mÚth
 =ğ
d2
.
	`mÚth
());

77 
	`as£¹
(
day
 =ğ
d2
.
	`day
());

78 
	`as£¹
(
w“kDay
 =ğ
d2
.
	`w“kDay
());

79 
	`as£¹
(
julŸnDayNumb”
 =ğ
d2
.
	`julŸnDayNumb”
());

81 ++
julŸnDayNumb”
;

82 
w“kDay
 = (weekDay+1) % 7;

86 
	`´štf
("All…assed.\n");

87 
	}
}

	@muduo/base/tests/Exception_test.cc

1 
	~<muduo/ba£/Exû±iÚ.h
>

2 
	~<¡dio.h
>

4 şas 
	cB¬


6 
	mpublic
:

7 
	$‹¡
()

9 
throw
 
muduo
::
	`Exû±iÚ
("oops");

11 
	}
};

13 
	$foo
()

15 
B¬
 
b
;

16 
b
.
	`‹¡
();

17 
	}
}

19 
	$maš
()

21 
Œy


23 
	`foo
();

25 
	`ÿtch
 (cÚ¡ 
muduo
::
Exû±iÚ
& 
ex
)

27 
	`´štf
("»asÚ: %s\n", 
ex
.
	`wh©
());

28 
	`´štf
("¡ack¿û: %s\n", 
ex
.
	`¡ackT¿û
());

30 
	}
}

	@muduo/base/tests/FileUtil_test.cc

1 
	~<muduo/ba£/FeUt.h
>

3 
	~<¡dio.h
>

4 
	#__STDC_FORMAT_MACROS


	)

5 
	~<š‰y³s.h
>

7 
usšg
 
Çme¥aû
 
	gmuduo
;

9 
	$maš
()

11 
¡ršg
 
»suÉ
;

12 
št64_t
 
size
 = 0;

13 
”r
 = 
FeUt
::
	`»adFe
("/´oc/£lf", 1024, &
»suÉ
, &
size
);

14 
	`´štf
("%d %zd %" 
PRIu64
 "\n", 
”r
, 
»suÉ
.
	`size
(), 
size
);

15 
”r
 = 
FeUt
::
	`»adFe
("/´oc/£lf", 1024, &
»suÉ
, 
NULL
);

16 
	`´štf
("%d %zd %" 
PRIu64
 "\n", 
”r
, 
»suÉ
.
	`size
(), 
size
);

17 
”r
 = 
FeUt
::
	`»adFe
("/´oc/£lf/cmdlše", 1024, &
»suÉ
, &
size
);

18 
	`´štf
("%d %zd %" 
PRIu64
 "\n", 
”r
, 
»suÉ
.
	`size
(), 
size
);

19 
”r
 = 
FeUt
::
	`»adFe
("/dev/nuÎ", 1024, &
»suÉ
, &
size
);

20 
	`´štf
("%d %zd %" 
PRIu64
 "\n", 
”r
, 
»suÉ
.
	`size
(), 
size
);

21 
”r
 = 
FeUt
::
	`»adFe
("/dev/z”o", 1024, &
»suÉ
, &
size
);

22 
	`´štf
("%d %zd %" 
PRIu64
 "\n", 
”r
, 
»suÉ
.
	`size
(), 
size
);

23 
”r
 = 
FeUt
::
	`»adFe
("/nÙexi¡", 1024, &
»suÉ
, &
size
);

24 
	`´štf
("%d %zd %" 
PRIu64
 "\n", 
”r
, 
»suÉ
.
	`size
(), 
size
);

25 
”r
 = 
FeUt
::
	`»adFe
("/dev/z”o", 102400, &
»suÉ
, &
size
);

26 
	`´štf
("%d %zd %" 
PRIu64
 "\n", 
”r
, 
»suÉ
.
	`size
(), 
size
);

27 
”r
 = 
FeUt
::
	`»adFe
("/dev/z”o", 102400, &
»suÉ
, 
NULL
);

28 
	`´štf
("%d %zd %" 
PRIu64
 "\n", 
”r
, 
»suÉ
.
	`size
(), 
size
);

29 
	}
}

	@muduo/base/tests/Fork_test.cc

1 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

3 
	~<¡dio.h
>

4 
	~<sys/ty³s.h
>

5 
	~<uni¡d.h
>

7 
	gÇme¥aû


9 
__th»ad
 
	gx
 = 0;

12 
	$´št
()

14 
	`´štf
("pid=%did=%d x=%d\n", 
	`g‘pid
(), 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
x
);

15 
	}
}

17 
	$maš
()

19 
	`´štf
("·»Á %d\n", 
	`g‘pid
());

20 
	`´št
();

21 
x
 = 1;

22 
	`´št
();

23 
pid_t
 
p
 = 
	`fÜk
();

25 ià(
p
 == 0)

27 
	`´štf
("chlid %d\n", 
	`g‘pid
());

29 
	`´št
();

30 
x
 = 2;

31 
	`´št
();

33 ià(
	`fÜk
() == 0)

35 
	`´štf
("g¿ndchlid %d\n", 
	`g‘pid
());

36 
	`´št
();

37 
x
 = 3;

38 
	`´št
();

44 
	`´št
();

46 
	}
}

	@muduo/base/tests/GzipFile_test.cc

1 
	~<muduo/ba£/GzFe.h
>

3 
	~<muduo/ba£/Loggšg.h
>

5 
	$maš
()

7 cÚ¡ * 
f’ame
 = "/tmp/gzipfile_test.gz";

8 ::
	`uÆšk
(
f’ame
);

9 cÚ¡ 
d©a
[] = "123456789012345678901234567890123456789012345678901234567890\n";

11 
muduo
::
GzFe
 
wr™”
 = muduo::GzFe::
	`İ’FÜAµ’d
(
f’ame
);

12 ià(
wr™”
.
	`v®id
())

14 
LOG_INFO
 << "‹Î " << 
wr™”
.
	`‹Î
();

15 
LOG_INFO
 << "wrÙ" << 
wr™”
.
	`wr™e
(
d©a
);

16 
LOG_INFO
 << "‹Î " << 
wr™”
.
	`‹Î
();

21 
	`´štf
("testing„eader\n");

22 
muduo
::
GzFe
 
»ad”
 = muduo::GzFe::
	`İ’FÜR—d
(
f’ame
);

23 ià(
»ad”
.
	`v®id
())

25 
buf
[256];

26 
LOG_INFO
 << "‹Î " << 
»ad”
.
	`‹Î
();

27 
Ä
 = 
»ad”
.
	`»ad
(
buf
,  buf);

28 
	`´štf
("»ad %d\n", 
Ä
);

29 ià(
Ä
 >= 0)

31 
buf
[
Ä
] = '\0';

32 
	`´štf
("d©¨%s", 
buf
);

34 
LOG_INFO
 << "‹Î " << 
»ad”
.
	`‹Î
();

35 ià(
	`¡ºcmp
(
buf
, 
d©a
, 
	`¡¾’
(data)) != 0)

37 
	`´štf
("failed!!!\n");

38 
	`abÜt
();

42 
	`´štf
("PASSED\n");

48 
muduo
::
GzFe
 
wr™”
 = muduo::GzFe::
	`İ’FÜWr™eExşusive
(
f’ame
);

49 ià(
wr™”
.
	`v®id
(è|| 
”ºo
 !ğ
EEXIST
)

51 
	`´štf
("FAILED\n");

54 
	}
}

	@muduo/base/tests/LogFile_test.cc

1 
	~<muduo/ba£/LogFe.h
>

2 
	~<muduo/ba£/Loggšg.h
>

4 
	~<uni¡d.h
>

6 
	gboo¡
::
scİed_±r
<
muduo
::
LogFe
> 
g_logFe
;

8 
	$ouutFunc
(cÚ¡ * 
msg
, 
Ën
)

10 
g_logFe
->
	`­³nd
(
msg
, 
Ën
);

11 
	}
}

13 
	$æushFunc
()

15 
g_logFe
->
	`æush
();

16 
	}
}

18 
	$maš
(
¬gc
, * 
¬gv
[])

20 
Çme
[256];

21 
	`¡ºıy
(
Çme
, 
¬gv
[0], 256);

22 
g_logFe
.
	`»£t
(
Ãw
 
muduo
::
	`LogFe
(::
	`ba£Çme
(
Çme
), 200*1000));

23 
muduo
::
Logg”
::
	`£tOuut
(
ouutFunc
);

24 
muduo
::
Logg”
::
	`£tFlush
(
æushFunc
);

26 
muduo
::
¡ršg
 
lše
 = "1234567890‡bcdefghijklmnopqrstuvwxyz ABCDEFGHIJKLMNOPQRSTUVWXYZ ";

28 
i
 = 0; i < 10000; ++i)

30 
LOG_INFO
 << 
lše
 << 
i
;

32 
	`u¦“p
(1000);

34 
	}
}

	@muduo/base/tests/LogStream_bench.cc

1 
	~<muduo/ba£/LogSŒ—m.h
>

2 
	~<muduo/ba£/Time¡amp.h
>

4 
	~<s¡»am
>

5 
	~<¡dio.h
>

6 
	#__STDC_FORMAT_MACROS


	)

7 
	~<š‰y³s.h
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

11 cÚ¡ 
size_t
 
	gN
 = 1000000;

13 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wold-style-cast"

15 
	g‹m¶©e
<
ty³Çme
 
	gT
>

16 
	$b’chPrštf
(cÚ¡ * 
fmt
)

18 
buf
[32];

19 
Time¡amp
 
	`¡¬t
(Time¡amp::
	`now
());

20 
size_t
 
i
 = 0; i < 
N
; ++i)

21 
	`¢´štf
(
buf
,  buf, 
fmt
, (
T
)(
i
));

22 
Time¡amp
 
	`’d
(Time¡amp::
	`now
());

24 
	`´štf
("b’chPrštà%f\n", 
	`timeDifã»nû
(
’d
, 
¡¬t
));

25 
	}
}

27 
	g‹m¶©e
<
ty³Çme
 
	gT
>

28 
	$b’chSŒšgSŒ—m
()

30 
Time¡amp
 
	`¡¬t
(Time¡amp::
	`now
());

31 
¡d
::
o¡ršg¡»am
 
os
;

33 
size_t
 
i
 = 0; i < 
N
; ++i)

35 
os
 << (
T
)(
i
);

36 
os
.
	`£ekp
(0, 
¡d
::
ios_ba£
::
beg
);

38 
Time¡amp
 
	`’d
(Time¡amp::
	`now
());

40 
	`´štf
("b’chSŒšgSŒ—m %f\n", 
	`timeDifã»nû
(
’d
, 
¡¬t
));

41 
	}
}

43 
	g‹m¶©e
<
ty³Çme
 
	gT
>

44 
	$b’chLogSŒ—m
()

46 
Time¡amp
 
	`¡¬t
(Time¡amp::
	`now
());

47 
LogSŒ—m
 
os
;

48 
size_t
 
i
 = 0; i < 
N
; ++i)

50 
os
 << (
T
)(
i
);

51 
os
.
	`»£tBufãr
();

53 
Time¡amp
 
	`’d
(Time¡amp::
	`now
());

55 
	`´štf
("b’chLogSŒ—m %f\n", 
	`timeDifã»nû
(
’d
, 
¡¬t
));

56 
	}
}

58 
	$maš
()

60 
b’chPrštf
<>("%d");

62 
	`puts
("int");

63 
b’chPrštf
<>("%d");

64 
b’chSŒšgSŒ—m
<>();

65 
b’chLogSŒ—m
<>();

67 
	`puts
("double");

68 
b’chPrštf
<>("%.12g");

69 
b’chSŒšgSŒ—m
<>();

70 
b’chLogSŒ—m
<>();

72 
	`puts
("int64_t");

73 
b’chPrštf
<
št64_t
>("%" 
PRId64
);

74 
b’chSŒšgSŒ—m
<
št64_t
>();

75 
b’chLogSŒ—m
<
št64_t
>();

77 
	`puts
("void*");

78 
b’chPrštf
<*>("%p");

79 
b’chSŒšgSŒ—m
<*>();

80 
b’chLogSŒ—m
<*>();

82 
	}
}

	@muduo/base/tests/LogStream_test.cc

1 
	~<muduo/ba£/LogSŒ—m.h
>

3 
	~<lim™s
>

4 
	~<¡dšt.h
>

7 
	#BOOST_TEST_MAIN


	)

8 
	#BOOST_TEST_DYN_LINK


	)

9 
	~<boo¡/‹¡/un™_‹¡.hµ
>

11 
usšg
 
	gmuduo
::
¡ršg
;

13 
	$BOOST_AUTO_TEST_CASE
(
‹¡LogSŒ—mBoŞ—ns
)

15 
muduo
::
LogSŒ—m
 
os
;

16 cÚ¡ 
muduo
::
LogSŒ—m
::
Bufãr
& 
buf
 = 
os
.
	`bufãr
();

17 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
(""));

18 
os
 << 
Œue
;

19 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("1"));

20 
os
 << '\n';

21 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("1\n"));

22 
os
 << 
çl£
;

23 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("1\n0"));

24 
	}
}

26 
	$BOOST_AUTO_TEST_CASE
(
‹¡LogSŒ—mIÁeg”s
)

28 
muduo
::
LogSŒ—m
 
os
;

29 cÚ¡ 
muduo
::
LogSŒ—m
::
Bufãr
& 
buf
 = 
os
.
	`bufãr
();

30 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
(""));

31 
os
 << 1;

32 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("1"));

33 
os
 << 0;

34 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("10"));

35 
os
 << -1;

36 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("10-1"));

37 
os
.
	`»£tBufãr
();

39 
os
 << 0 << " " << 123 << 'x' << 0x64;

40 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0 123x100"));

41 
	}
}

43 
	$BOOST_AUTO_TEST_CASE
(
‹¡LogSŒ—mIÁeg”Lim™s
)

45 
muduo
::
LogSŒ—m
 
os
;

46 cÚ¡ 
muduo
::
LogSŒ—m
::
Bufãr
& 
buf
 = 
os
.
	`bufãr
();

47 
os
 << -2147483647;

48 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("-2147483647"));

49 
os
 << 
¡©ic_ÿ¡
<>(-2147483647 - 1);

50 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("-2147483647-2147483648"));

51 
os
 << ' ';

52 
os
 << 2147483647;

53 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("-2147483647-2147483648 2147483647"));

54 
os
.
	`»£tBufãr
();

56 
os
 << 
¡d
::
num”ic_lim™s
<
št16_t
>::
	`mš
();

57 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("-32768"));

58 
os
.
	`»£tBufãr
();

60 
os
 << 
¡d
::
num”ic_lim™s
<
št16_t
>::
	`max
();

61 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("32767"));

62 
os
.
	`»£tBufãr
();

64 
os
 << 
¡d
::
num”ic_lim™s
<
ušt16_t
>::
	`mš
();

65 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0"));

66 
os
.
	`»£tBufãr
();

68 
os
 << 
¡d
::
num”ic_lim™s
<
ušt16_t
>::
	`max
();

69 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("65535"));

70 
os
.
	`»£tBufãr
();

72 
os
 << 
¡d
::
num”ic_lim™s
<
št32_t
>::
	`mš
();

73 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("-2147483648"));

74 
os
.
	`»£tBufãr
();

76 
os
 << 
¡d
::
num”ic_lim™s
<
št32_t
>::
	`max
();

77 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("2147483647"));

78 
os
.
	`»£tBufãr
();

80 
os
 << 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`mš
();

81 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0"));

82 
os
.
	`»£tBufãr
();

84 
os
 << 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`max
();

85 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("4294967295"));

86 
os
.
	`»£tBufãr
();

88 
os
 << 
¡d
::
num”ic_lim™s
<
št64_t
>::
	`mš
();

89 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("-9223372036854775808"));

90 
os
.
	`»£tBufãr
();

92 
os
 << 
¡d
::
num”ic_lim™s
<
št64_t
>::
	`max
();

93 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("9223372036854775807"));

94 
os
.
	`»£tBufãr
();

96 
os
 << 
¡d
::
num”ic_lim™s
<
ušt64_t
>::
	`mš
();

97 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0"));

98 
os
.
	`»£tBufãr
();

100 
os
 << 
¡d
::
num”ic_lim™s
<
ušt64_t
>::
	`max
();

101 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("18446744073709551615"));

102 
os
.
	`»£tBufãr
();

104 
št16_t
 
a
 = 0;

105 
št32_t
 
b
 = 0;

106 
št64_t
 
c
 = 0;

107 
os
 << 
a
;

108 
os
 << 
b
;

109 
os
 << 
c
;

110 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("000"));

111 
	}
}

113 
	$BOOST_AUTO_TEST_CASE
(
‹¡LogSŒ—mFlßts
)

115 
muduo
::
LogSŒ—m
 
os
;

116 cÚ¡ 
muduo
::
LogSŒ—m
::
Bufãr
& 
buf
 = 
os
.
	`bufãr
();

118 
os
 << 0.0;

119 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0"));

120 
os
.
	`»£tBufãr
();

122 
os
 << 1.0;

123 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("1"));

124 
os
.
	`»£tBufãr
();

126 
os
 << 0.1;

127 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0.1"));

128 
os
.
	`»£tBufãr
();

130 
os
 << 0.05;

131 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0.05"));

132 
os
.
	`»£tBufãr
();

134 
os
 << 0.15;

135 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0.15"));

136 
os
.
	`»£tBufãr
();

138 
a
 = 0.1;

139 
os
 << 
a
;

140 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0.1"));

141 
os
.
	`»£tBufãr
();

143 
b
 = 0.05;

144 
os
 << 
b
;

145 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0.05"));

146 
os
.
	`»£tBufãr
();

148 
c
 = 0.15;

149 
os
 << 
c
;

150 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0.15"));

151 
os
.
	`»£tBufãr
();

153 
os
 << 
a
+
b
;

154 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0.15"));

155 
os
.
	`»£tBufãr
();

157 
	`BOOST_CHECK
(
a
+
b
 !ğ
c
);

159 
os
 << 1.23456789;

160 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("1.23456789"));

161 
os
.
	`»£tBufãr
();

163 
os
 << 1.234567;

164 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("1.234567"));

165 
os
.
	`»£tBufãr
();

167 
os
 << -123.456;

168 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("-123.456"));

169 
os
.
	`»£tBufãr
();

170 
	}
}

172 
	$BOOST_AUTO_TEST_CASE
(
‹¡LogSŒ—mVoid
)

174 
muduo
::
LogSŒ—m
 
os
;

175 cÚ¡ 
muduo
::
LogSŒ—m
::
Bufãr
& 
buf
 = 
os
.
	`bufãr
();

177 
os
 << 
¡©ic_ÿ¡
<*>(0);

178 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0x0"));

179 
os
.
	`»£tBufãr
();

181 
os
 << 
»š‹½»t_ÿ¡
<*>(8888);

182 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("0x22B8"));

183 
os
.
	`»£tBufãr
();

184 
	}
}

186 
	$BOOST_AUTO_TEST_CASE
(
‹¡LogSŒ—mSŒšgs
)

188 
muduo
::
LogSŒ—m
 
os
;

189 cÚ¡ 
muduo
::
LogSŒ—m
::
Bufãr
& 
buf
 = 
os
.
	`bufãr
();

191 
os
 << "Hello ";

192 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("Hello "));

194 
¡ršg
 
ch’shuo
 = "Shuo Chen";

195 
os
 << 
ch’shuo
;

196 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("Hello Shuo Chen"));

197 
	}
}

199 
	$BOOST_AUTO_TEST_CASE
(
‹¡LogSŒ—mFmts
)

201 
muduo
::
LogSŒ—m
 
os
;

202 cÚ¡ 
muduo
::
LogSŒ—m
::
Bufãr
& 
buf
 = 
os
.
	`bufãr
();

204 
os
 << 
muduo
::
	`Fmt
("%4d", 1);

205 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
(" 1"));

206 
os
.
	`»£tBufãr
();

208 
os
 << 
muduo
::
	`Fmt
("%4.2f", 1.2);

209 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("1.20"));

210 
os
.
	`»£tBufãr
();

212 
os
 << 
muduo
::
	`Fmt
("%4.2f", 1.2) << muduo::Fmt("%4d", 43);

213 
	`BOOST_CHECK_EQUAL
(
buf
.
	`toSŒšg
(), 
	`¡ršg
("1.20 43"));

214 
os
.
	`»£tBufãr
();

215 
	}
}

217 
	$BOOST_AUTO_TEST_CASE
(
‹¡LogSŒ—mLÚg
)

219 
muduo
::
LogSŒ—m
 
os
;

220 cÚ¡ 
muduo
::
LogSŒ—m
::
Bufãr
& 
buf
 = 
os
.
	`bufãr
();

221 
i
 = 0; i < 399; ++i)

223 
os
 << "123456789 ";

224 
	`BOOST_CHECK_EQUAL
(
buf
.
	`Ëngth
(), 10*(
i
+1));

225 
	`BOOST_CHECK_EQUAL
(
buf
.
	`ava
(), 4000 - 10*(
i
+1));

228 
os
 << "abcdefghi ";

229 
	`BOOST_CHECK_EQUAL
(
buf
.
	`Ëngth
(), 3990);

230 
	`BOOST_CHECK_EQUAL
(
buf
.
	`ava
(), 10);

232 
os
 << "abcdefghi";

233 
	`BOOST_CHECK_EQUAL
(
buf
.
	`Ëngth
(), 3999);

234 
	`BOOST_CHECK_EQUAL
(
buf
.
	`ava
(), 1);

235 
	}
}

	@muduo/base/tests/Logging_test.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/ba£/LogFe.h
>

3 
	~<muduo/ba£/Th»adPoŞ.h
>

4 
	~<muduo/ba£/TimeZÚe.h
>

6 
	~<¡dio.h
>

7 
	~<uni¡d.h
>

9 
	gg_tÙ®
;

10 
FILE
* 
	gg_fe
;

11 
	gboo¡
::
scİed_±r
<
muduo
::
LogFe
> 
g_logFe
;

13 
	$dummyOuut
(cÚ¡ * 
msg
, 
Ën
)

15 
g_tÙ®
 +ğ
Ën
;

16 ià(
g_fe
)

18 
	`fwr™e
(
msg
, 1, 
Ën
, 
g_fe
);

20 ià(
g_logFe
)

22 
g_logFe
->
	`­³nd
(
msg
, 
Ën
);

24 
	}
}

26 
	$b’ch
(cÚ¡ * 
ty³
)

28 
muduo
::
Logg”
::
	`£tOuut
(
dummyOuut
);

29 
muduo
::
Time¡amp
 
	`¡¬t
(muduo::Time¡amp::
	`now
());

30 
g_tÙ®
 = 0;

32 
n
 = 1000*1000;

33 cÚ¡ 
boŞ
 
kLÚgLog
 = 
çl£
;

34 
muduo
::
¡ršg
 
em±y
 = " ";

35 
muduo
::
¡ršg
 
	`lÚgSŒ
(3000, 'X');

36 
lÚgSŒ
 += " ";

37 
i
 = 0; i < 
n
; ++i)

39 
LOG_INFO
 << "Hello 0123456789" << "‡bcdefghijklmnopqrstuvwxyz"

40 << (
kLÚgLog
 ? 
lÚgSŒ
 : 
em±y
)

41 << 
i
;

43 
muduo
::
Time¡amp
 
	`’d
(muduo::Time¡amp::
	`now
());

44 
£cÚds
 = 
	`timeDifã»nû
(
’d
, 
¡¬t
);

45 
	`´štf
("%12s: %f seconds, %d bytes, %10.2f msg/s, %.2f MiB/s\n",

46 
ty³
, 
£cÚds
, 
g_tÙ®
, 
n
 / seconds, g_total / seconds / (1024 * 1024));

47 
	}
}

49 
	$logInTh»ad
()

51 
LOG_INFO
 << "logInThread";

52 
	`u¦“p
(1000);

53 
	}
}

55 
	$maš
()

57 
	`g‘µid
();

59 
muduo
::
Th»adPoŞ
 
	`poŞ
("pool");

60 
poŞ
.
	`¡¬t
(5);

61 
poŞ
.
	`run
(
logInTh»ad
);

62 
poŞ
.
	`run
(
logInTh»ad
);

63 
poŞ
.
	`run
(
logInTh»ad
);

64 
poŞ
.
	`run
(
logInTh»ad
);

65 
poŞ
.
	`run
(
logInTh»ad
);

67 
LOG_TRACE
 << "trace";

68 
LOG_DEBUG
 << "debug";

69 
LOG_INFO
 << "Hello";

70 
LOG_WARN
 << "World";

71 
LOG_ERROR
 << "Error";

72 
LOG_INFO
 << (
muduo
::
Logg”
);

73 
LOG_INFO
 << (
muduo
::
LogSŒ—m
);

74 
LOG_INFO
 << (
muduo
::
Fmt
);

75 
LOG_INFO
 << (
muduo
::
LogSŒ—m
::
Bufãr
);

77 
	`¦“p
(1);

78 
	`b’ch
("nop");

80 
bufãr
[64*1024];

82 
g_fe
 = 
	`fİ’
("/dev/null", "w");

83 
	`£tbufãr
(
g_fe
, 
bufãr
,  buffer);

84 
	`b’ch
("/dev/null");

85 
	`fşo£
(
g_fe
);

87 
g_fe
 = 
	`fİ’
("/tmp/log", "w");

88 
	`£tbufãr
(
g_fe
, 
bufãr
,  buffer);

89 
	`b’ch
("/tmp/log");

90 
	`fşo£
(
g_fe
);

92 
g_fe
 = 
NULL
;

93 
g_logFe
.
	`»£t
(
Ãw
 
muduo
::
	`LogFe
("‹¡_log_¡", 500*1000*1000, 
çl£
));

94 
	`b’ch
("test_log_st");

96 
g_logFe
.
	`»£t
(
Ãw
 
muduo
::
	`LogFe
("‹¡_log_mt", 500*1000*1000, 
Œue
));

97 
	`b’ch
("test_log_mt");

98 
g_logFe
.
	`»£t
();

101 
g_fe
 = 
¡dout
;

102 
	`¦“p
(1);

103 
muduo
::
TimeZÚe
 
	`beijšg
(8*3600, "CST");

104 
muduo
::
Logg”
::
	`£tTimeZÚe
(
beijšg
);

105 
LOG_TRACE
 << "trace CST";

106 
LOG_DEBUG
 << "debug CST";

107 
LOG_INFO
 << "Hello CST";

108 
LOG_WARN
 << "World CST";

109 
LOG_ERROR
 << "Error CST";

111 
	`¦“p
(1);

112 
muduo
::
TimeZÚe
 
	`ÃwyÜk
("/usr/share/zoneinfo/America/New_York");

113 
muduo
::
Logg”
::
	`£tTimeZÚe
(
ÃwyÜk
);

114 
LOG_TRACE
 << "trace NYT";

115 
LOG_DEBUG
 << "debug NYT";

116 
LOG_INFO
 << "Hello NYT";

117 
LOG_WARN
 << "World NYT";

118 
LOG_ERROR
 << "Error NYT";

119 
g_fe
 = 
NULL
;

121 
	`b’ch
("timezone‚op");

122 
	}
}

	@muduo/base/tests/Mutex_test.cc

1 
	~<muduo/ba£/CouÁDownL©ch.h
>

2 
	~<muduo/ba£/Mu‹x.h
>

3 
	~<muduo/ba£/Th»ad.h
>

4 
	~<muduo/ba£/Time¡amp.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

8 
	~<veùÜ
>

9 
	~<¡dio.h
>

11 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
usšg
 
Çme¥aû
 
	g¡d
;

14 
Mu‹xLock
 
	gg_mu‹x
;

15 
	gveùÜ
<> 
	gg_vec
;

16 cÚ¡ 
	gkCouÁ
 = 10*1000*1000;

18 
	$th»adFunc
()

20 
i
 = 0; i < 
kCouÁ
; ++i)

22 
Mu‹xLockGu¬d
 
	`lock
(
g_mu‹x
);

23 
g_vec
.
	`push_back
(
i
);

25 
	}
}

27 
	$foo
(è
	`__©Œibu‹__
 ((
nošlše
));

29 
g_couÁ
 = 0;

30 
	$foo
()

32 
Mu‹xLockGu¬d
 
	`lock
(
g_mu‹x
);

33 ià(!
g_mu‹x
.
	`isLockedByThisTh»ad
())

35 
	`´štf
("FAIL\n");

39 ++
g_couÁ
;

41 
	}
}

43 
	$maš
()

45 
	`MCHECK
(
	`foo
());

46 ià(
g_couÁ
 != 1)

48 
	`´štf
("MCHECK callswice.\n");

49 
	`abÜt
();

52 cÚ¡ 
kMaxTh»ads
 = 8;

53 
g_vec
.
	`»£rve
(
kMaxTh»ads
 * 
kCouÁ
);

55 
Time¡amp
 
	`¡¬t
(Time¡amp::
	`now
());

56 
i
 = 0; i < 
kCouÁ
; ++i)

58 
g_vec
.
	`push_back
(
i
);

61 
	`´štf
("sšgËh»ad w™houˆlock %f\n", 
	`timeDifã»nû
(
Time¡amp
::
	`now
(), 
¡¬t
));

63 
¡¬t
 = 
Time¡amp
::
	`now
();

64 
	`th»adFunc
();

65 
	`´štf
("sšgËh»ad w™h†ock %f\n", 
	`timeDifã»nû
(
Time¡amp
::
	`now
(), 
¡¬t
));

67 
Áh»ads
 = 1;‚th»ad < 
kMaxTh»ads
; ++nthreads)

69 
boo¡
::
±r_veùÜ
<
Th»ad
> 
th»ads
;

70 
g_vec
.
	`ş—r
();

71 
¡¬t
 = 
Time¡amp
::
	`now
();

72 
i
 = 0; i < 
Áh»ads
; ++i)

74 
th»ads
.
	`push_back
(
Ãw
 
	`Th»ad
(&
th»adFunc
));

75 
th»ads
.
	`back
().
	`¡¬t
();

77 
i
 = 0; i < 
Áh»ads
; ++i)

79 
th»ads
[
i
].
	`još
();

81 
	`´štf
("%dh»ad(sèw™h†ock %f\n", 
Áh»ads
, 
	`timeDifã»nû
(
Time¡amp
::
	`now
(), 
¡¬t
));

83 
	}
}

	@muduo/base/tests/ProcessInfo_test.cc

1 
	~<muduo/ba£/ProûssInfo.h
>

2 
	~<¡dio.h
>

3 
	#__STDC_FORMAT_MACROS


	)

4 
	~<š‰y³s.h
>

6 
	$maš
()

8 
	`´štf
("pid = %d\n", 
muduo
::
ProûssInfo
::
	`pid
());

9 
	`´štf
("uid = %d\n", 
muduo
::
ProûssInfo
::
	`uid
());

10 
	`´štf
("euid = %d\n", 
muduo
::
ProûssInfo
::
	`euid
());

11 
	`´štf
("¡¬ˆtimğ%s\n", 
muduo
::
ProûssInfo
::
	`¡¬tTime
().
	`toFÜm©‹dSŒšg
().
	`c_¡r
());

12 
	`´štf
("ho¡Çmğ%s\n", 
muduo
::
ProûssInfo
::
	`ho¡Çme
().
	`c_¡r
());

13 
	`´štf
("İ’ed fe ğ%d\n", 
muduo
::
ProûssInfo
::
	`İ’edFes
());

14 
	`´štf
("th»ad ğ%zd\n", 
muduo
::
ProûssInfo
::
	`th»ads
().
	`size
());

15 
	`´štf
("numh»ad ğ%d\n", 
muduo
::
ProûssInfo
::
	`numTh»ads
());

16 
	`´štf
("¡©u ğ%s\n", 
muduo
::
ProûssInfo
::
	`´ocStus
().
	`c_¡r
());

17 
	}
}

	@muduo/base/tests/SingletonThreadLocal_test.cc

1 
	~<muduo/ba£/SšgËtÚ.h
>

2 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

3 
	~<muduo/ba£/Th»adLoÿl.h
>

4 
	~<muduo/ba£/Th»ad.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<¡dio.h
>

9 
	~<uni¡d.h
>

11 şas 
	cTe¡
 : 
boo¡
::
nÚcİyabË


13 
public
:

14 
	$Te¡
()

16 
	`´štf
("tid=%d, cÚ¡ruùšg %p\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
);

19 ~
	$Te¡
()

21 
	`´štf
("tid=%d, de¡ruùšg %°%s\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
, 
Çme_
.
	`c_¡r
());

22 
	}
}

24 cÚ¡ 
	gmuduo
::
¡ršg
& 
	$Çme
(ècÚ¡ {  
Çme_
; 
	}
}

25 
£tName
(cÚ¡ 
muduo
::
¡ršg
& 
n
è{ 
Çme_
 =‚; }

27 
	g´iv©e
:

28 
muduo
::
¡ršg
 
Çme_
;

31 
	#STL
 
muduo
::
SšgËtÚ
<muduo::
Th»adLoÿl
<
Te¡
> >::
	`š¡ªû
().
	`v®ue
()

	)

33 
	$´št
()

35 
	`´štf
("tid=%d, %p‚ame=%s\n",

36 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

37 &
STL
,

38 
STL
.
	`Çme
().
	`c_¡r
());

39 
	}
}

41 
	$th»adFunc
(cÚ¡ * 
chªgeTo
)

43 
	`´št
();

44 
STL
.
	`£tName
(
chªgeTo
);

45 
	`¦“p
(1);

46 
	`´št
();

47 
	}
}

49 
	$maš
()

51 
STL
.
	`£tName
("main one");

52 
muduo
::
Th»ad
 
	`t1
(
boo¡
::
	`bšd
(
th»adFunc
, "thread1"));

53 
muduo
::
Th»ad
 
	`t2
(
boo¡
::
	`bšd
(
th»adFunc
, "thread2"));

54 
t1
.
	`¡¬t
();

55 
t2
.
	`¡¬t
();

56 
t1
.
	`još
();

57 
	`´št
();

58 
t2
.
	`još
();

59 
	`±h»ad_ex™
(0);

60 
	}
}

	@muduo/base/tests/Singleton_test.cc

1 
	~<muduo/ba£/SšgËtÚ.h
>

2 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

3 
	~<muduo/ba£/Th»ad.h
>

5 
	~<boo¡/nÚcİyabË.hµ
>

6 
	~<¡dio.h
>

8 şas 
	cTe¡
 : 
boo¡
::
nÚcİyabË


10 
public
:

11 
	$Te¡
()

13 
	`´štf
("tid=%d, cÚ¡ruùšg %p\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
);

16 ~
	$Te¡
()

18 
	`´štf
("tid=%d, de¡ruùšg %°%s\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
, 
Çme_
.
	`c_¡r
());

19 
	}
}

21 cÚ¡ 
	gmuduo
::
¡ršg
& 
	$Çme
(ècÚ¡ {  
Çme_
; 
	}
}

22 
£tName
(cÚ¡ 
muduo
::
¡ršg
& 
n
è{ 
Çme_
 =‚; }

24 
	g´iv©e
:

25 
muduo
::
¡ršg
 
Çme_
;

28 şas 
	cTe¡NoDe¡roy
 : 
boo¡
::
nÚcİyabË


30 
public
:

32 
no_de¡roy
();

34 
	$Te¡NoDe¡roy
()

36 
	`´štf
("tid=%d, cÚ¡ruùšg Te¡NoDe¡roy %p\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
);

39 ~
	$Te¡NoDe¡roy
()

41 
	`´štf
("tid=%d, de¡ruùšg Te¡NoDe¡roy %p\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
);

42 
	}
}

45 
	$th»adFunc
()

47 
	`´štf
("tid=%d, %p‚ame=%s\n",

48 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

49 &
muduo
::
SšgËtÚ
<
Te¡
>::
	`š¡ªû
(),

50 
muduo
::
SšgËtÚ
<
Te¡
>::
	`š¡ªû
().
	`Çme
().
	`c_¡r
());

51 
muduo
::
SšgËtÚ
<
Te¡
>::
	`š¡ªû
().
	`£tName
("only one, changed");

52 
	}
}

54 
	$maš
()

56 
muduo
::
SšgËtÚ
<
Te¡
>::
	`š¡ªû
().
	`£tName
("only one");

57 
muduo
::
Th»ad
 
	`t1
(
th»adFunc
);

58 
t1
.
	`¡¬t
();

59 
t1
.
	`još
();

60 
	`´štf
("tid=%d, %p‚ame=%s\n",

61 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

62 &
muduo
::
SšgËtÚ
<
Te¡
>::
	`š¡ªû
(),

63 
muduo
::
SšgËtÚ
<
Te¡
>::
	`š¡ªû
().
	`Çme
().
	`c_¡r
());

64 
muduo
::
SšgËtÚ
<
Te¡NoDe¡roy
>::
	`š¡ªû
();

65 
	`´štf
("w™h v®gršd, you should s“ %zd-by‹ memÜy†—k.\n", (
Te¡NoDe¡roy
));

66 
	}
}

	@muduo/base/tests/ThreadLocalSingleton_test.cc

1 
	~<muduo/ba£/Th»adLoÿlSšgËtÚ.h
>

2 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

3 
	~<muduo/ba£/Th»ad.h
>

5 
	~<boo¡/bšd.hµ
>

6 
	~<boo¡/nÚcİyabË.hµ
>

7 
	~<¡dio.h
>

9 şas 
	cTe¡
 : 
boo¡
::
nÚcİyabË


11 
public
:

12 
	$Te¡
()

14 
	`´štf
("tid=%d, cÚ¡ruùšg %p\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
);

17 ~
	$Te¡
()

19 
	`´štf
("tid=%d, de¡ruùšg %°%s\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
, 
Çme_
.
	`c_¡r
());

20 
	}
}

22 cÚ¡ 
	gmuduo
::
¡ršg
& 
	$Çme
(ècÚ¡ {  
Çme_
; 
	}
}

23 
£tName
(cÚ¡ 
muduo
::
¡ršg
& 
n
è{ 
Çme_
 =‚; }

25 
	g´iv©e
:

26 
muduo
::
¡ršg
 
Çme_
;

29 
	$th»adFunc
(cÚ¡ * 
chªgeTo
)

31 
	`´štf
("tid=%d, %p‚ame=%s\n",

32 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

33 &
muduo
::
Th»adLoÿlSšgËtÚ
<
Te¡
>::
	`š¡ªû
(),

34 
muduo
::
Th»adLoÿlSšgËtÚ
<
Te¡
>::
	`š¡ªû
().
	`Çme
().
	`c_¡r
());

35 
muduo
::
Th»adLoÿlSšgËtÚ
<
Te¡
>::
	`š¡ªû
().
	`£tName
(
chªgeTo
);

36 
	`´štf
("tid=%d, %p‚ame=%s\n",

37 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

38 &
muduo
::
Th»adLoÿlSšgËtÚ
<
Te¡
>::
	`š¡ªû
(),

39 
muduo
::
Th»adLoÿlSšgËtÚ
<
Te¡
>::
	`š¡ªû
().
	`Çme
().
	`c_¡r
());

43 
	}
}

45 
	$maš
()

47 
muduo
::
Th»adLoÿlSšgËtÚ
<
Te¡
>::
	`š¡ªû
().
	`£tName
("main one");

48 
muduo
::
Th»ad
 
	`t1
(
boo¡
::
	`bšd
(
th»adFunc
, "thread1"));

49 
muduo
::
Th»ad
 
	`t2
(
boo¡
::
	`bšd
(
th»adFunc
, "thread2"));

50 
t1
.
	`¡¬t
();

51 
t2
.
	`¡¬t
();

52 
t1
.
	`još
();

53 
	`´štf
("tid=%d, %p‚ame=%s\n",

54 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

55 &
muduo
::
Th»adLoÿlSšgËtÚ
<
Te¡
>::
	`š¡ªû
(),

56 
muduo
::
Th»adLoÿlSšgËtÚ
<
Te¡
>::
	`š¡ªû
().
	`Çme
().
	`c_¡r
());

57 
t2
.
	`još
();

59 
	`±h»ad_ex™
(0);

60 
	}
}

	@muduo/base/tests/ThreadLocal_test.cc

1 
	~<muduo/ba£/Th»adLoÿl.h
>

2 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

3 
	~<muduo/ba£/Th»ad.h
>

5 
	~<boo¡/nÚcİyabË.hµ
>

6 
	~<¡dio.h
>

8 şas 
	cTe¡
 : 
boo¡
::
nÚcİyabË


10 
public
:

11 
	$Te¡
()

13 
	`´štf
("tid=%d, cÚ¡ruùšg %p\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
);

16 ~
	$Te¡
()

18 
	`´štf
("tid=%d, de¡ruùšg %°%s\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
this
, 
Çme_
.
	`c_¡r
());

19 
	}
}

21 cÚ¡ 
	gmuduo
::
¡ršg
& 
	$Çme
(ècÚ¡ {  
Çme_
; 
	}
}

22 
£tName
(cÚ¡ 
muduo
::
¡ršg
& 
n
è{ 
Çme_
 =‚; }

24 
	g´iv©e
:

25 
muduo
::
¡ršg
 
Çme_
;

28 
	gmuduo
::
Th»adLoÿl
<
Te¡
> 
‹¡Obj1
;

29 
	gmuduo
::
Th»adLoÿl
<
Te¡
> 
‹¡Obj2
;

31 
	$´št
()

33 
	`´štf
("tid=%d, obj1 %p‚ame=%s\n",

34 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

35 &
‹¡Obj1
.
	`v®ue
(),

36 
‹¡Obj1
.
	`v®ue
().
	`Çme
().
	`c_¡r
());

37 
	`´štf
("tid=%d, obj2 %p‚ame=%s\n",

38 
muduo
::
Cu¼’tTh»ad
::
	`tid
(),

39 &
‹¡Obj2
.
	`v®ue
(),

40 
‹¡Obj2
.
	`v®ue
().
	`Çme
().
	`c_¡r
());

41 
	}
}

43 
	$th»adFunc
()

45 
	`´št
();

46 
‹¡Obj1
.
	`v®ue
().
	`£tName
("changed 1");

47 
‹¡Obj2
.
	`v®ue
().
	`£tName
("changed 42");

48 
	`´št
();

49 
	}
}

51 
	$maš
()

53 
‹¡Obj1
.
	`v®ue
().
	`£tName
("main one");

54 
	`´št
();

55 
muduo
::
Th»ad
 
	`t1
(
th»adFunc
);

56 
t1
.
	`¡¬t
();

57 
t1
.
	`još
();

58 
‹¡Obj2
.
	`v®ue
().
	`£tName
("mainwo");

59 
	`´št
();

61 
	`±h»ad_ex™
(0);

62 
	}
}

	@muduo/base/tests/ThreadPool_test.cc

1 
	~<muduo/ba£/Th»adPoŞ.h
>

2 
	~<muduo/ba£/CouÁDownL©ch.h
>

3 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

4 
	~<muduo/ba£/Loggšg.h
>

6 
	~<boo¡/bšd.hµ
>

7 
	~<¡dio.h
>

8 
	~<uni¡d.h
>

10 
	$´št
()

12 
	`´štf
("tid=%d\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
());

13 
	}
}

15 
´štSŒšg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
)

17 
LOG_INFO
 << 
¡r
;

18 
u¦“p
(100*1000);

21 
	$‹¡
(
maxSize
)

23 
LOG_WARN
 << "Te¡ Th»adPoŞ w™h max queusizğ" << 
maxSize
;

24 
muduo
::
Th»adPoŞ
 
	`poŞ
("MainThreadPool");

25 
poŞ
.
	`£tMaxQueueSize
(
maxSize
);

26 
poŞ
.
	`¡¬t
(5);

28 
LOG_WARN
 << "Adding";

29 
poŞ
.
	`run
(
´št
);

30 
poŞ
.
	`run
(
´št
);

31 
i
 = 0; i < 100; ++i)

33 
buf
[32];

34 
	`¢´štf
(
buf
,  buf, "sk %d", 
i
);

35 
poŞ
.
	`run
(
boo¡
::
	`bšd
(
´štSŒšg
, 
¡d
::
	`¡ršg
(
buf
)));

37 
LOG_WARN
 << "Done";

39 
muduo
::
CouÁDownL©ch
 
	`Ïtch
(1);

40 
poŞ
.
	`run
(
boo¡
::
	`bšd
(&
muduo
::
CouÁDownL©ch
::
couÁDown
, &
Ïtch
));

41 
Ïtch
.
	`wa™
();

42 
poŞ
.
	`¡İ
();

43 
	}
}

45 
	$maš
()

47 
	`‹¡
(0);

48 
	`‹¡
(1);

49 
	`‹¡
(5);

50 
	`‹¡
(10);

51 
	`‹¡
(50);

52 
	}
}

	@muduo/base/tests/Thread_bench.cc

1 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

2 
	~<muduo/ba£/Mu‹x.h
>

3 
	~<muduo/ba£/Th»ad.h
>

4 
	~<muduo/ba£/Time¡amp.h
>

6 
	~<m­
>

7 
	~<¡ršg
>

8 
	~<boo¡/bšd.hµ
>

9 
	~<¡dio.h
>

10 
	~<sys/wa™.h
>

11 
	~<uni¡d.h
>

13 
	gmuduo
::
Mu‹xLock
 
g_mu‹x
;

14 
	g¡d
::
m­
<, > 
	gg_d–ays
;

16 
	$th»adFunc
()

19 
	}
}

21 
th»adFunc2
(
muduo
::
Time¡amp
 
¡¬t
)

23 
muduo
::
Time¡amp
 
now
(muduo::Timestamp::now());

24 
	gd–ay
 = 
¡©ic_ÿ¡
<>(
timeDifã»nû
(
now
, 
¡¬t
) * 1000000);

25 
	gmuduo
::
Mu‹xLockGu¬d
 
lock
(
g_mu‹x
);

26 ++
	gg_d–ays
[
d–ay
];

29 
	$fÜkB’ch
()

31 
	`¦“p
(10);

32 
muduo
::
Time¡amp
 
	`¡¬t
(muduo::Time¡amp::
	`now
());

33 
kProûs£s
 = 10*1000;

35 
i
 = 0; i < 
kProûs£s
; ++i)

37 
pid_t
 
chd
 = 
	`fÜk
();

38 ià(
chd
 == 0)

40 
	`ex™
(0);

44 
	`wa™pid
(
chd
, 
NULL
, 0);

48 
timeU£d
 = 
	`timeDifã»nû
(
muduo
::
Time¡amp
::
	`now
(), 
¡¬t
);

49 
	`´štf
("´oûs ü—tiÚimu£d %àus\n", 
timeU£d
*1000000/
kProûs£s
);

50 
	`´štf
("numb” oàü—‹d…roûs£ %d\n", 
kProûs£s
);

51 
	}
}

53 
	$maš
(
¬gc
, * 
¬gv
[])

55 
	`´štf
("pid=%d,id=%d\n", ::
	`g‘pid
(), 
muduo
::
Cu¼’tTh»ad
::
	`tid
());

56 
muduo
::
Time¡amp
 
	`¡¬t
(muduo::Time¡amp::
	`now
());

58 
kTh»ads
 = 100*1000;

59 
i
 = 0; i < 
kTh»ads
; ++i)

61 
muduo
::
Th»ad
 
	`t1
(
th»adFunc
);

62 
t1
.
	`¡¬t
();

63 
t1
.
	`još
();

66 
timeU£d
 = 
	`timeDifã»nû
(
muduo
::
Time¡amp
::
	`now
(), 
¡¬t
);

67 
	`´štf
("th»ad c»©iÚim%àus\n", 
timeU£d
*1000000/
kTh»ads
);

68 
	`´štf
("numb” oàü—‹dh»ad %d\n", 
muduo
::
Th»ad
::
	`numC»©ed
());

70 
i
 = 0; i < 
kTh»ads
; ++i)

72 
muduo
::
Time¡amp
 
	`now
(muduo::Timestamp::now());

73 
muduo
::
Th»ad
 
	`t2
(
boo¡
::
	`bšd
(
th»adFunc2
, 
now
));

74 
t2
.
	`¡¬t
();

75 
t2
.
	`još
();

78 
muduo
::
Mu‹xLockGu¬d
 
	`lock
(
g_mu‹x
);

79 
¡d
::
m­
<, >::
™”©Ü
 
™
 = 
g_d–ays
.
	`begš
();

80 
™
 !ğ
g_d–ays
.
	`’d
(); ++it)

82 
	`´štf
("delay = %d, count = %d\n",

83 
™
->
fœ¡
, it->
£cÚd
);

87 
	`fÜkB’ch
();

88 
	}
}

	@muduo/base/tests/Thread_test.cc

1 
	~<muduo/ba£/Th»ad.h
>

2 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

4 
	~<¡ršg
>

5 
	~<boo¡/bšd.hµ
>

6 
	~<¡dio.h
>

7 
	~<uni¡d.h
>

9 
	$my¦“p
(
£cÚds
)

11 
time¥ec
 
t
 = { 
£cÚds
, 0 };

12 
	`Çno¦“p
(&
t
, 
NULL
);

13 
	}
}

15 
	$th»adFunc
()

17 
	`´štf
("tid=%d\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
());

18 
	}
}

20 
	$th»adFunc2
(
x
)

22 
	`´štf
("tid=%d, x=%d\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
x
);

23 
	}
}

25 
	$th»adFunc3
()

27 
	`´štf
("tid=%d\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
());

28 
	`my¦“p
(1);

29 
	}
}

31 şas 
	cFoo


33 
	mpublic
:

34 
ex¶ic™
 
	$Foo
(
x
)

35 : 
	$x_
(
x
)

39 
	$memb”Func
()

41 
	`´štf
("tid=%d, Foo::x_=%f\n", 
muduo
::
Cu¼’tTh»ad
::
	`tid
(), 
x_
);

42 
	}
}

44 
memb”Func2
(cÚ¡ 
¡d
::
¡ršg
& 
‹xt
)

46 
´štf
("tid=%d, Foo::x_=%f,ext=%s\n", 
muduo
::
Cu¼’tTh»ad
::
tid
(), 
x_
, 
‹xt
.
c_¡r
());

49 
	g´iv©e
:

50 
x_
;

53 
	$maš
()

55 
	`´štf
("pid=%d,id=%d\n", ::
	`g‘pid
(), 
muduo
::
Cu¼’tTh»ad
::
	`tid
());

57 
muduo
::
Th»ad
 
	`t1
(
th»adFunc
);

58 
t1
.
	`¡¬t
();

59 
	`´štf
("t1.tid=%d\n", 
t1
.
	`tid
());

60 
t1
.
	`još
();

62 
muduo
::
Th»ad
 
	`t2
(
boo¡
::
	`bšd
(
th»adFunc2
, 42),

64 
t2
.
	`¡¬t
();

65 
	`´štf
("t2.tid=%d\n", 
t2
.
	`tid
());

66 
t2
.
	`još
();

68 
Foo
 
	`foo
(87.53);

69 
muduo
::
Th»ad
 
	`t3
(
boo¡
::
	`bšd
(&
Foo
::
memb”Func
, &
foo
),

71 
t3
.
	`¡¬t
();

72 
t3
.
	`još
();

74 
muduo
::
Th»ad
 
	`t4
(
boo¡
::
	`bšd
(&
Foo
::
memb”Func2
, boo¡::
	`»f
(
foo
), 
¡d
::
	`¡ršg
("Shuo Chen")));

75 
t4
.
	`¡¬t
();

76 
t4
.
	`još
();

79 
muduo
::
Th»ad
 
	`t5
(
th»adFunc3
);

80 
t5
.
	`¡¬t
();

83 
	`my¦“p
(2);

85 
muduo
::
Th»ad
 
	`t6
(
th»adFunc3
);

86 
t6
.
	`¡¬t
();

87 
	`my¦“p
(2);

90 
	`¦“p
(2);

91 
	`´štf
("numb” oàü—‹dh»ad %d\n", 
muduo
::
Th»ad
::
	`numC»©ed
());

92 
	}
}

	@muduo/base/tests/TimeZone_unittest.cc

1 
	~<muduo/ba£/TimeZÚe.h
>

3 
	~<as£¹.h
>

4 
	~<¡dio.h
>

5 
	~<¡ršg.h
>

6 
	~<¡ršgs.h
>

8 
usšg
 
	gmuduo
::
TimeZÚe
;

10 
tm
 
	$g‘Tm
(
y—r
, 
mÚth
, 
day
,

11 
hour
, 
mšu‹
, 
£cÚds
)

13 
tm
 
gmt
;

14 
	`bz”o
(&
gmt
,  gmt);

15 
gmt
.
tm_y—r
 = 
y—r
 - 1900;

16 
gmt
.
tm_mÚ
 = 
mÚth
 - 1;

17 
gmt
.
tm_mday
 = 
day
;

18 
gmt
.
tm_hour
 = 
hour
;

19 
gmt
.
tm_mš
 = 
mšu‹
;

20 
gmt
.
tm_£c
 = 
£cÚds
;

21  
gmt
;

22 
	}
}

24 
tm
 
	$g‘Tm
(cÚ¡ * 
¡r
)

26 
tm
 
gmt
;

27 
	`bz”o
(&
gmt
,  gmt);

28 
	`¡½time
(
¡r
, "%F %T", &
gmt
);

29  
gmt
;

30 
	}
}

32 
time_t
 
	$g‘Gmt
(
y—r
, 
mÚth
, 
day
,

33 
hour
, 
mšu‹
, 
£cÚds
)

35 
tm
 
gmt
 = 
	`g‘Tm
(
y—r
, 
mÚth
, 
day
, 
hour
, 
mšu‹
, 
£cÚds
);

36  
	`timegm
(&
gmt
);

37 
	}
}

39 
time_t
 
	$g‘Gmt
(cÚ¡ * 
¡r
)

41 
tm
 
gmt
 = 
	`g‘Tm
(
¡r
);

42  
	`timegm
(&
gmt
);

43 
	}
}

45 
	sTe¡Ca£


47 cÚ¡ * 
	mgmt
;

48 cÚ¡ * 
	mloÿl
;

49 
boŞ
 
	misd¡
;

52 
	$‹¡
(cÚ¡ 
TimeZÚe
& 
tz
, 
Te¡Ca£
 
tc
)

54 
time_t
 
gmt
 = 
	`g‘Gmt
(
tc
.gmt);

57 
tm
 
loÿl
 = 
tz
.
	`toLoÿlTime
(
gmt
);

58 
buf
[256];

59 
	`¡ráime
(
buf
,  buf, "%F %T%z(%Z)", &
loÿl
);

61 ià(
	`¡rcmp
(
buf
, 
tc
.
loÿl
è!ğ0 ||c.
isd¡
 !ğloÿl.
tm_isd¡
)

63 
	`´štf
("WRONG: ");

65 
	`´štf
("% -> %s\n", 
tc
.
gmt
, 
buf
);

69 
tm
 
loÿl
 = 
	`g‘Tm
(
tc
.local);

70 
loÿl
.
tm_isd¡
 = 
tc
.
isd¡
;

71 
time_t
 
»suÉ
 = 
tz
.
	`äomLoÿlTime
(
loÿl
);

72 ià(
»suÉ
 !ğ
gmt
)

74 
tm
 
loÿl2
 = 
tz
.
	`toLoÿlTime
(
»suÉ
);

75 
buf
[256];

76 
	`¡ráime
(
buf
,  buf, "%F %T%z(%Z)", &
loÿl2
);

78 
	`´štf
("WRONG fromLocalTime: %ld %ld %s\n",

79 
¡©ic_ÿ¡
<>(
gmt
), stic_ÿ¡<>(
»suÉ
), 
buf
);

82 
	}
}

84 
	$‹¡NewYÜk
()

86 
TimeZÚe
 
	`tz
("/usr/share/zoneinfo/America/New_York");

87 
Te¡Ca£
 
ÿ£s
[] =

90 { "2006-03-07 00:00:00", "2006-03-06 19:00:00-0500(EST)", 
çl£
 },

91 { "2006-04-02 06:59:59", "2006-04-02 01:59:59-0500(EST)", 
çl£
 },

92 { "2006-04-02 07:00:00", "2006-04-02 03:00:00-0400(EDT)", 
Œue
 },

93 { "2006-05-01 00:00:00", "2006-04-30 20:00:00-0400(EDT)", 
Œue
 },

94 { "2006-05-02 01:00:00", "2006-05-01 21:00:00-0400(EDT)", 
Œue
 },

95 { "2006-10-21 05:00:00", "2006-10-21 01:00:00-0400(EDT)", 
Œue
 },

96 { "2006-10-29 05:59:59", "2006-10-29 01:59:59-0400(EDT)", 
Œue
 },

97 { "2006-10-29 06:00:00", "2006-10-29 01:00:00-0500(EST)", 
çl£
 },

98 { "2006-10-29 06:59:59", "2006-10-29 01:59:59-0500(EST)", 
çl£
 },

99 { "2006-12-31 06:00:00", "2006-12-31 01:00:00-0500(EST)", 
çl£
 },

100 { "2007-01-01 00:00:00", "2006-12-31 19:00:00-0500(EST)", 
çl£
 },

102 { "2007-03-07 00:00:00", "2007-03-06 19:00:00-0500(EST)", 
çl£
 },

103 { "2007-03-11 06:59:59", "2007-03-11 01:59:59-0500(EST)", 
çl£
 },

104 { "2007-03-11 07:00:00", "2007-03-11 03:00:00-0400(EDT)", 
Œue
 },

105 { "2007-05-01 00:00:00", "2007-04-30 20:00:00-0400(EDT)", 
Œue
 },

106 { "2007-05-02 01:00:00", "2007-05-01 21:00:00-0400(EDT)", 
Œue
 },

107 { "2007-10-31 05:00:00", "2007-10-31 01:00:00-0400(EDT)", 
Œue
 },

108 { "2007-11-04 05:59:59", "2007-11-04 01:59:59-0400(EDT)", 
Œue
 },

109 { "2007-11-04 06:00:00", "2007-11-04 01:00:00-0500(EST)", 
çl£
 },

110 { "2007-11-04 06:59:59", "2007-11-04 01:59:59-0500(EST)", 
çl£
 },

111 { "2007-12-31 06:00:00", "2007-12-31 01:00:00-0500(EST)", 
çl£
 },

112 { "2008-01-01 00:00:00", "2007-12-31 19:00:00-0500(EST)", 
çl£
 },

114 { "2009-03-07 00:00:00", "2009-03-06 19:00:00-0500(EST)", 
çl£
 },

115 { "2009-03-08 06:59:59", "2009-03-08 01:59:59-0500(EST)", 
çl£
 },

116 { "2009-03-08 07:00:00", "2009-03-08 03:00:00-0400(EDT)", 
Œue
 },

117 { "2009-05-01 00:00:00", "2009-04-30 20:00:00-0400(EDT)", 
Œue
 },

118 { "2009-05-02 01:00:00", "2009-05-01 21:00:00-0400(EDT)", 
Œue
 },

119 { "2009-10-31 05:00:00", "2009-10-31 01:00:00-0400(EDT)", 
Œue
 },

120 { "2009-11-01 05:59:59", "2009-11-01 01:59:59-0400(EDT)", 
Œue
 },

121 { "2009-11-01 06:00:00", "2009-11-01 01:00:00-0500(EST)", 
çl£
 },

122 { "2009-11-01 06:59:59", "2009-11-01 01:59:59-0500(EST)", 
çl£
 },

123 { "2009-12-31 06:00:00", "2009-12-31 01:00:00-0500(EST)", 
çl£
 },

124 { "2010-01-01 00:00:00", "2009-12-31 19:00:00-0500(EST)", 
çl£
 },

126 { "2010-03-13 00:00:00", "2010-03-12 19:00:00-0500(EST)", 
çl£
 },

127 { "2010-03-14 06:59:59", "2010-03-14 01:59:59-0500(EST)", 
çl£
 },

128 { "2010-03-14 07:00:00", "2010-03-14 03:00:00-0400(EDT)", 
Œue
 },

129 { "2010-05-01 00:00:00", "2010-04-30 20:00:00-0400(EDT)", 
Œue
 },

130 { "2010-05-02 01:00:00", "2010-05-01 21:00:00-0400(EDT)", 
Œue
 },

131 { "2010-11-06 05:00:00", "2010-11-06 01:00:00-0400(EDT)", 
Œue
 },

132 { "2010-11-07 05:59:59", "2010-11-07 01:59:59-0400(EDT)", 
Œue
 },

133 { "2010-11-07 06:00:00", "2010-11-07 01:00:00-0500(EST)", 
çl£
 },

134 { "2010-11-07 06:59:59", "2010-11-07 01:59:59-0500(EST)", 
çl£
 },

135 { "2010-12-31 06:00:00", "2010-12-31 01:00:00-0500(EST)", 
çl£
 },

136 { "2011-01-01 00:00:00", "2010-12-31 19:00:00-0500(EST)", 
çl£
 },

138 { "2011-03-01 00:00:00", "2011-02-28 19:00:00-0500(EST)", 
çl£
 },

139 { "2011-03-13 06:59:59", "2011-03-13 01:59:59-0500(EST)", 
çl£
 },

140 { "2011-03-13 07:00:00", "2011-03-13 03:00:00-0400(EDT)", 
Œue
 },

141 { "2011-05-01 00:00:00", "2011-04-30 20:00:00-0400(EDT)", 
Œue
 },

142 { "2011-05-02 01:00:00", "2011-05-01 21:00:00-0400(EDT)", 
Œue
 },

143 { "2011-11-06 05:59:59", "2011-11-06 01:59:59-0400(EDT)", 
Œue
 },

144 { "2011-11-06 06:00:00", "2011-11-06 01:00:00-0500(EST)", 
çl£
 },

145 { "2011-11-06 06:59:59", "2011-11-06 01:59:59-0500(EST)", 
çl£
 },

146 { "2011-12-31 06:00:00", "2011-12-31 01:00:00-0500(EST)", 
çl£
 },

147 { "2012-01-01 00:00:00", "2011-12-31 19:00:00-0500(EST)", 
çl£
 },

151 
size_t
 
i
 = 0; i <  
ÿ£s
 /  cases[0]; ++i)

153 
	`‹¡
(
tz
, 
ÿ£s
[
i
]);

155 
	}
}

157 
	$‹¡LÚdÚ
()

159 
TimeZÚe
 
	`tz
("/usr/share/zoneinfo/Europe/London");

160 
Te¡Ca£
 
ÿ£s
[] =

163 { "2011-03-26 00:00:00", "2011-03-26 00:00:00+0000(GMT)", 
çl£
 },

164 { "2011-03-27 00:59:59", "2011-03-27 00:59:59+0000(GMT)", 
çl£
 },

165 { "2011-03-27 01:00:00", "2011-03-27 02:00:00+0100(BST)", 
Œue
 },

166 { "2011-10-30 00:59:59", "2011-10-30 01:59:59+0100(BST)", 
Œue
 },

167 { "2011-10-30 01:00:00", "2011-10-30 01:00:00+0000(GMT)", 
çl£
 },

168 { "2012-10-30 01:59:59", "2012-10-30 01:59:59+0000(GMT)", 
çl£
 },

169 { "2011-12-31 22:00:00", "2011-12-31 22:00:00+0000(GMT)", 
çl£
 },

170 { "2012-01-01 00:00:00", "2012-01-01 00:00:00+0000(GMT)", 
çl£
 },

172 { "2012-03-24 00:00:00", "2012-03-24 00:00:00+0000(GMT)", 
çl£
 },

173 { "2012-03-25 00:59:59", "2012-03-25 00:59:59+0000(GMT)", 
çl£
 },

174 { "2012-03-25 01:00:00", "2012-03-25 02:00:00+0100(BST)", 
Œue
 },

175 { "2012-10-28 00:59:59", "2012-10-28 01:59:59+0100(BST)", 
Œue
 },

176 { "2012-10-28 01:00:00", "2012-10-28 01:00:00+0000(GMT)", 
çl£
 },

177 { "2012-10-28 01:59:59", "2012-10-28 01:59:59+0000(GMT)", 
çl£
 },

178 { "2012-12-31 22:00:00", "2012-12-31 22:00:00+0000(GMT)", 
çl£
 },

179 { "2013-01-01 00:00:00", "2013-01-01 00:00:00+0000(GMT)", 
çl£
 },

183 
size_t
 
i
 = 0; i <  
ÿ£s
 /  cases[0]; ++i)

185 
	`‹¡
(
tz
, 
ÿ£s
[
i
]);

187 
	}
}

189 
	$‹¡HÚgKÚg
()

191 
TimeZÚe
 
	`tz
("/usr/share/zoneinfo/Asia/Hong_Kong");

192 
Te¡Ca£
 
ÿ£s
[] =

195 { "2011-04-03 00:00:00", "2011-04-03 08:00:00+0800(HKT)", 
çl£
},

199 
size_t
 
i
 = 0; i <  
ÿ£s
 /  cases[0]; ++i)

201 
	`‹¡
(
tz
, 
ÿ£s
[
i
]);

203 
	}
}

205 
	$‹¡SydÃy
()

207 
TimeZÚe
 
	`tz
("/usr/share/zoneinfo/Australia/Sydney");

208 
Te¡Ca£
 
ÿ£s
[] =

211 { "2011-01-01 00:00:00", "2011-01-01 11:00:00+1100(EST)", 
Œue
 },

212 { "2011-04-02 15:59:59", "2011-04-03 02:59:59+1100(EST)", 
Œue
 },

213 { "2011-04-02 16:00:00", "2011-04-03 02:00:00+1000(EST)", 
çl£
 },

214 { "2011-04-02 16:59:59", "2011-04-03 02:59:59+1000(EST)", 
çl£
 },

215 { "2011-05-02 01:00:00", "2011-05-02 11:00:00+1000(EST)", 
çl£
 },

216 { "2011-10-01 15:59:59", "2011-10-02 01:59:59+1000(EST)", 
çl£
 },

217 { "2011-10-01 16:00:00", "2011-10-02 03:00:00+1100(EST)", 
Œue
 },

218 { "2011-12-31 22:00:00", "2012-01-01 09:00:00+1100(EST)", 
Œue
 },

222 
size_t
 
i
 = 0; i <  
ÿ£s
 /  cases[0]; ++i)

224 
	`‹¡
(
tz
, 
ÿ£s
[
i
]);

226 
	}
}

228 
	$‹¡Utc
()

230 cÚ¡ 
kRªge
 = 100*1000*1000;

231 
time_t
 
t
 = -
kRªge
; <= kRange; += 11)

233 
tm
* 
t1
 = 
	`gmtime
(&
t
);

234 
tm
 
t2
 = 
TimeZÚe
::
	`toUtcTime
(
t
, 
Œue
);

235 
buf1
[80], 
buf2
[80];

236 
	`¡ráime
(
buf1
,  buf1, "%F %T %u %j", 
t1
);

237 
	`¡ráime
(
buf2
,  buf2, "%F %T %u %j", &
t2
);

238 ià(
	`¡rcmp
(
buf1
, 
buf2
) != 0)

240 
	`´štf
("'%s' !ğ'%s'\n", 
buf1
, 
buf2
);

241 
	`as£¹
(0);

243 
time_t
 
t3
 = 
TimeZÚe
::
	`äomUtcTime
(
t2
);

244 ià(
t
 !ğ
t3
)

246 
	`´štf
("%ld !ğ%ld\n", 
¡©ic_ÿ¡
<>(
t
), stic_ÿ¡<>(
t3
));

247 
	`as£¹
(0);

250 
	}
}

252 
	$‹¡FixedTimezÚe
()

254 
TimeZÚe
 
	`tz
(8*3600, "CST");

255 
Te¡Ca£
 
ÿ£s
[] =

258 { "2014-04-03 00:00:00", "2014-04-03 08:00:00+0800(CST)", 
çl£
},

262 
size_t
 
i
 = 0; i <  
ÿ£s
 /  cases[0]; ++i)

264 
	`‹¡
(
tz
, 
ÿ£s
[
i
]);

266 
	}
}

268 
	$maš
()

270 
	`‹¡NewYÜk
();

271 
	`‹¡LÚdÚ
();

272 
	`‹¡SydÃy
();

273 
	`‹¡HÚgKÚg
();

274 
	`‹¡FixedTimezÚe
();

275 
	`‹¡Utc
();

276 
	}
}

	@muduo/base/tests/Timestamp_unittest.cc

1 
	~<muduo/ba£/Time¡amp.h
>

2 
	~<veùÜ
>

3 
	~<¡dio.h
>

5 
usšg
 
	gmuduo
::
Time¡amp
;

7 
	$·ssByCÚ¡Reã»nû
(cÚ¡ 
Time¡amp
& 
x
)

9 
	`´štf
("%s\n", 
x
.
	`toSŒšg
().
	`c_¡r
());

10 
	}
}

12 
	$·ssByV®ue
(
Time¡amp
 
x
)

14 
	`´štf
("%s\n", 
x
.
	`toSŒšg
().
	`c_¡r
());

15 
	}
}

17 
	$b’chm¬k
()

19 cÚ¡ 
kNumb”
 = 1000*1000;

21 
¡d
::
veùÜ
<
Time¡amp
> 
¡amps
;

22 
¡amps
.
	`»£rve
(
kNumb”
);

23 
i
 = 0; i < 
kNumb”
; ++i)

25 
¡amps
.
	`push_back
(
Time¡amp
::
	`now
());

27 
	`´štf
("%s\n", 
¡amps
.
	`äÚt
().
	`toSŒšg
().
	`c_¡r
());

28 
	`´štf
("%s\n", 
¡amps
.
	`back
().
	`toSŒšg
().
	`c_¡r
());

29 
	`´štf
("%f\n", 
	`timeDifã»nû
(
¡amps
.
	`back
(), smps.
	`äÚt
()));

31 
šüem’ts
[100] = { 0 };

32 
št64_t
 
¡¬t
 = 
¡amps
.
	`äÚt
().
	`miüoSecÚdsSšûEpoch
();

33 
i
 = 1; i < 
kNumb”
; ++i)

35 
št64_t
 
Ãxt
 = 
¡amps
[
i
].
	`miüoSecÚdsSšûEpoch
();

36 
št64_t
 
šc
 = 
Ãxt
 - 
¡¬t
;

37 
¡¬t
 = 
Ãxt
;

38 ià(
šc
 < 0)

40 
	`´štf
("reverse!\n");

42 ià(
šc
 < 100)

44 ++
šüem’ts
[
šc
];

48 
	`´štf
("big g­ %d\n", 
¡©ic_ÿ¡
<>(
šc
));

52 
i
 = 0; i < 100; ++i)

54 
	`´štf
("%2d: %d\n", 
i
, 
šüem’ts
[i]);

56 
	}
}

58 
	$maš
()

60 
Time¡amp
 
	`now
(Timestamp::now());

61 
	`´štf
("%s\n", 
now
.
	`toSŒšg
().
	`c_¡r
());

62 
	`·ssByV®ue
(
now
);

63 
	`·ssByCÚ¡Reã»nû
(
now
);

64 
	`b’chm¬k
();

65 
	}
}

	@muduo/net/Acceptor.cc

9 
	~<muduo/Ãt/Acû±Ü.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/Ãt/Ev’tLoİ.h
>

13 
	~<muduo/Ãt/IÃtAdd»ss.h
>

14 
	~<muduo/Ãt/Sock‘sOps.h
>

16 
	~<boo¡/bšd.hµ
>

18 
	~<”ºo.h
>

19 
	~<fú.h
>

22 
	~<uni¡d.h
>

24 
usšg
 
Çme¥aû
 
	gmuduo
;

25 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

27 
	gAcû±Ü
::
	$Acû±Ü
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, 
boŞ
 
»u£pÜt
)

28 : 
	`loİ_
(
loİ
),

29 
	`acû±Sock‘_
(
sock‘s
::
	`ü—‹NÚblockšgOrD›
(
li¡’Addr
.
	`çmy
())),

30 
	`acû±ChªÃl_
(
loİ
, 
acû±Sock‘_
.
	`fd
()),

31 
	`li¡’nšg_
(
çl£
),

32 
	`idËFd_
(::
	`İ’
("/dev/nuÎ", 
O_RDONLY
 | 
O_CLOEXEC
))

34 
	`as£¹
(
idËFd_
 >= 0);

35 
acû±Sock‘_
.
	`£tReu£Addr
(
Œue
);

36 
acû±Sock‘_
.
	`£tReu£PÜt
(
»u£pÜt
);

37 
acû±Sock‘_
.
	`bšdAdd»ss
(
li¡’Addr
);

38 
acû±ChªÃl_
.
	`£tR—dC®lback
(

39 
boo¡
::
	`bšd
(&
Acû±Ü
::
hªdËR—d
, 
this
));

40 
	}
}

42 
	gAcû±Ü
::~
	$Acû±Ü
()

44 
acû±ChªÃl_
.
	`di§bËAÎ
();

45 
acû±ChªÃl_
.
	`»move
();

46 ::
	`şo£
(
idËFd_
);

47 
	}
}

49 
	gAcû±Ü
::
	$li¡’
()

51 
loİ_
->
	`as£¹InLoİTh»ad
();

52 
li¡’nšg_
 = 
Œue
;

53 
acû±Sock‘_
.
	`li¡’
();

54 
acû±ChªÃl_
.
	`’abËR—dšg
();

55 
	}
}

57 
	gAcû±Ü
::
	$hªdËR—d
()

59 
loİ_
->
	`as£¹InLoİTh»ad
();

60 
IÃtAdd»ss
 
³”Addr
;

62 
cÚnfd
 = 
acû±Sock‘_
.
	`acû±
(&
³”Addr
);

63 ià(
cÚnfd
 >= 0)

67 ià(
ÃwCÚÃùiÚC®lback_
)

69 
	`ÃwCÚÃùiÚC®lback_
(
cÚnfd
, 
³”Addr
);

73 
sock‘s
::
	`şo£
(
cÚnfd
);

78 
LOG_SYSERR
 << "in Acceptor::handleRead";

82 ià(
”ºo
 =ğ
EMFILE
)

84 ::
	`şo£
(
idËFd_
);

85 
idËFd_
 = ::
	`acû±
(
acû±Sock‘_
.
	`fd
(), 
NULL
, NULL);

86 ::
	`şo£
(
idËFd_
);

87 
idËFd_
 = ::
	`İ’
("/dev/nuÎ", 
O_RDONLY
 | 
O_CLOEXEC
);

90 
	}
}

	@muduo/net/Acceptor.h

11 #iâdeà
MUDUO_NET_ACCEPTOR_H


12 
	#MUDUO_NET_ACCEPTOR_H


	)

14 
	~<boo¡/funùiÚ.hµ
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
	~<muduo/Ãt/ChªÃl.h
>

18 
	~<muduo/Ãt/Sock‘.h
>

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


25 
şass
 
	gEv’tLoİ
;

26 
şass
 
	gIÃtAdd»ss
;

31 şas 
	cAcû±Ü
 : 
boo¡
::
nÚcİyabË


33 
public
:

34 
boo¡
::
	tfunùiÚ
<(
	tsockfd
,

35 cÚ¡ 
	tIÃtAdd»ss
&)> 
	tNewCÚÃùiÚC®lback
;

37 
Acû±Ü
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, 
boŞ
 
»u£pÜt
);

38 ~
Acû±Ü
();

40 
£tNewCÚÃùiÚC®lback
(cÚ¡ 
NewCÚÃùiÚC®lback
& 
cb
)

41 { 
	gÃwCÚÃùiÚC®lback_
 = 
cb
; }

43 
boŞ
 
li¡’nšg
(ècÚ¡ {  
	gli¡’nšg_
; }

44 
li¡’
();

46 
	g´iv©e
:

48 
hªdËR—d
();

51 
Ev’tLoİ
* 
	gloİ_
;

53 
Sock‘
 
	gacû±Sock‘_
;

55 
ChªÃl
 
	gacû±ChªÃl_
;

56 
NewCÚÃùiÚC®lback
 
	gÃwCÚÃùiÚC®lback_
;

57 
boŞ
 
	gli¡’nšg_
;

58 
	gidËFd_
;

	@muduo/net/Acceptor.h

11 #iâdeà
MUDUO_NET_ACCEPTOR_H


12 
	#MUDUO_NET_ACCEPTOR_H


	)

14 
	~<boo¡/funùiÚ.hµ
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
	~<muduo/Ãt/ChªÃl.h
>

18 
	~<muduo/Ãt/Sock‘.h
>

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


25 
şass
 
	gEv’tLoİ
;

26 
şass
 
	gIÃtAdd»ss
;

31 şas 
	cAcû±Ü
 : 
boo¡
::
nÚcİyabË


33 
public
:

34 
boo¡
::
	tfunùiÚ
<(
	tsockfd
,

35 cÚ¡ 
	tIÃtAdd»ss
&)> 
	tNewCÚÃùiÚC®lback
;

37 
Acû±Ü
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, 
boŞ
 
»u£pÜt
);

38 ~
Acû±Ü
();

40 
£tNewCÚÃùiÚC®lback
(cÚ¡ 
NewCÚÃùiÚC®lback
& 
cb
)

41 { 
	gÃwCÚÃùiÚC®lback_
 = 
cb
; }

43 
boŞ
 
li¡’nšg
(ècÚ¡ {  
	gli¡’nšg_
; }

44 
li¡’
();

46 
	g´iv©e
:

48 
hªdËR—d
();

51 
Ev’tLoİ
* 
	gloİ_
;

53 
Sock‘
 
	gacû±Sock‘_
;

55 
ChªÃl
 
	gacû±ChªÃl_
;

56 
NewCÚÃùiÚC®lback
 
	gÃwCÚÃùiÚC®lback_
;

57 
boŞ
 
	gli¡’nšg_
;

58 
	gidËFd_
;

	@muduo/net/Buffer.cc

10 
	~<muduo/Ãt/Bufãr.h
>

12 
	~<muduo/Ãt/Sock‘sOps.h
>

14 
	~<”ºo.h
>

15 
	~<sys/uio.h
>

17 
usšg
 
Çme¥aû
 
	gmuduo
;

18 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

20 cÚ¡ 
	gBufãr
::
kCRLF
[] = "\r\n";

22 cÚ¡ 
size_t
 
	gBufãr
::
kCh—pP»³nd
;

23 cÚ¡ 
size_t
 
	gBufãr
::
kIn™ŸlSize
;

25 
ssize_t
 
	gBufãr
::
	$»adFd
(
fd
, * 
§vedE¼no
)

28 
exŒabuf
[65536];

29 
iovec
 
vec
[2];

30 cÚ¡ 
size_t
 
wr™abË
 = 
	`wr™abËBy‹s
();

31 
vec
[0].
iov_ba£
 = 
	`begš
()+
wr™”Index_
;

32 
vec
[0].
iov_Ën
 = 
wr™abË
;

33 
vec
[1].
iov_ba£
 = 
exŒabuf
;

34 
vec
[1].
iov_Ën
 =  
exŒabuf
;

37 cÚ¡ 
iovút
 = (
wr™abË
 <  
exŒabuf
) ? 2 : 1;

38 cÚ¡ 
ssize_t
 
n
 = 
sock‘s
::
	`»adv
(
fd
, 
vec
, 
iovút
);

39 ià(
n
 < 0)

41 *
§vedE¼no
 = 
”ºo
;

43 ià(
im¶ic™_ÿ¡
<
size_t
>(
n
è<ğ
wr™abË
)

45 
wr™”Index_
 +ğ
n
;

49 
wr™”Index_
 = 
bufãr_
.
	`size
();

50 
	`­³nd
(
exŒabuf
, 
n
 - 
wr™abË
);

56  
n
;

57 
	}
}

	@muduo/net/Buffer.h

11 #iâdeà
MUDUO_NET_BUFFER_H


12 
	#MUDUO_NET_BUFFER_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

15 
	~<muduo/ba£/SŒšgP›û.h
>

16 
	~<muduo/ba£/Ty³s.h
>

18 
	~<muduo/Ãt/EndŸn.h
>

20 
	~<®gÜ™hm
>

21 
	~<veùÜ
>

23 
	~<as£¹.h
>

24 
	~<¡ršg.h
>

27 
Çme¥aû
 
	gmuduo


29 
Çme¥aû
 
	gÃt


42 şas 
	cBufãr
 : 
public
 
muduo
::
cİyabË


44 
public
:

45 cÚ¡ 
size_t
 
kCh—pP»³nd
 = 8;

46 cÚ¡ 
size_t
 
	gkIn™ŸlSize
 = 1024;

48 
ex¶ic™
 
Bufãr
(
size_t
 
š™ŸlSize
 = 
kIn™ŸlSize
)

49 : 
bufãr_
(
kCh—pP»³nd
 + 
š™ŸlSize
),

50 
»ad”Index_
(
kCh—pP»³nd
),

51 
wr™”Index_
(
kCh—pP»³nd
)

53 
as£¹
(
»adabËBy‹s
() == 0);

54 
as£¹
(
wr™abËBy‹s
(è=ğ
š™ŸlSize
);

55 
as£¹
(
´•’dabËBy‹s
(è=ğ
kCh—pP»³nd
);

61 
sw­
(
Bufãr
& 
rhs
)

63 
	gbufãr_
.
sw­
(
rhs
.
bufãr_
);

64 
	g¡d
::
sw­
(
»ad”Index_
, 
rhs
.readerIndex_);

65 
	g¡d
::
sw­
(
wr™”Index_
, 
rhs
.writerIndex_);

68 
size_t
 
»adabËBy‹s
() const

69 {  
	gwr™”Index_
 - 
	g»ad”Index_
; }

71 
size_t
 
wr™abËBy‹s
() const

72 {  
	gbufãr_
.
size
(è- 
	gwr™”Index_
; }

74 
size_t
 
´•’dabËBy‹s
() const

75 {  
	g»ad”Index_
; }

77 cÚ¡ * 
³ek
() const

78 {  
begš
(è+ 
	g»ad”Index_
; }

80 cÚ¡ * 
fšdCRLF
() const

83 cÚ¡ * 
	gülf
 = 
¡d
::
£¬ch
(
³ek
(), 
begšWr™e
(), 
kCRLF
, kCRLF+2);

84  
	gülf
 =ğ
begšWr™e
(è? 
NULL
 : 
ülf
;

87 cÚ¡ * 
fšdCRLF
(cÚ¡ * 
¡¬t
) const

89 
as£¹
(
³ek
(è<ğ
¡¬t
);

90 
as£¹
(
¡¬t
 <ğ
begšWr™e
());

92 cÚ¡ * 
	gülf
 = 
¡d
::
£¬ch
(
¡¬t
, 
begšWr™e
(), 
kCRLF
, kCRLF+2);

93  
	gülf
 =ğ
begšWr™e
(è? 
NULL
 : 
ülf
;

96 cÚ¡ * 
fšdEOL
() const

98 cÚ¡ * 
	geŞ
 = 
memchr
(
³ek
(), '\n', 
»adabËBy‹s
());

99  
	g¡©ic_ÿ¡
<cÚ¡ *>(
	geŞ
);

102 cÚ¡ * 
fšdEOL
(cÚ¡ * 
¡¬t
) const

104 
as£¹
(
³ek
(è<ğ
¡¬t
);

105 
as£¹
(
¡¬t
 <ğ
begšWr™e
());

106 cÚ¡ * 
	geŞ
 = 
memchr
(
¡¬t
, '\n', 
begšWr™e
() - start);

107  
	g¡©ic_ÿ¡
<cÚ¡ *>(
	geŞ
);

113 
»Œ›ve
(
size_t
 
Ën
)

115 
as£¹
(
Ën
 <ğ
»adabËBy‹s
());

116 ià(
	gËn
 < 
»adabËBy‹s
())

118 
	g»ad”Index_
 +ğ
Ën
;

122 
»Œ›veAÎ
();

126 
»Œ›veUÁ
(cÚ¡ * 
’d
)

128 
as£¹
(
³ek
(è<ğ
’d
);

129 
as£¹
(
’d
 <ğ
begšWr™e
());

130 
»Œ›ve
(
’d
 - 
³ek
());

133 
»Œ›veIÁ64
()

135 
»Œ›ve
((
št64_t
));

138 
»Œ›veIÁ32
()

140 
»Œ›ve
((
št32_t
));

143 
»Œ›veIÁ16
()

145 
»Œ›ve
((
št16_t
));

148 
»Œ›veIÁ8
()

150 
»Œ›ve
((
št8_t
));

153 
»Œ›veAÎ
()

155 
	g»ad”Index_
 = 
kCh—pP»³nd
;

156 
	gwr™”Index_
 = 
kCh—pP»³nd
;

159 
¡ršg
 
»Œ›veAÎAsSŒšg
()

161  
»Œ›veAsSŒšg
(
»adabËBy‹s
());

164 
¡ršg
 
»Œ›veAsSŒšg
(
size_t
 
Ën
)

166 
as£¹
(
Ën
 <ğ
»adabËBy‹s
());

167 
¡ršg
 
»suÉ
(
³ek
(), 
Ën
);

168 
»Œ›ve
(
Ën
);

169  
	g»suÉ
;

172 
SŒšgP›û
 
toSŒšgP›û
() const

174  
SŒšgP›û
(
³ek
(), 
¡©ic_ÿ¡
<>(
»adabËBy‹s
()));

177 
­³nd
(cÚ¡ 
SŒšgP›û
& 
¡r
)

179 
­³nd
(
¡r
.
d©a
(), sŒ.
size
());

182 
­³nd
(cÚ¡ * 
d©a
, 
size_t
 
Ën
)

184 
’su»Wr™abËBy‹s
(
Ën
);

185 
	g¡d
::
cİy
(
d©a
, d©a+
Ën
, 
begšWr™e
());

186 
hasWr™‹n
(
Ën
);

189 
­³nd
(cÚ¡ * 
d©a
, 
size_t
 
Ën
)

191 
­³nd
(
¡©ic_ÿ¡
<cÚ¡ *>(
d©a
), 
Ën
);

194 
’su»Wr™abËBy‹s
(
size_t
 
Ën
)

196 ià(
wr™abËBy‹s
(è< 
	gËn
)

198 
makeS·û
(
Ën
);

200 
as£¹
(
wr™abËBy‹s
(è>ğ
Ën
);

203 * 
begšWr™e
()

204 {  
begš
(è+ 
	gwr™”Index_
; }

206 cÚ¡ * 
begšWr™e
() const

207 {  
begš
(è+ 
	gwr™”Index_
; }

209 
hasWr™‹n
(
size_t
 
Ën
)

211 
as£¹
(
Ën
 <ğ
wr™abËBy‹s
());

212 
	gwr™”Index_
 +ğ
Ën
;

215 
unwr™e
(
size_t
 
Ën
)

217 
as£¹
(
Ën
 <ğ
»adabËBy‹s
());

218 
	gwr™”Index_
 -ğ
Ën
;

224 
­³ndIÁ64
(
št64_t
 
x
)

226 
št64_t
 
	gbe64
 = 
sock‘s
::
ho¡ToN‘wÜk64
(
x
);

227 
­³nd
(&
be64
,  be64);

233 
­³ndIÁ32
(
št32_t
 
x
)

235 
št32_t
 
	gbe32
 = 
sock‘s
::
ho¡ToN‘wÜk32
(
x
);

236 
­³nd
(&
be32
,  be32);

239 
­³ndIÁ16
(
št16_t
 
x
)

241 
št16_t
 
	gbe16
 = 
sock‘s
::
ho¡ToN‘wÜk16
(
x
);

242 
­³nd
(&
be16
,  be16);

245 
­³ndIÁ8
(
št8_t
 
x
)

247 
­³nd
(&
x
,  x);

254 
št64_t
 
»adIÁ64
()

256 
št64_t
 
	g»suÉ
 = 
³ekIÁ64
();

257 
»Œ›veIÁ64
();

258  
	g»suÉ
;

265 
št32_t
 
»adIÁ32
()

267 
št32_t
 
	g»suÉ
 = 
³ekIÁ32
();

268 
»Œ›veIÁ32
();

269  
	g»suÉ
;

272 
št16_t
 
»adIÁ16
()

274 
št16_t
 
	g»suÉ
 = 
³ekIÁ16
();

275 
»Œ›veIÁ16
();

276  
	g»suÉ
;

279 
št8_t
 
»adIÁ8
()

281 
št8_t
 
	g»suÉ
 = 
³ekIÁ8
();

282 
»Œ›veIÁ8
();

283  
	g»suÉ
;

290 
št64_t
 
³ekIÁ64
() const

292 
as£¹
(
»adabËBy‹s
(è>ğ(
št64_t
));

293 
št64_t
 
	gbe64
 = 0;

294 ::
memıy
(&
be64
, 
³ek
(),  be64);

295  
	gsock‘s
::
ÃtwÜkToHo¡64
(
be64
);

302 
št32_t
 
³ekIÁ32
() const

304 
as£¹
(
»adabËBy‹s
(è>ğ(
št32_t
));

305 
št32_t
 
	gbe32
 = 0;

306 ::
memıy
(&
be32
, 
³ek
(),  be32);

307  
	gsock‘s
::
ÃtwÜkToHo¡32
(
be32
);

310 
št16_t
 
³ekIÁ16
() const

312 
as£¹
(
»adabËBy‹s
(è>ğ(
št16_t
));

313 
št16_t
 
	gbe16
 = 0;

314 ::
memıy
(&
be16
, 
³ek
(),  be16);

315  
	gsock‘s
::
ÃtwÜkToHo¡16
(
be16
);

318 
št8_t
 
³ekIÁ8
() const

320 
as£¹
(
»adabËBy‹s
(è>ğ(
št8_t
));

321 
št8_t
 
	gx
 = *
³ek
();

322  
	gx
;

328 
´•’dIÁ64
(
št64_t
 
x
)

330 
št64_t
 
	gbe64
 = 
sock‘s
::
ho¡ToN‘wÜk64
(
x
);

331 
´•’d
(&
be64
,  be64);

337 
´•’dIÁ32
(
št32_t
 
x
)

339 
št32_t
 
	gbe32
 = 
sock‘s
::
ho¡ToN‘wÜk32
(
x
);

340 
´•’d
(&
be32
,  be32);

343 
´•’dIÁ16
(
št16_t
 
x
)

345 
št16_t
 
	gbe16
 = 
sock‘s
::
ho¡ToN‘wÜk16
(
x
);

346 
´•’d
(&
be16
,  be16);

349 
´•’dIÁ8
(
št8_t
 
x
)

351 
´•’d
(&
x
,  x);

354 
´•’d
(cÚ¡ * 
d©a
, 
size_t
 
Ën
)

356 
as£¹
(
Ën
 <ğ
´•’dabËBy‹s
());

357 
	g»ad”Index_
 -ğ
Ën
;

358 cÚ¡ * 
	gd
 = 
¡©ic_ÿ¡
<cÚ¡ *>(
d©a
);

359 
	g¡d
::
cİy
(
d
, d+
Ën
, 
begš
()+
»ad”Index_
);

362 
shršk
(
size_t
 
»£rve
)

365 
Bufãr
 
	gÙh”
;

366 
	gÙh”
.
’su»Wr™abËBy‹s
(
»adabËBy‹s
()+
»£rve
);

367 
	gÙh”
.
­³nd
(
toSŒšgP›û
());

368 
sw­
(
Ùh”
);

371 
size_t
 
š‹º®C­ac™y
() const

373  
	gbufãr_
.
ÿ·c™y
();

380 
ssize_t
 
»adFd
(
fd
, * 
§vedE¼no
);

382 
	g´iv©e
:

384 * 
begš
()

385 {  &*
bufãr_
.
begš
(); }

387 cÚ¡ * 
begš
() const

388 {  &*
	gbufãr_
.
begš
(); }

390 
makeS·û
(
size_t
 
Ën
)

392 ià(
wr™abËBy‹s
(è+ 
´•’dabËBy‹s
(è< 
	gËn
 + 
	gkCh—pP»³nd
)

395 
	gbufãr_
.
»size
(
wr™”Index_
+
Ën
);

400 
as£¹
(
kCh—pP»³nd
 < 
»ad”Index_
);

401 
size_t
 
	g»adabË
 = 
»adabËBy‹s
();

402 
	g¡d
::
cİy
(
begš
()+
»ad”Index_
,

403 
begš
()+
wr™”Index_
,

404 
begš
()+
kCh—pP»³nd
);

405 
	g»ad”Index_
 = 
kCh—pP»³nd
;

406 
	gwr™”Index_
 = 
»ad”Index_
 + 
»adabË
;

407 
as£¹
(
»adabË
 =ğ
»adabËBy‹s
());

411 
	g´iv©e
:

412 
¡d
::
veùÜ
<> 
bufãr_
;

413 
size_t
 
	g»ad”Index_
;

414 
size_t
 
	gwr™”Index_
;

416 cÚ¡ 
	gkCRLF
[];

	@muduo/net/Buffer.h

11 #iâdeà
MUDUO_NET_BUFFER_H


12 
	#MUDUO_NET_BUFFER_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

15 
	~<muduo/ba£/SŒšgP›û.h
>

16 
	~<muduo/ba£/Ty³s.h
>

18 
	~<muduo/Ãt/EndŸn.h
>

20 
	~<®gÜ™hm
>

21 
	~<veùÜ
>

23 
	~<as£¹.h
>

24 
	~<¡ršg.h
>

27 
Çme¥aû
 
	gmuduo


29 
Çme¥aû
 
	gÃt


42 şas 
	cBufãr
 : 
public
 
muduo
::
cİyabË


44 
public
:

45 cÚ¡ 
size_t
 
kCh—pP»³nd
 = 8;

46 cÚ¡ 
size_t
 
	gkIn™ŸlSize
 = 1024;

48 
ex¶ic™
 
Bufãr
(
size_t
 
š™ŸlSize
 = 
kIn™ŸlSize
)

49 : 
bufãr_
(
kCh—pP»³nd
 + 
š™ŸlSize
),

50 
»ad”Index_
(
kCh—pP»³nd
),

51 
wr™”Index_
(
kCh—pP»³nd
)

53 
as£¹
(
»adabËBy‹s
() == 0);

54 
as£¹
(
wr™abËBy‹s
(è=ğ
š™ŸlSize
);

55 
as£¹
(
´•’dabËBy‹s
(è=ğ
kCh—pP»³nd
);

61 
sw­
(
Bufãr
& 
rhs
)

63 
	gbufãr_
.
sw­
(
rhs
.
bufãr_
);

64 
	g¡d
::
sw­
(
»ad”Index_
, 
rhs
.readerIndex_);

65 
	g¡d
::
sw­
(
wr™”Index_
, 
rhs
.writerIndex_);

68 
size_t
 
»adabËBy‹s
() const

69 {  
	gwr™”Index_
 - 
	g»ad”Index_
; }

71 
size_t
 
wr™abËBy‹s
() const

72 {  
	gbufãr_
.
size
(è- 
	gwr™”Index_
; }

74 
size_t
 
´•’dabËBy‹s
() const

75 {  
	g»ad”Index_
; }

77 cÚ¡ * 
³ek
() const

78 {  
begš
(è+ 
	g»ad”Index_
; }

80 cÚ¡ * 
fšdCRLF
() const

83 cÚ¡ * 
	gülf
 = 
¡d
::
£¬ch
(
³ek
(), 
begšWr™e
(), 
kCRLF
, kCRLF+2);

84  
	gülf
 =ğ
begšWr™e
(è? 
NULL
 : 
ülf
;

87 cÚ¡ * 
fšdCRLF
(cÚ¡ * 
¡¬t
) const

89 
as£¹
(
³ek
(è<ğ
¡¬t
);

90 
as£¹
(
¡¬t
 <ğ
begšWr™e
());

92 cÚ¡ * 
	gülf
 = 
¡d
::
£¬ch
(
¡¬t
, 
begšWr™e
(), 
kCRLF
, kCRLF+2);

93  
	gülf
 =ğ
begšWr™e
(è? 
NULL
 : 
ülf
;

96 cÚ¡ * 
fšdEOL
() const

98 cÚ¡ * 
	geŞ
 = 
memchr
(
³ek
(), '\n', 
»adabËBy‹s
());

99  
	g¡©ic_ÿ¡
<cÚ¡ *>(
	geŞ
);

102 cÚ¡ * 
fšdEOL
(cÚ¡ * 
¡¬t
) const

104 
as£¹
(
³ek
(è<ğ
¡¬t
);

105 
as£¹
(
¡¬t
 <ğ
begšWr™e
());

106 cÚ¡ * 
	geŞ
 = 
memchr
(
¡¬t
, '\n', 
begšWr™e
() - start);

107  
	g¡©ic_ÿ¡
<cÚ¡ *>(
	geŞ
);

113 
»Œ›ve
(
size_t
 
Ën
)

115 
as£¹
(
Ën
 <ğ
»adabËBy‹s
());

116 ià(
	gËn
 < 
»adabËBy‹s
())

118 
	g»ad”Index_
 +ğ
Ën
;

122 
»Œ›veAÎ
();

126 
»Œ›veUÁ
(cÚ¡ * 
’d
)

128 
as£¹
(
³ek
(è<ğ
’d
);

129 
as£¹
(
’d
 <ğ
begšWr™e
());

130 
»Œ›ve
(
’d
 - 
³ek
());

133 
»Œ›veIÁ64
()

135 
»Œ›ve
((
št64_t
));

138 
»Œ›veIÁ32
()

140 
»Œ›ve
((
št32_t
));

143 
»Œ›veIÁ16
()

145 
»Œ›ve
((
št16_t
));

148 
»Œ›veIÁ8
()

150 
»Œ›ve
((
št8_t
));

153 
»Œ›veAÎ
()

155 
	g»ad”Index_
 = 
kCh—pP»³nd
;

156 
	gwr™”Index_
 = 
kCh—pP»³nd
;

159 
¡ršg
 
»Œ›veAÎAsSŒšg
()

161  
»Œ›veAsSŒšg
(
»adabËBy‹s
());

164 
¡ršg
 
»Œ›veAsSŒšg
(
size_t
 
Ën
)

166 
as£¹
(
Ën
 <ğ
»adabËBy‹s
());

167 
¡ršg
 
»suÉ
(
³ek
(), 
Ën
);

168 
»Œ›ve
(
Ën
);

169  
	g»suÉ
;

172 
SŒšgP›û
 
toSŒšgP›û
() const

174  
SŒšgP›û
(
³ek
(), 
¡©ic_ÿ¡
<>(
»adabËBy‹s
()));

177 
­³nd
(cÚ¡ 
SŒšgP›û
& 
¡r
)

179 
­³nd
(
¡r
.
d©a
(), sŒ.
size
());

182 
­³nd
(cÚ¡ * 
d©a
, 
size_t
 
Ën
)

184 
’su»Wr™abËBy‹s
(
Ën
);

185 
	g¡d
::
cİy
(
d©a
, d©a+
Ën
, 
begšWr™e
());

186 
hasWr™‹n
(
Ën
);

189 
­³nd
(cÚ¡ * 
d©a
, 
size_t
 
Ën
)

191 
­³nd
(
¡©ic_ÿ¡
<cÚ¡ *>(
d©a
), 
Ën
);

194 
’su»Wr™abËBy‹s
(
size_t
 
Ën
)

196 ià(
wr™abËBy‹s
(è< 
	gËn
)

198 
makeS·û
(
Ën
);

200 
as£¹
(
wr™abËBy‹s
(è>ğ
Ën
);

203 * 
begšWr™e
()

204 {  
begš
(è+ 
	gwr™”Index_
; }

206 cÚ¡ * 
begšWr™e
() const

207 {  
begš
(è+ 
	gwr™”Index_
; }

209 
hasWr™‹n
(
size_t
 
Ën
)

211 
as£¹
(
Ën
 <ğ
wr™abËBy‹s
());

212 
	gwr™”Index_
 +ğ
Ën
;

215 
unwr™e
(
size_t
 
Ën
)

217 
as£¹
(
Ën
 <ğ
»adabËBy‹s
());

218 
	gwr™”Index_
 -ğ
Ën
;

224 
­³ndIÁ64
(
št64_t
 
x
)

226 
št64_t
 
	gbe64
 = 
sock‘s
::
ho¡ToN‘wÜk64
(
x
);

227 
­³nd
(&
be64
,  be64);

233 
­³ndIÁ32
(
št32_t
 
x
)

235 
št32_t
 
	gbe32
 = 
sock‘s
::
ho¡ToN‘wÜk32
(
x
);

236 
­³nd
(&
be32
,  be32);

239 
­³ndIÁ16
(
št16_t
 
x
)

241 
št16_t
 
	gbe16
 = 
sock‘s
::
ho¡ToN‘wÜk16
(
x
);

242 
­³nd
(&
be16
,  be16);

245 
­³ndIÁ8
(
št8_t
 
x
)

247 
­³nd
(&
x
,  x);

254 
št64_t
 
»adIÁ64
()

256 
št64_t
 
	g»suÉ
 = 
³ekIÁ64
();

257 
»Œ›veIÁ64
();

258  
	g»suÉ
;

265 
št32_t
 
»adIÁ32
()

267 
št32_t
 
	g»suÉ
 = 
³ekIÁ32
();

268 
»Œ›veIÁ32
();

269  
	g»suÉ
;

272 
št16_t
 
»adIÁ16
()

274 
št16_t
 
	g»suÉ
 = 
³ekIÁ16
();

275 
»Œ›veIÁ16
();

276  
	g»suÉ
;

279 
št8_t
 
»adIÁ8
()

281 
št8_t
 
	g»suÉ
 = 
³ekIÁ8
();

282 
»Œ›veIÁ8
();

283  
	g»suÉ
;

290 
št64_t
 
³ekIÁ64
() const

292 
as£¹
(
»adabËBy‹s
(è>ğ(
št64_t
));

293 
št64_t
 
	gbe64
 = 0;

294 ::
memıy
(&
be64
, 
³ek
(),  be64);

295  
	gsock‘s
::
ÃtwÜkToHo¡64
(
be64
);

302 
št32_t
 
³ekIÁ32
() const

304 
as£¹
(
»adabËBy‹s
(è>ğ(
št32_t
));

305 
št32_t
 
	gbe32
 = 0;

306 ::
memıy
(&
be32
, 
³ek
(),  be32);

307  
	gsock‘s
::
ÃtwÜkToHo¡32
(
be32
);

310 
št16_t
 
³ekIÁ16
() const

312 
as£¹
(
»adabËBy‹s
(è>ğ(
št16_t
));

313 
št16_t
 
	gbe16
 = 0;

314 ::
memıy
(&
be16
, 
³ek
(),  be16);

315  
	gsock‘s
::
ÃtwÜkToHo¡16
(
be16
);

318 
št8_t
 
³ekIÁ8
() const

320 
as£¹
(
»adabËBy‹s
(è>ğ(
št8_t
));

321 
št8_t
 
	gx
 = *
³ek
();

322  
	gx
;

328 
´•’dIÁ64
(
št64_t
 
x
)

330 
št64_t
 
	gbe64
 = 
sock‘s
::
ho¡ToN‘wÜk64
(
x
);

331 
´•’d
(&
be64
,  be64);

337 
´•’dIÁ32
(
št32_t
 
x
)

339 
št32_t
 
	gbe32
 = 
sock‘s
::
ho¡ToN‘wÜk32
(
x
);

340 
´•’d
(&
be32
,  be32);

343 
´•’dIÁ16
(
št16_t
 
x
)

345 
št16_t
 
	gbe16
 = 
sock‘s
::
ho¡ToN‘wÜk16
(
x
);

346 
´•’d
(&
be16
,  be16);

349 
´•’dIÁ8
(
št8_t
 
x
)

351 
´•’d
(&
x
,  x);

354 
´•’d
(cÚ¡ * 
d©a
, 
size_t
 
Ën
)

356 
as£¹
(
Ën
 <ğ
´•’dabËBy‹s
());

357 
	g»ad”Index_
 -ğ
Ën
;

358 cÚ¡ * 
	gd
 = 
¡©ic_ÿ¡
<cÚ¡ *>(
d©a
);

359 
	g¡d
::
cİy
(
d
, d+
Ën
, 
begš
()+
»ad”Index_
);

362 
shršk
(
size_t
 
»£rve
)

365 
Bufãr
 
	gÙh”
;

366 
	gÙh”
.
’su»Wr™abËBy‹s
(
»adabËBy‹s
()+
»£rve
);

367 
	gÙh”
.
­³nd
(
toSŒšgP›û
());

368 
sw­
(
Ùh”
);

371 
size_t
 
š‹º®C­ac™y
() const

373  
	gbufãr_
.
ÿ·c™y
();

380 
ssize_t
 
»adFd
(
fd
, * 
§vedE¼no
);

382 
	g´iv©e
:

384 * 
begš
()

385 {  &*
bufãr_
.
begš
(); }

387 cÚ¡ * 
begš
() const

388 {  &*
	gbufãr_
.
begš
(); }

390 
makeS·û
(
size_t
 
Ën
)

392 ià(
wr™abËBy‹s
(è+ 
´•’dabËBy‹s
(è< 
	gËn
 + 
	gkCh—pP»³nd
)

395 
	gbufãr_
.
»size
(
wr™”Index_
+
Ën
);

400 
as£¹
(
kCh—pP»³nd
 < 
»ad”Index_
);

401 
size_t
 
	g»adabË
 = 
»adabËBy‹s
();

402 
	g¡d
::
cİy
(
begš
()+
»ad”Index_
,

403 
begš
()+
wr™”Index_
,

404 
begš
()+
kCh—pP»³nd
);

405 
	g»ad”Index_
 = 
kCh—pP»³nd
;

406 
	gwr™”Index_
 = 
»ad”Index_
 + 
»adabË
;

407 
as£¹
(
»adabË
 =ğ
»adabËBy‹s
());

411 
	g´iv©e
:

412 
¡d
::
veùÜ
<> 
bufãr_
;

413 
size_t
 
	g»ad”Index_
;

414 
size_t
 
	gwr™”Index_
;

416 cÚ¡ 
	gkCRLF
[];

	@muduo/net/Callbacks.h

11 #iâdeà
MUDUO_NET_CALLBACKS_H


12 
	#MUDUO_NET_CALLBACKS_H


	)

14 
	~<boo¡/funùiÚ.hµ
>

15 
	~<boo¡/sh¬ed_±r.hµ
>

17 
	~<muduo/ba£/Time¡amp.h
>

19 
Çme¥aû
 
	gmuduo


24 
	g‹m¶©e
<
ty³Çme
 
	gTo
,y³Çm
	gFrom
>

25 
	gšlše
 ::
boo¡
::
sh¬ed_±r
<
To
> 
down_poš‹r_ÿ¡
(cÚ¡ ::boo¡::sh¬ed_±r<
From
>& 
f
)

27 ià(
çl£
)

29 
im¶ic™_ÿ¡
<
From
*, 
	gTo
*>(0);

32 #iâdeà
NDEBUG


33 
as£¹
(
f
 =ğ
NULL
 || 
dyÇmic_ÿ¡
<
To
*>(
g‘_poš‹r
(f)) != NULL);

35  ::
boo¡
::
¡©ic_poš‹r_ÿ¡
<
To
>(
f
);

38 
Çme¥aû
 
	gÃt


43 
şass
 
	gBufãr
;

44 
şass
 
	gTıCÚÃùiÚ
;

45 
	gboo¡
::
	tsh¬ed_±r
<
	tTıCÚÃùiÚ
> 
	tTıCÚÃùiÚPŒ
;

46 
	gboo¡
::
	tfunùiÚ
<()> 
	tTim”C®lback
;

47 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&)> 
	tCÚÃùiÚC®lback
;

48 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&)> 
	tClo£C®lback
;

49 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&)> 
	tWr™eCom¶‘eC®lback
;

50 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&, 
	tsize_t
)> 
	tHighW©”M¬kC®lback
;

53 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

54 
	tBufãr
*,

55 
	tTime¡amp
)> 
	tMes§geC®lback
;

57 
deçuÉCÚÃùiÚC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

58 
deçuÉMes§geC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

59 
Bufãr
* 
bufãr
,

60 
Time¡amp
 
»ûiveTime
);

	@muduo/net/Callbacks.h

11 #iâdeà
MUDUO_NET_CALLBACKS_H


12 
	#MUDUO_NET_CALLBACKS_H


	)

14 
	~<boo¡/funùiÚ.hµ
>

15 
	~<boo¡/sh¬ed_±r.hµ
>

17 
	~<muduo/ba£/Time¡amp.h
>

19 
Çme¥aû
 
	gmuduo


24 
	g‹m¶©e
<
ty³Çme
 
	gTo
,y³Çm
	gFrom
>

25 
	gšlše
 ::
boo¡
::
sh¬ed_±r
<
To
> 
down_poš‹r_ÿ¡
(cÚ¡ ::boo¡::sh¬ed_±r<
From
>& 
f
)

27 ià(
çl£
)

29 
im¶ic™_ÿ¡
<
From
*, 
	gTo
*>(0);

32 #iâdeà
NDEBUG


33 
as£¹
(
f
 =ğ
NULL
 || 
dyÇmic_ÿ¡
<
To
*>(
g‘_poš‹r
(f)) != NULL);

35  ::
boo¡
::
¡©ic_poš‹r_ÿ¡
<
To
>(
f
);

38 
Çme¥aû
 
	gÃt


43 
şass
 
	gBufãr
;

44 
şass
 
	gTıCÚÃùiÚ
;

45 
	gboo¡
::
	tsh¬ed_±r
<
	tTıCÚÃùiÚ
> 
	tTıCÚÃùiÚPŒ
;

46 
	gboo¡
::
	tfunùiÚ
<()> 
	tTim”C®lback
;

47 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&)> 
	tCÚÃùiÚC®lback
;

48 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&)> 
	tClo£C®lback
;

49 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&)> 
	tWr™eCom¶‘eC®lback
;

50 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&, 
	tsize_t
)> 
	tHighW©”M¬kC®lback
;

53 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

54 
	tBufãr
*,

55 
	tTime¡amp
)> 
	tMes§geC®lback
;

57 
deçuÉCÚÃùiÚC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

58 
deçuÉMes§geC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

59 
Bufãr
* 
bufãr
,

60 
Time¡amp
 
»ûiveTime
);

	@muduo/net/Channel.cc

9 
	~<muduo/ba£/Loggšg.h
>

10 
	~<muduo/Ãt/ChªÃl.h
>

11 
	~<muduo/Ãt/Ev’tLoİ.h
>

13 
	~<s¡»am
>

15 
	~<pŞl.h
>

17 
usšg
 
Çme¥aû
 
	gmuduo
;

18 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

20 cÚ¡ 
	gChªÃl
::
kNÚeEv’t
 = 0;

21 cÚ¡ 
	gChªÃl
::
kR—dEv’t
 = 
POLLIN
 | 
POLLPRI
;

22 cÚ¡ 
	gChªÃl
::
kWr™eEv’t
 = 
POLLOUT
;

24 
	gChªÃl
::
	$ChªÃl
(
Ev’tLoİ
* 
loİ
, 
fd__
)

25 : 
	`loİ_
(
loİ
),

26 
	`fd_
(
fd__
),

27 
	`ev’ts_
(0),

28 
	`»v’ts_
(0),

29 
	`šdex_
(-1),

30 
	`logHup_
(
Œue
),

31 
	`t›d_
(
çl£
),

32 
	`ev’tHªdlšg_
(
çl£
),

33 
	$addedToLoİ_
(
çl£
)

35 
	}
}

37 
	gChªÃl
::~
	$ChªÃl
()

39 
	`as£¹
(!
ev’tHªdlšg_
);

40 
	`as£¹
(!
addedToLoİ_
);

41 ià(
loİ_
->
	`isInLoİTh»ad
())

43 
	`as£¹
(!
loİ_
->
	`hasChªÃl
(
this
));

45 
	}
}

47 
	gChªÃl
::
t›
(cÚ¡ 
boo¡
::
sh¬ed_±r
<>& 
obj
)

49 
t›_
 = 
obj
;

50 
	gt›d_
 = 
Œue
;

53 
	gChªÃl
::
	$upd©e
()

55 
addedToLoİ_
 = 
Œue
;

56 
loİ_
->
	`upd©eChªÃl
(
this
);

57 
	}
}

59 
	gChªÃl
::
	$»move
()

61 
	`as£¹
(
	`isNÚeEv’t
());

62 
addedToLoİ_
 = 
çl£
;

63 
loİ_
->
	`»moveChªÃl
(
this
);

64 
	}
}

66 
	gChªÃl
::
	$hªdËEv’t
(
Time¡amp
 
»ûiveTime
)

68 
boo¡
::
sh¬ed_±r
<> 
gu¬d
;

69 ià(
t›d_
)

71 
gu¬d
 = 
t›_
.
	`lock
();

72 ià(
gu¬d
)

74 
	`hªdËEv’tW™hGu¬d
(
»ûiveTime
);

79 
	`hªdËEv’tW™hGu¬d
(
»ûiveTime
);

81 
	}
}

83 
	gChªÃl
::
	$hªdËEv’tW™hGu¬d
(
Time¡amp
 
»ûiveTime
)

85 
ev’tHªdlšg_
 = 
Œue
;

86 
LOG_TRACE
 << 
	`»v’tsToSŒšg
();

87 ià((
»v’ts_
 & 
POLLHUP
è&& !Ôev’ts_ & 
POLLIN
))

89 ià(
logHup_
)

91 
LOG_WARN
 << "fd = " << 
fd_
 << " Channel::handle_event() POLLHUP";

93 ià(
şo£C®lback_
è
	`şo£C®lback_
();

96 ià(
»v’ts_
 & 
POLLNVAL
)

98 
LOG_WARN
 << "fd = " << 
fd_
 << " Channel::handle_event() POLLNVAL";

101 ià(
»v’ts_
 & (
POLLERR
 | 
POLLNVAL
))

103 ià(
”rÜC®lback_
è
	`”rÜC®lback_
();

106 ià(
»v’ts_
 & (
POLLIN
 | 
POLLPRI
 | 
POLLRDHUP
))

108 ià(
»adC®lback_
è
	`»adC®lback_
(
»ûiveTime
);

110 ià(
»v’ts_
 & 
POLLOUT
)

112 ià(
wr™eC®lback_
è
	`wr™eC®lback_
();

114 
ev’tHªdlšg_
 = 
çl£
;

115 
	}
}

117 
¡ršg
 
	gChªÃl
::
	$»v’tsToSŒšg
() const

119  
	`ev’tsToSŒšg
(
fd_
, 
»v’ts_
);

120 
	}
}

122 
¡ršg
 
	gChªÃl
::
	$ev’tsToSŒšg
() const

124  
	`ev’tsToSŒšg
(
fd_
, 
ev’ts_
);

125 
	}
}

127 
¡ršg
 
	gChªÃl
::
	$ev’tsToSŒšg
(
fd
, 
ev
)

129 
¡d
::
o¡ršg¡»am
 
oss
;

130 
oss
 << 
fd
 << ": ";

131 ià(
ev
 & 
POLLIN
)

132 
oss
 << "IN ";

133 ià(
ev
 & 
POLLPRI
)

134 
oss
 << "PRI ";

135 ià(
ev
 & 
POLLOUT
)

136 
oss
 << "OUT ";

137 ià(
ev
 & 
POLLHUP
)

138 
oss
 << "HUP ";

139 ià(
ev
 & 
POLLRDHUP
)

140 
oss
 << "RDHUP ";

141 ià(
ev
 & 
POLLERR
)

142 
oss
 << "ERR ";

143 ià(
ev
 & 
POLLNVAL
)

144 
oss
 << "NVAL ";

146  
oss
.
	`¡r
().
	`c_¡r
();

147 
	}
}

	@muduo/net/Channel.h

11 #iâdeà
MUDUO_NET_CHANNEL_H


12 
	#MUDUO_NET_CHANNEL_H


	)

14 
	~<boo¡/funùiÚ.hµ
>

15 
	~<boo¡/nÚcİyabË.hµ
>

16 
	~<boo¡/sh¬ed_±r.hµ
>

17 
	~<boo¡/w—k_±r.hµ
>

19 
	~<muduo/ba£/Time¡amp.h
>

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gÃt


26 
şass
 
	gEv’tLoİ
;

35 şas 
	cChªÃl
 : 
boo¡
::
nÚcİyabË


37 
public
:

38 
boo¡
::
	tfunùiÚ
<()> 
	tEv’tC®lback
;

39 
	gboo¡
::
	tfunùiÚ
<(
	tTime¡amp
)> 
	tR—dEv’tC®lback
;

41 
ChªÃl
(
Ev’tLoİ
* 
loİ
, 
fd
);

42 ~
ChªÃl
();

44 
hªdËEv’t
(
Time¡amp
 
»ûiveTime
);

45 
£tR—dC®lback
(cÚ¡ 
R—dEv’tC®lback
& 
cb
)

46 { 
	g»adC®lback_
 = 
cb
; }

47 
£tWr™eC®lback
(cÚ¡ 
Ev’tC®lback
& 
cb
)

48 { 
	gwr™eC®lback_
 = 
cb
; }

49 
£tClo£C®lback
(cÚ¡ 
Ev’tC®lback
& 
cb
)

50 { 
	gşo£C®lback_
 = 
cb
; }

51 
£tE¼ÜC®lback
(cÚ¡ 
Ev’tC®lback
& 
cb
)

52 { 
	g”rÜC®lback_
 = 
cb
; }

53 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


54 
£tR—dC®lback
(
R—dEv’tC®lback
&& 
cb
)

55 { 
	g»adC®lback_
 = 
¡d
::
move
(
cb
); }

56 
£tWr™eC®lback
(
Ev’tC®lback
&& 
cb
)

57 { 
	gwr™eC®lback_
 = 
¡d
::
move
(
cb
); }

58 
£tClo£C®lback
(
Ev’tC®lback
&& 
cb
)

59 { 
	gşo£C®lback_
 = 
¡d
::
move
(
cb
); }

60 
£tE¼ÜC®lback
(
Ev’tC®lback
&& 
cb
)

61 { 
	g”rÜC®lback_
 = 
¡d
::
move
(
cb
); }

66 
t›
(cÚ¡ 
boo¡
::
sh¬ed_±r
<>&);

68 
fd
(ècÚ¡ {  
	gfd_
; }

69 
ev’ts
(ècÚ¡ {  
	gev’ts_
; }

70 
£t_»v’ts
(
»vt
è{ 
	g»v’ts_
 =„evt; }

72 
boŞ
 
isNÚeEv’t
(ècÚ¡ {  
	gev’ts_
 =ğ
kNÚeEv’t
; }

74 
’abËR—dšg
(è{ 
	gev’ts_
 |ğ
kR—dEv’t
; 
upd©e
(); }

75 
di§bËR—dšg
(è{ 
	gev’ts_
 &ğ~
kR—dEv’t
; 
upd©e
(); }

76 
’abËWr™šg
(è{ 
	gev’ts_
 |ğ
kWr™eEv’t
; 
upd©e
(); }

77 
di§bËWr™šg
(è{ 
	gev’ts_
 &ğ~
kWr™eEv’t
; 
upd©e
(); }

78 
di§bËAÎ
(è{ 
	gev’ts_
 = 
kNÚeEv’t
; 
upd©e
(); }

79 
boŞ
 
isWr™šg
(ècÚ¡ {  
	gev’ts_
 & 
	gkWr™eEv’t
; }

80 
boŞ
 
isR—dšg
(ècÚ¡ {  
	gev’ts_
 & 
	gkR—dEv’t
; }

83 
šdex
(è{  
	gšdex_
; }

84 
£t_šdex
(
idx
è{ 
	gšdex_
 = idx; }

87 
¡ršg
 
»v’tsToSŒšg
() const;

88 
¡ršg
 
ev’tsToSŒšg
() const;

90 
doNÙLogHup
(è{ 
	glogHup_
 = 
çl£
; }

92 
Ev’tLoİ
* 
owÃrLoİ
(è{  
	gloİ_
; }

93 
»move
();

95 
	g´iv©e
:

96 
¡ršg
 
ev’tsToSŒšg
(
fd
, 
ev
);

98 
upd©e
();

99 
hªdËEv’tW™hGu¬d
(
Time¡amp
 
»ûiveTime
);

101 cÚ¡ 
	gkNÚeEv’t
;

102 cÚ¡ 
	gkR—dEv’t
;

103 cÚ¡ 
	gkWr™eEv’t
;

106 
Ev’tLoİ
* 
	gloİ_
;

108 cÚ¡ 
	gfd_
;

110 
	gev’ts_
;

111 
	g»v’ts_
;

113 
	gšdex_
;

114 
boŞ
 
	glogHup_
;

116 
	gboo¡
::
w—k_±r
<> 
t›_
;

117 
boŞ
 
	gt›d_
;

119 
boŞ
 
	gev’tHªdlšg_
;

121 
boŞ
 
	gaddedToLoİ_
;

123 
R—dEv’tC®lback
 
	g»adC®lback_
;

124 
Ev’tC®lback
 
	gwr™eC®lback_
;

125 
Ev’tC®lback
 
	gşo£C®lback_
;

126 
Ev’tC®lback
 
	g”rÜC®lback_
;

	@muduo/net/Channel.h

11 #iâdeà
MUDUO_NET_CHANNEL_H


12 
	#MUDUO_NET_CHANNEL_H


	)

14 
	~<boo¡/funùiÚ.hµ
>

15 
	~<boo¡/nÚcİyabË.hµ
>

16 
	~<boo¡/sh¬ed_±r.hµ
>

17 
	~<boo¡/w—k_±r.hµ
>

19 
	~<muduo/ba£/Time¡amp.h
>

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gÃt


26 
şass
 
	gEv’tLoİ
;

35 şas 
	cChªÃl
 : 
boo¡
::
nÚcİyabË


37 
public
:

38 
boo¡
::
	tfunùiÚ
<()> 
	tEv’tC®lback
;

39 
	gboo¡
::
	tfunùiÚ
<(
	tTime¡amp
)> 
	tR—dEv’tC®lback
;

41 
ChªÃl
(
Ev’tLoİ
* 
loİ
, 
fd
);

42 ~
ChªÃl
();

44 
hªdËEv’t
(
Time¡amp
 
»ûiveTime
);

45 
£tR—dC®lback
(cÚ¡ 
R—dEv’tC®lback
& 
cb
)

46 { 
	g»adC®lback_
 = 
cb
; }

47 
£tWr™eC®lback
(cÚ¡ 
Ev’tC®lback
& 
cb
)

48 { 
	gwr™eC®lback_
 = 
cb
; }

49 
£tClo£C®lback
(cÚ¡ 
Ev’tC®lback
& 
cb
)

50 { 
	gşo£C®lback_
 = 
cb
; }

51 
£tE¼ÜC®lback
(cÚ¡ 
Ev’tC®lback
& 
cb
)

52 { 
	g”rÜC®lback_
 = 
cb
; }

53 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


54 
£tR—dC®lback
(
R—dEv’tC®lback
&& 
cb
)

55 { 
	g»adC®lback_
 = 
¡d
::
move
(
cb
); }

56 
£tWr™eC®lback
(
Ev’tC®lback
&& 
cb
)

57 { 
	gwr™eC®lback_
 = 
¡d
::
move
(
cb
); }

58 
£tClo£C®lback
(
Ev’tC®lback
&& 
cb
)

59 { 
	gşo£C®lback_
 = 
¡d
::
move
(
cb
); }

60 
£tE¼ÜC®lback
(
Ev’tC®lback
&& 
cb
)

61 { 
	g”rÜC®lback_
 = 
¡d
::
move
(
cb
); }

66 
t›
(cÚ¡ 
boo¡
::
sh¬ed_±r
<>&);

68 
fd
(ècÚ¡ {  
	gfd_
; }

69 
ev’ts
(ècÚ¡ {  
	gev’ts_
; }

70 
£t_»v’ts
(
»vt
è{ 
	g»v’ts_
 =„evt; }

72 
boŞ
 
isNÚeEv’t
(ècÚ¡ {  
	gev’ts_
 =ğ
kNÚeEv’t
; }

74 
’abËR—dšg
(è{ 
	gev’ts_
 |ğ
kR—dEv’t
; 
upd©e
(); }

75 
di§bËR—dšg
(è{ 
	gev’ts_
 &ğ~
kR—dEv’t
; 
upd©e
(); }

76 
’abËWr™šg
(è{ 
	gev’ts_
 |ğ
kWr™eEv’t
; 
upd©e
(); }

77 
di§bËWr™šg
(è{ 
	gev’ts_
 &ğ~
kWr™eEv’t
; 
upd©e
(); }

78 
di§bËAÎ
(è{ 
	gev’ts_
 = 
kNÚeEv’t
; 
upd©e
(); }

79 
boŞ
 
isWr™šg
(ècÚ¡ {  
	gev’ts_
 & 
	gkWr™eEv’t
; }

80 
boŞ
 
isR—dšg
(ècÚ¡ {  
	gev’ts_
 & 
	gkR—dEv’t
; }

83 
šdex
(è{  
	gšdex_
; }

84 
£t_šdex
(
idx
è{ 
	gšdex_
 = idx; }

87 
¡ršg
 
»v’tsToSŒšg
() const;

88 
¡ršg
 
ev’tsToSŒšg
() const;

90 
doNÙLogHup
(è{ 
	glogHup_
 = 
çl£
; }

92 
Ev’tLoİ
* 
owÃrLoİ
(è{  
	gloİ_
; }

93 
»move
();

95 
	g´iv©e
:

96 
¡ršg
 
ev’tsToSŒšg
(
fd
, 
ev
);

98 
upd©e
();

99 
hªdËEv’tW™hGu¬d
(
Time¡amp
 
»ûiveTime
);

101 cÚ¡ 
	gkNÚeEv’t
;

102 cÚ¡ 
	gkR—dEv’t
;

103 cÚ¡ 
	gkWr™eEv’t
;

106 
Ev’tLoİ
* 
	gloİ_
;

108 cÚ¡ 
	gfd_
;

110 
	gev’ts_
;

111 
	g»v’ts_
;

113 
	gšdex_
;

114 
boŞ
 
	glogHup_
;

116 
	gboo¡
::
w—k_±r
<> 
t›_
;

117 
boŞ
 
	gt›d_
;

119 
boŞ
 
	gev’tHªdlšg_
;

121 
boŞ
 
	gaddedToLoİ_
;

123 
R—dEv’tC®lback
 
	g»adC®lback_
;

124 
Ev’tC®lback
 
	gwr™eC®lback_
;

125 
Ev’tC®lback
 
	gşo£C®lback_
;

126 
Ev’tC®lback
 
	g”rÜC®lback_
;

	@muduo/net/Connector.cc

10 
	~<muduo/Ãt/CÚÃùÜ.h
>

12 
	~<muduo/ba£/Loggšg.h
>

13 
	~<muduo/Ãt/ChªÃl.h
>

14 
	~<muduo/Ãt/Ev’tLoİ.h
>

15 
	~<muduo/Ãt/Sock‘sOps.h
>

17 
	~<boo¡/bšd.hµ
>

19 
	~<”ºo.h
>

21 
usšg
 
Çme¥aû
 
	gmuduo
;

22 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

24 cÚ¡ 
	gCÚÃùÜ
::
kMaxR‘ryD–ayMs
;

26 
	gCÚÃùÜ
::
	$CÚÃùÜ
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
)

27 : 
	`loİ_
(
loİ
),

28 
	`£rv”Addr_
(
£rv”Addr
),

29 
	`cÚÃù_
(
çl£
),

30 
	`¡©e_
(
kDiscÚÃùed
),

31 
	$»ŒyD–ayMs_
(
kIn™R‘ryD–ayMs
)

33 
LOG_DEBUG
 << "ùÜ[" << 
this
 << "]";

34 
	}
}

36 
	gCÚÃùÜ
::~
	$CÚÃùÜ
()

38 
LOG_DEBUG
 << "dtÜ[" << 
this
 << "]";

39 
	`as£¹
(!
chªÃl_
);

40 
	}
}

42 
	gCÚÃùÜ
::
	$¡¬t
()

44 
cÚÃù_
 = 
Œue
;

45 
loİ_
->
	`runInLoİ
(
boo¡
::
	`bšd
(&
CÚÃùÜ
::
¡¬tInLoİ
, 
this
));

46 
	}
}

48 
	gCÚÃùÜ
::
	$¡¬tInLoİ
()

50 
loİ_
->
	`as£¹InLoİTh»ad
();

51 
	`as£¹
(
¡©e_
 =ğ
kDiscÚÃùed
);

52 ià(
cÚÃù_
)

54 
	`cÚÃù
();

58 
LOG_DEBUG
 << "do‚ot connect";

60 
	}
}

62 
	gCÚÃùÜ
::
	$¡İ
()

64 
cÚÃù_
 = 
çl£
;

65 
loİ_
->
	`queueInLoİ
(
boo¡
::
	`bšd
(&
CÚÃùÜ
::
¡İInLoİ
, 
this
));

67 
	}
}

69 
	gCÚÃùÜ
::
	$¡İInLoİ
()

71 
loİ_
->
	`as£¹InLoİTh»ad
();

72 ià(
¡©e_
 =ğ
kCÚÃùšg
)

74 
	`£tS‹
(
kDiscÚÃùed
);

75 
sockfd
 = 
	`»moveAndRe£tChªÃl
();

76 
	`»Œy
(
sockfd
);

78 
	}
}

80 
	gCÚÃùÜ
::
	$cÚÃù
()

82 
sockfd
 = 
sock‘s
::
	`ü—‹NÚblockšgOrD›
(
£rv”Addr_
.
	`çmy
());

83 
»t
 = 
sock‘s
::
	`cÚÃù
(
sockfd
, 
£rv”Addr_
.
	`g‘SockAddr
());

84 
§vedE¼no
 = (
»t
 =ğ0è? 0 : 
”ºo
;

85 
§vedE¼no
)

88 
EINPROGRESS
:

89 
EINTR
:

90 
EISCONN
:

91 
	`cÚÃùšg
(
sockfd
);

94 
EAGAIN
:

95 
EADDRINUSE
:

96 
EADDRNOTAVAIL
:

97 
ECONNREFUSED
:

98 
ENETUNREACH
:

99 
	`»Œy
(
sockfd
);

102 
EACCES
:

103 
EPERM
:

104 
EAFNOSUPPORT
:

105 
EALREADY
:

106 
EBADF
:

107 
EFAULT
:

108 
ENOTSOCK
:

109 
LOG_SYSERR
 << "cÚÃùƒ¼Ü iÀCÚÃùÜ::¡¬tInLoİ " << 
§vedE¼no
;

110 
sock‘s
::
	`şo£
(
sockfd
);

114 
LOG_SYSERR
 << "UÃx³ùedƒ¼Ü iÀCÚÃùÜ::¡¬tInLoİ " << 
§vedE¼no
;

115 
sock‘s
::
	`şo£
(
sockfd
);

119 
	}
}

121 
	gCÚÃùÜ
::
	$»¡¬t
()

123 
loİ_
->
	`as£¹InLoİTh»ad
();

124 
	`£tS‹
(
kDiscÚÃùed
);

125 
»ŒyD–ayMs_
 = 
kIn™R‘ryD–ayMs
;

126 
cÚÃù_
 = 
Œue
;

127 
	`¡¬tInLoİ
();

128 
	}
}

130 
	gCÚÃùÜ
::
	$cÚÃùšg
(
sockfd
)

132 
	`£tS‹
(
kCÚÃùšg
);

133 
	`as£¹
(!
chªÃl_
);

134 
chªÃl_
.
	`»£t
(
Ãw
 
	`ChªÃl
(
loİ_
, 
sockfd
));

135 
chªÃl_
->
	`£tWr™eC®lback
(

136 
boo¡
::
	`bšd
(&
CÚÃùÜ
::
hªdËWr™e
, 
this
));

137 
chªÃl_
->
	`£tE¼ÜC®lback
(

138 
boo¡
::
	`bšd
(&
CÚÃùÜ
::
hªdËE¼Ü
, 
this
));

142 
chªÃl_
->
	`’abËWr™šg
();

143 
	}
}

145 
	gCÚÃùÜ
::
	$»moveAndRe£tChªÃl
()

147 
chªÃl_
->
	`di§bËAÎ
();

148 
chªÃl_
->
	`»move
();

149 
sockfd
 = 
chªÃl_
->
	`fd
();

151 
loİ_
->
	`queueInLoİ
(
boo¡
::
	`bšd
(&
CÚÃùÜ
::
»£tChªÃl
, 
this
));

152  
sockfd
;

153 
	}
}

155 
	gCÚÃùÜ
::
	$»£tChªÃl
()

157 
chªÃl_
.
	`»£t
();

158 
	}
}

160 
	gCÚÃùÜ
::
	$hªdËWr™e
()

162 
LOG_TRACE
 << "CÚÃùÜ::hªdËWr™" << 
¡©e_
;

164 ià(
¡©e_
 =ğ
kCÚÃùšg
)

166 
sockfd
 = 
	`»moveAndRe£tChªÃl
();

167 
”r
 = 
sock‘s
::
	`g‘Sock‘E¼Ü
(
sockfd
);

168 ià(
”r
)

170 
LOG_WARN
 << "Connector::handleWrite - SO_ERROR = "

171 << 
”r
 << " " << 
	`¡»¼Ü_
(err);

172 
	`»Œy
(
sockfd
);

174 ià(
sock‘s
::
	`isS–fCÚÃù
(
sockfd
))

176 
LOG_WARN
 << "Connector::handleWrite - Self connect";

177 
	`»Œy
(
sockfd
);

181 
	`£tS‹
(
kCÚÃùed
);

182 ià(
cÚÃù_
)

184 
	`ÃwCÚÃùiÚC®lback_
(
sockfd
);

188 
sock‘s
::
	`şo£
(
sockfd
);

195 
	`as£¹
(
¡©e_
 =ğ
kDiscÚÃùed
);

197 
	}
}

199 
	gCÚÃùÜ
::
	$hªdËE¼Ü
()

201 
LOG_ERROR
 << "CÚÃùÜ::hªdËE¼Ü s‹=" << 
¡©e_
;

202 ià(
¡©e_
 =ğ
kCÚÃùšg
)

204 
sockfd
 = 
	`»moveAndRe£tChªÃl
();

205 
”r
 = 
sock‘s
::
	`g‘Sock‘E¼Ü
(
sockfd
);

206 
LOG_TRACE
 << "SO_ERROR = " << 
”r
 << " " << 
	`¡»¼Ü_
(err);

207 
	`»Œy
(
sockfd
);

209 
	}
}

211 
	gCÚÃùÜ
::
	$»Œy
(
sockfd
)

213 
sock‘s
::
	`şo£
(
sockfd
);

214 
	`£tS‹
(
kDiscÚÃùed
);

215 ià(
cÚÃù_
)

217 
LOG_INFO
 << "CÚÃùÜ::»Œy - R‘ry cÚÃùšgØ" << 
£rv”Addr_
.
	`toIpPÜt
()

218 << " iÀ" << 
»ŒyD–ayMs_
 << " milliseconds. ";

219 
loİ_
->
	`runAá”
(
»ŒyD–ayMs_
/1000.0,

220 
boo¡
::
	`bšd
(&
CÚÃùÜ
::
¡¬tInLoİ
, 
	`sh¬ed_äom_this
()));

221 
»ŒyD–ayMs_
 = 
¡d
::
	`mš
Ô‘ryD–ayMs_ * 2, 
kMaxR‘ryD–ayMs
);

225 
LOG_DEBUG
 << "do‚ot connect";

227 
	}
}

	@muduo/net/Connector.h

11 #iâdeà
MUDUO_NET_CONNECTOR_H


12 
	#MUDUO_NET_CONNECTOR_H


	)

14 
	~<muduo/Ãt/IÃtAdd»ss.h
>

16 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

17 
	~<boo¡/funùiÚ.hµ
>

18 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<boo¡/scİed_±r.hµ
>

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gÃt


26 
şass
 
	gChªÃl
;

27 
şass
 
	gEv’tLoİ
;

29 
şass
 
	gCÚÃùÜ
 : 
boo¡
::
nÚcİyabË
,

30 
public
 
	gboo¡
::
’abË_sh¬ed_äom_this
<
CÚÃùÜ
>

32 
public
:

33 
boo¡
::
	tfunùiÚ
<(
	tsockfd
)> 
	tNewCÚÃùiÚC®lback
;

35 
CÚÃùÜ
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
);

36 ~
CÚÃùÜ
();

38 
£tNewCÚÃùiÚC®lback
(cÚ¡ 
NewCÚÃùiÚC®lback
& 
cb
)

39 { 
	gÃwCÚÃùiÚC®lback_
 = 
cb
; }

41 
¡¬t
();

42 
»¡¬t
();

43 
¡İ
();

45 cÚ¡ 
	gIÃtAdd»ss
& 
£rv”Add»ss
(ècÚ¡ {  
	g£rv”Addr_
; }

47 
	g´iv©e
:

48 
	eS‹s
 { 
kDiscÚÃùed
, 
	gkCÚÃùšg
, 
	gkCÚÃùed
 };

49 cÚ¡ 
	gkMaxR‘ryD–ayMs
 = 30*1000;

50 cÚ¡ 
	gkIn™R‘ryD–ayMs
 = 500;

52 
£tS‹
(
S‹s
 
s
è{ 
	g¡©e_
 = s; }

53 
¡¬tInLoİ
();

54 
¡İInLoİ
();

55 
cÚÃù
();

56 
cÚÃùšg
(
sockfd
);

57 
hªdËWr™e
();

58 
hªdËE¼Ü
();

59 
»Œy
(
sockfd
);

60 
»moveAndRe£tChªÃl
();

61 
»£tChªÃl
();

63 
Ev’tLoİ
* 
	gloİ_
;

64 
IÃtAdd»ss
 
	g£rv”Addr_
;

65 
boŞ
 
	gcÚÃù_
;

66 
S‹s
 
	g¡©e_
;

67 
	gboo¡
::
scİed_±r
<
ChªÃl
> 
chªÃl_
;

68 
NewCÚÃùiÚC®lback
 
	gÃwCÚÃùiÚC®lback_
;

69 
	g»ŒyD–ayMs_
;

	@muduo/net/Connector.h

11 #iâdeà
MUDUO_NET_CONNECTOR_H


12 
	#MUDUO_NET_CONNECTOR_H


	)

14 
	~<muduo/Ãt/IÃtAdd»ss.h
>

16 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

17 
	~<boo¡/funùiÚ.hµ
>

18 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<boo¡/scİed_±r.hµ
>

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gÃt


26 
şass
 
	gChªÃl
;

27 
şass
 
	gEv’tLoİ
;

29 
şass
 
	gCÚÃùÜ
 : 
boo¡
::
nÚcİyabË
,

30 
public
 
	gboo¡
::
’abË_sh¬ed_äom_this
<
CÚÃùÜ
>

32 
public
:

33 
boo¡
::
	tfunùiÚ
<(
	tsockfd
)> 
	tNewCÚÃùiÚC®lback
;

35 
CÚÃùÜ
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
);

36 ~
CÚÃùÜ
();

38 
£tNewCÚÃùiÚC®lback
(cÚ¡ 
NewCÚÃùiÚC®lback
& 
cb
)

39 { 
	gÃwCÚÃùiÚC®lback_
 = 
cb
; }

41 
¡¬t
();

42 
»¡¬t
();

43 
¡İ
();

45 cÚ¡ 
	gIÃtAdd»ss
& 
£rv”Add»ss
(ècÚ¡ {  
	g£rv”Addr_
; }

47 
	g´iv©e
:

48 
	eS‹s
 { 
kDiscÚÃùed
, 
	gkCÚÃùšg
, 
	gkCÚÃùed
 };

49 cÚ¡ 
	gkMaxR‘ryD–ayMs
 = 30*1000;

50 cÚ¡ 
	gkIn™R‘ryD–ayMs
 = 500;

52 
£tS‹
(
S‹s
 
s
è{ 
	g¡©e_
 = s; }

53 
¡¬tInLoİ
();

54 
¡İInLoİ
();

55 
cÚÃù
();

56 
cÚÃùšg
(
sockfd
);

57 
hªdËWr™e
();

58 
hªdËE¼Ü
();

59 
»Œy
(
sockfd
);

60 
»moveAndRe£tChªÃl
();

61 
»£tChªÃl
();

63 
Ev’tLoİ
* 
	gloİ_
;

64 
IÃtAdd»ss
 
	g£rv”Addr_
;

65 
boŞ
 
	gcÚÃù_
;

66 
S‹s
 
	g¡©e_
;

67 
	gboo¡
::
scİed_±r
<
ChªÃl
> 
chªÃl_
;

68 
NewCÚÃùiÚC®lback
 
	gÃwCÚÃùiÚC®lback_
;

69 
	g»ŒyD–ayMs_
;

	@muduo/net/Endian.h

11 #iâdeà
MUDUO_NET_ENDIAN_H


12 
	#MUDUO_NET_ENDIAN_H


	)

14 
	~<¡dšt.h
>

15 
	~<’dŸn.h
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


21 
Çme¥aû
 
	gsock‘s


26 #ià
defšed
(
__şªg__
è|| 
__GNUC_PREREQ
 (4,6)

27 #´agm¨
GCC
 
dŸgno¡ic
 
push


29 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wconversion"

30 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wold-style-cast"

31 
šlše
 
ušt64_t
 
ho¡ToN‘wÜk64
(ušt64_ˆ
ho¡64
)

33  
htobe64
(
ho¡64
);

36 
šlše
 
ušt32_t
 
ho¡ToN‘wÜk32
(ušt32_ˆ
ho¡32
)

38  
htobe32
(
ho¡32
);

41 
šlše
 
ušt16_t
 
ho¡ToN‘wÜk16
(ušt16_ˆ
ho¡16
)

43  
htobe16
(
ho¡16
);

46 
šlše
 
ušt64_t
 
ÃtwÜkToHo¡64
(ušt64_ˆ
Ãt64
)

48  
be64toh
(
Ãt64
);

51 
šlše
 
ušt32_t
 
ÃtwÜkToHo¡32
(ušt32_ˆ
Ãt32
)

53  
be32toh
(
Ãt32
);

56 
šlše
 
ušt16_t
 
ÃtwÜkToHo¡16
(ušt16_ˆ
Ãt16
)

58  
be16toh
(
Ãt16
);

60 #ià
defšed
(
__şªg__
è|| 
__GNUC_PREREQ
 (4,6)

61 #´agm¨
GCC
 
dŸgno¡ic
 
pİ


63 #´agm¨
GCC
 
dŸgno¡ic
 
w¬nšg
 "-Wconversion"

64 #´agm¨
GCC
 
dŸgno¡ic
 
w¬nšg
 "-Wold-style-cast"

	@muduo/net/Endian.h

11 #iâdeà
MUDUO_NET_ENDIAN_H


12 
	#MUDUO_NET_ENDIAN_H


	)

14 
	~<¡dšt.h
>

15 
	~<’dŸn.h
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


21 
Çme¥aû
 
	gsock‘s


26 #ià
defšed
(
__şªg__
è|| 
__GNUC_PREREQ
 (4,6)

27 #´agm¨
GCC
 
dŸgno¡ic
 
push


29 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wconversion"

30 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wold-style-cast"

31 
šlše
 
ušt64_t
 
ho¡ToN‘wÜk64
(ušt64_ˆ
ho¡64
)

33  
htobe64
(
ho¡64
);

36 
šlše
 
ušt32_t
 
ho¡ToN‘wÜk32
(ušt32_ˆ
ho¡32
)

38  
htobe32
(
ho¡32
);

41 
šlše
 
ušt16_t
 
ho¡ToN‘wÜk16
(ušt16_ˆ
ho¡16
)

43  
htobe16
(
ho¡16
);

46 
šlše
 
ušt64_t
 
ÃtwÜkToHo¡64
(ušt64_ˆ
Ãt64
)

48  
be64toh
(
Ãt64
);

51 
šlše
 
ušt32_t
 
ÃtwÜkToHo¡32
(ušt32_ˆ
Ãt32
)

53  
be32toh
(
Ãt32
);

56 
šlše
 
ušt16_t
 
ÃtwÜkToHo¡16
(ušt16_ˆ
Ãt16
)

58  
be16toh
(
Ãt16
);

60 #ià
defšed
(
__şªg__
è|| 
__GNUC_PREREQ
 (4,6)

61 #´agm¨
GCC
 
dŸgno¡ic
 
pİ


63 #´agm¨
GCC
 
dŸgno¡ic
 
w¬nšg
 "-Wconversion"

64 #´agm¨
GCC
 
dŸgno¡ic
 
w¬nšg
 "-Wold-style-cast"

	@muduo/net/EventLoop.cc

9 
	~<muduo/Ãt/Ev’tLoİ.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/ba£/Mu‹x.h
>

13 
	~<muduo/Ãt/ChªÃl.h
>

14 
	~<muduo/Ãt/PŞËr.h
>

15 
	~<muduo/Ãt/Sock‘sOps.h
>

16 
	~<muduo/Ãt/Tim”Queue.h
>

18 
	~<boo¡/bšd.hµ
>

20 
	~<sigÇl.h
>

21 
	~<sys/ev’tfd.h
>

22 
	~<uni¡d.h
>

24 
usšg
 
Çme¥aû
 
	gmuduo
;

25 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

27 
	gÇme¥aû


30 
__th»ad
 
Ev’tLoİ
* 
	gt_loİInThisTh»ad
 = 0;

32 cÚ¡ 
	gkPŞlTimeMs
 = 10000;

34 
ü—‹Ev’tfd
()

37 
	gevtfd
 = ::
ev’tfd
(0, 
EFD_NONBLOCK
 | 
EFD_CLOEXEC
);

38 ià(
	gevtfd
 < 0)

40 
	gLOG_SYSERR
 << "Failed inƒventfd";

41 
abÜt
();

43  
	gevtfd
;

46 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wold-style-cast"

47 şas 
	cIgnÜeSigPe


49 
	gpublic
:

50 
IgnÜeSigPe
()

52 ::
sigÇl
(
SIGPIPE
, 
SIG_IGN
);

56 #´agm¨
GCC
 
dŸgno¡ic
 
”rÜ
 "-Wold-style-cast"

58 
IgnÜeSigPe
 
	gš™Obj
;

62 
Ev’tLoİ
* 
	gEv’tLoİ
::
	$g‘Ev’tLoİOfCu¼’tTh»ad
()

64  
t_loİInThisTh»ad
;

65 
	}
}

67 
	gEv’tLoİ
::
	$Ev’tLoİ
()

68 : 
	`loİšg_
(
çl£
),

69 
	`qu™_
(
çl£
),

70 
	`ev’tHªdlšg_
(
çl£
),

71 
	`ÿÎšgP’dšgFunùÜs_
(
çl£
),

72 
	`™”©iÚ_
(0),

73 
	`th»adId_
(
Cu¼’tTh»ad
::
	`tid
()),

74 
	`pŞËr_
(
PŞËr
::
	`ÃwDeçuÉPŞËr
(
this
)),

75 
	`tim”Queue_
(
Ãw
 
	`Tim”Queue
(
this
)),

76 
	`wakeupFd_
(
	`ü—‹Ev’tfd
()),

77 
	`wakeupChªÃl_
(
Ãw
 
	`ChªÃl
(
this
, 
wakeupFd_
)),

78 
	$cu¼’tAùiveChªÃl_
(
NULL
)

80 
LOG_DEBUG
 << "Ev’tLoİ c»©ed " << 
this
 << " iÀth»ad " << 
th»adId_
;

81 ià(
t_loİInThisTh»ad
)

83 
LOG_FATAL
 << "AnÙh” Ev’tLoİ " << 
t_loİInThisTh»ad


84 << "ƒxi¡ šhi th»ad " << 
th»adId_
;

88 
t_loİInThisTh»ad
 = 
this
;

91 
wakeupChªÃl_
->
	`£tR—dC®lback
(

92 
boo¡
::
	`bšd
(&
Ev’tLoİ
::
hªdËR—d
, 
this
));

95 
wakeupChªÃl_
->
	`’abËR—dšg
();

96 
	}
}

98 
	gEv’tLoİ
::~
	$Ev’tLoİ
()

100 
LOG_DEBUG
 << "Ev’tLoİ " << 
this
 << " oàth»ad " << 
th»adId_


101 << " de¡ruù šh»ad " << 
Cu¼’tTh»ad
::
	`tid
();

102 
wakeupChªÃl_
->
	`di§bËAÎ
();

103 
wakeupChªÃl_
->
	`»move
();

104 ::
	`şo£
(
wakeupFd_
);

105 
t_loİInThisTh»ad
 = 
NULL
;

106 
	}
}

108 
	gEv’tLoİ
::
	$loİ
()

110 
	`as£¹
(!
loİšg_
);

111 
	`as£¹InLoİTh»ad
();

112 
loİšg_
 = 
Œue
;

113 
qu™_
 = 
çl£
;

114 
LOG_TRACE
 << "Ev’tLoİ " << 
this
 << " start†ooping";

116 !
qu™_
)

118 
aùiveChªÃls_
.
	`ş—r
();

120 
pŞlR‘uºTime_
 = 
pŞËr_
->
	`pŞl
(
kPŞlTimeMs
, &
aùiveChªÃls_
);

121 ++
™”©iÚ_
;

122 ià(
Logg”
::
	`logLev–
(è<ğLogg”::
TRACE
)

124 
	`´štAùiveChªÃls
();

129 
ev’tHªdlšg_
 = 
Œue
;

130 
ChªÃlLi¡
::
™”©Ü
 
™
 = 
aùiveChªÃls_
.
	`begš
();

131 
™
 !ğ
aùiveChªÃls_
.
	`’d
(); ++it)

133 
cu¼’tAùiveChªÃl_
 = *
™
;

136 
cu¼’tAùiveChªÃl_
->
	`hªdËEv’t
(
pŞlR‘uºTime_
);

138 
cu¼’tAùiveChªÃl_
 = 
NULL
;

139 
ev’tHªdlšg_
 = 
çl£
;

141 
	`doP’dšgFunùÜs
();

144 
LOG_TRACE
 << "Ev’tLoİ " << 
this
 << " stop†ooping";

145 
loİšg_
 = 
çl£
;

146 
	}
}

148 
	gEv’tLoİ
::
	$qu™
()

150 
qu™_
 = 
Œue
;

154 ià(!
	`isInLoİTh»ad
())

156 
	`wakeup
();

158 
	}
}

160 
	gEv’tLoİ
::
	$runInLoİ
(cÚ¡ 
FunùÜ
& 
cb
)

162 ià(
	`isInLoİTh»ad
())

164 
	`cb
();

168 
	`queueInLoİ
(
cb
);

170 
	}
}

172 
	gEv’tLoİ
::
	$queueInLoİ
(cÚ¡ 
FunùÜ
& 
cb
)

175 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

176 
³ndšgFunùÜs_
.
	`push_back
(
cb
);

179 ià(!
	`isInLoİTh»ad
(è|| 
ÿÎšgP’dšgFunùÜs_
)

181 
	`wakeup
();

183 
	}
}

185 
size_t
 
	gEv’tLoİ
::
	$queueSize
() const

187 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

188  
³ndšgFunùÜs_
.
	`size
();

189 
	}
}

191 
Tim”Id
 
	gEv’tLoİ
::
	$runAt
(cÚ¡ 
Time¡amp
& 
time
, cÚ¡ 
Tim”C®lback
& 
cb
)

193  
tim”Queue_
->
	`addTim”
(
cb
, 
time
, 0.0);

194 
	}
}

196 
Tim”Id
 
	gEv’tLoİ
::
	$runAá”
(
d–ay
, cÚ¡ 
Tim”C®lback
& 
cb
)

198 
Time¡amp
 
	`time
(
	`addTime
(Time¡amp::
	`now
(), 
d–ay
));

199  
	`runAt
(
time
, 
cb
);

200 
	}
}

202 
Tim”Id
 
	gEv’tLoİ
::
	$runEv”y
(
š‹rv®
, cÚ¡ 
Tim”C®lback
& 
cb
)

204 
Time¡amp
 
	`time
(
	`addTime
(Time¡amp::
	`now
(), 
š‹rv®
));

205  
tim”Queue_
->
	`addTim”
(
cb
, 
time
, 
š‹rv®
);

206 
	}
}

208 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


210 
	gEv’tLoİ
::
	$runInLoİ
(
FunùÜ
&& 
cb
)

212 ià(
	`isInLoİTh»ad
())

214 
	`cb
();

218 
	`queueInLoİ
(
¡d
::
	`move
(
cb
));

220 
	}
}

222 
	gEv’tLoİ
::
	$queueInLoİ
(
FunùÜ
&& 
cb
)

225 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

226 
³ndšgFunùÜs_
.
	`push_back
(
¡d
::
	`move
(
cb
));

229 ià(!
	`isInLoİTh»ad
(è|| 
ÿÎšgP’dšgFunùÜs_
)

231 
	`wakeup
();

233 
	}
}

235 
Tim”Id
 
	gEv’tLoİ
::
	$runAt
(cÚ¡ 
Time¡amp
& 
time
, 
Tim”C®lback
&& 
cb
)

237  
tim”Queue_
->
	`addTim”
(
¡d
::
	`move
(
cb
), 
time
, 0.0);

238 
	}
}

240 
Tim”Id
 
	gEv’tLoİ
::
	$runAá”
(
d–ay
, 
Tim”C®lback
&& 
cb
)

242 
Time¡amp
 
	`time
(
	`addTime
(Time¡amp::
	`now
(), 
d–ay
));

243  
	`runAt
(
time
, 
¡d
::
	`move
(
cb
));

244 
	}
}

246 
Tim”Id
 
	gEv’tLoİ
::
	$runEv”y
(
š‹rv®
, 
Tim”C®lback
&& 
cb
)

248 
Time¡amp
 
	`time
(
	`addTime
(Time¡amp::
	`now
(), 
š‹rv®
));

249  
tim”Queue_
->
	`addTim”
(
¡d
::
	`move
(
cb
), 
time
, 
š‹rv®
);

250 
	}
}

253 
	gEv’tLoİ
::
	$ÿnûl
(
Tim”Id
 
tim”Id
)

255  
tim”Queue_
->
	`ÿnûl
(
tim”Id
);

256 
	}
}

259 
	gEv’tLoİ
::
	$upd©eChªÃl
(
ChªÃl
* 
chªÃl
)

261 
	`as£¹
(
chªÃl
->
	`owÃrLoİ
(è=ğ
this
);

262 
	`as£¹InLoİTh»ad
();

263 
pŞËr_
->
	`upd©eChªÃl
(
chªÃl
);

264 
	}
}

266 
	gEv’tLoİ
::
	$»moveChªÃl
(
ChªÃl
* 
chªÃl
)

268 
	`as£¹
(
chªÃl
->
	`owÃrLoİ
(è=ğ
this
);

269 
	`as£¹InLoİTh»ad
();

270 ià(
ev’tHªdlšg_
)

272 
	`as£¹
(
cu¼’tAùiveChªÃl_
 =ğ
chªÃl
 ||

273 
¡d
::
	`fšd
(
aùiveChªÃls_
.
	`begš
(),‡ùiveChªÃls_.
	`’d
(), 
chªÃl
) ==‡ctiveChannels_.end());

275 
pŞËr_
->
	`»moveChªÃl
(
chªÃl
);

276 
	}
}

279 
boŞ
 
	gEv’tLoİ
::
	$hasChªÃl
(
ChªÃl
* 
chªÃl
)

281 
	`as£¹
(
chªÃl
->
	`owÃrLoİ
(è=ğ
this
);

282 
	`as£¹InLoİTh»ad
();

283  
pŞËr_
->
	`hasChªÃl
(
chªÃl
);

284 
	}
}

286 
	gEv’tLoİ
::
	$abÜtNÙInLoİTh»ad
()

288 
LOG_FATAL
 << "Ev’tLoİ::abÜtNÙInLoİTh»ad - Ev’tLoİ " << 
this


289 << " wa ü—‹d iÀth»adId_ = " << 
th»adId_


290 << ", cu¼’ˆth»ad id = " << 
Cu¼’tTh»ad
::
	`tid
();

291 
	}
}

294 
	gEv’tLoİ
::
	$wakeup
()

296 
ušt64_t
 
Úe
 = 1;

297 
ssize_t
 
n
 = 
sock‘s
::
	`wr™e
(
wakeupFd_
, &
Úe
,  one);

298 ià(
n
 !ğ 
Úe
)

300 
LOG_ERROR
 << "Ev’tLoİ::wakeup(èwr™e " << 
n
 << " bytes instead of 8";

302 
	}
}

304 
	gEv’tLoİ
::
	$hªdËR—d
()

306 
ušt64_t
 
Úe
 = 1;

307 
ssize_t
 
n
 = 
sock‘s
::
	`»ad
(
wakeupFd_
, &
Úe
,  one);

308 ià(
n
 !ğ 
Úe
)

310 
LOG_ERROR
 << "Ev’tLoİ::hªdËR—d(è»ad " << 
n
 << " bytes instead of 8";

312 
	}
}

314 
	gEv’tLoİ
::
	$doP’dšgFunùÜs
()

316 
¡d
::
veùÜ
<
FunùÜ
> 
funùÜs
;

318 
ÿÎšgP’dšgFunùÜs_
 = 
Œue
;

321 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

322 
funùÜs
.
	`sw­
(
³ndšgFunùÜs_
);

326 
size_t
 
i
 = 0; i < 
funùÜs
.
	`size
(); ++i)

328 
funùÜs
[
i
]();

330 
ÿÎšgP’dšgFunùÜs_
 = 
çl£
;

331 
	}
}

333 
	gEv’tLoİ
::
	$´štAùiveChªÃls
() const

335 
ChªÃlLi¡
::
cÚ¡_™”©Ü
 
™
 = 
aùiveChªÃls_
.
	`begš
();

336 
™
 !ğ
aùiveChªÃls_
.
	`’d
(); ++it)

338 cÚ¡ 
ChªÃl
* 
ch
 = *
™
;

339 
LOG_TRACE
 << "{" << 
ch
->
	`»v’tsToSŒšg
() << "} ";

341 
	}
}

	@muduo/net/EventLoop.h

11 #iâdeà
MUDUO_NET_EVENTLOOP_H


12 
	#MUDUO_NET_EVENTLOOP_H


	)

14 
	~<veùÜ
>

16 
	~<boo¡/ªy.hµ
>

17 
	~<boo¡/funùiÚ.hµ
>

18 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<boo¡/scİed_±r.hµ
>

21 
	~<muduo/ba£/Mu‹x.h
>

22 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

23 
	~<muduo/ba£/Time¡amp.h
>

24 
	~<muduo/Ãt/C®lbacks.h
>

25 
	~<muduo/Ãt/Tim”Id.h
>

27 
Çme¥aû
 
	gmuduo


29 
Çme¥aû
 
	gÃt


32 
şass
 
	gChªÃl
;

33 
şass
 
	gPŞËr
;

34 
şass
 
	gTim”Queue
;

41 şas 
	cEv’tLoİ
 : 
boo¡
::
nÚcİyabË


43 
public
:

44 
boo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

46 
Ev’tLoİ
();

47 ~
Ev’tLoİ
();

55 
loİ
();

62 
qu™
();

68 
Time¡amp
 
pŞlR‘uºTime
(ècÚ¡ {  
	gpŞlR‘uºTime_
; }

71 
št64_t
 
™”©iÚ
(ècÚ¡ {  
	g™”©iÚ_
; }

78 
runInLoİ
(cÚ¡ 
FunùÜ
& 
cb
);

83 
queueInLoİ
(cÚ¡ 
FunùÜ
& 
cb
);

85 
size_t
 
queueSize
() const;

87 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


88 
runInLoİ
(
FunùÜ
&& 
cb
);

89 
queueInLoİ
(
FunùÜ
&& 
cb
);

98 
Tim”Id
 
runAt
(cÚ¡ 
Time¡amp
& 
time
, cÚ¡ 
Tim”C®lback
& 
cb
);

103 
Tim”Id
 
runAá”
(
d–ay
, cÚ¡ 
Tim”C®lback
& 
cb
);

108 
Tim”Id
 
runEv”y
(
š‹rv®
, cÚ¡ 
Tim”C®lback
& 
cb
);

113 
ÿnûl
(
Tim”Id
 
tim”Id
);

115 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


116 
Tim”Id
 
runAt
(cÚ¡ 
Time¡amp
& 
time
, 
Tim”C®lback
&& 
cb
);

117 
Tim”Id
 
runAá”
(
d–ay
, 
Tim”C®lback
&& 
cb
);

118 
Tim”Id
 
runEv”y
(
š‹rv®
, 
Tim”C®lback
&& 
cb
);

122 
wakeup
();

123 
upd©eChªÃl
(
ChªÃl
* 
chªÃl
);

124 
»moveChªÃl
(
ChªÃl
* 
chªÃl
);

125 
boŞ
 
hasChªÃl
(
ChªÃl
* 
chªÃl
);

128 
as£¹InLoİTh»ad
()

130 ià(!
isInLoİTh»ad
())

132 
abÜtNÙInLoİTh»ad
();

135 
boŞ
 
isInLoİTh»ad
(ècÚ¡ {  
	gth»adId_
 =ğ
Cu¼’tTh»ad
::
tid
(); }

137 
boŞ
 
ev’tHªdlšg
(ècÚ¡ {  
	gev’tHªdlšg_
; }

139 
£tCÚ‹xt
(cÚ¡ 
boo¡
::
ªy
& 
cÚ‹xt
)

140 { 
cÚ‹xt_
 = 
cÚ‹xt
; }

142 cÚ¡ 
	gboo¡
::
ªy
& 
g‘CÚ‹xt
() const

143 {  
cÚ‹xt_
; }

145 
	gboo¡
::
ªy
* 
g‘MubËCÚ‹xt
()

146 {  &
cÚ‹xt_
; }

148 
Ev’tLoİ
* 
g‘Ev’tLoİOfCu¼’tTh»ad
();

150 
	g´iv©e
:

151 
abÜtNÙInLoİTh»ad
();

152 
hªdËR—d
();

153 
doP’dšgFunùÜs
();

155 
´štAùiveChªÃls
() const;

157 
	g¡d
::
	tveùÜ
<
	tChªÃl
*> 
	tChªÃlLi¡
;

159 
boŞ
 
	gloİšg_
;

161 
boŞ
 
	gqu™_
;

162 
boŞ
 
	gev’tHªdlšg_
;

163 
boŞ
 
	gÿÎšgP’dšgFunùÜs_
;

164 
št64_t
 
	g™”©iÚ_
;

166 cÚ¡ 
pid_t
 
	gth»adId_
;

168 
Time¡amp
 
	gpŞlR‘uºTime_
;

170 
	gboo¡
::
scİed_±r
<
PŞËr
> 
pŞËr_
;

172 
	gboo¡
::
scİed_±r
<
Tim”Queue
> 
tim”Queue_
;

174 
	gwakeupFd_
;

178 
	gboo¡
::
scİed_±r
<
ChªÃl
> 
wakeupChªÃl_
;

179 
	gboo¡
::
ªy
 
cÚ‹xt_
;

183 
ChªÃlLi¡
 
	gaùiveChªÃls_
;

185 
ChªÃl
* 
	gcu¼’tAùiveChªÃl_
;

188 
mubË
 
Mu‹xLock
 
	gmu‹x_
;

190 
	g¡d
::
veùÜ
<
FunùÜ
> 
³ndšgFunùÜs_
;

	@muduo/net/EventLoop.h

11 #iâdeà
MUDUO_NET_EVENTLOOP_H


12 
	#MUDUO_NET_EVENTLOOP_H


	)

14 
	~<veùÜ
>

16 
	~<boo¡/ªy.hµ
>

17 
	~<boo¡/funùiÚ.hµ
>

18 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<boo¡/scİed_±r.hµ
>

21 
	~<muduo/ba£/Mu‹x.h
>

22 
	~<muduo/ba£/Cu¼’tTh»ad.h
>

23 
	~<muduo/ba£/Time¡amp.h
>

24 
	~<muduo/Ãt/C®lbacks.h
>

25 
	~<muduo/Ãt/Tim”Id.h
>

27 
Çme¥aû
 
	gmuduo


29 
Çme¥aû
 
	gÃt


32 
şass
 
	gChªÃl
;

33 
şass
 
	gPŞËr
;

34 
şass
 
	gTim”Queue
;

41 şas 
	cEv’tLoİ
 : 
boo¡
::
nÚcİyabË


43 
public
:

44 
boo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

46 
Ev’tLoİ
();

47 ~
Ev’tLoİ
();

55 
loİ
();

62 
qu™
();

68 
Time¡amp
 
pŞlR‘uºTime
(ècÚ¡ {  
	gpŞlR‘uºTime_
; }

71 
št64_t
 
™”©iÚ
(ècÚ¡ {  
	g™”©iÚ_
; }

78 
runInLoİ
(cÚ¡ 
FunùÜ
& 
cb
);

83 
queueInLoİ
(cÚ¡ 
FunùÜ
& 
cb
);

85 
size_t
 
queueSize
() const;

87 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


88 
runInLoİ
(
FunùÜ
&& 
cb
);

89 
queueInLoİ
(
FunùÜ
&& 
cb
);

98 
Tim”Id
 
runAt
(cÚ¡ 
Time¡amp
& 
time
, cÚ¡ 
Tim”C®lback
& 
cb
);

103 
Tim”Id
 
runAá”
(
d–ay
, cÚ¡ 
Tim”C®lback
& 
cb
);

108 
Tim”Id
 
runEv”y
(
š‹rv®
, cÚ¡ 
Tim”C®lback
& 
cb
);

113 
ÿnûl
(
Tim”Id
 
tim”Id
);

115 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


116 
Tim”Id
 
runAt
(cÚ¡ 
Time¡amp
& 
time
, 
Tim”C®lback
&& 
cb
);

117 
Tim”Id
 
runAá”
(
d–ay
, 
Tim”C®lback
&& 
cb
);

118 
Tim”Id
 
runEv”y
(
š‹rv®
, 
Tim”C®lback
&& 
cb
);

122 
wakeup
();

123 
upd©eChªÃl
(
ChªÃl
* 
chªÃl
);

124 
»moveChªÃl
(
ChªÃl
* 
chªÃl
);

125 
boŞ
 
hasChªÃl
(
ChªÃl
* 
chªÃl
);

128 
as£¹InLoİTh»ad
()

130 ià(!
isInLoİTh»ad
())

132 
abÜtNÙInLoİTh»ad
();

135 
boŞ
 
isInLoİTh»ad
(ècÚ¡ {  
	gth»adId_
 =ğ
Cu¼’tTh»ad
::
tid
(); }

137 
boŞ
 
ev’tHªdlšg
(ècÚ¡ {  
	gev’tHªdlšg_
; }

139 
£tCÚ‹xt
(cÚ¡ 
boo¡
::
ªy
& 
cÚ‹xt
)

140 { 
cÚ‹xt_
 = 
cÚ‹xt
; }

142 cÚ¡ 
	gboo¡
::
ªy
& 
g‘CÚ‹xt
() const

143 {  
cÚ‹xt_
; }

145 
	gboo¡
::
ªy
* 
g‘MubËCÚ‹xt
()

146 {  &
cÚ‹xt_
; }

148 
Ev’tLoİ
* 
g‘Ev’tLoİOfCu¼’tTh»ad
();

150 
	g´iv©e
:

151 
abÜtNÙInLoİTh»ad
();

152 
hªdËR—d
();

153 
doP’dšgFunùÜs
();

155 
´štAùiveChªÃls
() const;

157 
	g¡d
::
	tveùÜ
<
	tChªÃl
*> 
	tChªÃlLi¡
;

159 
boŞ
 
	gloİšg_
;

161 
boŞ
 
	gqu™_
;

162 
boŞ
 
	gev’tHªdlšg_
;

163 
boŞ
 
	gÿÎšgP’dšgFunùÜs_
;

164 
št64_t
 
	g™”©iÚ_
;

166 cÚ¡ 
pid_t
 
	gth»adId_
;

168 
Time¡amp
 
	gpŞlR‘uºTime_
;

170 
	gboo¡
::
scİed_±r
<
PŞËr
> 
pŞËr_
;

172 
	gboo¡
::
scİed_±r
<
Tim”Queue
> 
tim”Queue_
;

174 
	gwakeupFd_
;

178 
	gboo¡
::
scİed_±r
<
ChªÃl
> 
wakeupChªÃl_
;

179 
	gboo¡
::
ªy
 
cÚ‹xt_
;

183 
ChªÃlLi¡
 
	gaùiveChªÃls_
;

185 
ChªÃl
* 
	gcu¼’tAùiveChªÃl_
;

188 
mubË
 
Mu‹xLock
 
	gmu‹x_
;

190 
	g¡d
::
veùÜ
<
FunùÜ
> 
³ndšgFunùÜs_
;

	@muduo/net/EventLoopThread.cc

9 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

11 
	~<muduo/Ãt/Ev’tLoİ.h
>

13 
	~<boo¡/bšd.hµ
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

19 
	gEv’tLoİTh»ad
::
	$Ev’tLoİTh»ad
(cÚ¡ 
Th»adIn™C®lback
& 
cb
,

20 cÚ¡ 
¡ršg
& 
Çme
)

21 : 
	`loİ_
(
NULL
),

22 
	`ex™šg_
(
çl£
),

23 
	`th»ad_
(
boo¡
::
	`bšd
(&
Ev’tLoİTh»ad
::
th»adFunc
, 
this
), 
Çme
),

24 
	`mu‹x_
(),

25 
	`cÚd_
(
mu‹x_
),

26 
	$ÿÎback_
(
cb
)

28 
	}
}

30 
	gEv’tLoİTh»ad
::~
	$Ev’tLoİTh»ad
()

32 
ex™šg_
 = 
Œue
;

33 ià(
loİ_
 !ğ
NULL
)

37 
loİ_
->
	`qu™
();

38 
th»ad_
.
	`još
();

40 
	}
}

42 
Ev’tLoİ
* 
	gEv’tLoİTh»ad
::
	$¡¬tLoİ
()

45 
	`as£¹
(!
th»ad_
.
	`¡¬‹d
());

46 
th»ad_
.
	`¡¬t
();

49 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

50 
loİ_
 =ğ
NULL
)

52 
cÚd_
.
	`wa™
();

56  
loİ_
;

57 
	}
}

59 
	gEv’tLoİTh»ad
::
	$th»adFunc
()

62 
Ev’tLoİ
 
loİ
;

65 ià(
ÿÎback_
)

67 
	`ÿÎback_
(&
loİ
);

71 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

72 
loİ_
 = &
loİ
;

73 
cÚd_
.
	`nÙify
();

76 
loİ
.
	`loİ
();

78 
loİ_
 = 
NULL
;

79 
	}
}

	@muduo/net/EventLoopThread.h

11 #iâdeà
MUDUO_NET_EVENTLOOPTHREAD_H


12 
	#MUDUO_NET_EVENTLOOPTHREAD_H


	)

14 
	~<muduo/ba£/CÚd™iÚ.h
>

15 
	~<muduo/ba£/Mu‹x.h
>

16 
	~<muduo/ba£/Th»ad.h
>

18 
	~<boo¡/nÚcİyabË.hµ
>

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


25 
şass
 
	gEv’tLoİ
;

27 şas 
	cEv’tLoİTh»ad
 : 
boo¡
::
nÚcİyabË


29 
public
:

30 
boo¡
::
	tfunùiÚ
<(
	tEv’tLoİ
*)> 
	tTh»adIn™C®lback
;

32 
Ev’tLoİTh»ad
(cÚ¡ 
Th»adIn™C®lback
& 
cb
 = ThreadInitCallback(),

33 cÚ¡ 
¡ršg
& 
Çme
 = string());

34 ~
Ev’tLoİTh»ad
();

35 
Ev’tLoİ
* 
¡¬tLoİ
();

37 
	g´iv©e
:

39 
th»adFunc
();

41 
Ev’tLoİ
* 
	gloİ_
;

42 
boŞ
 
	gex™šg_
;

44 
Th»ad
 
	gth»ad_
;

46 
Mu‹xLock
 
	gmu‹x_
;

48 
CÚd™iÚ
 
	gcÚd_
;

50 
Th»adIn™C®lback
 
	gÿÎback_
;

	@muduo/net/EventLoopThread.h

11 #iâdeà
MUDUO_NET_EVENTLOOPTHREAD_H


12 
	#MUDUO_NET_EVENTLOOPTHREAD_H


	)

14 
	~<muduo/ba£/CÚd™iÚ.h
>

15 
	~<muduo/ba£/Mu‹x.h
>

16 
	~<muduo/ba£/Th»ad.h
>

18 
	~<boo¡/nÚcİyabË.hµ
>

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


25 
şass
 
	gEv’tLoİ
;

27 şas 
	cEv’tLoİTh»ad
 : 
boo¡
::
nÚcİyabË


29 
public
:

30 
boo¡
::
	tfunùiÚ
<(
	tEv’tLoİ
*)> 
	tTh»adIn™C®lback
;

32 
Ev’tLoİTh»ad
(cÚ¡ 
Th»adIn™C®lback
& 
cb
 = ThreadInitCallback(),

33 cÚ¡ 
¡ršg
& 
Çme
 = string());

34 ~
Ev’tLoİTh»ad
();

35 
Ev’tLoİ
* 
¡¬tLoİ
();

37 
	g´iv©e
:

39 
th»adFunc
();

41 
Ev’tLoİ
* 
	gloİ_
;

42 
boŞ
 
	gex™šg_
;

44 
Th»ad
 
	gth»ad_
;

46 
Mu‹xLock
 
	gmu‹x_
;

48 
CÚd™iÚ
 
	gcÚd_
;

50 
Th»adIn™C®lback
 
	gÿÎback_
;

	@muduo/net/EventLoopThreadPool.cc

9 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

11 
	~<muduo/Ãt/Ev’tLoİ.h
>

12 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

14 
	~<boo¡/bšd.hµ
>

16 
	~<¡dio.h
>

18 
usšg
 
Çme¥aû
 
	gmuduo
;

19 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

22 
	gEv’tLoİTh»adPoŞ
::
	$Ev’tLoİTh»adPoŞ
(
Ev’tLoİ
* 
ba£Loİ
, cÚ¡ 
¡ršg
& 
ÇmeArg
)

23 : 
	`ba£Loİ_
(
ba£Loİ
),

24 
	`Çme_
(
ÇmeArg
),

25 
	`¡¬‹d_
(
çl£
),

26 
	`numTh»ads_
(0),

27 
	$Ãxt_
(0)

29 
	}
}

31 
	gEv’tLoİTh»adPoŞ
::~
	$Ev’tLoİTh»adPoŞ
()

34 
	}
}

36 
Ev’tLoİTh»adPoŞ
::
	$¡¬t
(cÚ¡ 
Th»adIn™C®lback
& 
cb
)

38 
	`as£¹
(!
¡¬‹d_
);

39 
ba£Loİ_
->
	`as£¹InLoİTh»ad
();

41 
¡¬‹d_
 = 
Œue
;

43 
i
 = 0; i < 
numTh»ads_
; ++i)

45 
buf
[
Çme_
.
	`size
() + 32];

46 
	`¢´štf
(
buf
,  buf, "%s%d", 
Çme_
.
	`c_¡r
(), 
i
);

47 
Ev’tLoİTh»ad
* 
t
 = 
Ãw
 
	`Ev’tLoİTh»ad
(
cb
, 
buf
);

48 
th»ads_
.
	`push_back
(
t
);

49 
loİs_
.
	`push_back
(
t
->
	`¡¬tLoİ
());

51 ià(
numTh»ads_
 =ğ0 && 
cb
)

53 
	`cb
(
ba£Loİ_
);

55 
	}
}

57 
Ev’tLoİ
* 
	gEv’tLoİTh»adPoŞ
::
	$g‘NextLoİ
()

59 
ba£Loİ_
->
	`as£¹InLoİTh»ad
();

60 
	`as£¹
(
¡¬‹d_
);

61 
Ev’tLoİ
* 
loİ
 = 
ba£Loİ_
;

63 ià(!
loİs_
.
	`em±y
())

66 
loİ
 = 
loİs_
[
Ãxt_
];

67 ++
Ãxt_
;

68 ià(
im¶ic™_ÿ¡
<
size_t
>(
Ãxt_
è>ğ
loİs_
.
	`size
())

70 
Ãxt_
 = 0;

73  
loİ
;

74 
	}
}

76 
Ev’tLoİ
* 
	gEv’tLoİTh»adPoŞ
::
	$g‘LoİFÜHash
(
size_t
 
hashCode
)

78 
ba£Loİ_
->
	`as£¹InLoİTh»ad
();

79 
Ev’tLoİ
* 
loİ
 = 
ba£Loİ_
;

81 ià(!
loİs_
.
	`em±y
())

83 
loİ
 = 
loİs_
[
hashCode
 %†oİs_.
	`size
()];

85  
loİ
;

86 
	}
}

88 
	g¡d
::
veùÜ
<
Ev’tLoİ
*> 
Ev’tLoİTh»adPoŞ
::
	$g‘AÎLoİs
()

90 
ba£Loİ_
->
	`as£¹InLoİTh»ad
();

91 
	`as£¹
(
¡¬‹d_
);

92 ià(
loİs_
.
	`em±y
())

94  
¡d
::
veùÜ
<
Ev’tLoİ
*>(1, 
ba£Loİ_
);

98  
loİs_
;

100 
	}
}

	@muduo/net/EventLoopThreadPool.h

11 #iâdeà
MUDUO_NET_EVENTLOOPTHREADPOOL_H


12 
	#MUDUO_NET_EVENTLOOPTHREADPOOL_H


	)

14 
	~<muduo/ba£/Ty³s.h
>

16 
	~<veùÜ
>

17 
	~<boo¡/funùiÚ.hµ
>

18 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

21 
Çme¥aû
 
	gmuduo


24 
Çme¥aû
 
	gÃt


27 
şass
 
	gEv’tLoİ
;

28 
şass
 
	gEv’tLoİTh»ad
;

30 şas 
	cEv’tLoİTh»adPoŞ
 : 
boo¡
::
nÚcİyabË


32 
public
:

33 
boo¡
::
	tfunùiÚ
<(
	tEv’tLoİ
*)> 
	tTh»adIn™C®lback
;

35 
Ev’tLoİTh»adPoŞ
(
Ev’tLoİ
* 
ba£Loİ
, cÚ¡ 
¡ršg
& 
ÇmeArg
);

36 ~
Ev’tLoİTh»adPoŞ
();

37 
£tTh»adNum
(
numTh»ads
è{ 
	gnumTh»ads_
 =‚umThreads; }

39 
¡¬t
(cÚ¡ 
Th»adIn™C®lback
& 
cb
 = ThreadInitCallback());

43 
Ev’tLoİ
* 
g‘NextLoİ
();

46 
Ev’tLoİ
* 
g‘LoİFÜHash
(
size_t
 
hashCode
);

48 
	g¡d
::
veùÜ
<
Ev’tLoİ
*> 
g‘AÎLoİs
();

50 
boŞ
 
¡¬‹d
() const

51 {  
	g¡¬‹d_
; }

53 cÚ¡ 
	g¡ršg
& 
Çme
() const

54 {  
	gÇme_
; }

56 
	g´iv©e
:

58 
Ev’tLoİ
* 
ba£Loİ_
;

60 
¡ršg
 
	gÇme_
;

62 
boŞ
 
	g¡¬‹d_
;

64 
	gnumTh»ads_
;

66 
	gÃxt_
;

68 
	gboo¡
::
±r_veùÜ
<
Ev’tLoİTh»ad
> 
th»ads_
;

70 
	g¡d
::
veùÜ
<
Ev’tLoİ
*> 
loİs_
;

	@muduo/net/EventLoopThreadPool.h

11 #iâdeà
MUDUO_NET_EVENTLOOPTHREADPOOL_H


12 
	#MUDUO_NET_EVENTLOOPTHREADPOOL_H


	)

14 
	~<muduo/ba£/Ty³s.h
>

16 
	~<veùÜ
>

17 
	~<boo¡/funùiÚ.hµ
>

18 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

21 
Çme¥aû
 
	gmuduo


24 
Çme¥aû
 
	gÃt


27 
şass
 
	gEv’tLoİ
;

28 
şass
 
	gEv’tLoİTh»ad
;

30 şas 
	cEv’tLoİTh»adPoŞ
 : 
boo¡
::
nÚcİyabË


32 
public
:

33 
boo¡
::
	tfunùiÚ
<(
	tEv’tLoİ
*)> 
	tTh»adIn™C®lback
;

35 
Ev’tLoİTh»adPoŞ
(
Ev’tLoİ
* 
ba£Loİ
, cÚ¡ 
¡ršg
& 
ÇmeArg
);

36 ~
Ev’tLoİTh»adPoŞ
();

37 
£tTh»adNum
(
numTh»ads
è{ 
	gnumTh»ads_
 =‚umThreads; }

39 
¡¬t
(cÚ¡ 
Th»adIn™C®lback
& 
cb
 = ThreadInitCallback());

43 
Ev’tLoİ
* 
g‘NextLoİ
();

46 
Ev’tLoİ
* 
g‘LoİFÜHash
(
size_t
 
hashCode
);

48 
	g¡d
::
veùÜ
<
Ev’tLoİ
*> 
g‘AÎLoİs
();

50 
boŞ
 
¡¬‹d
() const

51 {  
	g¡¬‹d_
; }

53 cÚ¡ 
	g¡ršg
& 
Çme
() const

54 {  
	gÇme_
; }

56 
	g´iv©e
:

58 
Ev’tLoİ
* 
ba£Loİ_
;

60 
¡ršg
 
	gÇme_
;

62 
boŞ
 
	g¡¬‹d_
;

64 
	gnumTh»ads_
;

66 
	gÃxt_
;

68 
	gboo¡
::
±r_veùÜ
<
Ev’tLoİTh»ad
> 
th»ads_
;

70 
	g¡d
::
veùÜ
<
Ev’tLoİ
*> 
loİs_
;

	@muduo/net/InetAddress.cc

9 
	~<muduo/Ãt/IÃtAdd»ss.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/Ãt/EndŸn.h
>

13 
	~<muduo/Ãt/Sock‘sOps.h
>

15 
	~<Ãtdb.h
>

16 
	~<¡ršgs.h
>

17 
	~<Ãtš‘/š.h
>

19 
	~<boo¡/¡©ic_as£¹.hµ
>

22 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wold-style-cast"

23 cÚ¡ 
š_addr_t
 
	gkIÇddrAny
 = 
INADDR_ANY
;

24 cÚ¡ 
š_addr_t
 
	gkIÇddrLoİback
 = 
INADDR_LOOPBACK
;

25 #´agm¨
GCC
 
dŸgno¡ic
 
”rÜ
 "-Wold-style-cast"

48 
usšg
 
Çme¥aû
 
	gmuduo
;

49 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

51 
BOOST_STATIC_ASSERT
((
IÃtAdd»ss
è=ğ(
sockaddr_š6
));

52 
BOOST_STATIC_ASSERT
(
off£tof
(
sockaddr_š
, 
sš_çmy
) == 0);

53 
BOOST_STATIC_ASSERT
(
off£tof
(
sockaddr_š6
, 
sš6_çmy
) == 0);

54 
BOOST_STATIC_ASSERT
(
off£tof
(
sockaddr_š
, 
sš_pÜt
) == 2);

55 
BOOST_STATIC_ASSERT
(
off£tof
(
sockaddr_š6
, 
sš6_pÜt
) == 2);

57 #ià!(
__GNUC_PREREQ
 (4,6))

58 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Winvalid-offsetof"

60 
	gIÃtAdd»ss
::
	$IÃtAdd»ss
(
ušt16_t
 
pÜt
, 
boŞ
 
loİbackOÆy
, boŞ 
v6
)

62 
	`BOOST_STATIC_ASSERT
(
	`off£tof
(
IÃtAdd»ss
, 
addr6_
) == 0);

63 
	`BOOST_STATIC_ASSERT
(
	`off£tof
(
IÃtAdd»ss
, 
addr_
) == 0);

64 ià(
v6
)

66 
	`bz”o
(&
addr6_
, ‡ddr6_);

67 
addr6_
.
sš6_çmy
 = 
AF_INET6
;

68 
š6_addr
 

 = 
loİbackOÆy
 ? 
š6addr_loİback
 : 
š6addr_ªy
;

69 
addr6_
.
sš6_addr
 = 

;

70 
addr6_
.
sš6_pÜt
 = 
sock‘s
::
	`ho¡ToN‘wÜk16
(
pÜt
);

74 
	`bz”o
(&
addr_
, ‡ddr_);

75 
addr_
.
sš_çmy
 = 
AF_INET
;

76 
š_addr_t
 

 = 
loİbackOÆy
 ? 
kIÇddrLoİback
 : 
kIÇddrAny
;

77 
addr_
.
sš_addr
.
s_addr
 = 
sock‘s
::
	`ho¡ToN‘wÜk32
(

);

78 
addr_
.
sš_pÜt
 = 
sock‘s
::
	`ho¡ToN‘wÜk16
(
pÜt
);

80 
	}
}

82 
	gIÃtAdd»ss
::
	$IÃtAdd»ss
(
SŒšgArg
 

, 
ušt16_t
 
pÜt
, 
boŞ
 
v6
)

84 ià(
v6
)

86 
	`bz”o
(&
addr6_
, ‡ddr6_);

87 
sock‘s
::
	`äomIpPÜt
(

.
	`c_¡r
(), 
pÜt
, &
addr6_
);

91 
	`bz”o
(&
addr_
, ‡ddr_);

92 
sock‘s
::
	`äomIpPÜt
(

.
	`c_¡r
(), 
pÜt
, &
addr_
);

94 
	}
}

96 
¡ršg
 
	gIÃtAdd»ss
::
	$toIpPÜt
() const

98 
buf
[64] = "";

99 
sock‘s
::
	`toIpPÜt
(
buf
,  buf, 
	`g‘SockAddr
());

100  
buf
;

101 
	}
}

103 
¡ršg
 
	gIÃtAdd»ss
::
	$toIp
() const

105 
buf
[64] = "";

106 
sock‘s
::
	`toIp
(
buf
,  buf, 
	`g‘SockAddr
());

107  
buf
;

108 
	}
}

110 
ušt32_t
 
	gIÃtAdd»ss
::
	$N‘EndŸn
() const

112 
	`as£¹
(
	`çmy
(è=ğ
AF_INET
);

113  
addr_
.
sš_addr
.
s_addr
;

114 
	}
}

116 
ušt16_t
 
	gIÃtAdd»ss
::
	$toPÜt
() const

118  
sock‘s
::
	`ÃtwÜkToHo¡16
(
	`pÜtN‘EndŸn
());

119 
	}
}

121 
__th»ad
 
	gt_»sŞveBufãr
[64 * 1024];

123 
boŞ
 
	gIÃtAdd»ss
::
	$»sŞve
(
SŒšgArg
 
ho¡Çme
, 
IÃtAdd»ss
* 
out
)

125 
	`as£¹
(
out
 !ğ
NULL
);

126 
ho¡’t
 
h’t
;

127 
ho¡’t
* 
he
 = 
NULL
;

128 
h”ºo
 = 0;

129 
	`bz”o
(&
h’t
, (hent));

131 
»t
 = 
	`g‘ho¡byÇme_r
(
ho¡Çme
.
	`c_¡r
(), &
h’t
, 
t_»sŞveBufãr
, _»sŞveBufãr, &
he
, &
h”ºo
);

132 ià(
»t
 =ğ0 && 
he
 !ğ
NULL
)

134 
	`as£¹
(
he
->
h_add¹y³
 =ğ
AF_INET
 && he->
h_Ëngth
 =ğ(
ušt32_t
));

135 
out
->
addr_
.
sš_addr
 = *
»š‹½»t_ÿ¡
<
š_addr
*>(
he
->
h_addr
);

136  
Œue
;

140 ià(
»t
)

142 
LOG_SYSERR
 << "InetAddress::resolve";

144  
çl£
;

146 
	}
}

	@muduo/net/InetAddress.h

11 #iâdeà
MUDUO_NET_INETADDRESS_H


12 
	#MUDUO_NET_INETADDRESS_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

15 
	~<muduo/ba£/SŒšgP›û.h
>

17 
	~<Ãtš‘/š.h
>

19 
Çme¥aû
 
	gmuduo


21 
Çme¥aû
 
	gÃt


23 
Çme¥aû
 
	gsock‘s


25 cÚ¡ 
sockaddr
* 
sockaddr_ÿ¡
(cÚ¡ 
sockaddr_š6
* 
addr
);

32 şas 
	cIÃtAdd»ss
 : 
public
 
muduo
::
cİyabË


34 
public
:

37 
ex¶ic™
 
IÃtAdd»ss
(
ušt16_t
 
pÜt
 = 0, 
boŞ
 
loİbackOÆy
 = 
çl£
, boŞ 
v6
 = false);

41 
IÃtAdd»ss
(
SŒšgArg
 

, 
ušt16_t
 
pÜt
, 
boŞ
 
v6
 = 
çl£
);

45 
ex¶ic™
 
IÃtAdd»ss
(cÚ¡ 
sockaddr_š
& 
addr
)

46 : 
addr_
(
addr
)

49 
ex¶ic™
 
IÃtAdd»ss
(cÚ¡ 
sockaddr_š6
& 
addr
)

50 : 
addr6_
(
addr
)

53 
§_çmy_t
 
çmy
(ècÚ¡ {  
addr_
.
sš_çmy
; }

54 
¡ršg
 
toIp
() const;

55 
¡ršg
 
toIpPÜt
() const;

56 
ušt16_t
 
toPÜt
() const;

60 cÚ¡ 
sockaddr
* 
g‘SockAddr
(ècÚ¡ {  
	gsock‘s
::
sockaddr_ÿ¡
(&
addr6_
); }

61 
£tSockAddrIÃt6
(cÚ¡ 
sockaddr_š6
& 
addr6
è{ 
	gaddr6_
 =‡ddr6; }

63 
ušt32_t
 
N‘EndŸn
() const;

64 
ušt16_t
 
pÜtN‘EndŸn
(ècÚ¡ {  
	gaddr_
.
	gsš_pÜt
; }

69 
boŞ
 
»sŞve
(
SŒšgArg
 
ho¡Çme
, 
IÃtAdd»ss
* 
»suÉ
);

72 
	g´iv©e
:

75 
sockaddr_š
 
addr_
;

76 
sockaddr_š6
 
	gaddr6_
;

	@muduo/net/InetAddress.h

11 #iâdeà
MUDUO_NET_INETADDRESS_H


12 
	#MUDUO_NET_INETADDRESS_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

15 
	~<muduo/ba£/SŒšgP›û.h
>

17 
	~<Ãtš‘/š.h
>

19 
Çme¥aû
 
	gmuduo


21 
Çme¥aû
 
	gÃt


23 
Çme¥aû
 
	gsock‘s


25 cÚ¡ 
sockaddr
* 
sockaddr_ÿ¡
(cÚ¡ 
sockaddr_š6
* 
addr
);

32 şas 
	cIÃtAdd»ss
 : 
public
 
muduo
::
cİyabË


34 
public
:

37 
ex¶ic™
 
IÃtAdd»ss
(
ušt16_t
 
pÜt
 = 0, 
boŞ
 
loİbackOÆy
 = 
çl£
, boŞ 
v6
 = false);

41 
IÃtAdd»ss
(
SŒšgArg
 

, 
ušt16_t
 
pÜt
, 
boŞ
 
v6
 = 
çl£
);

45 
ex¶ic™
 
IÃtAdd»ss
(cÚ¡ 
sockaddr_š
& 
addr
)

46 : 
addr_
(
addr
)

49 
ex¶ic™
 
IÃtAdd»ss
(cÚ¡ 
sockaddr_š6
& 
addr
)

50 : 
addr6_
(
addr
)

53 
§_çmy_t
 
çmy
(ècÚ¡ {  
addr_
.
sš_çmy
; }

54 
¡ršg
 
toIp
() const;

55 
¡ršg
 
toIpPÜt
() const;

56 
ušt16_t
 
toPÜt
() const;

60 cÚ¡ 
sockaddr
* 
g‘SockAddr
(ècÚ¡ {  
	gsock‘s
::
sockaddr_ÿ¡
(&
addr6_
); }

61 
£tSockAddrIÃt6
(cÚ¡ 
sockaddr_š6
& 
addr6
è{ 
	gaddr6_
 =‡ddr6; }

63 
ušt32_t
 
N‘EndŸn
() const;

64 
ušt16_t
 
pÜtN‘EndŸn
(ècÚ¡ {  
	gaddr_
.
	gsš_pÜt
; }

69 
boŞ
 
»sŞve
(
SŒšgArg
 
ho¡Çme
, 
IÃtAdd»ss
* 
»suÉ
);

72 
	g´iv©e
:

75 
sockaddr_š
 
addr_
;

76 
sockaddr_š6
 
	gaddr6_
;

	@muduo/net/Poller.cc

9 
	~<muduo/Ãt/PŞËr.h
>

11 
	~<muduo/Ãt/ChªÃl.h
>

13 
usšg
 
Çme¥aû
 
	gmuduo
;

14 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

16 
	gPŞËr
::
	$PŞËr
(
Ev’tLoİ
* 
loİ
)

17 : 
	$owÃrLoİ_
(
loİ
)

19 
	}
}

21 
PŞËr
::~
	$PŞËr
()

23 
	}
}

25 
boŞ
 
PŞËr
::
	$hasChªÃl
(
ChªÃl
* 
chªÃl
) const

27 
	`as£¹InLoİTh»ad
();

28 
ChªÃlM­
::
cÚ¡_™”©Ü
 
™
 = 
chªÃls_
.
	`fšd
(
chªÃl
->
	`fd
());

29  
™
 !ğ
chªÃls_
.
	`’d
(è&& it->
£cÚd
 =ğ
chªÃl
;

30 
	}
}

	@muduo/net/Poller.h

11 #iâdeà
MUDUO_NET_POLLER_H


12 
	#MUDUO_NET_POLLER_H


	)

14 
	~<m­
>

15 
	~<veùÜ
>

16 
	~<boo¡/nÚcİyabË.hµ
>

18 
	~<muduo/ba£/Time¡amp.h
>

19 
	~<muduo/Ãt/Ev’tLoİ.h
>

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gÃt


26 
şass
 
	gChªÃl
;

32 şas 
	cPŞËr
 : 
boo¡
::
nÚcİyabË


34 
public
:

35 
¡d
::
	tveùÜ
<
	tChªÃl
*> 
	tChªÃlLi¡
;

37 
PŞËr
(
Ev’tLoİ
* 
loİ
);

38 
	gvœtu®
 ~
PŞËr
();

43 
vœtu®
 
Time¡amp
 
pŞl
(
timeoutMs
, 
ChªÃlLi¡
* 
aùiveChªÃls
) = 0;

48 
vœtu®
 
upd©eChªÃl
(
ChªÃl
* 
chªÃl
) = 0;

53 
vœtu®
 
»moveChªÃl
(
ChªÃl
* 
chªÃl
) = 0;

56 
vœtu®
 
boŞ
 
hasChªÃl
(
ChªÃl
* 
chªÃl
) const;

59 
PŞËr
* 
ÃwDeçuÉPŞËr
(
Ev’tLoİ
* 
loİ
);

62 
as£¹InLoİTh»ad
() const

64 
	gowÃrLoİ_
->
as£¹InLoİTh»ad
();

67 
	g´Ùeùed
:

68 
¡d
::
	tm­
<, 
	tChªÃl
*> 
	tChªÃlM­
;

69 
ChªÃlM­
 
	gchªÃls_
;

71 
	g´iv©e
:

72 
Ev’tLoİ
* 
owÃrLoİ_
;

	@muduo/net/Poller.h

11 #iâdeà
MUDUO_NET_POLLER_H


12 
	#MUDUO_NET_POLLER_H


	)

14 
	~<m­
>

15 
	~<veùÜ
>

16 
	~<boo¡/nÚcİyabË.hµ
>

18 
	~<muduo/ba£/Time¡amp.h
>

19 
	~<muduo/Ãt/Ev’tLoİ.h
>

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gÃt


26 
şass
 
	gChªÃl
;

32 şas 
	cPŞËr
 : 
boo¡
::
nÚcİyabË


34 
public
:

35 
¡d
::
	tveùÜ
<
	tChªÃl
*> 
	tChªÃlLi¡
;

37 
PŞËr
(
Ev’tLoİ
* 
loİ
);

38 
	gvœtu®
 ~
PŞËr
();

43 
vœtu®
 
Time¡amp
 
pŞl
(
timeoutMs
, 
ChªÃlLi¡
* 
aùiveChªÃls
) = 0;

48 
vœtu®
 
upd©eChªÃl
(
ChªÃl
* 
chªÃl
) = 0;

53 
vœtu®
 
»moveChªÃl
(
ChªÃl
* 
chªÃl
) = 0;

56 
vœtu®
 
boŞ
 
hasChªÃl
(
ChªÃl
* 
chªÃl
) const;

59 
PŞËr
* 
ÃwDeçuÉPŞËr
(
Ev’tLoİ
* 
loİ
);

62 
as£¹InLoİTh»ad
() const

64 
	gowÃrLoİ_
->
as£¹InLoİTh»ad
();

67 
	g´Ùeùed
:

68 
¡d
::
	tm­
<, 
	tChªÃl
*> 
	tChªÃlM­
;

69 
ChªÃlM­
 
	gchªÃls_
;

71 
	g´iv©e
:

72 
Ev’tLoİ
* 
owÃrLoİ_
;

	@muduo/net/Socket.cc

9 
	~<muduo/Ãt/Sock‘.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/Ãt/IÃtAdd»ss.h
>

13 
	~<muduo/Ãt/Sock‘sOps.h
>

15 
	~<Ãtš‘/š.h
>

16 
	~<Ãtš‘/tı.h
>

17 
	~<¡ršgs.h
>

18 
	~<¡dio.h
>

20 
usšg
 
Çme¥aû
 
	gmuduo
;

21 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

23 
	gSock‘
::~
	$Sock‘
()

25 
sock‘s
::
	`şo£
(
sockfd_
);

26 
	}
}

28 
boŞ
 
	gSock‘
::
	$g‘TıInfo
(
tı_šfo
* 
tıi
) const

30 
sockËn_t
 
Ën
 = (*
tıi
);

31 
	`bz”o
(
tıi
, 
Ën
);

32  ::
	`g‘sockİt
(
sockfd_
, 
SOL_TCP
, 
TCP_INFO
, 
tıi
, &
Ën
) == 0;

33 
	}
}

35 
boŞ
 
	gSock‘
::
	$g‘TıInfoSŒšg
(* 
buf
, 
Ën
) const

37 
tı_šfo
 
tıi
;

38 
boŞ
 
ok
 = 
	`g‘TıInfo
(&
tıi
);

39 ià(
ok
)

41 
	`¢´štf
(
buf
, 
Ën
, "unrecovered=%u "

45 
tıi
.
tıi_»Œªsm™s
,

46 
tıi
.
tıi_¹o
,

47 
tıi
.
tıi_©o
,

48 
tıi
.
tıi_¢d_mss
,

49 
tıi
.
tıi_rcv_mss
,

50 
tıi
.
tıi_lo¡
,

51 
tıi
.
tıi_»Œªs
,

52 
tıi
.
tıi_¹t
,

53 
tıi
.
tıi_¹tv¬
,

54 
tıi
.
tıi_¢d_s¡h»sh
,

55 
tıi
.
tıi_¢d_cwnd
,

56 
tıi
.
tıi_tÙ®_»Œªs
);

58  
ok
;

59 
	}
}

61 
	gSock‘
::
	$bšdAdd»ss
(cÚ¡ 
IÃtAdd»ss
& 
addr
)

63 
sock‘s
::
	`bšdOrD›
(
sockfd_
, 
addr
.
	`g‘SockAddr
());

64 
	}
}

66 
	gSock‘
::
	$li¡’
()

68 
sock‘s
::
	`li¡’OrD›
(
sockfd_
);

69 
	}
}

71 
	gSock‘
::
	$acû±
(
IÃtAdd»ss
* 
³”addr
)

73 
sockaddr_š6
 
addr
;

74 
	`bz”o
(&
addr
, ‡ddr);

75 
cÚnfd
 = 
sock‘s
::
	`acû±
(
sockfd_
, &
addr
);

76 ià(
cÚnfd
 >= 0)

78 
³”addr
->
	`£tSockAddrIÃt6
(
addr
);

80  
cÚnfd
;

81 
	}
}

83 
	gSock‘
::
	$shutdownWr™e
()

85 
sock‘s
::
	`shutdownWr™e
(
sockfd_
);

86 
	}
}

88 
	gSock‘
::
	$£tTıNoD–ay
(
boŞ
 
Ú
)

90 
İtv®
 = 
Ú
 ? 1 : 0;

91 ::
	`£tsockİt
(
sockfd_
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

92 &
İtv®
, 
¡©ic_ÿ¡
<
sockËn_t
>( optval));

94 
	}
}

96 
	gSock‘
::
	$£tReu£Addr
(
boŞ
 
Ú
)

98 
İtv®
 = 
Ú
 ? 1 : 0;

99 ::
	`£tsockİt
(
sockfd_
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

100 &
İtv®
, 
¡©ic_ÿ¡
<
sockËn_t
>( optval));

102 
	}
}

104 
	gSock‘
::
	$£tReu£PÜt
(
boŞ
 
Ú
)

106 #ifdeà
SO_REUSEPORT


107 
İtv®
 = 
Ú
 ? 1 : 0;

108 
»t
 = ::
	`£tsockİt
(
sockfd_
, 
SOL_SOCKET
, 
SO_REUSEPORT
,

109 &
İtv®
, 
¡©ic_ÿ¡
<
sockËn_t
>( optval));

110 ià(
»t
 < 0 && 
Ú
)

112 
LOG_SYSERR
 << "SO_REUSEPORT failed.";

115 ià(
Ú
)

117 
LOG_ERROR
 << "SO_REUSEPORT is‚ot supported.";

120 
	}
}

122 
	gSock‘
::
	$£tK“pAlive
(
boŞ
 
Ú
)

124 
İtv®
 = 
Ú
 ? 1 : 0;

125 ::
	`£tsockİt
(
sockfd_
, 
SOL_SOCKET
, 
SO_KEEPALIVE
,

126 &
İtv®
, 
¡©ic_ÿ¡
<
sockËn_t
>( optval));

128 
	}
}

	@muduo/net/Socket.h

11 #iâdeà
MUDUO_NET_SOCKET_H


12 
	#MUDUO_NET_SOCKET_H


	)

14 
	~<boo¡/nÚcİyabË.hµ
>

17 
	gtı_šfo
;

19 
Çme¥aû
 
	gmuduo


24 
Çme¥aû
 
	gÃt


27 
şass
 
	gIÃtAdd»ss
;

34 şas 
	cSock‘
 : 
boo¡
::
nÚcİyabË


36 
public
:

37 
ex¶ic™
 
Sock‘
(
sockfd
)

38 : 
sockfd_
(
sockfd
)

42 ~
Sock‘
();

44 
fd
(ècÚ¡ {  
	gsockfd_
; }

46 
boŞ
 
g‘TıInfo
(
tı_šfo
*) const;

47 
boŞ
 
g‘TıInfoSŒšg
(* 
buf
, 
Ën
) const;

50 
bšdAdd»ss
(cÚ¡ 
IÃtAdd»ss
& 
loÿÏddr
);

52 
li¡’
();

58 
acû±
(
IÃtAdd»ss
* 
³”addr
);

60 
shutdownWr™e
();

65 
£tTıNoD–ay
(
boŞ
 
Ú
);

70 
£tReu£Addr
(
boŞ
 
Ú
);

75 
£tReu£PÜt
(
boŞ
 
Ú
);

80 
£tK“pAlive
(
boŞ
 
Ú
);

82 
	g´iv©e
:

83 cÚ¡ 
sockfd_
;

	@muduo/net/Socket.h

11 #iâdeà
MUDUO_NET_SOCKET_H


12 
	#MUDUO_NET_SOCKET_H


	)

14 
	~<boo¡/nÚcİyabË.hµ
>

17 
	gtı_šfo
;

19 
Çme¥aû
 
	gmuduo


24 
Çme¥aû
 
	gÃt


27 
şass
 
	gIÃtAdd»ss
;

34 şas 
	cSock‘
 : 
boo¡
::
nÚcİyabË


36 
public
:

37 
ex¶ic™
 
Sock‘
(
sockfd
)

38 : 
sockfd_
(
sockfd
)

42 ~
Sock‘
();

44 
fd
(ècÚ¡ {  
	gsockfd_
; }

46 
boŞ
 
g‘TıInfo
(
tı_šfo
*) const;

47 
boŞ
 
g‘TıInfoSŒšg
(* 
buf
, 
Ën
) const;

50 
bšdAdd»ss
(cÚ¡ 
IÃtAdd»ss
& 
loÿÏddr
);

52 
li¡’
();

58 
acû±
(
IÃtAdd»ss
* 
³”addr
);

60 
shutdownWr™e
();

65 
£tTıNoD–ay
(
boŞ
 
Ú
);

70 
£tReu£Addr
(
boŞ
 
Ú
);

75 
£tReu£PÜt
(
boŞ
 
Ú
);

80 
£tK“pAlive
(
boŞ
 
Ú
);

82 
	g´iv©e
:

83 cÚ¡ 
sockfd_
;

	@muduo/net/SocketsOps.cc

9 
	~<muduo/Ãt/Sock‘sOps.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/ba£/Ty³s.h
>

13 
	~<muduo/Ãt/EndŸn.h
>

15 
	~<”ºo.h
>

16 
	~<fú.h
>

17 
	~<¡dio.h
>

18 
	~<¡ršgs.h
>

19 
	~<sys/sock‘.h
>

20 
	~<uni¡d.h
>

22 
usšg
 
Çme¥aû
 
	gmuduo
;

23 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

25 
	gÇme¥aû


28 
sockaddr
 
	tSA
;

31 #ià
VALGRIND
 || 
defšed
 (
NO_ACCEPT4
)

32 
£tNÚBlockAndClo£OnExec
(
sockfd
)

35 
	gæags
 = ::
fú
(
sockfd
, 
F_GETFL
, 0);

36 
	gæags
 |ğ
O_NONBLOCK
;

37 
	g»t
 = ::
fú
(
sockfd
, 
F_SETFL
, 
æags
);

41 
	gæags
 = ::
fú
(
sockfd
, 
F_GETFD
, 0);

42 
	gæags
 |ğ
FD_CLOEXEC
;

43 
	g»t
 = ::
fú
(
sockfd
, 
F_SETFD
, 
æags
);

46 ()
	g»t
;

52 cÚ¡ 
sockaddr
* 
	gsock‘s
::
	$sockaddr_ÿ¡
(cÚ¡ 
sockaddr_š6
* 
addr
)

54  
¡©ic_ÿ¡
<cÚ¡ 
sockaddr
*>(
im¶ic™_ÿ¡
<cÚ¡ *>(
addr
));

55 
	}
}

57 
sockaddr
* 
	gsock‘s
::
	$sockaddr_ÿ¡
(
sockaddr_š6
* 
addr
)

59  
¡©ic_ÿ¡
<
sockaddr
*>(
im¶ic™_ÿ¡
<*>(
addr
));

60 
	}
}

62 cÚ¡ 
sockaddr
* 
	gsock‘s
::
	$sockaddr_ÿ¡
(cÚ¡ 
sockaddr_š
* 
addr
)

64  
¡©ic_ÿ¡
<cÚ¡ 
sockaddr
*>(
im¶ic™_ÿ¡
<cÚ¡ *>(
addr
));

65 
	}
}

67 cÚ¡ 
sockaddr_š
* 
	gsock‘s
::
	$sockaddr_š_ÿ¡
(cÚ¡ 
sockaddr
* 
addr
)

69  
¡©ic_ÿ¡
<cÚ¡ 
sockaddr_š
*>(
im¶ic™_ÿ¡
<cÚ¡ *>(
addr
));

70 
	}
}

72 cÚ¡ 
sockaddr_š6
* 
	gsock‘s
::
	$sockaddr_š6_ÿ¡
(cÚ¡ 
sockaddr
* 
addr
)

74  
¡©ic_ÿ¡
<cÚ¡ 
sockaddr_š6
*>(
im¶ic™_ÿ¡
<cÚ¡ *>(
addr
));

75 
	}
}

77 
	gsock‘s
::
	$ü—‹NÚblockšgOrD›
(
§_çmy_t
 
çmy
)

79 #ià
VALGRIND


80 
sockfd
 = ::
	`sock‘
(
çmy
, 
SOCK_STREAM
, 
IPPROTO_TCP
);

81 ià(
sockfd
 < 0)

83 
LOG_SYSFATAL
 << "sockets::createNonblockingOrDie";

86 
	`£tNÚBlockAndClo£OnExec
(
sockfd
);

88 
sockfd
 = ::
	`sock‘
(
çmy
, 
SOCK_STREAM
 | 
SOCK_NONBLOCK
 | 
SOCK_CLOEXEC
, 
IPPROTO_TCP
);

89 ià(
sockfd
 < 0)

91 
LOG_SYSFATAL
 << "sockets::createNonblockingOrDie";

94  
sockfd
;

95 
	}
}

97 
	gsock‘s
::
	$bšdOrD›
(
sockfd
, cÚ¡ 
sockaddr
* 
addr
)

99 
»t
 = ::
	`bšd
(
sockfd
, 
addr
, 
¡©ic_ÿ¡
<
sockËn_t
>((
sockaddr_š6
)));

100 ià(
»t
 < 0)

102 
LOG_SYSFATAL
 << "sockets::bindOrDie";

104 
	}
}

106 
	gsock‘s
::
	$li¡’OrD›
(
sockfd
)

108 
»t
 = ::
	`li¡’
(
sockfd
, 
SOMAXCONN
);

109 ià(
»t
 < 0)

111 
LOG_SYSFATAL
 << "sockets::listenOrDie";

113 
	}
}

115 
	gsock‘s
::
	$acû±
(
sockfd
, 
sockaddr_š6
* 
addr
)

117 
sockËn_t
 
add¾’
 = 
¡©ic_ÿ¡
<sockËn_t>( *
addr
);

118 #ià
VALGRIND
 || 
	`defšed
 (
NO_ACCEPT4
)

119 
cÚnfd
 = ::
	`acû±
(
sockfd
, 
	`sockaddr_ÿ¡
(
addr
), &
add¾’
);

120 
	`£tNÚBlockAndClo£OnExec
(
cÚnfd
);

122 
cÚnfd
 = ::
	`acû±4
(
sockfd
, 
	`sockaddr_ÿ¡
(
addr
),

123 &
add¾’
, 
SOCK_NONBLOCK
 | 
SOCK_CLOEXEC
);

125 ià(
cÚnfd
 < 0)

127 
§vedE¼no
 = 
”ºo
;

128 
LOG_SYSERR
 << "Socket::accept";

129 
§vedE¼no
)

131 
EAGAIN
:

132 
ECONNABORTED
:

133 
EINTR
:

134 
EPROTO
:

135 
EPERM
:

136 
EMFILE
:

138 
”ºo
 = 
§vedE¼no
;

140 
EBADF
:

141 
EFAULT
:

142 
EINVAL
:

143 
ENFILE
:

144 
ENOBUFS
:

145 
ENOMEM
:

146 
ENOTSOCK
:

147 
EOPNOTSUPP
:

149 
LOG_FATAL
 << "uÃx³ùedƒ¼Ü oà::acû± " << 
§vedE¼no
;

152 
LOG_FATAL
 << "unknowÀ”rÜ oà::acû± " << 
§vedE¼no
;

156  
cÚnfd
;

157 
	}
}

159 
	gsock‘s
::
	$cÚÃù
(
sockfd
, cÚ¡ 
sockaddr
* 
addr
)

161  ::
	`cÚÃù
(
sockfd
, 
addr
, 
¡©ic_ÿ¡
<
sockËn_t
>((
sockaddr_š6
)));

162 
	}
}

164 
ssize_t
 
	gsock‘s
::
	$»ad
(
sockfd
, *
buf
, 
size_t
 
couÁ
)

166  ::
	`»ad
(
sockfd
, 
buf
, 
couÁ
);

167 
	}
}

169 
ssize_t
 
	gsock‘s
::
	$»adv
(
sockfd
, cÚ¡ 
iovec
 *
iov
, 
iovút
)

171  ::
	`»adv
(
sockfd
, 
iov
, 
iovút
);

172 
	}
}

174 
ssize_t
 
	gsock‘s
::
	$wr™e
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

176  ::
	`wr™e
(
sockfd
, 
buf
, 
couÁ
);

177 
	}
}

179 
	gsock‘s
::
	$şo£
(
sockfd
)

181 ià(::
	`şo£
(
sockfd
) < 0)

183 
LOG_SYSERR
 << "sockets::close";

185 
	}
}

187 
	gsock‘s
::
	$shutdownWr™e
(
sockfd
)

189 ià(::
	`shutdown
(
sockfd
, 
SHUT_WR
) < 0)

191 
LOG_SYSERR
 << "sockets::shutdownWrite";

193 
	}
}

195 
	gsock‘s
::
	$toIpPÜt
(* 
buf
, 
size_t
 
size
,

196 cÚ¡ 
sockaddr
* 
addr
)

198 
	`toIp
(
buf
,
size
, 
addr
);

199 
size_t
 
’d
 = ::
	`¡¾’
(
buf
);

200 cÚ¡ 
sockaddr_š
* 
addr4
 = 
	`sockaddr_š_ÿ¡
(
addr
);

201 
ušt16_t
 
pÜt
 = 
sock‘s
::
	`ÃtwÜkToHo¡16
(
addr4
->
sš_pÜt
);

202 
	`as£¹
(
size
 > 
’d
);

203 
	`¢´štf
(
buf
+
’d
, 
size
-’d, ":%u", 
pÜt
);

204 
	}
}

206 
	gsock‘s
::
	$toIp
(* 
buf
, 
size_t
 
size
,

207 cÚ¡ 
sockaddr
* 
addr
)

209 ià(
addr
->
§_çmy
 =ğ
AF_INET
)

211 
	`as£¹
(
size
 >ğ
INET_ADDRSTRLEN
);

212 cÚ¡ 
sockaddr_š
* 
addr4
 = 
	`sockaddr_š_ÿ¡
(
addr
);

213 ::
	`š‘_Áİ
(
AF_INET
, &
addr4
->
sš_addr
, 
buf
, 
¡©ic_ÿ¡
<
sockËn_t
>(
size
));

215 ià(
addr
->
§_çmy
 =ğ
AF_INET6
)

217 
	`as£¹
(
size
 >ğ
INET6_ADDRSTRLEN
);

218 cÚ¡ 
sockaddr_š6
* 
addr6
 = 
	`sockaddr_š6_ÿ¡
(
addr
);

219 ::
	`š‘_Áİ
(
AF_INET6
, &
addr6
->
sš6_addr
, 
buf
, 
¡©ic_ÿ¡
<
sockËn_t
>(
size
));

221 
	}
}

223 
	gsock‘s
::
	$äomIpPÜt
(cÚ¡ * 

, 
ušt16_t
 
pÜt
,

224 
sockaddr_š
* 
addr
)

226 
addr
->
sš_çmy
 = 
AF_INET
;

227 
addr
->
sš_pÜt
 = 
	`ho¡ToN‘wÜk16
(
pÜt
);

228 ià(::
	`š‘_±Ú
(
AF_INET
, 

, &
addr
->
sš_addr
) <= 0)

230 
LOG_SYSERR
 << "sockets::fromIpPort";

232 
	}
}

234 
	gsock‘s
::
	$äomIpPÜt
(cÚ¡ * 

, 
ušt16_t
 
pÜt
,

235 
sockaddr_š6
* 
addr
)

237 
addr
->
sš6_çmy
 = 
AF_INET6
;

238 
addr
->
sš6_pÜt
 = 
	`ho¡ToN‘wÜk16
(
pÜt
);

239 ià(::
	`š‘_±Ú
(
AF_INET6
, 

, &
addr
->
sš6_addr
) <= 0)

241 
LOG_SYSERR
 << "sockets::fromIpPort";

243 
	}
}

245 
	gsock‘s
::
	$g‘Sock‘E¼Ü
(
sockfd
)

247 
İtv®
;

248 
sockËn_t
 
İ’
 = 
¡©ic_ÿ¡
<sockËn_t>( 
İtv®
);

250 ià(::
	`g‘sockİt
(
sockfd
, 
SOL_SOCKET
, 
SO_ERROR
, &
İtv®
, &
İ’
) < 0)

252  
”ºo
;

256  
İtv®
;

258 
	}
}

260 
sockaddr_š6
 
	gsock‘s
::
	$g‘LoÿlAddr
(
sockfd
)

262 
sockaddr_š6
 
loÿÏddr
;

263 
	`bz”o
(&
loÿÏddr
, †ocaladdr);

264 
sockËn_t
 
add¾’
 = 
¡©ic_ÿ¡
<sockËn_t>( 
loÿÏddr
);

265 ià(::
	`g‘sockÇme
(
sockfd
, 
	`sockaddr_ÿ¡
(&
loÿÏddr
), &
add¾’
) < 0)

267 
LOG_SYSERR
 << "sockets::getLocalAddr";

269  
loÿÏddr
;

270 
	}
}

272 
sockaddr_š6
 
	gsock‘s
::
	$g‘P“rAddr
(
sockfd
)

274 
sockaddr_š6
 
³”addr
;

275 
	`bz”o
(&
³”addr
, …eeraddr);

276 
sockËn_t
 
add¾’
 = 
¡©ic_ÿ¡
<sockËn_t>( 
³”addr
);

277 ià(::
	`g‘³”Çme
(
sockfd
, 
	`sockaddr_ÿ¡
(&
³”addr
), &
add¾’
) < 0)

279 
LOG_SYSERR
 << "sockets::getPeerAddr";

281  
³”addr
;

282 
	}
}

284 #ià!(
__GNUC_PREREQ
 (4,6))

285 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wstrict-aliasing"

287 
boŞ
 
	gsock‘s
::
	$isS–fCÚÃù
(
sockfd
)

289 
sockaddr_š6
 
loÿÏddr
 = 
	`g‘LoÿlAddr
(
sockfd
);

290 
sockaddr_š6
 
³”addr
 = 
	`g‘P“rAddr
(
sockfd
);

291 ià(
loÿÏddr
.
sš6_çmy
 =ğ
AF_INET
)

293 cÚ¡ 
sockaddr_š
* 
Ïddr4
 = 
»š‹½»t_ÿ¡
<sockaddr_š*>(&
loÿÏddr
);

294 cÚ¡ 
sockaddr_š
* 
¿ddr4
 = 
»š‹½»t_ÿ¡
<sockaddr_š*>(&
³”addr
);

295  
Ïddr4
->
sš_pÜt
 =ğ
¿ddr4
->sin_port

296 && 
Ïddr4
->
sš_addr
.
s_addr
 =ğ
¿ddr4
->sin_addr.s_addr;

298 ià(
loÿÏddr
.
sš6_çmy
 =ğ
AF_INET6
)

300  
loÿÏddr
.
sš6_pÜt
 =ğ
³”addr
.sin6_port

301 && 
	`memcmp
(&
loÿÏddr
.
sš6_addr
, &
³”addr
.sin6_addr, †ocaladdr.sin6_addr) == 0;

305  
çl£
;

307 
	}
}

	@muduo/net/SocketsOps.h

11 #iâdeà
MUDUO_NET_SOCKETSOPS_H


12 
	#MUDUO_NET_SOCKETSOPS_H


	)

14 
	~<¬·/š‘.h
>

16 
Çme¥aû
 
	gmuduo


18 
Çme¥aû
 
	gÃt


20 
Çme¥aû
 
	gsock‘s


26 
ü—‹NÚblockšgOrD›
(
§_çmy_t
 
çmy
);

28 
cÚÃù
(
sockfd
, cÚ¡ 
sockaddr
* 
addr
);

29 
bšdOrD›
(
sockfd
, cÚ¡ 
sockaddr
* 
addr
);

30 
li¡’OrD›
(
sockfd
);

31 
acû±
(
sockfd
, 
sockaddr_š6
* 
addr
);

32 
ssize_t
 
»ad
(
sockfd
, *
buf
, 
size_t
 
couÁ
);

33 
ssize_t
 
»adv
(
sockfd
, cÚ¡ 
iovec
 *
iov
, 
iovút
);

34 
ssize_t
 
wr™e
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

35 
şo£
(
sockfd
);

36 
shutdownWr™e
(
sockfd
);

38 
toIpPÜt
(* 
buf
, 
size_t
 
size
,

39 cÚ¡ 
sockaddr
* 
addr
);

40 
toIp
(* 
buf
, 
size_t
 
size
,

41 cÚ¡ 
sockaddr
* 
addr
);

43 
äomIpPÜt
(cÚ¡ * 

, 
ušt16_t
 
pÜt
,

44 
sockaddr_š
* 
addr
);

45 
äomIpPÜt
(cÚ¡ * 

, 
ušt16_t
 
pÜt
,

46 
sockaddr_š6
* 
addr
);

48 
g‘Sock‘E¼Ü
(
sockfd
);

50 cÚ¡ 
sockaddr
* 
sockaddr_ÿ¡
(cÚ¡ 
sockaddr_š
* 
addr
);

51 cÚ¡ 
sockaddr
* 
sockaddr_ÿ¡
(cÚ¡ 
sockaddr_š6
* 
addr
);

52 
sockaddr
* 
sockaddr_ÿ¡
(
sockaddr_š6
* 
addr
);

53 cÚ¡ 
sockaddr_š
* 
sockaddr_š_ÿ¡
(cÚ¡ 
sockaddr
* 
addr
);

54 cÚ¡ 
sockaddr_š6
* 
sockaddr_š6_ÿ¡
(cÚ¡ 
sockaddr
* 
addr
);

56 
sockaddr_š6
 
g‘LoÿlAddr
(
sockfd
);

57 
sockaddr_š6
 
g‘P“rAddr
(
sockfd
);

58 
boŞ
 
isS–fCÚÃù
(
sockfd
);

	@muduo/net/SocketsOps.h

11 #iâdeà
MUDUO_NET_SOCKETSOPS_H


12 
	#MUDUO_NET_SOCKETSOPS_H


	)

14 
	~<¬·/š‘.h
>

16 
Çme¥aû
 
	gmuduo


18 
Çme¥aû
 
	gÃt


20 
Çme¥aû
 
	gsock‘s


26 
ü—‹NÚblockšgOrD›
(
§_çmy_t
 
çmy
);

28 
cÚÃù
(
sockfd
, cÚ¡ 
sockaddr
* 
addr
);

29 
bšdOrD›
(
sockfd
, cÚ¡ 
sockaddr
* 
addr
);

30 
li¡’OrD›
(
sockfd
);

31 
acû±
(
sockfd
, 
sockaddr_š6
* 
addr
);

32 
ssize_t
 
»ad
(
sockfd
, *
buf
, 
size_t
 
couÁ
);

33 
ssize_t
 
»adv
(
sockfd
, cÚ¡ 
iovec
 *
iov
, 
iovút
);

34 
ssize_t
 
wr™e
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

35 
şo£
(
sockfd
);

36 
shutdownWr™e
(
sockfd
);

38 
toIpPÜt
(* 
buf
, 
size_t
 
size
,

39 cÚ¡ 
sockaddr
* 
addr
);

40 
toIp
(* 
buf
, 
size_t
 
size
,

41 cÚ¡ 
sockaddr
* 
addr
);

43 
äomIpPÜt
(cÚ¡ * 

, 
ušt16_t
 
pÜt
,

44 
sockaddr_š
* 
addr
);

45 
äomIpPÜt
(cÚ¡ * 

, 
ušt16_t
 
pÜt
,

46 
sockaddr_š6
* 
addr
);

48 
g‘Sock‘E¼Ü
(
sockfd
);

50 cÚ¡ 
sockaddr
* 
sockaddr_ÿ¡
(cÚ¡ 
sockaddr_š
* 
addr
);

51 cÚ¡ 
sockaddr
* 
sockaddr_ÿ¡
(cÚ¡ 
sockaddr_š6
* 
addr
);

52 
sockaddr
* 
sockaddr_ÿ¡
(
sockaddr_š6
* 
addr
);

53 cÚ¡ 
sockaddr_š
* 
sockaddr_š_ÿ¡
(cÚ¡ 
sockaddr
* 
addr
);

54 cÚ¡ 
sockaddr_š6
* 
sockaddr_š6_ÿ¡
(cÚ¡ 
sockaddr
* 
addr
);

56 
sockaddr_š6
 
g‘LoÿlAddr
(
sockfd
);

57 
sockaddr_š6
 
g‘P“rAddr
(
sockfd
);

58 
boŞ
 
isS–fCÚÃù
(
sockfd
);

	@muduo/net/TcpClient.cc

10 
	~<muduo/Ãt/TıCl›Á.h
>

12 
	~<muduo/ba£/Loggšg.h
>

13 
	~<muduo/Ãt/CÚÃùÜ.h
>

14 
	~<muduo/Ãt/Ev’tLoİ.h
>

15 
	~<muduo/Ãt/Sock‘sOps.h
>

17 
	~<boo¡/bšd.hµ
>

19 
	~<¡dio.h
>

21 
usšg
 
Çme¥aû
 
	gmuduo
;

22 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

35 
Çme¥aû
 
	gmuduo


37 
Çme¥aû
 
	gÃt


39 
Çme¥aû
 
	gd‘a


42 
»moveCÚÃùiÚ
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

44 
	gloİ
->
queueInLoİ
(
boo¡
::
bšd
(&
TıCÚÃùiÚ
::
cÚÃùDe¡royed
, 
cÚn
));

47 
»moveCÚÃùÜ
(cÚ¡ 
CÚÃùÜPŒ
& 
cÚÃùÜ
)

56 
	gTıCl›Á
::
	$TıCl›Á
(
Ev’tLoİ
* 
loİ
,

57 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

58 cÚ¡ 
¡ršg
& 
ÇmeArg
)

59 : 
	`loİ_
(
	`CHECK_NOTNULL
(
loİ
)),

60 
	`cÚÃùÜ_
(
Ãw
 
	`CÚÃùÜ
(
loİ
, 
£rv”Addr
)),

61 
	`Çme_
(
ÇmeArg
),

62 
	`cÚÃùiÚC®lback_
(
deçuÉCÚÃùiÚC®lback
),

63 
	`mes§geC®lback_
(
deçuÉMes§geC®lback
),

64 
	`»Œy_
(
çl£
),

65 
	`cÚÃù_
(
Œue
),

66 
	$ÃxtCÚnId_
(1)

68 
cÚÃùÜ_
->
	`£tNewCÚÃùiÚC®lback
(

69 
boo¡
::
	`bšd
(&
TıCl›Á
::
ÃwCÚÃùiÚ
, 
this
, 
_1
));

71 
LOG_INFO
 << "TıCl›Á::TıCl›Á[" << 
Çme_


72 << "] - cÚÃùÜ " << 
	`g‘_poš‹r
(
cÚÃùÜ_
);

73 
	}
}

75 
	gTıCl›Á
::~
	$TıCl›Á
()

77 
LOG_INFO
 << "TıCl›Á::~TıCl›Á[" << 
Çme_


78 << "] - cÚÃùÜ " << 
	`g‘_poš‹r
(
cÚÃùÜ_
);

79 
TıCÚÃùiÚPŒ
 
cÚn
;

80 
boŞ
 
unique
 = 
çl£
;

82 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

83 
unique
 = 
cÚÃùiÚ_
.
	`unique
();

84 
cÚn
 = 
cÚÃùiÚ_
;

86 ià(
cÚn
)

88 
	`as£¹
(
loİ_
 =ğ
cÚn
->
	`g‘Loİ
());

90 
Clo£C®lback
 
cb
 = 
boo¡
::
	`bšd
(&
d‘a
::
»moveCÚÃùiÚ
, 
loİ_
, 
_1
);

91 
loİ_
->
	`runInLoİ
(

92 
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
£tClo£C®lback
, 
cÚn
, 
cb
));

93 ià(
unique
)

95 
cÚn
->
	`fÜûClo£
();

100 
cÚÃùÜ_
->
	`¡İ
();

102 
loİ_
->
	`runAá”
(1, 
boo¡
::
	`bšd
(&
d‘a
::
»moveCÚÃùÜ
, 
cÚÃùÜ_
));

104 
	}
}

106 
	gTıCl›Á
::
	$cÚÃù
()

109 
LOG_INFO
 << "TıCl›Á::cÚÃù[" << 
Çme_
 << "] - connectingo "

110 << 
cÚÃùÜ_
->
	`£rv”Add»ss
().
	`toIpPÜt
();

111 
cÚÃù_
 = 
Œue
;

112 
cÚÃùÜ_
->
	`¡¬t
();

113 
	}
}

115 
	gTıCl›Á
::
	$discÚÃù
()

117 
cÚÃù_
 = 
çl£
;

120 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

121 ià(
cÚÃùiÚ_
)

123 
cÚÃùiÚ_
->
	`shutdown
();

126 
	}
}

128 
	gTıCl›Á
::
	$¡İ
()

130 
cÚÃù_
 = 
çl£
;

131 
cÚÃùÜ_
->
	`¡İ
();

132 
	}
}

134 
	gTıCl›Á
::
	$ÃwCÚÃùiÚ
(
sockfd
)

136 
loİ_
->
	`as£¹InLoİTh»ad
();

137 
IÃtAdd»ss
 
	`³”Addr
(
sock‘s
::
	`g‘P“rAddr
(
sockfd
));

138 
buf
[32];

139 
	`¢´štf
(
buf
,  buf, ":%s#%d", 
³”Addr
.
	`toIpPÜt
().
	`c_¡r
(), 
ÃxtCÚnId_
);

140 ++
ÃxtCÚnId_
;

141 
¡ršg
 
cÚnName
 = 
Çme_
 + 
buf
;

143 
IÃtAdd»ss
 
	`loÿlAddr
(
sock‘s
::
	`g‘LoÿlAddr
(
sockfd
));

146 
TıCÚÃùiÚPŒ
 
	`cÚn
(
Ãw
 
	`TıCÚÃùiÚ
(
loİ_
,

147 
cÚnName
,

148 
sockfd
,

149 
loÿlAddr
,

150 
³”Addr
));

152 
cÚn
->
	`£tCÚÃùiÚC®lback
(
cÚÃùiÚC®lback_
);

153 
cÚn
->
	`£tMes§geC®lback
(
mes§geC®lback_
);

154 
cÚn
->
	`£tWr™eCom¶‘eC®lback
(
wr™eCom¶‘eC®lback_
);

155 
cÚn
->
	`£tClo£C®lback
(

156 
boo¡
::
	`bšd
(&
TıCl›Á
::
»moveCÚÃùiÚ
, 
this
, 
_1
));

158 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

159 
cÚÃùiÚ_
 = 
cÚn
;

161 
cÚn
->
	`cÚÃùE¡ablished
();

162 
	}
}

164 
	gTıCl›Á
::
	$»moveCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

166 
loİ_
->
	`as£¹InLoİTh»ad
();

167 
	`as£¹
(
loİ_
 =ğ
cÚn
->
	`g‘Loİ
());

170 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

171 
	`as£¹
(
cÚÃùiÚ_
 =ğ
cÚn
);

172 
cÚÃùiÚ_
.
	`»£t
();

175 
loİ_
->
	`queueInLoİ
(
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
cÚÃùDe¡royed
, 
cÚn
));

176 ià(
»Œy_
 && 
cÚÃù_
)

178 
LOG_INFO
 << "TıCl›Á::cÚÃù[" << 
Çme_
 << "] - Reconnectingo "

179 << 
cÚÃùÜ_
->
	`£rv”Add»ss
().
	`toIpPÜt
();

180 
cÚÃùÜ_
->
	`»¡¬t
();

182 
	}
}

	@muduo/net/TcpClient.h

11 #iâdeà
MUDUO_NET_TCPCLIENT_H


12 
	#MUDUO_NET_TCPCLIENT_H


	)

14 
	~<boo¡/nÚcİyabË.hµ
>

16 
	~<muduo/ba£/Mu‹x.h
>

17 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

19 
Çme¥aû
 
	gmuduo


21 
Çme¥aû
 
	gÃt


24 
şass
 
	gCÚÃùÜ
;

25 
	gboo¡
::
	tsh¬ed_±r
<
	tCÚÃùÜ
> 
	tCÚÃùÜPŒ
;

27 şas 
	cTıCl›Á
 : 
boo¡
::
nÚcİyabË


29 
public
:

32 
TıCl›Á
(
Ev’tLoİ
* 
loİ
,

33 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

34 cÚ¡ 
¡ršg
& 
ÇmeArg
);

35 ~
TıCl›Á
();

37 
cÚÃù
();

38 
discÚÃù
();

39 
¡İ
();

41 
TıCÚÃùiÚPŒ
 
cÚÃùiÚ
() const

43 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

44  
	gcÚÃùiÚ_
;

47 
Ev’tLoİ
* 
g‘Loİ
(ècÚ¡ {  
	gloİ_
; }

48 
boŞ
 
»Œy
(ècÚ¡ {  
	g»Œy_
; }

49 
’abËR‘ry
(è{ 
	g»Œy_
 = 
Œue
; }

51 cÚ¡ 
	g¡ršg
& 
Çme
() const

52 {  
	gÇme_
; }

56 
£tCÚÃùiÚC®lback
(cÚ¡ 
CÚÃùiÚC®lback
& 
cb
)

57 { 
	gcÚÃùiÚC®lback_
 = 
cb
; }

61 
£tMes§geC®lback
(cÚ¡ 
Mes§geC®lback
& 
cb
)

62 { 
	gmes§geC®lback_
 = 
cb
; }

66 
£tWr™eCom¶‘eC®lback
(cÚ¡ 
Wr™eCom¶‘eC®lback
& 
cb
)

67 { 
	gwr™eCom¶‘eC®lback_
 = 
cb
; }

69 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


70 
£tCÚÃùiÚC®lback
(
CÚÃùiÚC®lback
&& 
cb
)

71 { 
	gcÚÃùiÚC®lback_
 = 
¡d
::
move
(
cb
); }

72 
£tMes§geC®lback
(
Mes§geC®lback
&& 
cb
)

73 { 
	gmes§geC®lback_
 = 
¡d
::
move
(
cb
); }

74 
£tWr™eCom¶‘eC®lback
(
Wr™eCom¶‘eC®lback
&& 
cb
)

75 { 
	gwr™eCom¶‘eC®lback_
 = 
¡d
::
move
(
cb
); }

78 
	g´iv©e
:

80 
ÃwCÚÃùiÚ
(
sockfd
);

82 
»moveCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

84 
Ev’tLoİ
* 
	gloİ_
;

85 
CÚÃùÜPŒ
 
	gcÚÃùÜ_
;

86 cÚ¡ 
¡ršg
 
	gÇme_
;

87 
CÚÃùiÚC®lback
 
	gcÚÃùiÚC®lback_
;

88 
Mes§geC®lback
 
	gmes§geC®lback_
;

89 
Wr™eCom¶‘eC®lback
 
	gwr™eCom¶‘eC®lback_
;

90 
boŞ
 
	g»Œy_
;

91 
boŞ
 
	gcÚÃù_
;

93 
	gÃxtCÚnId_
;

94 
mubË
 
Mu‹xLock
 
	gmu‹x_
;

95 
TıCÚÃùiÚPŒ
 
	gcÚÃùiÚ_
;

	@muduo/net/TcpClient.h

11 #iâdeà
MUDUO_NET_TCPCLIENT_H


12 
	#MUDUO_NET_TCPCLIENT_H


	)

14 
	~<boo¡/nÚcİyabË.hµ
>

16 
	~<muduo/ba£/Mu‹x.h
>

17 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

19 
Çme¥aû
 
	gmuduo


21 
Çme¥aû
 
	gÃt


24 
şass
 
	gCÚÃùÜ
;

25 
	gboo¡
::
	tsh¬ed_±r
<
	tCÚÃùÜ
> 
	tCÚÃùÜPŒ
;

27 şas 
	cTıCl›Á
 : 
boo¡
::
nÚcİyabË


29 
public
:

32 
TıCl›Á
(
Ev’tLoİ
* 
loİ
,

33 cÚ¡ 
IÃtAdd»ss
& 
£rv”Addr
,

34 cÚ¡ 
¡ršg
& 
ÇmeArg
);

35 ~
TıCl›Á
();

37 
cÚÃù
();

38 
discÚÃù
();

39 
¡İ
();

41 
TıCÚÃùiÚPŒ
 
cÚÃùiÚ
() const

43 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

44  
	gcÚÃùiÚ_
;

47 
Ev’tLoİ
* 
g‘Loİ
(ècÚ¡ {  
	gloİ_
; }

48 
boŞ
 
»Œy
(ècÚ¡ {  
	g»Œy_
; }

49 
’abËR‘ry
(è{ 
	g»Œy_
 = 
Œue
; }

51 cÚ¡ 
	g¡ršg
& 
Çme
() const

52 {  
	gÇme_
; }

56 
£tCÚÃùiÚC®lback
(cÚ¡ 
CÚÃùiÚC®lback
& 
cb
)

57 { 
	gcÚÃùiÚC®lback_
 = 
cb
; }

61 
£tMes§geC®lback
(cÚ¡ 
Mes§geC®lback
& 
cb
)

62 { 
	gmes§geC®lback_
 = 
cb
; }

66 
£tWr™eCom¶‘eC®lback
(cÚ¡ 
Wr™eCom¶‘eC®lback
& 
cb
)

67 { 
	gwr™eCom¶‘eC®lback_
 = 
cb
; }

69 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


70 
£tCÚÃùiÚC®lback
(
CÚÃùiÚC®lback
&& 
cb
)

71 { 
	gcÚÃùiÚC®lback_
 = 
¡d
::
move
(
cb
); }

72 
£tMes§geC®lback
(
Mes§geC®lback
&& 
cb
)

73 { 
	gmes§geC®lback_
 = 
¡d
::
move
(
cb
); }

74 
£tWr™eCom¶‘eC®lback
(
Wr™eCom¶‘eC®lback
&& 
cb
)

75 { 
	gwr™eCom¶‘eC®lback_
 = 
¡d
::
move
(
cb
); }

78 
	g´iv©e
:

80 
ÃwCÚÃùiÚ
(
sockfd
);

82 
»moveCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

84 
Ev’tLoİ
* 
	gloİ_
;

85 
CÚÃùÜPŒ
 
	gcÚÃùÜ_
;

86 cÚ¡ 
¡ršg
 
	gÇme_
;

87 
CÚÃùiÚC®lback
 
	gcÚÃùiÚC®lback_
;

88 
Mes§geC®lback
 
	gmes§geC®lback_
;

89 
Wr™eCom¶‘eC®lback
 
	gwr™eCom¶‘eC®lback_
;

90 
boŞ
 
	g»Œy_
;

91 
boŞ
 
	gcÚÃù_
;

93 
	gÃxtCÚnId_
;

94 
mubË
 
Mu‹xLock
 
	gmu‹x_
;

95 
TıCÚÃùiÚPŒ
 
	gcÚÃùiÚ_
;

	@muduo/net/TcpConnection.cc

9 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/ba£/W—kC®lback.h
>

13 
	~<muduo/Ãt/ChªÃl.h
>

14 
	~<muduo/Ãt/Ev’tLoİ.h
>

15 
	~<muduo/Ãt/Sock‘.h
>

16 
	~<muduo/Ãt/Sock‘sOps.h
>

18 
	~<boo¡/bšd.hµ
>

20 
	~<”ºo.h
>

22 
usšg
 
Çme¥aû
 
	gmuduo
;

23 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

25 
	gmuduo
::
Ãt
::
	$deçuÉCÚÃùiÚC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

27 
LOG_TRACE
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

28 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

29 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

31 
	}
}

33 
	gmuduo
::
Ãt
::
	$deçuÉMes§geC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

34 
Bufãr
* 
buf
,

35 
Time¡amp
)

37 
buf
->
	`»Œ›veAÎ
();

38 
	}
}

40 
	gTıCÚÃùiÚ
::
	$TıCÚÃùiÚ
(
Ev’tLoİ
* 
loİ
,

41 cÚ¡ 
¡ršg
& 
ÇmeArg
,

42 
sockfd
,

43 cÚ¡ 
IÃtAdd»ss
& 
loÿlAddr
,

44 cÚ¡ 
IÃtAdd»ss
& 
³”Addr
)

45 : 
	`loİ_
(
	`CHECK_NOTNULL
(
loİ
)),

46 
	`Çme_
(
ÇmeArg
),

47 
	`¡©e_
(
kCÚÃùšg
),

48 
	`»adšg_
(
Œue
),

49 
	`sock‘_
(
Ãw
 
	`Sock‘
(
sockfd
)),

50 
	`chªÃl_
(
Ãw
 
	`ChªÃl
(
loİ
, 
sockfd
)),

51 
	`loÿlAddr_
(
loÿlAddr
),

52 
	`³”Addr_
(
³”Addr
),

53 
	$highW©”M¬k_
(64*1024*1024)

55 
chªÃl_
->
	`£tR—dC®lback
(

56 
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
hªdËR—d
, 
this
, 
_1
));

57 
chªÃl_
->
	`£tWr™eC®lback
(

58 
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
hªdËWr™e
, 
this
));

59 
chªÃl_
->
	`£tClo£C®lback
(

60 
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
hªdËClo£
, 
this
));

61 
chªÃl_
->
	`£tE¼ÜC®lback
(

62 
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
hªdËE¼Ü
, 
this
));

63 
LOG_DEBUG
 << "TıCÚÃùiÚ::ùÜ[" << 
Çme_
 << "]‡ˆ" << 
this


64 << " fd=" << 
sockfd
;

65 
sock‘_
->
	`£tK“pAlive
(
Œue
);

66 
	}
}

68 
	gTıCÚÃùiÚ
::~
	$TıCÚÃùiÚ
()

70 
LOG_DEBUG
 << "TıCÚÃùiÚ::dtÜ[" << 
Çme_
 << "]‡ˆ" << 
this


71 << " fd=" << 
chªÃl_
->
	`fd
()

72 << " s‹=" << 
	`¡©eToSŒšg
();

73 
	`as£¹
(
¡©e_
 =ğ
kDiscÚÃùed
);

74 
	}
}

76 
boŞ
 
	gTıCÚÃùiÚ
::
	$g‘TıInfo
(
tı_šfo
* 
tıi
) const

78  
sock‘_
->
	`g‘TıInfo
(
tıi
);

79 
	}
}

81 
¡ršg
 
	gTıCÚÃùiÚ
::
	$g‘TıInfoSŒšg
() const

83 
buf
[1024];

84 
buf
[0] = '\0';

85 
sock‘_
->
	`g‘TıInfoSŒšg
(
buf
,  buf);

86  
buf
;

87 
	}
}

89 
	gTıCÚÃùiÚ
::
	$£nd
(cÚ¡ * 
d©a
, 
Ën
)

91 
	`£nd
(
	`SŒšgP›û
(
¡©ic_ÿ¡
<cÚ¡ *>(
d©a
), 
Ën
));

92 
	}
}

94 
	gTıCÚÃùiÚ
::
	$£nd
(cÚ¡ 
SŒšgP›û
& 
mes§ge
)

96 ià(
¡©e_
 =ğ
kCÚÃùed
)

98 ià(
loİ_
->
	`isInLoİTh»ad
())

100 
	`£ndInLoİ
(
mes§ge
);

104 
loİ_
->
	`runInLoİ
(

105 
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
£ndInLoİ
,

106 
this
,

107 
mes§ge
.
	`as_¡ršg
()));

111 
	}
}

114 
	gTıCÚÃùiÚ
::
	$£nd
(
Bufãr
* 
buf
)

116 ià(
¡©e_
 =ğ
kCÚÃùed
)

118 ià(
loİ_
->
	`isInLoİTh»ad
())

120 
	`£ndInLoİ
(
buf
->
	`³ek
(), buf->
	`»adabËBy‹s
());

121 
buf
->
	`»Œ›veAÎ
();

125 
loİ_
->
	`runInLoİ
(

126 
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
£ndInLoİ
,

127 
this
,

128 
buf
->
	`»Œ›veAÎAsSŒšg
()));

132 
	}
}

134 
	gTıCÚÃùiÚ
::
	$£ndInLoİ
(cÚ¡ 
SŒšgP›û
& 
mes§ge
)

136 
	`£ndInLoİ
(
mes§ge
.
	`d©a
(), mes§ge.
	`size
());

137 
	}
}

139 
	gTıCÚÃùiÚ
::
	$£ndInLoİ
(cÚ¡ * 
d©a
, 
size_t
 
Ën
)

141 
loİ_
->
	`as£¹InLoİTh»ad
();

142 
ssize_t
 
nwrÙe
 = 0;

143 
size_t
 
»maššg
 = 
Ën
;

144 
boŞ
 
çuÉE¼Ü
 = 
çl£
;

145 ià(
¡©e_
 =ğ
kDiscÚÃùed
)

147 
LOG_WARN
 << "disconnected, give up writing";

151 ià(!
chªÃl_
->
	`isWr™šg
(è&& 
ouutBufãr_
.
	`»adabËBy‹s
() == 0)

153 
nwrÙe
 = 
sock‘s
::
	`wr™e
(
chªÃl_
->
	`fd
(), 
d©a
, 
Ën
);

154 ià(
nwrÙe
 >= 0)

156 
»maššg
 = 
Ën
 - 
nwrÙe
;

157 ià(
»maššg
 =ğ0 && 
wr™eCom¶‘eC®lback_
)

159 
loİ_
->
	`queueInLoİ
(
boo¡
::
	`bšd
(
wr™eCom¶‘eC®lback_
, 
	`sh¬ed_äom_this
()));

164 
nwrÙe
 = 0;

165 ià(
”ºo
 !ğ
EWOULDBLOCK
)

167 
LOG_SYSERR
 << "TcpConnection::sendInLoop";

168 ià(
”ºo
 =ğ
EPIPE
 ||ƒ¼nØ=ğ
ECONNRESET
)

170 
çuÉE¼Ü
 = 
Œue
;

176 
	`as£¹
(
»maššg
 <ğ
Ën
);

177 ià(!
çuÉE¼Ü
 && 
»maššg
 > 0)

179 
size_t
 
ŞdL’
 = 
ouutBufãr_
.
	`»adabËBy‹s
();

180 ià(
ŞdL’
 + 
»maššg
 >ğ
highW©”M¬k_


181 && 
ŞdL’
 < 
highW©”M¬k_


182 && 
highW©”M¬kC®lback_
)

184 
loİ_
->
	`queueInLoİ
(
boo¡
::
	`bšd
(
highW©”M¬kC®lback_
, 
	`sh¬ed_äom_this
(), 
ŞdL’
 + 
»maššg
));

186 
ouutBufãr_
.
	`­³nd
(
¡©ic_ÿ¡
<cÚ¡ *>(
d©a
)+
nwrÙe
, 
»maššg
);

187 ià(!
chªÃl_
->
	`isWr™šg
())

189 
chªÃl_
->
	`’abËWr™šg
();

192 
	}
}

194 
	gTıCÚÃùiÚ
::
	$shutdown
()

197 ià(
¡©e_
 =ğ
kCÚÃùed
)

199 
	`£tS‹
(
kDiscÚÃùšg
);

201 
loİ_
->
	`runInLoİ
(
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
shutdownInLoİ
, 
this
));

203 
	}
}

205 
	gTıCÚÃùiÚ
::
	$shutdownInLoİ
()

207 
loİ_
->
	`as£¹InLoİTh»ad
();

208 ià(!
chªÃl_
->
	`isWr™šg
())

211 
sock‘_
->
	`shutdownWr™e
();

213 
	}
}

239 
	gTıCÚÃùiÚ
::
	$fÜûClo£
()

242 ià(
¡©e_
 =ğ
kCÚÃùed
 || s‹_ =ğ
kDiscÚÃùšg
)

244 
	`£tS‹
(
kDiscÚÃùšg
);

245 
loİ_
->
	`queueInLoİ
(
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
fÜûClo£InLoİ
, 
	`sh¬ed_äom_this
()));

247 
	}
}

249 
	gTıCÚÃùiÚ
::
	$fÜûClo£W™hD–ay
(
£cÚds
)

251 ià(
¡©e_
 =ğ
kCÚÃùed
 || s‹_ =ğ
kDiscÚÃùšg
)

253 
	`£tS‹
(
kDiscÚÃùšg
);

254 
loİ_
->
	`runAá”
(

255 
£cÚds
,

256 
	`makeW—kC®lback
(
	`sh¬ed_äom_this
(),

257 &
TıCÚÃùiÚ
::
fÜûClo£
));

259 
	}
}

261 
	gTıCÚÃùiÚ
::
	$fÜûClo£InLoİ
()

263 
loİ_
->
	`as£¹InLoİTh»ad
();

264 ià(
¡©e_
 =ğ
kCÚÃùed
 || s‹_ =ğ
kDiscÚÃùšg
)

267 
	`hªdËClo£
();

269 
	}
}

271 cÚ¡ * 
	gTıCÚÃùiÚ
::
	$¡©eToSŒšg
() const

273 
¡©e_
)

275 
kDiscÚÃùed
:

277 
kCÚÃùšg
:

279 
kCÚÃùed
:

281 
kDiscÚÃùšg
:

286 
	}
}

288 
	gTıCÚÃùiÚ
::
	$£tTıNoD–ay
(
boŞ
 
Ú
)

290 
sock‘_
->
	`£tTıNoD–ay
(
Ú
);

291 
	}
}

293 
	gTıCÚÃùiÚ
::
	$¡¬tR—d
()

295 
loİ_
->
	`runInLoİ
(
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
¡¬tR—dInLoİ
, 
this
));

296 
	}
}

298 
	gTıCÚÃùiÚ
::
	$¡¬tR—dInLoİ
()

300 
loİ_
->
	`as£¹InLoİTh»ad
();

301 ià(!
»adšg_
 || !
chªÃl_
->
	`isR—dšg
())

303 
chªÃl_
->
	`’abËR—dšg
();

304 
»adšg_
 = 
Œue
;

306 
	}
}

308 
	gTıCÚÃùiÚ
::
	$¡İR—d
()

310 
loİ_
->
	`runInLoİ
(
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
¡İR—dInLoİ
, 
this
));

311 
	}
}

313 
	gTıCÚÃùiÚ
::
	$¡İR—dInLoİ
()

315 
loİ_
->
	`as£¹InLoİTh»ad
();

316 ià(
»adšg_
 || 
chªÃl_
->
	`isR—dšg
())

318 
chªÃl_
->
	`di§bËR—dšg
();

319 
»adšg_
 = 
çl£
;

321 
	}
}

323 
	gTıCÚÃùiÚ
::
	$cÚÃùE¡ablished
()

325 
loİ_
->
	`as£¹InLoİTh»ad
();

326 
	`as£¹
(
¡©e_
 =ğ
kCÚÃùšg
);

327 
	`£tS‹
(
kCÚÃùed
);

328 
chªÃl_
->
	`t›
(
	`sh¬ed_äom_this
());

329 
chªÃl_
->
	`’abËR—dšg
();

331 
	`cÚÃùiÚC®lback_
(
	`sh¬ed_äom_this
());

332 
	}
}

334 
	gTıCÚÃùiÚ
::
	$cÚÃùDe¡royed
()

336 
loİ_
->
	`as£¹InLoİTh»ad
();

337 ià(
¡©e_
 =ğ
kCÚÃùed
)

339 
	`£tS‹
(
kDiscÚÃùed
);

340 
chªÃl_
->
	`di§bËAÎ
();

342 
	`cÚÃùiÚC®lback_
(
	`sh¬ed_äom_this
());

344 
chªÃl_
->
	`»move
();

345 
	}
}

347 
	gTıCÚÃùiÚ
::
	$hªdËR—d
(
Time¡amp
 
»ûiveTime
)

349 
loİ_
->
	`as£¹InLoİTh»ad
();

350 
§vedE¼no
 = 0;

351 
ssize_t
 
n
 = 
šputBufãr_
.
	`»adFd
(
chªÃl_
->
	`fd
(), &
§vedE¼no
);

352 ià(
n
 > 0)

354 
	`mes§geC®lback_
(
	`sh¬ed_äom_this
(), &
šputBufãr_
, 
»ûiveTime
);

356 ià(
n
 == 0)

358 
	`hªdËClo£
();

362 
”ºo
 = 
§vedE¼no
;

363 
LOG_SYSERR
 << "TcpConnection::handleRead";

364 
	`hªdËE¼Ü
();

366 
	}
}

368 
	gTıCÚÃùiÚ
::
	$hªdËWr™e
()

370 
loİ_
->
	`as£¹InLoİTh»ad
();

371 ià(
chªÃl_
->
	`isWr™šg
())

373 
ssize_t
 
n
 = 
sock‘s
::
	`wr™e
(
chªÃl_
->
	`fd
(),

374 
ouutBufãr_
.
	`³ek
(),

375 
ouutBufãr_
.
	`»adabËBy‹s
());

376 ià(
n
 > 0)

378 
ouutBufãr_
.
	`»Œ›ve
(
n
);

379 ià(
ouutBufãr_
.
	`»adabËBy‹s
() == 0)

381 
chªÃl_
->
	`di§bËWr™šg
();

382 ià(
wr™eCom¶‘eC®lback_
)

384 
loİ_
->
	`queueInLoİ
(
boo¡
::
	`bšd
(
wr™eCom¶‘eC®lback_
, 
	`sh¬ed_äom_this
()));

386 ià(
¡©e_
 =ğ
kDiscÚÃùšg
)

388 
	`shutdownInLoİ
();

394 
LOG_SYSERR
 << "TcpConnection::handleWrite";

403 
LOG_TRACE
 << "CÚÃùiÚ fd = " << 
chªÃl_
->
	`fd
()

406 
	}
}

408 
	gTıCÚÃùiÚ
::
	$hªdËClo£
()

410 
loİ_
->
	`as£¹InLoİTh»ad
();

411 
LOG_TRACE
 << "fd = " << 
chªÃl_
->
	`fd
(è<< " s‹ = " << 
	`¡©eToSŒšg
();

412 
	`as£¹
(
¡©e_
 =ğ
kCÚÃùed
 || s‹_ =ğ
kDiscÚÃùšg
);

414 
	`£tS‹
(
kDiscÚÃùed
);

415 
chªÃl_
->
	`di§bËAÎ
();

417 
TıCÚÃùiÚPŒ
 
	`gu¬dThis
(
	`sh¬ed_äom_this
());

418 
	`cÚÃùiÚC®lback_
(
gu¬dThis
);

420 
	`şo£C®lback_
(
gu¬dThis
);

421 
	}
}

423 
	gTıCÚÃùiÚ
::
	$hªdËE¼Ü
()

425 
”r
 = 
sock‘s
::
	`g‘Sock‘E¼Ü
(
chªÃl_
->
	`fd
());

426 
LOG_ERROR
 << "TıCÚÃùiÚ::hªdËE¼Ü [" << 
Çme_


427 << "] - SO_ERROR = " << 
”r
 << " " << 
	`¡»¼Ü_
(err);

428 
	}
}

	@muduo/net/TcpConnection.h

11 #iâdeà
MUDUO_NET_TCPCONNECTION_H


12 
	#MUDUO_NET_TCPCONNECTION_H


	)

14 
	~<muduo/ba£/SŒšgP›û.h
>

15 
	~<muduo/ba£/Ty³s.h
>

16 
	~<muduo/Ãt/C®lbacks.h
>

17 
	~<muduo/Ãt/Bufãr.h
>

18 
	~<muduo/Ãt/IÃtAdd»ss.h
>

20 
	~<boo¡/ªy.hµ
>

21 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

22 
	~<boo¡/nÚcİyabË.hµ
>

23 
	~<boo¡/scİed_±r.hµ
>

24 
	~<boo¡/sh¬ed_±r.hµ
>

27 
	gtı_šfo
;

29 
Çme¥aû
 
	gmuduo


31 
Çme¥aû
 
	gÃt


34 
şass
 
	gChªÃl
;

35 
şass
 
	gEv’tLoİ
;

36 
şass
 
	gSock‘
;

42 
şass
 
	gTıCÚÃùiÚ
 : 
boo¡
::
nÚcİyabË
,

43 
public
 
	gboo¡
::
’abË_sh¬ed_äom_this
<
TıCÚÃùiÚ
>

45 
public
:

49 
TıCÚÃùiÚ
(
Ev’tLoİ
* 
loİ
,

50 cÚ¡ 
¡ršg
& 
Çme
,

51 
sockfd
,

52 cÚ¡ 
IÃtAdd»ss
& 
loÿlAddr
,

53 cÚ¡ 
IÃtAdd»ss
& 
³”Addr
);

54 ~
TıCÚÃùiÚ
();

56 
Ev’tLoİ
* 
g‘Loİ
(ècÚ¡ {  
	gloİ_
; }

57 cÚ¡ 
	g¡ršg
& 
Çme
(ècÚ¡ {  
	gÇme_
; }

58 cÚ¡ 
	gIÃtAdd»ss
& 
loÿlAdd»ss
(ècÚ¡ {  
	gloÿlAddr_
; }

59 cÚ¡ 
	gIÃtAdd»ss
& 
³”Add»ss
(ècÚ¡ {  
	g³”Addr_
; }

60 
boŞ
 
cÚÃùed
(ècÚ¡ {  
	g¡©e_
 =ğ
kCÚÃùed
; }

61 
boŞ
 
discÚÃùed
(ècÚ¡ {  
	g¡©e_
 =ğ
kDiscÚÃùed
; }

63 
boŞ
 
g‘TıInfo
(
tı_šfo
*) const;

64 
¡ršg
 
g‘TıInfoSŒšg
() const;

67 
£nd
(cÚ¡ * 
mes§ge
, 
Ën
);

68 
£nd
(cÚ¡ 
SŒšgP›û
& 
mes§ge
);

70 
£nd
(
Bufãr
* 
mes§ge
);

71 
shutdown
();

73 
fÜûClo£
();

74 
fÜûClo£W™hD–ay
(
£cÚds
);

75 
£tTıNoD–ay
(
boŞ
 
Ú
);

77 
¡¬tR—d
();

78 
¡İR—d
();

79 
boŞ
 
isR—dšg
(ècÚ¡ {  
	g»adšg_
; };

81 
£tCÚ‹xt
(cÚ¡ 
boo¡
::
ªy
& 
cÚ‹xt
)

82 { 
cÚ‹xt_
 = 
cÚ‹xt
; }

84 cÚ¡ 
	gboo¡
::
ªy
& 
g‘CÚ‹xt
() const

85 {  
cÚ‹xt_
; }

87 
	gboo¡
::
ªy
* 
g‘MubËCÚ‹xt
()

88 {  &
cÚ‹xt_
; }

90 
£tCÚÃùiÚC®lback
(cÚ¡ 
CÚÃùiÚC®lback
& 
cb
)

91 { 
	gcÚÃùiÚC®lback_
 = 
cb
; }

93 
£tMes§geC®lback
(cÚ¡ 
Mes§geC®lback
& 
cb
)

94 { 
	gmes§geC®lback_
 = 
cb
; }

96 
£tWr™eCom¶‘eC®lback
(cÚ¡ 
Wr™eCom¶‘eC®lback
& 
cb
)

97 { 
	gwr™eCom¶‘eC®lback_
 = 
cb
; }

99 
£tHighW©”M¬kC®lback
(cÚ¡ 
HighW©”M¬kC®lback
& 
cb
, 
size_t
 
highW©”M¬k
)

100 { 
	ghighW©”M¬kC®lback_
 = 
cb
; 
	ghighW©”M¬k_
 = 
highW©”M¬k
; }

103 
Bufãr
* 
šputBufãr
()

104 {  &
	gšputBufãr_
; }

106 
Bufãr
* 
ouutBufãr
()

107 {  &
	gouutBufãr_
; }

110 
£tClo£C®lback
(cÚ¡ 
Clo£C®lback
& 
cb
)

111 { 
	gşo£C®lback_
 = 
cb
; }

114 
cÚÃùE¡ablished
();

116 
cÚÃùDe¡royed
();

118 
	g´iv©e
:

119 
	eS‹E
 { 
kDiscÚÃùed
, 
	gkCÚÃùšg
, 
	gkCÚÃùed
, 
	gkDiscÚÃùšg
 };

120 
hªdËR—d
(
Time¡amp
 
»ûiveTime
);

121 
hªdËWr™e
();

122 
hªdËClo£
();

123 
hªdËE¼Ü
();

125 
£ndInLoİ
(cÚ¡ 
SŒšgP›û
& 
mes§ge
);

126 
£ndInLoİ
(cÚ¡ * 
mes§ge
, 
size_t
 
Ën
);

127 
shutdownInLoİ
();

129 
fÜûClo£InLoİ
();

130 
£tS‹
(
S‹E
 
s
è{ 
	g¡©e_
 = s; }

131 cÚ¡ * 
¡©eToSŒšg
() const;

132 
¡¬tR—dInLoİ
();

133 
¡İR—dInLoİ
();

135 
Ev’tLoİ
* 
	gloİ_
;

136 cÚ¡ 
¡ršg
 
	gÇme_
;

137 
S‹E
 
	g¡©e_
;

138 
boŞ
 
	g»adšg_
;

140 
	gboo¡
::
scİed_±r
<
Sock‘
> 
sock‘_
;

141 
	gboo¡
::
scİed_±r
<
ChªÃl
> 
chªÃl_
;

142 cÚ¡ 
IÃtAdd»ss
 
	gloÿlAddr_
;

143 cÚ¡ 
IÃtAdd»ss
 
	g³”Addr_
;

144 
CÚÃùiÚC®lback
 
	gcÚÃùiÚC®lback_
;

145 
Mes§geC®lback
 
	gmes§geC®lback_
;

146 
Wr™eCom¶‘eC®lback
 
	gwr™eCom¶‘eC®lback_
;

147 
HighW©”M¬kC®lback
 
	ghighW©”M¬kC®lback_
;

148 
Clo£C®lback
 
	gşo£C®lback_
;

149 
size_t
 
	ghighW©”M¬k_
;

150 
Bufãr
 
	gšputBufãr_
;

151 
Bufãr
 
	gouutBufãr_
;

152 
	gboo¡
::
ªy
 
cÚ‹xt_
;

157 
	gboo¡
::
	tsh¬ed_±r
<
	tTıCÚÃùiÚ
> 
	tTıCÚÃùiÚPŒ
;

	@muduo/net/TcpConnection.h

11 #iâdeà
MUDUO_NET_TCPCONNECTION_H


12 
	#MUDUO_NET_TCPCONNECTION_H


	)

14 
	~<muduo/ba£/SŒšgP›û.h
>

15 
	~<muduo/ba£/Ty³s.h
>

16 
	~<muduo/Ãt/C®lbacks.h
>

17 
	~<muduo/Ãt/Bufãr.h
>

18 
	~<muduo/Ãt/IÃtAdd»ss.h
>

20 
	~<boo¡/ªy.hµ
>

21 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

22 
	~<boo¡/nÚcİyabË.hµ
>

23 
	~<boo¡/scİed_±r.hµ
>

24 
	~<boo¡/sh¬ed_±r.hµ
>

27 
	gtı_šfo
;

29 
Çme¥aû
 
	gmuduo


31 
Çme¥aû
 
	gÃt


34 
şass
 
	gChªÃl
;

35 
şass
 
	gEv’tLoİ
;

36 
şass
 
	gSock‘
;

42 
şass
 
	gTıCÚÃùiÚ
 : 
boo¡
::
nÚcİyabË
,

43 
public
 
	gboo¡
::
’abË_sh¬ed_äom_this
<
TıCÚÃùiÚ
>

45 
public
:

49 
TıCÚÃùiÚ
(
Ev’tLoİ
* 
loİ
,

50 cÚ¡ 
¡ršg
& 
Çme
,

51 
sockfd
,

52 cÚ¡ 
IÃtAdd»ss
& 
loÿlAddr
,

53 cÚ¡ 
IÃtAdd»ss
& 
³”Addr
);

54 ~
TıCÚÃùiÚ
();

56 
Ev’tLoİ
* 
g‘Loİ
(ècÚ¡ {  
	gloİ_
; }

57 cÚ¡ 
	g¡ršg
& 
Çme
(ècÚ¡ {  
	gÇme_
; }

58 cÚ¡ 
	gIÃtAdd»ss
& 
loÿlAdd»ss
(ècÚ¡ {  
	gloÿlAddr_
; }

59 cÚ¡ 
	gIÃtAdd»ss
& 
³”Add»ss
(ècÚ¡ {  
	g³”Addr_
; }

60 
boŞ
 
cÚÃùed
(ècÚ¡ {  
	g¡©e_
 =ğ
kCÚÃùed
; }

61 
boŞ
 
discÚÃùed
(ècÚ¡ {  
	g¡©e_
 =ğ
kDiscÚÃùed
; }

63 
boŞ
 
g‘TıInfo
(
tı_šfo
*) const;

64 
¡ršg
 
g‘TıInfoSŒšg
() const;

67 
£nd
(cÚ¡ * 
mes§ge
, 
Ën
);

68 
£nd
(cÚ¡ 
SŒšgP›û
& 
mes§ge
);

70 
£nd
(
Bufãr
* 
mes§ge
);

71 
shutdown
();

73 
fÜûClo£
();

74 
fÜûClo£W™hD–ay
(
£cÚds
);

75 
£tTıNoD–ay
(
boŞ
 
Ú
);

77 
¡¬tR—d
();

78 
¡İR—d
();

79 
boŞ
 
isR—dšg
(ècÚ¡ {  
	g»adšg_
; };

81 
£tCÚ‹xt
(cÚ¡ 
boo¡
::
ªy
& 
cÚ‹xt
)

82 { 
cÚ‹xt_
 = 
cÚ‹xt
; }

84 cÚ¡ 
	gboo¡
::
ªy
& 
g‘CÚ‹xt
() const

85 {  
cÚ‹xt_
; }

87 
	gboo¡
::
ªy
* 
g‘MubËCÚ‹xt
()

88 {  &
cÚ‹xt_
; }

90 
£tCÚÃùiÚC®lback
(cÚ¡ 
CÚÃùiÚC®lback
& 
cb
)

91 { 
	gcÚÃùiÚC®lback_
 = 
cb
; }

93 
£tMes§geC®lback
(cÚ¡ 
Mes§geC®lback
& 
cb
)

94 { 
	gmes§geC®lback_
 = 
cb
; }

96 
£tWr™eCom¶‘eC®lback
(cÚ¡ 
Wr™eCom¶‘eC®lback
& 
cb
)

97 { 
	gwr™eCom¶‘eC®lback_
 = 
cb
; }

99 
£tHighW©”M¬kC®lback
(cÚ¡ 
HighW©”M¬kC®lback
& 
cb
, 
size_t
 
highW©”M¬k
)

100 { 
	ghighW©”M¬kC®lback_
 = 
cb
; 
	ghighW©”M¬k_
 = 
highW©”M¬k
; }

103 
Bufãr
* 
šputBufãr
()

104 {  &
	gšputBufãr_
; }

106 
Bufãr
* 
ouutBufãr
()

107 {  &
	gouutBufãr_
; }

110 
£tClo£C®lback
(cÚ¡ 
Clo£C®lback
& 
cb
)

111 { 
	gşo£C®lback_
 = 
cb
; }

114 
cÚÃùE¡ablished
();

116 
cÚÃùDe¡royed
();

118 
	g´iv©e
:

119 
	eS‹E
 { 
kDiscÚÃùed
, 
	gkCÚÃùšg
, 
	gkCÚÃùed
, 
	gkDiscÚÃùšg
 };

120 
hªdËR—d
(
Time¡amp
 
»ûiveTime
);

121 
hªdËWr™e
();

122 
hªdËClo£
();

123 
hªdËE¼Ü
();

125 
£ndInLoİ
(cÚ¡ 
SŒšgP›û
& 
mes§ge
);

126 
£ndInLoİ
(cÚ¡ * 
mes§ge
, 
size_t
 
Ën
);

127 
shutdownInLoİ
();

129 
fÜûClo£InLoİ
();

130 
£tS‹
(
S‹E
 
s
è{ 
	g¡©e_
 = s; }

131 cÚ¡ * 
¡©eToSŒšg
() const;

132 
¡¬tR—dInLoİ
();

133 
¡İR—dInLoİ
();

135 
Ev’tLoİ
* 
	gloİ_
;

136 cÚ¡ 
¡ršg
 
	gÇme_
;

137 
S‹E
 
	g¡©e_
;

138 
boŞ
 
	g»adšg_
;

140 
	gboo¡
::
scİed_±r
<
Sock‘
> 
sock‘_
;

141 
	gboo¡
::
scİed_±r
<
ChªÃl
> 
chªÃl_
;

142 cÚ¡ 
IÃtAdd»ss
 
	gloÿlAddr_
;

143 cÚ¡ 
IÃtAdd»ss
 
	g³”Addr_
;

144 
CÚÃùiÚC®lback
 
	gcÚÃùiÚC®lback_
;

145 
Mes§geC®lback
 
	gmes§geC®lback_
;

146 
Wr™eCom¶‘eC®lback
 
	gwr™eCom¶‘eC®lback_
;

147 
HighW©”M¬kC®lback
 
	ghighW©”M¬kC®lback_
;

148 
Clo£C®lback
 
	gşo£C®lback_
;

149 
size_t
 
	ghighW©”M¬k_
;

150 
Bufãr
 
	gšputBufãr_
;

151 
Bufãr
 
	gouutBufãr_
;

152 
	gboo¡
::
ªy
 
cÚ‹xt_
;

157 
	gboo¡
::
	tsh¬ed_±r
<
	tTıCÚÃùiÚ
> 
	tTıCÚÃùiÚPŒ
;

	@muduo/net/TcpServer.cc

9 
	~<muduo/Ãt/TıS”v”.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/Ãt/Acû±Ü.h
>

13 
	~<muduo/Ãt/Ev’tLoİ.h
>

14 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

15 
	~<muduo/Ãt/Sock‘sOps.h
>

17 
	~<boo¡/bšd.hµ
>

19 
	~<¡dio.h
>

21 
usšg
 
Çme¥aû
 
	gmuduo
;

22 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

25 
	gTıS”v”
::

26 
	$TıS”v”
(
Ev’tLoİ
* 
loİ
,

27 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

28 cÚ¡ 
¡ršg
& 
ÇmeArg
,

29 
O±iÚ
 
İtiÚ
)

30 : 
	`loİ_
(
	`CHECK_NOTNULL
(
loİ
)),

31 
	`PÜt_
(
li¡’Addr
.
	`toIpPÜt
()),

32 
	`Çme_
(
ÇmeArg
),

33 
	`acû±Ü_
(
Ãw
 
	`Acû±Ü
(
loİ
, 
li¡’Addr
, 
İtiÚ
 =ğ
kReu£PÜt
)),

34 
	`th»adPoŞ_
(
Ãw
 
	`Ev’tLoİTh»adPoŞ
(
loİ
, 
Çme_
)),

35 
	`cÚÃùiÚC®lback_
(
deçuÉCÚÃùiÚC®lback
),

36 
	`mes§geC®lback_
(
deçuÉMes§geC®lback
),

37 
	$ÃxtCÚnId_
(1)

39 
acû±Ü_
->
	`£tNewCÚÃùiÚC®lback
(

40 
boo¡
::
	`bšd
(&
TıS”v”
::
ÃwCÚÃùiÚ
, 
this
, 
_1
, 
_2
));

41 
	}
}

43 
	gTıS”v”
::~
	$TıS”v”
()

45 
loİ_
->
	`as£¹InLoİTh»ad
();

46 
LOG_TRACE
 << "TıS”v”::~TıS”v” [" << 
Çme_
 << "] destructing";

48 
CÚÃùiÚM­
::
™”©Ü
 
	`™
(
cÚÃùiÚs_
.
	`begš
());

49 
™
 !ğ
cÚÃùiÚs_
.
	`’d
(); ++it)

51 
TıCÚÃùiÚPŒ
 
	`cÚn
(
™
->
£cÚd
);

52 
™
->
£cÚd
.
	`»£t
();

53 
cÚn
->
	`g‘Loİ
()->
	`runInLoİ
(

54 
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
cÚÃùDe¡royed
, 
cÚn
));

56 
	}
}

58 
	gTıS”v”
::
	$£tTh»adNum
(
numTh»ads
)

60 
	`as£¹
(0 <ğ
numTh»ads
);

61 
th»adPoŞ_
->
	`£tTh»adNum
(
numTh»ads
);

62 
	}
}

65 
	gTıS”v”
::
	$¡¬t
()

67 ià(
¡¬‹d_
.
	`g‘AndS‘
(1) == 0)

69 
th»adPoŞ_
->
	`¡¬t
(
th»adIn™C®lback_
);

71 
	`as£¹
(!
acû±Ü_
->
	`li¡’nšg
());

72 
loİ_
->
	`runInLoİ
(

73 
boo¡
::
	`bšd
(&
Acû±Ü
::
li¡’
, 
	`g‘_poš‹r
(
acû±Ü_
)));

75 
	}
}

77 
	gTıS”v”
::
	$ÃwCÚÃùiÚ
(
sockfd
, cÚ¡ 
IÃtAdd»ss
& 
³”Addr
)

79 
loİ_
->
	`as£¹InLoİTh»ad
();

80 
Ev’tLoİ
* 
ioLoİ
 = 
th»adPoŞ_
->
	`g‘NextLoİ
();

81 
buf
[64];

82 
	`¢´štf
(
buf
,  buf, "-%s#%d", 
PÜt_
.
	`c_¡r
(), 
ÃxtCÚnId_
);

83 ++
ÃxtCÚnId_
;

84 
¡ršg
 
cÚnName
 = 
Çme_
 + 
buf
;

86 
LOG_INFO
 << "TıS”v”::ÃwCÚÃùiÚ [" << 
Çme_


87 << "] -‚ew cÚÃùiÚ [" << 
cÚnName


88 << "] from " << 
³”Addr
.
	`toIpPÜt
();

89 
IÃtAdd»ss
 
	`loÿlAddr
(
sock‘s
::
	`g‘LoÿlAddr
(
sockfd
));

92 
TıCÚÃùiÚPŒ
 
	`cÚn
(
Ãw
 
	`TıCÚÃùiÚ
(
ioLoİ
,

93 
cÚnName
,

94 
sockfd
,

95 
loÿlAddr
,

96 
³”Addr
));

97 
cÚÃùiÚs_
[
cÚnName
] = 
cÚn
;

98 
cÚn
->
	`£tCÚÃùiÚC®lback
(
cÚÃùiÚC®lback_
);

99 
cÚn
->
	`£tMes§geC®lback
(
mes§geC®lback_
);

100 
cÚn
->
	`£tWr™eCom¶‘eC®lback
(
wr™eCom¶‘eC®lback_
);

101 
cÚn
->
	`£tClo£C®lback
(

102 
boo¡
::
	`bšd
(&
TıS”v”
::
»moveCÚÃùiÚ
, 
this
, 
_1
));

103 
ioLoİ
->
	`runInLoİ
(
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
cÚÃùE¡ablished
, 
cÚn
));

104 
	}
}

106 
	gTıS”v”
::
	$»moveCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

109 
loİ_
->
	`runInLoİ
(
boo¡
::
	`bšd
(&
TıS”v”
::
»moveCÚÃùiÚInLoİ
, 
this
, 
cÚn
));

110 
	}
}

112 
	gTıS”v”
::
	$»moveCÚÃùiÚInLoİ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

114 
loİ_
->
	`as£¹InLoİTh»ad
();

115 
LOG_INFO
 << "TıS”v”::»moveCÚÃùiÚInLoİ [" << 
Çme_


116 << "] - cÚÃùiÚ " << 
cÚn
->
	`Çme
();

117 
size_t
 
n
 = 
cÚÃùiÚs_
.
	`”a£
(
cÚn
->
	`Çme
());

118 ()
n
;

119 
	`as£¹
(
n
 == 1);

120 
Ev’tLoİ
* 
ioLoİ
 = 
cÚn
->
	`g‘Loİ
();

121 
ioLoİ
->
	`queueInLoİ
(

122 
boo¡
::
	`bšd
(&
TıCÚÃùiÚ
::
cÚÃùDe¡royed
, 
cÚn
));

123 
	}
}

	@muduo/net/TcpServer.h

11 #iâdeà
MUDUO_NET_TCPSERVER_H


12 
	#MUDUO_NET_TCPSERVER_H


	)

14 
	~<muduo/ba£/Atomic.h
>

15 
	~<muduo/ba£/Ty³s.h
>

16 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

18 
	~<m­
>

19 
	~<boo¡/nÚcİyabË.hµ
>

20 
	~<boo¡/scİed_±r.hµ
>

21 
	~<boo¡/sh¬ed_±r.hµ
>

23 
Çme¥aû
 
	gmuduo


25 
Çme¥aû
 
	gÃt


28 
şass
 
	gAcû±Ü
;

29 
şass
 
	gEv’tLoİ
;

30 
şass
 
	gEv’tLoİTh»adPoŞ
;

36 şas 
	cTıS”v”
 : 
boo¡
::
nÚcİyabË


38 
public
:

39 
boo¡
::
	tfunùiÚ
<(
	tEv’tLoİ
*)> 
	tTh»adIn™C®lback
;

40 
	eO±iÚ


42 
	gkNoReu£PÜt
,

43 
	gkReu£PÜt
,

47 
TıS”v”
(
Ev’tLoİ
* 
loİ
,

48 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

49 cÚ¡ 
¡ršg
& 
ÇmeArg
,

50 
O±iÚ
 
İtiÚ
 = 
kNoReu£PÜt
);

51 ~
TıS”v”
();

53 cÚ¡ 
	g¡ršg
& 
PÜt
(ècÚ¡ {  
	gPÜt_
; }

54 cÚ¡ 
	g¡ršg
& 
Çme
(ècÚ¡ {  
	gÇme_
; }

55 
Ev’tLoİ
* 
g‘Loİ
(ècÚ¡ {  
	gloİ_
; }

67 
£tTh»adNum
(
numTh»ads
);

68 
£tTh»adIn™C®lback
(cÚ¡ 
Th»adIn™C®lback
& 
cb
)

69 { 
	gth»adIn™C®lback_
 = 
cb
; }

71 
	gboo¡
::
sh¬ed_±r
<
Ev’tLoİTh»adPoŞ
> 
th»adPoŞ
()

72 {  
th»adPoŞ_
; }

78 
¡¬t
();

82 
£tCÚÃùiÚC®lback
(cÚ¡ 
CÚÃùiÚC®lback
& 
cb
)

83 { 
	gcÚÃùiÚC®lback_
 = 
cb
; }

87 
£tMes§geC®lback
(cÚ¡ 
Mes§geC®lback
& 
cb
)

88 { 
	gmes§geC®lback_
 = 
cb
; }

92 
£tWr™eCom¶‘eC®lback
(cÚ¡ 
Wr™eCom¶‘eC®lback
& 
cb
)

93 { 
	gwr™eCom¶‘eC®lback_
 = 
cb
; }

95 
	g´iv©e
:

97 
ÃwCÚÃùiÚ
(
sockfd
, cÚ¡ 
IÃtAdd»ss
& 
³”Addr
);

99 
»moveCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

101 
»moveCÚÃùiÚInLoİ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

104 
	g¡d
::
	tm­
<
	t¡ršg
, 
	tTıCÚÃùiÚPŒ
> 
	tCÚÃùiÚM­
;

107 
Ev’tLoİ
* 
	gloİ_
;

109 cÚ¡ 
¡ršg
 
	gPÜt_
;

111 cÚ¡ 
¡ršg
 
	gÇme_
;

113 
	gboo¡
::
scİed_±r
<
Acû±Ü
> 
acû±Ü_
;

115 
	gboo¡
::
sh¬ed_±r
<
Ev’tLoİTh»adPoŞ
> 
th»adPoŞ_
;

116 
CÚÃùiÚC®lback
 
	gcÚÃùiÚC®lback_
;

117 
Mes§geC®lback
 
	gmes§geC®lback_
;

118 
Wr™eCom¶‘eC®lback
 
	gwr™eCom¶‘eC®lback_
;

119 
Th»adIn™C®lback
 
	gth»adIn™C®lback_
;

120 
AtomicIÁ32
 
	g¡¬‹d_
;

122 
	gÃxtCÚnId_
;

123 
CÚÃùiÚM­
 
	gcÚÃùiÚs_
;

	@muduo/net/TcpServer.h

11 #iâdeà
MUDUO_NET_TCPSERVER_H


12 
	#MUDUO_NET_TCPSERVER_H


	)

14 
	~<muduo/ba£/Atomic.h
>

15 
	~<muduo/ba£/Ty³s.h
>

16 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

18 
	~<m­
>

19 
	~<boo¡/nÚcİyabË.hµ
>

20 
	~<boo¡/scİed_±r.hµ
>

21 
	~<boo¡/sh¬ed_±r.hµ
>

23 
Çme¥aû
 
	gmuduo


25 
Çme¥aû
 
	gÃt


28 
şass
 
	gAcû±Ü
;

29 
şass
 
	gEv’tLoİ
;

30 
şass
 
	gEv’tLoİTh»adPoŞ
;

36 şas 
	cTıS”v”
 : 
boo¡
::
nÚcİyabË


38 
public
:

39 
boo¡
::
	tfunùiÚ
<(
	tEv’tLoİ
*)> 
	tTh»adIn™C®lback
;

40 
	eO±iÚ


42 
	gkNoReu£PÜt
,

43 
	gkReu£PÜt
,

47 
TıS”v”
(
Ev’tLoİ
* 
loİ
,

48 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

49 cÚ¡ 
¡ršg
& 
ÇmeArg
,

50 
O±iÚ
 
İtiÚ
 = 
kNoReu£PÜt
);

51 ~
TıS”v”
();

53 cÚ¡ 
	g¡ršg
& 
PÜt
(ècÚ¡ {  
	gPÜt_
; }

54 cÚ¡ 
	g¡ršg
& 
Çme
(ècÚ¡ {  
	gÇme_
; }

55 
Ev’tLoİ
* 
g‘Loİ
(ècÚ¡ {  
	gloİ_
; }

67 
£tTh»adNum
(
numTh»ads
);

68 
£tTh»adIn™C®lback
(cÚ¡ 
Th»adIn™C®lback
& 
cb
)

69 { 
	gth»adIn™C®lback_
 = 
cb
; }

71 
	gboo¡
::
sh¬ed_±r
<
Ev’tLoİTh»adPoŞ
> 
th»adPoŞ
()

72 {  
th»adPoŞ_
; }

78 
¡¬t
();

82 
£tCÚÃùiÚC®lback
(cÚ¡ 
CÚÃùiÚC®lback
& 
cb
)

83 { 
	gcÚÃùiÚC®lback_
 = 
cb
; }

87 
£tMes§geC®lback
(cÚ¡ 
Mes§geC®lback
& 
cb
)

88 { 
	gmes§geC®lback_
 = 
cb
; }

92 
£tWr™eCom¶‘eC®lback
(cÚ¡ 
Wr™eCom¶‘eC®lback
& 
cb
)

93 { 
	gwr™eCom¶‘eC®lback_
 = 
cb
; }

95 
	g´iv©e
:

97 
ÃwCÚÃùiÚ
(
sockfd
, cÚ¡ 
IÃtAdd»ss
& 
³”Addr
);

99 
»moveCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

101 
»moveCÚÃùiÚInLoİ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

104 
	g¡d
::
	tm­
<
	t¡ršg
, 
	tTıCÚÃùiÚPŒ
> 
	tCÚÃùiÚM­
;

107 
Ev’tLoİ
* 
	gloİ_
;

109 cÚ¡ 
¡ršg
 
	gPÜt_
;

111 cÚ¡ 
¡ršg
 
	gÇme_
;

113 
	gboo¡
::
scİed_±r
<
Acû±Ü
> 
acû±Ü_
;

115 
	gboo¡
::
sh¬ed_±r
<
Ev’tLoİTh»adPoŞ
> 
th»adPoŞ_
;

116 
CÚÃùiÚC®lback
 
	gcÚÃùiÚC®lback_
;

117 
Mes§geC®lback
 
	gmes§geC®lback_
;

118 
Wr™eCom¶‘eC®lback
 
	gwr™eCom¶‘eC®lback_
;

119 
Th»adIn™C®lback
 
	gth»adIn™C®lback_
;

120 
AtomicIÁ32
 
	g¡¬‹d_
;

122 
	gÃxtCÚnId_
;

123 
CÚÃùiÚM­
 
	gcÚÃùiÚs_
;

	@muduo/net/Timer.cc

9 
	~<muduo/Ãt/Tim”.h
>

11 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

14 
AtomicIÁ64
 
	gTim”
::
s_numC»©ed_
;

16 
	gTim”
::
	$»¡¬t
(
Time¡amp
 
now
)

18 ià(
»³©_
)

20 
expœ©iÚ_
 = 
	`addTime
(
now
, 
š‹rv®_
);

24 
expœ©iÚ_
 = 
Time¡amp
::
	`šv®id
();

26 
	}
}

	@muduo/net/Timer.h

11 #iâdeà
MUDUO_NET_TIMER_H


12 
	#MUDUO_NET_TIMER_H


	)

14 
	~<boo¡/nÚcİyabË.hµ
>

16 
	~<muduo/ba£/Atomic.h
>

17 
	~<muduo/ba£/Time¡amp.h
>

18 
	~<muduo/Ãt/C®lbacks.h
>

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


27 şas 
	cTim”
 : 
boo¡
::
nÚcİyabË


29 
public
:

30 
Tim”
(cÚ¡ 
Tim”C®lback
& 
cb
, 
Time¡amp
 
wh’
, 
š‹rv®
)

31 : 
ÿÎback_
(
cb
),

32 
expœ©iÚ_
(
wh’
),

33 
š‹rv®_
(
š‹rv®
),

34 
»³©_
(
š‹rv®
 > 0.0),

35 
£qu’û_
(
s_numC»©ed_
.
šüem’tAndG‘
())

38 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


39 
Tim”
(
Tim”C®lback
&& 
cb
, 
Time¡amp
 
wh’
, 
š‹rv®
)

40 : 
ÿÎback_
(
¡d
::
move
(
cb
)),

41 
expœ©iÚ_
(
wh’
),

42 
š‹rv®_
(
š‹rv®
),

43 
»³©_
(
š‹rv®
 > 0.0),

44 
£qu’û_
(
s_numC»©ed_
.
šüem’tAndG‘
())

48 
run
() const

50 
ÿÎback_
();

53 
Time¡amp
 
expœ©iÚ
(ècÚ¡ {  
	gexpœ©iÚ_
; }

54 
boŞ
 
»³©
(ècÚ¡ {  
	g»³©_
; }

55 
št64_t
 
£qu’û
(ècÚ¡ {  
	g£qu’û_
; }

57 
»¡¬t
(
Time¡amp
 
now
);

59 
št64_t
 
numC»©ed
(è{  
	gs_numC»©ed_
.
g‘
(); }

61 
	g´iv©e
:

62 cÚ¡ 
Tim”C®lback
 
ÿÎback_
;

63 
Time¡amp
 
	gexpœ©iÚ_
;

64 cÚ¡ 
	gš‹rv®_
;

65 cÚ¡ 
boŞ
 
	g»³©_
;

66 cÚ¡ 
št64_t
 
	g£qu’û_
;

68 
AtomicIÁ64
 
	gs_numC»©ed_
;

	@muduo/net/Timer.h

11 #iâdeà
MUDUO_NET_TIMER_H


12 
	#MUDUO_NET_TIMER_H


	)

14 
	~<boo¡/nÚcİyabË.hµ
>

16 
	~<muduo/ba£/Atomic.h
>

17 
	~<muduo/ba£/Time¡amp.h
>

18 
	~<muduo/Ãt/C®lbacks.h
>

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


27 şas 
	cTim”
 : 
boo¡
::
nÚcİyabË


29 
public
:

30 
Tim”
(cÚ¡ 
Tim”C®lback
& 
cb
, 
Time¡amp
 
wh’
, 
š‹rv®
)

31 : 
ÿÎback_
(
cb
),

32 
expœ©iÚ_
(
wh’
),

33 
š‹rv®_
(
š‹rv®
),

34 
»³©_
(
š‹rv®
 > 0.0),

35 
£qu’û_
(
s_numC»©ed_
.
šüem’tAndG‘
())

38 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


39 
Tim”
(
Tim”C®lback
&& 
cb
, 
Time¡amp
 
wh’
, 
š‹rv®
)

40 : 
ÿÎback_
(
¡d
::
move
(
cb
)),

41 
expœ©iÚ_
(
wh’
),

42 
š‹rv®_
(
š‹rv®
),

43 
»³©_
(
š‹rv®
 > 0.0),

44 
£qu’û_
(
s_numC»©ed_
.
šüem’tAndG‘
())

48 
run
() const

50 
ÿÎback_
();

53 
Time¡amp
 
expœ©iÚ
(ècÚ¡ {  
	gexpœ©iÚ_
; }

54 
boŞ
 
»³©
(ècÚ¡ {  
	g»³©_
; }

55 
št64_t
 
£qu’û
(ècÚ¡ {  
	g£qu’û_
; }

57 
»¡¬t
(
Time¡amp
 
now
);

59 
št64_t
 
numC»©ed
(è{  
	gs_numC»©ed_
.
g‘
(); }

61 
	g´iv©e
:

62 cÚ¡ 
Tim”C®lback
 
ÿÎback_
;

63 
Time¡amp
 
	gexpœ©iÚ_
;

64 cÚ¡ 
	gš‹rv®_
;

65 cÚ¡ 
boŞ
 
	g»³©_
;

66 cÚ¡ 
št64_t
 
	g£qu’û_
;

68 
AtomicIÁ64
 
	gs_numC»©ed_
;

	@muduo/net/TimerId.h

11 #iâdeà
MUDUO_NET_TIMERID_H


12 
	#MUDUO_NET_TIMERID_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

16 
Çme¥aû
 
	gmuduo


18 
Çme¥aû
 
	gÃt


21 
şass
 
	gTim”
;

26 şas 
	cTim”Id
 : 
public
 
muduo
::
cİyabË


28 
public
:

29 
Tim”Id
()

30 : 
tim”_
(
NULL
),

31 
£qu’û_
(0)

35 
Tim”Id
(
Tim”
* 
tim”
, 
št64_t
 
£q
)

36 : 
tim”_
(
tim”
),

37 
£qu’û_
(
£q
)

43 
ä›nd
 
şass
 
	gTim”Queue
;

45 
	g´iv©e
:

46 
Tim”
* 
tim”_
;

47 
št64_t
 
	g£qu’û_
;

	@muduo/net/TimerId.h

11 #iâdeà
MUDUO_NET_TIMERID_H


12 
	#MUDUO_NET_TIMERID_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

16 
Çme¥aû
 
	gmuduo


18 
Çme¥aû
 
	gÃt


21 
şass
 
	gTim”
;

26 şas 
	cTim”Id
 : 
public
 
muduo
::
cİyabË


28 
public
:

29 
Tim”Id
()

30 : 
tim”_
(
NULL
),

31 
£qu’û_
(0)

35 
Tim”Id
(
Tim”
* 
tim”
, 
št64_t
 
£q
)

36 : 
tim”_
(
tim”
),

37 
£qu’û_
(
£q
)

43 
ä›nd
 
şass
 
	gTim”Queue
;

45 
	g´iv©e
:

46 
Tim”
* 
tim”_
;

47 
št64_t
 
	g£qu’û_
;

	@muduo/net/TimerQueue.cc

9 #iâdeà
__STDC_LIMIT_MACROS


10 
	#__STDC_LIMIT_MACROS


	)

13 
	~<muduo/Ãt/Tim”Queue.h
>

15 
	~<muduo/ba£/Loggšg.h
>

16 
	~<muduo/Ãt/Ev’tLoİ.h
>

17 
	~<muduo/Ãt/Tim”.h
>

18 
	~<muduo/Ãt/Tim”Id.h
>

20 
	~<boo¡/bšd.hµ
>

22 
	~<sys/tim”fd.h
>

23 
	~<uni¡d.h
>

25 
Çme¥aû
 
	gmuduo


27 
Çme¥aû
 
	gÃt


29 
Çme¥aû
 
	gd‘a


32 
ü—‹Tim”fd
()

34 
	gtim”fd
 = ::
tim”fd_ü—‹
(
CLOCK_MONOTONIC
,

35 
TFD_NONBLOCK
 | 
TFD_CLOEXEC
);

36 ià(
	gtim”fd
 < 0)

38 
	gLOG_SYSFATAL
 << "Failed inimerfd_create";

40  
	gtim”fd
;

43 
time¥ec
 
howMuchTimeFromNow
(
Time¡amp
 
wh’
)

45 
št64_t
 
	gmiüo£cÚds
 = 
wh’
.
miüoSecÚdsSšûEpoch
()

46 - 
Time¡amp
::
now
().
miüoSecÚdsSšûEpoch
();

47 ià(
	gmiüo£cÚds
 < 100)

49 
	gmiüo£cÚds
 = 100;

51 
time¥ec
 
	gts
;

52 
	gts
.
	gtv_£c
 = 
¡©ic_ÿ¡
<
time_t
>(

53 
miüo£cÚds
 / 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
);

54 
	gts
.
	gtv_n£c
 = 
¡©ic_ÿ¡
<>(

55 (
miüo£cÚds
 % 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
) * 1000);

56  
	gts
;

59 
»adTim”fd
(
tim”fd
, 
Time¡amp
 
now
)

61 
ušt64_t
 
	ghowmªy
;

62 
ssize_t
 
	gn
 = ::
»ad
(
tim”fd
, &
howmªy
,  howmany);

63 
	gLOG_TRACE
 << "Tim”Queue::hªdËR—d(è" << 
	ghowmªy
 << "‡ˆ" << 
	gnow
.
toSŒšg
();

64 ià(
	gn
 !ğ 
howmªy
)

66 
LOG_ERROR
 << "Tim”Queue::hªdËR—d(è»ad " << 
n
 << " bytes instead of 8";

70 
»£tTim”fd
(
tim”fd
, 
Time¡amp
 
expœ©iÚ
)

73 
™im”¥ec
 
	gÃwV®ue
;

74 
™im”¥ec
 
	gŞdV®ue
;

75 
bz”o
(&
ÃwV®ue
, ‚ewValue);

76 
bz”o
(&
ŞdV®ue
,  oldValue);

77 
	gÃwV®ue
.
	g™_v®ue
 = 
howMuchTimeFromNow
(
expœ©iÚ
);

78 
	g»t
 = ::
tim”fd_£‰ime
(
tim”fd
, 0, &
ÃwV®ue
, &
ŞdV®ue
);

79 ià(
	g»t
)

81 
	gLOG_SYSERR
 << "timerfd_settime()";

89 
usšg
 
Çme¥aû
 
	gmuduo
;

90 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

91 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
::
d‘a
;

93 
	gTim”Queue
::
	$Tim”Queue
(
Ev’tLoİ
* 
loİ
)

94 : 
	`loİ_
(
loİ
),

95 
	`tim”fd_
(
	`ü—‹Tim”fd
()),

96 
	`tim”fdChªÃl_
(
loİ
, 
tim”fd_
),

97 
	`tim”s_
(),

98 
	$ÿÎšgExpœedTim”s_
(
çl£
)

100 
tim”fdChªÃl_
.
	`£tR—dC®lback
(

101 
boo¡
::
	`bšd
(&
Tim”Queue
::
hªdËR—d
, 
this
));

103 
tim”fdChªÃl_
.
	`’abËR—dšg
();

104 
	}
}

106 
	gTim”Queue
::~
	$Tim”Queue
()

108 
tim”fdChªÃl_
.
	`di§bËAÎ
();

109 
tim”fdChªÃl_
.
	`»move
();

110 ::
	`şo£
(
tim”fd_
);

112 
Tim”Li¡
::
™”©Ü
 
™
 = 
tim”s_
.
	`begš
();

113 
™
 !ğ
tim”s_
.
	`’d
(); ++it)

115 
d–‘e
 
™
->
£cÚd
;

117 
	}
}

119 
Tim”Id
 
	gTim”Queue
::
	$addTim”
(cÚ¡ 
Tim”C®lback
& 
cb
,

120 
Time¡amp
 
wh’
,

121 
š‹rv®
)

123 
Tim”
* 
tim”
 = 
Ãw
 
	`Tim”
(
cb
, 
wh’
, 
š‹rv®
);

124 
loİ_
->
	`runInLoİ
(

125 
boo¡
::
	`bšd
(&
Tim”Queue
::
addTim”InLoİ
, 
this
, 
tim”
));

126  
	`Tim”Id
(
tim”
,im”->
	`£qu’û
());

127 
	}
}

129 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


130 
Tim”Id
 
	gTim”Queue
::
	$addTim”
(
Tim”C®lback
&& 
cb
,

131 
Time¡amp
 
wh’
,

132 
š‹rv®
)

134 
Tim”
* 
tim”
 = 
Ãw
 
	`Tim”
(
¡d
::
	`move
(
cb
), 
wh’
, 
š‹rv®
);

135 
loİ_
->
	`runInLoİ
(

136 
boo¡
::
	`bšd
(&
Tim”Queue
::
addTim”InLoİ
, 
this
, 
tim”
));

137  
	`Tim”Id
(
tim”
,im”->
	`£qu’û
());

138 
	}
}

141 
	gTim”Queue
::
	$ÿnûl
(
Tim”Id
 
tim”Id
)

143 
loİ_
->
	`runInLoİ
(

144 
boo¡
::
	`bšd
(&
Tim”Queue
::
ÿnûlInLoİ
, 
this
, 
tim”Id
));

145 
	}
}

147 
	gTim”Queue
::
	$addTim”InLoİ
(
Tim”
* 
tim”
)

149 
loİ_
->
	`as£¹InLoİTh»ad
();

150 
boŞ
 
—¾›¡Chªged
 = 
	`š£¹
(
tim”
);

152 ià(
—¾›¡Chªged
)

154 
	`»£tTim”fd
(
tim”fd_
, 
tim”
->
	`expœ©iÚ
());

156 
	}
}

158 
	gTim”Queue
::
	$ÿnûlInLoİ
(
Tim”Id
 
tim”Id
)

160 
loİ_
->
	`as£¹InLoİTh»ad
();

161 
	`as£¹
(
tim”s_
.
	`size
(è=ğ
aùiveTim”s_
.size());

162 
AùiveTim”
 
	`tim”
(
tim”Id
.
tim”_
,im”Id.
£qu’û_
);

163 
AùiveTim”S‘
::
™”©Ü
 
™
 = 
aùiveTim”s_
.
	`fšd
(
tim”
);

164 ià(
™
 !ğ
aùiveTim”s_
.
	`’d
())

166 
size_t
 
n
 = 
tim”s_
.
	`”a£
(
	`EÁry
(
™
->
fœ¡
->
	`expœ©iÚ
(), it->first));

167 
	`as£¹
(
n
 == 1); ()n;

168 
d–‘e
 
™
->
fœ¡
;

169 
aùiveTim”s_
.
	`”a£
(
™
);

171 ià(
ÿÎšgExpœedTim”s_
)

173 
ÿnûlšgTim”s_
.
	`š£¹
(
tim”
);

175 
	`as£¹
(
tim”s_
.
	`size
(è=ğ
aùiveTim”s_
.size());

176 
	}
}

178 
	gTim”Queue
::
	$hªdËR—d
()

180 
loİ_
->
	`as£¹InLoİTh»ad
();

181 
Time¡amp
 
	`now
(Timestamp::now());

182 
	`»adTim”fd
(
tim”fd_
, 
now
);

184 
¡d
::
veùÜ
<
EÁry
> 
expœed
 = 
	`g‘Expœed
(
now
);

186 
ÿÎšgExpœedTim”s_
 = 
Œue
;

187 
ÿnûlšgTim”s_
.
	`ş—r
();

189 
¡d
::
veùÜ
<
EÁry
>::
™”©Ü
 
™
 = 
expœed
.
	`begš
();

190 
™
 !ğ
expœed
.
	`’d
(); ++it)

192 
™
->
£cÚd
->
	`run
();

194 
ÿÎšgExpœedTim”s_
 = 
çl£
;

196 
	`»£t
(
expœed
, 
now
);

197 
	}
}

199 
	g¡d
::
veùÜ
<
Tim”Queue
::
EÁry
> Tim”Queue::
	$g‘Expœed
(
Time¡amp
 
now
)

201 
	`as£¹
(
tim”s_
.
	`size
(è=ğ
aùiveTim”s_
.size());

202 
¡d
::
veùÜ
<
EÁry
> 
expœed
;

203 
EÁry
 
	`£Áry
(
now
, 
»š‹½»t_ÿ¡
<
Tim”
*>(
UINTPTR_MAX
));

204 
Tim”Li¡
::
™”©Ü
 
’d
 = 
tim”s_
.
	`low”_bound
(
£Áry
);

205 
	`as£¹
(
’d
 =ğ
tim”s_
.
	`’d
(è|| 
now
 <ƒnd->
fœ¡
);

206 
¡d
::
	`cİy
(
tim”s_
.
	`begš
(), 
’d
, 
	`back_š£¹”
(
expœed
));

207 
tim”s_
.
	`”a£
Ñim”s_.
	`begš
(), 
’d
);

209 
¡d
::
veùÜ
<
EÁry
>::
™”©Ü
 
™
 = 
expœed
.
	`begš
();

210 
™
 !ğ
expœed
.
	`’d
(); ++it)

212 
AùiveTim”
 
	`tim”
(
™
->
£cÚd
, it->£cÚd->
	`£qu’û
());

213 
size_t
 
n
 = 
aùiveTim”s_
.
	`”a£
(
tim”
);

214 
	`as£¹
(
n
 == 1); ()n;

217 
	`as£¹
(
tim”s_
.
	`size
(è=ğ
aùiveTim”s_
.size());

218  
expœed
;

219 
	}
}

221 
	gTim”Queue
::
»£t
(cÚ¡ 
¡d
::
veùÜ
<
EÁry
>& 
expœed
, 
Time¡amp
 
now
)

223 
Time¡amp
 
	gÃxtExpœe
;

225 
	g¡d
::
veùÜ
<
EÁry
>::
cÚ¡_™”©Ü
 
™
 = 
expœed
.
begš
();

226 
	g™
 !ğ
expœed
.
’d
(); ++it)

228 
AùiveTim”
 
tim”
(
™
->
£cÚd
, it->£cÚd->
£qu’û
());

229 ià(
	g™
->
	g£cÚd
->
»³©
()

230 && 
	gÿnûlšgTim”s_
.
fšd
(
tim”
è=ğ
ÿnûlšgTim”s_
.
’d
())

232 
™
->
£cÚd
->
»¡¬t
(
now
);

233 
š£¹
(
™
->
£cÚd
);

238 
d–‘e
 
	g™
->
	g£cÚd
;

242 ià(!
	gtim”s_
.
em±y
())

244 
	gÃxtExpœe
 = 
tim”s_
.
begš
()->
£cÚd
->
expœ©iÚ
();

247 ià(
	gÃxtExpœe
.
v®id
())

249 
»£tTim”fd
(
tim”fd_
, 
ÃxtExpœe
);

253 
boŞ
 
	gTim”Queue
::
	$š£¹
(
Tim”
* 
tim”
)

255 
loİ_
->
	`as£¹InLoİTh»ad
();

256 
	`as£¹
(
tim”s_
.
	`size
(è=ğ
aùiveTim”s_
.size());

257 
boŞ
 
—¾›¡Chªged
 = 
çl£
;

258 
Time¡amp
 
wh’
 = 
tim”
->
	`expœ©iÚ
();

259 
Tim”Li¡
::
™”©Ü
 
™
 = 
tim”s_
.
	`begš
();

260 ià(
™
 =ğ
tim”s_
.
	`’d
(è|| 
wh’
 < it->
fœ¡
)

262 
—¾›¡Chªged
 = 
Œue
;

265 
¡d
::
·œ
<
Tim”Li¡
::
™”©Ü
, 
boŞ
> 
»suÉ


266 ğ
tim”s_
.
	`š£¹
(
	`EÁry
(
wh’
, 
tim”
));

267 
	`as£¹
(
»suÉ
.
£cÚd
); ()result;

270 
¡d
::
·œ
<
AùiveTim”S‘
::
™”©Ü
, 
boŞ
> 
»suÉ


271 ğ
aùiveTim”s_
.
	`š£¹
(
	`AùiveTim”
(
tim”
,im”->
	`£qu’û
()));

272 
	`as£¹
(
»suÉ
.
£cÚd
); ()result;

275 
	`as£¹
(
tim”s_
.
	`size
(è=ğ
aùiveTim”s_
.size());

276  
—¾›¡Chªged
;

277 
	}
}

	@muduo/net/TimerQueue.h

11 #iâdeà
MUDUO_NET_TIMERQUEUE_H


12 
	#MUDUO_NET_TIMERQUEUE_H


	)

14 
	~<£t
>

15 
	~<veùÜ
>

17 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<muduo/ba£/Mu‹x.h
>

20 
	~<muduo/ba£/Time¡amp.h
>

21 
	~<muduo/Ãt/C®lbacks.h
>

22 
	~<muduo/Ãt/ChªÃl.h
>

24 
Çme¥aû
 
	gmuduo


26 
Çme¥aû
 
	gÃt


29 
şass
 
	gEv’tLoİ
;

30 
şass
 
	gTim”
;

31 
şass
 
	gTim”Id
;

37 şas 
	cTim”Queue
 : 
boo¡
::
nÚcİyabË


39 
public
:

40 
ex¶ic™
 
Tim”Queue
(
Ev’tLoİ
* 
loİ
);

41 ~
Tim”Queue
();

48 
Tim”Id
 
addTim”
(cÚ¡ 
Tim”C®lback
& 
cb
,

49 
Time¡amp
 
wh’
,

50 
š‹rv®
);

51 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


52 
Tim”Id
 
addTim”
(
Tim”C®lback
&& 
cb
,

53 
Time¡amp
 
wh’
,

54 
š‹rv®
);

57 
ÿnûl
(
Tim”Id
 
tim”Id
);

59 
	g´iv©e
:

64 
¡d
::
	t·œ
<
	tTime¡amp
, 
	tTim”
*> 
	tEÁry
;

65 
	g¡d
::
	t£t
<
	tEÁry
> 
	tTim”Li¡
;

66 
	g¡d
::
	t·œ
<
	tTim”
*, 
	tšt64_t
> 
	tAùiveTim”
;

67 
	g¡d
::
	t£t
<
	tAùiveTim”
> 
	tAùiveTim”S‘
;

69 
addTim”InLoİ
(
Tim”
* 
tim”
);

70 
ÿnûlInLoİ
(
Tim”Id
 
tim”Id
);

72 
hªdËR—d
();

74 
	g¡d
::
veùÜ
<
EÁry
> 
g‘Expœed
(
Time¡amp
 
now
);

75 
»£t
(cÚ¡ 
¡d
::
veùÜ
<
EÁry
>& 
expœed
, 
Time¡amp
 
now
);

77 
boŞ
 
š£¹
(
Tim”
* 
tim”
);

79 
Ev’tLoİ
* 
	gloİ_
;

80 cÚ¡ 
	gtim”fd_
;

81 
ChªÃl
 
	gtim”fdChªÃl_
;

83 
Tim”Li¡
 
	gtim”s_
;

86 
AùiveTim”S‘
 
	gaùiveTim”s_
;

87 
boŞ
 
	gÿÎšgExpœedTim”s_
;

88 
AùiveTim”S‘
 
	gÿnûlšgTim”s_
;

	@muduo/net/TimerQueue.h

11 #iâdeà
MUDUO_NET_TIMERQUEUE_H


12 
	#MUDUO_NET_TIMERQUEUE_H


	)

14 
	~<£t
>

15 
	~<veùÜ
>

17 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<muduo/ba£/Mu‹x.h
>

20 
	~<muduo/ba£/Time¡amp.h
>

21 
	~<muduo/Ãt/C®lbacks.h
>

22 
	~<muduo/Ãt/ChªÃl.h
>

24 
Çme¥aû
 
	gmuduo


26 
Çme¥aû
 
	gÃt


29 
şass
 
	gEv’tLoİ
;

30 
şass
 
	gTim”
;

31 
şass
 
	gTim”Id
;

37 şas 
	cTim”Queue
 : 
boo¡
::
nÚcİyabË


39 
public
:

40 
ex¶ic™
 
Tim”Queue
(
Ev’tLoİ
* 
loİ
);

41 ~
Tim”Queue
();

48 
Tim”Id
 
addTim”
(cÚ¡ 
Tim”C®lback
& 
cb
,

49 
Time¡amp
 
wh’
,

50 
š‹rv®
);

51 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


52 
Tim”Id
 
addTim”
(
Tim”C®lback
&& 
cb
,

53 
Time¡amp
 
wh’
,

54 
š‹rv®
);

57 
ÿnûl
(
Tim”Id
 
tim”Id
);

59 
	g´iv©e
:

64 
¡d
::
	t·œ
<
	tTime¡amp
, 
	tTim”
*> 
	tEÁry
;

65 
	g¡d
::
	t£t
<
	tEÁry
> 
	tTim”Li¡
;

66 
	g¡d
::
	t·œ
<
	tTim”
*, 
	tšt64_t
> 
	tAùiveTim”
;

67 
	g¡d
::
	t£t
<
	tAùiveTim”
> 
	tAùiveTim”S‘
;

69 
addTim”InLoİ
(
Tim”
* 
tim”
);

70 
ÿnûlInLoİ
(
Tim”Id
 
tim”Id
);

72 
hªdËR—d
();

74 
	g¡d
::
veùÜ
<
EÁry
> 
g‘Expœed
(
Time¡amp
 
now
);

75 
»£t
(cÚ¡ 
¡d
::
veùÜ
<
EÁry
>& 
expœed
, 
Time¡amp
 
now
);

77 
boŞ
 
š£¹
(
Tim”
* 
tim”
);

79 
Ev’tLoİ
* 
	gloİ_
;

80 cÚ¡ 
	gtim”fd_
;

81 
ChªÃl
 
	gtim”fdChªÃl_
;

83 
Tim”Li¡
 
	gtim”s_
;

86 
AùiveTim”S‘
 
	gaùiveTim”s_
;

87 
boŞ
 
	gÿÎšgExpœedTim”s_
;

88 
AùiveTim”S‘
 
	gÿnûlšgTim”s_
;

	@muduo/net/ZlibStream.h

1 #´agm¨
Úû


3 
	~<muduo/Ãt/Bufãr.h
>

4 
	~<boo¡/nÚcİyabË.hµ
>

5 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wold-style-cast"

6 
	~<zlib.h
>

8 
Çme¥aû
 
	gmuduo


10 
Çme¥aû
 
	gÃt


15 şas 
	cZlibIÅutSŒ—m
 : 
boo¡
::
nÚcİyabË


17 
public
:

18 
ex¶ic™
 
ZlibIÅutSŒ—m
(
Bufãr
* 
ouut
)

19 : 
ouut_
(
ouut
),

20 
z”rÜ_
(
Z_OK
)

22 
bz”o
(&
z¡»am_
,  zstream_);

23 
	gz”rÜ_
 = 
šæ©eIn™
(&
z¡»am_
);

26 ~
ZlibIÅutSŒ—m
()

28 
fšish
();

31 
boŞ
 
wr™e
(
SŒšgP›û
 
buf
);

32 
boŞ
 
wr™e
(
Bufãr
* 
šput
);

33 
boŞ
 
fšish
();

36 
	g´iv©e
:

37 
decom´ess
(
æush
);

39 
Bufãr
* 
	gouut_
;

40 
z_¡»am
 
	gz¡»am_
;

41 
	gz”rÜ_
;

45 şas 
	cZlibOuutSŒ—m
 : 
boo¡
::
nÚcİyabË


47 
public
:

48 
ex¶ic™
 
ZlibOuutSŒ—m
(
Bufãr
* 
ouut
)

49 : 
ouut_
(
ouut
),

50 
z”rÜ_
(
Z_OK
),

51 
bufãrSize_
(1024)

53 
bz”o
(&
z¡»am_
,  zstream_);

54 
	gz”rÜ_
 = 
deæ©eIn™
(&
z¡»am_
, 
Z_DEFAULT_COMPRESSION
);

57 ~
ZlibOuutSŒ—m
()

59 
fšish
();

63 cÚ¡ * 
zlibE¼ÜMes§ge
(ècÚ¡ {  
	gz¡»am_
.
	gmsg
; }

65 
zlibE¼ÜCode
(ècÚ¡ {  
	gz”rÜ_
; }

66 
št64_t
 
šputBy‹s
(ècÚ¡ {  
	gz¡»am_
.
	gtÙ®_š
; }

67 
št64_t
 
ouutBy‹s
(ècÚ¡ {  
	gz¡»am_
.
	gtÙ®_out
; }

68 
š‹º®OuutBufãrSize
(ècÚ¡ {  
	gbufãrSize_
; }

70 
boŞ
 
wr™e
(
SŒšgP›û
 
buf
)

72 ià(
	gz”rÜ_
 !ğ
Z_OK
)

73  
çl£
;

75 
as£¹
(
z¡»am_
.
Ãxt_š
 =ğ
NULL
 && z¡»am_.
ava_š
 == 0);

76 * 
	gš
 = 
cÚ¡_ÿ¡
<*>(
buf
.
d©a
());

77 
	gz¡»am_
.
	gÃxt_š
 = 
¡©ic_ÿ¡
<
By‹f
*>(
š
);

78 
	gz¡»am_
.
	gava_š
 = 
buf
.
size
();

79 
	gz¡»am_
.
	gava_š
 > 0 && 
	gz”rÜ_
 =ğ
Z_OK
)

81 
z”rÜ_
 = 
com´ess
(
Z_NO_FLUSH
);

83 ià(
	gz¡»am_
.
	gava_š
 == 0)

85 
as£¹
(
¡©ic_ÿ¡
<cÚ¡ *>(
z¡»am_
.
Ãxt_š
è=ğ
buf
.
’d
());

86 
	gz¡»am_
.
	gÃxt_š
 = 
NULL
;

88  
	gz”rÜ_
 =ğ
Z_OK
;

92 
boŞ
 
wr™e
(
Bufãr
* 
šput
)

94 ià(
	gz”rÜ_
 !ğ
Z_OK
)

95  
çl£
;

97 * 
	gš
 = 
cÚ¡_ÿ¡
<*>(
šput
->
³ek
());

98 
	gz¡»am_
.
	gÃxt_š
 = 
¡©ic_ÿ¡
<
By‹f
*>(
š
);

99 
	gz¡»am_
.
	gava_š
 = 
¡©ic_ÿ¡
<>(
šput
->
»adabËBy‹s
());

100 ià(
	gz¡»am_
.
	gava_š
 > 0 && 
	gz”rÜ_
 =ğ
Z_OK
)

102 
z”rÜ_
 = 
com´ess
(
Z_NO_FLUSH
);

104 
	gšput
->
»Œ›ve
(
šput
->
»adabËBy‹s
(è- 
z¡»am_
.
ava_š
);

105  
	gz”rÜ_
 =ğ
Z_OK
;

108 
boŞ
 
fšish
()

110 ià(
	gz”rÜ_
 !ğ
Z_OK
)

111  
çl£
;

113 
	gz”rÜ_
 =ğ
Z_OK
)

115 
z”rÜ_
 = 
com´ess
(
Z_FINISH
);

117 
	gz”rÜ_
 = 
deæ©eEnd
(&
z¡»am_
);

118 
boŞ
 
	gok
 = 
z”rÜ_
 =ğ
Z_OK
;

119 
	gz”rÜ_
 = 
Z_STREAM_END
;

120  
	gok
;

123 
	g´iv©e
:

124 
com´ess
(
æush
)

126 
ouut_
->
’su»Wr™abËBy‹s
(
bufãrSize_
);

127 
	gz¡»am_
.
	gÃxt_out
 = 
»š‹½»t_ÿ¡
<
By‹f
*>(
ouut_
->
begšWr™e
());

128 
	gz¡»am_
.
	gava_out
 = 
¡©ic_ÿ¡
<>(
ouut_
->
wr™abËBy‹s
());

129 
	g”rÜ
 = ::
deæ©e
(&
z¡»am_
, 
æush
);

130 
	gouut_
->
hasWr™‹n
(
ouut_
->
wr™abËBy‹s
(è- 
z¡»am_
.
ava_out
);

131 ià(
	gouut_
->
wr™abËBy‹s
(è=ğ0 && 
bufãrSize_
 < 65536)

133 
bufãrSize_
 *= 2;

135  
	g”rÜ
;

138 
Bufãr
* 
	gouut_
;

139 
z_¡»am
 
	gz¡»am_
;

140 
	gz”rÜ_
;

141 
	gbufãrSize_
;

	@muduo/net/ZlibStream.h

1 #´agm¨
Úû


3 
	~<muduo/Ãt/Bufãr.h
>

4 
	~<boo¡/nÚcİyabË.hµ
>

5 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wold-style-cast"

6 
	~<zlib.h
>

8 
Çme¥aû
 
	gmuduo


10 
Çme¥aû
 
	gÃt


15 şas 
	cZlibIÅutSŒ—m
 : 
boo¡
::
nÚcİyabË


17 
public
:

18 
ex¶ic™
 
ZlibIÅutSŒ—m
(
Bufãr
* 
ouut
)

19 : 
ouut_
(
ouut
),

20 
z”rÜ_
(
Z_OK
)

22 
bz”o
(&
z¡»am_
,  zstream_);

23 
	gz”rÜ_
 = 
šæ©eIn™
(&
z¡»am_
);

26 ~
ZlibIÅutSŒ—m
()

28 
fšish
();

31 
boŞ
 
wr™e
(
SŒšgP›û
 
buf
);

32 
boŞ
 
wr™e
(
Bufãr
* 
šput
);

33 
boŞ
 
fšish
();

36 
	g´iv©e
:

37 
decom´ess
(
æush
);

39 
Bufãr
* 
	gouut_
;

40 
z_¡»am
 
	gz¡»am_
;

41 
	gz”rÜ_
;

45 şas 
	cZlibOuutSŒ—m
 : 
boo¡
::
nÚcİyabË


47 
public
:

48 
ex¶ic™
 
ZlibOuutSŒ—m
(
Bufãr
* 
ouut
)

49 : 
ouut_
(
ouut
),

50 
z”rÜ_
(
Z_OK
),

51 
bufãrSize_
(1024)

53 
bz”o
(&
z¡»am_
,  zstream_);

54 
	gz”rÜ_
 = 
deæ©eIn™
(&
z¡»am_
, 
Z_DEFAULT_COMPRESSION
);

57 ~
ZlibOuutSŒ—m
()

59 
fšish
();

63 cÚ¡ * 
zlibE¼ÜMes§ge
(ècÚ¡ {  
	gz¡»am_
.
	gmsg
; }

65 
zlibE¼ÜCode
(ècÚ¡ {  
	gz”rÜ_
; }

66 
št64_t
 
šputBy‹s
(ècÚ¡ {  
	gz¡»am_
.
	gtÙ®_š
; }

67 
št64_t
 
ouutBy‹s
(ècÚ¡ {  
	gz¡»am_
.
	gtÙ®_out
; }

68 
š‹º®OuutBufãrSize
(ècÚ¡ {  
	gbufãrSize_
; }

70 
boŞ
 
wr™e
(
SŒšgP›û
 
buf
)

72 ià(
	gz”rÜ_
 !ğ
Z_OK
)

73  
çl£
;

75 
as£¹
(
z¡»am_
.
Ãxt_š
 =ğ
NULL
 && z¡»am_.
ava_š
 == 0);

76 * 
	gš
 = 
cÚ¡_ÿ¡
<*>(
buf
.
d©a
());

77 
	gz¡»am_
.
	gÃxt_š
 = 
¡©ic_ÿ¡
<
By‹f
*>(
š
);

78 
	gz¡»am_
.
	gava_š
 = 
buf
.
size
();

79 
	gz¡»am_
.
	gava_š
 > 0 && 
	gz”rÜ_
 =ğ
Z_OK
)

81 
z”rÜ_
 = 
com´ess
(
Z_NO_FLUSH
);

83 ià(
	gz¡»am_
.
	gava_š
 == 0)

85 
as£¹
(
¡©ic_ÿ¡
<cÚ¡ *>(
z¡»am_
.
Ãxt_š
è=ğ
buf
.
’d
());

86 
	gz¡»am_
.
	gÃxt_š
 = 
NULL
;

88  
	gz”rÜ_
 =ğ
Z_OK
;

92 
boŞ
 
wr™e
(
Bufãr
* 
šput
)

94 ià(
	gz”rÜ_
 !ğ
Z_OK
)

95  
çl£
;

97 * 
	gš
 = 
cÚ¡_ÿ¡
<*>(
šput
->
³ek
());

98 
	gz¡»am_
.
	gÃxt_š
 = 
¡©ic_ÿ¡
<
By‹f
*>(
š
);

99 
	gz¡»am_
.
	gava_š
 = 
¡©ic_ÿ¡
<>(
šput
->
»adabËBy‹s
());

100 ià(
	gz¡»am_
.
	gava_š
 > 0 && 
	gz”rÜ_
 =ğ
Z_OK
)

102 
z”rÜ_
 = 
com´ess
(
Z_NO_FLUSH
);

104 
	gšput
->
»Œ›ve
(
šput
->
»adabËBy‹s
(è- 
z¡»am_
.
ava_š
);

105  
	gz”rÜ_
 =ğ
Z_OK
;

108 
boŞ
 
fšish
()

110 ià(
	gz”rÜ_
 !ğ
Z_OK
)

111  
çl£
;

113 
	gz”rÜ_
 =ğ
Z_OK
)

115 
z”rÜ_
 = 
com´ess
(
Z_FINISH
);

117 
	gz”rÜ_
 = 
deæ©eEnd
(&
z¡»am_
);

118 
boŞ
 
	gok
 = 
z”rÜ_
 =ğ
Z_OK
;

119 
	gz”rÜ_
 = 
Z_STREAM_END
;

120  
	gok
;

123 
	g´iv©e
:

124 
com´ess
(
æush
)

126 
ouut_
->
’su»Wr™abËBy‹s
(
bufãrSize_
);

127 
	gz¡»am_
.
	gÃxt_out
 = 
»š‹½»t_ÿ¡
<
By‹f
*>(
ouut_
->
begšWr™e
());

128 
	gz¡»am_
.
	gava_out
 = 
¡©ic_ÿ¡
<>(
ouut_
->
wr™abËBy‹s
());

129 
	g”rÜ
 = ::
deæ©e
(&
z¡»am_
, 
æush
);

130 
	gouut_
->
hasWr™‹n
(
ouut_
->
wr™abËBy‹s
(è- 
z¡»am_
.
ava_out
);

131 ià(
	gouut_
->
wr™abËBy‹s
(è=ğ0 && 
bufãrSize_
 < 65536)

133 
bufãrSize_
 *= 2;

135  
	g”rÜ
;

138 
Bufãr
* 
	gouut_
;

139 
z_¡»am
 
	gz¡»am_
;

140 
	gz”rÜ_
;

141 
	gbufãrSize_
;

	@muduo/net/boilerplate.cc

10 
	~<muduo/Ãt/Bo”PÏ‹.h
>

12 
usšg
 
Çme¥aû
 
	gmuduo
;

13 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

	@muduo/net/boilerplate.h

12 #iâdeà
MUDUO_NET_BOILERPLATE_H


13 
	#MUDUO_NET_BOILERPLATE_H


	)

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


22 şas 
	cBo”PÏ‹
 : 
boo¡
::
nÚcİyabË


24 
public
:

26 
´iv©e
:

	@muduo/net/boilerplate.h

12 #iâdeà
MUDUO_NET_BOILERPLATE_H


13 
	#MUDUO_NET_BOILERPLATE_H


	)

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


22 şas 
	cBo”PÏ‹
 : 
boo¡
::
nÚcİyabË


24 
public
:

26 
´iv©e
:

	@muduo/net/http/HttpContext.cc

10 
	~<muduo/Ãt/Bufãr.h
>

11 
	~<muduo/Ãt/h‰p/H‰pCÚ‹xt.h
>

13 
usšg
 
Çme¥aû
 
	gmuduo
;

14 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

16 
boŞ
 
	gH‰pCÚ‹xt
::
	$´oûssReque¡Lše
(cÚ¡ * 
begš
, cÚ¡ * 
’d
)

18 
boŞ
 
sucûed
 = 
çl£
;

19 cÚ¡ * 
¡¬t
 = 
begš
;

20 cÚ¡ * 
¥aû
 = 
¡d
::
	`fšd
(
¡¬t
, 
’d
, ' ');

21 ià(
¥aû
 !ğ
’d
 && 
»que¡_
.
	`£tM‘hod
(
¡¬t
, space))

23 
¡¬t
 = 
¥aû
+1;

24 
¥aû
 = 
¡d
::
	`fšd
(
¡¬t
, 
’d
, ' ');

25 ià(
¥aû
 !ğ
’d
)

27 cÚ¡ * 
que¡iÚ
 = 
¡d
::
	`fšd
(
¡¬t
, 
¥aû
, '?');

28 ià(
que¡iÚ
 !ğ
¥aû
)

30 
»que¡_
.
	`£tP©h
(
¡¬t
, 
que¡iÚ
);

31 
»que¡_
.
	`£tQu”y
(
que¡iÚ
, 
¥aû
);

35 
»que¡_
.
	`£tP©h
(
¡¬t
, 
¥aû
);

37 
¡¬t
 = 
¥aû
+1;

38 
sucûed
 = 
’d
-
¡¬t
 =ğ8 && 
¡d
::
	`equ®
(start,ƒnd-1, "HTTP/1.");

39 ià(
sucûed
)

41 ià(*(
’d
-1) == '1')

43 
»que¡_
.
	`£tV”siÚ
(
H‰pReque¡
::
kH‰p11
);

45 ià(*(
’d
-1) == '0')

47 
»que¡_
.
	`£tV”siÚ
(
H‰pReque¡
::
kH‰p10
);

51 
sucûed
 = 
çl£
;

56  
sucûed
;

57 
	}
}

60 
boŞ
 
	gH‰pCÚ‹xt
::
	$·r£Reque¡
(
Bufãr
* 
buf
, 
Time¡amp
 
»ûiveTime
)

62 
boŞ
 
ok
 = 
Œue
;

63 
boŞ
 
hasMÜe
 = 
Œue
;

64 
hasMÜe
)

66 ià(
¡©e_
 =ğ
kEx³ùReque¡Lše
)

68 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

69 ià(
ülf
)

71 
ok
 = 
	`´oûssReque¡Lše
(
buf
->
	`³ek
(), 
ülf
);

72 ià(
ok
)

74 
»que¡_
.
	`£tReûiveTime
(
»ûiveTime
);

75 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

76 
¡©e_
 = 
kEx³ùH—d”s
;

80 
hasMÜe
 = 
çl£
;

85 
hasMÜe
 = 
çl£
;

88 ià(
¡©e_
 =ğ
kEx³ùH—d”s
)

90 cÚ¡ * 
ülf
 = 
buf
->
	`fšdCRLF
();

91 ià(
ülf
)

93 cÚ¡ * 
cŞÚ
 = 
¡d
::
	`fšd
(
buf
->
	`³ek
(), 
ülf
, ':');

94 ià(
cŞÚ
 !ğ
ülf
)

96 
»que¡_
.
	`addH—d”
(
buf
->
	`³ek
(), 
cŞÚ
, 
ülf
);

102 
¡©e_
 = 
kGÙAÎ
;

103 
hasMÜe
 = 
çl£
;

105 
buf
->
	`»Œ›veUÁ
(
ülf
 + 2);

109 
hasMÜe
 = 
çl£
;

112 ià(
¡©e_
 =ğ
kEx³ùBody
)

117  
ok
;

118 
	}
}

	@muduo/net/http/HttpContext.h

11 #iâdeà
MUDUO_NET_HTTP_HTTPCONTEXT_H


12 
	#MUDUO_NET_HTTP_HTTPCONTEXT_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

16 
	~<muduo/Ãt/h‰p/H‰pReque¡.h
>

18 
Çme¥aû
 
	gmuduo


20 
Çme¥aû
 
	gÃt


23 
şass
 
	gBufãr
;

25 şas 
	cH‰pCÚ‹xt
 : 
public
 
muduo
::
cİyabË


27 
public
:

28 
	eH‰pReque¡P¬£S‹


30 
kEx³ùReque¡Lše
,

31 
	gkEx³ùH—d”s
,

32 
	gkEx³ùBody
,

33 
	gkGÙAÎ
,

36 
H‰pCÚ‹xt
()

37 : 
¡©e_
(
kEx³ùReque¡Lše
)

44 
boŞ
 
·r£Reque¡
(
Bufãr
* 
buf
, 
Time¡amp
 
»ûiveTime
);

46 
boŞ
 
gÙAÎ
() const

47 {  
	g¡©e_
 =ğ
kGÙAÎ
; }

49 
»£t
()

51 
	g¡©e_
 = 
kEx³ùReque¡Lše
;

52 
H‰pReque¡
 
	gdummy
;

53 
	g»que¡_
.
sw­
(
dummy
);

56 cÚ¡ 
	gH‰pReque¡
& 
»que¡
() const

57 {  
	g»que¡_
; }

59 
	gH‰pReque¡
& 
»que¡
()

60 {  
	g»que¡_
; }

62 
	g´iv©e
:

63 
boŞ
 
´oûssReque¡Lše
(cÚ¡ * 
begš
, cÚ¡ * 
’d
);

65 
H‰pReque¡P¬£S‹
 
	g¡©e_
;

66 
H‰pReque¡
 
	g»que¡_
;

	@muduo/net/http/HttpContext.h

11 #iâdeà
MUDUO_NET_HTTP_HTTPCONTEXT_H


12 
	#MUDUO_NET_HTTP_HTTPCONTEXT_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

16 
	~<muduo/Ãt/h‰p/H‰pReque¡.h
>

18 
Çme¥aû
 
	gmuduo


20 
Çme¥aû
 
	gÃt


23 
şass
 
	gBufãr
;

25 şas 
	cH‰pCÚ‹xt
 : 
public
 
muduo
::
cİyabË


27 
public
:

28 
	eH‰pReque¡P¬£S‹


30 
kEx³ùReque¡Lše
,

31 
	gkEx³ùH—d”s
,

32 
	gkEx³ùBody
,

33 
	gkGÙAÎ
,

36 
H‰pCÚ‹xt
()

37 : 
¡©e_
(
kEx³ùReque¡Lše
)

44 
boŞ
 
·r£Reque¡
(
Bufãr
* 
buf
, 
Time¡amp
 
»ûiveTime
);

46 
boŞ
 
gÙAÎ
() const

47 {  
	g¡©e_
 =ğ
kGÙAÎ
; }

49 
»£t
()

51 
	g¡©e_
 = 
kEx³ùReque¡Lše
;

52 
H‰pReque¡
 
	gdummy
;

53 
	g»que¡_
.
sw­
(
dummy
);

56 cÚ¡ 
	gH‰pReque¡
& 
»que¡
() const

57 {  
	g»que¡_
; }

59 
	gH‰pReque¡
& 
»que¡
()

60 {  
	g»que¡_
; }

62 
	g´iv©e
:

63 
boŞ
 
´oûssReque¡Lše
(cÚ¡ * 
begš
, cÚ¡ * 
’d
);

65 
H‰pReque¡P¬£S‹
 
	g¡©e_
;

66 
H‰pReque¡
 
	g»que¡_
;

	@muduo/net/http/HttpRequest.h

11 #iâdeà
MUDUO_NET_HTTP_HTTPREQUEST_H


12 
	#MUDUO_NET_HTTP_HTTPREQUEST_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

15 
	~<muduo/ba£/Time¡amp.h
>

16 
	~<muduo/ba£/Ty³s.h
>

18 
	~<m­
>

19 
	~<as£¹.h
>

20 
	~<¡dio.h
>

22 
Çme¥aû
 
	gmuduo


24 
Çme¥aû
 
	gÃt


27 şas 
	cH‰pReque¡
 : 
public
 
muduo
::
cİyabË


29 
public
:

30 
	eM‘hod


32 
kInv®id
, 
	gkG‘
, 
	gkPo¡
, 
	gkH—d
, 
	gkPut
, 
	gkD–‘e


34 
	eV”siÚ


36 
	gkUnknown
, 
	gkH‰p10
, 
	gkH‰p11


39 
H‰pReque¡
()

40 : 
m‘hod_
(
kInv®id
),

41 
v”siÚ_
(
kUnknown
)

45 
£tV”siÚ
(
V”siÚ
 
v
)

47 
	gv”siÚ_
 = 
v
;

50 
V”siÚ
 
g‘V”siÚ
() const

51 {  
	gv”siÚ_
; }

53 
boŞ
 
£tM‘hod
(cÚ¡ * 
¡¬t
, cÚ¡ * 
’d
)

55 
as£¹
(
m‘hod_
 =ğ
kInv®id
);

56 
¡ršg
 
m
(
¡¬t
, 
’d
);

57 ià(
	gm
 == "GET")

59 
m‘hod_
 = 
kG‘
;

61 ià(
	gm
 == "POST")

63 
m‘hod_
 = 
kPo¡
;

65 ià(
	gm
 == "HEAD")

67 
m‘hod_
 = 
kH—d
;

69 ià(
	gm
 == "PUT")

71 
m‘hod_
 = 
kPut
;

73 ià(
	gm
 == "DELETE")

75 
m‘hod_
 = 
kD–‘e
;

79 
	gm‘hod_
 = 
kInv®id
;

81  
	gm‘hod_
 !ğ
kInv®id
;

84 
M‘hod
 
m‘hod
() const

85 {  
	gm‘hod_
; }

87 cÚ¡ * 
m‘hodSŒšg
() const

89 cÚ¡ * 
	g»suÉ
 = "UNKNOWN";

90 
	gm‘hod_
)

92 
	gkG‘
:

93 
»suÉ
 = "GET";

95 
	gkPo¡
:

96 
»suÉ
 = "POST";

98 
	gkH—d
:

99 
»suÉ
 = "HEAD";

101 
	gkPut
:

102 
»suÉ
 = "PUT";

104 
	gkD–‘e
:

105 
»suÉ
 = "DELETE";

110  
	g»suÉ
;

113 
£tP©h
(cÚ¡ * 
¡¬t
, cÚ¡ * 
’d
)

115 
	g·th_
.
assign
(
¡¬t
, 
’d
);

118 cÚ¡ 
	g¡ršg
& 
·th
() const

119 {  
	g·th_
; }

121 
£tQu”y
(cÚ¡ * 
¡¬t
, cÚ¡ * 
’d
)

123 
	gqu”y_
.
assign
(
¡¬t
, 
’d
);

126 cÚ¡ 
	g¡ršg
& 
qu”y
() const

127 {  
	gqu”y_
; }

129 
£tReûiveTime
(
Time¡amp
 
t
)

130 { 
	g»ûiveTime_
 = 
t
; }

132 
Time¡amp
 
»ûiveTime
() const

133 {  
	g»ûiveTime_
; }

135 
addH—d”
(cÚ¡ * 
¡¬t
, cÚ¡ * 
cŞÚ
, cÚ¡ * 
’d
)

137 
¡ršg
 
f›ld
(
¡¬t
, 
cŞÚ
);

138 ++
	gcŞÚ
;

139 
	gcŞÚ
 < 
	g’d
 && 
is¥aû
(*
cŞÚ
))

141 ++
	gcŞÚ
;

143 
¡ršg
 
v®ue
(
cŞÚ
, 
’d
);

144 !
	gv®ue
.
em±y
(è&& 
is¥aû
(
v®ue
[v®ue.
size
()-1]))

146 
	gv®ue
.
»size
(
v®ue
.
size
()-1);

148 
	gh—d”s_
[
f›ld
] = 
v®ue
;

151 
¡ršg
 
g‘H—d”
(cÚ¡ sŒšg& 
f›ld
) const

153 
¡ršg
 
	g»suÉ
;

154 
	g¡d
::
m­
<
¡ršg
, 
	g¡ršg
>::
cÚ¡_™”©Ü
 
™
 = 
h—d”s_
.
fšd
(
f›ld
);

155 ià(
	g™
 !ğ
h—d”s_
.
’d
())

157 
»suÉ
 = 
™
->
£cÚd
;

159  
	g»suÉ
;

162 cÚ¡ 
	g¡d
::
m­
<
¡ršg
, 
	g¡ršg
>& 
h—d”s
() const

163 {  
	gh—d”s_
; }

165 
sw­
(
H‰pReque¡
& 
th©
)

167 
	g¡d
::
sw­
(
m‘hod_
, 
th©
.method_);

168 
	g¡d
::
sw­
(
v”siÚ_
, 
th©
.version_);

169 
	g·th_
.
sw­
(
th©
.
·th_
);

170 
	gqu”y_
.
sw­
(
th©
.
qu”y_
);

171 
	g»ûiveTime_
.
sw­
(
th©
.
»ûiveTime_
);

172 
	gh—d”s_
.
sw­
(
th©
.
h—d”s_
);

175 
	g´iv©e
:

176 
M‘hod
 
m‘hod_
;

177 
V”siÚ
 
	gv”siÚ_
;

178 
¡ršg
 
	g·th_
;

179 
¡ršg
 
	gqu”y_
;

180 
Time¡amp
 
	g»ûiveTime_
;

181 
	g¡d
::
m­
<
¡ršg
, 
	g¡ršg
> 
	gh—d”s_
;

	@muduo/net/http/HttpRequest.h

11 #iâdeà
MUDUO_NET_HTTP_HTTPREQUEST_H


12 
	#MUDUO_NET_HTTP_HTTPREQUEST_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

15 
	~<muduo/ba£/Time¡amp.h
>

16 
	~<muduo/ba£/Ty³s.h
>

18 
	~<m­
>

19 
	~<as£¹.h
>

20 
	~<¡dio.h
>

22 
Çme¥aû
 
	gmuduo


24 
Çme¥aû
 
	gÃt


27 şas 
	cH‰pReque¡
 : 
public
 
muduo
::
cİyabË


29 
public
:

30 
	eM‘hod


32 
kInv®id
, 
	gkG‘
, 
	gkPo¡
, 
	gkH—d
, 
	gkPut
, 
	gkD–‘e


34 
	eV”siÚ


36 
	gkUnknown
, 
	gkH‰p10
, 
	gkH‰p11


39 
H‰pReque¡
()

40 : 
m‘hod_
(
kInv®id
),

41 
v”siÚ_
(
kUnknown
)

45 
£tV”siÚ
(
V”siÚ
 
v
)

47 
	gv”siÚ_
 = 
v
;

50 
V”siÚ
 
g‘V”siÚ
() const

51 {  
	gv”siÚ_
; }

53 
boŞ
 
£tM‘hod
(cÚ¡ * 
¡¬t
, cÚ¡ * 
’d
)

55 
as£¹
(
m‘hod_
 =ğ
kInv®id
);

56 
¡ršg
 
m
(
¡¬t
, 
’d
);

57 ià(
	gm
 == "GET")

59 
m‘hod_
 = 
kG‘
;

61 ià(
	gm
 == "POST")

63 
m‘hod_
 = 
kPo¡
;

65 ià(
	gm
 == "HEAD")

67 
m‘hod_
 = 
kH—d
;

69 ià(
	gm
 == "PUT")

71 
m‘hod_
 = 
kPut
;

73 ià(
	gm
 == "DELETE")

75 
m‘hod_
 = 
kD–‘e
;

79 
	gm‘hod_
 = 
kInv®id
;

81  
	gm‘hod_
 !ğ
kInv®id
;

84 
M‘hod
 
m‘hod
() const

85 {  
	gm‘hod_
; }

87 cÚ¡ * 
m‘hodSŒšg
() const

89 cÚ¡ * 
	g»suÉ
 = "UNKNOWN";

90 
	gm‘hod_
)

92 
	gkG‘
:

93 
»suÉ
 = "GET";

95 
	gkPo¡
:

96 
»suÉ
 = "POST";

98 
	gkH—d
:

99 
»suÉ
 = "HEAD";

101 
	gkPut
:

102 
»suÉ
 = "PUT";

104 
	gkD–‘e
:

105 
»suÉ
 = "DELETE";

110  
	g»suÉ
;

113 
£tP©h
(cÚ¡ * 
¡¬t
, cÚ¡ * 
’d
)

115 
	g·th_
.
assign
(
¡¬t
, 
’d
);

118 cÚ¡ 
	g¡ršg
& 
·th
() const

119 {  
	g·th_
; }

121 
£tQu”y
(cÚ¡ * 
¡¬t
, cÚ¡ * 
’d
)

123 
	gqu”y_
.
assign
(
¡¬t
, 
’d
);

126 cÚ¡ 
	g¡ršg
& 
qu”y
() const

127 {  
	gqu”y_
; }

129 
£tReûiveTime
(
Time¡amp
 
t
)

130 { 
	g»ûiveTime_
 = 
t
; }

132 
Time¡amp
 
»ûiveTime
() const

133 {  
	g»ûiveTime_
; }

135 
addH—d”
(cÚ¡ * 
¡¬t
, cÚ¡ * 
cŞÚ
, cÚ¡ * 
’d
)

137 
¡ršg
 
f›ld
(
¡¬t
, 
cŞÚ
);

138 ++
	gcŞÚ
;

139 
	gcŞÚ
 < 
	g’d
 && 
is¥aû
(*
cŞÚ
))

141 ++
	gcŞÚ
;

143 
¡ršg
 
v®ue
(
cŞÚ
, 
’d
);

144 !
	gv®ue
.
em±y
(è&& 
is¥aû
(
v®ue
[v®ue.
size
()-1]))

146 
	gv®ue
.
»size
(
v®ue
.
size
()-1);

148 
	gh—d”s_
[
f›ld
] = 
v®ue
;

151 
¡ršg
 
g‘H—d”
(cÚ¡ sŒšg& 
f›ld
) const

153 
¡ršg
 
	g»suÉ
;

154 
	g¡d
::
m­
<
¡ršg
, 
	g¡ršg
>::
cÚ¡_™”©Ü
 
™
 = 
h—d”s_
.
fšd
(
f›ld
);

155 ià(
	g™
 !ğ
h—d”s_
.
’d
())

157 
»suÉ
 = 
™
->
£cÚd
;

159  
	g»suÉ
;

162 cÚ¡ 
	g¡d
::
m­
<
¡ršg
, 
	g¡ršg
>& 
h—d”s
() const

163 {  
	gh—d”s_
; }

165 
sw­
(
H‰pReque¡
& 
th©
)

167 
	g¡d
::
sw­
(
m‘hod_
, 
th©
.method_);

168 
	g¡d
::
sw­
(
v”siÚ_
, 
th©
.version_);

169 
	g·th_
.
sw­
(
th©
.
·th_
);

170 
	gqu”y_
.
sw­
(
th©
.
qu”y_
);

171 
	g»ûiveTime_
.
sw­
(
th©
.
»ûiveTime_
);

172 
	gh—d”s_
.
sw­
(
th©
.
h—d”s_
);

175 
	g´iv©e
:

176 
M‘hod
 
m‘hod_
;

177 
V”siÚ
 
	gv”siÚ_
;

178 
¡ršg
 
	g·th_
;

179 
¡ršg
 
	gqu”y_
;

180 
Time¡amp
 
	g»ûiveTime_
;

181 
	g¡d
::
m­
<
¡ršg
, 
	g¡ršg
> 
	gh—d”s_
;

	@muduo/net/http/HttpResponse.cc

10 
	~<muduo/Ãt/h‰p/H‰pRe¥Ú£.h
>

11 
	~<muduo/Ãt/Bufãr.h
>

13 
	~<¡dio.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 
	gH‰pRe¥Ú£
::
	$­³ndToBufãr
(
Bufãr
* 
ouut
) const

20 
buf
[32];

21 
	`¢´štf
(
buf
,  buf, "HTTP/1.1 %d ", 
¡©usCode_
);

22 
ouut
->
	`­³nd
(
buf
);

23 
ouut
->
	`­³nd
(
¡©usMes§ge_
);

24 
ouut
->
	`­³nd
("\r\n");

26 ià(
şo£CÚÃùiÚ_
)

28 
ouut
->
	`­³nd
("Connection: close\r\n");

32 
	`¢´štf
(
buf
,  buf, "CÚ‹Á-L’gth: %zd\r\n", 
body_
.
	`size
());

33 
ouut
->
	`­³nd
(
buf
);

34 
ouut
->
	`­³nd
("Connection: Keep-Alive\r\n");

37 
¡d
::
m­
<
¡ršg
, sŒšg>::
cÚ¡_™”©Ü
 
™
 = 
h—d”s_
.
	`begš
();

38 
™
 !ğ
h—d”s_
.
	`’d
();

39 ++
™
)

41 
ouut
->
	`­³nd
(
™
->
fœ¡
);

42 
ouut
->
	`­³nd
(": ");

43 
ouut
->
	`­³nd
(
™
->
£cÚd
);

44 
ouut
->
	`­³nd
("\r\n");

47 
ouut
->
	`­³nd
("\r\n");

48 
ouut
->
	`­³nd
(
body_
);

49 
	}
}

	@muduo/net/http/HttpResponse.h

11 #iâdeà
MUDUO_NET_HTTP_HTTPRESPONSE_H


12 
	#MUDUO_NET_HTTP_HTTPRESPONSE_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

15 
	~<muduo/ba£/Ty³s.h
>

17 
	~<m­
>

19 
Çme¥aû
 
	gmuduo


21 
Çme¥aû
 
	gÃt


24 
şass
 
	gBufãr
;

25 şas 
	cH‰pRe¥Ú£
 : 
public
 
muduo
::
cİyabË


27 
public
:

28 
	eH‰pStusCode


30 
kUnknown
,

31 
	gk200Ok
 = 200,

32 
	gk301MovedP”mª’y
 = 301,

33 
	gk400BadReque¡
 = 400,

34 
	gk404NÙFound
 = 404,

37 
ex¶ic™
 
H‰pRe¥Ú£
(
boŞ
 
şo£
)

38 : 
¡©usCode_
(
kUnknown
),

39 
şo£CÚÃùiÚ_
(
şo£
)

43 
£tStusCode
(
H‰pStusCode
 
code
)

44 { 
	g¡©usCode_
 = 
code
; }

46 
£tStusMes§ge
(cÚ¡ 
¡ršg
& 
mes§ge
)

47 { 
	g¡©usMes§ge_
 = 
mes§ge
; }

49 
£tClo£CÚÃùiÚ
(
boŞ
 
Ú
)

50 { 
	gşo£CÚÃùiÚ_
 = 
Ú
; }

52 
boŞ
 
şo£CÚÃùiÚ
() const

53 {  
	gşo£CÚÃùiÚ_
; }

55 
£tCÚ‹ÁTy³
(cÚ¡ 
¡ršg
& 
cÚ‹ÁTy³
)

56 { 
addH—d”
("CÚ‹Á-Ty³", 
cÚ‹ÁTy³
); }

59 
addH—d”
(cÚ¡ 
¡ršg
& 
key
, cÚ¡ sŒšg& 
v®ue
)

60 { 
	gh—d”s_
[
key
] = 
v®ue
; }

62 
£tBody
(cÚ¡ 
¡ršg
& 
body
)

63 { 
	gbody_
 = 
body
; }

65 
­³ndToBufãr
(
Bufãr
* 
ouut
) const;

67 
	g´iv©e
:

68 
¡d
::
m­
<
¡ršg
, 
	g¡ršg
> 
	gh—d”s_
;

69 
H‰pStusCode
 
	g¡©usCode_
;

71 
¡ršg
 
	g¡©usMes§ge_
;

72 
boŞ
 
	gşo£CÚÃùiÚ_
;

73 
¡ršg
 
	gbody_
;

	@muduo/net/http/HttpResponse.h

11 #iâdeà
MUDUO_NET_HTTP_HTTPRESPONSE_H


12 
	#MUDUO_NET_HTTP_HTTPRESPONSE_H


	)

14 
	~<muduo/ba£/cİyabË.h
>

15 
	~<muduo/ba£/Ty³s.h
>

17 
	~<m­
>

19 
Çme¥aû
 
	gmuduo


21 
Çme¥aû
 
	gÃt


24 
şass
 
	gBufãr
;

25 şas 
	cH‰pRe¥Ú£
 : 
public
 
muduo
::
cİyabË


27 
public
:

28 
	eH‰pStusCode


30 
kUnknown
,

31 
	gk200Ok
 = 200,

32 
	gk301MovedP”mª’y
 = 301,

33 
	gk400BadReque¡
 = 400,

34 
	gk404NÙFound
 = 404,

37 
ex¶ic™
 
H‰pRe¥Ú£
(
boŞ
 
şo£
)

38 : 
¡©usCode_
(
kUnknown
),

39 
şo£CÚÃùiÚ_
(
şo£
)

43 
£tStusCode
(
H‰pStusCode
 
code
)

44 { 
	g¡©usCode_
 = 
code
; }

46 
£tStusMes§ge
(cÚ¡ 
¡ršg
& 
mes§ge
)

47 { 
	g¡©usMes§ge_
 = 
mes§ge
; }

49 
£tClo£CÚÃùiÚ
(
boŞ
 
Ú
)

50 { 
	gşo£CÚÃùiÚ_
 = 
Ú
; }

52 
boŞ
 
şo£CÚÃùiÚ
() const

53 {  
	gşo£CÚÃùiÚ_
; }

55 
£tCÚ‹ÁTy³
(cÚ¡ 
¡ršg
& 
cÚ‹ÁTy³
)

56 { 
addH—d”
("CÚ‹Á-Ty³", 
cÚ‹ÁTy³
); }

59 
addH—d”
(cÚ¡ 
¡ršg
& 
key
, cÚ¡ sŒšg& 
v®ue
)

60 { 
	gh—d”s_
[
key
] = 
v®ue
; }

62 
£tBody
(cÚ¡ 
¡ršg
& 
body
)

63 { 
	gbody_
 = 
body
; }

65 
­³ndToBufãr
(
Bufãr
* 
ouut
) const;

67 
	g´iv©e
:

68 
¡d
::
m­
<
¡ršg
, 
	g¡ršg
> 
	gh—d”s_
;

69 
H‰pStusCode
 
	g¡©usCode_
;

71 
¡ršg
 
	g¡©usMes§ge_
;

72 
boŞ
 
	gşo£CÚÃùiÚ_
;

73 
¡ršg
 
	gbody_
;

	@muduo/net/http/HttpServer.cc

10 
	~<muduo/Ãt/h‰p/H‰pS”v”.h
>

12 
	~<muduo/ba£/Loggšg.h
>

13 
	~<muduo/Ãt/h‰p/H‰pCÚ‹xt.h
>

14 
	~<muduo/Ãt/h‰p/H‰pReque¡.h
>

15 
	~<muduo/Ãt/h‰p/H‰pRe¥Ú£.h
>

17 
	~<boo¡/bšd.hµ
>

19 
usšg
 
Çme¥aû
 
	gmuduo
;

20 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

22 
Çme¥aû
 
	gmuduo


24 
Çme¥aû
 
	gÃt


26 
Çme¥aû
 
	gd‘a


29 
deçuÉH‰pC®lback
(cÚ¡ 
H‰pReque¡
&, 
H‰pRe¥Ú£
* 
»¥
)

31 
	g»¥
->
£tStusCode
(
H‰pRe¥Ú£
::
k404NÙFound
);

32 
	g»¥
->
£tStusMes§ge
("Not Found");

33 
	g»¥
->
£tClo£CÚÃùiÚ
(
Œue
);

40 
	gH‰pS”v”
::
H‰pS”v”
(
Ev’tLoİ
* 
loİ
,

41 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

42 cÚ¡ 
¡ršg
& 
Çme
,

43 
TıS”v”
::
O±iÚ
 
İtiÚ
)

44 : 
£rv”_
(
loİ
, 
li¡’Addr
, 
Çme
, 
İtiÚ
),

45 
h‰pC®lback_
(
d‘a
::
deçuÉH‰pC®lback
)

47 
£rv”_
.
£tCÚÃùiÚC®lback
(

48 
boo¡
::
bšd
(&
H‰pS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

49 
	g£rv”_
.
£tMes§geC®lback
(

50 
boo¡
::
bšd
(&
H‰pS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

53 
	gH‰pS”v”
::~
	$H‰pS”v”
()

55 
	}
}

57 
H‰pS”v”
::
	$¡¬t
()

59 
LOG_WARN
 << "H‰pS”v”[" << 
£rv”_
.
	`Çme
()

60 << "] s¹ li¡’nšg oÀ" << 
£rv”_
.
	`PÜt
();

61 
£rv”_
.
	`¡¬t
();

62 
	}
}

64 
	gH‰pS”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

66 ià(
cÚn
->
	`cÚÃùed
())

68 
cÚn
->
	`£tCÚ‹xt
(
	`H‰pCÚ‹xt
());

70 
	}
}

72 
	gH‰pS”v”
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

73 
Bufãr
* 
buf
,

74 
Time¡amp
 
»ûiveTime
)

76 
H‰pCÚ‹xt
* 
cÚ‹xt
 = 
boo¡
::
ªy_ÿ¡
<H‰pCÚ‹xt>(
cÚn
->
	`g‘MubËCÚ‹xt
());

78 ià(!
cÚ‹xt
->
	`·r£Reque¡
(
buf
, 
»ûiveTime
))

80 
cÚn
->
	`£nd
("HTTP/1.1 400 Bad Request\r\n\r\n");

81 
cÚn
->
	`shutdown
();

84 ià(
cÚ‹xt
->
	`gÙAÎ
())

86 
	`ÚReque¡
(
cÚn
, 
cÚ‹xt
->
	`»que¡
());

87 
cÚ‹xt
->
	`»£t
();

89 
	}
}

91 
	gH‰pS”v”
::
	$ÚReque¡
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, cÚ¡ 
H‰pReque¡
& 
»q
)

93 cÚ¡ 
¡ršg
& 
cÚÃùiÚ
 = 
»q
.
	`g‘H—d”
("Connection");

94 
boŞ
 
şo£
 = 
cÚÃùiÚ
 == "close" ||

95 (
»q
.
	`g‘V”siÚ
(è=ğ
H‰pReque¡
::
kH‰p10
 && 
cÚÃùiÚ
 != "Keep-Alive");

96 
H‰pRe¥Ú£
 
	`»¥Ú£
(
şo£
);

97 
	`h‰pC®lback_
(
»q
, &
»¥Ú£
);

98 
Bufãr
 
buf
;

99 
»¥Ú£
.
	`­³ndToBufãr
(&
buf
);

100 
cÚn
->
	`£nd
(&
buf
);

101 ià(
»¥Ú£
.
	`şo£CÚÃùiÚ
())

103 
cÚn
->
	`shutdown
();

105 
	}
}

	@muduo/net/http/HttpServer.h

11 #iâdeà
MUDUO_NET_HTTP_HTTPSERVER_H


12 
	#MUDUO_NET_HTTP_HTTPSERVER_H


	)

14 
	~<muduo/Ãt/TıS”v”.h
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


22 
şass
 
	gH‰pReque¡
;

23 
şass
 
	gH‰pRe¥Ú£
;

29 şas 
	cH‰pS”v”
 : 
boo¡
::
nÚcİyabË


31 
public
:

32 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tH‰pReque¡
&,

33 
	tH‰pRe¥Ú£
*)> 
	tH‰pC®lback
;

35 
H‰pS”v”
(
Ev’tLoİ
* 
loİ
,

36 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

37 cÚ¡ 
¡ršg
& 
Çme
,

38 
TıS”v”
::
O±iÚ
 
İtiÚ
 = TıS”v”::
kNoReu£PÜt
);

40 ~
H‰pS”v”
();

42 
Ev’tLoİ
* 
g‘Loİ
(ècÚ¡ {  
	g£rv”_
.getLoop(); }

45 
£tH‰pC®lback
(cÚ¡ 
H‰pC®lback
& 
cb
)

47 
	gh‰pC®lback_
 = 
cb
;

50 
£tTh»adNum
(
numTh»ads
)

52 
	g£rv”_
.
£tTh»adNum
(
numTh»ads
);

55 
¡¬t
();

57 
	g´iv©e
:

58 
ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

59 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

60 
Bufãr
* 
buf
,

61 
Time¡amp
 
»ûiveTime
);

62 
ÚReque¡
(cÚ¡ 
TıCÚÃùiÚPŒ
&, cÚ¡ 
H‰pReque¡
&);

64 
TıS”v”
 
	g£rv”_
;

65 
H‰pC®lback
 
	gh‰pC®lback_
;

	@muduo/net/http/HttpServer.h

11 #iâdeà
MUDUO_NET_HTTP_HTTPSERVER_H


12 
	#MUDUO_NET_HTTP_HTTPSERVER_H


	)

14 
	~<muduo/Ãt/TıS”v”.h
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


22 
şass
 
	gH‰pReque¡
;

23 
şass
 
	gH‰pRe¥Ú£
;

29 şas 
	cH‰pS”v”
 : 
boo¡
::
nÚcİyabË


31 
public
:

32 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tH‰pReque¡
&,

33 
	tH‰pRe¥Ú£
*)> 
	tH‰pC®lback
;

35 
H‰pS”v”
(
Ev’tLoİ
* 
loİ
,

36 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
,

37 cÚ¡ 
¡ršg
& 
Çme
,

38 
TıS”v”
::
O±iÚ
 
İtiÚ
 = TıS”v”::
kNoReu£PÜt
);

40 ~
H‰pS”v”
();

42 
Ev’tLoİ
* 
g‘Loİ
(ècÚ¡ {  
	g£rv”_
.getLoop(); }

45 
£tH‰pC®lback
(cÚ¡ 
H‰pC®lback
& 
cb
)

47 
	gh‰pC®lback_
 = 
cb
;

50 
£tTh»adNum
(
numTh»ads
)

52 
	g£rv”_
.
£tTh»adNum
(
numTh»ads
);

55 
¡¬t
();

57 
	g´iv©e
:

58 
ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

59 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

60 
Bufãr
* 
buf
,

61 
Time¡amp
 
»ûiveTime
);

62 
ÚReque¡
(cÚ¡ 
TıCÚÃùiÚPŒ
&, cÚ¡ 
H‰pReque¡
&);

64 
TıS”v”
 
	g£rv”_
;

65 
H‰pC®lback
 
	gh‰pC®lback_
;

	@muduo/net/http/tests/HttpRequest_unittest.cc

1 
	~<muduo/Ãt/h‰p/H‰pCÚ‹xt.h
>

2 
	~<muduo/Ãt/Bufãr.h
>

5 
	#BOOST_TEST_MAIN


	)

6 
	#BOOST_TEST_DYN_LINK


	)

7 
	~<boo¡/‹¡/un™_‹¡.hµ
>

9 
usšg
 
	gmuduo
::
¡ršg
;

10 
usšg
 
	gmuduo
::
Time¡amp
;

11 
usšg
 
	gmuduo
::
Ãt
::
Bufãr
;

12 
usšg
 
	gmuduo
::
Ãt
::
H‰pCÚ‹xt
;

13 
usšg
 
	gmuduo
::
Ãt
::
H‰pReque¡
;

15 
	$BOOST_AUTO_TEST_CASE
(
‹¡P¬£Reque¡AÎInOÃ
)

17 
H‰pCÚ‹xt
 
cÚ‹xt
;

18 
Bufãr
 
šput
;

19 
šput
.
	`­³nd
("GET /index.html HTTP/1.1\r\n"

23 
	`BOOST_CHECK
(
cÚ‹xt
.
	`·r£Reque¡
(&
šput
, 
Time¡amp
::
	`now
()));

24 
	`BOOST_CHECK
(
cÚ‹xt
.
	`gÙAÎ
());

25 cÚ¡ 
H‰pReque¡
& 
»que¡
 = 
cÚ‹xt
.
	`»que¡
();

26 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`m‘hod
(), 
H‰pReque¡
::
kG‘
);

27 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`·th
(), 
	`¡ršg
("/index.html"));

28 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘V”siÚ
(), 
H‰pReque¡
::
kH‰p11
);

29 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘H—d”
("Ho¡"), 
	`¡ršg
("www.chenshuo.com"));

30 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘H—d”
("U£r-Ag’t"), 
	`¡ršg
(""));

31 
	}
}

33 
	$BOOST_AUTO_TEST_CASE
(
‹¡P¬£Reque¡InTwoP›ûs
)

35 
¡ršg
 
	`®l
("GET /index.html HTTP/1.1\r\n"

39 
size_t
 
sz1
 = 0; sz1 < 
®l
.
	`size
(); ++sz1)

41 
H‰pCÚ‹xt
 
cÚ‹xt
;

42 
Bufãr
 
šput
;

43 
šput
.
	`­³nd
(
®l
.
	`c_¡r
(), 
sz1
);

44 
	`BOOST_CHECK
(
cÚ‹xt
.
	`·r£Reque¡
(&
šput
, 
Time¡amp
::
	`now
()));

45 
	`BOOST_CHECK
(!
cÚ‹xt
.
	`gÙAÎ
());

47 
size_t
 
sz2
 = 
®l
.
	`size
(è- 
sz1
;

48 
šput
.
	`­³nd
(
®l
.
	`c_¡r
(è+ 
sz1
, 
sz2
);

49 
	`BOOST_CHECK
(
cÚ‹xt
.
	`·r£Reque¡
(&
šput
, 
Time¡amp
::
	`now
()));

50 
	`BOOST_CHECK
(
cÚ‹xt
.
	`gÙAÎ
());

51 cÚ¡ 
H‰pReque¡
& 
»que¡
 = 
cÚ‹xt
.
	`»que¡
();

52 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`m‘hod
(), 
H‰pReque¡
::
kG‘
);

53 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`·th
(), 
	`¡ršg
("/index.html"));

54 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘V”siÚ
(), 
H‰pReque¡
::
kH‰p11
);

55 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘H—d”
("Ho¡"), 
	`¡ršg
("www.chenshuo.com"));

56 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘H—d”
("U£r-Ag’t"), 
	`¡ršg
(""));

58 
	}
}

60 
	$BOOST_AUTO_TEST_CASE
(
‹¡P¬£Reque¡Em±yH—d”V®ue
)

62 
H‰pCÚ‹xt
 
cÚ‹xt
;

63 
Bufãr
 
šput
;

64 
šput
.
	`­³nd
("GET /index.html HTTP/1.1\r\n"

70 
	`BOOST_CHECK
(
cÚ‹xt
.
	`·r£Reque¡
(&
šput
, 
Time¡amp
::
	`now
()));

71 
	`BOOST_CHECK
(
cÚ‹xt
.
	`gÙAÎ
());

72 cÚ¡ 
H‰pReque¡
& 
»que¡
 = 
cÚ‹xt
.
	`»que¡
();

73 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`m‘hod
(), 
H‰pReque¡
::
kG‘
);

74 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`·th
(), 
	`¡ršg
("/index.html"));

75 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘V”siÚ
(), 
H‰pReque¡
::
kH‰p11
);

76 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘H—d”
("Ho¡"), 
	`¡ršg
("www.chenshuo.com"));

77 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘H—d”
("U£r-Ag’t"), 
	`¡ršg
(""));

78 
	`BOOST_CHECK_EQUAL
(
»que¡
.
	`g‘H—d”
("Acû±-Encodšg"), 
	`¡ršg
(""));

79 
	}
}

	@muduo/net/http/tests/HttpServer_test.cc

1 
	~<muduo/Ãt/h‰p/H‰pS”v”.h
>

2 
	~<muduo/Ãt/h‰p/H‰pReque¡.h
>

3 
	~<muduo/Ãt/h‰p/H‰pRe¥Ú£.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/ba£/Loggšg.h
>

7 
	~<io¡»am
>

8 
	~<m­
>

10 
usšg
 
Çme¥aû
 
	gmuduo
;

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 
çvicÚ
[555];

14 
boŞ
 
	gb’chm¬k
 = 
çl£
;

16 
	$ÚReque¡
(cÚ¡ 
H‰pReque¡
& 
»q
, 
H‰pRe¥Ú£
* 
»¥
)

18 
¡d
::
cout
 << "H—d” " << 
»q
.
	`m‘hodSŒšg
(è<< " " <<„eq.
	`·th
(è<< std::
’dl
;

19 ià(!
b’chm¬k
)

21 cÚ¡ 
¡d
::
m­
<
¡ršg
, sŒšg>& 
h—d”s
 = 
»q
.
	`h—d”s
();

22 
¡d
::
m­
<
¡ršg
, sŒšg>::
cÚ¡_™”©Ü
 
™
 = 
h—d”s
.
	`begš
();

23 
™
 !ğ
h—d”s
.
	`’d
();

24 ++
™
)

26 
¡d
::
cout
 << 
™
->
fœ¡
 << ": " << it->
£cÚd
 << std::
’dl
;

30 ià(
»q
.
	`·th
() == "/")

32 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k200Ok
);

33 
»¥
->
	`£tStusMes§ge
("OK");

34 
»¥
->
	`£tCÚ‹ÁTy³
("text/html");

35 
»¥
->
	`addH—d”
("Server", "Muduo");

36 
¡ršg
 
now
 = 
Time¡amp
::
	`now
().
	`toFÜm©‹dSŒšg
();

37 
»¥
->
	`£tBody
("<html><head><title>This isitle</title></head>"

38 "<body><h1>H–lo</h1>Now i " + 
now
 +

41 ià(
»q
.
	`·th
() == "/favicon.ico")

43 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k200Ok
);

44 
»¥
->
	`£tStusMes§ge
("OK");

45 
»¥
->
	`£tCÚ‹ÁTy³
("image/png");

46 
»¥
->
	`£tBody
(
	`¡ršg
(
çvicÚ
,  favicon));

48 ià(
»q
.
	`·th
() == "/hello")

50 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k200Ok
);

51 
»¥
->
	`£tStusMes§ge
("OK");

52 
»¥
->
	`£tCÚ‹ÁTy³
("text/plain");

53 
»¥
->
	`addH—d”
("Server", "Muduo");

54 
»¥
->
	`£tBody
("hello, world!\n");

58 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k404NÙFound
);

59 
»¥
->
	`£tStusMes§ge
("Not Found");

60 
»¥
->
	`£tClo£CÚÃùiÚ
(
Œue
);

62 
	}
}

64 
	$maš
(
¬gc
, * 
¬gv
[])

66 
numTh»ads
 = 0;

67 ià(
¬gc
 > 1)

69 
b’chm¬k
 = 
Œue
;

70 
Logg”
::
	`£tLogLev–
(Logg”::
WARN
);

71 
numTh»ads
 = 
	`©oi
(
¬gv
[1]);

73 
Ev’tLoİ
 
loİ
;

74 
H‰pS”v”
 
	`£rv”
(&
loİ
, 
	`IÃtAdd»ss
(8000), "dummy");

75 
£rv”
.
	`£tH‰pC®lback
(
ÚReque¡
);

76 
£rv”
.
	`£tTh»adNum
(
numTh»ads
);

77 
£rv”
.
	`¡¬t
();

78 
loİ
.
	`loİ
();

79 
	}
}

81 
	gçvicÚ
[555] = {

	@muduo/net/inspect/Inspector.cc

10 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

12 
	~<muduo/ba£/Loggšg.h
>

13 
	~<muduo/ba£/Th»ad.h
>

14 
	~<muduo/Ãt/Ev’tLoİ.h
>

15 
	~<muduo/Ãt/h‰p/H‰pReque¡.h
>

16 
	~<muduo/Ãt/h‰p/H‰pRe¥Ú£.h
>

17 
	~<muduo/Ãt/š¥eù/ProûssIn¥eùÜ.h
>

18 
	~<muduo/Ãt/š¥eù/P”fÜmªûIn¥eùÜ.h
>

19 
	~<muduo/Ãt/š¥eù/Sy¡emIn¥eùÜ.h
>

24 
	~<boo¡/bšd.hµ
>

25 
	~<boo¡/®gÜ™hm/¡ršg/şassifiÿtiÚ.hµ
>

26 
	~<boo¡/®gÜ™hm/¡ršg/¥l™.hµ
>

28 
usšg
 
Çme¥aû
 
	gmuduo
;

29 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

31 
	gÇme¥aû


33 
In¥eùÜ
* 
	gg_glob®In¥eùÜ
 = 0;

36 
	g¡d
::
veùÜ
<
¡ršg
> 
¥l™
(cÚ¡ sŒšg& 
¡r
)

38 
¡d
::
veùÜ
<
¡ršg
> 
»suÉ
;

39 
size_t
 
	g¡¬t
 = 0;

40 
size_t
 
	gpos
 = 
¡r
.
fšd
('/');

41 
	gpos
 !ğ
¡ršg
::
Åos
)

43 ià(
pos
 > 
¡¬t
)

45 
»suÉ
.
push_back
(
¡r
.
sub¡r
(
¡¬t
, 
pos
-start));

47 
	g¡¬t
 = 
pos
+1;

48 
	gpos
 = 
¡r
.
fšd
('/', 
¡¬t
);

51 ià(
	g¡¬t
 < 
	g¡r
.
Ëngth
())

53 
	g»suÉ
.
push_back
(
¡r
.
sub¡r
(
¡¬t
));

56  
	g»suÉ
;

61 
çvicÚ
[1743];

63 
	gIn¥eùÜ
::
	$In¥eùÜ
(
Ev’tLoİ
* 
loİ
,

64 cÚ¡ 
IÃtAdd»ss
& 
h‰pAddr
,

65 cÚ¡ 
¡ršg
& 
Çme
)

66 : 
	`£rv”_
(
loİ
, 
h‰pAddr
, "In¥eùÜ:"+
Çme
),

67 
	`´oûssIn¥eùÜ_
(
Ãw
 
ProûssIn¥eùÜ
),

68 
	$sy¡emIn¥eùÜ_
(
Ãw
 
Sy¡emIn¥eùÜ
)

70 
	`as£¹
(
Cu¼’tTh»ad
::
	`isMašTh»ad
());

71 
	`as£¹
(
g_glob®In¥eùÜ
 == 0);

72 
g_glob®In¥eùÜ
 = 
this
;

73 
£rv”_
.
	`£tH‰pC®lback
(
boo¡
::
	`bšd
(&
In¥eùÜ
::
ÚReque¡
, 
this
, 
_1
, 
_2
));

74 
´oûssIn¥eùÜ_
->
	`»gi¡”Commªds
(
this
);

75 
sy¡emIn¥eùÜ_
->
	`»gi¡”Commªds
(
this
);

76 #ifdeà
HAVE_TCMALLOC


77 
³rfÜmªûIn¥eùÜ_
.
	`»£t
(
Ãw
 
P”fÜmªûIn¥eùÜ
);

78 
³rfÜmªûIn¥eùÜ_
->
	`»gi¡”Commªds
(
this
);

80 
loİ
->
	`runAá”
(0, 
boo¡
::
	`bšd
(&
In¥eùÜ
::
¡¬t
, 
this
));

81 
	}
}

83 
	gIn¥eùÜ
::~
	$In¥eùÜ
()

85 
	`as£¹
(
Cu¼’tTh»ad
::
	`isMašTh»ad
());

86 
g_glob®In¥eùÜ
 = 
NULL
;

87 
	}
}

89 
	gIn¥eùÜ
::
	$add
(cÚ¡ 
¡ršg
& 
moduË
,

90 cÚ¡ 
¡ršg
& 
commªd
,

91 cÚ¡ 
C®lback
& 
cb
,

92 cÚ¡ 
¡ršg
& 
h–p
)

94 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

95 
moduËs_
[
moduË
][
commªd
] = 
cb
;

96 
h–ps_
[
moduË
][
commªd
] = 
h–p
;

97 
	}
}

99 
	gIn¥eùÜ
::
	$»move
(cÚ¡ 
¡ršg
& 
moduË
, cÚ¡ sŒšg& 
commªd
)

101 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

102 
¡d
::
m­
<
¡ršg
, 
CommªdLi¡
>::
™”©Ü
 
™
 = 
moduËs_
.
	`fšd
(
moduË
);

103 ià(
™
 !ğ
moduËs_
.
	`’d
())

105 
™
->
£cÚd
.
	`”a£
(
commªd
);

106 
h–ps_
[
moduË
].
	`”a£
(
commªd
);

108 
	}
}

110 
	gIn¥eùÜ
::
	$¡¬t
()

112 
£rv”_
.
	`¡¬t
();

113 
	}
}

115 
	gIn¥eùÜ
::
	$ÚReque¡
(cÚ¡ 
H‰pReque¡
& 
»q
, 
H‰pRe¥Ú£
* 
»¥
)

117 ià(
»q
.
	`·th
() == "/")

119 
¡ršg
 
»suÉ
;

120 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

121 
¡d
::
m­
<
¡ršg
, 
H–pLi¡
>::
cÚ¡_™”©Ü
 
h–pLi¡I
 = 
h–ps_
.
	`begš
();

122 
h–pLi¡I
 !ğ
h–ps_
.
	`’d
();

123 ++
h–pLi¡I
)

125 cÚ¡ 
H–pLi¡
& 
li¡
 = 
h–pLi¡I
->
£cÚd
;

126 
H–pLi¡
::
cÚ¡_™”©Ü
 
™
 = 
li¡
.
	`begš
();

127 
™
 !ğ
li¡
.
	`’d
();

128 ++
™
)

130 
»suÉ
 += "/";

131 
»suÉ
 +ğ
h–pLi¡I
->
fœ¡
;

132 
»suÉ
 += "/";

133 
»suÉ
 +ğ
™
->
fœ¡
;

134 
size_t
 
Ën
 = 
h–pLi¡I
->
fœ¡
.
	`size
(è+ 
™
->first.size();

135 
»suÉ
 +ğ
	`¡ršg
(
Ën
 >= 25 ? 1 : 25 -†en, ' ');

136 
»suÉ
 +ğ
™
->
£cÚd
;

137 
»suÉ
 += "\n";

140 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k200Ok
);

141 
»¥
->
	`£tStusMes§ge
("OK");

142 
»¥
->
	`£tCÚ‹ÁTy³
("text/plain");

143 
»¥
->
	`£tBody
(
»suÉ
);

147 
¡d
::
veùÜ
<
¡ršg
> 
»suÉ
 = 
	`¥l™
(
»q
.
	`·th
());

151 
boŞ
 
ok
 = 
çl£
;

152 ià(
»suÉ
.
	`size
() == 0)

154 
LOG_DEBUG
 << 
»q
.
	`·th
();

156 ià(
»suÉ
.
	`size
() == 1)

158 
¡ršg
 
moduË
 = 
»suÉ
[0];

159 ià(
moduË
 == "favicon.ico")

161 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k200Ok
);

162 
»¥
->
	`£tStusMes§ge
("OK");

163 
»¥
->
	`£tCÚ‹ÁTy³
("image/png");

164 
»¥
->
	`£tBody
(
	`¡ršg
(
çvicÚ
,  favicon));

166 
ok
 = 
Œue
;

170 
LOG_ERROR
 << "Unim¶em’‹d " << 
moduË
;

175 
¡ršg
 
moduË
 = 
»suÉ
[0];

176 
¡d
::
m­
<
¡ršg
, 
CommªdLi¡
>::
cÚ¡_™”©Ü
 
commLi¡I
 = 
moduËs_
.
	`fšd
(
moduË
);

177 ià(
commLi¡I
 !ğ
moduËs_
.
	`’d
())

179 
¡ršg
 
commªd
 = 
»suÉ
[1];

180 cÚ¡ 
CommªdLi¡
& 
commLi¡
 = 
commLi¡I
->
£cÚd
;

181 
CommªdLi¡
::
cÚ¡_™”©Ü
 
™
 = 
commLi¡
.
	`fšd
(
commªd
);

182 ià(
™
 !ğ
commLi¡
.
	`’d
())

184 
ArgLi¡
 
	`¬gs
(
»suÉ
.
	`begš
()+2,„esuÉ.
	`’d
());

185 ià(
™
->
£cÚd
)

187 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k200Ok
);

188 
»¥
->
	`£tStusMes§ge
("OK");

189 
»¥
->
	`£tCÚ‹ÁTy³
("text/plain");

190 cÚ¡ 
C®lback
& 
cb
 = 
™
->
£cÚd
;

191 
»¥
->
	`£tBody
(
	`cb
(
»q
.
	`m‘hod
(), 
¬gs
));

192 
ok
 = 
Œue
;

199 ià(!
ok
)

201 
»¥
->
	`£tStusCode
(
H‰pRe¥Ú£
::
k404NÙFound
);

202 
»¥
->
	`£tStusMes§ge
("Not Found");

206 
	}
}

208 
	gçvicÚ
[1743] =

	@muduo/net/inspect/Inspector.h

11 #iâdeà
MUDUO_NET_INSPECT_INSPECTOR_H


12 
	#MUDUO_NET_INSPECT_INSPECTOR_H


	)

14 
	~<muduo/ba£/Mu‹x.h
>

15 
	~<muduo/Ãt/h‰p/H‰pReque¡.h
>

16 
	~<muduo/Ãt/h‰p/H‰pS”v”.h
>

18 
	~<m­
>

19 
	~<boo¡/funùiÚ.hµ
>

20 
	~<boo¡/nÚcİyabË.hµ
>

21 
	~<boo¡/scİed_±r.hµ
>

23 
Çme¥aû
 
	gmuduo


25 
Çme¥aû
 
	gÃt


28 
şass
 
	gProûssIn¥eùÜ
;

29 
şass
 
	gP”fÜmªûIn¥eùÜ
;

30 
şass
 
	gSy¡emIn¥eùÜ
;

34 şas 
	cIn¥eùÜ
 : 
boo¡
::
nÚcİyabË


36 
public
:

37 
¡d
::
	tveùÜ
<
	t¡ršg
> 
	tArgLi¡
;

38 
	gboo¡
::
	tfunùiÚ
<
	t¡ršg
 (
	tH‰pReque¡
::
	tM‘hod
, cÚ¡ 
	tArgLi¡
& 
	t¬gs
)> 
	tC®lback
;

39 
In¥eùÜ
(
Ev’tLoİ
* 
loİ
,

40 cÚ¡ 
IÃtAdd»ss
& 
h‰pAddr
,

41 cÚ¡ 
¡ršg
& 
Çme
);

42 ~
In¥eùÜ
();

45 
add
(cÚ¡ 
¡ršg
& 
moduË
,

46 cÚ¡ 
¡ršg
& 
commªd
,

47 cÚ¡ 
C®lback
& 
cb
,

48 cÚ¡ 
¡ršg
& 
h–p
);

49 
»move
(cÚ¡ 
¡ršg
& 
moduË
, cÚ¡ sŒšg& 
commªd
);

51 
	g´iv©e
:

52 
¡d
::
	tm­
<
	t¡ršg
, 
	tC®lback
> 
	tCommªdLi¡
;

53 
	g¡d
::
	tm­
<
	t¡ršg
, sŒšg> 
	tH–pLi¡
;

55 
¡¬t
();

56 
ÚReque¡
(cÚ¡ 
H‰pReque¡
& 
»q
, 
H‰pRe¥Ú£
* 
»¥
);

58 
H‰pS”v”
 
	g£rv”_
;

59 
	gboo¡
::
scİed_±r
<
ProûssIn¥eùÜ
> 
´oûssIn¥eùÜ_
;

60 
	gboo¡
::
scİed_±r
<
P”fÜmªûIn¥eùÜ
> 
³rfÜmªûIn¥eùÜ_
;

61 
	gboo¡
::
scİed_±r
<
Sy¡emIn¥eùÜ
> 
sy¡emIn¥eùÜ_
;

62 
Mu‹xLock
 
	gmu‹x_
;

63 
	g¡d
::
m­
<
¡ršg
, 
	gCommªdLi¡
> 
	gmoduËs_
;

64 
	g¡d
::
m­
<
¡ršg
, 
	gH–pLi¡
> 
	gh–ps_
;

	@muduo/net/inspect/Inspector.h

11 #iâdeà
MUDUO_NET_INSPECT_INSPECTOR_H


12 
	#MUDUO_NET_INSPECT_INSPECTOR_H


	)

14 
	~<muduo/ba£/Mu‹x.h
>

15 
	~<muduo/Ãt/h‰p/H‰pReque¡.h
>

16 
	~<muduo/Ãt/h‰p/H‰pS”v”.h
>

18 
	~<m­
>

19 
	~<boo¡/funùiÚ.hµ
>

20 
	~<boo¡/nÚcİyabË.hµ
>

21 
	~<boo¡/scİed_±r.hµ
>

23 
Çme¥aû
 
	gmuduo


25 
Çme¥aû
 
	gÃt


28 
şass
 
	gProûssIn¥eùÜ
;

29 
şass
 
	gP”fÜmªûIn¥eùÜ
;

30 
şass
 
	gSy¡emIn¥eùÜ
;

34 şas 
	cIn¥eùÜ
 : 
boo¡
::
nÚcİyabË


36 
public
:

37 
¡d
::
	tveùÜ
<
	t¡ršg
> 
	tArgLi¡
;

38 
	gboo¡
::
	tfunùiÚ
<
	t¡ršg
 (
	tH‰pReque¡
::
	tM‘hod
, cÚ¡ 
	tArgLi¡
& 
	t¬gs
)> 
	tC®lback
;

39 
In¥eùÜ
(
Ev’tLoİ
* 
loİ
,

40 cÚ¡ 
IÃtAdd»ss
& 
h‰pAddr
,

41 cÚ¡ 
¡ršg
& 
Çme
);

42 ~
In¥eùÜ
();

45 
add
(cÚ¡ 
¡ršg
& 
moduË
,

46 cÚ¡ 
¡ršg
& 
commªd
,

47 cÚ¡ 
C®lback
& 
cb
,

48 cÚ¡ 
¡ršg
& 
h–p
);

49 
»move
(cÚ¡ 
¡ršg
& 
moduË
, cÚ¡ sŒšg& 
commªd
);

51 
	g´iv©e
:

52 
¡d
::
	tm­
<
	t¡ršg
, 
	tC®lback
> 
	tCommªdLi¡
;

53 
	g¡d
::
	tm­
<
	t¡ršg
, sŒšg> 
	tH–pLi¡
;

55 
¡¬t
();

56 
ÚReque¡
(cÚ¡ 
H‰pReque¡
& 
»q
, 
H‰pRe¥Ú£
* 
»¥
);

58 
H‰pS”v”
 
	g£rv”_
;

59 
	gboo¡
::
scİed_±r
<
ProûssIn¥eùÜ
> 
´oûssIn¥eùÜ_
;

60 
	gboo¡
::
scİed_±r
<
P”fÜmªûIn¥eùÜ
> 
³rfÜmªûIn¥eùÜ_
;

61 
	gboo¡
::
scİed_±r
<
Sy¡emIn¥eùÜ
> 
sy¡emIn¥eùÜ_
;

62 
Mu‹xLock
 
	gmu‹x_
;

63 
	g¡d
::
m­
<
¡ršg
, 
	gCommªdLi¡
> 
	gmoduËs_
;

64 
	g¡d
::
m­
<
¡ršg
, 
	gH–pLi¡
> 
	gh–ps_
;

	@muduo/net/inspect/PerformanceInspector.cc

10 
	~<muduo/Ãt/š¥eù/P”fÜmªûIn¥eùÜ.h
>

11 
	~<muduo/ba£/FeUt.h
>

12 
	~<muduo/ba£/LogSŒ—m.h
>

13 
	~<muduo/ba£/ProûssInfo.h
>

15 
	~<uni¡d.h
>

17 #ifdeà
HAVE_TCMALLOC


18 
	~<g³ráoŞs/m®loc_ex‹nsiÚ.h
>

19 
	~<g³ráoŞs/´of”.h
>

21 
usšg
 
Çme¥aû
 
	gmuduo
;

22 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

24 
	gP”fÜmªûIn¥eùÜ
::
	$»gi¡”Commªds
(
In¥eùÜ
* 
šs
)

26 
šs
->
	`add
("µrof", "h—p", 
P”fÜmªûIn¥eùÜ
::
h—p
, "get heap information");

27 
šs
->
	`add
("µrof", "growth", 
P”fÜmªûIn¥eùÜ
::
growth
, "get heap growth information");

28 
šs
->
	`add
("µrof", "´ofe", 
P”fÜmªûIn¥eùÜ
::
´ofe
,

30 
šs
->
	`add
("µrof", "cmdlše", 
P”fÜmªûIn¥eùÜ
::
cmdlše
, "get command†ine");

31 
šs
->
	`add
("µrof", "mem¡©s", 
P”fÜmªûIn¥eùÜ
::
mem¡©s
, "get memory stats");

32 
šs
->
	`add
("µrof", "memhi¡og¿m", 
P”fÜmªûIn¥eùÜ
::
memhi¡og¿m
, "get memory histogram");

33 
šs
->
	`add
("µrof", "»Ëa£ä“memÜy", 
P”fÜmªûIn¥eùÜ
::
»Ëa£F»eMemÜy
, "release free memory");

34 
	}
}

36 
¡ršg
 
	gP”fÜmªûIn¥eùÜ
::
h—p
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

38 
¡d
::
¡ršg
 
»suÉ
;

39 
	gM®locEx‹nsiÚ
::
š¡ªû
()->
G‘H—pSam¶e
(&
»suÉ
);

40  
¡ršg
(
»suÉ
.
d©a
(),„esuÉ.
size
());

43 
¡ršg
 
	gP”fÜmªûIn¥eùÜ
::
growth
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

45 
¡d
::
¡ršg
 
»suÉ
;

46 
	gM®locEx‹nsiÚ
::
š¡ªû
()->
G‘H—pGrowthScks
(&
»suÉ
);

47  
¡ršg
(
»suÉ
.
d©a
(),„esuÉ.
size
());

50 
¡ršg
 
	gP”fÜmªûIn¥eùÜ
::
´ofe
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

52 
¡ršg
 
f’ame
 = "/tmp/" + 
ProûssInfo
::
´oúame
();

53 
	gf’ame
 += ".";

54 
	gf’ame
 +ğ
ProûssInfo
::
pidSŒšg
();

55 
	gf’ame
 += ".";

56 
	gf’ame
 +ğ
Time¡amp
::
now
().
toSŒšg
();

57 
	gf’ame
 += ".profile";

59 
¡ršg
 
	g´ofe
;

60 ià(
Prof”S¹
(
f’ame
.
c_¡r
()))

63 
	gCu¼’tTh»ad
::
¦“pU£c
(30 * 1000 * 1000);

64 
Prof”Stİ
();

65 
	gFeUt
::
»adFe
(
f’ame
, 1024*1024, &
´ofe
, 
NULL
, NULL);

66 ::
uÆšk
(
f’ame
.
c_¡r
());

68  
	g´ofe
;

71 
¡ršg
 
	gP”fÜmªûIn¥eùÜ
::
cmdlše
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

76 
¡ršg
 
	gP”fÜmªûIn¥eùÜ
::
mem¡©s
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

78 
buf
[1024*64];

79 
	gM®locEx‹nsiÚ
::
š¡ªû
()->
G‘Sts
(
buf
,  buf);

80  
	gbuf
;

83 
¡ršg
 
	gP”fÜmªûIn¥eùÜ
::
memhi¡og¿m
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

85 
blocks
 = 0;

86 
size_t
 
	gtÙ®
 = 0;

87 
	ghi¡og¿m
[
kM®locHi¡og¿mSize
] = { 0, };

89 
	gM®locEx‹nsiÚ
::
š¡ªû
()->
M®locMemÜySts
(&
blocks
, &
tÙ®
, 
hi¡og¿m
);

90 
LogSŒ—m
 
	gs
;

91 
	gs
 << "block " << 
	gblocks
 << "\ÁÙ® " << 
	gtÙ®
 << "\n";

92 
	gi
 = 0; i < 
	gkM®locHi¡og¿mSize
; ++i)

93 
	gs
 << 
	gi
 << " " << 
	ghi¡og¿m
[
i
] << "\n";

94  
	gs
.
bufãr
().
toSŒšg
();

97 
¡ršg
 
	gP”fÜmªûIn¥eùÜ
::
»Ëa£F»eMemÜy
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

99 
buf
[256];

100 
¢´štf
(
buf
,  buf, "memory„elease„ate: %f\nAll free memory„eleased.\n",

101 
M®locEx‹nsiÚ
::
š¡ªû
()->
G‘MemÜyR–—£R©e
());

102 
	gM®locEx‹nsiÚ
::
š¡ªû
()->
R–—£F»eMemÜy
();

103  
	gbuf
;

	@muduo/net/inspect/PerformanceInspector.h

11 #iâdeà
MUDUO_NET_INSPECT_PERFORMANCEINSPECTOR_H


12 
	#MUDUO_NET_INSPECT_PERFORMANCEINSPECTOR_H


	)

14 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


22 şas 
	cP”fÜmªûIn¥eùÜ
 : 
boo¡
::
nÚcİyabË


24 
public
:

25 
»gi¡”Commªds
(
In¥eùÜ
* 
šs
);

27 
¡ršg
 
h—p
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

28 
¡ršg
 
growth
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

29 
¡ršg
 
´ofe
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

30 
¡ršg
 
cmdlše
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

31 
¡ršg
 
mem¡©s
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

32 
¡ršg
 
memhi¡og¿m
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

33 
¡ršg
 
»Ëa£F»eMemÜy
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

35 
¡ršg
 
symbŞ
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

	@muduo/net/inspect/PerformanceInspector.h

11 #iâdeà
MUDUO_NET_INSPECT_PERFORMANCEINSPECTOR_H


12 
	#MUDUO_NET_INSPECT_PERFORMANCEINSPECTOR_H


	)

14 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


22 şas 
	cP”fÜmªûIn¥eùÜ
 : 
boo¡
::
nÚcİyabË


24 
public
:

25 
»gi¡”Commªds
(
In¥eùÜ
* 
šs
);

27 
¡ršg
 
h—p
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

28 
¡ršg
 
growth
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

29 
¡ršg
 
´ofe
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

30 
¡ršg
 
cmdlše
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

31 
¡ršg
 
mem¡©s
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

32 
¡ršg
 
memhi¡og¿m
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

33 
¡ršg
 
»Ëa£F»eMemÜy
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

35 
¡ršg
 
symbŞ
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

	@muduo/net/inspect/ProcessInspector.cc

10 
	~<muduo/Ãt/š¥eù/ProûssIn¥eùÜ.h
>

11 
	~<muduo/ba£/FeUt.h
>

12 
	~<muduo/ba£/ProûssInfo.h
>

13 
	~<lim™s.h
>

14 
	~<¡dio.h
>

15 
	~<¡d¬g.h
>

16 
	~<uni¡d.h
>

18 
usšg
 
Çme¥aû
 
	gmuduo
;

19 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gš¥eù


26 
¡ršg
 
u±ime
(
Time¡amp
 
now
, Time¡am°
¡¬t
, 
boŞ
 
showMiüo£cÚds
)

28 
	gbuf
[256];

29 
št64_t
 
	gage
 = 
now
.
miüoSecÚdsSšûEpoch
(è- 
¡¬t
.microSecondsSinceEpoch();

30 
	g£cÚds
 = 
¡©ic_ÿ¡
<>(
age
 / 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
);

31 
	gdays
 = 
£cÚds
/86400;

32 
	ghours
 = (
£cÚds
 % 86400) / 3600;

33 
	gmšu‹s
 = (
£cÚds
 % 3600) / 60;

34 ià(
	gshowMiüo£cÚds
)

36 
	gmiüo£cÚds
 = 
¡©ic_ÿ¡
<>(
age
 % 
Time¡amp
::
kMiüoSecÚdsP”SecÚd
);

37 
¢´štf
(
buf
,  buf, "%d days %02d:%02d:%02d.%06d",

38 
days
, 
hours
, 
mšu‹s
, 
£cÚds
 % 60, 
miüo£cÚds
);

42 
¢´štf
(
buf
,  buf, "%d days %02d:%02d:%02d",

43 
days
, 
hours
, 
mšu‹s
, 
£cÚds
 % 60);

45  
	gbuf
;

48 
g‘LÚg
(cÚ¡ 
¡ršg
& 
´ocStus
, cÚ¡ * 
key
)

50 
	g»suÉ
 = 0;

51 
size_t
 
	gpos
 = 
´ocStus
.
fšd
(
key
);

52 ià(
	gpos
 !ğ
¡ršg
::
Åos
)

54 
»suÉ
 = ::
©Ş
(
´ocStus
.
c_¡r
(è+ 
pos
 + 
¡¾’
(
key
));

56  
	g»suÉ
;

59 
¡ršg
 
g‘ProûssName
(cÚ¡ sŒšg& 
´ocStus
)

61 
¡ršg
 
	g»suÉ
;

62 
size_t
 
	gpos
 = 
´ocStus
.
fšd
("Name:");

63 ià(
	gpos
 !ğ
¡ršg
::
Åos
)

65 
pos
 +ğ
¡¾’
("Name:");

66 
	g´ocStus
[
pos
] == '\t')

67 ++
pos
;

68 
size_t
 
	geŞ
 = 
pos
;

69 
	g´ocStus
[
eŞ
] != '\n')

70 ++
eŞ
;

71 
	g»suÉ
 = 
´ocStus
.
sub¡r
(
pos
, 
eŞ
-pos);

73  
	g»suÉ
;

76 
SŒšgP›û
 
Ãxt
(SŒšgP›û 
d©a
)

78 cÚ¡ * 
	g¥
 = 
¡©ic_ÿ¡
<cÚ¡ *>(::
memchr
(
d©a
.d©a(), ' ', d©a.
size
()));

79 ià(
	g¥
)

81 
	gd©a
.
»move_´efix
(
¡©ic_ÿ¡
<>(
¥
+1-
d©a
.
begš
()));

82  
	gd©a
;

87 
	gProûssInfo
::
CpuTime
 
g‘CpuTime
(
SŒšgP›û
 
d©a
)

89 
ProûssInfo
::
CpuTime
 
t
;

91 
	gi
 = 0; i < 10; ++i)

93 
	gd©a
 = 
Ãxt
(
d©a
);

95 
	gutime
 = 
¡¹Ş
(
d©a
.d©a(), 
NULL
, 10);

96 
	gd©a
 = 
Ãxt
(
d©a
);

97 
	g¡ime
 = 
¡¹Ş
(
d©a
.d©a(), 
NULL
, 10);

98 cÚ¡ 
	ghz
 = 
¡©ic_ÿ¡
<>(
ProûssInfo
::
şockTicksP”SecÚd
());

99 
	gt
.
	gu£rSecÚds
 = 
¡©ic_ÿ¡
<>(
utime
è/ 
hz
;

100 
	gt
.
	gsy¡emSecÚds
 = 
¡©ic_ÿ¡
<>(
¡ime
è/ 
hz
;

101  
	gt
;

104 
¡ršgPrštf
(
¡ršg
* 
out
, cÚ¡ * 
fmt
, ...è
__©Œibu‹__
 ((
fÜm©
 (
´štf
, 2, 3)));

106 
¡ršgPrštf
(
¡ršg
* 
out
, cÚ¡ * 
fmt
, ...)

108 
	gbuf
[256];

109 
va_li¡
 
	g¬gs
;

110 
va_¡¬t
(
¬gs
, 
fmt
);

111 
	g»t
 = 
v¢´štf
(
buf
,  buf, 
fmt
, 
¬gs
);

112 
va_’d
(
¬gs
);

113 
	gout
->
­³nd
(
buf
);

114  
	g»t
;

120 
usšg
 
Çme¥aû
 
	gmuduo
::
š¥eù
;

122 
¡ršg
 
	gProûssIn¥eùÜ
::
u£ºame_
 = 
ProûssInfo
::
u£ºame
();

124 
	gProûssIn¥eùÜ
::
	$»gi¡”Commªds
(
In¥eùÜ
* 
šs
)

126 
šs
->
	`add
("´oc", "ov”v›w", 
ProûssIn¥eùÜ
::
ov”v›w
, "print basic overview");

127 
šs
->
	`add
("´oc", "pid", 
ProûssIn¥eùÜ
::
pid
, "print…id");

128 
šs
->
	`add
("´oc", "¡©us", 
ProûssIn¥eùÜ
::
´ocStus
, "print /proc/self/status");

130 
šs
->
	`add
("´oc", "th»ads", 
ProûssIn¥eùÜ
::
th»ads
, "list /proc/self/task");

131 
	}
}

133 
¡ršg
 
	gProûssIn¥eùÜ
::
ov”v›w
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

135 
¡ršg
 
»suÉ
;

136 
	g»suÉ
.
»£rve
(1024);

137 
Time¡amp
 
	gnow
 = Time¡amp::
now
();

138 
	g»suÉ
 += "Page generated‡t ";

139 
	g»suÉ
 +ğ
now
.
toFÜm©‹dSŒšg
();

140 
	g»suÉ
 += " (UTC)\nStarted‡t ";

141 
	g»suÉ
 +ğ
ProûssInfo
::
¡¬tTime
().
toFÜm©‹dSŒšg
();

142 
	g»suÉ
 += " (UTC), up for ";

143 
	g»suÉ
 +ğ
u±ime
(
now
, 
ProûssInfo
::
¡¬tTime
(), 
Œue
 );

144 
	g»suÉ
 += "\n";

146 
¡ršg
 
	g´ocStus
 = 
ProûssInfo
::
´ocStus
();

147 
	g»suÉ
 +ğ
g‘ProûssName
(
´ocStus
);

148 
	g»suÉ
 += " (";

149 
	g»suÉ
 +ğ
ProûssInfo
::
exeP©h
();

150 
	g»suÉ
 += ")„unning‡s ";

151 
	g»suÉ
 +ğ
u£ºame_
;

152 
	g»suÉ
 += " on ";

153 
	g»suÉ
 +ğ
ProûssInfo
::
ho¡Çme
();

154 
	g»suÉ
 += "\n";

156 ià(
	gProûssInfo
::
isDebugBud
())

158 
»suÉ
 += "WARNING: debug build!\n";

161 
¡ršgPrštf
(&
»suÉ
, "pid %d,‚um ofhreads %ld, bits %zd\n",

162 
ProûssInfo
::
pid
(), 
g‘LÚg
(
´ocStus
, "Th»ads:"), 
CHAR_BIT
 * (*));

164 
	g»suÉ
 += "Virtual memory: ";

165 
¡ršgPrštf
(&
»suÉ
, "%.3f MiB, ",

166 
¡©ic_ÿ¡
<>(
g‘LÚg
(
´ocStus
, "VmSize:")) / 1024.0);

168 
	g»suÉ
 += "RSS memory: ";

169 
¡ršgPrštf
(&
»suÉ
, "%.3f MiB\n",

170 
¡©ic_ÿ¡
<>(
g‘LÚg
(
´ocStus
, "VmRSS:")) / 1024.0);

174 
¡ršgPrštf
(&
»suÉ
, "Opened files: %d,†imit: %d\n",

175 
ProûssInfo
::
İ’edFes
(), ProûssInfo::
maxO³nFes
());

184 
	gProûssInfo
::
CpuTime
 
t
 = 
ProûssInfo
::
ıuTime
();

185 
¡ršgPrštf
(&
»suÉ
, "Userime: %12.3fs\nSysime: %12.3fs\n",

186 
t
.
u£rSecÚds
,.
sy¡emSecÚds
);

190  
	g»suÉ
;

193 
¡ršg
 
	gProûssIn¥eùÜ
::
pid
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

195 
buf
[32];

196 
¢´štf
(
buf
,  buf, "%d", 
ProûssInfo
::
pid
());

197  
	gbuf
;

200 
¡ršg
 
	gProûssIn¥eùÜ
::
´ocStus
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

202  
ProûssInfo
::
´ocStus
();

205 
¡ršg
 
	gProûssIn¥eùÜ
::
İ’edFes
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

207 
buf
[32];

208 
¢´štf
(
buf
,  buf, "%d", 
ProûssInfo
::
İ’edFes
());

209  
	gbuf
;

212 
¡ršg
 
	gProûssIn¥eùÜ
::
th»ads
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

214 
¡d
::
veùÜ
<
pid_t
> 
th»ads
 = 
ProûssInfo
::threads();

215 
¡ršg
 
	g»suÉ
 = " TID NAME S User Time System Time\n";

216 
	g»suÉ
.
»£rve
(
th»ads
.
size
() * 64);

217 
¡ršg
 
	g¡©
;

218 
size_t
 
	gi
 = 0; i < 
	gth»ads
.
size
(); ++i)

220 
	gbuf
[256];

221 
	gtid
 = 
th»ads
[
i
];

222 
¢´štf
(
buf
,  buf, "/´oc/%d/sk/%d/¡©", 
ProûssInfo
::
pid
(), 
tid
);

223 ià(
	gFeUt
::
»adFe
(
buf
, 65536, &
¡©
) == 0)

225 
SŒšgP›û
 
Çme
 = 
ProûssInfo
::
´oúame
(
¡©
);

226 cÚ¡ * 
	g½
 = 
Çme
.
’d
();

227 
as£¹
(*
½
 == ')');

228 cÚ¡ * 
	g¡©e
 = 
½
 + 2;

229 *
	gcÚ¡_ÿ¡
<*>(
	g½
) = '\0';

230 
SŒšgP›û
 
d©a
(
¡©
);

231 
	gd©a
.
»move_´efix
(
¡©ic_ÿ¡
<>(
¡©e
 - 
d©a
.data() + 2));

232 
	gProûssInfo
::
CpuTime
 
t
 = 
g‘CpuTime
(
d©a
);

233 
¢´štf
(
buf
,  buf, "%5d %-16s %c %12.3f %12.3f\n",

234 
tid
, 
Çme
.
d©a
(), *
¡©e
, 
t
.
u£rSecÚds
,.
sy¡emSecÚds
);

235 
	g»suÉ
 +ğ
buf
;

238  
	g»suÉ
;

	@muduo/net/inspect/ProcessInspector.h

11 #iâdeà
MUDUO_NET_INSPECT_PROCESSINSPECTOR_H


12 
	#MUDUO_NET_INSPECT_PROCESSINSPECTOR_H


	)

14 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


22 şas 
	cProûssIn¥eùÜ
 : 
boo¡
::
nÚcİyabË


24 
public
:

25 
»gi¡”Commªds
(
In¥eùÜ
* 
šs
);

27 
¡ršg
 
ov”v›w
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

28 
¡ršg
 
pid
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

29 
¡ršg
 
´ocStus
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

30 
¡ršg
 
İ’edFes
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

31 
¡ršg
 
th»ads
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

33 
¡ršg
 
	gu£ºame_
;

	@muduo/net/inspect/ProcessInspector.h

11 #iâdeà
MUDUO_NET_INSPECT_PROCESSINSPECTOR_H


12 
	#MUDUO_NET_INSPECT_PROCESSINSPECTOR_H


	)

14 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

15 
	~<boo¡/nÚcİyabË.hµ
>

17 
Çme¥aû
 
	gmuduo


19 
Çme¥aû
 
	gÃt


22 şas 
	cProûssIn¥eùÜ
 : 
boo¡
::
nÚcİyabË


24 
public
:

25 
»gi¡”Commªds
(
In¥eùÜ
* 
šs
);

27 
¡ršg
 
ov”v›w
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

28 
¡ršg
 
pid
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

29 
¡ršg
 
´ocStus
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

30 
¡ršg
 
İ’edFes
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

31 
¡ršg
 
th»ads
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

33 
¡ršg
 
	gu£ºame_
;

	@muduo/net/inspect/SystemInspector.cc

10 
	~<muduo/Ãt/š¥eù/Sy¡emIn¥eùÜ.h
>

11 
	~<muduo/ba£/FeUt.h
>

13 
	~<sys/ut¢ame.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 
Çme¥aû
 
	gmuduo


20 
Çme¥aû
 
	gš¥eù


23 
¡ršg
 
u±ime
(
Time¡amp
 
now
, Time¡am°
¡¬t
, 
boŞ
 
showMiüo£cÚds
);

24 
g‘LÚg
(cÚ¡ 
¡ršg
& 
cÚ‹Á
, cÚ¡ * 
key
);

25 
¡ršgPrštf
(
¡ršg
* 
out
, cÚ¡ * 
fmt
, ...è
__©Œibu‹__
 ((
fÜm©
 (
´štf
, 2, 3)));

30 
usšg
 
Çme¥aû
 
	gmuduo
::
š¥eù
;

32 
	gSy¡emIn¥eùÜ
::
	$»gi¡”Commªds
(
In¥eùÜ
* 
šs
)

34 
šs
->
	`add
("sys", "ov”v›w", 
Sy¡emIn¥eùÜ
::
ov”v›w
, "print system overview");

35 
šs
->
	`add
("sys", "lßdavg", 
Sy¡emIn¥eùÜ
::
lßdavg
, "print /proc/loadavg");

36 
šs
->
	`add
("sys", "v”siÚ", 
Sy¡emIn¥eùÜ
::
v”siÚ
, "print /proc/version");

37 
šs
->
	`add
("sys", "ıušfo", 
Sy¡emIn¥eùÜ
::
ıušfo
, "print /proc/cpuinfo");

38 
šs
->
	`add
("sys", "memšfo", 
Sy¡emIn¥eùÜ
::
memšfo
, "print /proc/meminfo");

39 
šs
->
	`add
("sys", "¡©", 
Sy¡emIn¥eùÜ
::
¡©
, "print /proc/stat");

40 
	}
}

42 
¡ršg
 
	gSy¡emIn¥eùÜ
::
lßdavg
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

44 
¡ršg
 
lßdavg
;

45 
	gFeUt
::
»adFe
("/´oc/lßdavg", 65536, &
lßdavg
);

46  
	glßdavg
;

49 
¡ršg
 
	gSy¡emIn¥eùÜ
::
v”siÚ
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

51 
¡ršg
 
v”siÚ
;

52 
	gFeUt
::
»adFe
("/´oc/v”siÚ", 65536, &
v”siÚ
);

53  
	gv”siÚ
;

56 
¡ršg
 
	gSy¡emIn¥eùÜ
::
ıušfo
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

58 
¡ršg
 
ıušfo
;

59 
	gFeUt
::
»adFe
("/´oc/ıušfo", 65536, &
ıušfo
);

60  
	gıušfo
;

63 
¡ršg
 
	gSy¡emIn¥eùÜ
::
memšfo
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

65 
¡ršg
 
memšfo
;

66 
	gFeUt
::
»adFe
("/´oc/memšfo", 65536, &
memšfo
);

67  
	gmemšfo
;

70 
¡ršg
 
	gSy¡emIn¥eùÜ
::
¡©
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

72 
¡ršg
 
¡©
;

73 
	gFeUt
::
»adFe
("/´oc/¡©", 65536, &
¡©
);

74  
	g¡©
;

77 
¡ršg
 
	gSy¡emIn¥eùÜ
::
ov”v›w
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&)

79 
¡ršg
 
»suÉ
;

80 
	g»suÉ
.
»£rve
(1024);

81 
Time¡amp
 
	gnow
 = Time¡amp::
now
();

82 
	g»suÉ
 += "Page generated‡t ";

83 
	g»suÉ
 +ğ
now
.
toFÜm©‹dSŒšg
();

84 
	g»suÉ
 += " (UTC)\n";

87 
ut¢ame
 
	gun
;

88 ià(::
uÇme
(&
un
) == 0)

90 
¡ršgPrštf
(&
»suÉ
, "Ho¡Çme: %s\n", 
un
.
nod’ame
);

91 
¡ršgPrštf
(&
»suÉ
, "Machše: %s\n", 
un
.
machše
);

92 
¡ršgPrštf
(&
»suÉ
, "OS: % % %s\n", 
un
.
sy¢ame
, un.
»Ëa£
, un.
v”siÚ
);

95 
¡ršg
 
	g¡©
;

96 
	gFeUt
::
»adFe
("/´oc/¡©", 65536, &
¡©
);

97 
Time¡amp
 
boÙTime
(Time¡amp::
kMiüoSecÚdsP”SecÚd
 * 
g‘LÚg
(
¡©
, "btime "));

98 
	g»suÉ
 += "Bootime: ";

99 
	g»suÉ
 +ğ
boÙTime
.
toFÜm©‹dSŒšg
(
çl£
 );

100 
	g»suÉ
 += " (UTC)\n";

101 
	g»suÉ
 += "Upime: ";

102 
	g»suÉ
 +ğ
u±ime
(
now
, 
boÙTime
, 
çl£
 );

103 
	g»suÉ
 += "\n";

107 
¡ršg
 
	glßdavg
;

108 
	gFeUt
::
»adFe
("/´oc/lßdavg", 65536, &
lßdavg
);

109 
¡ršgPrštf
(&
»suÉ
, "Proûs£ ü—‹d: %ld\n", 
g‘LÚg
(
¡©
, "processes "));

110 
¡ršgPrštf
(&
»suÉ
, "Lßdavg: %s\n", 
lßdavg
.
c_¡r
());

115 
¡ršg
 
	gmemšfo
;

116 
	gFeUt
::
»adFe
("/´oc/memšfo", 65536, &
memšfo
);

117 
	gtÙ®_kb
 = 
g‘LÚg
(
memšfo
, "MemTotal:");

118 
	gä“_kb
 = 
g‘LÚg
(
memšfo
, "MemFree:");

119 
	gbufãrs_kb
 = 
g‘LÚg
(
memšfo
, "Buffers:");

120 
	gÿched_kb
 = 
g‘LÚg
(
memšfo
, "Cached:");

122 
¡ršgPrštf
(&
»suÉ
, "TÙ® MemÜy: %6ld MiB\n", 
tÙ®_kb
 / 1024);

123 
¡ršgPrštf
(&
»suÉ
, "F»MemÜy: %6ld MiB\n", 
ä“_kb
 / 1024);

124 
¡ršgPrštf
(&
»suÉ
, "Bufãrs: %6ld MiB\n", 
bufãrs_kb
 / 1024);

125 
¡ršgPrštf
(&
»suÉ
, "Cached: %6ld MiB\n", 
ÿched_kb
 / 1024);

126 
¡ršgPrštf
(&
»suÉ
, "R—ÈU£d: %6ld MiB\n", (
tÙ®_kb
 - 
ä“_kb
 - 
bufãrs_kb
 - 
ÿched_kb
) / 1024);

127 
¡ršgPrštf
(&
»suÉ
, "R—ÈF»e: %6ld MiB\n", (
ä“_kb
 + 
bufãrs_kb
 + 
ÿched_kb
) / 1024);

133  
	g»suÉ
;

	@muduo/net/inspect/SystemInspector.h

11 #iâdeà
MUDUO_NET_INSPECT_SYSTEMINSPECTOR_H


12 
	#MUDUO_NET_INSPECT_SYSTEMINSPECTOR_H


	)

14 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

16 
Çme¥aû
 
	gmuduo


18 
Çme¥aû
 
	gÃt


21 şas 
	cSy¡emIn¥eùÜ
 : 
boo¡
::
nÚcİyabË


23 
public
:

24 
»gi¡”Commªds
(
In¥eùÜ
* 
šs
);

26 
¡ršg
 
ov”v›w
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

27 
¡ršg
 
lßdavg
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

28 
¡ršg
 
v”siÚ
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

29 
¡ršg
 
ıušfo
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

30 
¡ršg
 
memšfo
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

31 
¡ršg
 
¡©
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

	@muduo/net/inspect/SystemInspector.h

11 #iâdeà
MUDUO_NET_INSPECT_SYSTEMINSPECTOR_H


12 
	#MUDUO_NET_INSPECT_SYSTEMINSPECTOR_H


	)

14 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

16 
Çme¥aû
 
	gmuduo


18 
Çme¥aû
 
	gÃt


21 şas 
	cSy¡emIn¥eùÜ
 : 
boo¡
::
nÚcİyabË


23 
public
:

24 
»gi¡”Commªds
(
In¥eùÜ
* 
šs
);

26 
¡ršg
 
ov”v›w
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

27 
¡ršg
 
lßdavg
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

28 
¡ršg
 
v”siÚ
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

29 
¡ršg
 
ıušfo
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

30 
¡ršg
 
memšfo
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

31 
¡ršg
 
¡©
(
H‰pReque¡
::
M‘hod
, cÚ¡ 
In¥eùÜ
::
ArgLi¡
&);

	@muduo/net/inspect/tests/Inspector_test.cc

1 
	~<muduo/Ãt/š¥eù/In¥eùÜ.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

5 
usšg
 
Çme¥aû
 
	gmuduo
;

6 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

8 
	$maš
()

10 
Ev’tLoİ
 
loİ
;

11 
Ev’tLoİTh»ad
 
t
;

12 
In¥eùÜ
 
	`šs
(
t
.
	`¡¬tLoİ
(), 
	`IÃtAdd»ss
(12345), "test");

13 
loİ
.
	`loİ
();

14 
	}
}

	@muduo/net/poller/DefaultPoller.cc

9 
	~<muduo/Ãt/PŞËr.h
>

10 
	~<muduo/Ãt/pŞËr/PŞlPŞËr.h
>

11 
	~<muduo/Ãt/pŞËr/EPŞlPŞËr.h
>

13 
	~<¡dlib.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

17 
PŞËr
* 
	gPŞËr
::
	$ÃwDeçuÉPŞËr
(
Ev’tLoİ
* 
loİ
)

19 ià(::
	`g‘’v
("MUDUO_USE_POLL"))

21  
Ãw
 
	`PŞlPŞËr
(
loİ
);

25  
Ãw
 
	`EPŞlPŞËr
(
loİ
);

27 
	}
}

	@muduo/net/poller/EPollPoller.cc

9 
	~<muduo/Ãt/pŞËr/EPŞlPŞËr.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/Ãt/ChªÃl.h
>

14 
	~<boo¡/¡©ic_as£¹.hµ
>

16 
	~<as£¹.h
>

17 
	~<”ºo.h
>

18 
	~<pŞl.h
>

19 
	~<sys/•Şl.h
>

20 
	~<uni¡d.h
>

22 
usšg
 
Çme¥aû
 
	gmuduo
;

23 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

27 
BOOST_STATIC_ASSERT
(
EPOLLIN
 =ğ
POLLIN
);

28 
BOOST_STATIC_ASSERT
(
EPOLLPRI
 =ğ
POLLPRI
);

29 
BOOST_STATIC_ASSERT
(
EPOLLOUT
 =ğ
POLLOUT
);

30 
BOOST_STATIC_ASSERT
(
EPOLLRDHUP
 =ğ
POLLRDHUP
);

31 
BOOST_STATIC_ASSERT
(
EPOLLERR
 =ğ
POLLERR
);

32 
BOOST_STATIC_ASSERT
(
EPOLLHUP
 =ğ
POLLHUP
);

34 
	gÇme¥aû


36 cÚ¡ 
	gkNew
 = -1;

37 cÚ¡ 
	gkAdded
 = 1;

38 cÚ¡ 
	gkD–‘ed
 = 2;

41 
	gEPŞlPŞËr
::
	$EPŞlPŞËr
(
Ev’tLoİ
* 
loİ
)

42 : 
	`PŞËr
(
loİ
),

43 
	`•Şlfd_
(::
	`•Şl_ü—‹1
(
EPOLL_CLOEXEC
)),

44 
	$ev’ts_
(
kIn™Ev’tLi¡Size
)

46 ià(
•Şlfd_
 < 0)

48 
LOG_SYSFATAL
 << "EPollPoller::EPollPoller";

50 
	}
}

52 
	gEPŞlPŞËr
::~
	$EPŞlPŞËr
()

54 ::
	`şo£
(
•Şlfd_
);

55 
	}
}

57 
Time¡amp
 
	gEPŞlPŞËr
::
	$pŞl
(
timeoutMs
, 
ChªÃlLi¡
* 
aùiveChªÃls
)

59 
LOG_TRACE
 << "fdÙ® couÁ " << 
chªÃls_
.
	`size
();

60 
numEv’ts
 = ::
	`•Şl_wa™
(
•Şlfd_
,

61 &*
ev’ts_
.
	`begš
(),

62 
¡©ic_ÿ¡
<>(
ev’ts_
.
	`size
()),

63 
timeoutMs
);

64 
§vedE¼no
 = 
”ºo
;

65 
Time¡amp
 
	`now
(Timestamp::now());

66 ià(
numEv’ts
 > 0)

68 
LOG_TRACE
 << 
numEv’ts
 << "ƒvents happended";

69 
	`flAùiveChªÃls
(
numEv’ts
, 
aùiveChªÃls
);

70 ià(
im¶ic™_ÿ¡
<
size_t
>(
numEv’ts
è=ğ
ev’ts_
.
	`size
())

72 
ev’ts_
.
	`»size
Óv’ts_.
	`size
()*2);

75 ià(
numEv’ts
 == 0)

77 
LOG_TRACE
 << "nothing happended";

82 ià(
§vedE¼no
 !ğ
EINTR
)

84 
”ºo
 = 
§vedE¼no
;

85 
LOG_SYSERR
 << "EPollPoller::poll()";

88  
now
;

89 
	}
}

91 
	gEPŞlPŞËr
::
	$flAùiveChªÃls
(
numEv’ts
,

92 
ChªÃlLi¡
* 
aùiveChªÃls
) const

94 
	`as£¹
(
im¶ic™_ÿ¡
<
size_t
>(
numEv’ts
è<ğ
ev’ts_
.
	`size
());

95 
i
 = 0; i < 
numEv’ts
; ++i)

97 
ChªÃl
* 
chªÃl
 = 
¡©ic_ÿ¡
<ChªÃl*>(
ev’ts_
[
i
].
d©a
.
±r
);

98 #iâdeà
NDEBUG


99 
fd
 = 
chªÃl
->
	`fd
();

100 
ChªÃlM­
::
cÚ¡_™”©Ü
 
™
 = 
chªÃls_
.
	`fšd
(
fd
);

101 
	`as£¹
(
™
 !ğ
chªÃls_
.
	`’d
());

102 
	`as£¹
(
™
->
£cÚd
 =ğ
chªÃl
);

104 
chªÃl
->
	`£t_»v’ts
(
ev’ts_
[
i
].
ev’ts
);

105 
aùiveChªÃls
->
	`push_back
(
chªÃl
);

107 
	}
}

109 
	gEPŞlPŞËr
::
	$upd©eChªÃl
(
ChªÃl
* 
chªÃl
)

111 
PŞËr
::
	`as£¹InLoİTh»ad
();

112 cÚ¡ 
šdex
 = 
chªÃl
->
	`šdex
();

113 
LOG_TRACE
 << "fd = " << 
chªÃl
->
	`fd
()

114 << "ƒv’t ğ" << 
chªÃl
->
	`ev’ts
(è<< " index = " << 
šdex
;

115 ià(
šdex
 =ğ
kNew
 || index =ğ
kD–‘ed
)

118 
fd
 = 
chªÃl
->
	`fd
();

119 ià(
šdex
 =ğ
kNew
)

121 
	`as£¹
(
chªÃls_
.
	`fšd
(
fd
è=ğchªÃls_.
	`’d
());

122 
chªÃls_
[
fd
] = 
chªÃl
;

126 
	`as£¹
(
chªÃls_
.
	`fšd
(
fd
è!ğchªÃls_.
	`’d
());

127 
	`as£¹
(
chªÃls_
[
fd
] =ğ
chªÃl
);

130 
chªÃl
->
	`£t_šdex
(
kAdded
);

131 
	`upd©e
(
EPOLL_CTL_ADD
, 
chªÃl
);

136 
fd
 = 
chªÃl
->
	`fd
();

137 ()
fd
;

138 
	`as£¹
(
chªÃls_
.
	`fšd
(
fd
è!ğchªÃls_.
	`’d
());

139 
	`as£¹
(
chªÃls_
[
fd
] =ğ
chªÃl
);

140 
	`as£¹
(
šdex
 =ğ
kAdded
);

141 ià(
chªÃl
->
	`isNÚeEv’t
())

143 
	`upd©e
(
EPOLL_CTL_DEL
, 
chªÃl
);

144 
chªÃl
->
	`£t_šdex
(
kD–‘ed
);

148 
	`upd©e
(
EPOLL_CTL_MOD
, 
chªÃl
);

151 
	}
}

153 
	gEPŞlPŞËr
::
	$»moveChªÃl
(
ChªÃl
* 
chªÃl
)

155 
PŞËr
::
	`as£¹InLoİTh»ad
();

156 
fd
 = 
chªÃl
->
	`fd
();

157 
LOG_TRACE
 << "fd = " << 
fd
;

158 
	`as£¹
(
chªÃls_
.
	`fšd
(
fd
è!ğchªÃls_.
	`’d
());

159 
	`as£¹
(
chªÃls_
[
fd
] =ğ
chªÃl
);

160 
	`as£¹
(
chªÃl
->
	`isNÚeEv’t
());

161 
šdex
 = 
chªÃl
->
	`šdex
();

162 
	`as£¹
(
šdex
 =ğ
kAdded
 || index =ğ
kD–‘ed
);

163 
size_t
 
n
 = 
chªÃls_
.
	`”a£
(
fd
);

164 ()
n
;

165 
	`as£¹
(
n
 == 1);

167 ià(
šdex
 =ğ
kAdded
)

169 
	`upd©e
(
EPOLL_CTL_DEL
, 
chªÃl
);

171 
chªÃl
->
	`£t_šdex
(
kNew
);

172 
	}
}

174 
	gEPŞlPŞËr
::
	$upd©e
(
İ”©iÚ
, 
ChªÃl
* 
chªÃl
)

176 
•Şl_ev’t
 
ev’t
;

177 
	`bz”o
(&
ev’t
, ƒvent);

178 
ev’t
.
ev’ts
 = 
chªÃl
->
	`ev’ts
();

179 
ev’t
.
d©a
.
±r
 = 
chªÃl
;

180 
fd
 = 
chªÃl
->
	`fd
();

181 
LOG_TRACE
 << "•Şl_ùÈİ = " << 
	`İ”©iÚToSŒšg
(
İ”©iÚ
)

182 << " fd = " << 
fd
 << "ƒv’ˆğ{ " << 
chªÃl
->
	`ev’tsToSŒšg
() << " }";

183 ià(::
	`•Şl_ùl
(
•Şlfd_
, 
İ”©iÚ
, 
fd
, &
ev’t
) < 0)

185 ià(
İ”©iÚ
 =ğ
EPOLL_CTL_DEL
)

187 
LOG_SYSERR
 << "•Şl_ùÈİ =" << 
	`İ”©iÚToSŒšg
(
İ”©iÚ
è<< " fd =" << 
fd
;

191 
LOG_SYSFATAL
 << "•Şl_ùÈİ =" << 
	`İ”©iÚToSŒšg
(
İ”©iÚ
è<< " fd =" << 
fd
;

194 
	}
}

196 cÚ¡ * 
	gEPŞlPŞËr
::
	$İ”©iÚToSŒšg
(
İ
)

198 
İ
)

200 
EPOLL_CTL_ADD
:

202 
EPOLL_CTL_DEL
:

204 
EPOLL_CTL_MOD
:

207 
	`as£¹
(
çl£
 && "ERROR op");

210 
	}
}

	@muduo/net/poller/EPollPoller.h

11 #iâdeà
MUDUO_NET_POLLER_EPOLLPOLLER_H


12 
	#MUDUO_NET_POLLER_EPOLLPOLLER_H


	)

14 
	~<muduo/Ãt/PŞËr.h
>

16 
	~<veùÜ
>

18 
	g•Şl_ev’t
;

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


28 şas 
	cEPŞlPŞËr
 : 
public
 
PŞËr


30 
public
:

31 
EPŞlPŞËr
(
Ev’tLoİ
* 
loİ
);

32 
	gvœtu®
 ~
EPŞlPŞËr
();

34 
vœtu®
 
Time¡amp
 
pŞl
(
timeoutMs
, 
ChªÃlLi¡
* 
aùiveChªÃls
);

35 
vœtu®
 
upd©eChªÃl
(
ChªÃl
* 
chªÃl
);

36 
vœtu®
 
»moveChªÃl
(
ChªÃl
* 
chªÃl
);

38 
	g´iv©e
:

40 cÚ¡ 
kIn™Ev’tLi¡Size
 = 16;

42 cÚ¡ * 
İ”©iÚToSŒšg
(
İ
);

44 
flAùiveChªÃls
(
numEv’ts
,

45 
ChªÃlLi¡
* 
aùiveChªÃls
) const;

47 
upd©e
(
İ”©iÚ
, 
ChªÃl
* 
chªÃl
);

49 
	g¡d
::
	tveùÜ
<
	t•Şl_ev’t
> 
	tEv’tLi¡
;

52 
	g•Şlfd_
;

54 
Ev’tLi¡
 
	gev’ts_
;

	@muduo/net/poller/EPollPoller.h

11 #iâdeà
MUDUO_NET_POLLER_EPOLLPOLLER_H


12 
	#MUDUO_NET_POLLER_EPOLLPOLLER_H


	)

14 
	~<muduo/Ãt/PŞËr.h
>

16 
	~<veùÜ
>

18 
	g•Şl_ev’t
;

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


28 şas 
	cEPŞlPŞËr
 : 
public
 
PŞËr


30 
public
:

31 
EPŞlPŞËr
(
Ev’tLoİ
* 
loİ
);

32 
	gvœtu®
 ~
EPŞlPŞËr
();

34 
vœtu®
 
Time¡amp
 
pŞl
(
timeoutMs
, 
ChªÃlLi¡
* 
aùiveChªÃls
);

35 
vœtu®
 
upd©eChªÃl
(
ChªÃl
* 
chªÃl
);

36 
vœtu®
 
»moveChªÃl
(
ChªÃl
* 
chªÃl
);

38 
	g´iv©e
:

40 cÚ¡ 
kIn™Ev’tLi¡Size
 = 16;

42 cÚ¡ * 
İ”©iÚToSŒšg
(
İ
);

44 
flAùiveChªÃls
(
numEv’ts
,

45 
ChªÃlLi¡
* 
aùiveChªÃls
) const;

47 
upd©e
(
İ”©iÚ
, 
ChªÃl
* 
chªÃl
);

49 
	g¡d
::
	tveùÜ
<
	t•Şl_ev’t
> 
	tEv’tLi¡
;

52 
	g•Şlfd_
;

54 
Ev’tLi¡
 
	gev’ts_
;

	@muduo/net/poller/PollPoller.cc

9 
	~<muduo/Ãt/pŞËr/PŞlPŞËr.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/ba£/Ty³s.h
>

13 
	~<muduo/Ãt/ChªÃl.h
>

15 
	~<as£¹.h
>

16 
	~<”ºo.h
>

17 
	~<pŞl.h
>

19 
usšg
 
Çme¥aû
 
	gmuduo
;

20 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

22 
	gPŞlPŞËr
::
	$PŞlPŞËr
(
Ev’tLoİ
* 
loİ
)

23 : 
	$PŞËr
(
loİ
)

25 
	}
}

27 
PŞlPŞËr
::~
	$PŞlPŞËr
()

29 
	}
}

31 
Time¡amp
 
PŞlPŞËr
::
	$pŞl
(
timeoutMs
, 
ChªÃlLi¡
* 
aùiveChªÃls
)

34 
numEv’ts
 = ::
	`pŞl
(&*
pŞlfds_
.
	`begš
(),…Şlfds_.
	`size
(), 
timeoutMs
);

35 
§vedE¼no
 = 
”ºo
;

36 
Time¡amp
 
	`now
(Timestamp::now());

37 ià(
numEv’ts
 > 0)

39 
LOG_TRACE
 << 
numEv’ts
 << "ƒvents happended";

40 
	`flAùiveChªÃls
(
numEv’ts
, 
aùiveChªÃls
);

42 ià(
numEv’ts
 == 0)

44 
LOG_TRACE
 << "‚othing happended";

48 ià(
§vedE¼no
 !ğ
EINTR
)

50 
”ºo
 = 
§vedE¼no
;

51 
LOG_SYSERR
 << "PollPoller::poll()";

54  
now
;

55 
	}
}

57 
	gPŞlPŞËr
::
	$flAùiveChªÃls
(
numEv’ts
,

58 
ChªÃlLi¡
* 
aùiveChªÃls
) const

60 
PŞlFdLi¡
::
cÚ¡_™”©Ü
 
pfd
 = 
pŞlfds_
.
	`begš
();

61 
pfd
 !ğ
pŞlfds_
.
	`’d
(è&& 
numEv’ts
 > 0; ++pfd)

63 ià(
pfd
->
»v’ts
 > 0)

65 --
numEv’ts
;

66 
ChªÃlM­
::
cÚ¡_™”©Ü
 
ch
 = 
chªÃls_
.
	`fšd
(
pfd
->
fd
);

67 
	`as£¹
(
ch
 !ğ
chªÃls_
.
	`’d
());

68 
ChªÃl
* 
chªÃl
 = 
ch
->
£cÚd
;

69 
	`as£¹
(
chªÃl
->
	`fd
(è=ğ
pfd
->
fd
);

70 
chªÃl
->
	`£t_»v’ts
(
pfd
->
»v’ts
);

72 
aùiveChªÃls
->
	`push_back
(
chªÃl
);

75 
	}
}

77 
	gPŞlPŞËr
::
	$upd©eChªÃl
(
ChªÃl
* 
chªÃl
)

79 
PŞËr
::
	`as£¹InLoİTh»ad
();

80 
LOG_TRACE
 << "fd = " << 
chªÃl
->
	`fd
(è<< "ƒv’t ğ" << chªÃl->
	`ev’ts
();

81 ià(
chªÃl
->
	`šdex
() < 0)

84 
	`as£¹
(
chªÃls_
.
	`fšd
(
chªÃl
->
	`fd
()è=ğchªÃls_.
	`’d
());

85 
pŞlfd
 
pfd
;

86 
pfd
.
fd
 = 
chªÃl
->
	`fd
();

87 
pfd
.
ev’ts
 = 
¡©ic_ÿ¡
<>(
chªÃl
->
	`ev’ts
());

88 
pfd
.
»v’ts
 = 0;

89 
pŞlfds_
.
	`push_back
(
pfd
);

90 
idx
 = 
¡©ic_ÿ¡
<>(
pŞlfds_
.
	`size
())-1;

91 
chªÃl
->
	`£t_šdex
(
idx
);

92 
chªÃls_
[
pfd
.
fd
] = 
chªÃl
;

97 
	`as£¹
(
chªÃls_
.
	`fšd
(
chªÃl
->
	`fd
()è!ğchªÃls_.
	`’d
());

98 
	`as£¹
(
chªÃls_
[
chªÃl
->
	`fd
()] == channel);

99 
idx
 = 
chªÃl
->
	`šdex
();

100 
	`as£¹
(0 <ğ
idx
 && idx < 
¡©ic_ÿ¡
<>(
pŞlfds_
.
	`size
()));

101 
pŞlfd
& 
pfd
 = 
pŞlfds_
[
idx
];

102 
	`as£¹
(
pfd
.
fd
 =ğ
chªÃl
->
	`fd
() ||…fd.fd == -channel->fd()-1);

103 
pfd
.
fd
 = 
chªÃl
->
	`fd
();

104 
pfd
.
ev’ts
 = 
¡©ic_ÿ¡
<>(
chªÃl
->
	`ev’ts
());

105 
pfd
.
»v’ts
 = 0;

106 ià(
chªÃl
->
	`isNÚeEv’t
())

109 
pfd
.
fd
 = -
chªÃl
->
	`fd
()-1;

112 
	}
}

114 
	gPŞlPŞËr
::
	$»moveChªÃl
(
ChªÃl
* 
chªÃl
)

116 
PŞËr
::
	`as£¹InLoİTh»ad
();

117 
LOG_TRACE
 << "fd = " << 
chªÃl
->
	`fd
();

118 
	`as£¹
(
chªÃls_
.
	`fšd
(
chªÃl
->
	`fd
()è!ğchªÃls_.
	`’d
());

119 
	`as£¹
(
chªÃls_
[
chªÃl
->
	`fd
()] == channel);

120 
	`as£¹
(
chªÃl
->
	`isNÚeEv’t
());

121 
idx
 = 
chªÃl
->
	`šdex
();

122 
	`as£¹
(0 <ğ
idx
 && idx < 
¡©ic_ÿ¡
<>(
pŞlfds_
.
	`size
()));

123 cÚ¡ 
pŞlfd
& 
pfd
 = 
pŞlfds_
[
idx
]; ()pfd;

124 
	`as£¹
(
pfd
.
fd
 =ğ-
chªÃl
->
	`fd
()-1 &&…fd.
ev’ts
 =ğchªÃl->
	`ev’ts
());

125 
size_t
 
n
 = 
chªÃls_
.
	`”a£
(
chªÃl
->
	`fd
());

126 
	`as£¹
(
n
 == 1); ()n;

127 ià(
im¶ic™_ÿ¡
<
size_t
>(
idx
è=ğ
pŞlfds_
.
	`size
()-1)

129 
pŞlfds_
.
	`pİ_back
();

133 
chªÃlAtEnd
 = 
pŞlfds_
.
	`back
().
fd
;

134 
	`™”_sw­
(
pŞlfds_
.
	`begš
()+
idx
,…Şlfds_.
	`’d
()-1);

135 ià(
chªÃlAtEnd
 < 0)

137 
chªÃlAtEnd
 = -channelAtEnd-1;

139 
chªÃls_
[
chªÃlAtEnd
]->
	`£t_šdex
(
idx
);

140 
pŞlfds_
.
	`pİ_back
();

142 
	}
}

	@muduo/net/poller/PollPoller.h

11 #iâdeà
MUDUO_NET_POLLER_POLLPOLLER_H


12 
	#MUDUO_NET_POLLER_POLLPOLLER_H


	)

14 
	~<muduo/Ãt/PŞËr.h
>

16 
	~<veùÜ
>

18 
	gpŞlfd
;

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


28 şas 
	cPŞlPŞËr
 : 
public
 
PŞËr


30 
public
:

32 
PŞlPŞËr
(
Ev’tLoİ
* 
loİ
);

33 
	gvœtu®
 ~
PŞlPŞËr
();

35 
vœtu®
 
Time¡amp
 
pŞl
(
timeoutMs
, 
ChªÃlLi¡
* 
aùiveChªÃls
);

36 
vœtu®
 
upd©eChªÃl
(
ChªÃl
* 
chªÃl
);

37 
vœtu®
 
»moveChªÃl
(
ChªÃl
* 
chªÃl
);

39 
	g´iv©e
:

40 
flAùiveChªÃls
(
numEv’ts
,

41 
ChªÃlLi¡
* 
aùiveChªÃls
) const;

43 
	g¡d
::
	tveùÜ
<
	tpŞlfd
> 
	tPŞlFdLi¡
;

44 
PŞlFdLi¡
 
	gpŞlfds_
;

	@muduo/net/poller/PollPoller.h

11 #iâdeà
MUDUO_NET_POLLER_POLLPOLLER_H


12 
	#MUDUO_NET_POLLER_POLLPOLLER_H


	)

14 
	~<muduo/Ãt/PŞËr.h
>

16 
	~<veùÜ
>

18 
	gpŞlfd
;

20 
Çme¥aû
 
	gmuduo


22 
Çme¥aû
 
	gÃt


28 şas 
	cPŞlPŞËr
 : 
public
 
PŞËr


30 
public
:

32 
PŞlPŞËr
(
Ev’tLoİ
* 
loİ
);

33 
	gvœtu®
 ~
PŞlPŞËr
();

35 
vœtu®
 
Time¡amp
 
pŞl
(
timeoutMs
, 
ChªÃlLi¡
* 
aùiveChªÃls
);

36 
vœtu®
 
upd©eChªÃl
(
ChªÃl
* 
chªÃl
);

37 
vœtu®
 
»moveChªÃl
(
ChªÃl
* 
chªÃl
);

39 
	g´iv©e
:

40 
flAùiveChªÃls
(
numEv’ts
,

41 
ChªÃlLi¡
* 
aùiveChªÃls
) const;

43 
	g¡d
::
	tveùÜ
<
	tpŞlfd
> 
	tPŞlFdLi¡
;

44 
PŞlFdLi¡
 
	gpŞlfds_
;

	@muduo/net/protobuf/BufferStream.h

9 #´agm¨
Úû


10 
	~<muduo/Ãt/Bufãr.h
>

11 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am.h
>

12 
Çme¥aû
 
	gmuduo


14 
Çme¥aû
 
	gÃt


22 şas 
	cBufãrOuutSŒ—m
 : 
public
 
googË
::
´Ùobuf
::
io
::
Z”oCİyOuutSŒ—m


24 
public
:

25 
BufãrOuutSŒ—m
(
Bufãr
* 
buf
)

26 : 
bufãr_
(
CHECK_NOTNULL
(
buf
)),

27 
Üigš®Size_
(
bufãr_
->
»adabËBy‹s
())

31 
vœtu®
 
boŞ
 
Next
(** 
d©a
, * 
size
)

33 
	gbufãr_
->
’su»Wr™abËBy‹s
(4096);

34 *
	gd©a
 = 
bufãr_
->
begšWr™e
();

35 *
	gsize
 = 
¡©ic_ÿ¡
<>(
bufãr_
->
wr™abËBy‹s
());

36 
	gbufãr_
->
hasWr™‹n
(*
size
);

37  
	gŒue
;

40 
vœtu®
 
BackUp
(
couÁ
)

42 
	gbufãr_
->
unwr™e
(
couÁ
);

45 
vœtu®
 
št64_t
 
By‹CouÁ
() const

47  
	gbufãr_
->
»adabËBy‹s
(è- 
	gÜigš®Size_
;

50 
	g´iv©e
:

51 
Bufãr
* 
bufãr_
;

52 
size_t
 
	gÜigš®Size_
;

	@muduo/net/protobuf/BufferStream.h

9 #´agm¨
Úû


10 
	~<muduo/Ãt/Bufãr.h
>

11 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am.h
>

12 
Çme¥aû
 
	gmuduo


14 
Çme¥aû
 
	gÃt


22 şas 
	cBufãrOuutSŒ—m
 : 
public
 
googË
::
´Ùobuf
::
io
::
Z”oCİyOuutSŒ—m


24 
public
:

25 
BufãrOuutSŒ—m
(
Bufãr
* 
buf
)

26 : 
bufãr_
(
CHECK_NOTNULL
(
buf
)),

27 
Üigš®Size_
(
bufãr_
->
»adabËBy‹s
())

31 
vœtu®
 
boŞ
 
Next
(** 
d©a
, * 
size
)

33 
	gbufãr_
->
’su»Wr™abËBy‹s
(4096);

34 *
	gd©a
 = 
bufãr_
->
begšWr™e
();

35 *
	gsize
 = 
¡©ic_ÿ¡
<>(
bufãr_
->
wr™abËBy‹s
());

36 
	gbufãr_
->
hasWr™‹n
(*
size
);

37  
	gŒue
;

40 
vœtu®
 
BackUp
(
couÁ
)

42 
	gbufãr_
->
unwr™e
(
couÁ
);

45 
vœtu®
 
št64_t
 
By‹CouÁ
() const

47  
	gbufãr_
->
»adabËBy‹s
(è- 
	gÜigš®Size_
;

50 
	g´iv©e
:

51 
Bufãr
* 
bufãr_
;

52 
size_t
 
	gÜigš®Size_
;

	@muduo/net/protobuf/ProtobufCodecLite.cc

9 
	~<muduo/Ãt/´Ùobuf/PrÙobufCodecL™e.h
>

12 
	~<muduo/ba£/Loggšg.h
>

13 
	~<muduo/Ãt/EndŸn.h
>

14 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

15 
	~<muduo/Ãt/´ÙÜpc/googË-šl.h
>

17 
	~<googË/´Ùobuf/mes§ge.h
>

18 
	~<zlib.h
>

20 
usšg
 
Çme¥aû
 
	gmuduo
;

21 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

23 
	gÇme¥aû


25 
PrÙobufV”siÚCheck
()

27 
	gGOOGLE_PROTOBUF_VERIFY_VERSION
;

30 
__©Œibu‹__
 ((
unu£d
)è
	gdummy
 = 
PrÙobufV”siÚCheck
();

33 
	gPrÙobufCodecL™e
::
£nd
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

34 cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
)

37 
muduo
::
Ãt
::
Bufãr
 
buf
;

38 
flEm±yBufãr
(&
buf
, 
mes§ge
);

39 
	gcÚn
->
£nd
(&
buf
);

42 
	gPrÙobufCodecL™e
::
flEm±yBufãr
(
muduo
::
Ãt
::
Bufãr
* 
buf
,

43 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
)

45 
as£¹
(
buf
->
»adabËBy‹s
() == 0);

47 
	gbuf
->
­³nd
(
g_
);

49 
	gby‹_size
 = 
£rŸlizeToBufãr
(
mes§ge
, 
buf
);

51 
št32_t
 
	gcheckSum
 = 
checksum
(
buf
->
³ek
(), 
¡©ic_ÿ¡
<>(buf->
»adabËBy‹s
()));

52 
	gbuf
->
­³ndIÁ32
(
checkSum
);

53 
as£¹
(
buf
->
»adabËBy‹s
(è=ğ
g_
.
size
(è+ 
by‹_size
 + 
kChecksumL’
); (è
	gby‹_size
;

54 
št32_t
 
	gËn
 = 
sock‘s
::
ho¡ToN‘wÜk32
(
¡©ic_ÿ¡
<št32_t>(
buf
->
»adabËBy‹s
()));

55 
	gbuf
->
´•’d
(&
Ën
, †en);

58 
	gPrÙobufCodecL™e
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

59 
Bufãr
* 
buf
,

60 
Time¡amp
 
»ûiveTime
)

62 
buf
->
	`»adabËBy‹s
(è>ğ
¡©ic_ÿ¡
<
ušt32_t
>(
kMšMes§geL’
+
kH—d”L’
))

64 cÚ¡ 
št32_t
 
Ën
 = 
buf
->
	`³ekIÁ32
();

65 ià(
Ën
 > 
kMaxMes§geL’
 ||†’ < 
kMšMes§geL’
)

67 
	`”rÜC®lback_
(
cÚn
, 
buf
, 
»ûiveTime
, 
kInv®idL’gth
);

70 ià(
buf
->
	`»adabËBy‹s
(è>ğ
im¶ic™_ÿ¡
<
size_t
>(
kH—d”L’
+
Ën
))

72 ià(
¿wCb_
 && !
	`¿wCb_
(
cÚn
, 
	`SŒšgP›û
(
buf
->
	`³ek
(), 
kH—d”L’
+
Ën
), 
»ûiveTime
))

74 
buf
->
	`»Œ›ve
(
kH—d”L’
+
Ën
);

77 
Mes§gePŒ
 
	`mes§ge
(
´ÙÙy³_
->
	`New
());

79 
E¼ÜCode
 
”rÜCode
 = 
	`·r£
(
buf
->
	`³ek
()+
kH—d”L’
, 
Ën
, 
mes§ge
.
	`g‘
());

80 ià(
”rÜCode
 =ğ
kNoE¼Ü
)

83 
	`mes§geC®lback_
(
cÚn
, 
mes§ge
, 
»ûiveTime
);

84 
buf
->
	`»Œ›ve
(
kH—d”L’
+
Ën
);

88 
	`”rÜC®lback_
(
cÚn
, 
buf
, 
»ûiveTime
, 
”rÜCode
);

97 
	}
}

99 
boŞ
 
	gPrÙobufCodecL™e
::
·r£FromBufãr
(
SŒšgP›û
 
buf
, 
googË
::
´Ùobuf
::
Mes§ge
* 
mes§ge
)

101  
mes§ge
->
P¬£FromA¼ay
(
buf
.
d©a
(), buf.
size
());

104 
	gPrÙobufCodecL™e
::
£rŸlizeToBufãr
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
, 
Bufãr
* 
buf
)

112 
GOOGLE_DCHECK
(
mes§ge
.
IsIn™Ÿlized
()è<< 
In™Ÿliz©iÚE¼ÜMes§ge
("serialize", message);

114 
	gby‹_size
 = 
mes§ge
.
By‹Size
();

115 
	gbuf
->
’su»Wr™abËBy‹s
(
by‹_size
 + 
kChecksumL’
);

117 
ušt8_t
* 
	g¡¬t
 = 
»š‹½»t_ÿ¡
<ušt8_t*>(
buf
->
begšWr™e
());

118 
ušt8_t
* 
	g’d
 = 
mes§ge
.
S”ŸlizeW™hCachedSizesToA¼ay
(
¡¬t
);

119 ià(
	g’d
 - 
	g¡¬t
 !ğ
by‹_size
)

121 
By‹SizeCÚsi¡’cyE¼Ü
(
by‹_size
, 
mes§ge
.
By‹Size
(), 
¡©ic_ÿ¡
<>(
’d
 - 
¡¬t
));

123 
	gbuf
->
hasWr™‹n
(
by‹_size
);

124  
	gby‹_size
;

127 
	gÇme¥aû


129 cÚ¡ 
¡ršg
 
	gkNoE¼ÜSŒ
 = "NoError";

130 cÚ¡ 
¡ršg
 
	gkInv®idL’gthSŒ
 = "InvalidLength";

131 cÚ¡ 
¡ršg
 
	gkCheckSumE¼ÜSŒ
 = "CheckSumError";

132 cÚ¡ 
¡ršg
 
	gkInv®idNameL’SŒ
 = "InvalidNameLen";

133 cÚ¡ 
¡ršg
 
	gkUnknownMes§geTy³SŒ
 = "UnknownMessageType";

134 cÚ¡ 
¡ršg
 
	gkP¬£E¼ÜSŒ
 = "ParseError";

135 cÚ¡ 
¡ršg
 
	gkUnknownE¼ÜSŒ
 = "UnknownError";

138 cÚ¡ 
	g¡ršg
& 
	gPrÙobufCodecL™e
::
	$”rÜCodeToSŒšg
(
E¼ÜCode
 
”rÜCode
)

140 
”rÜCode
)

142 
kNoE¼Ü
:

143  
kNoE¼ÜSŒ
;

144 
kInv®idL’gth
:

145  
kInv®idL’gthSŒ
;

146 
kCheckSumE¼Ü
:

147  
kCheckSumE¼ÜSŒ
;

148 
kInv®idNameL’
:

149  
kInv®idNameL’SŒ
;

150 
kUnknownMes§geTy³
:

151  
kUnknownMes§geTy³SŒ
;

152 
kP¬£E¼Ü
:

153  
kP¬£E¼ÜSŒ
;

155  
kUnknownE¼ÜSŒ
;

157 
	}
}

159 
	gPrÙobufCodecL™e
::
	$deçuÉE¼ÜC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

160 
Bufãr
* 
buf
,

161 
Time¡amp
,

162 
E¼ÜCode
 
”rÜCode
)

164 
LOG_ERROR
 << "PrÙobufCodecL™e::deçuÉE¼ÜC®lback - " << 
	`”rÜCodeToSŒšg
(
”rÜCode
);

165 ià(
cÚn
 && cÚn->
	`cÚÃùed
())

167 
cÚn
->
	`shutdown
();

169 
	}
}

171 
št32_t
 
	gPrÙobufCodecL™e
::
	$asIÁ32
(cÚ¡ * 
buf
)

173 
št32_t
 
be32
 = 0;

174 ::
	`memıy
(&
be32
, 
buf
, (be32));

175  
sock‘s
::
	`ÃtwÜkToHo¡32
(
be32
);

176 
	}
}

178 
št32_t
 
	gPrÙobufCodecL™e
::
	$checksum
(cÚ¡ * 
buf
, 
Ën
)

180  
¡©ic_ÿ¡
<
št32_t
>(

181 ::
	`adËr32
(1, 
¡©ic_ÿ¡
<cÚ¡ 
By‹f
*>(
buf
), 
Ën
));

182 
	}
}

184 
boŞ
 
	gPrÙobufCodecL™e
::
	$v®id©eChecksum
(cÚ¡ * 
buf
, 
Ën
)

187 
št32_t
 
ex³ùedCheckSum
 = 
	`asIÁ32
(
buf
 + 
Ën
 - 
kChecksumL’
);

188 
št32_t
 
checkSum
 = 
	`checksum
(
buf
, 
Ën
 - 
kChecksumL’
);

189  
checkSum
 =ğ
ex³ùedCheckSum
;

190 
	}
}

192 
	gPrÙobufCodecL™e
::
E¼ÜCode
 
PrÙobufCodecL™e
::
·r£
(cÚ¡ * 
buf
,

193 
Ën
,

194 ::
googË
::
´Ùobuf
::
Mes§ge
* 
mes§ge
)

196 
E¼ÜCode
 
”rÜ
 = 
kNoE¼Ü
;

198 ià(
v®id©eChecksum
(
buf
, 
Ën
))

200 ià(
memcmp
(
buf
, 
g_
.
d©a
(),ag_.
size
()) == 0)

203 cÚ¡ * 
d©a
 = 
buf
 + 
g_
.
size
();

204 
št32_t
 
	gd©aL’
 = 
Ën
 - 
kChecksumL’
 - 
¡©ic_ÿ¡
<>(
g_
.
size
());

205 ià(
·r£FromBufãr
(
SŒšgP›û
(
d©a
, 
d©aL’
), 
mes§ge
))

207 
	g”rÜ
 = 
kNoE¼Ü
;

211 
	g”rÜ
 = 
kP¬£E¼Ü
;

216 
	g”rÜ
 = 
kUnknownMes§geTy³
;

221 
	g”rÜ
 = 
kCheckSumE¼Ü
;

224  
	g”rÜ
;

	@muduo/net/protobuf/ProtobufCodecLite.h

14 #iâdeà
MUDUO_NET_PROTOBUF_CODEC_H


15 
	#MUDUO_NET_PROTOBUF_CODEC_H


	)

17 
	~<muduo/ba£/SŒšgP›û.h
>

18 
	~<muduo/ba£/Time¡amp.h
>

20 
	~<muduo/Ãt/C®lbacks.h
>

22 
	~<boo¡/funùiÚ.hµ
>

23 
	~<boo¡/nÚcİyabË.hµ
>

24 
	~<boo¡/sh¬ed_±r.hµ
>

26 
	~<boo¡/bšd.hµ
>

28 #iâdeà
NDEBUG


29 
	~<boo¡/¡©ic_as£¹.hµ
>

30 
	~<boo¡/ty³_Œa™s/is_ba£_of.hµ
>

33 
Çme¥aû
 
	ggoogË


35 
Çme¥aû
 
	g´Ùobuf


37 
şass
 
	gMes§ge
;

41 
Çme¥aû
 
	gmuduo


43 
Çme¥aû
 
	gÃt


46 
şass
 
	gBufãr
;

47 
şass
 
	gTıCÚÃùiÚ
;

48 
	gboo¡
::
	tsh¬ed_±r
<
	tTıCÚÃùiÚ
> 
	tTıCÚÃùiÚPŒ
;

49 
	gboo¡
::
	tsh¬ed_±r
<
	tgoogË
::
	t´Ùobuf
::
	tMes§ge
> 
	tMes§gePŒ
;

61 şas 
	cPrÙobufCodecL™e
 : 
boo¡
::
nÚcİyabË


63 
public
:

64 cÚ¡ 
kH—d”L’
 = (
št32_t
);

65 cÚ¡ 
	gkChecksumL’
 = (
št32_t
);

66 cÚ¡ 
	gkMaxMes§geL’
 = 64*1024*1024;

68 
	eE¼ÜCode


70 
	gkNoE¼Ü
 = 0,

71 
	gkInv®idL’gth
,

72 
	gkCheckSumE¼Ü
,

73 
	gkInv®idNameL’
,

74 
	gkUnknownMes§geTy³
,

75 
	gkP¬£E¼Ü
,

79 
	gboo¡
::
	tfunùiÚ
<
	tboŞ
 (cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

80 
	tSŒšgP›û
,

81 
	tTime¡amp
)> 
	tRawMes§geC®lback
;

83 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

84 cÚ¡ 
	tMes§gePŒ
&,

85 
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

87 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

88 
	tBufãr
*,

89 
	tTime¡amp
,

90 
	tE¼ÜCode
)> 
	tE¼ÜC®lback
;

92 
PrÙobufCodecL™e
(cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
* 
´ÙÙy³
,

93 
SŒšgP›û
 
gArg
,

94 cÚ¡ 
PrÙobufMes§geC®lback
& 
mes§geCb
,

95 cÚ¡ 
RawMes§geC®lback
& 
¿wCb
 = RawMessageCallback(),

96 cÚ¡ 
E¼ÜC®lback
& 
”rÜCb
 = 
deçuÉE¼ÜC®lback
)

97 : 
´ÙÙy³_
(
´ÙÙy³
),

98 
g_
(
gArg
.
as_¡ršg
()),

99 
mes§geC®lback_
(
mes§geCb
),

100 
¿wCb_
(
¿wCb
),

101 
”rÜC®lback_
(
”rÜCb
),

102 
kMšMes§geL’
(
gArg
.
size
(è+ 
kChecksumL’
)

106 
	gvœtu®
 ~
PrÙobufCodecL™e
() { }

108 cÚ¡ 
	g¡ršg
& 
g
(ècÚ¡ {  
	gg_
; }

110 
£nd
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

111 cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
);

113 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

114 
Bufãr
* 
buf
,

115 
Time¡amp
 
»ûiveTime
);

117 
vœtu®
 
boŞ
 
·r£FromBufãr
(
SŒšgP›û
 
buf
, 
googË
::
´Ùobuf
::
Mes§ge
* 
mes§ge
);

118 
vœtu®
 
£rŸlizeToBufãr
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
, 
Bufãr
* 
buf
);

120 cÚ¡ 
	g¡ršg
& 
”rÜCodeToSŒšg
(
E¼ÜCode
 
”rÜCode
);

123 
E¼ÜCode
 
·r£
(cÚ¡ * 
buf
, 
Ën
, ::
googË
::
´Ùobuf
::
Mes§ge
* 
mes§ge
);

124 
flEm±yBufãr
(
muduo
::
Ãt
::
Bufãr
* 
buf
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
);

126 
št32_t
 
checksum
(cÚ¡ * 
buf
, 
Ën
);

127 
boŞ
 
v®id©eChecksum
(cÚ¡ * 
buf
, 
Ën
);

128 
št32_t
 
asIÁ32
(cÚ¡ * 
buf
);

129 
deçuÉE¼ÜC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

130 
Bufãr
*,

131 
Time¡amp
,

132 
E¼ÜCode
);

134 
	g´iv©e
:

135 cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
* 
´ÙÙy³_
;

136 cÚ¡ 
¡ršg
 
	gg_
;

137 
PrÙobufMes§geC®lback
 
	gmes§geC®lback_
;

138 
RawMes§geC®lback
 
	g¿wCb_
;

139 
E¼ÜC®lback
 
	g”rÜC®lback_
;

140 cÚ¡ 
	gkMšMes§geL’
;

143 
	g‹m¶©e
<
ty³Çme
 
	gMSG
, cÚ¡ * 
	gTAG
,y³Çm
	gCODEC
=
PrÙobufCodecL™e
>

144 şas 
	cPrÙobufCodecL™eT


146 #iâdeà
NDEBUG


147 
BOOST_STATIC_ASSERT
((
boo¡
::
is_ba£_of
<
PrÙobufCodecL™e
, 
CODEC
>::
v®ue
));

149 
	gpublic
:

150 
boo¡
::
	tsh¬ed_±r
<
	tMSG
> 
	tCÚü‘eMes§gePŒ
;

151 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

152 cÚ¡ 
	tCÚü‘eMes§gePŒ
&,

153 
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

154 
	gPrÙobufCodecL™e
::
	tRawMes§geC®lback
 RawMessageCallback;

155 
	gPrÙobufCodecL™e
::
	tE¼ÜC®lback
 ErrorCallback;

157 
ex¶ic™
 
PrÙobufCodecL™eT
(cÚ¡ 
PrÙobufMes§geC®lback
& 
mes§geCb
,

158 cÚ¡ 
RawMes§geC®lback
& 
¿wCb
 = RawMessageCallback(),

159 cÚ¡ 
E¼ÜC®lback
& 
”rÜCb
 = 
PrÙobufCodecL™e
::
deçuÉE¼ÜC®lback
)

160 : 
mes§geC®lback_
(
mes§geCb
),

161 
codec_
(&
MSG
::
deçuÉ_š¡ªû
(),

162 
TAG
,

163 
boo¡
::
bšd
(&
PrÙobufCodecL™eT
::
ÚRpcMes§ge
, 
this
, 
_1
, 
_2
, 
_3
),

164 
¿wCb
,

165 
”rÜCb
)

169 cÚ¡ 
	g¡ršg
& 
g
(ècÚ¡ {  
	gcodec_
.tag(); }

171 
£nd
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

172 cÚ¡ 
MSG
& 
mes§ge
)

174 
	gcodec_
.
£nd
(
cÚn
, 
mes§ge
);

177 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

178 
Bufãr
* 
buf
,

179 
Time¡amp
 
»ûiveTime
)

181 
	gcodec_
.
ÚMes§ge
(
cÚn
, 
buf
, 
»ûiveTime
);

185 
ÚRpcMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

186 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

187 
Time¡amp
 
»ûiveTime
)

189 
mes§geC®lback_
(
cÚn
, ::
muduo
::
down_poš‹r_ÿ¡
<
MSG
>(
mes§ge
), 
»ûiveTime
);

192 
flEm±yBufãr
(
muduo
::
Ãt
::
Bufãr
* 
buf
, cÚ¡ 
MSG
& 
mes§ge
)

194 
	gcodec_
.
flEm±yBufãr
(
buf
, 
mes§ge
);

197 
	g´iv©e
:

198 
PrÙobufMes§geC®lback
 
mes§geC®lback_
;

199 
CODEC
 
	gcodec_
;

	@muduo/net/protobuf/ProtobufCodecLite.h

14 #iâdeà
MUDUO_NET_PROTOBUF_CODEC_H


15 
	#MUDUO_NET_PROTOBUF_CODEC_H


	)

17 
	~<muduo/ba£/SŒšgP›û.h
>

18 
	~<muduo/ba£/Time¡amp.h
>

20 
	~<muduo/Ãt/C®lbacks.h
>

22 
	~<boo¡/funùiÚ.hµ
>

23 
	~<boo¡/nÚcİyabË.hµ
>

24 
	~<boo¡/sh¬ed_±r.hµ
>

26 
	~<boo¡/bšd.hµ
>

28 #iâdeà
NDEBUG


29 
	~<boo¡/¡©ic_as£¹.hµ
>

30 
	~<boo¡/ty³_Œa™s/is_ba£_of.hµ
>

33 
Çme¥aû
 
	ggoogË


35 
Çme¥aû
 
	g´Ùobuf


37 
şass
 
	gMes§ge
;

41 
Çme¥aû
 
	gmuduo


43 
Çme¥aû
 
	gÃt


46 
şass
 
	gBufãr
;

47 
şass
 
	gTıCÚÃùiÚ
;

48 
	gboo¡
::
	tsh¬ed_±r
<
	tTıCÚÃùiÚ
> 
	tTıCÚÃùiÚPŒ
;

49 
	gboo¡
::
	tsh¬ed_±r
<
	tgoogË
::
	t´Ùobuf
::
	tMes§ge
> 
	tMes§gePŒ
;

61 şas 
	cPrÙobufCodecL™e
 : 
boo¡
::
nÚcİyabË


63 
public
:

64 cÚ¡ 
kH—d”L’
 = (
št32_t
);

65 cÚ¡ 
	gkChecksumL’
 = (
št32_t
);

66 cÚ¡ 
	gkMaxMes§geL’
 = 64*1024*1024;

68 
	eE¼ÜCode


70 
	gkNoE¼Ü
 = 0,

71 
	gkInv®idL’gth
,

72 
	gkCheckSumE¼Ü
,

73 
	gkInv®idNameL’
,

74 
	gkUnknownMes§geTy³
,

75 
	gkP¬£E¼Ü
,

79 
	gboo¡
::
	tfunùiÚ
<
	tboŞ
 (cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

80 
	tSŒšgP›û
,

81 
	tTime¡amp
)> 
	tRawMes§geC®lback
;

83 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

84 cÚ¡ 
	tMes§gePŒ
&,

85 
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

87 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

88 
	tBufãr
*,

89 
	tTime¡amp
,

90 
	tE¼ÜCode
)> 
	tE¼ÜC®lback
;

92 
PrÙobufCodecL™e
(cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
* 
´ÙÙy³
,

93 
SŒšgP›û
 
gArg
,

94 cÚ¡ 
PrÙobufMes§geC®lback
& 
mes§geCb
,

95 cÚ¡ 
RawMes§geC®lback
& 
¿wCb
 = RawMessageCallback(),

96 cÚ¡ 
E¼ÜC®lback
& 
”rÜCb
 = 
deçuÉE¼ÜC®lback
)

97 : 
´ÙÙy³_
(
´ÙÙy³
),

98 
g_
(
gArg
.
as_¡ršg
()),

99 
mes§geC®lback_
(
mes§geCb
),

100 
¿wCb_
(
¿wCb
),

101 
”rÜC®lback_
(
”rÜCb
),

102 
kMšMes§geL’
(
gArg
.
size
(è+ 
kChecksumL’
)

106 
	gvœtu®
 ~
PrÙobufCodecL™e
() { }

108 cÚ¡ 
	g¡ršg
& 
g
(ècÚ¡ {  
	gg_
; }

110 
£nd
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

111 cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
);

113 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

114 
Bufãr
* 
buf
,

115 
Time¡amp
 
»ûiveTime
);

117 
vœtu®
 
boŞ
 
·r£FromBufãr
(
SŒšgP›û
 
buf
, 
googË
::
´Ùobuf
::
Mes§ge
* 
mes§ge
);

118 
vœtu®
 
£rŸlizeToBufãr
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
, 
Bufãr
* 
buf
);

120 cÚ¡ 
	g¡ršg
& 
”rÜCodeToSŒšg
(
E¼ÜCode
 
”rÜCode
);

123 
E¼ÜCode
 
·r£
(cÚ¡ * 
buf
, 
Ën
, ::
googË
::
´Ùobuf
::
Mes§ge
* 
mes§ge
);

124 
flEm±yBufãr
(
muduo
::
Ãt
::
Bufãr
* 
buf
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
& 
mes§ge
);

126 
št32_t
 
checksum
(cÚ¡ * 
buf
, 
Ën
);

127 
boŞ
 
v®id©eChecksum
(cÚ¡ * 
buf
, 
Ën
);

128 
št32_t
 
asIÁ32
(cÚ¡ * 
buf
);

129 
deçuÉE¼ÜC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

130 
Bufãr
*,

131 
Time¡amp
,

132 
E¼ÜCode
);

134 
	g´iv©e
:

135 cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
* 
´ÙÙy³_
;

136 cÚ¡ 
¡ršg
 
	gg_
;

137 
PrÙobufMes§geC®lback
 
	gmes§geC®lback_
;

138 
RawMes§geC®lback
 
	g¿wCb_
;

139 
E¼ÜC®lback
 
	g”rÜC®lback_
;

140 cÚ¡ 
	gkMšMes§geL’
;

143 
	g‹m¶©e
<
ty³Çme
 
	gMSG
, cÚ¡ * 
	gTAG
,y³Çm
	gCODEC
=
PrÙobufCodecL™e
>

144 şas 
	cPrÙobufCodecL™eT


146 #iâdeà
NDEBUG


147 
BOOST_STATIC_ASSERT
((
boo¡
::
is_ba£_of
<
PrÙobufCodecL™e
, 
CODEC
>::
v®ue
));

149 
	gpublic
:

150 
boo¡
::
	tsh¬ed_±r
<
	tMSG
> 
	tCÚü‘eMes§gePŒ
;

151 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tTıCÚÃùiÚPŒ
&,

152 cÚ¡ 
	tCÚü‘eMes§gePŒ
&,

153 
	tTime¡amp
)> 
	tPrÙobufMes§geC®lback
;

154 
	gPrÙobufCodecL™e
::
	tRawMes§geC®lback
 RawMessageCallback;

155 
	gPrÙobufCodecL™e
::
	tE¼ÜC®lback
 ErrorCallback;

157 
ex¶ic™
 
PrÙobufCodecL™eT
(cÚ¡ 
PrÙobufMes§geC®lback
& 
mes§geCb
,

158 cÚ¡ 
RawMes§geC®lback
& 
¿wCb
 = RawMessageCallback(),

159 cÚ¡ 
E¼ÜC®lback
& 
”rÜCb
 = 
PrÙobufCodecL™e
::
deçuÉE¼ÜC®lback
)

160 : 
mes§geC®lback_
(
mes§geCb
),

161 
codec_
(&
MSG
::
deçuÉ_š¡ªû
(),

162 
TAG
,

163 
boo¡
::
bšd
(&
PrÙobufCodecL™eT
::
ÚRpcMes§ge
, 
this
, 
_1
, 
_2
, 
_3
),

164 
¿wCb
,

165 
”rÜCb
)

169 cÚ¡ 
	g¡ršg
& 
g
(ècÚ¡ {  
	gcodec_
.tag(); }

171 
£nd
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

172 cÚ¡ 
MSG
& 
mes§ge
)

174 
	gcodec_
.
£nd
(
cÚn
, 
mes§ge
);

177 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

178 
Bufãr
* 
buf
,

179 
Time¡amp
 
»ûiveTime
)

181 
	gcodec_
.
ÚMes§ge
(
cÚn
, 
buf
, 
»ûiveTime
);

185 
ÚRpcMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

186 cÚ¡ 
Mes§gePŒ
& 
mes§ge
,

187 
Time¡amp
 
»ûiveTime
)

189 
mes§geC®lback_
(
cÚn
, ::
muduo
::
down_poš‹r_ÿ¡
<
MSG
>(
mes§ge
), 
»ûiveTime
);

192 
flEm±yBufãr
(
muduo
::
Ãt
::
Bufãr
* 
buf
, cÚ¡ 
MSG
& 
mes§ge
)

194 
	gcodec_
.
flEm±yBufãr
(
buf
, 
mes§ge
);

197 
	g´iv©e
:

198 
PrÙobufMes§geC®lback
 
mes§geC®lback_
;

199 
CODEC
 
	gcodec_
;

	@muduo/net/protorpc/RpcChannel.cc

9 
	~<muduo/Ãt/´ÙÜpc/RpcChªÃl.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/Ãt/´ÙÜpc/½c.pb.h
>

14 
	~<googË/´Ùobuf/desütÜ.h
>

16 
	~<boo¡/bšd.hµ
>

17 
	~<boo¡/scİed_±r.hµ
>

19 
usšg
 
Çme¥aû
 
	gmuduo
;

20 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

22 
	gRpcChªÃl
::
	$RpcChªÃl
()

23 : 
	`codec_
(
boo¡
::
	`bšd
(&
RpcChªÃl
::
ÚRpcMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

24 
	$£rviûs_
(
NULL
)

26 
LOG_INFO
 << "RpcChªÃl::ùÜ - " << 
this
;

27 
	}
}

29 
	gRpcChªÃl
::
	$RpcChªÃl
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

30 : 
	`codec_
(
boo¡
::
	`bšd
(&
RpcChªÃl
::
ÚRpcMes§ge
, 
this
, 
_1
, 
_2
, 
_3
)),

31 
	`cÚn_
(
cÚn
),

32 
	$£rviûs_
(
NULL
)

34 
LOG_INFO
 << "RpcChªÃl::ùÜ - " << 
this
;

35 
	}
}

37 
	gRpcChªÃl
::~
	$RpcChªÃl
()

39 
LOG_INFO
 << "RpcChªÃl::dtÜ - " << 
this
;

40 
¡d
::
m­
<
št64_t
, 
Out¡ªdšgC®l
>::
™”©Ü
 
™
 = 
out¡ªdšgs_
.
	`begš
(); iˆ!ğout¡ªdšgs_.
	`’d
(); ++it)

42 
Out¡ªdšgC®l
 
out
 = 
™
->
£cÚd
;

43 
d–‘e
 
out
.
»¥Ú£
;

44 
d–‘e
 
out
.
dÚe
;

46 
	}
}

53 
	gRpcChªÃl
::
C®lM‘hod
(cÚ¡ ::
googË
::
´Ùobuf
::
M‘hodDesütÜ
* 
m‘hod
,

54 
googË
::
´Ùobuf
::
RpcCÚŒŞËr
* 
cÚŒŞËr
,

55 cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
* 
»que¡
,

56 ::
googË
::
´Ùobuf
::
Mes§ge
* 
»¥Ú£
,

57 ::
googË
::
´Ùobuf
::
Closu»
* 
dÚe
)

59 
RpcMes§ge
 
mes§ge
;

60 
	gmes§ge
.
£t_ty³
(
REQUEST
);

61 
št64_t
 
	gid
 = 
id_
.
šüem’tAndG‘
();

62 
	gmes§ge
.
£t_id
(
id
);

63 
	gmes§ge
.
£t_£rviû
(
m‘hod
->
£rviû
()->
fuÎ_Çme
());

64 
	gmes§ge
.
£t_m‘hod
(
m‘hod
->
Çme
());

65 
	gmes§ge
.
£t_»que¡
(
»que¡
->
S”ŸlizeAsSŒšg
());

67 
Out¡ªdšgC®l
 
	gout
 = { 
»¥Ú£
, 
dÚe
 };

69 
Mu‹xLockGu¬d
 
lock
(
mu‹x_
);

70 
	gout¡ªdšgs_
[
id
] = 
out
;

72 
	gcodec_
.
£nd
(
cÚn_
, 
mes§ge
);

75 
	gRpcChªÃl
::
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

76 
Bufãr
* 
buf
,

77 
Time¡amp
 
»ûiveTime
)

79 
codec_
.
	`ÚMes§ge
(
cÚn
, 
buf
, 
»ûiveTime
);

80 
	}
}

82 
	gRpcChªÃl
::
	$ÚRpcMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

83 cÚ¡ 
RpcMes§gePŒ
& 
mes§gePŒ
,

84 
Time¡amp
 
»ûiveTime
)

86 
	`as£¹
(
cÚn
 =ğ
cÚn_
);

88 
RpcMes§ge
& 
mes§ge
 = *
mes§gePŒ
;

89 ià(
mes§ge
.
	`ty³
(è=ğ
RESPONSE
)

91 
št64_t
 
id
 = 
mes§ge
.
	`id
();

92 
	`as£¹
(
mes§ge
.
	`has_»¥Ú£
(è|| mes§ge.
	`has_”rÜ
());

94 
Out¡ªdšgC®l
 
out
 = { 
NULL
, NULL };

97 
Mu‹xLockGu¬d
 
	`lock
(
mu‹x_
);

98 
¡d
::
m­
<
št64_t
, 
Out¡ªdšgC®l
>::
™”©Ü
 
™
 = 
out¡ªdšgs_
.
	`fšd
(
id
);

99 ià(
™
 !ğ
out¡ªdšgs_
.
	`’d
())

101 
out
 = 
™
->
£cÚd
;

102 
out¡ªdšgs_
.
	`”a£
(
™
);

106 ià(
out
.
»¥Ú£
)

108 
boo¡
::
scİed_±r
<
googË
::
´Ùobuf
::
Mes§ge
> 
	`d
(
out
.
»¥Ú£
);

109 ià(
mes§ge
.
	`has_»¥Ú£
())

111 
out
.
»¥Ú£
->
	`P¬£FromSŒšg
(
mes§ge
.
	`»¥Ú£
());

113 ià(
out
.
dÚe
)

115 
out
.
dÚe
->
	`Run
();

119 ià(
mes§ge
.
	`ty³
(è=ğ
REQUEST
)

122 
E¼ÜCode
 
”rÜ
 = 
WRONG_PROTO
;

123 ià(
£rviûs_
)

125 
¡d
::
m­
<¡d::
¡ršg
, 
googË
::
´Ùobuf
::
S”viû
*>::
cÚ¡_™”©Ü
 
™
 = 
£rviûs_
->
	`fšd
(
mes§ge
.
	`£rviû
());

126 ià(
™
 !ğ
£rviûs_
->
	`’d
())

128 
googË
::
´Ùobuf
::
S”viû
* 
£rviû
 = 
™
->
£cÚd
;

129 
	`as£¹
(
£rviû
 !ğ
NULL
);

130 cÚ¡ 
googË
::
´Ùobuf
::
S”viûDesütÜ
* 
desc
 = 
£rviû
->
	`G‘DesütÜ
();

131 cÚ¡ 
googË
::
´Ùobuf
::
M‘hodDesütÜ
* 
m‘hod


132 ğ
desc
->
	`FšdM‘hodByName
(
mes§ge
.
	`m‘hod
());

133 ià(
m‘hod
)

135 
boo¡
::
scİed_±r
<
googË
::
´Ùobuf
::
Mes§ge
> 
	`»que¡
(
£rviû
->
	`G‘Reque¡PrÙÙy³
(
m‘hod
).
	`New
());

136 ià(
»que¡
->
	`P¬£FromSŒšg
(
mes§ge
.
	`»que¡
()))

138 
googË
::
´Ùobuf
::
Mes§ge
* 
»¥Ú£
 = 
£rviû
->
	`G‘Re¥Ú£PrÙÙy³
(
m‘hod
).
	`New
();

140 
št64_t
 
id
 = 
mes§ge
.
	`id
();

141 
£rviû
->
	`C®lM‘hod
(
m‘hod
, 
NULL
, 
	`g‘_poš‹r
(
»que¡
), 
»¥Ú£
,

142 
	`NewC®lback
(
this
, &
RpcChªÃl
::
dÚeC®lback
, 
»¥Ú£
, 
id
));

143 
”rÜ
 = 
NO_ERROR
;

147 
”rÜ
 = 
INVALID_REQUEST
;

152 
”rÜ
 = 
NO_METHOD
;

157 
”rÜ
 = 
NO_SERVICE
;

162 
”rÜ
 = 
NO_SERVICE
;

164 ià(
”rÜ
 !ğ
NO_ERROR
)

166 
RpcMes§ge
 
»¥Ú£
;

167 
»¥Ú£
.
	`£t_ty³
(
RESPONSE
);

168 
»¥Ú£
.
	`£t_id
(
mes§ge
.
	`id
());

169 
»¥Ú£
.
	`£t_”rÜ
(
”rÜ
);

170 
codec_
.
	`£nd
(
cÚn_
, 
»¥Ú£
);

173 ià(
mes§ge
.
	`ty³
(è=ğ
ERROR
)

176 
	}
}

178 
	gRpcChªÃl
::
dÚeC®lback
(::
googË
::
´Ùobuf
::
Mes§ge
* 
»¥Ú£
, 
št64_t
 
id
)

180 
	gboo¡
::
scİed_±r
<
googË
::
´Ùobuf
::
Mes§ge
> 
d
(
»¥Ú£
);

181 
RpcMes§ge
 
	gmes§ge
;

182 
	gmes§ge
.
£t_ty³
(
RESPONSE
);

183 
	gmes§ge
.
£t_id
(
id
);

184 
	gmes§ge
.
£t_»¥Ú£
(
»¥Ú£
->
S”ŸlizeAsSŒšg
());

185 
	gcodec_
.
£nd
(
cÚn_
, 
mes§ge
);

	@muduo/net/protorpc/RpcChannel.h

11 #iâdeà
MUDUO_NET_PROTORPC_RPCCHANNEL_H


12 
	#MUDUO_NET_PROTORPC_RPCCHANNEL_H


	)

14 
	~<muduo/ba£/Atomic.h
>

15 
	~<muduo/ba£/Mu‹x.h
>

16 
	~<muduo/Ãt/´ÙÜpc/RpcCodec.h
>

18 
	~<googË/´Ùobuf/£rviû.h
>

20 
	~<boo¡/sh¬ed_±r.hµ
>

22 
	~<m­
>

61 
Çme¥aû
 
	ggoogË
 {

62 
Çme¥aû
 
	g´Ùobuf
 {

65 
şass
 
	gDesütÜ
;

66 
şass
 
	gS”viûDesütÜ
;

67 
şass
 
	gM‘hodDesütÜ
;

68 
şass
 
	gMes§ge
;

70 
şass
 
	gClosu»
;

72 
şass
 
	gRpcCÚŒŞËr
;

73 
şass
 
	gS”viû
;

79 
Çme¥aû
 
	gmuduo


81 
Çme¥aû
 
	gÃt


93 şas 
	cRpcChªÃl
 : 
public
 ::
googË
::
´Ùobuf
::
RpcChªÃl


95 
public
:

96 
RpcChªÃl
();

98 
ex¶ic™
 
RpcChªÃl
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

100 ~
RpcChªÃl
();

102 
£tCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

104 
	gcÚn_
 = 
cÚn
;

107 
£tS”viûs
(cÚ¡ 
¡d
::
m­
<¡d::
¡ršg
, ::
googË
::
´Ùobuf
::
S”viû
*>* 
£rviûs
)

109 
£rviûs_
 = 
£rviûs
;

117 
C®lM‘hod
(cÚ¡ ::
googË
::
´Ùobuf
::
M‘hodDesütÜ
* 
m‘hod
,

118 ::
googË
::
´Ùobuf
::
RpcCÚŒŞËr
* 
cÚŒŞËr
,

119 cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
* 
»que¡
,

120 ::
googË
::
´Ùobuf
::
Mes§ge
* 
»¥Ú£
,

121 ::
googË
::
´Ùobuf
::
Closu»
* 
dÚe
);

123 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

124 
Bufãr
* 
buf
,

125 
Time¡amp
 
»ûiveTime
);

127 
	g´iv©e
:

128 
ÚRpcMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

129 cÚ¡ 
RpcMes§gePŒ
& 
mes§gePŒ
,

130 
Time¡amp
 
»ûiveTime
);

132 
dÚeC®lback
(::
googË
::
´Ùobuf
::
Mes§ge
* 
»¥Ú£
, 
št64_t
 
id
);

134 
	sOut¡ªdšgC®l


136 ::
googË
::
´Ùobuf
::
Mes§ge
* 
»¥Ú£
;

137 ::
googË
::
´Ùobuf
::
Closu»
* 
dÚe
;

140 
RpcCodec
 
	gcodec_
;

141 
TıCÚÃùiÚPŒ
 
	gcÚn_
;

142 
AtomicIÁ64
 
	gid_
;

144 
Mu‹xLock
 
	gmu‹x_
;

145 
	g¡d
::
m­
<
št64_t
, 
	gOut¡ªdšgC®l
> 
	gout¡ªdšgs_
;

147 cÚ¡ 
	g¡d
::
m­
<
¡d
::
¡ršg
, ::
googË
::
´Ùobuf
::
S”viû
*>* 
£rviûs_
;

149 
	gboo¡
::
	tsh¬ed_±r
<
	tRpcChªÃl
> 
	tRpcChªÃlPŒ
;

	@muduo/net/protorpc/RpcChannel.h

11 #iâdeà
MUDUO_NET_PROTORPC_RPCCHANNEL_H


12 
	#MUDUO_NET_PROTORPC_RPCCHANNEL_H


	)

14 
	~<muduo/ba£/Atomic.h
>

15 
	~<muduo/ba£/Mu‹x.h
>

16 
	~<muduo/Ãt/´ÙÜpc/RpcCodec.h
>

18 
	~<googË/´Ùobuf/£rviû.h
>

20 
	~<boo¡/sh¬ed_±r.hµ
>

22 
	~<m­
>

61 
Çme¥aû
 
	ggoogË
 {

62 
Çme¥aû
 
	g´Ùobuf
 {

65 
şass
 
	gDesütÜ
;

66 
şass
 
	gS”viûDesütÜ
;

67 
şass
 
	gM‘hodDesütÜ
;

68 
şass
 
	gMes§ge
;

70 
şass
 
	gClosu»
;

72 
şass
 
	gRpcCÚŒŞËr
;

73 
şass
 
	gS”viû
;

79 
Çme¥aû
 
	gmuduo


81 
Çme¥aû
 
	gÃt


93 şas 
	cRpcChªÃl
 : 
public
 ::
googË
::
´Ùobuf
::
RpcChªÃl


95 
public
:

96 
RpcChªÃl
();

98 
ex¶ic™
 
RpcChªÃl
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

100 ~
RpcChªÃl
();

102 
£tCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

104 
	gcÚn_
 = 
cÚn
;

107 
£tS”viûs
(cÚ¡ 
¡d
::
m­
<¡d::
¡ršg
, ::
googË
::
´Ùobuf
::
S”viû
*>* 
£rviûs
)

109 
£rviûs_
 = 
£rviûs
;

117 
C®lM‘hod
(cÚ¡ ::
googË
::
´Ùobuf
::
M‘hodDesütÜ
* 
m‘hod
,

118 ::
googË
::
´Ùobuf
::
RpcCÚŒŞËr
* 
cÚŒŞËr
,

119 cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
* 
»que¡
,

120 ::
googË
::
´Ùobuf
::
Mes§ge
* 
»¥Ú£
,

121 ::
googË
::
´Ùobuf
::
Closu»
* 
dÚe
);

123 
ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

124 
Bufãr
* 
buf
,

125 
Time¡amp
 
»ûiveTime
);

127 
	g´iv©e
:

128 
ÚRpcMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
,

129 cÚ¡ 
RpcMes§gePŒ
& 
mes§gePŒ
,

130 
Time¡amp
 
»ûiveTime
);

132 
dÚeC®lback
(::
googË
::
´Ùobuf
::
Mes§ge
* 
»¥Ú£
, 
št64_t
 
id
);

134 
	sOut¡ªdšgC®l


136 ::
googË
::
´Ùobuf
::
Mes§ge
* 
»¥Ú£
;

137 ::
googË
::
´Ùobuf
::
Closu»
* 
dÚe
;

140 
RpcCodec
 
	gcodec_
;

141 
TıCÚÃùiÚPŒ
 
	gcÚn_
;

142 
AtomicIÁ64
 
	gid_
;

144 
Mu‹xLock
 
	gmu‹x_
;

145 
	g¡d
::
m­
<
št64_t
, 
	gOut¡ªdšgC®l
> 
	gout¡ªdšgs_
;

147 cÚ¡ 
	g¡d
::
m­
<
¡d
::
¡ršg
, ::
googË
::
´Ùobuf
::
S”viû
*>* 
£rviûs_
;

149 
	gboo¡
::
	tsh¬ed_±r
<
	tRpcChªÃl
> 
	tRpcChªÃlPŒ
;

	@muduo/net/protorpc/RpcCodec.cc

9 
	~<muduo/Ãt/´ÙÜpc/RpcCodec.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/Ãt/EndŸn.h
>

13 
	~<muduo/Ãt/TıCÚÃùiÚ.h
>

15 
	~<muduo/Ãt/´ÙÜpc/½c.pb.h
>

16 
	~<muduo/Ãt/´ÙÜpc/googË-šl.h
>

18 
	~<boo¡/bšd.hµ
>

20 
usšg
 
Çme¥aû
 
	gmuduo
;

21 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

23 
	gÇme¥aû


25 
PrÙobufV”siÚCheck
()

27 
	gGOOGLE_PROTOBUF_VERIFY_VERSION
;

30 
dummy
 
__©Œibu‹__
 ((
unu£d
)èğ
PrÙobufV”siÚCheck
();

33 
Çme¥aû
 
	gmuduo


35 
Çme¥aû
 
	gÃt


37 cÚ¡ 
	g½ùag
 [] = "RPC0";

	@muduo/net/protorpc/RpcCodec.h

11 #iâdeà
MUDUO_NET_PROTORPC_RPCCODEC_H


12 
	#MUDUO_NET_PROTORPC_RPCCODEC_H


	)

14 
	~<muduo/ba£/Time¡amp.h
>

15 
	~<muduo/Ãt/´Ùobuf/PrÙobufCodecL™e.h
>

17 
	~<boo¡/funùiÚ.hµ
>

18 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<boo¡/sh¬ed_±r.hµ
>

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gÃt


26 
şass
 
	gBufãr
;

27 
şass
 
	gTıCÚÃùiÚ
;

28 
	gboo¡
::
	tsh¬ed_±r
<
	tTıCÚÃùiÚ
> 
	tTıCÚÃùiÚPŒ
;

30 
şass
 
	gRpcMes§ge
;

31 
	gboo¡
::
	tsh¬ed_±r
<
	tRpcMes§ge
> 
	tRpcMes§gePŒ
;

32 cÚ¡ 
½ùag
[];

44 
	gPrÙobufCodecL™eT
<
	tRpcMes§ge
, 
	t½ùag
> 
	tRpcCodec
;

	@muduo/net/protorpc/RpcCodec.h

11 #iâdeà
MUDUO_NET_PROTORPC_RPCCODEC_H


12 
	#MUDUO_NET_PROTORPC_RPCCODEC_H


	)

14 
	~<muduo/ba£/Time¡amp.h
>

15 
	~<muduo/Ãt/´Ùobuf/PrÙobufCodecL™e.h
>

17 
	~<boo¡/funùiÚ.hµ
>

18 
	~<boo¡/nÚcİyabË.hµ
>

19 
	~<boo¡/sh¬ed_±r.hµ
>

21 
Çme¥aû
 
	gmuduo


23 
Çme¥aû
 
	gÃt


26 
şass
 
	gBufãr
;

27 
şass
 
	gTıCÚÃùiÚ
;

28 
	gboo¡
::
	tsh¬ed_±r
<
	tTıCÚÃùiÚ
> 
	tTıCÚÃùiÚPŒ
;

30 
şass
 
	gRpcMes§ge
;

31 
	gboo¡
::
	tsh¬ed_±r
<
	tRpcMes§ge
> 
	tRpcMes§gePŒ
;

32 cÚ¡ 
½ùag
[];

44 
	gPrÙobufCodecL™eT
<
	tRpcMes§ge
, 
	t½ùag
> 
	tRpcCodec
;

	@muduo/net/protorpc/RpcCodec_test.cc

1 #undeà
NDEBUG


2 
	~<muduo/Ãt/´ÙÜpc/RpcCodec.h
>

3 
	~<muduo/Ãt/´ÙÜpc/½c.pb.h
>

4 
	~<muduo/Ãt/´Ùobuf/PrÙobufCodecL™e.h
>

5 
	~<muduo/Ãt/Bufãr.h
>

7 
	~<¡dio.h
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

12 
	$½cMes§geC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

13 cÚ¡ 
RpcMes§gePŒ
&,

14 
Time¡amp
)

16 
	}
}

18 
Mes§gePŒ
 
	gg_msg±r
;

19 
	$mes§geC®lback
(cÚ¡ 
TıCÚÃùiÚPŒ
&,

20 cÚ¡ 
Mes§gePŒ
& 
msg
,

21 
Time¡amp
)

23 
g_msg±r
 = 
msg
;

24 
	}
}

26 
	$´št
(cÚ¡ 
Bufãr
& 
buf
)

28 
	`´štf
("’codedØ%zd by‹s\n", 
buf
.
	`»adabËBy‹s
());

29 
size_t
 
i
 = 0; i < 
buf
.
	`»adabËBy‹s
(); ++i)

31 
ch
 = 
¡©ic_ÿ¡
<>(
buf
.
	`³ek
()[
i
]);

33 
	`´štf
("%2zd: 0x%02x %c\n", 
i
, 
ch
, 
	`isg¿ph
(ch) ? ch : ' ');

35 
	}
}

37 
	g½ùag
[] = "RPC0";

39 
	$maš
()

41 
RpcMes§ge
 
mes§ge
;

42 
mes§ge
.
	`£t_ty³
(
REQUEST
);

43 
mes§ge
.
	`£t_id
(2);

44 
wœe
[] = "\0\0\0\x13" "RPC0" "\x08\x01\x11\x02\0\0\0\0\0\0\0" "\x0f\xef\x01\x32";

45 
¡ršg
 
	`ex³ùed
(
wœe
, (wire)-1);

46 
¡ršg
 
s1
, 
s2
;

47 
Bufãr
 
buf1
, 
buf2
;

49 
RpcCodec
 
	`codec
(
½cMes§geC®lback
);

50 
codec
.
	`flEm±yBufãr
(&
buf1
, 
mes§ge
);

51 
	`´št
(
buf1
);

52 
s1
 = 
buf1
.
	`toSŒšgP›û
().
	`as_¡ršg
();

56 
PrÙobufCodecL™e
 
	`codec
(&
RpcMes§ge
::
	`deçuÉ_š¡ªû
(), "RPC0", 
mes§geC®lback
);

57 
codec
.
	`flEm±yBufãr
(&
buf2
, 
mes§ge
);

58 
	`´št
(
buf2
);

59 
s2
 = 
buf2
.
	`toSŒšgP›û
().
	`as_¡ršg
();

60 
codec
.
	`ÚMes§ge
(
	`TıCÚÃùiÚPŒ
(), &
buf1
, 
Time¡amp
::
	`now
());

61 
	`as£¹
(
g_msg±r
);

62 
	`as£¹
(
g_msg±r
->
	`DebugSŒšg
(è=ğ
mes§ge
.DebugString());

63 
g_msg±r
.
	`»£t
();

65 
	`as£¹
(
s1
 =ğ
s2
);

66 
	`as£¹
(
s1
 =ğ
ex³ùed
);

67 
	`as£¹
(
s2
 =ğ
ex³ùed
);

70 
Bufãr
 
buf
;

71 
PrÙobufCodecL™e
 
	`codec
(&
RpcMes§ge
::
	`deçuÉ_š¡ªû
(), "XYZ", 
mes§geC®lback
);

72 
codec
.
	`flEm±yBufãr
(&
buf
, 
mes§ge
);

73 
	`´št
(
buf
);

74 
s2
 = 
buf
.
	`toSŒšgP›û
().
	`as_¡ršg
();

75 
codec
.
	`ÚMes§ge
(
	`TıCÚÃùiÚPŒ
(), &
buf
, 
Time¡amp
::
	`now
());

76 
	`as£¹
(
g_msg±r
);

77 
	`as£¹
(
g_msg±r
->
	`DebugSŒšg
(è=ğ
mes§ge
.DebugString());

80 
googË
::
´Ùobuf
::
	`ShutdownPrÙobufLib¿ry
();

81 
	}
}

	@muduo/net/protorpc/RpcServer.cc

9 
	~<muduo/Ãt/´ÙÜpc/RpcS”v”.h
>

11 
	~<muduo/ba£/Loggšg.h
>

12 
	~<muduo/Ãt/´ÙÜpc/RpcChªÃl.h
>

14 
	~<googË/´Ùobuf/desütÜ.h
>

15 
	~<googË/´Ùobuf/£rviû.h
>

17 
	~<boo¡/bšd.hµ
>

19 
usšg
 
Çme¥aû
 
	gmuduo
;

20 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

22 
	gRpcS”v”
::
	$RpcS”v”
(
Ev’tLoİ
* 
loİ
,

23 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

24 : 
	`£rv”_
(
loİ
, 
li¡’Addr
, "RpcServer")

26 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

27 
boo¡
::
	`bšd
(&
RpcS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

30 
	}
}

32 
	gRpcS”v”
::
»gi¡”S”viû
(
googË
::
´Ùobuf
::
S”viû
* 
£rviû
)

34 cÚ¡ 
googË
::
´Ùobuf
::
S”viûDesütÜ
* 
desc
 = 
£rviû
->
G‘DesütÜ
();

35 
	g£rviûs_
[
desc
->
fuÎ_Çme
()] = 
£rviû
;

38 
	gRpcS”v”
::
	$¡¬t
()

40 
£rv”_
.
	`¡¬t
();

41 
	}
}

43 
	gRpcS”v”
::
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

45 
LOG_INFO
 << "RpcS”v” - " << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

46 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

47 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

48 ià(
cÚn
->
	`cÚÃùed
())

50 
RpcChªÃlPŒ
 
	`chªÃl
(
Ãw
 
	`RpcChªÃl
(
cÚn
));

51 
chªÃl
->
	`£tS”viûs
(&
£rviûs_
);

52 
cÚn
->
	`£tMes§geC®lback
(

53 
boo¡
::
	`bšd
(&
RpcChªÃl
::
ÚMes§ge
, 
	`g‘_poš‹r
(
chªÃl
), 
_1
, 
_2
, 
_3
));

54 
cÚn
->
	`£tCÚ‹xt
(
chªÃl
);

58 
cÚn
->
	`£tCÚ‹xt
(
	`RpcChªÃlPŒ
());

61 
	}
}

	@muduo/net/protorpc/RpcServer.h

11 #iâdeà
MUDUO_NET_PROTORPC_RPCSERVER_H


12 
	#MUDUO_NET_PROTORPC_RPCSERVER_H


	)

14 
	~<muduo/Ãt/TıS”v”.h
>

16 
Çme¥aû
 
	ggoogË
 {

17 
Çme¥aû
 
	g´Ùobuf
 {

19 
şass
 
	gS”viû
;

24 
Çme¥aû
 
	gmuduo


26 
Çme¥aû
 
	gÃt


29 şas 
	cRpcS”v”


31 
	gpublic
:

32 
RpcS”v”
(
Ev’tLoİ
* 
loİ
,

33 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
);

35 
£tTh»adNum
(
numTh»ads
)

37 
	g£rv”_
.
£tTh»adNum
(
numTh»ads
);

40 
»gi¡”S”viû
(::
googË
::
´Ùobuf
::
S”viû
*);

41 
¡¬t
();

43 
	g´iv©e
:

44 
ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

50 
TıS”v”
 
	g£rv”_
;

51 
	g¡d
::
m­
<
¡d
::
¡ršg
, ::
googË
::
´Ùobuf
::
S”viû
*> 
£rviûs_
;

	@muduo/net/protorpc/RpcServer.h

11 #iâdeà
MUDUO_NET_PROTORPC_RPCSERVER_H


12 
	#MUDUO_NET_PROTORPC_RPCSERVER_H


	)

14 
	~<muduo/Ãt/TıS”v”.h
>

16 
Çme¥aû
 
	ggoogË
 {

17 
Çme¥aû
 
	g´Ùobuf
 {

19 
şass
 
	gS”viû
;

24 
Çme¥aû
 
	gmuduo


26 
Çme¥aû
 
	gÃt


29 şas 
	cRpcS”v”


31 
	gpublic
:

32 
RpcS”v”
(
Ev’tLoİ
* 
loİ
,

33 cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
);

35 
£tTh»adNum
(
numTh»ads
)

37 
	g£rv”_
.
£tTh»adNum
(
numTh»ads
);

40 
»gi¡”S”viû
(::
googË
::
´Ùobuf
::
S”viû
*);

41 
¡¬t
();

43 
	g´iv©e
:

44 
ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
);

50 
TıS”v”
 
	g£rv”_
;

51 
	g¡d
::
m­
<
¡d
::
¡ršg
, ::
googË
::
´Ùobuf
::
S”viû
*> 
£rviûs_
;

	@muduo/net/protorpc/google-inl.h

39 
	~<googË/´Ùobuf/mes§ge.h
>

47 
šlše


48 
	$By‹SizeCÚsi¡’cyE¼Ü
(
by‹_size_befÜe_£rŸliz©iÚ
,

49 
by‹_size_aá”_£rŸliz©iÚ
,

50 
by‹s_´oduûd_by_£rŸliz©iÚ
)

52 
	`GOOGLE_CHECK_EQ
(
by‹_size_befÜe_£rŸliz©iÚ
, 
by‹_size_aá”_£rŸliz©iÚ
)

54 
	`GOOGLE_CHECK_EQ
(
by‹s_´oduûd_by_£rŸliz©iÚ
, 
by‹_size_befÜe_£rŸliz©iÚ
)

58 
	`GOOGLE_LOG
(
FATAL
) << "This shouldn't be called if‡llhe sizes‡reƒqual.";

59 
	}
}

61 
šlše


62 
	g¡d
::
¡ršg
 
In™Ÿliz©iÚE¼ÜMes§ge
(cÚ¡ * 
aùiÚ
,

63 cÚ¡ 
googË
::
´Ùobuf
::
Mes§geL™e
& 
mes§ge
)

74 
¡d
::
¡ršg
 
»suÉ
;

75 
	g»suÉ
 += "Can't ";

76 
	g»suÉ
 +ğ
aùiÚ
;

77 
	g»suÉ
 += " message ofype \"";

78 
	g»suÉ
 +ğ
mes§ge
.
G‘Ty³Name
();

79 
	g»suÉ
 += "\" because it is missing„equired fields: ";

80 
	g»suÉ
 +ğ
mes§ge
.
In™Ÿliz©iÚE¼ÜSŒšg
();

81  
	g»suÉ
;

	@muduo/net/protorpc/google-inl.h

39 
	~<googË/´Ùobuf/mes§ge.h
>

47 
šlše


48 
	$By‹SizeCÚsi¡’cyE¼Ü
(
by‹_size_befÜe_£rŸliz©iÚ
,

49 
by‹_size_aá”_£rŸliz©iÚ
,

50 
by‹s_´oduûd_by_£rŸliz©iÚ
)

52 
	`GOOGLE_CHECK_EQ
(
by‹_size_befÜe_£rŸliz©iÚ
, 
by‹_size_aá”_£rŸliz©iÚ
)

54 
	`GOOGLE_CHECK_EQ
(
by‹s_´oduûd_by_£rŸliz©iÚ
, 
by‹_size_befÜe_£rŸliz©iÚ
)

58 
	`GOOGLE_LOG
(
FATAL
) << "This shouldn't be called if‡llhe sizes‡reƒqual.";

59 
	}
}

61 
šlše


62 
	g¡d
::
¡ršg
 
In™Ÿliz©iÚE¼ÜMes§ge
(cÚ¡ * 
aùiÚ
,

63 cÚ¡ 
googË
::
´Ùobuf
::
Mes§geL™e
& 
mes§ge
)

74 
¡d
::
¡ršg
 
»suÉ
;

75 
	g»suÉ
 += "Can't ";

76 
	g»suÉ
 +ğ
aùiÚ
;

77 
	g»suÉ
 += " message ofype \"";

78 
	g»suÉ
 +ğ
mes§ge
.
G‘Ty³Name
();

79 
	g»suÉ
 += "\" because it is missing„equired fields: ";

80 
	g»suÉ
 +ğ
mes§ge
.
In™Ÿliz©iÚE¼ÜSŒšg
();

81  
	g»suÉ
;

	@muduo/net/tests/Buffer_unittest.cc

1 
	~<muduo/Ãt/Bufãr.h
>

4 
	#BOOST_TEST_MAIN


	)

5 
	#BOOST_TEST_DYN_LINK


	)

6 
	~<boo¡/‹¡/un™_‹¡.hµ
>

8 
usšg
 
	gmuduo
::
¡ršg
;

9 
usšg
 
	gmuduo
::
Ãt
::
Bufãr
;

11 
	$BOOST_AUTO_TEST_CASE
(
‹¡BufãrAµ’dR‘r›ve
)

13 
Bufãr
 
buf
;

14 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 0);

15 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
);

16 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
);

18 cÚ¡ 
¡ršg
 
	`¡r
(200, 'x');

19 
buf
.
	`­³nd
(
¡r
);

20 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 
¡r
.
	`size
());

21 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
 - 
¡r
.
	`size
());

22 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
);

24 cÚ¡ 
¡ršg
 
¡r2
 = 
buf
.
	`»Œ›veAsSŒšg
(50);

25 
	`BOOST_CHECK_EQUAL
(
¡r2
.
	`size
(), 50);

26 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 
¡r
.
	`size
(è- 
¡r2
.size());

27 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
 - 
¡r
.
	`size
());

28 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
 + 
¡r2
.
	`size
());

29 
	`BOOST_CHECK_EQUAL
(
¡r2
, 
	`¡ršg
(50, 'x'));

31 
buf
.
	`­³nd
(
¡r
);

32 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 2*
¡r
.
	`size
(è- 
¡r2
.size());

33 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
 - 2*
¡r
.
	`size
());

34 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
 + 
¡r2
.
	`size
());

36 cÚ¡ 
¡ršg
 
¡r3
 = 
buf
.
	`»Œ›veAÎAsSŒšg
();

37 
	`BOOST_CHECK_EQUAL
(
¡r3
.
	`size
(), 350);

38 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 0);

39 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
);

40 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
);

41 
	`BOOST_CHECK_EQUAL
(
¡r3
, 
	`¡ršg
(350, 'x'));

42 
	}
}

44 
	$BOOST_AUTO_TEST_CASE
(
‹¡BufãrGrow
)

46 
Bufãr
 
buf
;

47 
buf
.
	`­³nd
(
	`¡ršg
(400, 'y'));

48 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 400);

49 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
-400);

51 
buf
.
	`»Œ›ve
(50);

52 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 350);

53 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
-400);

54 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
+50);

56 
buf
.
	`­³nd
(
	`¡ršg
(1000, 'z'));

57 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 1350);

58 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 0);

59 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
+50);

61 
buf
.
	`»Œ›veAÎ
();

62 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 0);

63 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 1400);

64 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
);

65 
	}
}

67 
	$BOOST_AUTO_TEST_CASE
(
‹¡BufãrInsideGrow
)

69 
Bufãr
 
buf
;

70 
buf
.
	`­³nd
(
	`¡ršg
(800, 'y'));

71 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 800);

72 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
-800);

74 
buf
.
	`»Œ›ve
(500);

75 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 300);

76 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
-800);

77 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
+500);

79 
buf
.
	`­³nd
(
	`¡ršg
(300, 'z'));

80 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 600);

81 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
-600);

82 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
);

83 
	}
}

85 
	$BOOST_AUTO_TEST_CASE
(
‹¡BufãrShršk
)

87 
Bufãr
 
buf
;

88 
buf
.
	`­³nd
(
	`¡ršg
(2000, 'y'));

89 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 2000);

90 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 0);

91 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
);

93 
buf
.
	`»Œ›ve
(1500);

94 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 500);

95 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 0);

96 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
+1500);

98 
buf
.
	`shršk
(0);

99 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 500);

100 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
-500);

101 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»Œ›veAÎAsSŒšg
(), 
	`¡ršg
(500, 'y'));

102 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
);

103 
	}
}

105 
	$BOOST_AUTO_TEST_CASE
(
‹¡BufãrP»³nd
)

107 
Bufãr
 
buf
;

108 
buf
.
	`­³nd
(
	`¡ršg
(200, 'y'));

109 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 200);

110 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
-200);

111 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
);

113 
x
 = 0;

114 
buf
.
	`´•’d
(&
x
,  x);

115 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 204);

116 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
-200);

117 
	`BOOST_CHECK_EQUAL
(
buf
.
	`´•’dabËBy‹s
(), 
Bufãr
::
kCh—pP»³nd
 - 4);

118 
	}
}

120 
	$BOOST_AUTO_TEST_CASE
(
‹¡BufãrR—dIÁ
)

122 
Bufãr
 
buf
;

123 
buf
.
	`­³nd
("HTTP");

125 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 4);

126 
	`BOOST_CHECK_EQUAL
(
buf
.
	`³ekIÁ8
(), 'H');

127 
tİ16
 = 
buf
.
	`³ekIÁ16
();

128 
	`BOOST_CHECK_EQUAL
(
tİ16
, 'H'*256 + 'T');

129 
	`BOOST_CHECK_EQUAL
(
buf
.
	`³ekIÁ32
(), 
tİ16
*65536 + 'T'*256 + 'P');

131 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adIÁ8
(), 'H');

132 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adIÁ16
(), 'T'*256 + 'T');

133 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adIÁ8
(), 'P');

134 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 0);

135 
	`BOOST_CHECK_EQUAL
(
buf
.
	`wr™abËBy‹s
(), 
Bufãr
::
kIn™ŸlSize
);

137 
buf
.
	`­³ndIÁ8
(-1);

138 
buf
.
	`­³ndIÁ16
(-2);

139 
buf
.
	`­³ndIÁ32
(-3);

140 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adabËBy‹s
(), 7);

141 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adIÁ8
(), -1);

142 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adIÁ16
(), -2);

143 
	`BOOST_CHECK_EQUAL
(
buf
.
	`»adIÁ32
(), -3);

144 
	}
}

146 
	$BOOST_AUTO_TEST_CASE
(
‹¡BufãrFšdEOL
)

148 
Bufãr
 
buf
;

149 
buf
.
	`­³nd
(
	`¡ršg
(100000, 'x'));

150 cÚ¡ * 
nuÎ
 = 
NULL
;

151 
	`BOOST_CHECK_EQUAL
(
buf
.
	`fšdEOL
(), 
nuÎ
);

152 
	`BOOST_CHECK_EQUAL
(
buf
.
	`fšdEOL
(buf.
	`³ek
()+90000), 
nuÎ
);

153 
	}
}

155 #ifdeà
__GXX_EXPERIMENTAL_CXX0X__


156 
	$ouut
(
Bufãr
&& 
buf
, cÚ¡ * 
šÃr
)

158 
Bufãr
 
	`Ãwbuf
(
¡d
::
	`move
(
buf
));

160 
	`BOOST_CHECK_EQUAL
(
šÃr
, 
Ãwbuf
.
	`³ek
());

161 
	}
}

164 
	$BOOST_AUTO_TEST_CASE
(
‹¡Move
)

166 
Bufãr
 
buf
;

167 
buf
.
	`­³nd
("muduo", 5);

168 cÚ¡ * 
šÃr
 = 
buf
.
	`³ek
();

170 
	`ouut
(
¡d
::
	`move
(
buf
), 
šÃr
);

171 
	}
}

	@muduo/net/tests/Channel_test.cc

1 
	~<muduo/ba£/Loggšg.h
>

2 
	~<muduo/Ãt/ChªÃl.h
>

3 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<m­
>

7 
	~<boo¡/bšd.hµ
>

9 
	~<¡dio.h
>

10 
	~<uni¡d.h
>

11 
	~<sys/tim”fd.h
>

13 
usšg
 
Çme¥aû
 
	gmuduo
;

14 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

16 
	$´št
(cÚ¡ * 
msg
)

18 
¡d
::
m­
<cÚ¡ *, 
Time¡amp
> 
Ï¡s
;

19 
Time¡amp
& 
Ï¡
 = 
Ï¡s
[
msg
];

20 
Time¡amp
 
now
 = Time¡amp::
	`now
();

21 
	`´štf
("% tid %d % d–ay %f\n", 
now
.
	`toSŒšg
().
	`c_¡r
(), 
Cu¼’tTh»ad
::
	`tid
(),

22 
msg
, 
	`timeDifã»nû
(
now
, 
Ï¡
));

23 
Ï¡
 = 
now
;

24 
	}
}

26 
Çme¥aû
 
	gmuduo


28 
Çme¥aû
 
	gÃt


30 
Çme¥aû
 
	gd‘a


32 
ü—‹Tim”fd
();

33 
»adTim”fd
(
tim”fd
, 
Time¡amp
 
now
);

39 şas 
	cP”iodicTim”


41 
	mpublic
:

42 
	$P”iodicTim”
(
Ev’tLoİ
* 
loİ
, 
š‹rv®
, cÚ¡ 
Tim”C®lback
& 
cb
)

43 : 
	`loİ_
(
loİ
),

44 
	`tim”fd_
(
muduo
::
Ãt
::
d‘a
::
	`ü—‹Tim”fd
()),

45 
	`tim”fdChªÃl_
(
loİ
, 
tim”fd_
),

46 
	`š‹rv®_
(
š‹rv®
),

47 
	$cb_
(
cb
)

49 
tim”fdChªÃl_
.
	`£tR—dC®lback
(

50 
boo¡
::
	`bšd
(&
P”iodicTim”
::
hªdËR—d
, 
this
));

51 
tim”fdChªÃl_
.
	`’abËR—dšg
();

54 
	$¡¬t
()

56 
™im”¥ec
 
¥ec
;

57 
	`bz”o
(&
¥ec
,  spec);

58 
¥ec
.
™_š‹rv®
 = 
	`toTimeS³c
(
š‹rv®_
);

59 
¥ec
.
™_v®ue
 = s³c.
™_š‹rv®
;

60 
»t
 = ::
	`tim”fd_£‰ime
(
tim”fd_
, 0 , &
¥ec
, 
NULL
);

61 ià(
»t
)

63 
LOG_SYSERR
 << "timerfd_settime()";

65 
	}
}

67 ~
	$P”iodicTim”
()

69 
tim”fdChªÃl_
.
	`di§bËAÎ
();

70 
tim”fdChªÃl_
.
	`»move
();

71 ::
	`şo£
(
tim”fd_
);

72 
	}
}

74 
	g´iv©e
:

75 
	$hªdËR—d
()

77 
loİ_
->
	`as£¹InLoİTh»ad
();

78 
muduo
::
Ãt
::
d‘a
::
	`»adTim”fd
(
tim”fd_
, 
Time¡amp
::
	`now
());

79 ià(
cb_
)

80 
	`cb_
();

81 
	}
}

83 
time¥ec
 
	$toTimeS³c
(
£cÚds
)

85 
time¥ec
 
ts
;

86 
	`bz”o
(&
ts
, s);

87 cÚ¡ 
št64_t
 
kNªoSecÚdsP”SecÚd
 = 1e9;

88 cÚ¡ 
kMšIÁ”v®
 = 1e5;

89 
št64_t
 
Çno£cÚds
 = 
¡©ic_ÿ¡
<št64_t>(
£cÚds
 * 
kNªoSecÚdsP”SecÚd
);

90 ià(
Çno£cÚds
 < 
kMšIÁ”v®
)

91 
Çno£cÚds
 = 
kMšIÁ”v®
;

92 
ts
.
tv_£c
 = 
¡©ic_ÿ¡
<
time_t
>(
Çno£cÚds
 / 
kNªoSecÚdsP”SecÚd
);

93 
ts
.
tv_n£c
 = 
¡©ic_ÿ¡
<>(
Çno£cÚds
 % 
kNªoSecÚdsP”SecÚd
);

94  
ts
;

95 
	}
}

97 
Ev’tLoİ
* 
	gloİ_
;

98 cÚ¡ 
	gtim”fd_
;

99 
ChªÃl
 
	gtim”fdChªÃl_
;

100 cÚ¡ 
	gš‹rv®_
;

101 
Tim”C®lback
 
	gcb_
;

104 
	$maš
(
¬gc
, * 
¬gv
[])

106 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
()

108 
Ev’tLoİ
 
loİ
;

109 
P”iodicTim”
 
	`tim”
(&
loİ
, 1, 
boo¡
::
	`bšd
(
´št
, "PeriodicTimer"));

110 
tim”
.
	`¡¬t
();

111 
loİ
.
	`runEv”y
(1, 
boo¡
::
	`bšd
(
´št
, "EventLoop::runEvery"));

112 
loİ
.
	`loİ
();

113 
	}
}

	@muduo/net/tests/EchoClient_unittest.cc

1 
	~<muduo/Ãt/TıCl›Á.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Th»ad.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<boo¡/bšd.hµ
>

9 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

11 
	~<ut™y
>

13 
	~<¡dio.h
>

14 
	~<uni¡d.h
>

16 
usšg
 
Çme¥aû
 
	gmuduo
;

17 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

19 
	gnumTh»ads
 = 0;

20 
şass
 
	gEchoCl›Á
;

21 
	gboo¡
::
±r_veùÜ
<
EchoCl›Á
> 
ş›Ás
;

22 
	gcu¼’t
 = 0;

24 şas 
	cEchoCl›Á
 : 
boo¡
::
nÚcİyabË


26 
public
:

27 
	$EchoCl›Á
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
, cÚ¡ 
¡ršg
& 
id
)

28 : 
	`loİ_
(
loİ
),

29 
	`ş›Á_
(
loİ
, 
li¡’Addr
, "EchoCl›Á"+
id
)

31 
ş›Á_
.
	`£tCÚÃùiÚC®lback
(

32 
boo¡
::
	`bšd
(&
EchoCl›Á
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

33 
ş›Á_
.
	`£tMes§geC®lback
(

34 
boo¡
::
	`bšd
(&
EchoCl›Á
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

38 
	$cÚÃù
()

40 
ş›Á_
.
	`cÚÃù
();

41 
	}
}

44 
	g´iv©e
:

45 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

47 
LOG_TRACE
 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " -> "

48 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " is "

49 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

51 ià(
cÚn
->
	`cÚÃùed
())

53 ++
cu¼’t
;

54 ià(
im¶ic™_ÿ¡
<
size_t
>(
cu¼’t
è< 
ş›Ás
.
	`size
())

56 
ş›Ás
[
cu¼’t
].
	`cÚÃù
();

58 
LOG_INFO
 << "*** cÚÃùed " << 
cu¼’t
;

60 
cÚn
->
	`£nd
("world\n");

61 
	}
}

63 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
time
)

65 
¡ršg
 
	`msg
(
buf
->
	`»Œ›veAÎAsSŒšg
());

66 
LOG_TRACE
 << 
cÚn
->
	`Çme
(è<< "„ecv " << 
msg
.
	`size
(è<< " by‹ © " << 
time
.
	`toSŒšg
();

67 ià(
msg
 == "quit\n")

69 
cÚn
->
	`£nd
("bye\n");

70 
cÚn
->
	`shutdown
();

72 ià(
msg
 == "shutdown\n")

74 
loİ_
->
	`qu™
();

78 
cÚn
->
	`£nd
(
msg
);

80 
	}
}

82 
Ev’tLoİ
* 
	gloİ_
;

83 
TıCl›Á
 
	gş›Á_
;

86 
	$maš
(
¬gc
, * 
¬gv
[])

88 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

89 ià(
¬gc
 > 1)

91 
Ev’tLoİ
 
loİ
;

92 
boŞ
 
v6
 = 
¬gc
 > 3;

93 
IÃtAdd»ss
 
	`£rv”Addr
(
¬gv
[1], 2000, 
v6
);

95 
n
 = 1;

96 ià(
¬gc
 > 2)

98 
n
 = 
	`©oi
(
¬gv
[2]);

101 
ş›Ás
.
	`»£rve
(
n
);

102 
i
 = 0; i < 
n
; ++i)

104 
buf
[32];

105 
	`¢´štf
(
buf
,  buf, "%d", 
i
+1);

106 
ş›Ás
.
	`push_back
(
Ãw
 
	`EchoCl›Á
(&
loİ
, 
£rv”Addr
, 
buf
));

109 
ş›Ás
[
cu¼’t
].
	`cÚÃù
();

110 
loİ
.
	`loİ
();

114 
	`´štf
("U§ge: % ho¡_ [cu¼’t#]\n", 
¬gv
[0]);

116 
	}
}

	@muduo/net/tests/EchoServer_unittest.cc

1 
	~<muduo/Ãt/TıS”v”.h
>

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Th»ad.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/IÃtAdd»ss.h
>

8 
	~<boo¡/bšd.hµ
>

10 
	~<ut™y
>

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

15 
usšg
 
Çme¥aû
 
	gmuduo
;

16 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

18 
	gnumTh»ads
 = 0;

20 şas 
	cEchoS”v”


22 
	mpublic
:

23 
	$EchoS”v”
(
Ev’tLoİ
* 
loİ
, cÚ¡ 
IÃtAdd»ss
& 
li¡’Addr
)

24 : 
	`loİ_
(
loİ
),

25 
	`£rv”_
(
loİ
, 
li¡’Addr
, "EchoServer")

27 
£rv”_
.
	`£tCÚÃùiÚC®lback
(

28 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚCÚÃùiÚ
, 
this
, 
_1
));

29 
£rv”_
.
	`£tMes§geC®lback
(

30 
boo¡
::
	`bšd
(&
EchoS”v”
::
ÚMes§ge
, 
this
, 
_1
, 
_2
, 
_3
));

31 
£rv”_
.
	`£tTh»adNum
(
numTh»ads
);

34 
	$¡¬t
()

36 
£rv”_
.
	`¡¬t
();

37 
	}
}

40 
	g´iv©e
:

41 
	$ÚCÚÃùiÚ
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
)

43 
LOG_TRACE
 << 
cÚn
->
	`³”Add»ss
().
	`toIpPÜt
() << " -> "

44 << 
cÚn
->
	`loÿlAdd»ss
().
	`toIpPÜt
() << " is "

45 << (
cÚn
->
	`cÚÃùed
() ? "UP" : "DOWN");

46 
LOG_INFO
 << 
cÚn
->
	`g‘TıInfoSŒšg
();

48 
cÚn
->
	`£nd
("hello\n");

49 
	}
}

51 
	$ÚMes§ge
(cÚ¡ 
TıCÚÃùiÚPŒ
& 
cÚn
, 
Bufãr
* 
buf
, 
Time¡amp
 
time
)

53 
¡ršg
 
	`msg
(
buf
->
	`»Œ›veAÎAsSŒšg
());

54 
LOG_TRACE
 << 
cÚn
->
	`Çme
(è<< "„ecv " << 
msg
.
	`size
(è<< " by‹ © " << 
time
.
	`toSŒšg
();

55 ià(
msg
 == "exit\n")

57 
cÚn
->
	`£nd
("bye\n");

58 
cÚn
->
	`shutdown
();

60 ià(
msg
 == "quit\n")

62 
loİ_
->
	`qu™
();

64 
cÚn
->
	`£nd
(
msg
);

65 
	}
}

67 
Ev’tLoİ
* 
	gloİ_
;

68 
TıS”v”
 
	g£rv”_
;

71 
	$maš
(
¬gc
, * 
¬gv
[])

73 
LOG_INFO
 << "pid = " << 
	`g‘pid
(è<< ",id = " << 
Cu¼’tTh»ad
::
	`tid
();

74 
LOG_INFO
 << "sizeoàTıCÚÃùiÚ = " << (
TıCÚÃùiÚ
);

75 ià(
¬gc
 > 1)

77 
numTh»ads
 = 
	`©oi
(
¬gv
[1]);

79 
boŞ
 
v6
 = 
¬gc
 > 2;

80 
Ev’tLoİ
 
loİ
;

81 
IÃtAdd»ss
 
	`li¡’Addr
(2000, 
çl£
, 
v6
);

82 
EchoS”v”
 
	`£rv”
(&
loİ
, 
li¡’Addr
);

84 
£rv”
.
	`¡¬t
();

86 
loİ
.
	`loİ
();

87 
	}
}

	@muduo/net/tests/EventLoopThreadPool_unittest.cc

1 
	~<muduo/Ãt/Ev’tLoİTh»adPoŞ.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/ba£/Th»ad.h
>

5 
	~<boo¡/bšd.hµ
>

7 
	~<¡dio.h
>

8 
	~<uni¡d.h
>

10 
usšg
 
Çme¥aû
 
	gmuduo
;

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 
	$´št
(
Ev’tLoİ
* 
p
 = 
NULL
)

15 
	`´štf
("main():…id = %d,id = %d,†oop = %p\n",

16 
	`g‘pid
(), 
Cu¼’tTh»ad
::
	`tid
(), 
p
);

17 
	}
}

19 
	$š™
(
Ev’tLoİ
* 
p
)

21 
	`´štf
("init():…id = %d,id = %d,†oop = %p\n",

22 
	`g‘pid
(), 
Cu¼’tTh»ad
::
	`tid
(), 
p
);

23 
	}
}

25 
	$maš
()

27 
	`´št
();

29 
Ev’tLoİ
 
loİ
;

30 
loİ
.
	`runAá”
(11, 
boo¡
::
	`bšd
(&
Ev’tLoİ
::
qu™
, &loop));

33 
	`´štf
("SšgËh»ad %p:\n", &
loİ
);

34 
Ev’tLoİTh»adPoŞ
 
	`mod–
(&
loİ
, "single");

35 
mod–
.
	`£tTh»adNum
(0);

36 
mod–
.
	`¡¬t
(
š™
);

37 
	`as£¹
(
mod–
.
	`g‘NextLoİ
(è=ğ&
loİ
);

38 
	`as£¹
(
mod–
.
	`g‘NextLoİ
(è=ğ&
loİ
);

39 
	`as£¹
(
mod–
.
	`g‘NextLoİ
(è=ğ&
loİ
);

43 
	`´štf
("Anotherhread:\n");

44 
Ev’tLoİTh»adPoŞ
 
	`mod–
(&
loİ
, "another");

45 
mod–
.
	`£tTh»adNum
(1);

46 
mod–
.
	`¡¬t
(
š™
);

47 
Ev’tLoİ
* 
ÃxtLoİ
 = 
mod–
.
	`g‘NextLoİ
();

48 
ÃxtLoİ
->
	`runAá”
(2, 
boo¡
::
	`bšd
(
´št
,‚extLoop));

49 
	`as£¹
(
ÃxtLoİ
 !ğ&
loİ
);

50 
	`as£¹
(
ÃxtLoİ
 =ğ
mod–
.
	`g‘NextLoİ
());

51 
	`as£¹
(
ÃxtLoİ
 =ğ
mod–
.
	`g‘NextLoİ
());

52 ::
	`¦“p
(3);

56 
	`´štf
("Threehreads:\n");

57 
Ev’tLoİTh»adPoŞ
 
	`mod–
(&
loİ
, "three");

58 
mod–
.
	`£tTh»adNum
(3);

59 
mod–
.
	`¡¬t
(
š™
);

60 
Ev’tLoİ
* 
ÃxtLoİ
 = 
mod–
.
	`g‘NextLoİ
();

61 
ÃxtLoİ
->
	`runInLoİ
(
boo¡
::
	`bšd
(
´št
,‚extLoop));

62 
	`as£¹
(
ÃxtLoİ
 !ğ&
loİ
);

63 
	`as£¹
(
ÃxtLoİ
 !ğ
mod–
.
	`g‘NextLoİ
());

64 
	`as£¹
(
ÃxtLoİ
 !ğ
mod–
.
	`g‘NextLoİ
());

65 
	`as£¹
(
ÃxtLoİ
 =ğ
mod–
.
	`g‘NextLoİ
());

68 
loİ
.
	`loİ
();

69 
	}
}

	@muduo/net/tests/EventLoopThread_unittest.cc

1 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

2 
	~<muduo/Ãt/Ev’tLoİ.h
>

3 
	~<muduo/ba£/Th»ad.h
>

4 
	~<muduo/ba£/CouÁDownL©ch.h
>

6 
	~<boo¡/bšd.hµ
>

8 
	~<¡dio.h
>

9 
	~<uni¡d.h
>

11 
usšg
 
Çme¥aû
 
	gmuduo
;

12 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

14 
	$´št
(
Ev’tLoİ
* 
p
 = 
NULL
)

16 
	`´štf
("print:…id = %d,id = %d,†oop = %p\n",

17 
	`g‘pid
(), 
Cu¼’tTh»ad
::
	`tid
(), 
p
);

18 
	}
}

20 
	$qu™
(
Ev’tLoİ
* 
p
)

22 
	`´št
(
p
);

23 
p
->
	`qu™
();

24 
	}
}

26 
	$maš
()

28 
	`´št
();

31 
Ev’tLoİTh»ad
 
thr1
;

36 
Ev’tLoİTh»ad
 
thr2
;

37 
Ev’tLoİ
* 
loİ
 = 
thr2
.
	`¡¬tLoİ
();

38 
loİ
->
	`runInLoİ
(
boo¡
::
	`bšd
(
´št
,†oop));

39 
Cu¼’tTh»ad
::
	`¦“pU£c
(500 * 1000);

44 
Ev’tLoİTh»ad
 
thr3
;

45 
Ev’tLoİ
* 
loİ
 = 
thr3
.
	`¡¬tLoİ
();

46 
loİ
->
	`runInLoİ
(
boo¡
::
	`bšd
(
qu™
,†oop));

47 
Cu¼’tTh»ad
::
	`¦“pU£c
(500 * 1000);

49 
	}
}

	@muduo/net/tests/EventLoop_unittest.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

2 
	~<muduo/ba£/Th»ad.h
>

4 
	~<boo¡/bšd.hµ
>

6 
	~<as£¹.h
>

7 
	~<¡dio.h
>

8 
	~<uni¡d.h
>

10 
usšg
 
Çme¥aû
 
	gmuduo
;

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 
Ev’tLoİ
* 
	gg_loİ
;

15 
	$ÿÎback
()

17 
	`´štf
("ÿÎback():…id = %d,id = %d\n", 
	`g‘pid
(), 
Cu¼’tTh»ad
::
	`tid
());

18 
Ev’tLoİ
 
ªÙh”Loİ
;

19 
	}
}

21 
	$th»adFunc
()

23 
	`´štf
("th»adFunc():…id = %d,id = %d\n", 
	`g‘pid
(), 
Cu¼’tTh»ad
::
	`tid
());

25 
	`as£¹
(
Ev’tLoİ
::
	`g‘Ev’tLoİOfCu¼’tTh»ad
(è=ğ
NULL
);

26 
Ev’tLoİ
 
loİ
;

27 
	`as£¹
(
Ev’tLoİ
::
	`g‘Ev’tLoİOfCu¼’tTh»ad
(è=ğ&
loİ
);

28 
loİ
.
	`runAá”
(1.0, 
ÿÎback
);

29 
loİ
.
	`loİ
();

30 
	}
}

32 
	$maš
()

34 
	`´štf
("maš():…id = %d,id = %d\n", 
	`g‘pid
(), 
Cu¼’tTh»ad
::
	`tid
());

36 
	`as£¹
(
Ev’tLoİ
::
	`g‘Ev’tLoİOfCu¼’tTh»ad
(è=ğ
NULL
);

37 
Ev’tLoİ
 
loİ
;

38 
	`as£¹
(
Ev’tLoİ
::
	`g‘Ev’tLoİOfCu¼’tTh»ad
(è=ğ&
loİ
);

40 
Th»ad
 
	`th»ad
(
th»adFunc
);

41 
th»ad
.
	`¡¬t
();

43 
loİ
.
	`loİ
();

44 
	}
}

	@muduo/net/tests/InetAddress_unittest.cc

1 
	~<muduo/Ãt/IÃtAdd»ss.h
>

3 
	~<muduo/ba£/Loggšg.h
>

6 
	#BOOST_TEST_MAIN


	)

7 
	#BOOST_TEST_DYN_LINK


	)

8 
	~<boo¡/‹¡/un™_‹¡.hµ
>

10 
usšg
 
	gmuduo
::
¡ršg
;

11 
usšg
 
	gmuduo
::
Ãt
::
IÃtAdd»ss
;

13 
	$BOOST_AUTO_TEST_CASE
(
‹¡IÃtAdd»ss
)

15 
IÃtAdd»ss
 
	`addr0
(1234);

16 
	`BOOST_CHECK_EQUAL
(
addr0
.
	`toIp
(), 
	`¡ršg
("0.0.0.0"));

17 
	`BOOST_CHECK_EQUAL
(
addr0
.
	`toIpPÜt
(), 
	`¡ršg
("0.0.0.0:1234"));

18 
	`BOOST_CHECK_EQUAL
(
addr0
.
	`toPÜt
(), 1234);

20 
IÃtAdd»ss
 
	`addr1
(4321, 
Œue
);

21 
	`BOOST_CHECK_EQUAL
(
addr1
.
	`toIp
(), 
	`¡ršg
("127.0.0.1"));

22 
	`BOOST_CHECK_EQUAL
(
addr1
.
	`toIpPÜt
(), 
	`¡ršg
("127.0.0.1:4321"));

23 
	`BOOST_CHECK_EQUAL
(
addr1
.
	`toPÜt
(), 4321);

25 
IÃtAdd»ss
 
	`addr2
("1.2.3.4", 8888);

26 
	`BOOST_CHECK_EQUAL
(
addr2
.
	`toIp
(), 
	`¡ršg
("1.2.3.4"));

27 
	`BOOST_CHECK_EQUAL
(
addr2
.
	`toIpPÜt
(), 
	`¡ršg
("1.2.3.4:8888"));

28 
	`BOOST_CHECK_EQUAL
(
addr2
.
	`toPÜt
(), 8888);

30 
IÃtAdd»ss
 
	`addr3
("255.254.253.252", 65535);

31 
	`BOOST_CHECK_EQUAL
(
addr3
.
	`toIp
(), 
	`¡ršg
("255.254.253.252"));

32 
	`BOOST_CHECK_EQUAL
(
addr3
.
	`toIpPÜt
(), 
	`¡ršg
("255.254.253.252:65535"));

33 
	`BOOST_CHECK_EQUAL
(
addr3
.
	`toPÜt
(), 65535);

34 
	}
}

36 
	$BOOST_AUTO_TEST_CASE
(
‹¡IÃtAdd»ssResŞve
)

38 
IÃtAdd»ss
 
	`addr
(80);

39 ià(
IÃtAdd»ss
::
	`»sŞve
("googË.com", &
addr
))

41 
LOG_INFO
 << "googË.com„esŞvedØ" << 
addr
.
	`toIpPÜt
();

45 
LOG_ERROR
 << "Unableo„esolve google.com";

47 
	}
}

	@muduo/net/tests/TcpClient_reg1.cc

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİ.h
>

5 
	~<muduo/Ãt/TıCl›Á.h
>

7 
	~<boo¡/bšd.hµ
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

12 
TıCl›Á
* 
	gg_ş›Á
;

14 
	$timeout
()

16 
LOG_INFO
 << "timeout";

17 
g_ş›Á
->
	`¡İ
();

18 
	}
}

20 
	$maš
(
¬gc
, * 
¬gv
[])

22 
Ev’tLoİ
 
loİ
;

23 
IÃtAdd»ss
 
	`£rv”Addr
("127.0.0.1", 2);

24 
TıCl›Á
 
	`ş›Á
(&
loİ
, 
£rv”Addr
, "TcpClient");

25 
g_ş›Á
 = &
ş›Á
;

26 
loİ
.
	`runAá”
(0.0, 
timeout
);

27 
loİ
.
	`runAá”
(1.0, 
boo¡
::
	`bšd
(&
Ev’tLoİ
::
qu™
, &loop));

28 
ş›Á
.
	`cÚÃù
();

29 
Cu¼’tTh»ad
::
	`¦“pU£c
(100 * 1000);

30 
loİ
.
	`loİ
();

31 
	}
}

	@muduo/net/tests/TcpClient_reg2.cc

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/ba£/Th»ad.h
>

5 
	~<muduo/Ãt/Ev’tLoİ.h
>

6 
	~<muduo/Ãt/TıCl›Á.h
>

8 
	~<boo¡/bšd.hµ
>

10 
usšg
 
Çme¥aû
 
	gmuduo
;

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 
	$th»adFunc
(
Ev’tLoİ
* 
loİ
)

15 
IÃtAdd»ss
 
	`£rv”Addr
("127.0.0.1", 1234);

16 
TıCl›Á
 
	`ş›Á
(
loİ
, 
£rv”Addr
, "TcpClient");

17 
ş›Á
.
	`cÚÃù
();

19 
Cu¼’tTh»ad
::
	`¦“pU£c
(1000*1000);

21 
	}
}

23 
	$maš
(
¬gc
, * 
¬gv
[])

25 
Logg”
::
	`£tLogLev–
(Logg”::
DEBUG
);

27 
Ev’tLoİ
 
loİ
;

28 
loİ
.
	`runAá”
(3.0, 
boo¡
::
	`bšd
(&
Ev’tLoİ
::
qu™
, &loop));

29 
Th»ad
 
	`thr
(
boo¡
::
	`bšd
(
th»adFunc
, &
loİ
));

30 
thr
.
	`¡¬t
();

31 
loİ
.
	`loİ
();

32 
	}
}

	@muduo/net/tests/TcpClient_reg3.cc

3 
	~<muduo/ba£/Loggšg.h
>

4 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

5 
	~<muduo/Ãt/TıCl›Á.h
>

7 
	~<boo¡/bšd.hµ
>

9 
usšg
 
Çme¥aû
 
	gmuduo
;

10 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

12 
	$maš
(
¬gc
, * 
¬gv
[])

14 
Logg”
::
	`£tLogLev–
(Logg”::
DEBUG
);

16 
Ev’tLoİTh»ad
 
loİTh»ad
;

18 
IÃtAdd»ss
 
	`£rv”Addr
("127.0.0.1", 1234);

19 
TıCl›Á
 
	`ş›Á
(
loİTh»ad
.
	`¡¬tLoİ
(), 
£rv”Addr
, "TcpClient");

20 
ş›Á
.
	`cÚÃù
();

21 
Cu¼’tTh»ad
::
	`¦“pU£c
(500 * 1000);

22 
ş›Á
.
	`discÚÃù
();

25 
Cu¼’tTh»ad
::
	`¦“pU£c
(1000 * 1000);

26 
	}
}

	@muduo/net/tests/TimerQueue_unittest.cc

1 
	~<muduo/Ãt/Ev’tLoİ.h
>

2 
	~<muduo/Ãt/Ev’tLoİTh»ad.h
>

3 
	~<muduo/ba£/Th»ad.h
>

5 
	~<boo¡/bšd.hµ
>

7 
	~<¡dio.h
>

8 
	~<uni¡d.h
>

10 
usšg
 
Çme¥aû
 
	gmuduo
;

11 
usšg
 
Çme¥aû
 
	gmuduo
::
Ãt
;

13 
	gút
 = 0;

14 
Ev’tLoİ
* 
	gg_loİ
;

16 
	$´štTid
()

18 
	`´štf
("pid = %d,id = %d\n", 
	`g‘pid
(), 
Cu¼’tTh»ad
::
	`tid
());

19 
	`´štf
("now %s\n", 
Time¡amp
::
	`now
().
	`toSŒšg
().
	`c_¡r
());

20 
	}
}

22 
	$´št
(cÚ¡ * 
msg
)

24 
	`´štf
("msg % %s\n", 
Time¡amp
::
	`now
().
	`toSŒšg
().
	`c_¡r
(), 
msg
);

25 ià(++
út
 == 20)

27 
g_loİ
->
	`qu™
();

29 
	}
}

31 
	$ÿnûl
(
Tim”Id
 
tim”
)

33 
g_loİ
->
	`ÿnûl
(
tim”
);

34 
	`´štf
("ÿnûÎed‡ˆ%s\n", 
Time¡amp
::
	`now
().
	`toSŒšg
().
	`c_¡r
());

35 
	}
}

37 
	$maš
()

39 
	`´štTid
();

40 
	`¦“p
(1);

42 
Ev’tLoİ
 
loİ
;

43 
g_loİ
 = &
loİ
;

45 
	`´št
("main");

46 
loİ
.
	`runAá”
(1, 
boo¡
::
	`bšd
(
´št
, "once1"));

47 
loİ
.
	`runAá”
(1.5, 
boo¡
::
	`bšd
(
´št
, "once1.5"));

48 
loİ
.
	`runAá”
(2.5, 
boo¡
::
	`bšd
(
´št
, "once2.5"));

49 
loİ
.
	`runAá”
(3.5, 
boo¡
::
	`bšd
(
´št
, "once3.5"));

50 
Tim”Id
 
t45
 = 
loİ
.
	`runAá”
(4.5, 
boo¡
::
	`bšd
(
´št
, "once4.5"));

51 
loİ
.
	`runAá”
(4.2, 
boo¡
::
	`bšd
(
ÿnûl
, 
t45
));

52 
loİ
.
	`runAá”
(4.8, 
boo¡
::
	`bšd
(
ÿnûl
, 
t45
));

53 
loİ
.
	`runEv”y
(2, 
boo¡
::
	`bšd
(
´št
, "every2"));

54 
Tim”Id
 
t3
 = 
loİ
.
	`runEv”y
(3, 
boo¡
::
	`bšd
(
´št
, "every3"));

55 
loİ
.
	`runAá”
(9.001, 
boo¡
::
	`bšd
(
ÿnûl
, 
t3
));

57 
loİ
.
	`loİ
();

58 
	`´št
("main†oopƒxits");

60 
	`¦“p
(1);

62 
Ev’tLoİTh»ad
 
loİTh»ad
;

63 
Ev’tLoİ
* 
loİ
 = 
loİTh»ad
.
	`¡¬tLoİ
();

64 
loİ
->
	`runAá”
(2, 
´štTid
);

65 
	`¦“p
(3);

66 
	`´št
("thread†oopƒxits");

68 
	}
}

	@muduo/net/tests/ZlibStream_unittest.cc

1 
	~<muduo/Ãt/ZlibSŒ—m.h
>

3 
	~<muduo/ba£/Loggšg.h
>

5 
	#BOOST_TEST_MAIN


	)

6 
	#BOOST_TEST_DYN_LINK


	)

7 
	~<boo¡/‹¡/un™_‹¡.hµ
>

9 
	~<¡dio.h
>

11 
	$BOOST_AUTO_TEST_CASE
(
‹¡ZlibOuutSŒ—m
)

13 
muduo
::
Ãt
::
Bufãr
 
ouut
;

15 
muduo
::
Ãt
::
ZlibOuutSŒ—m
 
	`¡»am
(&
ouut
);

16 
	`BOOST_CHECK_EQUAL
(
ouut
.
	`»adabËBy‹s
(), 0);

18 
	`BOOST_CHECK_EQUAL
(
ouut
.
	`»adabËBy‹s
(), 8);

19 
	}
}

21 
	$BOOST_AUTO_TEST_CASE
(
‹¡ZlibOuutSŒ—m1
)

23 
muduo
::
Ãt
::
Bufãr
 
ouut
;

24 
muduo
::
Ãt
::
ZlibOuutSŒ—m
 
	`¡»am
(&
ouut
);

25 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_OK
);

26 
¡»am
.
	`fšish
();

27 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_STREAM_END
);

28 
	}
}

30 
	$BOOST_AUTO_TEST_CASE
(
‹¡ZlibOuutSŒ—m2
)

32 
muduo
::
Ãt
::
Bufãr
 
ouut
;

33 
muduo
::
Ãt
::
ZlibOuutSŒ—m
 
	`¡»am
(&
ouut
);

34 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_OK
);

35 
	`BOOST_CHECK
(
¡»am
.
	`wr™e
("01234567890123456789012345678901234567890123456789"));

36 
¡»am
.
	`fšish
();

38 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_STREAM_END
);

39 
	}
}

41 
	$BOOST_AUTO_TEST_CASE
(
‹¡ZlibOuutSŒ—m3
)

43 
muduo
::
Ãt
::
Bufãr
 
ouut
;

44 
muduo
::
Ãt
::
ZlibOuutSŒ—m
 
	`¡»am
(&
ouut
);

45 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_OK
);

46 
i
 = 0; i < 1024*1024; ++i)

48 
	`BOOST_CHECK
(
¡»am
.
	`wr™e
("01234567890123456789012345678901234567890123456789"));

50 
¡»am
.
	`fšish
();

52 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_STREAM_END
);

53 
	}
}

55 
	$BOOST_AUTO_TEST_CASE
(
‹¡ZlibOuutSŒ—m4
)

57 
muduo
::
Ãt
::
Bufãr
 
ouut
;

58 
muduo
::
Ãt
::
ZlibOuutSŒ—m
 
	`¡»am
(&
ouut
);

59 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_OK
);

60 
muduo
::
¡ršg
 
šput
;

61 
i
 = 0; i < 32768; ++i)

63 
šput
 +ğ"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnİqr¡uvwxyz_-"[
	`¿nd
() % 64];

66 
i
 = 0; i < 10; ++i)

68 
	`BOOST_CHECK
(
¡»am
.
	`wr™e
(
šput
));

70 
¡»am
.
	`fšish
();

72 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_STREAM_END
);

73 
	}
}

75 
	$BOOST_AUTO_TEST_CASE
(
‹¡ZlibOuutSŒ—m5
)

77 
muduo
::
Ãt
::
Bufãr
 
ouut
;

78 
muduo
::
Ãt
::
ZlibOuutSŒ—m
 
	`¡»am
(&
ouut
);

79 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_OK
);

80 
muduo
::
¡ršg
 
	`šput
(1024*1024, '_');

81 
i
 = 0; i < 64; ++i)

83 
	`BOOST_CHECK
(
¡»am
.
	`wr™e
(
šput
));

85 
	`´štf
("bufsiz %d\n", 
¡»am
.
	`š‹º®OuutBufãrSize
());

86 
LOG_INFO
 << "tÙ®_š " << 
¡»am
.
	`šputBy‹s
();

87 
LOG_INFO
 << "tÙ®_ouˆ" << 
¡»am
.
	`ouutBy‹s
();

88 
¡»am
.
	`fšish
();

89 
	`´štf
("tÙ® %zd\n", 
ouut
.
	`»adabËBy‹s
());

90 
	`BOOST_CHECK_EQUAL
(
¡»am
.
	`zlibE¼ÜCode
(), 
Z_STREAM_END
);

91 
	}
}

	@
1
.
0
392
11659
contrib/hiredis/Hiredis.cc
contrib/hiredis/Hiredis.h
contrib/hiredis/Hiredis.h
contrib/hiredis/mrediscli.cc
contrib/thrift/ThriftConnection.cc
contrib/thrift/ThriftConnection.h
contrib/thrift/ThriftConnection.h
contrib/thrift/ThriftServer.cc
contrib/thrift/ThriftServer.h
contrib/thrift/ThriftServer.h
contrib/thrift/tests/echo/EchoServer.cc
contrib/thrift/tests/ping/PingServer.cc
examples/ace/logging/client.cc
examples/ace/logging/server.cc
examples/ace/ttcp/common.cc
examples/ace/ttcp/common.h
examples/ace/ttcp/common.h
examples/ace/ttcp/main.cc
examples/ace/ttcp/ttcp.cc
examples/ace/ttcp/ttcp_blocking.cc
examples/asio/chat/client.cc
examples/asio/chat/codec.h
examples/asio/chat/codec.h
examples/asio/chat/loadtest.cc
examples/asio/chat/server.cc
examples/asio/chat/server_threaded.cc
examples/asio/chat/server_threaded_efficient.cc
examples/asio/chat/server_threaded_highperformance.cc
examples/asio/tutorial/timer2/timer.cc
examples/asio/tutorial/timer3/timer.cc
examples/asio/tutorial/timer4/timer.cc
examples/asio/tutorial/timer5/timer.cc
examples/asio/tutorial/timer6/timer.cc
examples/cdns/Resolver.cc
examples/cdns/Resolver.h
examples/cdns/Resolver.h
examples/cdns/dns.cc
examples/curl/Curl.cc
examples/curl/Curl.h
examples/curl/Curl.h
examples/curl/download.cc
examples/curl/mcurl.cc
examples/fastcgi/fastcgi.cc
examples/fastcgi/fastcgi.h
examples/fastcgi/fastcgi.h
examples/fastcgi/fastcgi_test.cc
examples/filetransfer/download.cc
examples/filetransfer/download2.cc
examples/filetransfer/download3.cc
examples/hub/codec.cc
examples/hub/codec.h
examples/hub/codec.h
examples/hub/hub.cc
examples/hub/pub.cc
examples/hub/pubsub.cc
examples/hub/pubsub.h
examples/hub/pubsub.h
examples/hub/sub.cc
examples/idleconnection/echo.cc
examples/idleconnection/echo.h
examples/idleconnection/echo.h
examples/idleconnection/main.cc
examples/idleconnection/sortedlist.cc
examples/maxconnection/echo.cc
examples/maxconnection/echo.h
examples/maxconnection/echo.h
examples/maxconnection/main.cc
examples/memcached/client/bench.cc
examples/memcached/server/Item.cc
examples/memcached/server/Item.h
examples/memcached/server/Item.h
examples/memcached/server/MemcacheServer.cc
examples/memcached/server/MemcacheServer.h
examples/memcached/server/MemcacheServer.h
examples/memcached/server/Session.cc
examples/memcached/server/Session.h
examples/memcached/server/Session.h
examples/memcached/server/footprint_test.cc
examples/memcached/server/server.cc
examples/multiplexer/demux.cc
examples/multiplexer/multiplexer.cc
examples/multiplexer/multiplexer_simple.cc
examples/netty/discard/client.cc
examples/netty/discard/server.cc
examples/netty/echo/client.cc
examples/netty/echo/server.cc
examples/netty/echo/server2.cc
examples/netty/uptime/uptime.cc
examples/pingpong/bench.cc
examples/pingpong/client.cc
examples/pingpong/server.cc
examples/procmon/dummyload.cc
examples/procmon/plot.cc
examples/procmon/plot.h
examples/procmon/plot.h
examples/procmon/plot_test.cc
examples/procmon/procmon.cc
examples/protobuf/codec/client.cc
examples/protobuf/codec/codec.cc
examples/protobuf/codec/codec.h
examples/protobuf/codec/codec.h
examples/protobuf/codec/codec_test.cc
examples/protobuf/codec/dispatcher.h
examples/protobuf/codec/dispatcher.h
examples/protobuf/codec/dispatcher_lite.h
examples/protobuf/codec/dispatcher_lite.h
examples/protobuf/codec/dispatcher_lite_test.cc
examples/protobuf/codec/dispatcher_test.cc
examples/protobuf/codec/server.cc
examples/protobuf/resolver/client.cc
examples/protobuf/resolver/server.cc
examples/protobuf/rpc/client.cc
examples/protobuf/rpc/server.cc
examples/protobuf/rpcbalancer/balancer.cc
examples/protobuf/rpcbalancer/balancer_raw.cc
examples/protobuf/rpcbench/client.cc
examples/protobuf/rpcbench/server.cc
examples/roundtrip/roundtrip.cc
examples/roundtrip/roundtrip_udp.cc
examples/shorturl/shorturl.cc
examples/simple/allinone/allinone.cc
examples/simple/chargen/chargen.cc
examples/simple/chargen/chargen.h
examples/simple/chargen/chargen.h
examples/simple/chargen/main.cc
examples/simple/chargenclient/chargenclient.cc
examples/simple/daytime/daytime.cc
examples/simple/daytime/daytime.h
examples/simple/daytime/daytime.h
examples/simple/daytime/main.cc
examples/simple/discard/discard.cc
examples/simple/discard/discard.h
examples/simple/discard/discard.h
examples/simple/discard/main.cc
examples/simple/echo/echo.cc
examples/simple/echo/echo.h
examples/simple/echo/echo.h
examples/simple/echo/main.cc
examples/simple/time/main.cc
examples/simple/time/time.cc
examples/simple/time/time.h
examples/simple/time/time.h
examples/simple/timeclient/timeclient.cc
examples/socks4a/balancer.cc
examples/socks4a/socks4a.cc
examples/socks4a/tcprelay.cc
examples/socks4a/tunnel.h
examples/socks4a/tunnel.h
examples/sudoku/batch.cc
examples/sudoku/loadtest.cc
examples/sudoku/percentile.h
examples/sudoku/percentile.h
examples/sudoku/pipeline.cc
examples/sudoku/server_basic.cc
examples/sudoku/server_hybrid.cc
examples/sudoku/server_multiloop.cc
examples/sudoku/server_prod.cc
examples/sudoku/server_threadpool.cc
examples/sudoku/stat.h
examples/sudoku/stat.h
examples/sudoku/stat_unittest.cc
examples/sudoku/sudoku.cc
examples/sudoku/sudoku.h
examples/sudoku/sudoku.h
examples/twisted/finger/finger01.cc
examples/twisted/finger/finger02.cc
examples/twisted/finger/finger03.cc
examples/twisted/finger/finger04.cc
examples/twisted/finger/finger05.cc
examples/twisted/finger/finger06.cc
examples/twisted/finger/finger07.cc
examples/wordcount/hash.h
examples/wordcount/hash.h
examples/wordcount/hasher.cc
examples/wordcount/receiver.cc
examples/zeromq/local_lat.cc
examples/zeromq/remote_lat.cc
muduo/base/AsyncLogging.cc
muduo/base/AsyncLogging.h
muduo/base/AsyncLogging.h
muduo/base/Atomic.h
muduo/base/Atomic.h
muduo/base/BlockingQueue.h
muduo/base/BlockingQueue.h
muduo/base/BoundedBlockingQueue.h
muduo/base/BoundedBlockingQueue.h
muduo/base/Condition.cc
muduo/base/Condition.h
muduo/base/Condition.h
muduo/base/CountDownLatch.cc
muduo/base/CountDownLatch.h
muduo/base/CountDownLatch.h
muduo/base/CurrentThread.h
muduo/base/CurrentThread.h
muduo/base/Date.cc
muduo/base/Date.h
muduo/base/Date.h
muduo/base/Exception.cc
muduo/base/Exception.h
muduo/base/Exception.h
muduo/base/FileUtil.cc
muduo/base/FileUtil.h
muduo/base/FileUtil.h
muduo/base/GzipFile.h
muduo/base/GzipFile.h
muduo/base/LogFile.cc
muduo/base/LogFile.h
muduo/base/LogFile.h
muduo/base/LogStream.cc
muduo/base/LogStream.h
muduo/base/LogStream.h
muduo/base/Logging.cc
muduo/base/Logging.h
muduo/base/Logging.h
muduo/base/Mutex.h
muduo/base/Mutex.h
muduo/base/ProcessInfo.cc
muduo/base/ProcessInfo.h
muduo/base/ProcessInfo.h
muduo/base/Singleton.h
muduo/base/Singleton.h
muduo/base/StringPiece.h
muduo/base/StringPiece.h
muduo/base/Thread.cc
muduo/base/Thread.h
muduo/base/Thread.h
muduo/base/ThreadLocal.h
muduo/base/ThreadLocal.h
muduo/base/ThreadLocalSingleton.h
muduo/base/ThreadLocalSingleton.h
muduo/base/ThreadPool.cc
muduo/base/ThreadPool.h
muduo/base/ThreadPool.h
muduo/base/TimeZone.cc
muduo/base/TimeZone.h
muduo/base/TimeZone.h
muduo/base/Timestamp.cc
muduo/base/Timestamp.h
muduo/base/Timestamp.h
muduo/base/Types.h
muduo/base/Types.h
muduo/base/WeakCallback.h
muduo/base/WeakCallback.h
muduo/base/copyable.h
muduo/base/copyable.h
muduo/base/tests/AsyncLogging_test.cc
muduo/base/tests/Atomic_unittest.cc
muduo/base/tests/BlockingQueue_bench.cc
muduo/base/tests/BlockingQueue_test.cc
muduo/base/tests/BoundedBlockingQueue_test.cc
muduo/base/tests/Date_unittest.cc
muduo/base/tests/Exception_test.cc
muduo/base/tests/FileUtil_test.cc
muduo/base/tests/Fork_test.cc
muduo/base/tests/GzipFile_test.cc
muduo/base/tests/LogFile_test.cc
muduo/base/tests/LogStream_bench.cc
muduo/base/tests/LogStream_test.cc
muduo/base/tests/Logging_test.cc
muduo/base/tests/Mutex_test.cc
muduo/base/tests/ProcessInfo_test.cc
muduo/base/tests/SingletonThreadLocal_test.cc
muduo/base/tests/Singleton_test.cc
muduo/base/tests/ThreadLocalSingleton_test.cc
muduo/base/tests/ThreadLocal_test.cc
muduo/base/tests/ThreadPool_test.cc
muduo/base/tests/Thread_bench.cc
muduo/base/tests/Thread_test.cc
muduo/base/tests/TimeZone_unittest.cc
muduo/base/tests/Timestamp_unittest.cc
muduo/net/Acceptor.cc
muduo/net/Acceptor.h
muduo/net/Acceptor.h
muduo/net/Buffer.cc
muduo/net/Buffer.h
muduo/net/Buffer.h
muduo/net/Callbacks.h
muduo/net/Callbacks.h
muduo/net/Channel.cc
muduo/net/Channel.h
muduo/net/Channel.h
muduo/net/Connector.cc
muduo/net/Connector.h
muduo/net/Connector.h
muduo/net/Endian.h
muduo/net/Endian.h
muduo/net/EventLoop.cc
muduo/net/EventLoop.h
muduo/net/EventLoop.h
muduo/net/EventLoopThread.cc
muduo/net/EventLoopThread.h
muduo/net/EventLoopThread.h
muduo/net/EventLoopThreadPool.cc
muduo/net/EventLoopThreadPool.h
muduo/net/EventLoopThreadPool.h
muduo/net/InetAddress.cc
muduo/net/InetAddress.h
muduo/net/InetAddress.h
muduo/net/Poller.cc
muduo/net/Poller.h
muduo/net/Poller.h
muduo/net/Socket.cc
muduo/net/Socket.h
muduo/net/Socket.h
muduo/net/SocketsOps.cc
muduo/net/SocketsOps.h
muduo/net/SocketsOps.h
muduo/net/TcpClient.cc
muduo/net/TcpClient.h
muduo/net/TcpClient.h
muduo/net/TcpConnection.cc
muduo/net/TcpConnection.h
muduo/net/TcpConnection.h
muduo/net/TcpServer.cc
muduo/net/TcpServer.h
muduo/net/TcpServer.h
muduo/net/Timer.cc
muduo/net/Timer.h
muduo/net/Timer.h
muduo/net/TimerId.h
muduo/net/TimerId.h
muduo/net/TimerQueue.cc
muduo/net/TimerQueue.h
muduo/net/TimerQueue.h
muduo/net/ZlibStream.h
muduo/net/ZlibStream.h
muduo/net/boilerplate.cc
muduo/net/boilerplate.h
muduo/net/boilerplate.h
muduo/net/http/HttpContext.cc
muduo/net/http/HttpContext.h
muduo/net/http/HttpContext.h
muduo/net/http/HttpRequest.h
muduo/net/http/HttpRequest.h
muduo/net/http/HttpResponse.cc
muduo/net/http/HttpResponse.h
muduo/net/http/HttpResponse.h
muduo/net/http/HttpServer.cc
muduo/net/http/HttpServer.h
muduo/net/http/HttpServer.h
muduo/net/http/tests/HttpRequest_unittest.cc
muduo/net/http/tests/HttpServer_test.cc
muduo/net/inspect/Inspector.cc
muduo/net/inspect/Inspector.h
muduo/net/inspect/Inspector.h
muduo/net/inspect/PerformanceInspector.cc
muduo/net/inspect/PerformanceInspector.h
muduo/net/inspect/PerformanceInspector.h
muduo/net/inspect/ProcessInspector.cc
muduo/net/inspect/ProcessInspector.h
muduo/net/inspect/ProcessInspector.h
muduo/net/inspect/SystemInspector.cc
muduo/net/inspect/SystemInspector.h
muduo/net/inspect/SystemInspector.h
muduo/net/inspect/tests/Inspector_test.cc
muduo/net/poller/DefaultPoller.cc
muduo/net/poller/EPollPoller.cc
muduo/net/poller/EPollPoller.h
muduo/net/poller/EPollPoller.h
muduo/net/poller/PollPoller.cc
muduo/net/poller/PollPoller.h
muduo/net/poller/PollPoller.h
muduo/net/protobuf/BufferStream.h
muduo/net/protobuf/BufferStream.h
muduo/net/protobuf/ProtobufCodecLite.cc
muduo/net/protobuf/ProtobufCodecLite.h
muduo/net/protobuf/ProtobufCodecLite.h
muduo/net/protorpc/RpcChannel.cc
muduo/net/protorpc/RpcChannel.h
muduo/net/protorpc/RpcChannel.h
muduo/net/protorpc/RpcCodec.cc
muduo/net/protorpc/RpcCodec.h
muduo/net/protorpc/RpcCodec.h
muduo/net/protorpc/RpcCodec_test.cc
muduo/net/protorpc/RpcServer.cc
muduo/net/protorpc/RpcServer.h
muduo/net/protorpc/RpcServer.h
muduo/net/protorpc/google-inl.h
muduo/net/protorpc/google-inl.h
muduo/net/tests/Buffer_unittest.cc
muduo/net/tests/Channel_test.cc
muduo/net/tests/EchoClient_unittest.cc
muduo/net/tests/EchoServer_unittest.cc
muduo/net/tests/EventLoopThreadPool_unittest.cc
muduo/net/tests/EventLoopThread_unittest.cc
muduo/net/tests/EventLoop_unittest.cc
muduo/net/tests/InetAddress_unittest.cc
muduo/net/tests/TcpClient_reg1.cc
muduo/net/tests/TcpClient_reg2.cc
muduo/net/tests/TcpClient_reg3.cc
muduo/net/tests/TimerQueue_unittest.cc
muduo/net/tests/ZlibStream_unittest.cc
